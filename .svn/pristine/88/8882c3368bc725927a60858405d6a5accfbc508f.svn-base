<html>
<head>
    @{
    ViewBag.Title = "FabricPlanning Order";
    }
</head>
<body>

    @model IEnumerable<ESimSol.BusinessObjects.FabricPlanning>

    <div class="menuMainCollectionTable">
   
        <fieldset>
            <legend>FabricPlanning Detail For : <label id="lblFabricNo"></label></legend>

            <table style="width:100%; margin-top:10px">
                @*<tr>
                    <td style=" float:left; width:10%;">
                        <label>Product</label>
                    </td>
                    <td style="float:left; width:60%;">
                        <input id="txtProduct" style="float:left; width:75%;" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                   
                </tr>*@
                <tr>
                    <td style=" width:10%;">
                        <label>Type:</label>
                        <select style="width: 60%;" id="cboWarp">
                            <option value="true">Warp</option>
                            <option value="false">Weft</option>
                        </select>
                   
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Yarn:</label>
                    </td>
                    <td style="width:20%; text-align:left">
                        <input id="txtProduct" style="float:left; width:70%;" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Color: </label>
                    </td>
                    <td style="width:30%; text-align:left">
                        <input id="txtRGB" onkeydown="ColorChange(1)" type="text">
                        <input id="txtRGBPriview" type="color" onchange="ColorChange(2)">
                        <button id="btnPickColor">Color Picker</button>
                    </td>
                    <td style="width:30%;">
                      
                    </td>
                </tr>
            </table>

        </fieldset>
        <div style="padding-left:2px; padding-right:2px;">
            @*<table id="tblFabricPlanningDetail" class="easyui-datagrid" style="height: 415px; width:100%;" fitcolumns="true" rownumbers="true" pagination="false" 
                   singleselect="true" autorowheight="false" toolbar="#toolbar" >*@
            <table id="tblFabricPlanningDetail" title="Purchase Invoice Detail" class="easyui-datagrid" style="width:100%;height:415px;" fitcolumns="true" singleselect="true" rownumbers="true" pagination="false" autorowheight="false"
                   data-options="toolbar: '#toolbar',onClickRow:onClickRow,onLoadSuccess: onLoadSuccess"></table>
               
            <div id="toolbar">
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true"><label id="lblEditUpdate">Edit</label></a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnMakeTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Create Group</a>
                <a id="btnRemoveTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Remove Group</a>
                <a id="btnCopyDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="CopyDetail()" plain="true">Copy</a>
                <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                <a id="btnAddPlanDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Plan Detail</a>
            </div>
        </div>
        <fieldset>
            <legend>Action</legend>
            <table border="0" cellpadding="0" cellspacing="0" style="float:right; width:100%;">
                <tr>
                    <td style=" float:left;  width:10%; ">
                        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                    </td>
                    <td style="float:left;  width:20%; ">
                   
                    </td>
                    <td style="width:70%;float:right; text-align:right">
                        @*<a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>*@
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
   
</body>
</html>

<style type="text/css">

     .col-md-12{
        width:100%;
        padding-right:3px;
        padding-left:3px;
        margin-bottom:3px;
    }
    .col-md-1{
        width:8%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-2{
        width:13%;
        padding-right:3px;
        padding-left:3px;
    }
     .col-md-3{
        width:16.66%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-4{
        width:25%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-5{
        width:39%;
        padding-right:3px;
        padding-left:0px;
    }
    .col-md-6{
        width:46%;
        padding-right:0px;
        padding-left:3px;
    }
     .col-md-8{
        width:65%;
        padding-right:0px;
        padding-left:3px;
    }
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }

    .td-col-3 input {
        width: 92%;
    }

    .td-col-6 input {
        width: 70%;
    }

    .td-col-13 input {
        width: 86%;
    }

    .send-to .td-col-13 input {
        width: 85.7%;
    }


    .hp-ph .td-col-8 input {
        width: 66%;
    }

    .hp-ph .td-col-8 select {
        width: 96%;
    }

    .td-Note input {
        width: 97.5%;
    }

    .td-col-13 select {
        width: 15%;
    }

    .td-product input {
        width: 66%;
    }

    .td-KnitPly select {
        width: 95%;
    }

    .combo-number {
        width: 85%;
    }

    .td-ColorName input {
        width: 90%;
    }

    .td-PantonNo-Ref input {
        width: 34.5%;
    }

    .custom-styler {
        width: 85%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oFabricPlanning=null;
    var _nProductID=0;
    var _nFabricID=0;
    var _oCellRowSpans=[];
    var _oFabricSCReport=[];
    $(document).ready(function ()
    {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oFabricPlannings =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _nFabricID=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricID));
        _oFabricSCReport=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricSCReport));
        if(oFabricPlannings.length>0)
        {
            _oCellRowSpans=oFabricPlannings[0].CellRowSpans;
        }
        Refresh(oFabricPlannings);debugger;
    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winFabricPlanningOrder').icsWindow('close'); } });

    function MakeGrid()
    {
        var tblColums=[];
        var oColumn=null;
        oColumn=  {field : 'FabricPlanningID',title:'',width:10,checkbox:true}; tblColums.push(oColumn);
        oColumn= { field :"IsWarpSt", title:"Type", width:"5%"}; tblColums.push(oColumn);
        oColumn= { field :"ProductName", title:"ProductName", width:"10%"}; tblColums.push(oColumn);
        oColumn= { field :"RGB", title:"Color", width:"10%"}; tblColums.push(oColumn);
        oColumn= { field:'ColorInHEX', title:'ColorView', width:'15%',
            formatter:function(val, row, idx)
            {
                return '<div style="background-color:'+val+';">('+val+')</div>';
            } }; tblColums.push(oColumn);
            oColumn= { field :"Count1", title:"1", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count2", title:"2", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count3", title:"3", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count4", title:"4", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count5", title:"5", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count6", title:"6", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count7", title:"7", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count8", title:"8", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count9", title:"9", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Count10", title:"10", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"RepeatNo", title:"Repeat", width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"CountT", title:"Total", width:"5%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
          
            $('#tblFabricPlanningDetail').datagrid({ columns:[tblColums]});
    }
    MakeGrid();
   
    /*============COLOR PICKER CODE START============================*/
    var picker = new CP(document.getElementById('btnPickColor')),
        output = document.getElementById('txtRGB');
    picker.on("change", function(color)
    {
        // convert to RGB
        $('#txtRGBPriview').val('#'+color);
        var rgb = CP.HEX2RGB(color);
        output.value = rgb.join(', ');
    });
    function ColorChange(nType)
    {
        debugger;
        if(nType==1 && $('#txtRGB').val().split(',').length==3)
        {
            var color=$('#txtRGB').val();
            var hex = CP.RGB2HEX(color.split(','));
            $('#txtRGBPriview').val('#'+hex);
        }
        else if(nType==2)
        {
            var color=$('#txtRGBPriview').val();
            var rgb = CP.HEX2RGB(color.replace('#',''));
            output.value = rgb.join(', ');
        }
    };
    /*============COLOR PICKER CODE ENDS============================*/

    function GetWarpWeftTypes(nId){
        if(nId==true)
            return "Warp";
        return 'Weft';
    }

    $('#tblFabricPlanningDetail').datagrid({selectOnCheck:false, checkOnSelect:false});

    function Initialization(oFabricPlanning, sOperation){
        ResetControll();
        if(sOperation=="View")
        {
            $('#toolbar,#btnSave,.ics-pick').hide();
            $('input,select').not('#txtFabricPlanningNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('input,select').not('#txtFabricPlanningNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
    }

    function Refresh(oData)
    {
        for(var i=0;i<oData.length;i++)
        {
            oData[i].ColorInHEX="#"+CP.RGB2HEX(oData[i].RGB.split(','));
        }
        DynamicRefreshList(oData, 'tblFabricPlanningDetail');
    }

    function ResetDetail(bIsProductReset){
        _oFabricPlanningDetail=null;
        if(bIsProductReset)
        {
            _nProductID=0;
            _nFabricPlanningColorID=0;
            $('#txtProduct').val("");
            
        }
        $('#lblEditUpdate').text('Edit');
    }

    function ValidationDetail(){

        if(_nProductID<=0){
            $('#txtProduct').focus();
            $('#txtProduct').addClass("errorFieldBorder");
            alert('No product found.');
            return false;
        }
        else{
            $('#txtProduct').removeClass("errorFieldBorder");
        }

        if($('#txtRGB').val().split(',').length!=3)
        {
            $('#txtRGB').focus();
            $('#txtRGB').addClass("errorFieldBorder");
            alert('Valid RGB Color Is required.');
            return false;
        }
        else{
            $('#txtRGB').removeClass("errorFieldBorder");
        }

        //if($.trim($('#cboWarp').val())==0){
        //    alert('Planning Type Is required.');$('#cboWarp').focus();
        //    return false;
        //}
        return true;
    }

    function RefreshObjectDetail(bIsUpdate){
        var oFabricPlanningDetail={
            FabricPlanningID: (bIsUpdate? (_oFabricPlanning.FabricPlanningID>0 ? _oFabricPlanning.FabricPlanningID:0) : 0 ),
            FabricID:_nFabricID,
            ProductID:_nProductID,
            RGB:$('#txtRGB').val(),
            ColorInHEX:"#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
            IsWarp:$('#cboWarp').val(),
            IsWarpSt:GetWarpWeftTypes($('#cboWarp').val())
        }
        return oFabricPlanningDetail;
    }

    function SaveFabricPlanningDetail(bIsUpdate){
        debugger;
        if (!ValidationDetail()) return false;
        var oFabricPlanningDetail =null;
        if(bIsUpdate==true)
        {
            oFabricPlanningDetail=_oFabricPlanning;
            oFabricPlanningDetail.ProductID=_nProductID,
            oFabricPlanningDetail.RGB=$('#txtRGB').val(),
            oFabricPlanningDetail.ColorInHEX="#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
            oFabricPlanningDetail.IsWarp=$('#cboWarp').val(),
            oFabricPlanningDetail.IsWarpSt=GetWarpWeftTypes($('#cboWarp').val())
        }
        else
        {
            oFabricPlanningDetail = RefreshObjectDetail(bIsUpdate);
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanningDetail,
            ObjectId: oFabricPlanningDetail.FabricPlanningID,
            ControllerName: "FabricPlanning",
            ActionName: "SavePlanning",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oFabricPlanningDetail.FabricPlanningID>0)?"Update Successfully." : "Save Successfully."
        };

        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) 
            {
                debugger;
                if (response.obj.FabricPlanningID > 0 && response.obj.ErrorMessage=='') 
                {    
                    var oFabricPlanning=response.obj;
                    oFabricPlanning.ColorInHEX="#"+CP.RGB2HEX(oFabricPlanning.RGB.split(','));

                    if(bIsUpdate)
                        $('#tblFabricPlanningDetail').datagrid('updateRow',{row:oFabricPlanning, index: parseInt(sessionStorage.getItem("SelectedRowIndex_Detail"))});
                    else
                        $('#tblFabricPlanningDetail').datagrid('appendRow',oFabricPlanning);
                    ResetDetail(false);
                }
                else alert(response.obj.ErrorMessage);
            }
        });
    }

    $("#btnAddDetail").click(function () {
        //if($('#cboWarp').val()==3)
        //{
        //    SaveFabricPlanningDetail(false,1);
        //    SaveFabricPlanningDetail(false,2);
        //}else 
        SaveFabricPlanningDetail(false);
    });

    $('#btnEditDetail').click(function(e){
        debugger;
        if($('#lblEditUpdate').text()=='Edit')
        {
            var oFabricPlanningDetail = $("#tblFabricPlanningDetail").datagrid("getSelected");
            if (oFabricPlanningDetail == null || oFabricPlanningDetail.FabricPlanningID <= 0) { alert("Please select an item from list!"); return false; }
            ResetDetail(true);
            sessionStorage.setItem("SelectedRowIndex_Detail",$('#tblFabricPlanningDetail').datagrid('getRowIndex', oFabricPlanningDetail));
            _nProductID=oFabricPlanningDetail.ProductID;
            _oFabricPlanning=oFabricPlanningDetail;
            $('#txtProduct').val(oFabricPlanningDetail.ProductName);
            $('#txtRGB').val(oFabricPlanningDetail.RGB);ColorChange(1);
            $('#cboWarp').val(oFabricPlanningDetail.IsWarp);
            $('#lblEditUpdate').text('Update');
        }
        else
        {
            //var oFabricPlanningDetail = $("#tblFabricPlanningDetail").datagrid("getSelected");
            //if (oFabricPlanningDetail == null || oFabricPlanningDetail.FabricPlanningID <= 0) { alert("Please select an item from list!"); return false; }
            ////oFabricPlanningDetail.FabricID=_nFabricID;
            //oFabricPlanningDetail.ProductID=_nProductID;
            //oFabricPlanningDetail.RGB=$('#txtRGB').val();
            //oFabricPlanningDetail.ColorInHEX="#"+CP.RGB2HEX($('#txtRGB').val().split(','));
            //oFabricPlanningDetail.IsWarp=$('#cboWarp').val();
            //UpdateFabricPlanningDetail(oFabricPlanningDetail);
            SaveFabricPlanningDetail(true);
        }

    });

    $("#btnRemoveDetail").click(function () {

        var oFabricPlanningDetail = $("#tblFabricPlanningDetail").datagrid("getSelected");
        if (oFabricPlanningDetail == null || oFabricPlanningDetail.FabricPlanningID <= 0) { alert("Please select an item from list!"); return false; }

        if (!confirm("Confirm to Delete?")) return false;
        var nIndex = $("#tblFabricPlanningDetail").datagrid("getRowIndex", oFabricPlanningDetail);
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanningDetail,
            ControllerName: "FabricPlanning",
            ActionName: "DeletePlanning",
            TableId: "tblFabricPlanningDetail",
            IsWinClose: false,
            Message:''
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message == 'deleted') 
            {
                var oFabricPlanningdetails=$('#tblFabricPlanningDetail').datagrid('getRows');
                DynamicRefreshList(oFabricPlanningdetails, 'tblFabricPlanningDetail');
            }
        });
    });

    $('#btnAddPlanDetail').click(function (e) {
        var oFabricPlanningDetail = $("#tblFabricPlanningDetail").datagrid("getSelected");
        if (oFabricPlanningDetail == null || oFabricPlanningDetail.FabricPlanningID <= 0) { alert("Please select an item from list!"); return false; }
        window.open(sessionStorage.getItem('BaseAddress')+"/FabricPlanning/ViewFabricPlanningDetail?nFabricPlanningID="+oFabricPlanningDetail.FabricPlanningID, '_blank');
    });

    $("#btnResetProduct").click(function () {

        $("#txtProduct").val("");
        _nProductID=0;
    });
    $("#btnPickProduct").click(function () {
        var sProductName=$.trim($("#txtProduct").val());
        GetProducts(sProductName);
    });
    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct").val());
            //if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName);
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
        }
    });

    function SetProduct(oProduct)
    {
        if(oProduct !=null  && oProduct.ProductID>0){
            $('#txtProduct').val(oProduct.ProductNameCode);
            _nProductID= oProduct.ProductID;
           
        }
    }
    function GetProducts(sProductName){

        var oProduct = {
            BUID: sessionStorage.getItem("BUID"),
            ModuleNameInInt:201, //FabricPattern
            ProductUsagesInInt:1, //Regular
            ProductName: sProductName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "GetProductsByBUModuleWithProductUse",
            IsWinClose: false
        };

        var tblColums = [];
        var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
        oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

        var oPickerParam = {
            winid: 'winProductPicker',
            winclass:'clsProductPicker',
            winwidth: 520,
            winheight: 460,
            tableid: 'tblProductPicker',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName:'ProductName',
            windowTittle: 'Product List',
            paramObj:obj,
            pkID:'ProductID',
            callBack:SetProduct
        };
        

        $.icsDynamicPicker(oPickerParam);
    }
    function GetProducts_OFF(sProductName){ //ProdyctPIckByFSCID

        if(_nFSCID==0)
        {
            alert('Please Pick A PO And Tray Again!');
        }
        var oFabricSalesContract = {
            FabricSalesContractID:_nFSCID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricSalesContract,
            ControllerName: "FabricSalesContract",
            ActionName: "GetsDetailByFSC",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeProductPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    ///Color Code

    function IntializeProductPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function ()
        {
            ProductSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ProductSelect(oPickerobj);
            }
        });
    }
    function ProductSelect(oPickerobj){
        var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winProductPicker')
        {
            if(oProduct !=null  && oProduct.ProductID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtProduct').val(oProduct.ProductNameCode);
                _nProductID= oProduct.ProductID;
               
            }
            else{
                alert("Please select product.");
            }
        }
        else if (oPickerobj.winid == 'winPOPicker')
        {debugger;
            if (oProduct != null && oProduct.ContractorID > 0)
            {
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                var oFabricSalesContract = oProduct;
                $('#txtPO').val(oFabricSalesContract.SCNo);
                $("#txtPO").addClass("fontColorOfPickItem");
                $('#txtIssueTo').val(oProduct.ContractorName);
                $('#txtDeliverTo').val(oProduct.BuyerName);
                _nDeliveryToID= oProduct.BuyerID;
                _nContractorID= oProduct.ContractorID;
                _nFSCID = oFabricSalesContract.FabricSalesContractID;
            }
            else {
                alert("Please select an item from.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winFabricPicker')
        {
            if (oProduct!= null && oProduct.FabricSalesContractDetailID> 0)
            {
                $('#txtFabricNo').val(oProduct.FabricNo);
                $('#txtFabricNo').addClass('fontColorOfPickItem');
                _nFSCDetailID = oProduct.FabricSalesContractDetailID;
                $('#txtConstruction').val(oProduct.Construction);
                $('#txtComposition').val(oProduct.ProductName);
                debugger;
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtFabricNo').focus();
            }
        }
       

    }

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
   
    $('#btnPrint').click(function (e)
    {
        debugger;
        if (_nFabricID ==null || _nFabricID<=0 ) { alert("Please select an item from list."); return ; }
       
        window.open(_sBaseAddress + '/FabricPlanning/PrintFabricPlanning?nFSCDID='+_oFabricSCReport.FabricSalesContractDetailID+"&buid="+1, "_blank");

    });

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblFabricPlanningDetail').datagrid('validateRow', editIndex)) {
            $('#tblFabricPlanningDetail').datagrid('endEdit', editIndex);
            $('#tblFabricPlanningDetail').datagrid('selectRow', editIndex);
            debugger;
            //InvoiceType: Standard = 1, Advance = 2
            //ReferenceType : Open = 1, PO = 2, Import = 3
            var oFabricPlanning = $('#tblFabricPlanningDetail').datagrid('getSelected');
            if (oFabricPlanning.FabricPlanningID>0) {
                UpdateFP(oFabricPlanning, editIndex);
            }
            else
            {
                $('#tblFabricPlanningDetail').datagrid('updateRow', { index: editIndex, row: oFabricPlanning });
            }

          //  RefreshSummery();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {
        if (editIndex != index) {
            if (endEditing()) {
                $('#tblFabricPlanningDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oFabricPlanning= $('#tblFabricPlanningDetail').datagrid('getSelected');
                //if(oPurchaseInvoiceDetail.PurchaseInvoiceDetailID<=0){
                //    $('#btnAddSpecification').hide();
                //}
                //else{
                //    $('#btnAddSpecification').show();
                //}
                editIndex = index;
            }
            else {
                $('#tblFabricPlanningDetail').datagrid('selectRow', editIndex);
            }
        }
    }

    function UpdateFP(oFabricPlanning, SelectedRowIndex)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricPlanning/SavePlanning",
            traditional: true,
            data: JSON.stringify(oFabricPlanning),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
            
                var oFabricPlanning = jQuery.parseJSON(data);
            
                if (parseInt(oFabricPlanning.FabricPlanningID) > 0) {
                    $('#tblFabricPlanningDetail').datagrid('updateRow', { index: SelectedRowIndex, row: oFabricPlanning });
                   // RefreshTotalSummery();
                }
                else {
                    alert(oFabricPlanning.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    /////Twist
    function formatTwisted(value){

        if(value>0){
            return "Twisted";
        }
        else{
            return "";
        }
    }
    function onLoadSuccess(data)
    {
        debugger;
        var nIndex=0;
        var nSpan=0;
        for(var i=0;i<_oCellRowSpans.length;i++){
            var oMCell=[_oCellRowSpans[i].mergerCell];
            nIndex=oMCell[0][0];
            nSpan= oMCell[0][1];
            if(_oCellRowSpans[i].FieldName=="ComboNo"){
                $(this).datagrid('mergeCells',{index: nIndex, field: 'ComboNo', rowspan: nSpan});
                $(this).datagrid('mergeCells',{index: nIndex, field: 'RepeatNo', rowspan: nSpan});
 
            }
        }
    }
   


    $('#btnMakeTwisted').click(function(e){
        
        debugger;
        var oFabricPlannings= $('#tblFabricPlanningDetail').datagrid('getChecked');

        if(oFabricPlannings.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sFabricPlanningIDs="";
        for(var i=0; i<oFabricPlannings.length; i++){
            sFabricPlanningIDs = sFabricPlanningIDs + oFabricPlannings[i].FabricPlanningID +",";
        }
        sFabricPlanningIDs=sFabricPlanningIDs.substring(0,sFabricPlanningIDs.length-1);

        var oFabricPlanning={
            FSCDID: oFabricPlannings[0].FSCDID,
            FabricID:oFabricPlannings[0].FabricID,
            FabricPlanningID: oFabricPlannings[0].FabricPlanningID,
            ComboNo: 0,
            ErrorMessage: sFabricPlanningIDs
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanning,
            ObjectId: oFabricPlanning.FabricPlanningID,
            ControllerName: "FabricPlanning",
            ActionName: "MakeCombo",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oDyeingOrderDetail.FabricPlanningID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.FabricPlannings.length > 0 && response.obj.FabricPlannings[0].FabricPlanningID>0) {
                
                    _oCellRowSpans=response.obj.FabricPlannings[0].CellRowSpans;
                 //   DynamicRefreshList(response.obj.FabricPlannings, 'tblFabricPlanningDetail');
                    Refresh(response.obj.FabricPlannings);debugger;

                }
                else if(response.obj.FabricPlannings.length > 0 && response.obj.FabricPlannings[0].FabricPlanningID<=0){
                    alert(response.obj.FabricPlannings[0].ErrorMessage);
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    $('#btnRemoveTwisted').click(function(e){

        var oFabricPlannings= $('#tblFabricPlanningDetail').datagrid('getChecked');

        if(oFabricPlannings.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sFabricPlanningIDs="";
        for(var i=0; i<oFabricPlannings.length; i++){
            sFabricPlanningIDs = sFabricPlanningIDs + oFabricPlannings[i].FabricPlanningID +",";
        }
        sFabricPlanningIDs=sFabricPlanningIDs.substring(0,sFabricPlanningIDs.length-1);

        var oFabricPlanning={
            FSCDID: oFabricPlannings[0].FSCDID,
            FabricID:oFabricPlannings[0].FabricID,
            FabricPlanningID: oFabricPlannings[0].FabricPlanningID,
            ComboNo: 0,
            ErrorMessage: sFabricPlanningIDs
        }


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanning,
            ObjectId: oFabricPlanning.FabricPlanningID,
            ControllerName: "FabricPlanning",
            ActionName: "RemoveComboGroup",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oDyeingOrderDetail.FabricPlanningID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.FabricPlannings.length > 0 && response.obj.FabricPlannings[0].FabricPlanningID>0) {
                    _oCellRowSpans=response.obj.FabricPlannings[0].CellRowSpans;
                 //   DynamicRefreshList(response.obj.DyeingOrderDetails, 'tblFabricPlanningDetail');
                    Refresh(response.obj.FabricPlannings);debugger;
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    function formatPrice(val,row)
    {
   
        val=parseFloat(val);
        var test = val.toFixed(0);
        if (val <= 0)
        {
            test=(-1*test);
        }
        var tests =test;// addComma(test);
        if (val <= 0)
        {
            return '';
        }
        else 
        {
            return tests;
        }

    }
    function CopyDetail()
    {
        debugger;
        if(parseInt($('#cboWarp').val())<=0)    {alert("Please Selet Warp/Weft Type"); return false}

        var oFabricPlannings= $('#tblFabricPlanningDetail').datagrid('getChecked');
        var oFabricPlannings_New=[];
        for(var i =0;i<oFabricPlannings.length;i++)
        {

            var oFabricPlanning={
                FabricPlanningID:0,
                FabricPlanningID: 0,
                ProductID:oFabricPlannings[i].ProductID,
                RGB:oFabricPlannings[i].RGB,
                //ColorSet:$('#txtColorSet').val(),
                ColorInHEX:oFabricPlannings[i].ColorInHEX,
                IsWarp:(oFabricPlannings[i].IsWarp==true)?false:true,
                IsWarpSt:(oFabricPlannings[i].IsWarp==true)?"Weft":"Warp",
                Color:oFabricPlannings[i].Color,
                FabricID:oFabricPlannings[i].FabricID,
                ProductName:oFabricPlannings[i].ProductName,
                RGB:oFabricPlannings[i].RGB,
                Value:oFabricPlannings[i].Value
            }

            //var bExists= IsExist(oFabricPlanning)
            //if(!bExists)
            //{
            $('#tblFabricPlanningDetail').datagrid('appendRow',oFabricPlanning);
            var oLDpDetail = $('#tblFabricPlanningDetail').datagrid('getRows');
            UpdateFP(oFabricPlanning,oLDpDetail.length );
            //}
           
            //oFabricPlannings_New.push(oFabricPlanning);
        }

    }
    
    function IsExist(oFabricPlanning)
    {
        var oLDpDetail = $('#tblFabricPlanning').datagrid('getRows');
        for (var i = 0; i < oLDpDetail.length; i++) {
            if (parseInt(oLDpDetail[i].WarpWeftType) ==parseInt(oFabricPlanning.WarpWeftType) && oLDpDetail[i].ColorName ==oFabricPlanning.ColorName)
            {
                return true;
            }
        }

        return false;
    }
    $('#btnRefresh').click(function(e){

        endEditing();
    });

</script>