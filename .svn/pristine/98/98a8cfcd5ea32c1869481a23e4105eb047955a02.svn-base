<html>
<head>
    <title>Delivery Challlan </title>
</head>
<body>

    @model ESimSol.BusinessObjects.DUDeliveryOrderDC
    <div class="menuMainCollectionTable">

        <fieldset>
         <legend style="font-weight:bold"> </legend>
            <table style="width:100%" cellpadding="1" cellspacing="0">

                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Deliver To</label>
                    </td>
                    <td style="width: 60%; text-align: left">
                        <input id="txtDeliverTo" style="width: 70%;" class="reset-text" placeholder="Search Delivery To" />
                        @*<a id="btnPickDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>*@
                    </td>
                   
                    <td style="width: 8%; text-align: right">
                        <label>Challan No</label>
                    </td>
                    <td style="width: 14%; text-align: left">
                        <input id="txtChallanNo" style="width: 75%" placeholder="Auto Generate" disabled="disabled" />
                    </td>
                    <td style="width: 8%; text-align: right">
                        <label>Date</label>
                    </td>
                    <td style="width: 10%; text-align: left">
                        <input id="txtChallanDate" type="date" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend style="font-weight:bold"> Delivery Challan entry: </legend>
            <table cellpadding="2" cellspacing="2" style="width:100%">
                <tr>
                    
                    <td style="width: 15%; text-align: right">
                        <label>Store</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <select style="width: 100%;" id="cboWorkingUnit" ></select>
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Order Type</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <select style="width: 100%;" id="cboOrderType" onchange="ChangeOrderType()"></select>
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Order No</label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input id="txtOrderNo" style="width: 100%;" class="reset-text" />
                    </td>
                  
                </tr>
                <tr>

                    <td style="width: 15%; text-align: right">
                        <label>Driver Name</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtReceivedByName" style="width: 100%;" class="reset-text" />
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Carrier</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtCarrier" style="width: 100%;" class="reset-text" />
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Vehicle No</label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input id="txtVehicleNo" style="width: 100%;" class="reset-text"/>
                    </td>

                </tr>

                <tr>
                    <td style="width: 15%; text-align: right">
                        <label>Gate Pass No</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtGatePassNo" style="width: 100%;" class="reset-text" />
                    </td>
                    
                    <td style="width: 15%; text-align: right">
                        <label>Remarks</label>
                    </td>
                    <td colspan="3" style="width: 25%; text-align: left">
                        <input id="txtNote" style="width: 100%;" class="reset-text" placeholder="Remarks" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend style="font-weight:bold">Delivery Order info </legend>
            <table style="width:100%" cellpadding="0" cellspacing="1">

                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>DO No</label>
                    </td>
                    <td style="width: 30%; text-align: left">
                        <input id="txtDONo" style="width: 80%;" class="reset-text" placeholder="Search DO No" />
                        <a id="btnPickDO" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>

                    <td style="width: 20%; text-align: right">
                        <label>Product Name </label>
                    </td>
                    <td style="width: 20%; text-align: left">
                        <input id="txtProduct" style="width: 80%" class="reset-text" />
                        <a id="btnPickDODetail" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                </tr>
                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Color</label>
                    </td>
                    <td style="width: 30%; text-align: left">
                        <input id="txtPTU" style="width: 80%;" class="reset-text" placeholder="Search Color" />
                        <a id="btnPickPTU" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>

                    <td style="width:20%; text-align: right">
                        <label>Lot </label>
                    </td>
                    <td style="width: 20%; text-align: left">
                        <input id="txtLot" style="width: 80%" class="reset-text" />
                        <a id="btnPickLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend>Delivery Challan Detail</legend>
            <table id="tblDUDeliveryChallanDetail" class="easyui-datagrid" style="width:100%;height:200px;"
                   data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbar',onClickRow:onClickRow ">
                
                    <thead>
                        <tr>
                            <th field="DONo" width="10%" align="center">DO No</th>
                            <th field="ProductName" width="40%" align="left">Yarn</th>
                            <th field="ColorName" width="10%" align="left">Color Name</th>
                            <th field="LotNo" width="10%" align="left">Lot No</th>
                            <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="15%">Qty(LBS)</th>
                            <th data-options="field:'Note',width:100,height:60 ,align:'Left',editor:{type:'text'}" width="20%" align="Left">Remark</th>
                            @*<th field="Qty" width="10%" align="right" formatter="formatPrice">Qty(Lbs)</th>*@
                            
                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                    <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                </div>
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                        <td style="width:65%;  text-align:right;font-weight:bold;">Total:</td>
                        <td style="width:10%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label> </td>
                        <td style="width:5%;  text-align:right;font-weight:bold;"> </td>
                       
                    </tr>
                </table>
</fieldset>

        <fieldset>
            <legend>Action</legend>
            <div class="align-right">
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                    <tr>
                        <td style=" float:left;  width:10%; ">
                            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                        </td>
                        <td style=" float:left;  width:10%; ">
                        </td>
                        <td style=" float:left;  width:60%; "></td>
                        <td style=" float:right;  width:20%; ">
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnDisburse" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Disburse</a>
                            <a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Cancel</a>
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>

                </table>

            </div>

        </fieldset>
    </div>

</body>
</html>

<style type="text/css">
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oDUDeliveryChallan=null;
    var _oDUDeliveryOrderDC=null;
    var _nContractorID=0;
    var _nProductID=0;
    
    var _oCPIssueTos=[];
    var _oCPDeliveryTos=[];
    var _oOrderTypes=[];
    var _nDOID=0;
    var _nDUDeliveryOrderDetailID=0;
    var _oDUDeliveryChallanDetail=[];
    var _nSelectedRowIndex=0;
    var _sBackLink="";
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oDUDeliveryOrderDC =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oCPIssueTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPIssueTos));
        _oCPDeliveryTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPDeliveryTos));
        var oOrderTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.OrderTypes));
        var oWorkingUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WorkingUnits));
        _oDUDeliveryChallan=oDUDeliveryOrderDC.DUDeliveryChallan;
        _nDOID=oDUDeliveryOrderDC.DUDeliveryOrderID;
        debugger;
        $("#cboOrderType").icsLoadCombo({
            List: oOrderTypes,
            OptionValue: "OrderType",
            DisplayText: "ShortName"
        });
        $("#cboWorkingUnit").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:""
        });
        Initialization(_oDUDeliveryChallan,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'));
        _sBackLink=sessionStorage.getItem("BackLink");
        Control_disabled();
    });
    function Control_disabled()
    {
        document.getElementById("txtDeliverTo").disabled = true;
        document.getElementById("cboOrderType").disabled = true;
        document.getElementById("txtOrderNo").disabled = true;
        //document.getElementById("txtOrderNo").disabled = true;
        document.getElementById("txtDONo").disabled = true;
    }

    function Initialization(oDUDeliveryChallan, sOperation){
        //ResetControll();
        RefreshControl(oDUDeliveryChallan);

        if(sOperation=="View")
        {
            $('#toolbar,#btnDisburse,#btnSave,#btnCancel,.ics-pick').hide();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
      
        else if(sOperation=="Approve")
        {
            $('#toolbar,#btnSave,#btnCancel,.ics-pick').hide();
            $('#btnDisburse').show();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('#btnDisburse,#btnCancel').hide();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
        ChangeOrderType();
    }


    function LoadIssueContactPersonnel(oCPs){
        $("#cboCPIssueTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }

    function LoadDeliveredContactPersonnel(oCPs){
        $("#cboCPDeliverTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }


    function ResetControll(){
        _oDUDeliveryChallan=null;

        $('.reset-text').val("");
        //$('#dtOrderDate,#dtSeekingDate').datebox('setValue', icsdateformat(new Date()));
        //LoadIssueContactPersonnel(_oCPIssueTos);
        //LoadDeliveredContactPersonnel(_oCPDeliveryTos);
        ////$('.number').val("0.00");
        //ResetDetail();
        DynamicRefreshList([], 'tblDUDeliveryChallanDetail');
        RefreshSummary();
    }

   

    function RefreshControl(oDUDeliveryChallan){
        debugger;
       
        _oDUDeliveryChallan=oDUDeliveryChallan;
        _nContractorID=oDUDeliveryChallan.ContractorID;//
      
        $('#txtDeliverTo').val(oDUDeliveryChallan.ContractorName);
        $('#txtChallanNo').val(oDUDeliveryChallan.ChallanNo);
        $('#txtChallanDate').datebox('setValue',oDUDeliveryChallan.ChallanDateSt);
        $('#cboWorkingUnit').val(oDUDeliveryChallan.WorkingUnitID);
        $('#cboOrderType').val(oDUDeliveryChallan.OrderType);
        $('#txtOrderNo').val(oDUDeliveryChallan.OrderNos);
        $('#txtNote').val(oDUDeliveryChallan.Note);
        $('#txtReceivedByName').val(oDUDeliveryChallan.ReceivedByName);
        $('#txtCarrier').val(oDUDeliveryChallan.VehicleName);
        $('#txtVehicleNo').val(oDUDeliveryChallan.VehicleNo);
        $('#txtGatePassNo').val(oDUDeliveryChallan.GatePassNo);
        $('#txtDONo').val(oDUDeliveryChallan.DONos);
      
        if(oDUDeliveryChallan.DUDeliveryChallanDetails!==null && oDUDeliveryChallan.DUDeliveryChallanDetails.length>0)
        {
            DynamicRefreshList(oDUDeliveryChallan.DUDeliveryChallanDetails, 'tblDUDeliveryChallanDetail');
        }
        else{
            DynamicRefreshList([], 'tblDUDeliveryChallanDetail');
        }
        RefreshSummary();

    }

    function ChangeOrderType()
    {

        var ncboOrderType=parseInt($("#cboOrderType").val());
       // if(ncboOrderType===2)
       // {
       //     $(".lblLCNo").html("Invoice No");
       //     $(".lblOrderNo").html("Sample No");
       // }
       //else
       // {
       //    $(".lblLCNo").html("L/C No");
       //    $(".lblOrderNo").html("P/I No");
       // }

    }

    function Validation(){

        //if(_oDUDeliveryChallan.OrderID<=0)
        //{
        //    $('#txtExportPINo').focus();
        //    $('#txtExportPINo').addClass("errorFieldBorder");
        //    alert('Pick Order No .');
        //    return false;
        //}
        if(_nContractorID<=0){
            $('#txtDeliverTo').focus();
            $('#txtDeliverTo').addClass("errorFieldBorder");
            alert('Challan issue to required.');
            return false;
        }
        else{
            $('#txtDeliverTo').removeClass("errorFieldBorder");
        }
        return true;
    }

    function RefreshObject()
    {

        var oDUDeliveryChallan={
            DUDeliveryChallanID: (_oDUDeliveryChallan!=null && _oDUDeliveryChallan.DUDeliveryChallanID>0)? _oDUDeliveryChallan.DUDeliveryChallanID:0,
            ContractorID: _nContractorID,
            ContactPersonnelID: 0,
            WorkingUnitID: $('#cboWorkingUnit').val(),
            OrderType: $('#cboOrderType').val(),
            Note:$.trim($('#txtNote').val()),
            ChallanDate:$('#txtChallanDate').datebox('getValue'),
            ReceivedByName:$.trim($('#txtReceivedByName').val()),
            VehicleName:$.trim($('#txtCarrier').val()),
            VehicleNo:$.trim($('#txtVehicleNo').val()),
            GatePassNo:$.trim($('#txtGatePassNo').val()),
            DUDeliveryChallanDetails:$('#tblDUDeliveryChallanDetail').datagrid('getRows')

        };
        return oDUDeliveryChallan;
    }

      



    $("#btnPickDeliverTo").click(function () {
        var sContractorName=$.trim($("#txtDeliverTo").val());
      
        GetContractors(sContractorName);
    });
    $("#txtDeliverTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtDeliverTo").val());
            _bIsIssueTo=false;
            GetContractors(sContractorName);
        }
        else if(nkeyCode==8){
            $("#txtDeliverTo").val("");
            _nContractorID=0;
            $("#txtDeliverTo").empty();

        }
    });
    $("#btnResetDeliverTo").click(function () {
        $("#txtDeliverTo").val("");
        _nContractorID=0;
        $("#cboCPDeliverTo").empty();
    });
    function GetContractors(sContractorName){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }




   


    //Pick DO
    $("#btnPickDO").click(function () 
    {
        var oDO = {
            ContractorID:_nContractorID,
            OrderType:$("#cboOrderType").val(),
            DONo:""
        };
        GetsDOs(oDO);
    });
    $("#txtDONo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sDONo=$.trim($("#txtDONo").val());
            var oDO = {
                ContractorID:_nContractorID,
                OrderType:$("#cboOrderType").val(),
                DONo:sDONo
            };
            GetsDOs(oDO);
        }
        else if(nkeyCode==8){
            $("#txtDONo").val("");
        }
    });
    function GetsDOs(oDO){
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDO,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetDOs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0)
            {
                if (response.objs[0].DUDeliveryOrderID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "DONoFull", title: "DO No", width: 160, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderTypeSt", title: "Type", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "Order No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "DeliveryDateSt", title: "Delivery Date", width: 100, align: "left" };tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winDOPicker',
                        winclass:'clsDOPicker',
                        winwidth: 660,
                        winheight: 460,
                        tableid: 'tblDOPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'DONoFull',
                        windowTittle: 'DO List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data not found.");
            }
        });


    }
    //End DO Pick

    //Pick DODetail
    $("#btnPickDODetail").click(function () {

        if(_nDOID<=0)
        {
            alert("Please, first Pick DO");
            $("#txtDONo").focus()
            return;
        }
        GetProducts(_nDOID)
    });
    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(_nDOID<=0)
            {
                alert("Please, first Pick DO");
                $("#txtDONo").focus()
                return;
            }

            GetProducts(_nDOID);
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
        }
    });
    function GetProducts(nDOID){

        var oDO = {
            DUDeliveryOrderID:nDOID,
            DONo:""
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDO,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetDODs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductName", title: "Name", width: 220, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "ProductName", title: "Name", width: 220, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "DO Qty", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_DC", title: "Delivery Qty", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "YetToDC", title: "Yet To Delivery", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    //End DODetail
    //Pick PTU
    $("#btnPickPTU").click(function () 
    {
        var oDCD = {
            DOID:_nDOID,
            OrderType:$("#cboOrderType").val(),
            ProductID:_nProductID
         
        };
        GetsPTU(oDCD)
    });
    $("#txtPTU").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var oDCD = {
                DOID:_nDOID,
                OrderType:$("#cboOrderType").val(),
                ProductID:_nProductID
            };
            GetsPTU(oDCD)
        }
        else if(nkeyCode==8){
            $("#txtPTU").val("");
            _oDUDeliveryChallanDetail=null;
        }
    });
    function GetsPTU(oDCD){

    
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDCD,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetPTUs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductName", title: "Name", width: 220, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Yet To Delivery", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "OrderQty", title: "Order Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "DeliveryQty", title: "Delivery Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 60, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winPTUPicker',
                        winclass:'clsPTUPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblPTUPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    //End PTU
    //Pick Lot
    $("#btnPickLot").click(function () 
    {
        _oDUDeliveryChallanDetail.DODetailID=_nDUDeliveryOrderDetailID;
        _oDUDeliveryChallanDetail.WorkingUnitID= $('#cboWorkingUnit').val();
        GetsLot(_oDUDeliveryChallanDetail)
    });
    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
          
            _oDUDeliveryChallanDetail.DODetailID=_nDUDeliveryOrderDetailID;
            _oDUDeliveryChallanDetail.WorkingUnitID= $('#cboWorkingUnit').val();
            GetsLot(_oDUDeliveryChallanDetail)
        }
        else if(nkeyCode==8){
            $("#txtPTU").val("");
            _oDUDeliveryChallanDetail=null;
        }
    });
    function GetsLot(oDCD){

    
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDCD,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetLots",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "LotNo", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "MUName", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Balance", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 200, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data not found.");
            }
        });


    }
    //End PTU
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winContractorPicker')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                $('#txtDeliverTo').val(oreturnObj.Name);
                _nContractorID= oreturnObj.ContractorID;
                //  GetContactPersonel(oreturnObj.ContractorID);
            }
            else{
                $('#txtDeliverTo').focus();
                $('#txtDeliverTo').addClass("errorFieldBorder");
                alert("Data not found");
                return;
            }
        }
        else if (oPickerobj.winid=='winDOPicker')
        {
            if(oreturnObj!=null && parseInt(oreturnObj.DUDeliveryOrderID)>0)
            {
                debugger;
                var txtDONo = document.getElementById("txtDONo");
                txtDONo.style.color = "blue";
                txtDONo.style.fontWeight = "bold";
                _nDOID=oreturnObj.DUDeliveryOrderID;
                _nProductID=0;
                $('#txtDONo').val(oreturnObj.DONoFull);
                $('#txtDeliverTo').val(oreturnObj.DeliveryToName);
                _nContractorID= oreturnObj.ContractorID;
                $('#txtOrderNo').val(oreturnObj.OrderNo);
                $('#cboOrderType').val(oreturnObj.OrderType);
                $('#txtProduct').focus();
                $('#txtProduct').addClass("errorFieldBorder");
            }
            else
            {
                $('#txtDONo').focus();
                $('#txtDONo').addClass("errorFieldBorder");
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnObj != null && oreturnObj.ProductID > 0)
            {
                _nProductID=oreturnObj.ProductID ;
                _nDUDeliveryOrderDetailID=oreturnObj.DUDeliveryOrderDetailID;
                $('#txtProduct').val(oreturnObj.ProductName);
                _oDUDeliveryChallanDetail=null;
                $('#txtPTU').val("");
                $('#txtPTU').focus();
                $('#txtPTU').addClass("errorFieldBorder");
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winPTUPicker')
        {
            if (oreturnObj.PTUID > 0)
            {
                _oDUDeliveryChallanDetail=oreturnObj;
                $('#txtPTU').val(_oDUDeliveryChallanDetail.ProductName+", Color:"+_oDUDeliveryChallanDetail.ColorName);
                $('#txtLot').val("");
                $('#txtLot').focus();
                $('#txtLot').addClass("errorFieldBorder");
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winLotPicker')
        {
            if (oreturnobjs.length > 0)
            {
                debugger;

                if(_nDUDeliveryOrderDetailID<=0 || _nDUDeliveryOrderDetailID==null)
                {
                    $('#txtProduct').focus();
                    $('#txtProduct').addClass("errorFieldBorder");
                    alert("Product not Found.");
                    return;
                }
              
                for (i=0; i<oreturnobjs.length;i++)
                {
                    //_oDUDeliveryChallanDetail.LotID=oreturnobjs[i].LotID;
                    //_oDUDeliveryChallanDetail.LotNo=oreturnobjs[i].LotNo;
                    //_oDUDeliveryChallanDetail.Qty=oreturnobjs[i].Qty;
                    var oDCD={
                        DONo: $('#txtDONo').val(),
                        ProductName:_oDUDeliveryChallanDetail.ProductName,
                        ColorName:_oDUDeliveryChallanDetail.ColorName,
                        LotNo:oreturnobjs[i].LotNo,
                        Qty:oreturnobjs[i].Qty,
                        Note:"",
                        ProductID:_oDUDeliveryChallanDetail.ProductID,
                        LotID:oreturnobjs[i].LotID,
                        OrderID: _oDUDeliveryChallanDetail.OrderID,
                        DODetailID :_nDUDeliveryOrderDetailID,
                        OrderType: _oDUDeliveryChallanDetail.OrderType,
                        PTUID:_oDUDeliveryChallanDetail.PTUID
                    }
                  
                    $('#tblDUDeliveryChallanDetail').datagrid('appendRow', oDCD);
                }
                endEditing();
                RefreshSummary();
                _oDUDeliveryChallanDetail=null;
                $('#txtPTU').val("");
                _nProductID=0;
                $('#txtProduct').val("");
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
    }

   
    $("#btnSave").click(function (){
        debugger;
        endEditing();
        if(!Validation()) return false;

        debugger;
        var oDUDeliveryChallan=RefreshObject();
        //if(!ValidateInput_Two()) return;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/DUDeliveryChallan/Save",
            traditional: true,
            data:  JSON.stringify(oDUDeliveryChallan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDC= jQuery.parseJSON(data);
                if (oDUDC.ErrorMessage=="" || oDUDC.ErrorMessage==null)
                {
                    _oDUDeliveryChallan=oDUDO;
                    alert("Data Save Succesfully!!");
                  

                    var oDUDeliveryOrderDCs =sessionStorage.getItem("DUDeliveryOrderDCs");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oDUDeliveryOrderDCs!=null)
                    {
                        oDUDeliveryOrderDCs = jQuery.parseJSON(oDUDeliveryOrderDCs);
                    }
                    else
                    {
                        oDUDeliveryOrderDCs=[];
                    }
                    if(nIndex!=-1)
                    {
                        oDUDeliveryOrderDCs[nIndex].Qty_DC=oDUDO.Qty;;
                    }
                    
                    sessionStorage.setItem("DUDeliveryChallans", JSON.stringify(oDUDeliveryChallans));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDC.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });




    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });


    $("#btnRemoveDetail").click(function () {

        var oDUDeliveryChallanDetail = $("#tblDUDeliveryChallanDetail").datagrid("getSelected");
        if (oDUDeliveryChallanDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblDUDeliveryChallanDetail').datagrid('getRowIndex',oDUDeliveryChallanDetail);
        if (!confirm("Confirm to Delete?")) return false;
        $("#tblDUDeliveryChallanDetail").datagrid("deleteRow", nIndex);
        RefreshSummary();

    });



    function RefreshSummary()
    {
        var oDODetails = $('#tblDUDeliveryChallanDetail').datagrid('getRows');
        var nTotalQty = 0, nTotalAmount= 0;
        for(var i = 0; i<oDODetails.length;i++)
        {
            nTotalQty+=parseFloat(oDODetails[i].Qty);

        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0)+"LBS";

    }
    //////////// Detail ////////
  
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblDUDeliveryChallanDetail').datagrid('validateRow', editIndex)) {
            $('#tblDUDeliveryChallanDetail').datagrid('endEdit', editIndex);
            $('#tblDUDeliveryChallanDetail').datagrid('selectRow', editIndex);
            var oESCDetail = $('#tblDUDeliveryChallanDetail').datagrid('getSelected');

            debugger;
            $('#tblDUDeliveryChallanDetail').datagrid('updateRow', { index: editIndex, row: oESCDetail });

          //  RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblDUDeliveryChallanDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblDUDeliveryChallanDetail').datagrid('getSelected');

                editIndex = index;
            }
            else {
                $('#tblDUDeliveryChallanDetail').datagrid('selectRow', editIndex);
            }
        }
    }


    $('#btnDisburse').click(function () {

        debugger;
        var conf = confirm("Are you sure you want to Approve ?");
        if(conf==false)return;

        if (_oDUDeliveryChallan ==null || _oDUDeliveryChallan.DUDeliveryChallanID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oDUDeliveryChallan.ApproveBy!=0)
        {
            alert("Already Approve.");
            return;
        }


        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/DUDeliveryChallan/Approve",
            traditional: true,
            data:  JSON.stringify(_oDUDeliveryChallan),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oDUDeliveryChallan=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oDUDeliveryChallans =sessionStorage.getItem("DUDeliveryChallans");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oDUDeliveryChallans!=null)
                    {
                        oDUDeliveryChallans = jQuery.parseJSON(oDUDeliveryChallans);
                    }
                    else
                    {
                        oDUDeliveryChallans=[];
                    }
                    if(nIndex!=-1)
                    {
                        oDUDeliveryChallans[nIndex]=_oDUDeliveryChallan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oDUDeliveryChallans.length);
                        oDUDeliveryChallans.push(_oDUDeliveryChallan);
                    }
                    sessionStorage.setItem("DUDeliveryChallans", JSON.stringify(oDUDeliveryChallans));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });



  


    $('#btnPrint').click(function (e)
    {

        if (_oDUDeliveryChallan ==null || _oDUDeliveryChallan.DUDeliveryChallanID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        var bIsPrintHistory=false;
        window.open(_sBaseAddress+ "/DUDeliveryChallan/PrintDUDeliveryChallan?nId="+_oDUDeliveryChallan.DUDeliveryChallanID+"&bIsPrintHistory="+bIsPrintHistory+"&nts="+tsv, "_blank");

    });


</script>