@{
    ViewBag.Title = "Payment List";
}
@model IEnumerable<ESimSol.BusinessObjects.TradingPayment>
    <div id="progbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div style="margin-left:0px; height:100%; width:100%; font-family:Tahoma">
            <table id="tblTradingPayments" title="Payment List" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
                <thead>
                    <tr>
                        <th field="RefNo" width="90">MR No</th>
                        <th field="PaymentDateSt" width="90">Payment Date</th>
                        <th field="ContractorName" width="130">Contractor</th>
                        <th field="AccountHeadName" width="120">Account Head</th>
                        <th field="ApprovedByName" width="120">Approved By</th>
                        <th field="CurrencyName" width="60">Currency</th>
                        <th field="Amount" width="100" formatter="formatPrice" align="right">Amount</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar">
                <input type="text" id="txtSearchByMRNo" placeholder="Search by MR No" style="width:150px" />
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv Search</a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnWaitForApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Wait for Approved</a>
                <a id="btnApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approved</a>
                <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
                <a id="btnPrintList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print List</a>
            </div>
        </div>

        <div id="winAdvanceSearch" class="easyui-window" title="Advance Search" style="width:540px;height:345px;padding:2px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div>
                <fieldset>
                    <legend style="font-weight:bold"> Searching Criteria : </legend>
                    <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                        <tr>
                            <td style="width:170px; text-align:right">
                                MR No :
                            </td>
                            <td style="width:370px">
                                <input type="text" style="width: 370px;" id="txtMRNo" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                Invoice No :
                            </td>
                            <td style="width:370px">
                                <input type="text" style="width: 370px;" id="txtInvoiceNo" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                TradingPayment Account :
                            </td>
                            <td style="width:370px">
                                <select style="width:375px" id="cboTradingPaymentAccount"></select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                TradingPayment Date :
                            </td>
                            <td style="width:370px">
                                <table border="0" cellpadding="0" cellspacing="0" style="font-size: 12px">
                                    <tr>
                                        <td style="width: 120px; font-size: 12px; text-align: left">
                                            <select id="cboPaymentDate" style="width:120px"></select>
                                        </td>
                                        <td style="width: 120px; font-size: 12px">
                                            <input id="txtTradingPaymentStartDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                        </td>
                                        <td style="width: 10px; font-size: 12px">
                                            To
                                        </td>
                                        <td style="width: 120px; font-size: 12px">
                                            <input id="txtTradingPaymentEndDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                TradingPayment Amount :
                            </td>
                            <td style="width:370px">
                                <table border="0" cellpadding="0" cellspacing="0" style="font-size: 12px">
                                    <tr>
                                        <td style="width: 120px; font-size: 12px; text-align: left">
                                            <select id="cboTradingPaymentAmount" style="width:120px"></select>
                                        </td>
                                        <td style="width: 120px; font-size: 12px">
                                            <input id="txtTradingPaymentAmountStart" style="width:114px" />
                                        </td>
                                        <td style="width: 10px; font-size: 12px">
                                            To
                                        </td>
                                        <td style="width: 120px; font-size: 12px">
                                            <input id="txtTradingPaymentAmountEnd" style="width:114px" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                Approved By :
                            </td>
                            <td style="width:370px">
                                <select id="cboApprovedBy" style="width:375px"></select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:170px; text-align:right">
                                Contractor(s) :
                            </td>
                            <td style="width:370px">
                                <input type="text" style="width: 282px;" id="txtContractorName" placeholder="Press enter with Contractor name/code" />
                                <input type="button" style="width: 30px;" id="btnContractorClear" value="C" />
                                <input type="button" style="width: 50px;" id="btnContractorPicker" value="Pick" />
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <fieldset style="width:498px; vertical-align:top;">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold;">
                    <tr>
                        <td style="width:100px;text-align:right">
                            <a id="btnAdvSearchReset" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true"> Reset</a>
                        </td>
                        <td style="width:408px;text-align:right;">
                            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                            <a id="btnAdvSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
            var nReferenceType = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ReferenceType));
            var nTradingPaymentBy = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.TradingPaymentBy));
            var oApprovalUsers=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ApprovalUsers));
            var oDateCompareOperatorObjs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DateCompareOperatorObjs));
            var oAmountCompareOperatorObjs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.AmountCompareOperatorObjs));
            var oTradingPaymentAccounts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.TradingPaymentAccounts));
            var oSalesmanBusinessUnit=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.SalesmanBusinessUnit));
            var oTradingPayments =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
            var oAURolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
            var oTempTradingPayments =sessionStorage.getItem("TradingPayments");

            if(oTempTradingPayments!=null)
            {
                oTradingPayments = jQuery.parseJSON(oTempTradingPayments);
            }
            RefreshList(oTradingPayments);
            RefreshControlLayout(oAURolesMapping);
            sessionStorage.setItem("BUID", nBUID);
            sessionStorage.setItem("ReferenceType", nReferenceType);
            sessionStorage.setItem("TradingPaymentBy", nTradingPaymentBy);
            $('#tblTradingPayments').data('SalesmanBusinessUnit',oSalesmanBusinessUnit);

            $("#progbar").progressbar({ value: 0 });
            $("#progbarParent").hide();
            $('#txtContractorName').data('Contractors', []);
            $('#cboApprovedBy').data('ApprovalUsers', oApprovalUsers);
            $('#cboPaymentDate').data('DateCompareOperatorObjs', oDateCompareOperatorObjs);
            $('#cboTradingPaymentAmount').data('AmountCompareOperatorObj', oAmountCompareOperatorObjs);
            $('#cboTradingPaymentAccount').data('TradingPaymentAccounts', oTradingPaymentAccounts)
            $('#tblTradingPayments').data('TradingPayments', oTradingPayments);
            $('#txtTradingPaymentAmountStart,#txtTradingPaymentAmountEnd').icsCurrencyBox();
        });

        $('#btnWaitForApproved').click(function (e) {
            var oTradingPayment = {
                TradingPaymentID : 0,
                BUID : parseInt(sessionStorage.getItem("BUID")),
                SalesManID : parseInt($('#tblTradingPayments').data('SalesmanBusinessUnit').SalesmanID)
            };

            $.ajax({
                type: "POST",
                dataType: "JSON",
                url: sessionStorage.getItem("BaseAddress")+  "/TradingPayment/WaitForApproval",
                data:  JSON.stringify(oTradingPayment),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var  oTradingPayments = jQuery.parseJSON(data);
                    if (oTradingPayments != null) {
                        if(oTradingPayments.length>0)
                        {
                            if(oTradingPayments[0].ErrorMessage=="")
                            {
                                RefreshList(oTradingPayments);
                                $('#tblTradingPayments').data('TradingPayments', oTradingPayments);
                            }
                            else
                            {
                                alert(oTradingPayments[0].ErrorMessage);
                            }
                        }
                        else
                        {
                            alert("Data not found!!");
                        }
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        $('#btnAdd').click(function (e) {
            var oTradingPayments= $('#tblTradingPayments').datagrid('getRows');
            sessionStorage.setItem("TradingPayments", JSON.stringify(oTradingPayments));
            sessionStorage.setItem("SelectedRowIndex", -1);
            sessionStorage.setItem("TradingPaymentHeader", "Add TradingPayment");
            sessionStorage.setItem("BackLink", window.location.href);
            var tsv=((new Date()).getTime())/1000;
            window.location.href = sessionStorage.getItem("BaseAddress")+ "/TradingPayment/ViewTradingPayment?id=0&pby="+sessionStorage.getItem("TradingPaymentBy")+"&buid="+sessionStorage.getItem("BUID")+"&ts="+tsv;
        });

        $('#btnEdit').click(function (e) {
            var oTradingPayment= $('#tblTradingPayments').datagrid('getSelected');
            if(oTradingPayment==null || oTradingPayment.TradingPaymentID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(parseInt(oTradingPayment.ApprovedBy)!=0)
            {
                alert("Your selected Invaoice already approved!");
                return;
            }
            var tsv=((new Date()).getTime())/1000;
            var SelectedRowIndex=$('#tblTradingPayments').datagrid('getRowIndex',oTradingPayment);
            var oTradingPayments= $('#tblTradingPayments').datagrid('getRows');
            sessionStorage.setItem("TradingPayments", JSON.stringify(oTradingPayments));
            sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
            sessionStorage.setItem("TradingPaymentHeader", "Edit TradingPayment");
            sessionStorage.setItem("BackLink", window.location.href);
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/TradingPayment/ViewTradingPayment?id="+oTradingPayment.TradingPaymentID+"&pby="+sessionStorage.getItem("TradingPaymentBy")+"&buid="+sessionStorage.getItem("BUID")+"&ts="+tsv;
        });

        $("#btnView").click(function(){
            var oTradingPayment= $('#tblTradingPayments').datagrid('getSelected');
            if(oTradingPayment==null || oTradingPayment.TradingPaymentID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            var tsv=((new Date()).getTime())/1000;
            var SelectedRowIndex=$('#tblTradingPayments').datagrid('getRowIndex',oTradingPayment);
            var oTradingPayments= $('#tblTradingPayments').datagrid('getRows');
            sessionStorage.setItem("TradingPayments", JSON.stringify(oTradingPayments));
            sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
            sessionStorage.setItem("TradingPaymentHeader", "View TradingPayment");
            sessionStorage.setItem("BackLink", window.location.href);
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/TradingPayment/ViewTradingPayment?id="+oTradingPayment.TradingPaymentID+"&pby="+sessionStorage.getItem("TradingPaymentBy")+"&buid="+sessionStorage.getItem("BUID")+"&ts="+tsv;
        });

        $('#btnDelete').click(function (e) {
            var oTradingPayment = $('#tblTradingPayments').datagrid('getSelected');
            if(oTradingPayment==null || oTradingPayment.TradingPaymentID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(parseInt(oTradingPayment.ApprovedBy)!=0)
            {
                alert("Please selected TradingPayment already approved!");
                return;
            }
            if (!confirm("Confirm to Delete?")) return ;
            var SelectedRowIndex=$('#tblTradingPayments').datagrid('getRowIndex',oTradingPayment);
            $.ajax({
                type: "POST",
                dataType: "json",
                url: sessionStorage.getItem("BaseAddress")+ "/TradingPayment/Delete",
                traditional: true,
                data:  JSON.stringify(oTradingPayment),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Data delete successfully")
                    {
                        alert("Delete sucessfully");
                        $('#tblTradingPayments').datagrid('deleteRow',SelectedRowIndex);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        $('#btnApproved').click(function (e) {
            var oTradingPayment = $('#tblTradingPayments').datagrid('getSelected');
            if(oTradingPayment==null || parseInt(oTradingPayment.TradingPaymentID)<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(parseInt(oTradingPayment.ApprovedBy)!=0)
            {
                alert("Please selected TradingPayment already approved!");
                return;
            }
            if (!confirm("Confirm to Approved?")) return ;
            var SelectedRowIndex=$('#tblTradingPayments').datagrid('getRowIndex',oTradingPayment);
            $.ajax({
                type: "POST",
                dataType: "json",
                url: sessionStorage.getItem("BaseAddress")+ "/TradingPayment/Approved",
                traditional: true,
                data:  JSON.stringify(oTradingPayment),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    debugger;
                    oTradingPayment = jQuery.parseJSON(data);
                    if (parseInt(oTradingPayment.TradingPaymentID)>0) {
                        alert("Approved Successfully");
                        $('#tblTradingPayments').datagrid('updateRow',{index: SelectedRowIndex,	row: oTradingPayment});
                    }
                    else {
                        alert(oTradingPayment.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        function RefreshList(oTradingPayments)
        {
            data = oTradingPayments;
            data={"total":""+data.length+"","rows":data};
            $('#tblTradingPayments').datagrid('loadData',data);
            var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
            $('#tblTradingPayments').datagrid('selectRow',nIndex);
        }

        $('#btnPreview').click(function (e) {
            debugger;
            var oTradingPayment = $('#tblTradingPayments').datagrid('getSelected');
            if(oTradingPayment==null || oTradingPayment.TradingPaymentID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            var tsv = ((new Date()).getTime())/1000;
            window.open(sessionStorage.getItem("BaseAddress")+'/TradingPayment/PrintTradingPayment?id='+oTradingPayment.TradingPaymentID+"&ts="+tsv, "_blank")
        });

        $('#btnPrintList').click(function (e) {
            var oTradingPayments= $('#tblTradingPayments').datagrid('getRows');
            var ids ="";
            if(oTradingPayments.length >0)
            {
                for(var i =0;i<oTradingPayments.length;i++)
                {
                    ids =ids+oTradingPayments[i].TradingPaymentID+",";
                }
                ids= ids.substring(0, ids.length - 1);
            }
            else{
                return;
            }
            var tsv = ((new Date()).getTime())/1000;
            window.open(sessionStorage.getItem("BaseAddress") + '/TradingPayment/PrintTradingPayments?ids='+ids+"&ts="+tsv, "_blank");
        });

        //Start Search
        function RefreshComboBoxControls()
        {
            var oApprovalUsers = $('#cboApprovedBy').data('ApprovalUsers');
            var oDateCompareOperatorObjs = $('#cboPaymentDate').data('DateCompareOperatorObjs');
            var oAmountCompareOperatorObjs = $('#cboTradingPaymentAmount').data('AmountCompareOperatorObj');
            var oTradingPaymentAccounts = $('#cboTradingPaymentAccount').data('TradingPaymentAccounts');
            $("#cboApprovedBy").icsLoadCombo({ List: oApprovalUsers, OptionValue: "UserID", DisplayText: "UserName" });
            $("#cboPaymentDate").icsLoadCombo({ List: oDateCompareOperatorObjs, OptionValue: "Id", DisplayText: "Value" });
            $("#cboTradingPaymentAmount").icsLoadCombo({ List: oAmountCompareOperatorObjs, OptionValue: "Id", DisplayText: "Value" });
            $("#cboTradingPaymentAccount").icsLoadCombo({ List: oTradingPaymentAccounts, OptionValue: "AccountHeadID", DisplayText: "AccountHeadName" });
        }

        function ValidateSearch()
        {
            var sMRNo =$.trim($('#txtMRNo').val());
            var sInvoiceNo =$.trim($('#txtInvoiceNo').val());
            var nTradingPaymentAccount = parseInt($('#cboTradingPaymentAccount').val());
            var nPaymentDate = parseInt($('#cboPaymentDate').val());
            if(nPaymentDate===1 || nPaymentDate===2 || nPaymentDate===3 || nPaymentDate===4)
            {
                var sTradingPaymentStartDate   = $('#txtTradingPaymentStartDate').datebox('getValue');
                if(sTradingPaymentStartDate===null || sTradingPaymentStartDate==="")
                {
                    alert("Please select TradingPayment start date!");
                    $('#txtTradingPaymentStartDate').focus();
                    return false;
                }
            }
            if(nPaymentDate===5 || nPaymentDate===6)
            {
                var sTradingPaymentStartDate   = $('#txtTradingPaymentStartDate').datebox('getValue');
                var sTradingPaymentEndDate   = $('#txtTradingPaymentEndDate').datebox('getValue');
                if(sTradingPaymentStartDate===null || sTradingPaymentStartDate==="")
                {
                    alert("Please select TradingPayment start date!");
                    $('#txtTradingPaymentStartDate').focus();
                    return false;
                }
                if(sTradingPaymentEndDate===null || sTradingPaymentEndDate==="")
                {
                    alert("Please select TradingPayment end date!");
                    $('#txtTradingPaymentEndDate').focus();
                    return false;
                }
                if(new Date(sTradingPaymentStartDate) > new Date(sTradingPaymentEndDate))
                {
                    alert("Start date must be smallar than or equal end date!");
                    $('#txtTradingPaymentStartDate').focus();
                    return false;
                }
            }

            var nTradingPaymentAmount = parseInt($('#cboTradingPaymentAmount').val());
            if(nTradingPaymentAmount===1 || nTradingPaymentAmount===2 || nTradingPaymentAmount===3 || nTradingPaymentAmount===4)
            {
                var sTradingPaymentAmountStart   = $.trim($('#txtTradingPaymentAmountStart').val());
                if(sTradingPaymentAmountStart===null || sTradingPaymentAmountStart==="")
                {
                    alert("Please enter TradingPayment start Amount!");
                    $('#txtTradingPaymentAmountStart').focus();
                    return false;
                }
                if(icsRemoveComma(sTradingPaymentAmountStart)<=0)
                {
                    alert("Please enter TradingPayment start Amount!");
                    $('#txtTradingPaymentAmountStart').focus();
                    return false;
                }
            }
            if(nTradingPaymentAmount===5 || nTradingPaymentAmount===6)
            {
                var sTradingPaymentAmountStart = $.trim($('#txtTradingPaymentAmountStart').val());
                if(sTradingPaymentAmountStart===null || sTradingPaymentAmountStart==="")
                {
                    alert("Please enter TradingPayment start Amount!");
                    $('#txtTradingPaymentAmountStart').focus();
                    return false;
                }
                if(icsRemoveComma(sTradingPaymentAmountStart)<=0)
                {
                    alert("Please enter TradingPayment start Amount!");
                    $('#txtTradingPaymentAmountStart').focus();
                    return false;
                }

                var sTradingPaymentAmountEnd = $.trim($('#txtTradingPaymentAmountEnd').val());
                if(sTradingPaymentAmountEnd===null || sTradingPaymentAmountEnd==="")
                {
                    alert("Please enter TradingPayment end Amount!");
                    $('#txtTradingPaymentAmountEnd').focus();
                    return false;
                }
                if(icsRemoveComma(sTradingPaymentAmountEnd)<=0)
                {
                    alert("Please enter TradingPayment end Amount!");
                    $('#txtTradingPaymentAmountEnd').focus();
                    return false;
                }
                if(icsRemoveComma(sTradingPaymentAmountStart) >= icsRemoveComma(sTradingPaymentAmountEnd))
                {
                    alert("Start amount must be smallar than end amount!");
                    $('#txtTradingPaymentAmountStart').focus();
                    return false;
                }
            }

            var nApprovedBy = parseInt($('#cboApprovedBy').val());
            var oContractors = $('#txtContractorName').data('Contractors');

            if(nTradingPaymentAccount===0 && sMRNo==="" && sInvoiceNo==="" && nPaymentDate===0 && nTradingPaymentAmount===0 && nApprovedBy===0 && oContractors.length<=0)
            {
                alert("Please select atleast one searching criteriea!");
                return false;
            }
            return true;
        }

        $('#btnAdvSearch').click(function(e){
            $("#winAdvanceSearch").icsWindow('open', "Advance Search");
            $("#winAdvanceSearch input").not("input[type='button']").val("");
            $('#txtTradingPaymentStartDate').datebox('setValue', icsdateformat(new Date()));
            $('#txtTradingPaymentEndDate').datebox('setValue', icsdateformat(new Date()));
            $('#txtTradingPaymentAmountStart').val('0.00');
            $('#txtTradingPaymentAmountEnd').val('0.00');
            $('#txtTradingPaymentAmountStart').prop("disabled", true);
            $('#txtTradingPaymentAmountEnd').prop("disabled", true);
            $('#txtContractorName').data('Contractors', []);
            RefreshComboBoxControls();
        });

        $('#btnAdvSearchClose').click(function(e){
            $("#winAdvanceSearch").icsWindow('close');
        });

        $('#cboPaymentDate').change(function(e){
            //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
            var nCompareOperator =   parseInt($('#cboPaymentDate').val());
            if(nCompareOperator===0)
            {
                $('#txtTradingPaymentStartDate').datebox({ disabled : true });
                $('#txtTradingPaymentEndDate').datebox({ disabled : true });
            }
            else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
            {
                $('#txtTradingPaymentStartDate').datebox({ disabled : false });
                $('#txtTradingPaymentEndDate').datebox({ disabled : true });
            }
            else
            {
                $('#txtTradingPaymentStartDate').datebox({ disabled : false });
                $('#txtTradingPaymentEndDate').datebox({ disabled : false });
            }
            $('#txtTradingPaymentStartDate').datebox('setValue', icsdateformat(new Date()));
            $('#txtTradingPaymentEndDate').datebox('setValue', icsdateformat(new Date()));
        });

        $('#cboTradingPaymentAmount').change(function(e){
            //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
            var nCompareOperator =   parseInt($('#cboTradingPaymentAmount').val());
            if(nCompareOperator===0)
            {
                $('#txtTradingPaymentAmountStart').prop("disabled", true);
                $('#txtTradingPaymentAmountEnd').prop("disabled", true);
            }
            else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
            {
                $('#txtTradingPaymentAmountStart').prop("disabled", false);
                $('#txtTradingPaymentAmountEnd').prop("disabled", true);
            }
            else
            {
                $('#txtTradingPaymentAmountStart').prop("disabled", false);
                $('#txtTradingPaymentAmountEnd').prop("disabled", false);
            }
            $('#txtTradingPaymentAmountStart').val('0.00');
            $('#txtTradingPaymentAmountEnd').val('0.00');
        });

        $('#btnAdvSearchReset').click(function(e){
            $("#winAdvanceSearch input").not("input[type='button']").val("");
            $('#cboPaymentDate').val(0);
            $('#txtTradingPaymentStartDate').datebox({ disabled : true });
            $('#txtTradingPaymentEndDate').datebox({ disabled : true });
            $('#txtTradingPaymentStartDate').datebox('setValue', icsdateformat(new Date()));
            $('#txtTradingPaymentEndDate').datebox('setValue', icsdateformat(new Date()));

            $('#cboTradingPaymentAmount').val(0);
            $('#txtTradingPaymentAmountStart').prop("disabled", true);
            $('#txtTradingPaymentAmountEnd').prop("disabled", true);
            $('#txtTradingPaymentAmountStart').val('0.00');
            $('#txtTradingPaymentAmountEnd').val('0.00');

            $('#cboApprovedBy').val(0);
            $('#txtContractorName').data('Contractors', []);
            $("#txtContractorName").removeClass("fontColorOfPickItem");
        });

        $('#btnSearch').click(function(e){
            if(!ValidateSearch()) return;

            var sMRNo =$.trim($('#txtMRNo').val());
            var sInvoiceNo =$.trim($('#txtInvoiceNo').val());
            var nTradingPaymentAccount =parseInt($('#cboTradingPaymentAccount').val());

            var nPaymentDate = parseInt($('#cboPaymentDate').val());
            var sTradingPaymentStartDate   = $('#txtTradingPaymentStartDate').datebox('getValue');
            var sTradingPaymentEndDate   = $('#txtTradingPaymentEndDate').datebox('getValue');

            var nTradingPaymentAmount = parseInt($('#cboTradingPaymentAmount').val());
            var sTradingPaymentAmountStart = icsRemoveComma($.trim($('#txtTradingPaymentAmountStart').val()));
            var sTradingPaymentAmountEnd = icsRemoveComma($.trim($('#txtTradingPaymentAmountEnd').val()));

            var nApprovedBy = parseInt($('#cboApprovedBy').val());
            var oContractors = $('#txtContractorName').data('Contractors');

            if(oContractors===null) {oContractors = []; }
            var sContractorIDs ="";

            for(var i=0; i<oContractors.length; i++)
            {
                sContractorIDs  = sContractorIDs + oContractors[i].ContractorID+ ",";
            }
            if(sContractorIDs.length>0)
            {
                sContractorIDs=sContractorIDs.substring(0, sContractorIDs.length-1);
            }

            var sSearchingData  =  sMRNo+'~';
            sSearchingData = sSearchingData + sInvoiceNo+'~';
            sSearchingData = sSearchingData + nTradingPaymentAccount+'~';
            sSearchingData = sSearchingData + nPaymentDate+'~';
            sSearchingData = sSearchingData + sTradingPaymentStartDate+'~';
            sSearchingData = sSearchingData + sTradingPaymentEndDate+'~';
            sSearchingData = sSearchingData + nTradingPaymentAmount+'~';
            sSearchingData = sSearchingData + sTradingPaymentAmountStart+'~';
            sSearchingData = sSearchingData + sTradingPaymentAmountEnd+'~';
            sSearchingData = sSearchingData + nApprovedBy+'~';
            sSearchingData = sSearchingData + sContractorIDs;


            var oTradingPayment = {
                Note : sSearchingData,
                BUID : parseInt(sessionStorage.getItem("BUID")),
                ReferenceTypeInt : parseInt(sessionStorage.getItem("ReferenceType")),
                //SalesManID : parseInt($('#tblTradingPayments').data('SalesmanBusinessUnit').SalesmanID)
            };

            $.ajax({
                type: "POST",
                dataType: "JSON",
                url: sessionStorage.getItem("BaseAddress")+  "/TradingPayment/AdvanceSearch",
                data:  JSON.stringify(oTradingPayment),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var  oTradingPayments = jQuery.parseJSON(data);
                    if (oTradingPayments != null) {
                        if(oTradingPayments.length>0)
                        {
                            if(oTradingPayments[0].ErrorMessage=="")
                            {
                                RefreshList(oTradingPayments);
                                $('#tblTradingPayments').data('TradingPayments', oTradingPayments);
                                $("#winAdvanceSearch").icsWindow('close');
                            }
                            else
                            {
                                alert(oTradingPayments[0].ErrorMessage);
                            }
                        }
                        else
                        {
                            alert("Data not found!!");
                        }
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        $('#txtSearchByMRNo').keyup(function (e) {
            //
            var c = String.fromCharCode(e.which);
            var txtSearchByName = document.getElementById('txtSearchByMRNo').value;

            var oSearchedTradingPayments = [];  var sTempName="";
            var oTradingPaymentList = $('#tblTradingPayments').datagrid('getRows');
            if (e.which == 8)
            {
                oTradingPaymentList = $('#tblTradingPayments').data('TradingPayments');
            }
            for(i=0;i<oTradingPaymentList.length;++i){
                sTempName=oTradingPaymentList[i].RefNo;
                n=sTempName.toUpperCase().indexOf(txtSearchByName.toUpperCase())
                if(n!=-1)
                {
                    oSearchedTradingPayments.push(oTradingPaymentList[i]);
                }
            }
            RefreshList(oSearchedTradingPayments);
        });

        ///Contractor Pick
        $("#txtContractorName").keydown(function (e) {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) // Enter Press
            {
                var nBUID = parseInt(sessionStorage.getItem("BUID"));
                var oContractor = { Params: 2 + '~' + $.trim($('#txtContractorName').val())+'~'+ nBUID };//here 2 is Contractor
                var obj = {
                    BaseAddress: sessionStorage.getItem("BaseAddress"),
                    Object: oContractor,
                    ControllerName: "Contractor",
                    ActionName: "ContractorSearchByNameType",
                    IsWinClose: false
                };
                $("#progbar").progressbar({ value: 0 });
                $("#progbarParent").show();
                var intervalID = setInterval(updateProgress, 250);
                $.icsDataGets(obj, function (response) {
                    clearInterval(intervalID);
                    $("#progbarParent").hide();
                    if (response.status && response.objs.length > 0) {
                        if (response.objs[0].ContractorID > 0) {
                            var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                            oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                            oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                            oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                            var oPickerParam = {
                                winid: 'winContractors',
                                winclass: 'clsContractor',
                                winwidth: 600,
                                winheight: 460,
                                tableid: 'tblContractors',
                                tablecolumns: tblColums,
                                datalist: response.objs,
                                multiplereturn: true,
                                searchingbyfieldName: 'Name',
                                windowTittle: 'Contractor List'
                            };
                            $.icsPicker(oPickerParam);
                            IntializePickerbutton(oPickerParam);
                        }
                        else { alert(response.objs[0].ErrorMessage); }
                    }else{
                        alert("Data Not Found.");
                        return;
                    }
                });
            }
        });
        $("#btnContractorPicker").click(function () {
            var nBUID = parseInt(sessionStorage.getItem("BUID"));
            var oContractor = { Params: "2~~"+nBUID };//here 2 Is Contractor
            var obj = {
                BaseAddress: sessionStorage.getItem("BaseAddress"),
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            $("#progbar").progressbar({ value: 0 });
            $("#progbarParent").show();
            var intervalID = setInterval(updateProgress, 250);
            $.icsDataGets(obj, function (response) {
                clearInterval(intervalID);
                $("#progbarParent").hide();
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winContractors',
                            winclass: 'clsContractor',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblContractors',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName: 'Name',
                            windowTittle: 'Contractor List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else{
                    alert("Data Not Found.");
                }
            });

        });
        $('#txtContractorName').keydown(function (e) {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 8) //backspace=8
            {
                $("#txtContractorName").removeClass("fontColorOfPickItem");
                $('#txtContractorName').data('ContractorID', 0);
            }
        });
        $('#btnContractorClear').click(function(e){
            $("#txtContractorName").val("");
            $('#txtContractorName').data('Contractors', []);
            $("#txtContractorName").removeClass("fontColorOfPickItem");
        });
        //End Contractor Picker


        function IntializePickerbutton(oPickerobj) {
            $("#" + oPickerobj.winid).find("#btnOk").click(function () {
                //for Single Select
                SetPickerValueAssign(oPickerobj);
            });
            $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
                if (e.which == 13)//enter=13
                {
                    SetPickerValueAssign(oPickerobj);
                }
            });
        }

        function SetPickerValueAssign(oPickerobj) {
            var oreturnObj = null, oreturnobjs = [];
            if (oPickerobj.multiplereturn) {
                oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
            } else {
                oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
            }
            $("#" + oPickerobj.winid).icsWindow("close");
            $("#" + oPickerobj.winid).remove();

            if (oPickerobj.winid === 'winContractors')
            {
                if (oreturnobjs != null && oreturnobjs.length > 0) {
                    $('#txtContractorName').val(oreturnobjs.length+"'s Contractors seleted");
                    $('#txtContractorName').addClass('fontColorOfPickItem');
                    $('#txtContractorName').data('Contractors', oreturnobjs);
                    $('#txtContractorName').focus();
                }
            }
        }

        function updateProgress() {
            var value =$('#progbar').progressbar('getValue');
            if (value < 96){
                value += Math.floor(Math.random() * 10);
                $('#progbar').progressbar('setValue', value);
            }
        }

        function hideShow(miliseconds) {
            $("#progbarParent").hide();
        }

        function RefreshControlLayout(oAURolesMapping)
        {
            $("#btnAdvSearch").hide();
            $("#btnAdd").hide();
            $("#btnEdit").hide();
            $("#btnView").hide();
            $("#btnDelete").hide();
            $("#btnWaitForApproved").hide();
            $("#btnApproved").hide();
            $("#btnPreview").hide();
            $("#btnPrintList").hide();

            if(PermissionChecker('AdvSearch','TradingPayment',oAURolesMapping)){$("#btnAdvSearch").show();}
            if(PermissionChecker('Add','TradingPayment',oAURolesMapping)){$("#btnAdd").show();}
            if(PermissionChecker('Edit','TradingPayment',oAURolesMapping)){$("#btnEdit").show();}
            if(PermissionChecker('View','TradingPayment',oAURolesMapping)){$("#btnView").show();}
            if(PermissionChecker('Delete','TradingPayment', oAURolesMapping)){$("#btnDelete").show();}
            if(PermissionChecker('Approved','TradingPayment',oAURolesMapping)){$("#btnApproved").show();}
            if(PermissionChecker('Approved','TradingPayment',oAURolesMapping)){$("#btnWaitForApproved").show();}
            if(PermissionChecker('Preview','TradingPayment',oAURolesMapping)){$("#btnPreview").show();}
            if(PermissionChecker('PrintList','TradingPayment',oAURolesMapping)){$("#btnPrintList").show();}
        }
    </script>
