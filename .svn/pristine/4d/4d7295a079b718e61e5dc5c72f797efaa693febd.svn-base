<html>
<head>
    @{ViewBag.Title = "Wait fo Sub Contract";} 
</head>
<body>
    @model IEnumerable< ESimSol.BusinessObjects.PTUUnit2>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>

    
    <div class="menuMainCollectionTable" id="divPS">
                <table id="tblPTUs" title="PTU Details" class="easyui-datagrid" style="height:550px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar">
                    <thead data-options="frozen:true">
                        <tr>
                            <th field="ProductCode" width="8%" align="left">Code</th>
                            <th field="ProductName" width="15%" align="left">Product Name</th>
                            <th width="10%" align="left" field="ColorName">Color Name</th>
                            <th width="6%" align="right" formatter="formatPrice" field="ExportSCQty">PI Qty</th>
                            <th width="6%" align="right" field="ProdOrderQtyInString" formatter="formatingQty">PO Qty</th>
                        </tr>
                        </thead>
                    <thead>
                        <tr>
                            <th width="10%" align="right" field="ProductionCapacity" formatter="formatPrice">Prod. Capacity</th>
                            <th width="6%" align="right" field="ProdPipeLineQtyInString" formatter="formatingQty">Pipe Line Qty</th>
                            <th width="8%" align="right" field="SubcontractQtyInString" formatter="formatingQty">Subcontract Qty</th>
                            <th width="8%" align="right" field="SubContractReadStockQty" formatter="formatPrice">SubC. Ready Stock</th>
                            <th width="9%" align="right" field="SubContractReceiveQtyInString" formatter="formatSubContractReceiveQty">Rcv Qty(Subcontract)</th>
                            <th width="7%" align="right" field="ActualFinishQtyQtyInString" formatter="formatingQty">Actual Finish</th>
                            <th width="7%" align="right" field="DOQtyInString" formatter="formatingQty">DO Qty</th>
                            <th width="7%" align="right" formatter="formatPrice" field="YetToDOQty">Yet to DO</th>
                            <th width="7%" align="right" field="ChallanQtyInString" formatter="formatingQty">Challan Qty</th>
                            <th width="7%" align="right" formatter="formatPrice" field="YetToChallanQty">Yet to Challan</th>
                            <th width="7%" align="right" field="GraceQtyInString" formatter="formatingQty">Grace Qty</th>
                            <th width="7%" align="right" formatter="formatPrice" field="ReturnQty">Return Qty</th>
                            <th width="7%" align="right" field="RejectQtyInString" formatter="formatingQty">Reject Qty</th>
                            <th width="7%" align="right" field="ReadyStockQtyInString" formatter="formatReadyStockQty">Ready Stock</th>
                            <th width="7%" align="right" formatter="formatPrice" field="AvialableStockQty">Avilable Stock</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <a id="btnPTUReceiveSubContract" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-receive" plain="true">PTU Rcv(SubContract)</a>
                </div>
            </div>
</body>
</html>
<style type="text/css">
       #winGraceInfo {
        width: 750px;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress ="";
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oPTUUnit2s =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        DynamicRefreshList(oPTUUnit2s, "tblPTUs");
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
    });
    
    $('#btnReload').click(function(){
        MakeURL($('#divPS').data('ExportSC').ExportSCID);
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }


    $("#btnPTUReceiveSubContract").click(function ()
    {
        var oPTUUnit2 = $('#tblPTUs').datagrid("getSelected");
        if(oPTUUnit2==null || parseInt(oPTUUnit2.PTUUnit2ID)<=0)
        {
            alert("Please Select a Item from List");
            return;
        }
        var SelectedRowIndex=$('#tblPTUs').datagrid('getRowIndex',oPTUUnit2);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("ProductionSheetHeader", "PTU Receive For SubContract");
        sessionStorage.setItem("BackLink", window.location.href);
        sessionStorage.setItem("PTUUnit2", JSON.stringify($('#divPS').data('PTUUnit2')));
        window.location.href = _sBaseAddress+ "/PTUUnit2/ViewSubContractReceive?nPTUUnit2ID="+oPTUUnit2.PTUUnit2ID+"&nExportSCDetailID="+oPTUUnit2.ExportSCDetailID;
    });

   
    $("#txtRawMaterialName").keydown(function (e) {

        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
            {
                alert('Sheet Quantity Should be Greater than 0.');
                return false;
            }

            if($.trim($('#txtRawMaterialName').val())==null || $.trim($('#txtRawMaterialName').val())=="")
            {
                alert("Type Raw Material Name and Press Enter.");
                $('#txtRawMaterialName').focus();
                return;
            }
            if(parseInt($('#cboQtyType').val())<=0)
            {
                alert("Please select Qty Type!");
                $('#cboQtyType').focus();
                return;
            }
            var sProductName = $.trim($('#txtRawMaterialName').val());
            GetRawMaterials(sProductName);
        }else if (code == 8) //backspace=8
        {
            //
            $("#txtRawMaterialName").removeClass("fontColorOfPickItem");
        }
    });
    $("#btnRefreshDetail").click(function (){
        endEditing();
    });

    function formatingQty(value)
    {
        var values=value.split("~");
        var nPTUUnit2ID=values[0];
        var nRefType=values[1];
        var nValue=values[2];
        var s = '<a  href="javascript:void(0)" id="idPO~'+nPTUUnit2ID+' value="'+nValue+'"  onclick = "PickerLoad('+nPTUUnit2ID+','+nRefType+')"">'+nValue+'</a>';
        return s;
    }
    function PickerLoad(nPTUUnit2ID,nRefType)
    {
        if(nPTUUnit2ID == null || parseInt(nPTUUnit2ID)<=0 || nRefType<=0)
        {
            alert("Sorry Click Again");
            return;
        }
        var oPTUUnit2Log  = {PTUUnit2ID:nPTUUnit2ID, PTUUnit2RefTypeInInt:nRefType};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUUnit2Log,
            ControllerName: "PTUUnit2",
            ActionName: "GetsByPTUwithType",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUUnit2LogID > 0) {
                    var tblColums = [];
                    var oColumn = "", sRefNoTitle = '', nWidth=600, sQtyTitle='Qty';
                    //1:Production Order; 2:Productio sheet; 3: DO;4:Challan;5:grace;6:QC/Lot
                    if(nRefType==1){sRefNoTitle='PO NO';}else if(nRefType==2||nRefType==7){sRefNoTitle='Sheet No'}else if(nRefType==3){sRefNoTitle='DO No'}else if(nRefType==4){sRefNoTitle='Challan No'}else if(nRefType==5){sRefNoTitle='Grace No'}else if(nRefType==6){sRefNoTitle='Lot No'}else if(nRefType==13){sRefNoTitle='SubContract No'}
                    oColumn = { field: "RefNo", title: sRefNoTitle, width: 100, align: "left" }; tblColums.push(oColumn);
                    if(nRefType==1)//PO
                    {
                        oColumn = { field: "PODateInString", title: "PO Date", width: 80, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "POApproveByName", title: "Approve By", width: 100, align: "left" }; tblColums.push(oColumn);
                    }
                    else if(nRefType==2)//pipe line qty
                    {
                        sQtyTitle = 'Sheet Qty';
                        oColumn = { field: "SheetWiseActualFinish", title: "Actual finish", formatter:formatPriceWithZeroDecimal, width: 90, align: "right" }; tblColums.push(oColumn);
                        oColumn = { field: "SheetWiseReject", title: "Reject", width: 70, formatter:formatPriceWithZeroDecimal, align: "right" }; tblColums.push(oColumn);
                        oColumn = { field: "PipeLineQtyInString", title: "Pipe Line", width: 100, align: "right" }; tblColums.push(oColumn);
                    }
                    else if(nRefType==3){//DO
                        oColumn = { field: "DeliveryDateInString", title: "Delivery Date",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DOApprovedByName", title: "Approved By",width: 100, align: "left" }; tblColums.push(oColumn);
                    }
                    else if(nRefType==4){//challan
                        oColumn = { field: "EntryPerson", title: "Challan By",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "WorkingUnitName", title: "Store",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "LotNo", title: "Lot No",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DBServerDateTimeInString", title: "Challan Time",width: 90, align: "left" }; tblColums.push(oColumn);
                    }else if(nRefType==5){//Grace

                        oColumn = { field: "EntryPerson", title: "Entry By",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DBServerDateTimeInString", title: "Execution Time",width:130, align: "left" }; tblColums.push(oColumn);
                    }else if(nRefType==6){//Actual finish
                        oColumn = { field: "EntryPerson", title: "QC By",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "WorkingUnitName", title: "Store",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DBServerDateTimeInString", title: "Operation Time",width:130, align: "left" }; tblColums.push(oColumn);
                    }else if(nRefType==7){//Reject

                        oColumn = { field: "EntryPerson", title: "Operate By",width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DBServerDateTimeInString", title: "Operation Time",width:130, align: "left" }; tblColums.push(oColumn);
                    }else if(nRefType==13){//Subcontract

                        oColumn = { field: "ContractBUName", title: "Send To",width:150, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ContractDateInstring", title: "Contract Date",width:70, align: "left" }; tblColums.push(oColumn);
                    }
                    oColumn = { field: "MUSymbol", title: "Unit", width:60, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: sQtyTitle, formatter:formatPriceWithZeroDecimal, width: 100, align: "right" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winPTUUnit2Log',
                        winclass: 'clsPTUUnit2Log',
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tblPTUUnit2Log',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'RefNo',
                        windowTittle: 'History List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }
    function formatReadyStockQty(value)
    {
        var values=value.split("~");
        var nPTUUnit2ID=values[0];
        var nValue=values[1];
        var s = '<a  href="javascript:void(0)" id="idstock~'+nPTUUnit2ID+' value="'+nValue+'"  onclick = "ReadyStockHistory('+nPTUUnit2ID+')"">'+nValue+'</a>';
        return s;
    }
    function ReadyStockHistory(nPTUUnit2ID)
    {
        if(nPTUUnit2ID == null || parseInt(nPTUUnit2ID)<=0 )
        {
            alert("Sorry Click Again");
            return;
        }
        var oPTUUnit2Distribution  = {PTUUnit2ID:nPTUUnit2ID};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUUnit2Distribution,
            ControllerName: "PTUUnit2",
            ActionName: "GetsReadyStockHistory",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUUnit2DistributionID > 0) {
                    var tblColums = [];
                    var oColumn = "",  nWidth=550;
                    oColumn = { field: "LotNo", title: "Lot No", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "WorkingUnitName", title: "Store", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width:60, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", formatter:formatPriceWithZeroDecimal, width: 100, align: "right" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winPTUUnit2Distribution',
                        winclass: 'clsPTUUnit2Distribution',
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tblPTUUnit2Distribution',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'LotNo',
                        windowTittle: 'Stock History List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }

    function formatSubContractReceiveQty(value)
    {
        var values=value.split("~");
        var nPTUUnit2ID=values[0];
        var nValue=values[1];
        var s = '<a  href="javascript:void(0)" id="idSCR~'+nPTUUnit2ID+' value="'+nValue+'"  onclick = "SubContractReceiveHistory('+nPTUUnit2ID+')"">'+nValue+'</a>';
        return s;
    }
    
    function SubContractReceiveHistory(nPTUUnit2ID)
    {
        if(nPTUUnit2ID == null || parseInt(nPTUUnit2ID)<=0 )
        {
            alert("Sorry Click Again");
            return;
        }
        var oPTUUnit2Distribution  = {PTUUnit2ID:nPTUUnit2ID};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUUnit2Distribution,
            ControllerName: "PTUUnit2",
            ActionName: "GetsSubContrctReceiveHistory",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUUnit2DistributionID > 0) {
                    var tblColums = [];
                    var oColumn = "",  nWidth=550;
                    oColumn = { field: "LotNo", title: "Lot No", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "WorkingUnitName", title: "Store", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width:60, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", formatter:formatPriceWithZeroDecimal, width: 100, align: "right" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winPTUUnit2Distribution',
                        winclass: 'clsPTUUnit2Distribution',
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tblPTUUnit2Distribution',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'LotNo',
                        windowTittle: 'Stock History List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }

  
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {

        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winExportSCPicker')
        {
            if (oreturnObj != null && oreturnObj.ExportSCID > 0)
            {
                MakeURL(oreturnObj.ExportSCID);
            }
        }
    }
    function MakeURL(nExportSCID)
    {
        var sTargetLink = "";
        var sLink = window.location.href;
        var sLinkArray =[];sLinkArray = sLink.split('?');sTargetLink = sLinkArray[0]+'?';
        var sAndArray = sLinkArray[1].split('&');sAndArray[0] = 'nExportSCID='+nExportSCID;
        sTargetLink+=sAndArray[0];
        for(var i =1;i<sAndArray.length;i++)
        {
            sTargetLink+="&"+sAndArray[i];
        }
        window.location.href = sTargetLink;
        $('#txtExportPINo').focus();
    }
</script>