
@{
    ViewBag.Title = "Sample Invoice Approved";
}
@model ESimSol.BusinessObjects.SampleInvoice

<div class="menuMainCollectionTable easyui-panel" id="divPC" title="Approve Sample Invoice" style="font-family:Tahoma; height:100%; width:100%">
    <fieldset>
        <legend style="font-weight:bold"> Sample Invoice Informations </legend>
        <table border="0" cellpadding="2" cellspacing="2" style="width:100%;font-size:11px; font-weight:bold">
            <tr>
                <td style="width:10%; text-align:right">
                    Invoice No
                </td>
                <td style="width:20%; text-align:left">
                    @Html.TextBoxFor(model => model.SampleInvoiceNo, new { style = "width:100%", id = "txtSampleInvoiceNo", disabled = "disabled" })
                </td>
                <td style="width:10%; text-align:right">
                    Invoice Type
                </td>
                <td style="width:20%; text-align:left">
                    <input id="txtInvoiceType" type="text" style="width: 100%;" disabled="disabled" />
                </td>
                <td style="width:10%; text-align:right">
                    Date
                </td>
                <td style="width:10%">
                    @Html.TextBoxFor(model => model.SampleInvoiceDateST, new { style = "width: 100%;", id = "txtSampleInvoiceDateST", disabled = "disabled" })
                </td>
                <td style="width:10%; text-align:right">
                    Status
                </td>
                <td style="width:10%; text-align:left">
                    @Html.TextBoxFor(model => model.CurrentStatusSt, new { style = "width: 100%;", id = "txtCurrentStatusSt", disabled = "disabled" })
                </td>
            </tr>
            <tr>
                <td style="width:10%; text-align:right">
                    Party Name
                </td>
                <td style="width:20%; text-align:left">
                    @Html.TextBoxFor(model => model.ContractorName, new { style = "width:100%;", id = "txtContractorName", disabled = "disabled" })
                </td>
                <td style="width:10%; text-align:right">
                    Rate Unit
                </td>
                <td style="width:20%">
                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tr>
                            <td style="width:30%">@Html.TextBoxFor(model => model.RateUnit, new { style = "width:100%;text-align:right", id = "txtRateUnit", disabled = "disabled" })</td>
                            <td style="width:40%; text-align:right;">C.Rate</td>
                            <td style="width:30%">@Html.TextBoxFor(model => model.ConversionRate, new { style = "width:100%;text-align:right", id = "txtCRate", disabled = "disabled" })</td>
                        </tr>
                    </table>
                </td>
                <td style="width:10%; text-align:right">
                    Concern Person
                </td>
                <td colspan="3" style="width:30%; text-align:left">
                    @Html.TextBoxFor(model => model.MKTPName, new { style = "width:100%;", id = "txtMktPerson", disabled = "disabled" })
                </td>
            </tr>
            <tr>
                <td style="width:10%; text-align:right">
                    Payment Mode
                </td>
                <td style="width:20%; text-align:left">
                    @Html.TextBoxFor(model => model.PaymentTypeSt, new { style = "width: 100%;", id = "txtPaymentType", disabled = "disabled" })
                </td>
                <td style="width:10%; text-align:right">
                    Adjust Type
                </td>
                <td style="width:20%; text-align:left">
                    <input id="txtPaymentAdjType" type="text" style="width: 100%;" disabled="disabled" />
                </td>
                <td style="width:10%; text-align:right">
                    Amount(@Model.CurrencySymbol)
                </td>
                <td style="width:10%">
                    @Html.TextBoxFor(model => model.Amount, new { style = "width: 100%; text-align:right;", id = "txtAmountST", disabled = "disabled" })
                </td>
                <td style="width:10%; text-align:right">
                    Amount(@Model.ExchangeCurrencySymbol)
                </td>
                <td style="width:10%; text-align:right">
                    @Html.TextBoxFor(model => model.AmountWithCRate, new { style = "width: 100%;text-align:right;", id = "txtAmountWithCRateST", disabled = "disabled" })
                </td>
            </tr>
        </table>
    </fieldset>
    <div id="dvSampleInvoiceDetail" style="width:100%;">
        <table id="tblSampleInvoiceDetail" title="Order Detail Information" class="easyui-datagrid" style="width:100%;height:190px"
                data-options="
                singleSelect: true,
                fitColumns:false,
                rownumbers:true,
                pagination:false,
                autoRowHeight:false,
                toolbar: '#toolbar'
            ">
            <thead>
                <tr>
                    <th field="LabdipNo" width="10%" align="left">Labdip No</th>
                    <th field="ProductNameCode" width="25%" align="left">Product Name</th>
                    <th field="ColorName" width="10%" align="left">Color</th>
                    <th field="ColorNo" width="10%" align="left">Color No</th>
                    <th field="PantonNo" width="10%" align="left">Panton No</th>
                    <th field="ShadeSt" width="5%" align="left">Shade</th>
                    <th field="Qty" width="10%" align="right" formatter="formatPrice">Qty(Lbs)</th>
                    <th field="UnitPrice" width="10%" align="right">UnitPrice(@Model.CurrencySymbol/LBS)</th>
                    <th field="Amount" width="10%" align="right" formatter="formatPrice">Amount(@Model.CurrencyName)</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a id="btnShowdetails" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="Showdetails()">Show details </a>
        </div>
    </div>
    <div id="dvSampleInvoiceDetail_Other" style="width:100%;">
        <table id="tblSampleInvoiceDetail_Other" title="Order Detail Information" class="easyui-datagrid" style="width:100%;height:210px"
                data-options="
                singleSelect: true,
                fitColumns:false,
                rownumbers:true,
                pagination:false,
                autoRowHeight:false,
                toolbar: '#toolbar'
            ">
            <thead>
                <tr>
                    <th field="ProductName" width="55%" align="left">Description</th>
                    <th field="Qty" width="15%" align="right" formatter="formatPrice">Qty</th>
                    <th field="UnitPrice" width="10%" align="right">UnitPrice(@Model.CurrencyName)</th>
                    <th field="Amount" width="15%" align="right" formatter="formatPrice">Amount(@Model.CurrencyName)</th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="dvPayment" style="width:100%;">
        <table id="tblPayments" title="Payment Information" class="easyui-datagrid" style="width:100%;height:160px"
                data-options="singleSelect: true,fitColumns:false,rownumbers:true,pagination:false,autoRowHeight:false">
            <thead>
                <tr>
                    <th field="PaymentNo" width="45%" align="left">Payment Description</th>
                    <th field="PaymentDateST" width="15%" align="left">Effect Date</th>
                    <th field="AmountST" width="15%" align="left">Amount</th>
                    <th field="Note" width="20%" align="left">Comments</th>

                </tr>
            </thead>
        </table>
    </div>
    <div id="dvPartyLedger" style="width:100%;">
        <table id="tblPartyLog" title="Invoice Ledger status" class="easyui-datagrid" style="width:100%;height:160px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" , autorowheight="false">
            <thead>
                <tr>


                    <th data-options="field:'DateTimeInString',width:100,align:'right'">Effect On</th>
                    <th data-options="field:'PartyTriggerTypeInString',width:280,align:'left'">Type</th>
                    <th data-options="field:'Debit_TotalValue',width:120,align:'right',formatter:formatPrice">Debit</th>
                    <th data-options="field:'Credit_TotalValue',width:120,align:'right',formatter:formatPrice">Credit</th>
                    <th data-options="field:'ClosingValue',width:120,align:'right',formatter:formatPrice">Closing Value</th>
                </tr>
            </thead>
        </table>
    </div>
    <fieldset>
        <table border="0" style="width:100%;font-size:11px; font-weight:bold">
            <tr>
                <td style="width:10%">
                    <input id="btnShowLedger" type="button" value="Show Ledger" />
                </td>
                <td style="width:60%"></td>
                <td style="width:5%; text-align:right"></td>
                <td style="width:15%">
                    <a id="btnApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true">Approved</a>
                    <a id="btnNotApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Cancel</a>
                </td>
                <td style="width:10%">
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-closed" plain="true">Close</a>
                </td>

            </tr>
        </table>
    </fieldset>
</div>


<script type="text/javascript">
    //    debugger;
    var _nAmount=0;
    var _nQty=0;
    var _nDeliveryQty=0;
    var _nStockInHand=0;
    var _nYetToDelivery=0;
    var _nValueWithCRate=0;
    var _oSampleInvoice;
    var _oSampleInvoiceDetail;
    var _oSampleInvoiceDetails=[];
    var _oPayments=[];
    var _bIsShow=false;
    var _sBackLink="";
    $(document).ready(function () {
        debugger;
    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    _oSampleInvoice =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    _oSampleInvoiceDetails = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.SampleInvoiceDetails));
    var sHeader=sessionStorage.getItem("Header");
    _sBackLink=sessionStorage.getItem("BackLink");
    if(sHeader=="Cancel")
    {
        $('#btnApproved').hide();
        $('#btnNotApproved').show();
    }
    else if(sHeader=="Approved")
    {
        $('#btnApproved').show();
        $('#btnNotApproved').hide();
    }
    else if(sHeader=="View")
    {
        $('#btnApproved').hide();
        $('#btnNotApproved').hide();
    }
    $('#txtInvoiceType').val("Sample Invoice");
    $('#txtPaymentAdjType').val(_oSampleInvoice.PaymentAdjTypeSt);
    debugger;
    //Invoice Type : None = 0, SampleInvoice = 1, Adjstment_Qty = 3, Adjstment_Value = 4, Cr_Transfer = 5, DocCharge = 10,SalesContract=11  
    if(_oSampleInvoice.InvoiceType==1 || _oSampleInvoice.InvoiceType==11)
    {
        _oSampleInvoiceDetails = _oSampleInvoice.SampleInvoiceDetails;
        document.getElementById('dvSampleInvoiceDetail').style.display ='none';
        document.getElementById('dvSampleInvoiceDetail_Other').style.display  = '';
        document.getElementById('btnShowdetails').style.display ='none';
    }
    else
    {
        document.getElementById('dvSampleInvoiceDetail').style.display  ='';
        document.getElementById('dvSampleInvoiceDetail_Other').style.display  ='none';
        document.getElementById('btnShowdetails').style.display ='';
    }
    RefreshList(_oSampleInvoiceDetails);
    document.getElementById('dvPayment').style.display ='';
    document.getElementById('dvPartyLedger').style.display  = 'none';
 });

     function RefreshList(oSampleInvoiceDetails)
    {
         data=oSampleInvoiceDetails;
         data={"total":""+data.length+"","rows":data};
         $('#tblSampleInvoiceDetail').datagrid('loadData',data);

         data=oSampleInvoiceDetails;
         data={"total":""+data.length+"","rows":data};
         $('#tblSampleInvoiceDetail_Other').datagrid('loadData',data);
    }
     function RefreshList_Payments(oPayments)
    {
          data=oPayments;
          data={"total":""+data.length+"","rows":data};
          $('#tblPayments').datagrid('loadData',data);
    }
     $('#btnApproved').click(function ()
     {
//   Initialized = 0,      WaitingForApprove = 1,        Approved = 2,        Not_Approved = 3,        RequestToPaymentTypeChange = 4,       Settled = 5,
           debugger;
            var conf = confirm("Are you sure you want to Approve selected item?");
            if(conf==false)return;
            var oSampleInvoice= {
                            SampleInvoiceID : _oSampleInvoice.SampleInvoiceID,
                            SampleInvoiceNo:_oSampleInvoice.SampleInvoiceNo,
                            PaymentType : _oSampleInvoice.PaymentType,
                            InvoiceTypeInt :  _oSampleInvoice.InvoiceType,
                            CurrentStatusInt: 2
                        };
            if(parseInt(oSampleInvoice.CurrentStatusInt)> 0)
            {
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+"/SampleInvoice/Approve",
                    traditional: true,
                    data:  JSON.stringify(oSampleInvoice),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;
                        var oSampleInvoice = jQuery.parseJSON(data);
                        if ( oSampleInvoice.ErrorMessage=="" || oSampleInvoice.ErrorMessage==null )
                        {
                            alert("data updated sucessfully");
                            window.location.href = _sBackLink;
                        }
                        else
                        {
                            alert(oSampleInvoice.ErrorMessage);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                    }
                });
            }
    });
     $('#btnNotApproved').click(function ()
     {
    //   Initialized = 0,      WaitingForApprove = 1,        Approved = 2,        Not_Approved = 3,        RequestToPaymentTypeChange = 4,       Settled = 5,

           var conf = confirm("Are you sure you want to Approve selected item?");
           if(conf==false)return;

           var oSampleInvoice= {
               SampleInvoiceID : _oSampleInvoice.SampleInvoiceID,
               SampleInvoiceNo:_oSampleInvoice.SampleInvoiceNo,
               PaymentType : _oSampleInvoice.PaymentType,
               InvoiceTypeInt :  _oSampleInvoice.InvoiceType,
               CurrentStatusInt: 2
           };

           if (oSampleInvoice.CurrentStatusInt> 0)
           {
               $.ajax({
                   type: "POST",
                   dataType: "json",

                   url : _sBaseAddress+  "/SampleInvoice/Cancel",
                   traditional: true,
                   data:  JSON.stringify(oSampleInvoice),

                   contentType: "application/json; charset=utf-8",
                   success: function (data) {
                       debugger;
                       var oSampleInvoice = jQuery.parseJSON(data);
                       if ( oSampleInvoice.ErrorMessage=="" || oSampleInvoice.ErrorMessage==null ) {
                           alert("data updated sucessfully");
                           window.location.href = _sBackLink;
                       }
                       else
                       {
                           alert(oSampleInvoice.ErrorMessage);
                       }
                   },
                   error: function (xhr, status, error) {
                       alert(error);
                   }
               });
           }
    });
     function Showdetails()
    {
       //debugger;
          var oSampleInvoiceDetail= $('#tblSampleInvoiceDetail').datagrid('getSelected');
        if(oSampleInvoiceDetail==null || oSampleInvoiceDetail.OrderID<=0)
        {
            alert("Please select a item from list!");
            return;
        }

        var oParameter = new Object();

        if(oSampleInvoiceDetail.OrderType==2)
        {

        oParameter.Name = "View SampleOrder";
        var url = "/SampleOrder/ViewSampleOrder?id="+oSampleInvoiceDetail.OrderID;
        oSampleOrder = window.showModalDialog(url, oParameter, 'dialogHeight:700px;dialogWidth:800px;dialogLeft:300;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
        }

           if(oSampleInvoiceDetail.OrderType==3)
        {
        var oParameter = new Object();
        var url = "/PI/ViewDetails?id=" + oSampleInvoiceDetail.OrderID;
        window.showModalDialog(url, oParameter, 'dialogHeight:600px;dialogWidth:860px;center:yes;resizable:yes;status:no;scroll:yes');
        }
     }
     $('#btnShowLedger').click(function () {

         _bIsShow=!_bIsShow;
         ShowPartyLedger(_bIsShow);
     });
     function ShowPartyLedger(IsShow)
     {
         var oPartyLogs=[];
         if(IsShow)
         {
             var oRPT_SampleInvoiceApprove={InvoiceID:_oSampleInvoice.SampleInvoiceID,ContractorID:_oSampleInvoice.ContractorID }

             $.ajax
               ({
                   type: "POST",
                   dataType: "json",
                   url : _sBaseAddress+  "/RPT_SampleInvoiceApprove/GetsPartyLedger",
                   data:  JSON.stringify(oRPT_SampleInvoiceApprove),
                   contentType: "application/json; charset=utf-8",
                   success: function (data) {
                       oPartyLogs = jQuery.parseJSON(data);
                       DynamicRefreshList(oPartyLogs,"tblPartyLog");
                   },
                   error: function (xhr, status, error)
                   {
                       alert(error);
                   }
               });

             document.getElementById('dvPayment').style.display ='none';
             document.getElementById('dvPartyLedger').style.display  = '';
         }
         else
         {
             document.getElementById('dvPayment').style.display ='';
             document.getElementById('dvPartyLedger').style.display  = 'none';
         }
     }
     $("#btnClose").click(function(){
         window.location.href = _sBackLink;
     });
     $(document).keydown(function(e) {
         if(e.which == 27)//escape=27
         {
             window.location.href = _sBackLink;
         }
     });
    
</script>   