@{
    ViewBag.Title = "Fabric Requisition List";
}
@model IEnumerable<ESimSol.BusinessObjects.FabricRequisition>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>

    <div id="winAdvSearch" class="easyui-window winClass" title="Adv. Search" style="width:480px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%;">
                <tr>
                    <td>
                        <fieldset style="margin-bottom: 0px;">
                            <legend>Searching Criteria</legend>
                            <table>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Dispo No </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <input id="txtDispoNo" type="text" style="width:100%" />
                                    </td>
                                </tr>
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Layout Type </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select id="cboLayoutType" style="width:100%;"></select>
                                    </td>
                                </tr>*@
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label> Req. Date </label>
                                    </td>
                                    <td colspan="3">
                                        <select id="cboDate" style="width:35%;" onchange="DateActionsOrderDateAdvSearch();"></select>
                                        <input id="txtFromDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="txtToDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Warp/Weft </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select id="cboWarpWeftType" style="width:100%;"></select>
                                    </td>
                                </tr>*@
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label> Receive Date </label>
                                    </td>
                                    <td colspan="3">
                                        <select id="cboReceiveDate" style="width:35%;" onchange="DateActionsOrderRcvDateAdvSearch();"></select>
                                        <input id="txtFromReceiveDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="txtToReceiveDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Buyer </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <table style=" width:100%;">
                                            <tr style=" width:100%;">
                                                <td style=" width:78%;"><input type="text" style=" width:100%;" id="txtBuyerName" onkeydown="BuyerKeyDown(event);" /> </td>
                                                <td style="width: 20%;"><input type="button" id="btnBuyer" onclick="PickBuyer()" style="width:100%;float:right;" value="Pick" /></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>*@
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Status </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select id="cboStatus" style="width:100%;">
                                            <option value="0">--Select One--</option>
                                            <option value="1">Yet To Approve</option>
                                            <option value="2">Wait For Receive</option>
                                            <option value="3">Wait For Disburse</option>
                                        </select>
                                    </td>
                                </tr>*@


                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Req. Type </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select style="width: 100%;" id="cboRequsitionType">
                                            <option value="0">--Select One--</option>
                                            <option value="102">SRS</option>
                                            <option value="101">SRM</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Lot/Roll No </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <input id="txtLotNo" type="text" style="width:100%" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Issue Store </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select style="width: 100%;" id="cboIssueStore"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Receive Store </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <select style="width: 100%;" id="cboReceiveStore"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label> Disburse Date </label>
                                    </td>
                                    <td colspan="3">
                                        <select id="cboDisburseDate" style="width:35%;" onchange="DateActionsOrderDisburseDateAdvSearch();"></select>
                                        <input id="txtFromDisburseDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="txtToDisburseDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Yarn Count </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <table style=" width:100%;">
                                            <tr style=" width:100%;">
                                                <td style=" width:78%;"><input type="text" style=" width:100%;" id="txtYarnName" onkeydown="YarnKeyDown(event);" /> </td>
                                                <td style="width: 20%;"><input type="button" id="btnYarn" onclick="PickYarn()" style="width:100%;float:right;" value="Pick" /></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>*@
                              
                                <tr>
                                    <td height="25px" colspan="4"></td>
                                </tr>
                              
                            </table>
                            
                        </fieldset>
                    </td>
                </tr>
            </table>
           
            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <a id="btnPreviewList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview List</a>
                <label class="lblLoadingMessage" style="float: left;font-size:15px;">Loading Please Wait...</label>
                <a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" onclick="ResetAdvSearchWindow()" plain="true">Reset</a>
                <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>
    
    <div class="menuMainCollectionTable" id="regionFabricRequisition">
        <table id="tblFabricRequisitions" title="Fabric Requisition List" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
            <thead>
                <tr>
                    <th field="ReqNo" width="9%">Request No</th>
                    <th field="RequisitionTypeInString" width="9%">Req. Type</th>
                    <th field="ReqDateInString" width="9%">Request Date</th>
                    <th field="ApproveDateInString" width="8%">Approve Date</th>
                    <th field="ApprovedByName" width="12%">Approve By</th>
                    <th field="DisburseDateInString" width="8%">Disburse Date</th>
                    <th field="DisburseByName" width="12%">Disburse By</th>
                    <th field="ReceiveDateInString" width="8%">Receive Date</th>
                    <th field="ReceivedByName" width="12%">Receive By</th>
                    <th field="Note" width="15%">Note</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <input type="text" id="txtSearchByReqNo" placeholder="Search by Req. No" style="width:120px;text-align:left" />
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New</a>
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="ChangeStatus('Approve')" plain="true">Approve</a>
            <a id="btnUndoApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" onclick="ChangeStatus('Unapprove')" plain="true">Undo Approve </a>
            <a id="btnDisburse" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-disburse" plain="true">Disburse</a>
            @*<a id="btnUndoDisburse" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Undo Disburse</a>*@
            <a id="btnReceive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-receive" plain="true">Receive</a>
            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
            <div style="float:right;margin-right:10px;">
                <label>Print Format :</label>
                <input id="rdoMeter" type="radio" name="Unit" checked />Meter
                <input id="rdoYard" type="radio" name="Unit" />Yard
            </div>
        </div>
    </div>

    <script type="text/javascript">
    debugger;
    var _oFabricRequisition=null;
    var _oFabricRequisitions=[];
    var _sBaseAddress="";
    var _oAuthorizationRolesMapping=[];
    var _oCompareOperators=[];
    var _oIssueStores=[];
    var _oReceiveStores=[];

    $(document).ready(function () {
        debugger;
        _oFabricRequisitions =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oCompareOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        _oIssueStores = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.IssueStores));
        _oReceiveStores=  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ReceiveStores));
        sessionStorage.setItem("BUID",nBUID);

        var oFabricRequisitions =sessionStorage.getItem("FabricRequisitions");
        if(oFabricRequisitions!=null)
        {
            oFabricRequisitions = jQuery.parseJSON(oFabricRequisitions);
        }
        else
        {
            oFabricRequisitions=_oFabricRequisitions;
        }
        RefreshList(oFabricRequisitions);
        RefreshControlLayout();
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();

        //Adv search
        

    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }


    $('#tblFabricRequisitions').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData)
    {
        debugger;
        if (rowData != null && rowData.FabricRequisitionID > 0)
        {
            debugger;
            if(rowData.ApprovedBy!=0 && rowData.DisburseBy==0)
            {
                $('#btnEdit,#btnDelete,#btnApprove,#btnReceive,#btnUndoDisburse').hide();
                //$('#btnDisburse,#btnUndoApprove').show();
                if (PermissionChecker('Approved', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnUndoApprove").show();}
                if (PermissionChecker('Disburse', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnDisburse").show();}
            }
            else if(rowData.ApprovedBy!=0 && rowData.DisburseBy!=0 && rowData.ReceivedBy==0)
            {
                //$('#btnUndoDisburse,#btnReceive').show();
                $('#btnEdit,#btnDelete,#btnApprove,#btnUndoApprove,#btnDisburse').hide();
                if (PermissionChecker('Disburse', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnUndoDisburse").show();}
                if (PermissionChecker('Received', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnReceive").show();}
            }
            else if(rowData.ApprovedBy!=0 && rowData.DisburseBy!=0 && rowData.ReceivedBy!=0)
            {
                $('#btnEdit,#btnDelete,#btnDisburse,#btnUndoApprove,#btnApprove,#btnReceive,#btnUndoDisburse,#btnDisburse,#btnUndoApprove').hide();
            }
            else if(rowData.ApprovedBy==0 && rowData.ReceivedBy==0)
            {
                //$('#btnEdit,#btnDelete,#btnApprove').show();
                $('#btnReceive,#btnUndoDisburse,#btnDisburse,#btnUndoApprove').hide();
                if (PermissionChecker('Edit', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
                if (PermissionChecker('Delete', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
                if (PermissionChecker('Approved', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnApprove").show();}

            }
            else
            {
                $('#btnDisburse,#btnUndoApprove,#btnReceive,#btnUndoDisburse,#btnDisburse,#btnUndoApprove').hide();
                //$('#btnEdit,#btnDelete,#btnApprove').show();
                if (PermissionChecker('Edit', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
                if (PermissionChecker('Delete', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
                if (PermissionChecker('Approved', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnApprove").show();}
            }


        }
    }
    $("#btnAdd").click(function(){
        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("FabricRequisitionHeader", "Add Fabric Requisition");
        sessionStorage.setItem('Action','Add')
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/FabricRequisition/ViewFabricRequisition?id=0&buid="+sessionStorage.getItem('BUID');  //
    });

    $("#btnEdit").click(function(){

        debugger;
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oFabricRequisition.ApprovedBy != 0 || oFabricRequisition.DisburseBy != 0){
            alert("You can not Edit this item!");
            return false;
        }

        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("FabricRequisitionHeader", "Edit Fabric Requisition");
        sessionStorage.setItem('Action','Edit')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/FabricRequisition/ViewFabricRequisition?id="+oFabricRequisition.FabricRequisitionID+"&buid="+sessionStorage.getItem('BUID');
    });

    $("#btnView").click(function(){
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("FabricRequisitionHeader", "View Fabric Requisition");
        sessionStorage.setItem('Action','View')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/FabricRequisition/ViewFabricRequisition?id="+oFabricRequisition.FabricRequisitionID+"&buid="+sessionStorage.getItem('BUID');
    });

    $("#btnDelete").click(function(){
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if(oFabricRequisition.ApprovedBy != 0 || oFabricRequisition.DisburseBy != 0){
            alert("You can not delete this item!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        if (oFabricRequisition.FabricRequisitionID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricRequisition/Delete",
                data: JSON.stringify(oFabricRequisition),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage.toLowerCase() == "data delete successfully")
                    {
                        alert("Delete sucessfully");
                        $('#tblFabricRequisitions').datagrid('deleteRow',SelectedRowIndex);
                        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
                        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });

    $("#btnDisburse").click(function(){
        debugger;
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oFabricRequisition.ApprovedBy == 0){
            alert("Please Approve First!!");
            return;
        }
        if(oFabricRequisition.DisburseBy != 0){
            alert("Already Disbursed!!");
            return;
        }

        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("FabricRequisitionHeader", "Disburse Fabric Requisition");
        sessionStorage.setItem('Action','Disburse')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/FabricRequisition/ViewFabricRequisition?id="+oFabricRequisition.FabricRequisitionID+"&buid="+sessionStorage.getItem('BUID');
    });

    $("#btnReceive").click(function(){
        debugger;
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oFabricRequisition.DisburseBy == 0){
            alert("Please Disburse First!!");
            return;
        }
        if(oFabricRequisition.ReceivedBy != 0){
            alert("Already Received!!");
            return;
        }

        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        var oFabricRequisitions= $('#tblFabricRequisitions').datagrid('getRows');
        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("FabricRequisitionHeader", "Receive Fabric Requisition");
        sessionStorage.setItem('Action','Receive')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/FabricRequisition/ViewFabricRequisition?id="+oFabricRequisition.FabricRequisitionID+"&buid="+sessionStorage.getItem('BUID');
    });

    function ChangeStatus(sAction){
        var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if(sAction == 'Approve'){
            if(oFabricRequisition.ApprovedBy != 0){
                alert("Already Approve!!");
                return;
            }
        }else if(sAction == 'Disburse'){
            if(oFabricRequisition.ApprovedBy == 0){
                alert("Please Approve First!!");
                return;
            }
            if(oFabricRequisition.DisburseBy != 0){
                alert("Already Disbursed!!");
                return;
            }
        }else if(sAction == 'Unapprove'){
            if(parseInt(oFabricRequisition.ApprovedBy) == 0){
                alert("Undo Approve is not possible!!");
                return;
            }
        }
        

        if (!confirm("Confirm to "+sAction+"?")) return ;
        var SelectedRowIndex=$('#tblFabricRequisitions').datagrid('getRowIndex',oFabricRequisition);
        oFabricRequisition.ErrorMessage = sAction;
        if (oFabricRequisition.FabricRequisitionID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricRequisition/ChangeStatus",
                data: JSON.stringify(oFabricRequisition),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    oFabricRequisition = jQuery.parseJSON(data);
                    if (oFabricRequisition.ErrorMessage=="" || oFabricRequisition.ErrorMessage == null)
                    {
                        alert(sAction + " sucessfully");
                        $('#tblFabricRequisitions').datagrid('updateRow',{index: SelectedRowIndex,row: oFabricRequisition});
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    }

    function RefreshList(oFabricRequisitions)
    {
        debugger;
        var data=oFabricRequisitions;
        data={"total":""+data.length+"","rows":data};
        $('#tblFabricRequisitions').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        $('#tblFabricRequisitions').datagrid('selectRow',nIndex);
    }

    $("#btnCloseAdvSearch").click(function () {
        $("#winAdvSearch").icsWindow("close");
    });

    $("#btnAdvSearch").click(function () {
        debugger;
        LoadComboAdv();
        $(".lblLoadingMessage").hide();
        $("#winAdvSearch").icsWindow("open", "Fabric Requisition Advance Search");
        ResetAdvSearchWindow();
    });

    function ResetAdvSearchWindow() {
        DynamicResetAdvSearchWindow("winAdvSearch");
        $("#winAdvSearch input").not("input[type='button']").val("");
        $("#winAdvSearch input").removeClass("fontColorOfPickItem");
        $("#winAdvSearch select").val(0);

        $("#txtFromDateAdvSearch,#txtToDateAdvSearch,#txtFromReceiveDateAdvSearch,#txtToReceiveDateAdvSearch,#txtFromDisburseDateAdvSearch,#txtToDisburseDateAdvSearch").datebox({ disabled: true });
        $("#txtFromDateAdvSearch,#txtToDateAdvSearch,#txtFromReceiveDateAdvSearch,#txtToReceiveDateAdvSearch,#txtFromDisburseDateAdvSearch,#txtToDisburseDateAdvSearch").datebox("setValue", icsdateformat(new Date()));
        //$("#winAdvSearch").data("BuyerID","");
        //$("#winAdvSearch").data("YarnID","");
    }

    $("#btnSearchAdvSearch").click(function () {
        debugger;

        $(".lblLoadingMessage").show();

        var checkDate = CheckFromAndToDateValidation("cboDate", "txtFromDateAdvSearch", "txtToDateAdvSearch");
        if (!checkDate) {
            alert("Issue Start date must be greater than end date.");
            return;
        }
        checkDate = CheckFromAndToDateValidation("cboReceiveDate", "txtFromReceiveDateAdvSearch", "txtToReceiveDateAdvSearch");
        if (!checkDate) {
            alert("Receive Start date must be greater than end date.");
            return;
        }
        checkDate = CheckFromAndToDateValidation("cboDisburseDate", "txtFromDisburseDateAdvSearch", "txtToDisburseDateAdvSearch");
        if (!checkDate) {
            alert("Disburse Start date must be greater than end date.");
            return;
        }

        var sDispoNo = $("#txtDispoNo").val();
        //var nLayoutType=parseInt($("#cboLayoutType").val());

        var ncboDate = parseInt($("#cboDate").val());
        var dFromDate = $('#txtFromDateAdvSearch').datebox('getValue');
        var dToDate = $('#txtToDateAdvSearch').datebox('getValue');

        //var nWarpWeftType = parseInt($("#cboWarpWeftType").val());

        var ncboReceiveDate = parseInt($("#cboReceiveDate").val());        
        var dFromReceiveDate = $('#txtFromReceiveDateAdvSearch').datebox('getValue');
        var dToReceiveDate = $('#txtToReceiveDateAdvSearch').datebox('getValue');

        var sLotNo = $("#txtLotNo").val();
        var ncboRequsitionType = parseInt($("#cboRequsitionType").val());
        var ncboIssueStore = parseInt($("#cboIssueStore").val());
        var ncboReceiveStore = parseInt($("#cboReceiveStore").val());
        //var sYarnIDs = $("#winAdvSearch").data("YarnID");

        var ncboDisburseDate = parseInt($("#cboDisburseDate").val());
        var dFromDisburseDate = $('#txtFromDisburseDateAdvSearch').datebox('getValue');
        var dToDisburseDate = $('#txtToDisburseDateAdvSearch').datebox('getValue');

        //var sBuyerIDs = $("#winAdvSearch").data("BuyerID");
        //var nStatus = parseInt($("#cboStatus").val());

        var SearchStringDate = ncboDate + "~" +
                      dFromDate + "~" +
                      dToDate + "~" +
                    ncboReceiveDate + "~" +
                    dFromReceiveDate + "~" +
                    dToReceiveDate + "~" +                    
                    ncboDisburseDate + "~" +
                    dFromDisburseDate + "~" +
                    dToDisburseDate + "~" +
                    sDispoNo+ "~" +
                     ""+ "~" +
                    sLotNo;

        var oFabricRequisition = {
            ErrorMessage : SearchStringDate,
            RequisitionType: ncboRequsitionType,
            IssueStoreID: ncboIssueStore,
            ReceiveStoreID: ncboReceiveStore
        };

        GetsOrders(oFabricRequisition);
    });
    function GetsOrders(oFabricRequisition)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricRequisition/AdvSearch",
            traditional: true,
            data: JSON.stringify(oFabricRequisition),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //var oFabricRequisitions = jQuery.parseJSON(data);
                var oFabricRequisitions = data;
                debugger;
                if (oFabricRequisitions != null) {
                    if (oFabricRequisitions.length > 0)
                    {
                        DynamicRefreshList(oFabricRequisitions, "tblFabricRequisitions");
                        $("#winAdvSearch").icsWindow("close");
                    }
                    else
                    {
                        alert("Sorry, No data found.");
                        //DynamicRefreshList([], "tblWYRequisition");
                    }

                } else {
                    alert("Sorry, No data found.");
                    //DynamicRefreshList([], "tblWYRequisition");
                }
                $(".lblLoadingMessage").hide();
            }
        });
    }

    $("#txtSearchByReqNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            debugger;
            var SearchStringDate = 0 + "~" +
                   icsdateformat(new Date()) + "~" +
                      icsdateformat(new Date()) + "~" +
                 0 + "~" +
                 icsdateformat(new Date()) + "~" +
                      icsdateformat(new Date()) + "~" +           
                 0 + "~" +
                icsdateformat(new Date()) + "~" +
                      icsdateformat(new Date()) + "~" +
                 ""+ "~" +
                 $('#txtSearchByReqNo').val()+ "~" +
                 "";

            var oFabricRequisition = {
                ErrorMessage : SearchStringDate,
            };

           
            GetsOrders(oFabricRequisition);
        }
        else if(nkeyCode==8){
            $("#txtSearchByClaimNo").val("");

        }
    });

    function LoadComboAdv()
    {
        $("#cboDate").icsLoadCombo({ List: _oCompareOperators, OptionValue: "id", DisplayText: "Value" });
        $("#cboReceiveDate").icsLoadCombo({ List: _oCompareOperators, OptionValue: "id", DisplayText: "Value" });
        $("#cboDisburseDate").icsLoadCombo({ List: _oCompareOperators, OptionValue: "id", DisplayText: "Value"});
        $("#cboIssueStore").icsLoadCombo({ List: _oIssueStores,  OptionValue: "WorkingUnitID",  DisplayText: "WorkingUnitName",});
        $("#cboReceiveStore").icsLoadCombo({ List: _oReceiveStores,  OptionValue: "WorkingUnitID",  DisplayText: "WorkingUnitName",});
    }

    function DateActionsOrderDateAdvSearch() {
        DynamicDateActions("cboDate", "txtFromDateAdvSearch", "txtToDateAdvSearch");
    }
    function DateActionsOrderRcvDateAdvSearch() {
        DynamicDateActions("cboReceiveDate", "txtFromReceiveDateAdvSearch", "txtToReceiveDateAdvSearch");
    }
    function DateActionsOrderDisburseDateAdvSearch() {
        DynamicDateActions("cboDisburseDate", "txtFromDisburseDateAdvSearch", "txtToDisburseDateAdvSearch");
    }

    function CheckFromAndToDateValidation(OperationComboId, FromDateId, ToDateId) {
        $("#" + OperationComboId).parent().parent().parent().find("select").removeClass("errorFieldBorder");
        var nCboVal = $("#" + OperationComboId).val();
        if (parseInt(nCboVal) == 5 || parseInt(nCboVal) == 6) {
            var fromDate = $("#" + FromDateId).datebox("getValue");
            var toDate = $("#" + ToDateId).datebox("getValue");
            if (new Date(fromDate) > new Date(toDate)) {
                $("#" + ToDateId).focus();
                $("#" + OperationComboId).addClass("errorFieldBorder");
                $(".lblLoadingMessage").hide();
                return false;
            } else {
                $("#" + OperationComboId).removeClass("errorFieldBorder");
                return true;
            }
        } else {
            return true;
        }
    }

    $('#btnPrint').click(function(){
        var oFabricRequisition=$('#tblFabricRequisitions').datagrid('getSelected');
        if(oFabricRequisition==null || parseInt(oFabricRequisition.FabricRequisitionID)<=0)
        {
            alert("Please select Fabric Requisition!!");
            return;
        }
        var bIsInMtr = $("#rdoMeter").is(':checked');
        window.open(_sBaseAddress+ "/FabricRequisition/FabricRequisitionPrintPreview?id="+oFabricRequisition.FabricRequisitionID+"&buid="+sessionStorage.getItem("BUID")+"&bIsInMtr="+bIsInMtr);
    });

    $('#btnPreviewList').click(function()
    {
        debugger;
        //$(".lblLoadingMessage").show();
        var checkDate = CheckFromAndToDateValidation("cboDate", "txtFromDateAdvSearch", "txtToDateAdvSearch");
        if (!checkDate) {
            alert("Issue Start date must be greater than end date.");
            return;
        }
        checkDate = CheckFromAndToDateValidation("cboReceiveDate", "txtFromReceiveDateAdvSearch", "txtToReceiveDateAdvSearch");
        if (!checkDate) {
            alert("Receive Start date must be greater than end date.");
            return;
        }
        checkDate = CheckFromAndToDateValidation("cboDisburseDate", "txtFromDisburseDateAdvSearch", "txtToDisburseDateAdvSearch");
        if (!checkDate) {
            alert("Disburse Start date must be greater than end date.");
            return;
        }

        var sDispoNo = $("#txtDispoNo").val();
        //var nLayoutType=parseInt($("#cboLayoutType").val());

        var ncboDate = parseInt($("#cboDate").val());
        var dFromDate = $('#txtFromDateAdvSearch').datebox('getValue');
        var dToDate = $('#txtToDateAdvSearch').datebox('getValue');

        //var nWarpWeftType = parseInt($("#cboWarpWeftType").val());

        var ncboReceiveDate = parseInt($("#cboReceiveDate").val());        
        var dFromReceiveDate = $('#txtFromReceiveDateAdvSearch').datebox('getValue');
        var dToReceiveDate = $('#txtToReceiveDateAdvSearch').datebox('getValue');

        var sLotNo = $("#txtLotNo").val();
        var ncboRequsitionType = parseInt($("#cboRequsitionType").val());
        var ncboIssueStore = parseInt($("#cboIssueStore").val());
        var ncboReceiveStore = parseInt($("#cboReceiveStore").val());
        //var sYarnIDs = $("#winAdvSearch").data("YarnID");

        var ncboDisburseDate = parseInt($("#cboDisburseDate").val());
        var dFromDisburseDate = $('#txtFromDisburseDateAdvSearch').datebox('getValue');
        var dToDisburseDate = $('#txtToDisburseDateAdvSearch').datebox('getValue');

        //var sBuyerIDs = $("#winAdvSearch").data("BuyerID");
        //var nStatus = parseInt($("#cboStatus").val());

        var SearchStringDate = ncboDate + "~" +
                      dFromDate + "~" +
                      dToDate + "~" +
                    ncboReceiveDate + "~" +
                    dFromReceiveDate + "~" +
                    dToReceiveDate + "~" +                    
                    ncboDisburseDate + "~" +
                    dFromDisburseDate + "~" +
                    dToDisburseDate + "~" +
                    sDispoNo+ "~" +
                     ""+ "~" +
                    sLotNo;

        var oFabricRequisition = {
            ErrorMessage : SearchStringDate,
            RequisitionType: ncboRequsitionType,
            IssueStoreID: ncboIssueStore,
            ReceiveStoreID: ncboReceiveStore
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricRequisition/SetSessionSearchCriterias",
            traditional: true,
            data:  JSON.stringify(oFabricRequisition),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful") {
                    var tsv=((new Date()).getTime())/1000;
                    window.open(_sBaseAddress+'/FabricRequisition/PrintLists?ts='+tsv,"_blank");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    function RefreshControlLayout()
    {
        $("#btnAdd,#btnEdit,#btnDelete,#btnApprove,#btnDisburse,#btnUndoDisburse,#btnReceive,#btnUndoApprove").hide();
        //if (PermissionChecker('AdvSearch', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnAdvSearch").show();}
        if (PermissionChecker('Add', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnAdd").show();}
        if (PermissionChecker('Edit', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
        //if (PermissionChecker('View', 'WYRequisition',_oAuthorizationRolesMapping)) {$("#btnView").show();}
        if (PermissionChecker('Delete', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
        if (PermissionChecker('Approved', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnApprove").show();}
        if (PermissionChecker('UnApproved', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnUndoApprove").show();}
        if (PermissionChecker('Disburse', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnDisburse").show();}
        if (PermissionChecker('Received', 'FabricRequisition',_oAuthorizationRolesMapping)) {$("#btnReceive").show();}
    }

   


</script>
