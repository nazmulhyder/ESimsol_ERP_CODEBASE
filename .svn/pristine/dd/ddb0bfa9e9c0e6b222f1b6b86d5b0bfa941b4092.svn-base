@{
    ViewBag.Title = "Attendance Access Point";
}
<html>
<head>
    <title>Attendance Access Point</title>
</head>
<body>
    @model ESimSol.BusinessObjects.AttendanceAccessPoint
    <div class="menuMainCollectionTable">
        <table border="0" style="width:100%;">
            <tr>
                <td>
                    <fieldset>
                        <legend>User Info</legend>
                        <table border="0" style="width:100%;">
                            <tr>
                                <td colspan="2" style="text-align:right; padding-right:1%;">
                                    <label>This PC: </label>
                                    <span>
                                        <input id="chkThisPC" type="checkbox" />
                                    </span>

                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Access Point: </label></td>
                                <td class="td-right">
                                    <input id="txtAccessPoint" type="text" class="cls-txt" placeholder="Access point" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Machine No: </label></td>
                                <td class="td-right">
                                    <input id="txtMachineSlNo" type="text" class="cls-txt" placeholder="Machine serial no" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Note: </label></td>
                                <td class="td-right">
                                    <textarea id="txtNote" class="cls-txt" placeholder="Description"></textarea>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </td>
                <td>
                    <fieldset>
                        <legend>Database Access Info</legend>
                        <table border="0" style="width:100%;">
                            <tr>
                                <td class="td-left"><label>Data Provider: </label></td>
                                <td class="td-right">
                                    <select id="cboDataProvider" class="cls-cbo"></select>
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Data Source: </label></td>
                                <td class="td-right">
                                    <input id="txtDataSource" type="text" class="cls-txt" placeholder="Data source" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Login ID: </label></td>
                                <td class="td-right">
                                    <input id="txtDBLoginID" type="text" class="cls-txt" placeholder="User login Id" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Password: </label></td>
                                <td class="td-right">
                                    <input id="txtPassword" type="password" class="cls-txt" placeholder="User password" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Database: </label></td>
                                <td class="td-right">
                                    <input id="txtDatabaseName" type="text" class="cls-txt" placeholder="Database Name" />
                                </td>
                            </tr>
                            <tr>
                                <td class="td-left"><label>Query: </label></td>
                                <td class="td-right">
                                    <input id="txtQuery" type="text" class="cls-txt" placeholder="Database Query" />
                                </td>
                            </tr>
                        </table>
                    </fieldset> 
                </td>
            </tr>
        </table>


        <table border="0" style="width:100%;">
            <tr>
                <td>
                    <fieldset>
                        <legend>Assess Permission</legend>
                        <div style="float:left; width:100%; padding-bottom:5px;">
                            <div style="float:left; width:14%; text-align:right;">
                                <label>Employee:</label>
                            </div>
                           <div style="float:left; width:78%; text-align:left;margin-left:3px;">
                                <input type="text" id="txtEmployeeName" style="width:100%" />
                            </div>
                        </div>


                        <table id="tblAttendanceAccessPointEmployee" class="easyui-datagrid" style="width:985px;height:205px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarAAPEmployee">
                            <thead>
                                <tr>
                                    <th field="EmployeeNameCode" width="20%" align="left">Employee Name</th>
                                    <th field="InactiveByName" width="30%" align="left">Inactive By</th>
                                    <th field="InactiveDateInStr" width="15%" align="left">Inactive Date</th>
                                    <th field="ActivityInStr" width="15%" align="left">Status</th>
                                </tr>
                            </thead>
                        </table>
                        <div>
                            <input id="chkRange" type="checkbox" />Range
                            <label id="lblRange1">
                                <input id="txtFrom" type="text" style="width:40px" />&nbsp; To &nbsp;
                            </label>
                            <label id="lblRange2">
                                <input id="txtTo" type="text" style="width:40px" />
                            </label>
                            <label id="lblcount"></label>
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="Next()">Next</a>
                        </div>
                        <div id="toolbarAAPEmployee">
                            <a id="btnAddAAPEmployee" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                            <a id="btnDeleteAAPEmployee" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                            <a id="btnActivityAAPEmployee" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"></a>
                            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" style="float:right" onclick="AAPESearch()">For first 20 employee</a>
                            
                        </div>
                    </fieldset>

                </td>
            </tr>
        </table>

        <fieldset>
            <legend>Action</legend>
            <div style="width:100%; text-align:right;">
                <a id="btnReset" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                <a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Cancel</a>
            </div>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    .td-left {
        width: 18%;
        text-align: right;
    }

    .td-right {
        width: 80%;
        text-align: left;
    }

        .td-right .cls-cbo {
            width: 98.5%;
        }

        .td-right .cls-txt {
            width: 98%;
        }

        .td-right .cls-cbo {
            width: 99%;
        }
</style>
<script type="text/javascript">
    var _sBaseAddress="";
    var _oAAP=null;
    var _nEmployeeId=0;

    var _nLastEmployeeID=0;
    var _bNext = false;
    var _nLoadRecords = 0;
    var _nRowLength = 0;

    $(document).ready(function () {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oAAP =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oDataProviders=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.DataProviders));

        $('#cboDataProvider').icsLoadCombo({
            List: oDataProviders,
            OptionValue: "Value",
            DisplayText: "Text",
            InitialValue: "-----Select Data Provider-----"
        });

        Initialization(oAAP,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'));

        $('#txtLoadRecords').numberbox({min:0, precision:0 });
        $('#txtFrom').numberbox({min:0, precision:0 });
        $('#txtTo').numberbox({min:0, precision:0 });
        $('#txtFrom').numberbox('setValue',1);
        $('#txtTo').numberbox('setValue',20);
        document.getElementById("lblRange1").style.display = 'none';

    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#div').icsWindow('close'); } });


    function Initialization(oAAP,sOperation){
        ResetControl();
        RefreshControl(oAAP);
        if(sOperation=="View"){
            $('input,select,textarea').prop('disabled',true);
            $('#toolbarAAPEmployee').hide();
            $('#btnSave').hide();
        }
    }

    function ResetControl(){
        _oAAP=null;
        $('#chkThisPC').prop('checked',false);
        $('input').val('');
        $('textarea').val('');
        $('select').val(0);

        $('#toolbarAAPEmployee').show();
        DynamicRefreshList([],'tblAttendanceAccessPointEmployee');
        $('#btnSave').show();
    }

    function RefreshControl(oAAP){

        debugger;
        _oAAP=oAAP;
        $('#chkThisPC').prop('checked',oAAP.IsThisPC);
        $('#txtAccessPoint').val(oAAP.Name);
        $('#txtMachineSlNo').val(oAAP.MachineSLNo);
        $('#txtNote').val(oAAP.Note);
        $('#cboDataProvider').val(oAAP.DataProviderInInt);
        $('#txtDataSource').val(oAAP.DataSource);
        $('#txtDBLoginID').val(oAAP.DBLoginID);
        $('#txtPassword').val(oAAP.DBPassword);
        $('#txtDatabaseName').val(oAAP.DBName);
        $('#txtQuery').val(oAAP.Query);
        
        //DynamicRefreshList(oAAP.AAPEs,'tblAttendanceAccessPointEmployee');
    }

    function RefreshObjectAAP(){
        var oAAP = {
            AAPID:(_oAAP!=null && _oAAP.AAPID>0)? _oAAP.AAPID: 0,
            Name: $.trim($('#txtAccessPoint').val()),
            MachineSLNo : $.trim($('#txtMachineSlNo').val()),
            Note : $.trim($('#txtNote').val()),
            DataProvider : $('#cboDataProvider').val(),
            DataSource : $.trim($('#txtDataSource').val()),
            DBLoginID : $.trim($('#txtDBLoginID').val()),
            DBPassword : $.trim($('#txtPassword').val()),
            DBName : $.trim($('#txtDatabaseName').val()),
            Query: $.trim($('#txtQuery').val()),
            IsActive : (_oAAP!=null && _oAAP.AAPID>0)? _oAAP.IsActive: false,
            IsThisPC : $('#chkThisPC').is(':checked')
        };
        return oAAP;
    }

    function RefreshObjectAAPEmployee(){
        var oAAPEmployee = {
            AAPEmployeeID:0,
            AAPID:(_oAAP!=null)? _oAAP.AAPID: 0,
            EmployeeID : _nEmployeeId,
            IsActive : true,
            AAP:(_oAAP==null || _oAAP.AAPID<=0) ? RefreshObjectAAP(): null,
        };
        return oAAPEmployee;
    }



    function Validation(){

        if ($.trim($("#txtAccessPoint").val()) == "") {
            alert("Please enter access point name.");
            $("#txtAccessPoint").addClass("errorFieldBorder");
            $("#txtAccessPoint").focus();
            return false;
        } else {
            $("#txtAccessPoint").removeClass("errorFieldBorder");
        }

        if ($.trim($("#txtMachineSlNo").val()) == "") {
            alert("Please enter machine serial no.");
            $("#txtMachineSlNo").addClass("errorFieldBorder");
            $("#txtMachineSlNo").focus();
            return false;
        } else {
            $("#txtMachineSlNo").removeClass("errorFieldBorder");
        }
        if ($("#cboDataProvider").val() <=0) {
            alert("Please select a data provider.");
            $("#cboDataProvider").addClass("errorFieldBorder");
            $("#cboDataProvider").focus();
            return false;
        } else {
            $("#cboDataProvider").removeClass("errorFieldBorder");
        }
        if ($.trim($("#txtDataSource").val()) == "") {
            alert("Please enter data source.");
            $("#txtDataSource").addClass("errorFieldBorder");
            $("#txtDataSource").focus();
            return false;
        } else {
            $("#txtDataSource").removeClass("errorFieldBorder");
        }
        if ($.trim($("#txtDBLoginID").val()) == "") {
            alert("Please enter login Id.");
            $("#txtDBLoginID").addClass("errorFieldBorder");
            $("#txtDBLoginID").focus();
            return false;
        } else {
            $("#txtDBLoginID").removeClass("errorFieldBorder");
        }
        if ($.trim($("#txtPassword").val()) == "") {
            alert("Please enter password.");
            $("#txtPassword").addClass("errorFieldBorder");
            $("#txtPassword").focus();
            return false;
        } else {
            $("#txtPassword").removeClass("errorFieldBorder");
        }
        if ($.trim($("#txtDatabaseName").val()) == "") {
            alert("Please enter database name.");
            $("#txtDatabaseName").addClass("errorFieldBorder");
            $("#txtDatabaseName").focus();
            return false;
        } else {
            $("#txtDatabaseName").removeClass("errorFieldBorder");
        }
        
        return true;
    }

    function ValidationAAPEmployee(){

        if(_nEmployeeId<=0)
        {
            alert("No valid employee found.");
            $("#txtEmployeeName").addClass("errorFieldBorder");
            $("#txtEmployeeName").focus();
            return false;
        }
        else {
            $("#txtEmployeeName").removeClass("errorFieldBorder");
        }
        return true;
    }


    


    /*---- Access Employee  ----*/
    
    $('#txtEmployeeName').keypress(function(e){

        var keyCode = e.keyCode || e.which;
        if (keyCode == 13){
            if($.trim($('#txtEmployeeName').val())==""){
                alert("Please enter employee name to search"); return false;
            }
            var oEmployee= {
                Params: $.trim($('#txtEmployeeName').val())+'~'+ 0
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oEmployee,
                ControllerName: "Employee",
                ActionName: "GetsByEmpCode",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].EmployeeID > 0) {
                        debugger;
                        var tblColums = [];var oColumn = { field: "Code", title: "Code", width: 60, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "Name", title: "Name", width: 110, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "DepartmentName", title: "Department", width: 120, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "DesignationName", title: "Designation", width: 120, align: "left" };tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winEmployee',
                            winclass:'clsEmployeePickerTextSearch',
                            winwidth: 470,
                            winheight: 460,
                            tableid: 'tblEmployeePicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName:'Name',
                            windowTittle: 'Employee List'
                        };

                        $.icsPicker(oPickerParam);
                        IntializeEmployeePickerTextSearchPickerbutton(oPickerParam);//multiplereturn, winclassName

                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No employee found.");
                }
            });
        }
        if(keyCode==8){
            _nEmployeeId=0;
            $("#txtEmployeeName").val("");
        }

    });

    function IntializeEmployeePickerTextSearchPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {

            var oEmployee = $('#'+oPickerobj.tableid).datagrid('getSelected');
            $("#"+oPickerobj.winid).icsWindow("close");
            $("#" + oPickerobj.winid).remove();
            if (oPickerobj.winid == 'winEmployee')
            {
                if(oEmployee.EmployeeID>0){
                    $('#txtEmployeeName').val(oEmployee.Name);
                    _nEmployeeId=oEmployee.EmployeeID;
                }
            }
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                var oEmployee = $('#'+oPickerobj.tableid).datagrid('getSelected');
                if(oEmployee == null || oEmployee.EmployeeID<=0){  alert("please select an employee."); return false;}

                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                if (oPickerobj.winclass == 'clsEmployeePickerTextSearch')
                {
                    if (oEmployee != null && oEmployee.EmployeeID > 0)
                    {
                        $('#txtEmployeeName').val(oEmployee.Name);
                        _nEmployeeId=oEmployee.EmployeeID;
                    }
                }
            }
        });
    }


    function SaveAAPEmployee(IsClose){
        debugger;
        if(!Validation()) return false;
        if(!ValidationAAPEmployee()) return false;
        var oAAPEmployee = RefreshObjectAAPEmployee();
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oAAPEmployee,
            ObjectId: oAAPEmployee.AAPEmployeeID,
            ControllerName: "AttendanceAccessPoint",
            ActionName: "SaveAAPEmp",
            TableId: "tblAttendanceAccessPointEmployee",
            IsWinClose: false,
            Message:(oAAPEmployee.AAPEmployeeID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.AAP!=null && response.obj.AAP.AAPID>0) {
                    $('#tblAttendanceAccessPoint').datagrid('appendRow',response.obj.AAP);
                    response.obj.AAP.AAPEs = $('#tblAttendanceAccessPointEmployee').datagrid('getRows');
                    RefreshControl(response.obj.AAP);
                    if(IsClose ){
                        ResetControl();
                    }
                }
                if(response.obj.AAPEmployeeID>0){
                    _nEmployeeId=0;
                    $("#txtEmployeeName").val("");
                }
            }
        });
    }

    $('#btnAddAAPEmployee').click(function(e){
        SaveAAPEmployee(false);
    });

    $('#btnDeleteAAPEmployee').click(function(e){

        var oAAPEmployee = $('#tblAttendanceAccessPointEmployee').datagrid('getSelected');
        if (oAAPEmployee == null || oAAPEmployee.AAPEmployeeID <= 0) {
            alert("Please select an item from list");
            return false;
        }
        if (oAAPEmployee.IsActive) {
            alert("Please inactive to delete.");
            return false;
        }
        if (!confirm("Confirm to Delete?")) return;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oAAPEmployee,
            ControllerName: "AttendanceAccessPoint",
            ActionName: "DeleteAAPEmp",
            TableId: "tblAttendanceAccessPointEmployee",
            IsWinClose: false
        };
        $.icsDelete(obj);
    });

    $("#btnActivityAAPEmployee").click(function (e) {

        debugger;
        var oAAPEmployee = $('#tblAttendanceAccessPointEmployee').datagrid('getSelected');

        if (oAAPEmployee == null || oAAPEmployee.AAPEmployeeID <= 0) {
            alert("Please select an item from list.");
            return false;
        }

        if (!confirm((oAAPEmployee.IsActive) ?"Confirm to inactive?":"Confirm to active?")) return;
        var nIndex=$('#tblAttendanceAccessPointEmployee').datagrid('getRowIndex',oAAPEmployee);
        oAAPEmployee.AAP=null;
        var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oAAPEmployee,
                ObjectId: oAAPEmployee.AAPEmployeeID,
                ControllerName: "AttendanceAccessPoint",
                ActionName: "ActivityChangeAAPEmp",
                TableId: "tblAttendanceAccessPointEmployee",
                IsWinClose: false,
                Message: ""
            };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                RowSelect(nIndex,response.obj);
            }
        });

    });



    $('#btnSave').click(function(e){

        debugger;
        if(_oAAP==null || _oAAP.AAPID<=0 || ($('#tblAttendanceAccessPointEmployee').datagrid('getRows')).length<=0){
            alert("Please add employee's contribution first.");
            return false;
        }
        else{
            if (!Validation()) return false;
            var oAAP = RefreshObjectAAP();
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oAAP,
                ObjectId: oAAP.AAPID,
                ControllerName: "AttendanceAccessPoint",
                ActionName: "SaveAAP",
                TableId: "",
                IsWinClose: false,
                Message: (oAAP.AAPID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                debugger;
                if (response.status && response.obj != null) {
                    if (response.obj!=null && response.obj.AAPID>0) {
                        window.location.href = sessionStorage.getItem("BackLink");
                        ResetControl();
                    }
                }
            });
        }
    });

    $('#btnCancel').click(function(e){
        ResetControl();
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $('#btnReset').click(function(e){
        ResetControl();
    });

    $('#chkRange').click(function()
    {
        if(document.getElementById("chkRange").checked == true)
        {
            document.getElementById("lblRange1").style.display = '';
        }
        else
        {
            document.getElementById("lblRange1").style.display = 'none';
        }
    });

    function AAPESearch()
    {
        if(_oAAP.AAPID<=0)
        {
            alert("There is no Attendance Access Point is selected!");
            return;
        }
        if(!_bNext)
        {
            _nRowLength = 0;
            _nLastEmployeeID = 0;
        }

        _nLoadRecords = document.getElementById("txtTo").value;
        if(document.getElementById("chkRange").checked == true)
        {
            var RangeFrom = 0;
            var RangeTo = 0;
            RangeFrom = parseFloat(document.getElementById("txtFrom").value);
            RangeTo = parseFloat(document.getElementById("txtTo").value);

            if(RangeFrom > RangeTo)
            {
                alert("Invalid Range !");
                return;
            }
            _nRowLength = 0;
            _nLoadRecords = 0;

            _nRowLength = RangeFrom-1;
            _nLoadRecords = RangeTo - RangeFrom +1;

        }

        var sParam="";
        sParam=_oAAP.AAPID+"~"+_nRowLength+"~"+_nLoadRecords;

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/AttendanceAccessPoint/AAPESearch",
            traditional: true,
            data:  JSON.stringify({sParam :sParam}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oAAPEs  = jQuery.parseJSON(data);
                if (oAAPEs != null) {
                    if(oAAPEs.length>0 && oAAPEs[0].ErrorMessage=="")
                    {
                        for (var j = 0; j < oAAPEs.length; j++)
                        {
                            $('#tblAttendanceAccessPointEmployee').datagrid('appendRow',oAAPEs[j]);
                        }
                        //DynamicRefreshList(oAAPEs,'tblAttendanceAccessPointEmployee');
                    }
                    else
                    {
                        if(_bNext == false)
                        {
                            alert("Data not found !!");
                            oAAPEs=[];
                            DynamicRefreshList([],'tblAttendanceAccessPointEmployee');
                        }
                        else
                        {
                            alert("No more data found!");
                        }
                    }
                    var oObjs=$('#tblAttendanceAccessPointEmployee').datagrid('getRows');
                    document.getElementById("lblcount").innerHTML = " | Count ="+ oObjs.length;
                    _bNext = false;
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function Next()
    {
        var oAAPEs =[];
        oAAPEs=$('#tblAttendanceAccessPointEmployee').datagrid('getRows');
        _nRowLength = oAAPEs.length;
        _bNext = true;

        if (oAAPEs.length<=0)
        {
            alert('Please Select Criteria and click on "Search" to find information.!!');
            return;
        }
        var oAAPE=oAAPEs[oAAPEs.length-1];

        if (_nLastEmployeeID==oAAPE.EmployeeID)
        {
            alert('No more data found');
            return;
        }
        _nLastEmployeeID=oAAPE.EmployeeID;
        Search();
    }

</script>