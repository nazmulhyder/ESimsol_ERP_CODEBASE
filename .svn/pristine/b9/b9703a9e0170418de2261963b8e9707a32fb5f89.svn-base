<html>
<head>
    @{
        ViewBag.Title = "Fabric Requisition";
    }
</head>
@model ESimSol.BusinessObjects.FabricRequisition
<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>

<body class="menuMainCollectionTable">
    <div class="easyui-layout" style="width:100%; height:490px;">
        <div region="west" split="true" style="width:45%;">
            <fieldset>
                <legend>Requisition Info</legend>
                <table style="width:100%;margin:0 auto;">
                    <tr>
                        <td style="width:20%;text-align:right;">
                            <label>Req. Type : </label>
                        </td>
                        <td style="width:30%;">
                            <select id="cboReqType" disabled="disabled" style="width:100%;height:22px;">
                                <option value="10">SRS</option>
                                <option value="102">SRM</option>
                            </select>
                        </td>
                        <td style="width:20%;text-align:right;">
                            <label>Req. No : </label>
                        </td>
                        <td style="width:30%;">
                            <input id="txtReqNo" type="text" style="width:100%;" disabled />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:20%;text-align:right;">
                            <label>Req. Date : </label>
                        </td>
                        <td style="width:30%;">
                            <input id="txtReqDate" type="text" style="width: 100%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:20%;text-align:right;">
                            <label>Issue Store : </label>
                        </td>
                        <td style="width:30%;">
                            <select id="cboIssueStore" style="width:100%;height:22px;"></select>
                        </td>
                    </tr>
                    <tr>
                       
                        <td style="width:20%;text-align:right;">
                            <label>Note : </label>
                        </td>
                        <td style="width:30%;">
                            <input id="txtNote" type="text" style="width:100%;" />
                        </td>
                        <td style="width:20%;text-align:right;">
                            <label>Rcv Store : </label>
                        </td>
                        <td style="width:30%;">
                            <select id="cboRcvStore" style="width:100%;height:22px;"></select>
                        </td>
                    </tr>
                </table>
            </fieldset>
            <div>
                <table id="tblFabricRequisitionDetail" title="Fabric Requisition Details" style="height:375px;width:100%;" class="easyui-datagrid" fit="false" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" data-options="onClickRow: onClickRow,onEndEdit: onEndEdit" toolbar="#toolbarFTPL" showfooter="true">
                    <thead>
                        <tr>
                            @*<th data-options="field:'Selected',checkbox:true"></th>*@
                            <th field="ExeNo" width="50%">Dispo No</th>
                            <th formatter="formatPrice5digit" data-options="field:'ReqQty',align:'right',editor:{type:'numberbox',options:{precision:5}}">Req. Qty(Y)</th>
                            <th formatter="formatPrice5digit" data-options="field:'ReqQtyM',align:'right',editor:{type:'numberbox',options:{precision:5}}">Req. Qty(M)</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbarFTPL">
                    Dispo : <input type="text" id="txtDispo" placeholder="Search By Dispo No" style="width:130px;" onkeydown="DispoKeyDown(event)" />
                    <input type="button" id="btnDispo" style="width:45px;" onclick="PickDispo()" value="Pick" />
                    <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                </div>
            </div>
        </div>
        <div region="center" style="width:100%;overflow:hidden;">
            <table id="tblFabricRequisitionRoll" title="Fabric Requisition Roll List" style="width:100%;" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" data-options="onClickRow: onClickRowRoll" toolbar="#toolbarFTPLD" showfooter="true">
                @*,onEndEdit: onEndEditRoll*@
                <thead>
                    <tr>
                        <th field="LotNo" width="20%">Roll No</th>
                        <th formatter="formatPrice" width="15%" data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}">Qty</th>
                        <th formatter="formatPriceWithZeroDecimal" width="15%" data-options="field:'RollNo',align:'right',editor:{type:'numberbox',options:{precision:0}}">No Of Rolls</th>
                        <th field="ReceiveDateST" width="15%" align="center">Received Date</th>
                        <th field="ReceiveByName" width="20%">Received By</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarFTPLD">
                <select id="cboRollType" style="width:95px">
                    <option value="2" selected>Grade Wise</option>
                    <option value="1">Roll Wise</option>                   
                </select>
                <input id="txtRollNo" type="text" style="width:160px;" placeholder="Search By Roll No" onkeydown="RollNoKeyDown(event)" />                
                <input type="button" id="btnRollNo" style="width:45px;" onclick="PickRollNo()" value="Pick" />
                <input id="txtDispoNo" type="text" style="width:160px;" placeholder="Search By Dispo No" onkeydown="DispoNoKeyDown(event)" />
                <a id="btnUpdateRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Update</a>
                <a id="btnRemoveRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                @*<a id="btnReceive" href="javascript:void(0)" class="easyui-linkbutton clsReceive" iconcls="icon-receive" plain="true">Receive</a>*@
            </div>
        </div>
    </div>
    <fieldset>
        <legend>Actions</legend>
        <label class="" style="float: left;padding-left:450px;"></label>
        <a id="btnSave" href="javascript:void(0)" style="float:left;" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
        <a id="btnBack" href="javascript:void(0)" style="float:right;" class="easyui-linkbutton" iconcls="icon-back" plain="true">Back</a>
        <a id="btnDisburse" href="javascript:void(0)" style="float:right;" class="easyui-linkbutton" iconcls="icon-disburse" onclick="ChangeStatus('Disburse')" plain="true">Disburse</a>
        <a id="btnReceiveAll" href="javascript:void(0)" style="float:right;" class="easyui-linkbutton" iconcls="icon-receive" plain="true">Receive</a>
    </fieldset>
</body>
</html>
<style type="text/css">
    td, th {
        padding: 2px;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oFabricRequisition = [];
    var TypeList = [];
    var Units = [];
    var _oFabricRequisitionDetails = [];
    var _oIssueStores=[];
    var _oReceiveStores=[];

    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFabricRequisition =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oIssueStores = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.IssueStores));
        _oReceiveStores=  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ReceiveStores));
        $("#cboIssueStore").icsLoadCombo({ List: _oIssueStores,  OptionValue: "WorkingUnitID",  DisplayText: "WorkingUnitName",});
        $("#cboRcvStore").icsLoadCombo({ List: _oReceiveStores,  OptionValue: "WorkingUnitID",  DisplayText: "WorkingUnitName",});
        sessionStorage.setItem("BUID",nBUID);
        RefreshFabricRequisition(_oFabricRequisition);
        $('#btnDisburse,#btnReceiveAll').hide();
        if(sessionStorage.getItem('Action')=='View')
        {
            $('#tblFabricRequisitionDetail').data("GridEditable",false);
            $('#btnSave, #toolbar').hide();
        }
        else if(sessionStorage.getItem('Action')=='Add'){
            if(_oIssueStores.length == 1)
                $("#cboIssueStore").val(_oIssueStores[0].WorkingUnitID);
            if(_oReceiveStores.length == 1)
                $("#cboRcvStore").val(_oReceiveStores[0].WorkingUnitID);
        }
        else if(sessionStorage.getItem('Action')=='Disburse')
        {
            $('#tblFabricRequisitionDetail').data("GridEditable",false);
            $('#btnSave, #toolbar').hide();
            $('#btnDisburse').show();
        }
        else if(sessionStorage.getItem('Action')=='Receive')
        {
            $('#tblFabricRequisitionDetail').data("GridEditable",false);
            $('#btnSave, #toolbar').hide();
            $('#btnReceiveAll').show();
        }

        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();

        //$('#tblFabricRequisitionDetail').datagrid({ onSelect: function (rowIndex, rowData) { OpenAttHistory(rowIndex, rowData); } });
        //function OpenAttHistory(rowIndex, rowData) {
        //    if(rowData.FabricRequisitionDetailID > 0){
        //        GetFabricRequisitionRolls(rowData.FabricRequisitionDetailID);
        //    }else{
        //        $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
        //    }
        //}

        ColShowHide();
        $.icsMakeFooterColumn('tblFabricRequisitionDetail',['ExeNo','ReqQty','ReqQtyM']);
        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
    });

    function GetFabricRequisitionRolls(nFabricRequisitionDetailID){
        debugger;
        var oFabricRequisitionDetail={
            FabricRequisitionDetailID: nFabricRequisitionDetailID,
            RollType : $('#cboRollType').val()
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricRequisition/GetFabricRequisitionRolls",
            traditional: true,
            data:  JSON.stringify(oFabricRequisitionDetail),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oFabricRequisitionRolls = jQuery.parseJSON(data);
                if(oFabricRequisitionRolls.length > 0){
                    if (oFabricRequisitionRolls[0].ErrorMessage==null || oFabricRequisitionRolls[0].ErrorMessage=="") {
                        $('#tblFabricRequisitionRoll').datagrid('loadData',oFabricRequisitionRolls);
                        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                    }
                    else {
                        alert(oFabricRequisitionRolls[0].ErrorMessage);
                        $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
                        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                    }
                }else{
                    $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
                    $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
    function RefreshFabricRequisition(oFabricRequisition)
    {
        debugger;
        $("#cboReqType").val(oFabricRequisition.RequisitionType);
        $("#txtReqNo").val(oFabricRequisition.ReqNo);
        $('#txtReqDate').datebox('setValue', oFabricRequisition.ReqDateInString);
        $("#cboIssueStore").val(oFabricRequisition.IssueStoreID);
        $("#cboRcvStore").val(oFabricRequisition.ReceiveStoreID);
        $("#txtNote").val(oFabricRequisition.Note);

        var data=oFabricRequisition.FabricRequisitionDetails;
        data={"total":""+data.length+"","rows":data};
        $('#tblFabricRequisitionDetail').datagrid('loadData',data);
    }

    var editIndex = undefined;
    var _nQty=0;
    var _nQtyM=0;
    function endEditing() {
        //debugger;
        if (editIndex == undefined) { return true }
        if ($('#tblFabricRequisitionDetail').datagrid('validateRow', editIndex)) {
            $('#tblFabricRequisitionDetail').datagrid('endEdit', editIndex);
            //$('#tblFabricRequisitionDetail').datagrid('selectRow',editIndex);
            //var oFabricRequisitionDetail=$('#tblFabricRequisitionDetail').datagrid('getSelected');

            //_nQty=oFabricRequisitionDetail.ReqQty;
            //_nQtyM=oFabricRequisitionDetail.ReqQtyM;
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {
        debugger;
        if (editIndex != index ) {
        //if (editIndex != index) {
            if (endEditing()) {
                $('#tblFabricRequisitionDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
                var oFabricRequisitionDetail = $('#tblFabricRequisitionDetail').datagrid('getSelected');
                _nQty=oFabricRequisitionDetail.ReqQty;
                _nQtyM=oFabricRequisitionDetail.ReqQtyM;
                if(oFabricRequisitionDetail.FabricRequisitionDetailID > 0){
                    GetFabricRequisitionRolls(oFabricRequisitionDetail.FabricRequisitionDetailID);
                }else{
                    $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
                    $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                }
            }
            else {
                $('#tblFabricRequisitionDetail').datagrid('selectRow', editIndex);
            }
        }
    }

    function onEndEdit(index, row) {
        debugger;
        if(_nQty != row.ReqQty){
            row.ReqQtyM = parseFloat(row.ReqQty) * 0.9144;
        }else if(_nQtyM != row.ReqQtyM){
            row.ReqQty = parseFloat(row.ReqQtyM) * 1.09361;
        }

        $('#tblFabricRequisitionDetail').datagrid('updateRow',{
            index: index,
            row: row
        });
        $.icsMakeFooterColumn('tblFabricRequisitionDetail',['ExeNo','ReqQty','ReqQtyM']);
    }

    var editIndexRoll = undefined;
    function endEditingRoll() {
        //debugger;
        if (editIndexRoll == undefined) { return true }
        if ($('#tblFabricRequisitionRoll').datagrid('validateRow', editIndexRoll)) {
            $('#tblFabricRequisitionRoll').datagrid('endEdit', editIndexRoll);
            //RefreshSummery();
            debugger;
            $('#tblFabricRequisitionRoll').datagrid('selectRow',editIndexRoll);
            var oFabricRequisitionRoll=$('#tblFabricRequisitionRoll').datagrid('getSelected');
            //oFabricRequisitionRoll.Qty = 
            $('#tblFabricRequisitionRoll').datagrid('updateRow', { index: editIndexRoll, row: oFabricRequisitionRoll });
            $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);

            editIndexRoll = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRowRoll(index) {
        //debugger;
        if (editIndexRoll != index && _oFabricRequisition.DisburseBy == 0) {
        //if (editIndexRoll != index) {
            if (endEditingRoll()) {
                $('#tblFabricRequisitionRoll').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndexRoll = index;
            }
            else {
                $('#tblFabricRequisitionRoll').datagrid('selectRow', editIndexRoll);
            }
        }
    }


    function DispoKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtDispo").val();
            if (oTxtName != null) {
                PickDispo(oTxtName);
            }
        }
        if (event.which == 8) {
            txtDispo.style.color="Black";
        }
    }

    function PickDispo(oTxtName)
    {
        debugger;
        var oStyleSearch = {
            //BUID:_oSampleRequest.BUID,
            ExeNo: (typeof(oTxtName) != 'undefined'?oTxtName:"")
        };

        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FabricRequisition",
            ActionName: "GetDispos",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: "ExeNo", title: "Dispo", width: 200, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "RequiredWarpLength", title: "Required Warp Length", width: 150, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "TotalEnds", title: "TotalEnds", width: 150, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('Dispo',obj,tblColums,true,'ExeNo','FEOSID',500); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }

    function RollNoKeyDown(event) {
        //return;
        if (event.which == 13) {
           
            var oTxtName=$("#txtRollNo").val();
            if (oTxtName != null) {
                PickRollNo(oTxtName);
            }
        }
        if (event.which == 8) {
            txtRollNo.style.color="Black";
        }
    }

    function PickRollNo(oTxtName)
    {
        var oFabricRequisitionDetail = $('#tblFabricRequisitionDetail').datagrid('getSelected');
        if(oFabricRequisitionDetail == null){
            alert("Please select a Fabric Requisition Detail!!");
            return;
        }
        if(oFabricRequisitionDetail.FabricRequisitionDetailID <= 0){
            alert("Please save Fabric Requisition!!");
            return;
        }
        if(parseInt($("#cboIssueStore").val()) <= 0){
            alert("Please select Issue Store!!");
            return;
        }
        debugger;
        var oStyleSearch = {
            //BUID:_oSampleRequest.BUID,
            LotNo: (typeof(oTxtName) != 'undefined'?oTxtName:""),
            WUID: $("#cboIssueStore").val(),
            FEOID : oFabricRequisitionDetail.FSCDID,
            RollType : parseInt($("#cboRollType").val())
        };

        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FabricRequisition",
            ActionName: "GetRollNos",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: "LotNo", title: "Roll No", width: 200, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Balance", width: 110, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "MUName", title: "MUName", width: 50, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "WorkingUnitName", title: "Store", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "DispoNo", title: "DispoNo", width: 100, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('RollNo',obj,tblColums,true,'LotNo','LotID',500); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }

    function DispoNoKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtDispoNo").val();
            if (oTxtName == null || oTxtName == "") {
                alert("Enter Dispo No!!");
                return;
            }else{
                PickDispoNo(oTxtName);
            }
        }
        if (event.which == 8) {
            txtDispoNo.style.color="Black";
        }
    }

    function PickDispoNo(oTxtName)
    {
        var oFabricRequisitionDetail = $('#tblFabricRequisitionDetail').datagrid('getSelected');
        if(oFabricRequisitionDetail == null){
            alert("Please select a Fabric Requisition Detail!!");
            return;
        }
        if(oFabricRequisitionDetail.FabricRequisitionDetailID <= 0){
            alert("Please save Fabric Requisition!!");
            return;
        }
        if(parseInt($("#cboIssueStore").val()) <= 0){
            alert("Please select Issue Store!!");
            return;
        }
        debugger;
        var oStyleSearch = {
            WUID: $("#cboIssueStore").val(),
            //FEOID : oFabricRequisitionDetail.FSCDID
            FEONo : (typeof(oTxtName) != 'undefined'?oTxtName:""),
            RollType : parseInt($("#cboRollType").val())
        };

        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FabricRequisition",
            ActionName: "GetRollNos",
            IsWinClose: false
        };

        var tblColums = []; var oColumn = []; var oColumn = { field: "LotNo", title: "Roll No", width: 200, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Balance", width: 110, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "MUName", title: "MUName", width: 30, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "WorkingUnitName", title: "Store", width: 150, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "DispoNo", title: "DispoNo", width: 150, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('RollNo',obj,tblColums,true,'LotNo','LotID',500); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }

    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oResult;
        if (oPickerobj.multiplereturn)
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }
        else
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winDispo')
        {
            //var oDetails = [];
            for(var i=0;i<oResult.length;i++){
                var obj = {
                    FabricRequisitionDetailID : 0,
                    FabricRequisitionID : _oFabricRequisition.FabricRequisitionID,
                    ExeNo : oResult[i].ExeNo,
                    FEOSID : oResult[i].FEOSID,
                    FSCDID : oResult[i].FSCDID,
                    ReqQty : 0,
                    ReqQtyM : 0
                }
                $('#tblFabricRequisitionDetail').datagrid('appendRow',obj);
                //oDetails.push(obj);
            }
            //$('#tblFabricRequisitionDetail').datagrid('loadData',oDetails);
            $.icsMakeFooterColumn('tblFabricRequisitionDetail',['ExeNo','ReqQty','ReqQtyM']);
        }
        else if (oPickerobj.winid == 'winRollNo'){
            var oFabricRequisitionDetail = $('#tblFabricRequisitionDetail').datagrid('getSelected');
            var oDetails=[];
            for(var i=0;i<oResult.length;i++)
            {
                oResult[i].FabricRequisitionDetailID=oFabricRequisitionDetail.FabricRequisitionDetailID;

                //var obj = {
                //    FabricRequisitionRollID : 0,
                //    FabricRequisitionDetailID : oFabricRequisitionDetail.FabricRequisitionDetailID,
                //    LotID : oResult[i].LotID,
                //    LotNo: oResult[i].LotNo,
                //    Qty : oResult[i].Balance
                //}
                ////$('#tblFabricRequisitionRoll').datagrid('appendRow',obj);
                //oDetails.push(obj);
            }
            SaveFabricRequisitionRoll(oResult);
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 90){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    ////
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    /////
    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID,nWidth)
    {
        debugger;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        setInterval(updateProgress,250);

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][pID] > 0) {
                    debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    $("#progressbar").progressbar({ value: 0 });//hide
                    $("#progressbarParent").hide();
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                    $("#progressbar").progressbar({ value: 0 });//hide
                    $("#progressbarParent").hide();
                }
            }
            else{
                alert("Data Not Found.");
                $("#progressbar").progressbar({ value: 0 });//hide
                $("#progressbarParent").hide();
                return;
            }
        });
    }
    ////
    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }


    function Validation(){

        if(parseInt(sessionStorage.getItem("BUID"))<=0)
        {
            alert('No business unit found.');
            return false;
        }

        if($("#txtReqDate").datebox('getValue') == '' || $("#txtReqDate").datebox('getValue') == null){
            alert('Please Enter Request date!!');
            $("#txtReqDate").focus();
            return false;
        }

        if(parseInt($("#cboIssueStore").val())<=0)
        {
            $('#cboIssueStore').focus();
            alert("Please Select Issue Store.");
            return false;
        }
        if(parseInt($("#cboRcvStore").val())<=0)
        {
            $('#cboIssueStore').focus();
            alert("Please Select Receive Store.");
            return false;
        }

        var oRows=$('#tblFabricRequisitionDetail').datagrid('getRows');
        if(oRows.length<=0){
            alert("Atleast onen Fabric Requisition detail required!!");
            return false;
        }

        return true;
    }

    function RefreshObject()
    {
        var oFabricRequisition={
            FabricRequisitionID : _oFabricRequisition.FabricRequisitionID,
            BUID : parseInt(sessionStorage.getItem("BUID")),
            RequisitionType : $("#cboReqType").val(),
            ReqDate:$('#txtReqDate').datebox('getValue'),
            IssueStoreID:$("#cboIssueStore").val(),
            ReceiveStoreID :$("#cboRcvStore").val(),
            Note :$("#txtNote").val(),
            FabricRequisitionDetails: $('#tblFabricRequisitionDetail').datagrid('getRows')
        };

        return oFabricRequisition;
    }

    $("#btnSave").click(function (){
        debugger;
        endEditing();
        if(!Validation()) return false;
        var oFabricRequisition=RefreshObject();
        //return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricRequisition/Save",
            traditional: true,
            data:  JSON.stringify(oFabricRequisition),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oFabricRequisition = jQuery.parseJSON(data);
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (oFabricRequisition.ErrorMessage==null || oFabricRequisition.ErrorMessage=="") {
                    alert("Data Saved successfully");
                    var oFabricRequisitions = sessionStorage.getItem("FabricRequisitions");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oFabricRequisitions != null) {
                        oFabricRequisitions = jQuery.parseJSON(oFabricRequisitions);
                    }
                    else
                    {
                        oFabricRequisitions = [];
                    }
                    if (nIndex != -1)
                    {
                        oFabricRequisitions[nIndex] = oFabricRequisition;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricRequisitions.length);
                        oFabricRequisitions.push(oFabricRequisition);
                    }
                    sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oFabricRequisition.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    function SaveFabricRequisitionRoll(oFabricRequisitionRolls){
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricRequisition/SaveFabricRequisitionRoll",
            traditional: true,
            data:  JSON.stringify(oFabricRequisitionRolls),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oFabricRequisitionRolls = jQuery.parseJSON(data);
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if(oFabricRequisitionRolls.length > 0){
                    if (oFabricRequisitionRolls[0].ErrorMessage==null || oFabricRequisitionRolls[0].ErrorMessage=="") {
                        for(var i= 0; i<oFabricRequisitionRolls.length;i++){
                            $('#tblFabricRequisitionRoll').datagrid('appendRow',oFabricRequisitionRolls[i]);
                            ColShowHide();
                        }
                        alert("Data Saved successfully");
                        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                    }
                    else {
                        alert(oFabricRequisitionRolls[0].ErrorMessage);
                        ColShowHide();
                    }
                }

            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    $("#btnRemoveDetail").click(function ()
    {
        endEditing();
        var oDCDetail=$('#tblFabricRequisitionDetail').datagrid('getSelected');
        if(oDCDetail==null || oDCDetail.ProductID<=0)
        {
            alert("Please select a valid item from list.");
            return;
        }
        var nIndex= $('#tblFabricRequisitionDetail').datagrid('getRowIndex',oDCDetail);
        $('#tblFabricRequisitionDetail').datagrid('deleteRow',nIndex);
        $.icsMakeFooterColumn('tblFabricRequisitionDetail',['ExeNo','ReqQty','ReqQtyM']);
    });

    $("#btnUpdateRoll").click(function(){
        endEditingRoll();
        var oFabricRequisitionRoll= $('#tblFabricRequisitionRoll').datagrid('getSelected');
        if(oFabricRequisitionRoll==null || oFabricRequisitionRoll.FabricRequisitionRollID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }

        if (!confirm("Confirm to Update?")) return ;
        var SelectedRowIndex=$('#tblFabricRequisitionRoll').datagrid('getRowIndex',oFabricRequisitionRoll);
        if (oFabricRequisitionRoll.FabricRequisitionRollID > 0)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/FabricRequisition/SaveRoll",
                traditional: true,
                data:  JSON.stringify(oFabricRequisitionRoll),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //debugger;
                    oFabricRequisitionRoll = jQuery.parseJSON(data);
                    if (oFabricRequisitionRoll.ErrorMessage==null || oFabricRequisitionRoll.ErrorMessage=="") {
                        alert("Updated successfully");
                        $("#tblFabricRequisitionRoll").datagrid("updateRow", { index: SelectedRowIndex, row: oFabricRequisitionRoll });
                        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                    }
                    else {
                        alert(oFabricRequisitionRoll.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }
    });

    $("#btnRemoveRoll").click(function(){
        endEditingRoll();
        var oFabricRequisitionRoll= $('#tblFabricRequisitionRoll').datagrid('getSelected');
        if(oFabricRequisitionRoll==null || oFabricRequisitionRoll.FabricRequisitionRollID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblFabricRequisitionRoll').datagrid('getRowIndex',oFabricRequisitionRoll);
        if (oFabricRequisitionRoll.FabricRequisitionRollID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricRequisition/DeleteFabricRequisitionRoll",
                data: JSON.stringify(oFabricRequisitionRoll),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage.toLowerCase() == "data delete successfully")
                    {
                        alert("Delete sucessfully");
                        $('#tblFabricRequisitionRoll').datagrid('deleteRow',SelectedRowIndex);
                        $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });

    $('#btnBack').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    })

    function ChangeStatus(sAction){
        debugger;
        //var oFabricRequisition= $('#tblFabricRequisitions').datagrid('getSelected');
        if(_oFabricRequisition==null || _oFabricRequisition.FabricRequisitionID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if(sAction == 'Approve'){
            if(_oFabricRequisition.ApprovedBy != 0){
                alert("Already Approve!!");
                return;
            }
        }else if(sAction == 'Disburse'){
            if(_oFabricRequisition.ApprovedBy == 0){
                alert("Please Approve First!!");
                return;
            }
            if(_oFabricRequisition.DisburseBy != 0){
                alert("Already Disbursed!!");
                return;
            }
        }

        if (!confirm("Confirm to "+sAction+"?")) return ;

        _oFabricRequisition.ErrorMessage = sAction;
        if (_oFabricRequisition.FabricRequisitionID > 0)
        {
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            var intervalID = setInterval(updateProgress, 250);
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricRequisition/ChangeStatus",
                data: JSON.stringify(_oFabricRequisition),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricRequisition = jQuery.parseJSON(data);
                    clearInterval(intervalID);
                    $("#progressbarParent").hide();
                    if (oFabricRequisition.ErrorMessage=="" || oFabricRequisition.ErrorMessage == null)
                    {
                        alert(sAction + " sucessfully");
                        var oFabricRequisitions = sessionStorage.getItem("FabricRequisitions");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oFabricRequisitions != null) {
                            oFabricRequisitions = jQuery.parseJSON(oFabricRequisitions);
                        }
                        else
                        {
                            oFabricRequisitions = [];
                        }
                        if (nIndex != -1)
                        {
                            oFabricRequisitions[nIndex] = oFabricRequisition;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oFabricRequisitions.length);
                            oFabricRequisitions.push(oFabricRequisition);
                        }
                        sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
                        window.location.href = sessionStorage.getItem("BackLink");
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    }

    $("#btnReceive").click(function(){
        debugger;
        var oFabricRequisitionRoll = $("#tblFabricRequisitionRoll").datagrid("getSelected");
        if(oFabricRequisitionRoll == null || oFabricRequisitionRoll.FabricRequisitionRollID <= 0)
        {
            alert("Please select an item from list.");
            return false;
        }

        if(oFabricRequisitionRoll.ReceiveBy != 0)
        {
            alert("Already received.");
            return false;
        }
        
        if (!confirm("Confirm to receive?")) return;
        var nRowIndex = $("#tblFabricRequisitionRoll").datagrid("getRowIndex", oFabricRequisitionRoll);

        var sFabricRequisitionRollIDs = oFabricRequisitionRoll.FabricRequisitionRollID;
        var oFRR={
            //FTNID : ((_oFTN == null || _oFTN.FTNID == 0) ? 0 : _oFTN.FTNID),
            //FTPListIDs : sFabricRequisitionRollIDs, //Carry oFabricRequisitionRoll.FabricRequisitionRollID
            //IsFTPLD : true,
            //WUID: $("#cboFinishGoodsStore").val(),
            //FabricRequisitionRollID : oFabricRequisitionRoll.FabricRequisitionRollID
        };
        ReceiveFRR(oFRR,nRowIndex);
    });

    $("#btnReceiveAll").click(function(){
        debugger;
        if(_oFabricRequisition.FabricRequisitionID <= 0)
        {
            alert("Invalid fabric Requisition.");
            return false;
        }
        
        if (!confirm("Confirm to receive?")) return;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: _oFabricRequisition,
            ObjectId: _oFabricRequisition.FabricRequisitionID,
            ControllerName: "FabricRequisition",
            ActionName: "ReceiveFabricRequisition",
            TableId: "",
            IsWinClose: false,
            Message: "Successfully Received."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if($.trim(response.obj.ErrorMessage) == "")
                {
                    var oFabricRequisition=response.obj;
                    alert("Received sucessfully");
                    var oFabricRequisitions = sessionStorage.getItem("FabricRequisitions");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oFabricRequisitions != null) {
                        oFabricRequisitions = jQuery.parseJSON(oFabricRequisitions);
                    }
                    else
                    {
                        oFabricRequisitions = [];
                    }
                    if (nIndex != -1)
                    {
                        oFabricRequisitions[nIndex] = oFabricRequisition;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricRequisitions.length);
                        oFabricRequisitions.push(oFabricRequisition);
                    }
                    sessionStorage.setItem("FabricRequisitions", JSON.stringify(oFabricRequisitions));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
            }
        });
    });

    function ReceiveFRR(oFRR,nRowIndex)
    {
        //var obj = {
        //    BaseAddress: _sBaseAddress,
        //    Object: oFTN,
        //    ObjectId: oFRR.FTNID,
        //    ControllerName: "FabricTransferNote",
        //    ActionName: "ReceiveFTN",
        //    TableId: "",
        //    IsWinClose: false,
        //    Message: "Successfully Received."
        //};
        //$.icsSave(obj, function (response) {
        //    if (response.status && response.obj != null) {
        //        if($.trim(response.obj.ErrorMessage) == "")
        //        {
        //            if(nRowIndex > -1)
        //            {
        //                $("#tblFTPLDetail").datagrid("updateRow", { index: nRowIndex, row: response.obj.FTPLD });
        //            }
        //        }
        //    }
        //});
    }

    //NAZMUL
    $("#cboRollType").change(function(){
        debugger;
        ColShowHide();
        var oFabricRequisitionDetail = $('#tblFabricRequisitionDetail').datagrid('getSelected');
        if(oFabricRequisitionDetail.FabricRequisitionDetailID > 0){
                debugger;
                var oFabricRequisitionDetail={
                    FabricRequisitionDetailID: oFabricRequisitionDetail.FabricRequisitionDetailID,
                    RollType : $('#cboRollType').val()
                }
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+"/FabricRequisition/GetFabricRequisitionRolls",
                    traditional: true,
                    data:  JSON.stringify(oFabricRequisitionDetail),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        //debugger;
                        oFabricRequisitionRolls = jQuery.parseJSON(data);
                        if(oFabricRequisitionRolls.length > 0){
                            if (oFabricRequisitionRolls[0].ErrorMessage==null || oFabricRequisitionRolls[0].ErrorMessage=="") {
                                ColShowHide();
                                $('#tblFabricRequisitionRoll').datagrid('loadData',oFabricRequisitionRolls);
                                $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                            }
                            else {
                                ColShowHide();
                                alert(oFabricRequisitionRolls[0].ErrorMessage);
                                $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
                                $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
                               
                            }
                        }else{
                            ColShowHide();
                            $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
                            $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);

                        }
                    },
                    error: function (xhr, status, error) {
                        ColShowHide();
                        alert(error);
                    }

                });
            
        }else{
            $('#tblFabricRequisitionRoll').datagrid('loadData',[]);
            $.icsMakeFooterColumn('tblFabricRequisitionRoll',['LotNo','Qty','RollNo']);
        }

    });

    function ColShowHide(){
        $('#tblFabricRequisitionRoll').datagrid('hideColumn', 'RollNo');
        var nVal = $('#cboRollType').val();
        if(nVal == 1){
            $('#tblFabricRequisitionRoll').datagrid('hideColumn', 'RollNo');
        }
        if(nVal == 2)
        {
            $('#tblFabricRequisitionRoll').datagrid('showColumn', 'RollNo');
        }
    }
</script>