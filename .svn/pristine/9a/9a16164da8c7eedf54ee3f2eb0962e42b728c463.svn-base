@model ESimSol.BusinessObjects.SP_RatioSetup
@{
    ViewBag.Title = "Ratio Analysis";
}

@*<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>*@
<div id="divRatio" class="easyui-panel" title="Ratio Analysis" style="margin-left: 0px; height:100%; width:100%" fit="true">
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'north',split:true" style="width:100%;height:35px; padding:5px; overflow:hidden">
            <div style="margin-bottom:5px">
                
                <input id="txtStartDate" type="text" class="easyui-datebox" style="width:100px;" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input id="txtEndDate" type="text" class="easyui-datebox" style="width:100px;" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <select id="cboBUs" style="width:200px;"></select>
                <select id="cboRatios" style="width:200px;"></select>
                <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="false">Refresh</a>
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="false">Ratio Analysis</a>
                <a id="btnPrintXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="false">Export To XL</a>
            </div>
        </div>
        <div data-options="region:'center'" style="width:100%;padding:20px; text-align:center;overflow:hidden;">
            <div style="width:100%;height:100%; overflow:hidden;">
                <div style="width:99.5%;height:99.5%; border:1px solid black;overflow:hidden;">
                    <div id="divHeader" style="width:100%;height:15%; overflow:hidden;">
                        <table id="tblHeader" border="0" cellpadding="1" cellspacing="0" style="width:100%;">
                            <tr>
                                <td style="width:100%;font-weight:bold;text-align:center; font-size:16px;"><label id="lblCompanyName">Cross World Ltd.</label></td>
                            </tr>
                            <tr>
                                <td style="width:100%;font-weight:bold;text-align:center; font-size:14px;"><label id="lblReportName">Ratio Analysis</label></td>
                            </tr>
                            <tr>
                                <td style="width:100%;font-weight:bold;text-align:center; font-size:14px;"><label ></label></td>
                            </tr>
                            <tr>
                                <td style="width:100%;font-weight:bold;text-align:center; font-size:14px;text-decoration:underline;"><label id="lblStatementDate">Date Range : 01 Jan 2015 to 31 Jan 2016</label></td>
                            </tr>
                            <tr>
                                <td style="width:100%;font-weight:bold;text-align:center; font-size:14px;"><label></label></td>
                            </tr>
                        </table>
                    </div>
                    <div id="divReport" style="width:100%;height:85%; overflow:auto;">
                    </div>
                </div>
                
            </div>
        </div>        
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        //debugger;
        var oSP_RatioSetup =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        $('#divRatio').data('obj',oSP_RatioSetup);

        var oCompany= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Company));
        sessionStorage.setItem("Company", JSON.stringify(oCompany));

        var oBUs = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUs));

        $('#cboBUs').data('objs',oBUs);
        $('#cboBUs').icsLoadCombo({
            List: oBUs,
            OptionValue: "BusinessUnitID",
            DisplayText: "Name",
            InitialValue : "--Select Business Unit--"
        });
        var oRatios= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Ratios));

        $('#cboRatios').data('objs',oRatios);
        $('#cboRatios').icsLoadCombo({
            List: oRatios,
            OptionValue: "AccountingRatioSetupID",
            DisplayText: "Name",
            InitialValue : "--All Ratios--"
        });

        debugger;
       

        $('#txtStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtEndDate').datebox('setValue', icsdateformat(new Date()));

        ////refresh control
        $('#txtStartDate').datebox('setValue', oSP_RatioSetup.StartDateSt);
        $('#txtEndDate').datebox('setValue', oSP_RatioSetup.EndDateSt);
        $('#cboBUs').val(oSP_RatioSetup.BusinessUnitID);
        $('#cboRatios').val(oSP_RatioSetup.AccountingRatioSetupID);

        $('#lblCompanyName').text(jQuery.parseJSON(sessionStorage.getItem("Company")).Name);
        $('#lblStatementDate').text(RefreshHeader(oSP_RatioSetup));
        /////end refresh control
        RefreshTable(oSP_RatioSetup);
    });
    function RefreshHeader(oSP_RatioSetup){
        var sHeaderText='';


        return sHeaderText='Date Range : "'+ oSP_RatioSetup.StartDateSt+'" to "'+oSP_RatioSetup.EndDateSt+'"';
    }
    function ValidateInput()
    {
        var sStartDate=$('#txtStartDate').datebox('getValue');
        if (sStartDate==null || sStartDate =="") {
            alert("please select start date!");
            $('#txtStartDate').focus();
            return false;
        }

        var sEndDate = $('#txtEndDate').datebox('getValue');
        if ( sEndDate ==null || sEndDate=="") {
            alert("Please select end date!!");
            $('#txtEndDate').focus();
            return false;
        }

        var dStartDate = new Date(sStartDate);
        var dEndDate = new Date(sEndDate);

        if(dEndDate < dStartDate) {
            alert("End date must be grater then start date!!");
            $('#txtEndDate').focus();
            return false;
        }
        return true;
    }
    $("#btnRefresh").click(function(){
        if(!ValidateInput()){return false;}
        var obj={
            AccountingRatioSetupID:parseInt($('#cboRatios').val())?parseInt($('#cboRatios').val()):0,
            BusinessUnitID:parseInt($('#cboBUs').val())?parseInt($('#cboBUs').val()):0,
            StartDate:$('#txtStartDate').datebox('getValue'),
            EndDate:$('#txtEndDate').datebox('getValue')
        };
        sessionStorage.setItem('AnalysisRatioBUID',parseInt($('#cboBUs').val())?parseInt($('#cboBUs').val()):0);
        sessionStorage.setItem('AnalysisRatioEndDate',$('#txtEndDate').datebox('getValue'));
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/IncomeStatement/SetAccountingRatioSetupData",
            traditional: true,
            data:  JSON.stringify(obj),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful") {
                    window.location.href = sessionStorage.getItem('BaseAddress')+ "/AccountingRatioSetup/ViewRatioAnalysis?menuid="+parseInt(sessionStorage.getItem('MenuID'));
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

   
    function RefreshTable(oSP_RatioSetup)
    {
        var oSP_RatioSetups = oSP_RatioSetup.SP_RatioSetups;
        var bIsFistSegment=false;
        var bIsImmediateSegment =false;

        for(var i=0;  i<oSP_RatioSetups.length; i++ )
        {
            var div=document.createElement('div');
            div.setAttribute('id','divRatio'+oSP_RatioSetups[i].AccountingRatioSetupID);
            div.setAttribute('style','width:96.4%;margin:20px;border:1px solid black;overflow:hidden;');


            var table = document.createElement('table');
            table.setAttribute('id','tblRatio'+oSP_RatioSetups[i].AccountingRatioSetupID);
            var sTableID=table.getAttribute('id');
            var nRowIndex = table.rows.length;
            var row = table.insertRow(nRowIndex);


            var cellBlank1 = row.insertCell(0);
            cellBlank1.width= "2%";
            cellBlank1.innerHTML = '';

            var cellAccountHead = row.insertCell(1);
            cellAccountHead.width= "16%";
            cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].Name+' = '+'</label>';
            cellAccountHead.style.textAlign = 'right';
            cellAccountHead.style.verticalAlign ='middle';
            cellAccountHead.rowSpan ='2';


            var cellAccountHead = row.insertCell(2);
            cellAccountHead.width= "25%";
            cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].DivisibleName+'</label>';
            cellAccountHead.style.textAlign = 'center';
            cellAccountHead.style.borderBottom ='1px solid black';

            var cellAccountHead = row.insertCell(3);
            cellAccountHead.width= "5%";
            cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].Separator+'</label>';
            cellAccountHead.style.textAlign = 'center';
            cellAccountHead.rowSpan ='2';

            var cellAmount = row.insertCell(4);
            cellAmount.width= "25%";
            cellAmount.innerHTML = '<label rowIndex="'+nRowIndex+'" onclick="NoteWiseDetails('+oSP_RatioSetups[i].AccountingRatioSetupID+',true);" style="color:#0000FF;cursor:pointer;text-decoration: underline; font-size:13px">'+oSP_RatioSetups[i].DivisibleAmountSt+'</label>';
            cellAmount.style.textAlign = 'center';
            cellAmount.style.borderBottom ='1px solid black';

            if(oSP_RatioSetups[i].RatioFormat===1){//Ratio = 1,

                var cellAccountHead = row.insertCell(5);
                cellAccountHead.width= "30%";
                cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].RatioSt+'</label>';
                cellAccountHead.style.textAlign = 'left';
                cellAccountHead.rowSpan ='2';
            }else if(oSP_RatioSetups[i].RatioFormat===2){//Percentage = 2

                var cellAccountHead = row.insertCell(5);
                cellAccountHead.width= "30%";
                cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].PercentageSt+'</label>';
                cellAccountHead.style.textAlign = 'left';
                cellAccountHead.rowSpan ='2';
            }

            var cellBlank2 = row.insertCell(6);
            cellBlank2.width= "2%";
            cellBlank2.innerHTML = '';

            var nRowIndex = table.rows.length;
            var row = table.insertRow(nRowIndex);


            var cellBlank1 = row.insertCell(0);
            cellBlank1.width= "2%";
            cellBlank1.innerHTML = '';



            var cellAccountHead = row.insertCell(1);
            cellAccountHead.width= "25%";
            cellAccountHead.innerHTML = '<label rowIndex="'+nRowIndex+'" style="font-size:13px;">'+oSP_RatioSetups[i].DividerName+'</label>';
            cellAccountHead.style.textAlign = 'center';
            //cellAccountHead.style.borderBottom ='1px solid black';



            var cellAmount = row.insertCell(2);
            cellAmount.width= "25%";
            cellAmount.innerHTML = '<label rowIndex="'+nRowIndex+'" onclick="NoteWiseDetails('+oSP_RatioSetups[i].AccountingRatioSetupID+',false);" style="color:#0000FF;cursor:pointer;text-decoration: underline; font-size:13px">'+oSP_RatioSetups[i].DividerAmountSt+'</label>';
            cellAmount.style.textAlign = 'center';
            //cellAmount.style.borderBottom ='1px solid black';



            var cellBlank2 = row.insertCell(3);
            cellBlank2.width= "2%";
            cellBlank2.innerHTML = '';

            div.appendChild(table);

            var Report=document.getElementById('divReport');
            Report.appendChild(div);
        }
    }

    function NoteWiseDetails(rasid, bisdivisible)
    {        
        if(parseInt(rasid)<=0)
        {
            alert("Invalid Ratio Analysis!");
            return;
        }
        var buid = parseInt($('#cboBUs').val());                
        var sdt =$('#txtStartDate').datebox('getValue');
        var edt =$('#txtEndDate').datebox('getValue');        
        window.location.href = _sBaseAddress+ "/AccountingRatioSetup/ViewNotesOfRationAnalysis?buid="+buid+"&sdt="+sdt+"&edt="+edt+"&rasid="+parseInt(rasid)+"&bisdivisible="+bisdivisible;
    }

    $("#btnPrint").click(function(){
        var AccountingRatioSetupID=parseInt($('#cboRatios').val())?parseInt($('#cboRatios').val()):0;
        var nBusinessUnitID=parseInt($('#cboBUs').val())?parseInt($('#cboBUs').val()):0;
        var dStartDate = $('#txtStartDate').datebox('getValue');
        var dEndDate = $('#txtEndDate').datebox('getValue');
        var sParam= AccountingRatioSetupID+"~"+dStartDate+"~"+dEndDate+"~"+nBusinessUnitID;
        window.open(sessionStorage.getItem("BaseAddress")+'/AccountingRatioSetup/PrintRatioAnalysis?Params=' + sParam, "_blank");
    });


    $("#btnPrintXL").click(function(){
        var AccountingRatioSetupID=parseInt($('#cboRatios').val())?parseInt($('#cboRatios').val()):0;
        var nBusinessUnitID=parseInt($('#cboBUs').val())?parseInt($('#cboBUs').val()):0;
        var dStartDate = $('#txtStartDate').datebox('getValue');
        var dEndDate = $('#txtEndDate').datebox('getValue');
        var sParam= AccountingRatioSetupID+"~"+dStartDate+"~"+dEndDate+"~"+nBusinessUnitID;
        window.open(sessionStorage.getItem("BaseAddress")+'/AccountingRatioSetup/ExportRatioAnalysisToExcel?Params=' + sParam, "_blank");
    });
</script>
