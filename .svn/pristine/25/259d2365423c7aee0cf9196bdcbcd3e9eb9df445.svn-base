<html>
@{
    ViewBag.Title = "Komm File Entry";
}
<body>
    @model ESimSol.BusinessObjects.KommFile
    <script src="~/Views/VehicleChassis/VehicleChassiss.js"></script>
    <script src="~/Views/VehicleEngine/VehicleEngine.js"></script>
    <div class="menuMainCollectionTable" ng-app="KommFileApp" ng-controller="KommFileController as MLCC" style="height:100%; width:100%; overflow:hidden" id="divKommFile">
        <div style="height:5%; overflow:hidden; padding-left:5px;" class="ui-grid-top-panel">
            <label style="">Komm File Info:</label>
        </div>
        <div style="font-family:Tahoma;text-align:center;height:45%; padding-top:10px" class="regionVR">
                  <div class="col-md-12">
                      <div class="col-md-7 align-left" style="overflow:scroll">
                          <fieldset style="height:250px; border:hidden">
                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">SL No:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="col-md-3">
                                          <input ng-model="KommFile.FileNo" class="form-control" disabled />
                                      </div>
                                      <div class="col-md-3" style="text-align:right;">
                                          <label class="control-label">Issue Date:</label>
                                      </div>
                                      <div class="col-md-3">
                                          <div class="input-group date date-container">
                                              <input type="text" class="form-control" ng-model="KommFile.IssueDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                          </div>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Komm No:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <input type="text" ng-model="KommFile.KommNo" class="form-control" />
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Vehicle Order:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          @*Ref/Engine/Chassis*@
                                          <input type="text" ng-model="KommFile.VehicleOrderRECNo" class="form-control" ng-keydown="SearchKeyDownVehicleOrder($event)" placeholder="Type Ref/Model/Engine/Chassis No & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button style="margin-left:3px; font-weight:bold" type="button" class="btn btn-sm" aria-label="left Align" ng-click="ClearVehicleOrder()"> C </button>
                                              <button style="margin-left:3px" type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickVehicleOrder()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Model No:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.ModelNo" class="form-control" ng-keydown="SearchKeyDownVehicleModel($event)" placeholder="Type Model No & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickVehicleModel()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Chassis No:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.ChassisNo" class="form-control" ng-keydown="SearchKeyDownChassisNo($event)" placeholder="Type Chassis No & Press Enter" />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickNewChassis()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickChassisNo()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Engine No:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.EngineNo" class="form-control" ng-keydown="SearchKeyDownEngineNo($event)" placeholder="Type Engine No & Press Enter" />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickNewEngine()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickEngineNo()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Exterior Color:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.ExteriorColorName" class="form-control" ng-keydown="SearchKeyDownExteriorColor($event)" placeholder="Type Exterior Color Name & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(1)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Interior Color:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.InteriorColorName" class="form-control" ng-keydown="SearchKeyDownInteriorColor($event)" placeholder="Type Interior Color Name & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(2)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Upholstery:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.Upholstery" class="form-control" ng-keydown="SearchKeyDownUpholstery($event)" placeholder="Type Upholstery & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(3)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Trim:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.Trim" class="form-control" ng-keydown="SearchKeyDownTrim($event)" placeholder="Type Code or Name & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickParts(1)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Wheels:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="input-group">
                                          <input ng-model="KommFile.Wheels" class="form-control" ng-keydown="SearchKeyDownWheels($event)" placeholder="Type Code or Name & Press Enter" required />
                                          <span class="input-group-btn">
                                              <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickParts(2)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                          </span>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">E.T.A:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <div class="col-md-3">
                                          <input type="text" ng-model="KommFile.ETAValue" class="form-control" ng-change="ChangeETAType()" />
                                      </div>
                                      <div class="col-md-3">
                                          <select ng-model="KommFile.ETATypeInInt" ng-change="ChangeETAType()" class="form-control" ng-options="oItem.id as oItem.Value for oItem in DisplayParts"></select>
                                      </div>
                                      <div class="col-md-3">
                                          <input ng-model="KommFile.PossibleDateSt" class="form-control" disabled />
                                      </div>
                                  </div>
                              </div>


                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Remarks:</label>
                                  </div>
                                  <div class="col-md-4 text-left">
                                      <input type="text" ng-model="KommFile.Remarks" class="form-control" />
                                  </div>
                                  <div class="col-md-2 align-left">
                                      <label style="margin-left:-5px" class="control-label">Currency:</label>
                                  </div>
                                  <div class="col-md-2 text-left">
                                      <select style="width:230%; margin-left:-35px" ng-model="KommFile.CurrencyID" ng-change="UpdateSign();" class="form-control" ng-options="oItem.CurrencyID as oItem.CurrencyName for oItem in CurrencyList">
                                          <option value="">--Select Currency--</option>
                                      </select>
                                  </div>
                              </div>
                              <div class="col-md-12">
                                  <div class="col-md-4 text-right">
                                      <label class="control-label">Feature Setup:</label>
                                  </div>
                                  <div class="col-md-8 text-left">
                                      <input type="text" ng-model="KommFile.FeatureSetupName" class="form-control" />
                                  </div>
                              </div>
                          </fieldset>
                      </div>
                    <div class="col-md-5">
                          <fieldset style="height:260px;">
                              <legend>Image</legend>
                              <div class="col-md-12">
                                  <img id="imgOrderImage" src="@Url.Action("GetLargeImage", "VehicleOrder", new { id = Model.VehicleOrderID })" alt="Photo" style="width:90%; height:230px; vertical-align:middle; text-align:center;" />
                              </div>
                          </fieldset>
                      </div>
                </div>
        </div>
        @*-----------DIV TOTAL AMOUNT----------------*@
        <div class="row" style="margin-left:-25px; margin-top:20px; width:100%"> 
            <div class="col-md-12">
                <div class="col-md-7" style="width:61%">
                    <div class="ui-grid-panel col-md-12" style="text-align:left; width:106%">
                            <label>Feature:</label><input ng-model="txtFeatureName" placeholder="Type Feature & Press Enter" ng-keydown="SearchKeyFeatureNo($event)" style="width:210px; height:24px;" required />
                            <button type="button" class="btn btn-default btn-xs" aria-label="right Align" ng-click="PickFeature()"><span class="glyphicon glyphicon-ok" aria-hidden="true"> Pick</span></button>
                            <button type="button" class="btn btn-default btn-xs" aria-label="right Align" ng-click="RemoveDetail()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
                            <button type="button" class="btn btn-default btn-xs" aria-label="right Align" ng-click="RefreshDetail()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
                    </div>
                    <div style="height:144px;" class="col-md-12" ui-grid="gridOptionsKommFileDetail" ui-grid-selection ui-grid-edit></div>
                </div>
                <div class="col-md-5 regionVR regionVROT" style="text-align:right; margin-top:-7px; height:156px; font-size:11px; width:39%">
                    <fieldset style="height:112%; width:110%; margin:5px 0 0 10px">
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Option Total:</label>
                            </div>
                            <div class="col-md-8 text-right">
                                <input type="text" ng-model="OptionTotal" class="form-control input-sm text-right" style="height:18px;" disabled />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Unit Price:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <input ng-model="KommFile.UnitPrice" class="form-control number input-sm text-right" style="height:18px" ng-change="SetTotal()" disabled/>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Total Amount:</label>
                            </div>
                            <div class="col-md-8 text-right">
                                <input type="text" ng-model="TotalAmount" class="form-control input-sm text-right" style="height:18px" disabled />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Vat Amount:</label>
                            </div>
                            <div class="col-md-8 text-right">
                                <input type="text" ng-model="KommFile.VatInPercent" class="form-control input-sm  number text-right" style="height:18px" ng-change="SetTotal()"/>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Reg Fee:</label>
                            </div>
                            <div class="col-md-8 text-right">
                                <input type="text" ng-model="KommFile.RegistrationFeePercent" class="form-control input-sm  number text-right" style="height:18px" ng-keyup="SetTotal()" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">OTR Amount:</label>
                            </div>
                            <div class="col-md-8 text-right">
                                <input ng-model="OTRAmount" class="form-control input-sm text-right" style="height:18px" disabled />
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
       
        <div class="row" style="width:100%;">
            <fieldset style="height:60px; margin:10px 0 0 20px" >
                <legend>Action</legend>
                <div class="row col-md-12 text-right">
                    <button type="button" class="btn btn-sm" aria-label="Left Align" ng-hide="btnSave" ng-click="Save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> <label id="lblSave">Save</label></span> </button>
                    <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
                </div>
            </fieldset>
        </div>
   </div>
</body>
</html>
<style type="text/css">
    .regionVR .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionVR .form-control {
        height: 20px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionVR regionVROT .form-control {
        height: 10px;
        padding: 0px 6px;
        font-size: 12px;
    }
    .regionVR .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 3px;
    }

    .regionVR .col-md-7 {
        width: 60%;
        padding-right: 5px;
        padding-left: 5px;
    }
    .regionVR .col-md-5 {
        width: 40%;
        padding-right: 5px;
        padding-left: 5px;
    }

     .regionVR .col-md-4 {
        width: 30%;
        padding-right: 5px;
        padding-left: 5px;
    }
    
    .regionVR .col-md-8 {
        width: 70%;
        padding-right: 5px;
        padding-left: 5px;
    }
 
     .regionVR .col-md-3 {
        width: 33.33%;
        padding-right:3px;
        padding-left:3px;
    }
     
    .regionVR .btn {
        height: 20px;
        padding: 2px 8px;
    }
    .regionVR .glyphicon {
        top:-1px;
    }
    .regionVR .input-group-addon {
        padding: 2px 5px;
    }
    .ui-grid-top-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    } 
    .ui-grid-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    }
</style>
<script type="text/javascript">
    var oKommFile =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oDisplayParts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DisplayParts));
    var oCurrencyList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CurrencyList));
    var oFuelTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FuelTypes));
    var oSessions = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Sessions));
    var nBaseCurrencyID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BaseCurrencyID));

    var oKommFileDetails= oKommFile.KommFileDetails;
    var KommFileApp = angular.module('KommFileApp', ['ngAnimate', 'ui.bootstrap','ui.grid', 'ui.grid.selection', 'ui.grid.edit', 'ui.grid.rowEdit','ui.grid.cellNav', 'ms.service','chassis.service','engine.service']);
    KommFileApp.controller('KommFileController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod,msGridControl, chassisservice, engineservice) {

        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });
        $scope.KommFile=oKommFile;
        $scope.KommFile.BUID=sessionStorage.getItem('BUID');
        if(sessionStorage.getItem("KommFileHeader")=="Copy Komm File")
        {
            $('#lblSave').html('Paste');
            //Reset IDs
            $scope.KommFile.KommFileID = 0;
            for(var i = 0;i<oKommFileDetails.length;i++)
            {
                oKommFileDetails[i].KommFileDetailID = 0;
                oKommFileDetails[i].KommFileID = 0;
            }
        }
        $scope.KommFileDetails=oKommFileDetails;
        $scope.DisplayParts = oDisplayParts;
        $scope.CurrencyList = oCurrencyList;
        $scope.CurrencySymbol="";

        if($scope.KommFile.KommFileID==0)
            $scope.KommFile.CurrencyID= nBaseCurrencyID;

        //$scope.VATPercentage=0;
        //$scope.Offerprice=0;
        //$scope.ExShowroomPriceBC=0;
        $scope.KommFile.VehicleOrderRECNo=$scope.KommFile.RefNo;
        debugger;

        $scope.UpdateSign= function()
        {
            $scope.PriceSymbol="Price";
            $scope.CurrencySymbol="";
            for(var i =0;i<$scope.CurrencyList.length;i++)
            {
                if($scope.CurrencyList[i].CurrencyID==$scope.KommFile.CurrencyID)
                {
                    $scope.PriceSymbol="Price ("+$scope.CurrencyList[i].Symbol+")";
                    $scope.CurrencySymbol=$scope.CurrencyList[i].Symbol;
                }
            }
            $scope.MakeKommFileDetail();
            $scope.SetOptionTotal();
            $scope.SetTotal();
        }

        $scope.MakeKommFileDetail= function()
        {
            var oDetailColumns = [];
            var oColumn = { field: 'FeatureCode', name:'Code', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn ={ field: 'FeatureName', name:'Feature Description', width:'40%',cellClass: 'text-left',enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Remarks', name: 'Remarks', width: '15%', cellClass: 'text-center',enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);
            //oColumn ={ field: 'CurrencyName', name: 'Currency', width: '10%', cellClass: 'text-center',editType: 'dropdown',editableCellTemplate: 'ui-grid/dropdownEditor',editDropdownOptionsArray: $scope.CurrencyList,editDropdownIdLabel:'CurrencyName',editDropdownValueLabel: 'CurrencyName', enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);
            oColumn ={ field: 'Price', name: $scope.PriceSymbol, width: '17%',align:'left',cellClass: 'text-right', cellFilter: 'number: 2', enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);

            $scope.gridOptionsKommFileDetail = {
                showColumnFooter: false,
                multiSelect: false,
                enableRowSelection: true,
                enableSelectAll: false,
                columnDefs:oDetailColumns,
                data:oKommFileDetails,
                onRegisterApi: function (gridApi) {

                    $scope.gridDetailApi = gridApi;
                    gridApi.edit.on.afterCellEdit($scope,
                     function (rowEntity, colDef, newValue, oldValue)
                     {
                         //rowEntity.CurrencyID = $scope.CurrencyList.filter(function(obj){return obj.CurrencyName== rowEntity.CurrencyName;})[0].CurrencyID;
                         $scope.SetOptionTotal();
                         $scope.SetTotal();
                         return rowEntity;
                     });
                }
            };
            $scope.gridOptionsKommFileDetail.data=$scope.KommFileDetails;
        }
        $scope.MakeKommFileDetail();

        $scope.ChangeETAType =  function()
        {
            debugger;
            var dIssueDate = new Date($scope.KommFile.IssueDateInString);
            if($scope.KommFile.ETATypeInInt==1 &&  $scope.KommFile.ETAValue!="" && parseInt($scope.KommFile.ETAValue)>0 )//day
            {

                $scope.KommFile.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.KommFile.ETAValue))));
            }else if($scope.KommFile.ETATypeInInt==2)//week
            {
                $scope.KommFile.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.KommFile.ETAValue * 7))));
            }else if($scope.KommFile.ETATypeInInt==3)//Month
            {
                $scope.KommFile.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.KommFile.ETAValue * 30))));
            }else if($scope.KommFile.ETATypeInInt==4)//Year
            {
                $scope.KommFile.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.KommFile.ETAValue * 365))));
            }
            else if($scope.KommFile.ETATypeInInt==3)//Month
            {
                $scope.KommFile.PossibleDateSt = "";
            }
        }
        $scope.ChangeETAType();

        $scope.SetOptionTotal=function ()
        {
            var oGriddata = $scope.gridOptionsKommFileDetail.data;
            $scope.OptionTotal = 0;
            if(oGriddata.length>0)
            {
                for(var i =0;i<oGriddata.length;i++)
                {
                    $scope.OptionTotal+= parseFloat(oGriddata[i].Price,0);
                    parseFloat($scope.OptionTotal,0);
                }
            }
            $scope.OptionTotal=formatPrice(parseFloat($scope.OptionTotal),0);
            // (parseFloat(icsRemoveComma($scope.TotalComAmount,2),0) >0)? $scope.textdisabled = true :$scope.textdisabled = false;
        }
        $scope.SetTotal = function()
        {
            debugger;
            $scope.TotalAmountInFloat=parseFloat(icsRemoveComma($scope.OptionTotal,2),0)+parseFloat($scope.KommFile.UnitPrice,0);
            $scope.TotalAmount=formatPrice($scope.TotalAmountInFloat)+" ("+$scope.CurrencySymbol+")";
            //$scope.KommFile.VatInPercent=(parseFloat($scope.TotalAmountInFloat)-parseFloat($scope.KommFile.ExShowroomPriceBC))*($scope.KommFile.VATPercentage/100);

            if(isNaN(parseFloat($scope.KommFile.VatInPercent)))$scope.KommFile.VatInPercent=0;

            $scope.OTRAmount= parseFloat($scope.TotalAmountInFloat,0)+parseFloat($scope.KommFile.VatInPercent,0)+parseFloat($scope.KommFile.RegistrationFeePercent,0);
            $scope.OTRAmount=formatPrice($scope.OTRAmount,0)+" ("+$scope.CurrencySymbol+")";
        }
        $scope.SetOptionTotal();
        $scope.SetTotal();

        $scope.GetVehicleOrderDetails= function()
        {
            debugger;
            var oKommFile = {
                KommFileID:$scope.KommFile.VehicleIOrderID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/KommFile/GetKommFileDetailsByOrderID',$.param(oKommFile), config).then(
                                function (response) {
                                    $scope.gridOptionsKommFileDetail.data=[];
                                    result=jQuery.parseJSON(response.data);
                                    $scope.gridOptionsKommFileDetail.data=(result);
                                    $scope.KommFileDetails=result;
                                    $scope.RefreshDetail();
                                    $scope.SetOptionTotal();
                                    $scope.SetTotal();
                                }, function () {
                                    $log.info('GetVehicleOrderDetails Dismissed at: ' + new Date());
                                });
        }
        $scope.PickVehicleOrder= function ()
        {
            debugger;
            var oVehicleModel = {
                RefNo: $.trim($scope.KommFile.VehicleOrderRECNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleOrder/GetsOrderByRefNo',$.param(oVehicleModel), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'RefNo', name: 'Code/Ref No',width: '20%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ModelNo', name: 'Model No',width: '20%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'EngineNo', name: 'Engine No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'ChassisNo', name: 'Chassis No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Order List',
                                searchingbyfieldName:'RefNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.KommFile.VehicleOrderRECNo=result.RefNo;
                                $scope.KommFile.ModelNo=result.ModelNo;
                                $scope.KommFile.RefNo=result.RefNo;
                                $scope.KommFile.VehicleOrderID=result.VehicleOrderID;
                                $scope.KommFile.ModelID=result.VehicleModelID;
                                $scope.KommFile.VehicleIOrderID=result.VehicleOrderID;
                                $scope.KommFile.ChassisNo=result.ChassisNo;
                                $scope.KommFile.EngineNo=result.EngineNo;
                                $scope.KommFile.InteriorColorName=result.InteriorColorName;
                                $scope.KommFile.ExteriorColorName=result.ExteriorColorName;
                                $scope.KommFile.CurrencyID=result.CurrencyID;
                                $scope.KommFile.ETAValueWithTypeInString=result.ETAValueWithTypeInString;
                                $scope.KommFile.PossibleDateInString=result.PossibleDateInString;
                                $scope.KommFile.VATPercentage=result.VATPercentage;
                                $scope.KommFile.ExShowroomPriceBC=result.ExShowroomPriceBC;
                                $scope.KommFile.UnitPrice=result.OfferPrice;
                                $scope.KommFile.Remarks=result.Remarks;
                                $scope.KommFile.FeatureSetupName=result.FeatureSetupName;
                                $scope.KommFile.Upholstery=result.Upholstery;
                                $scope.KommFile.UpholsteryID=result.UpholsteryID;
                                $scope.KommFile.UpholsteryCode=result.UpholsteryCode;
                                $scope.KommFile.Trim=result.Trim;
                                $scope.KommFile.TrimID=result.TrimID;
                                $scope.KommFile.TrimCode=result.TrimCode;
                                $scope.KommFile.Wheels=result.Wheels;
                                $scope.KommFile.WheelsID=result.WheelsID;
                                $scope.KommFile.WheelsCode=result.WheelsCode;
                                // alert(result.VehicleOrderID+" id----image"+result.VehicleOrderImageID);
                                $scope.GetVehicleOrderDetails();
                                GetVehicleImage(result.VehicleOrderImageID,"VehicleOrder");//Get Model Image
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownVehicleOrder = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var RefNo = $.trim($scope.KommFile.VehicleOrderRECNo);
                if(RefNo=="" || RefNo==null)
                {
                    alert("Type Ref/Engine/Chassis No and Press Enter");
                    return;
                }
                $scope.PickVehicleOrder();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.RefNo='';
                $scope.KommFile.VehicleRefID=0;
                // GetVehicleRefImage(0);//Get Model Image
            }
        };
        $scope.ClearVehicleOrder= function ()
        {
            $scope.KommFile.VehicleOrderRECNo="";
            $scope.KommFile.ModelNo="";
            $scope.KommFile.VehicleIOrderID=0;
            $scope.KommFile.ChassisNo="";
            $scope.KommFile.EngineNo="";
            $scope.KommFile.InteriorColorName="";
            $scope.KommFile.ExteriorColorName="";
            $scope.KommFile.CurrencyID="";
            $scope.KommFile.ETAValueWithTypeInString="";
            $scope.KommFile.PossibleDateInString="";
            $scope.KommFile.Remarks="";
            $scope.KommFile.FeatureSetupName="";
            $scope.gridOptionsKommFileDetail.data=[];
        }


        //==========PICKER=============
        $scope.GetModelFeatures= function() //GetOptionalFeature //NotUsed
        {
            debugger;
            var oModelFeature = {
                VehicleModelID:$scope.KommFile.VehicleModelID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModelFeatures',$.param(oModelFeature), config).then(
                                function (response) {
                                    $scope.gridOptionsKommFileDetail.data=[];
                                    result=jQuery.parseJSON(response.data);
                                    $scope.gridOptionsKommFileDetail.data=(result);
                                    $scope.VehicleOrderDetails=result;
                                    alert($scope.VehicleIOrder.VehicleModelID);
                                }, function () {
                                    $log.info('GetVehicleOrderDetails Dismissed at: ' + new Date());
                                });
        }
        $scope.PickVehicleModel= function ()
        {
            debugger;
            var oVehicleModel = {
                ModelNo: $.trim($scope.KommFile.ModelNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModels',$.param(oVehicleModel), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'ModelNo', name: 'ModelNo',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'CategoryName', name: 'CategoryName',width: '40%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Model List',
                                searchingbyfieldName:'ModelNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.KommFile.ModelNo=result.ModelNo;
                                $scope.KommFile.VehicleModelID=result.VehicleModelID;
                                $scope.KommFile.VATPercentage=result.VATPercentage;
                                $scope.KommFile.ExShowroomPriceBC=result.ExShowroomPriceBC;
                                $scope.KommFile.UnitPrice=result.OfferPrice;
                                GetVehicleImage(result.VehicleModelImageID,'VehicleModel');//Get Model Image
                                $scope.SetOptionTotal();
                                $scope.SetTotal();
                                //$scope.GetModelFeatures();
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownVehicleModel = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ModelNo = $.trim($scope.KommFile.ModelNo);
                if(ModelNo=="" || ModelNo==null)
                {
                    alert("Type Model No and Press Enter");
                    return;
                }
                $scope.PickVehicleModel();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.ModelNo='';
                $scope.KommFile.VehicleModelID=0;
                GetVehicleModelImage(0);//Get Model Image
            }
        };
        $scope.PickChassisNo= function ()
        {
            var oVehicleChassis = {
                ChassisNo: $.trim($scope.KommFile.ChassisNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleChassis/SearchByChassisNo',$.param(oVehicleChassis), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FileNo', name: 'File No',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ChassisNo', name: 'ChassisNo',width: '60%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Chassis List',
                                searchingbyfieldName:'ChassisNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.KommFile.ChassisNo=result.ChassisNo;
                                $scope.KommFile.ChassisID=result.VehicleChassisID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownChassisNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ChassisNo = $.trim($scope.KommFile.ChassisNo);
                if(ChassisNo=="" || ChassisNo==null)
                {
                    alert("Type Chassis No and Press Enter");
                    return;
                }
                $scope.PickChassisNo();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.ChassisNo='';
                $scope.KommFile.ChassisID=0;
            }
        };
        $scope.PickEngineNo= function ()
        {
            var oVehicleEngine = {
                EngineNo: $.trim($scope.KommFile.EngineNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleEngine/SearchByEngineNo',$.param(oVehicleEngine), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FileNo', name: 'File No',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'EngineNo', name: 'EngineNo',width: '60%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Engine List',
                                searchingbyfieldName:'EngineNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.KommFile.EngineNo=result.EngineNo;
                                $scope.KommFile.EngineID=result.VehicleEngineID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownEngineNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var EngineNo = $.trim($scope.KommFile.EngineNo);
                if(EngineNo=="" || EngineNo==null)
                {
                    alert("Type Engine No and Press Enter");
                    return;
                }
                $scope.PickEngineNo();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.EngineNo='';
                $scope.KommFile.EngineID=0;
            }
        };
        //Color get
        $scope.PickColorName= function (nColorType)
        {
            var sColorName ="";
            if(nColorType==1)//Exterior
            {
                sColorName =  $.trim($scope.KommFile.ExteriorColorName);
            }else if(nColorType==2)
            {
                sColorName =  $.trim($scope.KommFile.InteriorColorName);
            }else if(nColorType==3)
            {
                sColorName =  $.trim($scope.KommFile.Upholstery);
            }

            var oVehicleColor = {
                ColorName:sColorName,
                ColorType:nColorType
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleColor/SearchColor',$.param(oVehicleColor), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'ColorCode', name: 'Code',width: '35%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ColorName', name: 'Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Color List',
                                searchingbyfieldName:'ColorName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(nColorType==1)//Exterior
                                {
                                    $scope.KommFile.ExteriorColorName = result.ColorName;
                                    $scope.KommFile.ExteriorColorID = result.VehicleColorID;
                                }else if(nColorType==2)
                                {
                                    $scope.KommFile.InteriorColorName = result.ColorName;
                                    $scope.KommFile.InteriorColorID = result.VehicleColorID;
                                }else if(nColorType==3)
                                {
                                    $scope.KommFile.Upholstery = result.ColorName;
                                    $scope.KommFile.UpholsteryID = result.VehicleColorID;
                                }

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownExteriorColor = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ExteriorColorName = $.trim($scope.KommFile.ExteriorColorName);
                if(ExteriorColorName=="" || ExteriorColorName==null)
                {
                    alert("Type Color Name and Press Enter");
                    return;
                }
                $scope.PickColorName(1);//Exterior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.ExteriorColorName = '';
                $scope.KommFile.ExteriorColorID = 0;
            }
        }
        $scope.SearchKeyDownInteriorColor = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var InteriorColorName = $.trim($scope.KommFile.InteriorColorName);
                if(InteriorColorName=="" || InteriorColorName==null)
                {
                    alert("Type Color Name and Press Enter");
                    return;
                }
                $scope.PickColorName(2);//Interior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.InteriorColorName = '';
                $scope.KommFile.InteriorColorID = 0;
            }
        }
        $scope.SearchKeyDownUpholstery = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Upholstery = $.trim($scope.KommFile.Upholstery);
                if(Upholstery=="" || Upholstery==null)
                {
                    alert("Type Upholstery and Press Enter");
                    return;
                }
                $scope.PickColorName(3);//Upholstery
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.Upholstery = '';
                $scope.KommFile.UpholsteryID = 0;
            }
        }

        $scope.PickParts= function (nPartsType)
        {
            var sPartsName ="";
            if(nPartsType==1)//Trim
            {
                sPartsName =  $.trim($scope.KommFile.Trim);
            }else
            {
                sPartsName =  $.trim($scope.KommFile.Wheels);
            }

            var oVehicleParts = {
                PartsName:sPartsName,
                PartsType:nPartsType
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleParts/SearchParts',$.param(oVehicleParts), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'PartsCode', name: 'Code',width: '35%'  };oColumns.push(oColumn);
                            oColumn = { field: 'PartsName', name: 'Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Parts List',
                                searchingbyfieldName:'PartsName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(nPartsType==1)//Exterior
                                {
                                    $scope.KommFile.Trim = result.PartsName;
                                    $scope.KommFile.TrimID = result.VehiclePartsID;
                                }else
                                {
                                    $scope.KommFile.Wheels = result.PartsName;
                                    $scope.KommFile.WheelsID = result.VehiclePartsID;
                                }

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownTrim = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Trim = $.trim($scope.KommFile.Trim);
                if(Trim=="" || Trim==null)
                {
                    alert("Type Trim Name/Code and Press Enter");
                    return;
                }
                $scope.PickParts(1);//Exterior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.Trim = '';
                $scope.KommFile.TrimID = 0;
            }
        }
        $scope.SearchKeyDownWheels = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Wheels = $.trim($scope.KommFile.Wheels);
                if(Wheels=="" || Wheels==null)
                {
                    alert("Type Wheels Name/Code and Press Enter");
                    return;
                }
                $scope.PickParts(2);//Interior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.KommFile.Wheels = '';
                $scope.KommFile.WheelsID = 0;
            }
        }
        //============PICKER ENDS===========

        //========NEW ENGINE + CHASSIS=========
        $scope.PickNewChassis= function()
        {
            debugger;
            var result=null;
            var oVehicleChassis={
                VehicleChassisID: 0
            };

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress + '/VehicleChassis/GetByID', $.param(oVehicleChassis), config).then(
                                function (response) {
                                    debugger;
                                    result=jQuery.parseJSON(response.data);

                                    var modalObj={
                                        modalcontroller:'CCategoryapp',
                                        appcontroller:'VehicleChassisController',
                                        VehicleChassis: result
                                        //BussinessSessions:$scope.BussinessSessions
                                    }
                                    var modalInstance=chassisservice.Instance(modalObj);
                                    modalInstance.result.then(function (result)
                                    {
                                        debugger;
                                        $scope.gridOptions.data = result;
                                        $scope.selectedRowIndex=parseInt(userSession.getData("SelectedRowIndex"));
                                        //$scope.gridOptions.selectRow(selectedRowIndex), true);
                                        //$scope.gridApi.selection.selectRow($scope.gridOptions.data[selectedRowIndex]);
                                        // $scope.gridApi.selection.selectRow($scope.gridOptions.data[$scope.selectedRowIndex]);

                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                }
                            );
        }
        $scope.FuelTypes= oFuelTypes;
        $scope.PickNewEngine= function()
        {
            debugger;
            var result=null;
            var oVehicleEngine={
                VehicleEngineID: 0
            };

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress + '/VehicleEngine/GetByID', $.param(oVehicleEngine), config).then(
                                function (response) {
                                    debugger;
                                    result=jQuery.parseJSON(response.data);

                                    var modalObj={
                                        modalcontroller:'CCategoryapp',
                                        appcontroller:'VehicleEngineController',
                                        VehicleEngine: result,
                                        FuelTypes:  $scope.FuelTypes,
                                        Sessions: oSessions
                                    }
                                    var modalInstance=engineservice.Instance(modalObj);
                                    modalInstance.result.then(function(result)
                                    {
                                        debugger;
                                        $scope.gridOptions.data = result;

                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                }
                            );
        }

        //if(sessionStorage.getItem("KommFileHeader")=="View Vehicle Order")
        //{
        //    $("#divKommFile :input").prop('disabled', true);
        //    $('#btnclose').prop('disabled', false);
        //}
        //======== ENGINE + CHASSIS ENDS=======

        $scope.RefreshDetail = function ()
        {
            debugger;
            $scope.UpdateSign();
            var oList = $scope.gridOptionsKommFileDetail.data;
            $scope.gridOptionsKommFileDetail.data =  oList;
            $scope.SetOptionTotal();
            $scope.SetTotal();
        };
        $scope.PickFeature= function ()
        {
            //debugger;
            //var oKommFile = {
            //    KommFileID:$scope.KommFile.VehicleIOrderID
            //};
            //var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };

            var oModelFeature = {
                VehicleModelID:$scope.KommFile.VehicleModelID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModelFeatures',$.param(oKommFile), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FeatureCode', name: 'Code',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureName', name: 'Name',width: '40%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureTypeST', name: 'Type',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:true,
                                pickertitle:'Feature List',
                                searchingbyfieldName:'FeatureName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(result.length>0)
                                {
                                    for(var i=0;i<result.length;i++)
                                    {
                                        var oKommFileDetails = $scope.gridOptionsKommFileDetail.data;
                                        if(!icsMethod.ICS_IsExist(oKommFileDetails,'FeatureID', result[i].FeatureID))
                                        {
                                            var oKommFileDetail = {
                                                KommFileDetailID:0,
                                                KommFileID:$scope.KommFile.KommFileID,
                                                FeatureID :result[i].FeatureID,
                                                Remarks : '',
                                                CurrencyID:0,
                                                CurrencyName:'-Select Currency-',
                                                FeatureCode:result[i].FeatureCode,
                                                FeatureName :result[i].FeatureName,
                                                Price:result[i].Price
                                            };
                                            $scope.gridOptionsKommFileDetail.data.push(oKommFileDetail);
                                        }
                                    }
                                }
                                $scope.txtFeatureName='';
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.PickFeatureByName= function ()
        {
            var oFeature = {
                FeatureName: $.trim($scope.txtFeatureName)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/KommFile/GetFeaturesByName',$.param(oFeature), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FeatureCode', name: 'Code',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureName', name: 'Name',width: '40%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureTypeST', name: 'Type',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:true,
                                pickertitle:'Feature List',
                                searchingbyfieldName:'FeatureName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(result.length>0)
                                {
                                    for(var i=0;i<result.length;i++)
                                    {
                                        var oKommFileDetails = $scope.gridOptionsKommFileDetail.data;
                                        if(!icsMethod.ICS_IsExist(oKommFileDetails,'FeatureID', result[i].FeatureID))
                                        {
                                            var oKommFileDetail = {
                                                KommFileDetailID:0,
                                                KommFileID:$scope.KommFile.KommFileID,
                                                FeatureID :result[i].FeatureID,
                                                Remarks : '',
                                                CurrencyID:0,
                                                CurrencyName:'-Select Currency-',
                                                FeatureCode:result[i].FeatureCode,
                                                FeatureName :result[i].FeatureName,
                                                Price:0
                                            };
                                            $scope.gridOptionsKommFileDetail.data.push(oKommFileDetail);
                                        }
                                    }
                                    $scope.RefreshDetail();
                                }
                                $scope.txtFeatureName='';
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.SearchKeyFeatureNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtFeatureName = $.trim($scope.txtFeatureName);
                if(txtFeatureName=="" || txtFeatureName==null)
                {
                    alert("Type Sheet No and Press Enter");
                    return;
                }
                $scope.PickFeatureByName();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtFeatureName='';
            }
        };

        $scope.RemoveDetail = function ()
        {
            debugger;
            var oMLCDetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oMLCDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptionsKommFileDetail.data.indexOf(oMLCDetail);
            if (!confirm("Confirm to Delete?")) return ;
            $scope.gridOptionsKommFileDetail.data.splice(SelectedRowIndex,1);
            $scope.RefreshDetail();
        };
        $scope.Save = function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oKommFile= $scope.KommFile;
            oKommFile.ETAType = $scope.KommFile.ETATypeInInt;
            oKommFile.IssueDate = new Date($scope.KommFile.IssueDateInString);
            oKommFile.OrderStatusInInt = 1;//intialize
            oKommFile.KommFileDetails = $scope.gridOptionsKommFileDetail.data;

            //console.log(oKommFile);return;

            $http.post(sessionStorage.getItem('BaseAddress')+'/KommFile/Save',oKommFile).then(
                        function (response)
                        {
                            var oKommFile= jQuery.parseJSON(response.data);
                            if (oKommFile.ErrorMessage=="" || oKommFile.ErrorMessage==null)
                            {
                                debugger;
                                alert("Data Save Successfully!!");
                                var oKommFiles = sessionStorage.getItem("KommFileList");
                                var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                                if (oKommFiles != null) {
                                    oKommFiles = jQuery.parseJSON(oKommFiles);
                                }
                                else {
                                    oKommFiles = [];
                                }
                                if (nIndex != -1) {
                                    oKommFiles[nIndex] = oKommFile;
                                }
                                else {
                                    sessionStorage.setItem("SelectedRowIndex", oKommFiles.length);
                                    oKommFiles.push(oKommFile);
                                }
                                sessionStorage.setItem("KommFiles", JSON.stringify(oKommFiles));
                                window.location.href = sessionStorage.getItem("BackLink");
                            }
                            else
                            {
                                alert(oKommFile.ErrorMessage);
                            }

                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);$scope.MeasurementUnits=[];}
                    );

        };
        $scope.ValidateInput =  function ()
        {
            debugger;
            if($scope.KommFile.KommNo=="" || $scope.KommFile.KommNo==0)
            {
                alert('Please Insert Komm No.');
                return false;
            }
            if(($scope.KommFile.VehicleOrderRECNo=="" || $scope.KommFile.VehicleOrderID==0) && $scope.KommFile.VehicleModelID==0)
            {
                alert('Please Pick Order/Model .');
                return false;
            }

            //if($scope.gridOptionsKommFileDetail.data.length <=0){alert("Please Add Vechicle Order Detail");  return false;}

            return true;
        };

        $scope.RefreshDetail();
        if(sessionStorage.getItem("KommFileHeader")=="View Komm File")
        {
            $("#divKommFile :input").prop('disabled', true);
            $('#btnclose').prop('disabled', false);
        }

        $scope.Close=function ()
        {
            debugger;
            window.location.href = sessionStorage.getItem("BackLink");
        };

        function GetVehicleImage(nVehicleOrderImageID, sController)
        {
            debugger;
            $.ajax({
                cache:true,
                type: "GET",
                url: sessionStorage.getItem('BaseAddress')+'/'+sController+'/GetImageInBase64',     //"@@(Url.Action("GetImageInBase64", "KommFile"))",
                data: "id=" + nVehicleOrderImageID,
                success: function (data) {
                    $('#imgOrderImage').attr('src', "data:image/jpg;base64," + data.base64imgage );
                }
            });
        }

        //if($scope.KommFile.KommFileImageID<=0)
        //    GetVehicleImage($scope.KommFile.VehicleModelImageID, "KommFile");
        //else
        GetVehicleImage($scope.KommFile.KommFileImageID, "KommFile");
    });
</script>