<html>
<head>
    @{
        ViewBag.Title = "Request For LC Letter";
    }
</head>
<body>
    @model ESimSol.BusinessObjects.ImportLCReqByExBill
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div id="MainDiv" class="easyui-panel" title="Request For LC Letter" style="font-family:Tahoma;height:90%">

            <fieldset>
                <legend>Import LC Info</legend>
                <table style="width:100%;">
                    <tr>
                        <td class="align-right" style="width:15%"><strong>PI No : </strong></td>
                        <td style="width:20%">
                            <input type="text" id="txtPINo" style="width:100%;" disabled />
                        </td>
                        <td class="align-right" style="width:15%"><strong>Bank : </strong></td>
                        <td style="width:50%">
                            <input type="text" id="txtBank" style="width:100%;" disabled />
                        </td>
                    </tr>

                </table>
            </fieldset>

            <fieldset>
                <legend>Request For LC Letter Info</legend>
                <table style="width:100%;">
                    <tr>
                        <td class="align-right" style="width:15%"><strong>LC Value : </strong></td>
                        <td style="width:10%">
                            <input type="text" id="txtLCValuePercent" style="width:100%;text-align:right;" disabled />
                        </td>
                        <td style="width:10%">
                            <input type="text" id="txtLCValueAmount" style="width:100%;text-align:right;" disabled />
                        </td>
                        <td class="align-right" style="width:15%"><strong>Date : </strong></td>
                        <td style="width:15%">
                            <input type="text" style="width:100%;" id="txtIssueDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td class="align-right" style="width:15%"><strong>Account No : </strong></td>
                        <td style="width:20%">
                            <select id="cboAccountNo" style="width:100%;height:22px;"></select>
                        </td>
                    </tr>
                    <tr>
                        <td class="align-right" style="width:15%"><strong>From Credit Facility : </strong></td>
                        <td style="width:10%">
                            <input type="text" id="txtFromCreditFacilityPercent" style="width:100%;text-align:right;" />
                        </td>
                        <td style="width:10%">
                            <input type="text" id="txtFromCreditFacilityAmount" style="width:100%;text-align:right;" />
                        </td>
                        <td class="align-right" style="width:15%"><strong>Note : </strong></td>
                        <td colspan="3" style="width:50%">
                            <input type="text" id="txtNote" style="width:100%;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="align-right" style="width:15%"><strong>Cash : </strong></td>
                        <td style="width:10%">
                            <input type="text" id="txtCashPercent" style="width:100%;text-align:right;" />
                        </td>
                        <td style="width:10%">
                            <input type="text" id="txtCashAmount" style="width:100%;text-align:right;" />
                        </td>
                        <td class="align-right" style="width:15%"><strong>Enclosed : </strong></td>
                        <td colspan="3" style="width:50%">
                            <input type="text" id="txtEnclosed" style="width:100%;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="align-right" style="width:15%"><strong>Export Bill : </strong></td>
                        <td style="width:10%">
                            <input type="text" id="txtExportBillPercent" style="width:100%;text-align:right;" />
                        </td>
                        <td style="width:10%">
                            <input type="text" id="txtExportBillAmount" style="width:100%;text-align:right;" />
                        </td>
                        <td class="align-right" style="width:15%"></td>
                        <td colspan="3" style="width:50%">
                        </td>
                    </tr>

                </table>
            </fieldset>
            <table id="tblImportLCReqByExBillDetail" title="Request For LC Letter Details" class="easyui-datagrid" style="height:280px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar">
                <thead>
                    <tr>
                        <th field="ExportLCNo" width="15%" align="left">LC No</th>
                        <th field="LCOpeningDateInString" width="25%" align="left">Opening Date</th>
                        <th field="LDBCNo" width="20%" align="left">Bank Ref No</th>
                        <th field="Amount" width="12%" formatter="formatPrice" align="right">Amount</th>
                        <th field="MaturityDateInString" width="20%" align="right">Maturity Date</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar">
                <input id="txtLDBCNoPick" type="text" style="width: 15%" placeholder="Type LDBC No" />
                <input id="txtExportLCNoPick" type="text" style="width: 15%" placeholder="Type L/C No" />
                <input id="txtBillNoPick" type="text" style="width: 15%" placeholder="Type Bill No" />
                @*<input type="button" id="btnPickExportLC" value="Pick ExportBill(s)" style="width: 120px; font-size: 12px" />*@
                
                <a id="btnPickExportLC" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Pick ExportBill(s)</a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                @*<a id="btnRefreshDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>*@

            </div>
        </div>
        <fieldset style="height:10%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:60%; text-align:right"></td>
                    <td style="width:40%;text-align:right;">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="Close()" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    td, th {
        padding: 2px;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oImportLCReqByExBill = [];
    var _oBankAccounts = [];
    var Units = [];
    var _buid = 0;
    var _oImportLCReqByExBillDetails = [];
    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oImportLCReqByExBill =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oBankAccounts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BankAccounts));
        _buid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.buid));
        sessionStorage.setItem("BUID", _buid);
        LoadCombos();
        RefreshControlLayout();
        if(parseInt(_oImportLCReqByExBill.ImportLCReqByExBillID)>0)
        {
            _oImportLCReqByExBillDetails = _oImportLCReqByExBill.ImportLCReqByExBillDetails;
            RefreshList(_oImportLCReqByExBillDetails);
        }

        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        //$("#MainDiv").data("ContractorID",0);
    });

    $('#txtFromCreditFacilityPercent').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (nAmount * parseFloat($('#txtFromCreditFacilityPercent').val()))/100;
        if(isNaN(nRes)) nRes= 0;
        $('#txtFromCreditFacilityAmount').val(nRes.toFixed(2));
    });
    $('#txtCashPercent').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (nAmount * parseFloat($('#txtCashPercent').val()))/100;
        if(isNaN(nRes)) nRes= 0;
        $('#txtCashAmount').val(nRes.toFixed(2));
    });
    $('#txtExportBillPercent').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (nAmount * parseFloat($('#txtExportBillPercent').val()))/100;
        if(isNaN(nRes)) nRes= 0;
        $('#txtExportBillAmount').val(nRes.toFixed(2));
    });

    $('#txtFromCreditFacilityAmount').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (parseFloat($('#txtFromCreditFacilityAmount').val()) * 100)/nAmount;
        if(isNaN(nRes)) nRes= 0;
        $('#txtFromCreditFacilityPercent').val(nRes.toFixed(2));
    });
    $('#txtCashAmount').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (parseFloat($('#txtCashAmount').val()) * 100)/nAmount;
        if(isNaN(nRes)) nRes= 0;
        $('#txtCashPercent').val(nRes.toFixed(2));
    });
    $('#txtExportBillAmount').keyup(function(e){
        debugger;
        var nAmount = parseFloat($('#txtLCValueAmount').val());
        var nRes = (parseFloat($('#txtExportBillAmount').val()) * 100)/nAmount;
        if(isNaN(nRes)) nRes= 0;
        $('#txtExportBillPercent').val(nRes.toFixed(2));
    });

    function RefreshControlLayout(){
        $("#txtPINo").val(_oImportLCReqByExBill.ImportLC.ImportLCNo);
        $("#txtBank").val(_oImportLCReqByExBill.ImportLC.BankName_Nego);
        $("#txtLCValuePercent").val(100);
        $("#txtLCValueAmount").val(_oImportLCReqByExBill.ImportLC.Amount);

        $('#txtIssueDate').datebox('setValue',_oImportLCReqByExBill.IssueDateInString);
        $("#cboAccountNo").val(_oImportLCReqByExBill.BankAccountID);
        $("#txtNote").val(_oImportLCReqByExBill.Note);
        $("#txtEnclosed").val(_oImportLCReqByExBill.Enclosed);

        $("#txtFromCreditFacilityPercent").val(_oImportLCReqByExBill.MarginSCFP);
        $("#txtFromCreditFacilityAmount").val(_oImportLCReqByExBill.MarginSCF);
        $("#txtCashPercent").val(_oImportLCReqByExBill.MarginCashP);
        $("#txtCashAmount").val(_oImportLCReqByExBill.MarginCash);
        $("#txtExportBillPercent").val(_oImportLCReqByExBill.MarginLienP);
        $("#txtExportBillAmount").val(_oImportLCReqByExBill.MarginLien);
    }

    function LoadCombos(){
        $("#cboAccountNo").icsLoadCombo({ List:_oBankAccounts, OptionValue: "BankAccountID", DisplayText: "AccountName" });
    }

    function RefreshList(oImportLCReqByExBillDetails)
    {
        debugger;
        var data=oImportLCReqByExBillDetails;
        data={"total":""+data.length+"","rows":data};
        $('#tblImportLCReqByExBillDetail').datagrid('loadData',data);
    }

    function Validation(){
        //if(parseInt($("#cboType").val())<=0)
        //{
        //    $('#cboType').focus();
        //    alert("Please Select Type.");
        //    return false;
        //}
        
        var nTotal = parseFloat($("#txtFromCreditFacilityPercent").val()) + parseFloat($("#txtCashPercent").val()) + parseFloat($("#txtExportBillPercent").val());
        if(nTotal != 100){
            alert("Sum of percentage (From Credit Facility, Cash, Export Bill) Should be equal to 100!!");
            return false;
        }

        var oRows=$('#tblImportLCReqByExBillDetail').datagrid('getRows');
        if(oRows.length<=0){
            alert("Atleast one detail required!!");
            return false;
        }

        return true;
    }

    function RefreshObject()
    {
        var oImportLCReqByExBill={
            ImportLCReqByExBillID : _oImportLCReqByExBill.ImportLCReqByExBillID,
            ImportLCID: _oImportLCReqByExBill.ImportLC.ImportLCID,
            AmendmentNo: _oImportLCReqByExBill.ImportLC.AmendmentNo,
            Amount: _oImportLCReqByExBill.ImportLC.Amount,
            IssueDate:$('#txtIssueDate').datebox('getValue'),
            BankAccountID:$("#cboAccountNo").val(),
            Note : $("#txtNote").val(),
            Enclosed : $("#txtEnclosed").val(),

            MarginSCFP: $("#txtFromCreditFacilityPercent").val(),
            MarginSCF: $("#txtFromCreditFacilityAmount").val(),
            MarginCashP: $("#txtCashPercent").val(),
            MarginCash: $("#txtCashAmount").val(),
            MarginLienP: $("#txtExportBillPercent").val(),
            MarginLien: $("#txtExportBillAmount").val(),

            ImportLCReqByExBillDetails: $('#tblImportLCReqByExBillDetail').datagrid('getRows')
        };

        return oImportLCReqByExBill;
    }

    $("#btnSave").click(function (){
        debugger;
        if(!Validation()) return false;
        var oImportLCReqByExBill=RefreshObject();
        //return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        //var intervalID = setInterval(updateProgress, 250);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ImportLC/SaveImportLCReqByExBill",
            traditional: true,
            data:  JSON.stringify(oImportLCReqByExBill),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oImportLCReqByExBill = jQuery.parseJSON(data);
                //clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (oImportLCReqByExBill.ErrorMessage==null || oImportLCReqByExBill.ErrorMessage=="") {
                    alert("Data Saved successfully");
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oImportLCReqByExBill.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $("#btnRemoveDetail").click(function ()
    {
        var oDCDetail=$('#tblImportLCReqByExBillDetail').datagrid('getSelected');
        if(oDCDetail==null)
        {
            alert("Please select a valid item from list.");
            return;
        }
        var nIndex= $('#tblImportLCReqByExBillDetail').datagrid('getRowIndex',oDCDetail);
        $('#tblImportLCReqByExBillDetail').datagrid('deleteRow',nIndex);
    });

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    })

    $('#txtLDBCNoPick').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oExport_LDBP = {
                BankBranchID:0,
                LDBCNo: $.trim($("#txtLDBCNoPick").val()),
                ExportLCNo:"",
                ExportBillNo: "",
                ErrorMessage: "",
                BUID: _buid
            };
            GetsExportBills(oExport_LDBP)
        }

    });
    $('#txtExportLCNoPick').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oExport_LDBP = {
                BankBranchID: 0,
                LDBCNo: "",
                ExportLCNo: $.trim($("#txtExportLCNoPick").val()),
                ExportBillNo: "",
                ErrorMessage: "",
                BUID: _buid
            };
            GetsExportBills(oExport_LDBP)
        }

    });
    $('#txtBillNoPick').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oExport_LDBP = {
                BankBranchID: 0,
                LDBCNo: "",
                ExportLCNo: "",
                ExportBillNo: $.trim($("#txtBillNoPick").val()),
                ErrorMessage: "",
                BUID: _buid
            };
            GetsExportBills(oExport_LDBP)
        }

    });

    $("#btnPickExportLC").click(function () {
        PickExportBills();
    });

    function PickExportBills() {

        var oExport_LDBP = {
            BankBranchID: parseInt($("#cboBankBranch_Nego").val()),
            LDBCNo: "",
            ExportLCNo: "",
            ExportBillNo: "",
            ErrorMessage: "",
            BUID: _buid
        };
        GetsExportBills(oExport_LDBP)
    }

    function GetsExportBills(oExport_LDBP)
    {
        debugger;

        var oExportBills = $('#tblImportLCReqByExBillDetail').datagrid('getRows');
        var sExportBillID = "";
        if (oExportBills != null && oExportBills.length > 0) {
            for (var i = 0; i < oExportBills.length; i++) {
                sExportBillID = oExportBills[i].ExportBillID + "," + sExportBillID;
            }
            sExportBillID = sExportBillID.substring(0, sExportBillID.length - 1);
        }

        oExport_LDBP.ErrorMessage = sExportBillID;


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oExport_LDBP,
            ControllerName: "Export_LDBP",
            ActionName: "GetsExportBills",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        //var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            //clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ExportBillID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ExportBillNo", title: "Bill No", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "LDBCNo", title: "LDBCNo", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ExportLCNo", title: "L/C No", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "AmountSt", title: "Amount", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "MaturityDateSt", title: "MaturityDate", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BankName_Issue", title: "Issue Bank", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "NegoBank", title: "Nego. Bank", width: 100, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winExportBillsPicker',
                        winclass: 'clsExportBillPicker',
                        winwidth: 850,
                        winheight: 460,
                        tableid: 'tblExportBillPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'LDBCNo',
                        windowTittle: 'LDBC No'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else {
                alert("No Bill found.");
            }
        });
    }

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winExportBillsPicker') {
            if (oreturnObjs != null && oreturnObjs.length > 0) {
                ExportBillMapping(oreturnObjs);
            }
            else {
                alert("Please select an Applicant.");
                return false;
            }
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function ExportBillMapping(oExportBills) {
        debugger;
        var bExists = false;
        for (i = 0; i < oExportBills.length; i++) {
            var bExists = IsExist(oExportBills[i].ExportBillID)
            if (!bExists) {

                var oObj = {
                    ImportLCReqByExBillDetailID : 0,
                    ImportLCReqByExBillID : _oImportLCReqByExBill.ImportLCReqByExBillID,
                    ExportBillID : oExportBills[i].ExportBillID,
                    ExportLCID : oExportBills[i].ExportLCID,
                    ExportLCNo : oExportBills[i].ExportLCNo,
                    LCOpeningDate : oExportBills[i].LCOpeningDate,
                    LCOpeningDateInString : oExportBills[i].LCOpeningDatest,
                    LDBCNo : oExportBills[i].LDBCNo,
                    Amount : oExportBills[i].Amount,
                    MaturityDate : oExportBills[i].MaturityDate,
                    MaturityDateInString : oExportBills[i].MaturityDateSt
                }

                $('#tblImportLCReqByExBillDetail').datagrid('appendRow', oObj);
            }
        }
        //endEditing();
        //RefreshTotalSummery_EBillDetail();
    }
    function IsExist(nExportBillID) {
        var oPRDetails = $('#tblImportLCReqByExBillDetail').datagrid('getRows');

        for (var i = 0; i < oPRDetails.length; i++) {
            if (parseInt(oPRDetails[i].ExportBillID) == parseInt(nExportBillID)) {
                return true;
            }
        }

        return false;
    }

</script>