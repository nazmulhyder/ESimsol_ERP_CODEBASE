@model IEnumerable<ESimSol.BusinessObjects.AttendanceDaily>
@{
    ViewBag.Title = "AttendanceDailys";
}

<div style="margin-left:0px; height:550px" class="menuMainCollectionTable">
    <table id="tblAttendanceDaily" title="Daily Absentee List"
            class="easyui-datagrid" style="width:100%;height:500px" fitcolumns="false"
            rownumbers="true" pagination="false" singleselect="true" , autorowheight="false" toolbar="#toolbar"
            data-options="
        rowStyler: function(index,row){
        if (row.InTimeInString == '00:00'){
        return 'background-color:#6293BB;color:#fff;font-weight:bold;';
        }
        }
        ">
        <thead>
            <tr>
                <th field="EmployeeCode" width="120" align="left">Code</th>
                <th field="EmployeeName" width="200" align="left">Name</th>
                <th field="LocationName" width="120" align="left">Location</th>
                <th field="DepartmentName" width="120" align="left">Designation</th>
                <th field="DesignationName" width="120" align="left">Designation</th>
                <th field="WorkingStatusInString" width="120" align="left">Working Status</th>
                @*<th field="InTimeInString" width="60" align="right">InTime</th>
                <th field="OutTimeInString" width="60" align="right">OutTime</th>
                <th field="LateArrivalMinuteSt" width="90" align="right">Late(min)</th>
                <th field="EarlyDepartureMinuteSt" width="100" align="right">Earlyleaving(min)</th>*@
           
            </tr>
        </thead>
    </table>

    <table>
        <tr>
            <td>
                Load <input id="txtLoadRecords" type="text" style="width:70px" />  &nbsp; Records &nbsp; &nbsp;
                <label id="lblcount"></label>
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="Next()">Next</a>
            </td>
            <td>
                &nbsp;&nbsp;&nbsp;<label id="lblSort"></label>
            </td>
        </tr>
    </table>

    <div id="toolbar" style="height:auto;">
        <input id="dtDateFrom" type="text" style="width: 95px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat, parser:icsdateparser" />
        <span id="spDateTo">
            &nbsp; To &nbsp;
            <input id="dtDateTo" type="text" style="width: 95px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat, parser:icsdateparser" />
        </span>

        <input id="txtBusinessUnit_Collection" type="text" style="width:13%;" placeholder="Pick Business Unit" />
        <a id="btnBusinessUnitPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetBusinessUnitPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtLocation_Colection" style="width:13%;" placeholder="Pick Location" type="text" />
        <a id="btnLocationPicker_Colection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetLocationPicker_Colection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtDepartment_Collection" style="width:13%;" type="text" placeholder="Pick Department" />
        <a id="btnDepartmentPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetDepartmentPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtDesignation_Collection" type="text" style="width:13%;" placeholder="Pick Designation" />
        <a id="btnDesignationPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetDesignationPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>
        <br />
        <input id="chkContinuousAbsent" type="checkbox" /> Continuous Absent
        <a id="btnSrc" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true" onclick="Search()">Search</a>
        <label id="lblInfo"></label>
        <select id="cboPrint">
            <option value="0">Location Wise</option>
            <option value="1">Department Wise</option>
        </select>
        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
    </div>

    <div id="winLocationPicker" class="easyui-window winstyle" title="Location Picker" style="width:350px; height:400px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <div class="easyui-panel" style="width:335px;height:300px;overflow:auto">
                <ul id="locationtree" data-options="checkbox:true" singleselect="false"></ul>
            </div>

            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:400px; text-align:right"></td>

                        <td style="width:50px">
                            <a id="btnLocationPickerOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="OkButtonClick()">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnLocationPickerClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <div id="winDepartmentPicker_Collection" class="easyui-window winstyle" title="Department Picker" style="width:350px; height:400px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <div class="easyui-panel" style="width:335px;height:300px;overflow:auto">
                <ul id="departmenttree_Collection" data-options="checkbox:true" singleselect="false"></ul>
            </div>
            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:400px; text-align:right"></td>

                        <td style="width:50px">
                            <a id="btnDepartmentPickerOk_Collection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnDepartmentPickerClose_Collection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<script type="text/javascript">
    var _oAttendanceDailys=[];
    var _sBaseAddress="";
    var _nLastAttendanceID = 0;

    var _sBusinessUnitIds = "";
    var _sLocationID = "";
    var _sDepartmentIds = "";
    var _sDepartmentNames = "";
    var _sDesignationIds = "";
    var _sDesignationNames = "";

    var _nLastEmployeeID = 0;
    var _bNext = false;
    var _nLoadRecords = 0;
    var _nRowLength = 0;

    var _oBusinessUnits=[];

    //var _nDepartmentID =0 ;
    //var _oEmployee = null;
    //var _nEmployeeID = 0;
    //var _sEmployeeIDs = "";
    //var _oEmployees =[];
    //var _nLoadRecords = 0;
    //var _nRowLength = 0;

    //var _bNext = false;
    //var _sDepartmentNames = "";
    //var _sDepartmentIds = "";
    //var _sDesignationNames = "";
    //var _sDesignationIds = "";
    //var _nLocationID=0;

    $(document).ready(function () {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oBusinessUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BusinessUnits));
        $('#txtLoadRecords').numberbox({min:0, precision:0 });
        $('#txtLoadRecords').numberbox('setValue',100);

        $('#dtDateFrom').datebox('setValue', icsdateformat(new Date()));
        $('#dtDateTo').datebox('setValue', icsdateformat(new Date()));
        $('#spDateTo').hide();
        
    });
    
    function Search()
    {
        if(!_bNext)
        {
            _nRowLength = 0;
            _nLastAttendanceID = 0;
        }
        var tsv = ((new Date()).getTime()) / 1000;
        var dtDateFrom=$('#dtDateFrom').datebox('getValue');
        var dtDateTo=$('#dtDateTo').datebox('getValue');
        _nLoadRecords = document.getElementById("txtLoadRecords").value;
        var bContinuousAbsent=$('#chkContinuousAbsent').is(":checked");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/AttendanceDaily/GetsDailyAbsent",
            traditional: true,
            data: JSON.stringify({ dtDateFrom: dtDateFrom ,dtDateTo:dtDateTo,sBusinessUnitIds:_sBusinessUnitIds, sLocationIds:_sLocationID , sDepartmentIds : _sDepartmentIds,sDesignationIds:_sDesignationIds,bContinuousAbsent:bContinuousAbsent,nLoadRecords : _nLoadRecords,nRowLength : _nRowLength, nts : tsv}),
            contentType: "application/json; charset=utf-8",

            success: function (data) {
                var oAttendanceDailys =[];
                var oADs =[];
                oAttendanceDailys = jQuery.parseJSON(data);
                debugger;
                if(oAttendanceDailys.length>0)
                {
                    if(!_bNext)
                    {
                        oADs=[];
                        LoadDailyAttendanceGrid(oADs);
                    }
                    if(!bContinuousAbsent){document.getElementById('lblInfo').innerHTML = 'Absent for '+icsdateformat(new Date(dtDateFrom));}
                    else{document.getElementById('lblInfo').innerHTML = 'Absent from '+icsdateformat(new Date(dtDateFrom))+" To "+icsdateformat(new Date(dtDateTo))};
                    for (var j = 0; j < oAttendanceDailys.length; j++)
                    {
                        $('#tblAttendanceDaily').datagrid('appendRow',oAttendanceDailys[j]);
                    }
                }
                else
                {
                    if(!_bNext)
                    {
                        alert("Data not found by this date!!");
                        oADs=[];
                        LoadDailyAttendanceGrid(oADs);
                    }
                    else
                    {
                        alert("No more data found by this date !");
                    }
                }
                var oEmployees=$('#tblAttendanceDaily').datagrid('getRows');
                document.getElementById("lblcount").innerHTML = " | Count ="+ oEmployees.length;
                _bNext = false;
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function Next()
    {
        var oAttendanceDailys =[];
        oAttendanceDailys=$('#tblAttendanceDaily').datagrid('getRows');
        _nRowLength = oAttendanceDailys.length;
        _bNext = true;
        if (oAttendanceDailys.length<=0)
        {
            alert('Please Select Criteria and click on "Search" to find information.!!');
            return;
        }
        var oAttendanceDaily=oAttendanceDailys[oAttendanceDailys.length-1];

        if (_nLastAttendanceID==oAttendanceDaily.AttendanceID)
        {
            alert('No more data found by this date');
            return;
        }
        _nLastAttendanceID=oAttendanceDaily.AttendanceID;
        Search();
    }

    function LoadDailyAttendanceGrid(oAttendanceDailys)
    {
        data={"total":""+oAttendanceDailys.length+"","rows":oAttendanceDailys};
        $('#tblAttendanceDaily').datagrid('loadData',data);
    }

    //$('#btnPrint').click(function (e)
    //{
    //    var oAtts = $('#tblAttendanceDaily').datagrid('getRows');
    //    if(oAtts.length <= 0)
    //    {
    //        alert("There is nothing to print !");
    //        return;
    //    }
    //    var sAttIDs="";
    //    for(var i=0; i<oAtts.length; i++)
    //    {
    //        sAttIDs+=oAtts[i].AttendanceID+",";
    //    }
    //    sAttIDs=sAttIDs.substring(0,sAttIDs.length-1);
    //    var nAction = 2;
    //    var tsv=((new Date()).getTime())/1000;
    //    window.open(_sBaseAddress+ "/AttendanceDaily/PrintAbsentAttendance?sAttIDs="+sAttIDs+"&nAction="+nAction+"&nts="+tsv, "_blank");
    //});
    $('#btnPrint').click(function (e)
    {
        var nPrintType=$("#cboPrint").val();
        var dtDateFrom=$('#dtDateFrom').datebox('getValue');
        var dtDateTo=$('#dtDateTo').datebox('getValue');
        var bContinuousAbsent=$('#chkContinuousAbsent').is(":checked");
        var tsv = ((new Date()).getTime()) / 1000;

        var sParam= dtDateFrom+"~"+dtDateTo+"~"+ _sBusinessUnitIds+"~"+_sLocationID+"~"+ _sDepartmentIds+"~"+_sDesignationIds+"~"+ bContinuousAbsent;
        var tsv=((new Date()).getTime())/1000;
        var sAction="";
        if(nPrintType==0){sAction="PrintDailyAbsent_LocationWise";}
        if(nPrintType==1){sAction="PrintDailyAbsent_DepartmentWise";}
        window.open(_sBaseAddress+ "/AttendanceDaily/"+sAction+"?sParam="+sParam+"&nts="+tsv, "_blank");
    });

    /*-------------Start Business Unit Picker----------------*/
    $("#btnBusinessUnitPicker_Collection").click(function(e){
        BusinessUnitPicker();
    });

    $("#txtBusinessUnit_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            BusinessUnitPicker();
        }
    });

    function BusinessUnitPicker()
    {
        var oBusinessUnit={
            BusinessUnitID:0
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oBusinessUnit,
            ControllerName: "BusinessUnit",
            ActionName: "GetsBusinessUnitWithPermission",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].BusinessUnitID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 170, align: "left" };tblColums.push(oColumn);

                    var bmultiplereturn=true;

                    var oPickerParam = {
                        winid: 'winBusinessUnit',
                        winclass:'clsBusinessUnit',
                        winwidth: 320,
                        winheight: 400,
                        tableid: 'tblBusinessUnit',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bmultiplereturn,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Business Unit List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeBusinessUnitPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeBusinessUnitPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oBusinessUnits=[];
            oBusinessUnits = $('#'+oPickerobj.tableid).datagrid('getChecked');
            if (oPickerobj.winid == 'winBusinessUnit')
            {
                if(oBusinessUnits!=null && oBusinessUnits.length>0)
                {
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    var sBusinessUnitName = "";
                    for(var i=0; i<oBusinessUnits.length; i++)
                    {
                        sBusinessUnitName+=oBusinessUnits[i].Name+",";
                        _sBusinessUnitIds+=oBusinessUnits[i].BusinessUnitID+",";
                    }

                    sBusinessUnitName=sBusinessUnitName.substring(0,sBusinessUnitName.length-1);
                    _sBusinessUnitIds=_sBusinessUnitIds.substring(0,_sBusinessUnitIds.length-1);
                    $("#txtBusinessUnit_Collection").val(sBusinessUnitName);
                }
                else
                {
                    alert("Please select a Business Unit.");
                }
            }
        });
    }

    $("#btnResetBusinessUnitPicker_Collection").click(function(e){
        $('#txtBusinessUnit_Collection').val("");
        _sBusinessUnitIds="";
    });
    /*-------------End Business Unit Picker----------------*/

    /*-------------Location Picker----------------*/
    $("#btnLocationPicker_Colection").click(function(e){
        $("#winLocationPicker").icsWindow('open');
        var oLocation={LocationID:0,BusinessUnitIDs:_sBusinessUnitIds};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLocation,
            ControllerName: "Location",
            ActionName: "GetsLocationMenuTree",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                if (response.obj.TLocation.id > 0) {
                    $('#locationtree').tree({ data: [response.obj.TLocation] });
                }
            }
        });
    });

    $("#btnLocationPickerOk").click(function(e){
        var oLocations = $('#locationtree').tree('getChecked');
        if(oLocations!=null && oLocations.length>0)
        {
            var LocationName="";
            for(var i=0; i<oLocations.length; i++)
            {
                if(oLocations[i].id !=1)
                {
                    LocationName+=oLocations[i].text+",";
                    _sLocationID+=oLocations[i].id+",";
                }
            }

            LocationName=LocationName.substring(0,LocationName.length-1);
            _sLocationID=_sLocationID.substring(0,_sLocationID.length-1);
            $("#winLocationPicker").icsWindow('close');
            $('#txtLocation_Colection').val(LocationName);
        }
        else
        {
            alert("Please select a location.");
        }
        
    });

    $('#txtLocation_Colection').keypress(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {

            $("#winLocationPicker").icsWindow('open');
            var oLocation={LocationID:0,BusinessUnitIDs:_sBusinessUnitIds};

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oLocation,
                ControllerName: "Location",
                ActionName: "GetsLocationMenuTree",
                IsWinClose: false
            };
            $.icsDataGet(obj, function (response) {

                if (response.status && response.obj!=null) {
                    if (response.obj.TLocation.id > 0) {
                        $('#locationtree').tree({ data: [response.obj.TLocation] });
                    }
                }
            });
        }
    });

    $("#btnLocationPickerClose").click(function(e){
        $("#winLocationPicker").icsWindow('close');
    });

    $("#btnResetLocationPicker_Colection").click(function(e){
        $('#txtLocation_Colection').val("");
        _sLocationID="";
    });

    $("#btnLocationPickerClose").click(function(e){
        $("#winLocationPicker").icsWindow('close');
    });

    /*-------------Department start Picker----------------*/

    $("#btnDepartmentPicker_Collection").click(function(e){
        DepartmentPicker();
    });

    $("#txtDepartment_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            DepartmentPicker();
        }
    });

    function DepartmentPicker()
    {
        $("#winDepartmentPicker_Collection").icsWindow('open');
        var oDepartment={DepartmentID:0,BusinessUnitIDs:_sBusinessUnitIds,LocationIDs:_sLocationID};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDepartment,
            ControllerName: "Department",
            ActionName: "GetsDepartments",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                if (response.obj.id > 0) {
                    $('#departmenttree_Collection').tree({ data: [response.obj] });
                }
            }
        });
    }

    $("#btnDepartmentPickerOk_Collection").click(function(e){
        var oDepartments = $('#departmenttree_Collection').tree('getChecked');
        if(oDepartments!=null && oDepartments.length>0){
            $("#winDepartmentPicker_Collection").icsWindow('close');
            for(var i=0; i<oDepartments.length; i++)
            {
                _sDepartmentNames+=oDepartments[i].text+",";
                _sDepartmentIds+=oDepartments[i].id+",";
            }

            _sDepartmentNames=_sDepartmentNames.substring(0,_sDepartmentNames.length-1);
            _sDepartmentIds=_sDepartmentIds.substring(0,_sDepartmentIds.length-1);
            $("#txtDepartment_Collection").val(_sDepartmentNames);
        }
        else{
            alert("Please select a department.");
        }
    });

    $("#btnResetDepartmentPicker_Collection").click(function(e){
        $('#txtDepartment_Collection').val("");
        _sDepartmentIds="";
        _sDepartmentNames="";
    });

    /*-------------Department end Picker----------------*/

    /*-------------Designation start Picker----------------*/
    $("#btnDesignationPicker_Collection").click(function(e){
        DesignationPicker();
    });

    $("#txtDesignation_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            DesignationPicker();
        }
    });

    function DesignationPicker()
    {
        var oDesignation={
            DesignationID:0,
            Params: _sBusinessUnitIds+'~'+_sLocationID+'~'+ _sDepartmentIds
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDesignation,
            ControllerName: "Designation",
            ActionName: "Gets",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DesignationID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 170, align: "left" };tblColums.push(oColumn);

                    var bmultiplereturn=true;

                    var oPickerParam = {
                        winid: 'winDesignation',
                        winclass:'clsDesignation',
                        winwidth: 320,
                        winheight: 460,
                        tableid: 'tblDesignation',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bmultiplereturn,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Designation List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDesignationPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeDesignationPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oDesignations=[];
            oDesignations = $('#'+oPickerobj.tableid).datagrid('getChecked');
            if (oPickerobj.winid == 'winDesignation')
            {
                if(oDesignations!=null && oDesignations.length>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();

                    for(var i=0; i<oDesignations.length; i++)
                    {
                        _sDesignationNames+=oDesignations[i].Name+",";
                        _sDesignationIds+=oDesignations[i].DesignationID+",";
                    }

                    _sDesignationNames=_sDesignationNames.substring(0,_sDesignationNames.length-1);
                    _sDesignationIds=_sDesignationIds.substring(0,_sDesignationIds.length-1);
                    $("#txtDesignation_Collection").val(_sDesignationNames);
                }
                else{
                    alert("Please select a designation.");
                }
            }
        });
    }

    $("#btnResetDesignationPicker_Collection").click(function(e){
        $('#txtDesignation_Collection').val("");
        _sDesignationIds="";
        _sDesignationNames = "";
    });

    /*-------------Designation end Picker----------------*/
    
    $("#chkContinuousAbsent").click(function(e){
        if ($('#chkContinuousAbsent').is(":checked"))
        {
            $('#spDateTo').show();
        }
        else
        {
            $('#spDateTo').hide();
        }
    });

</script>
