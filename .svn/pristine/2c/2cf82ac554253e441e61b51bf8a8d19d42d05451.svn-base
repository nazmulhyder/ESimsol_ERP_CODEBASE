<html>
<head>
    <title>Delivery Order </title>
</head>
<body>

    @model ESimSol.BusinessObjects.FabricDeliveryOrder
    <div class="menuMainCollectionTable">
        <fieldset>
            <legend style="font-weight:bold"> Order info: </legend>
            <table style="width:100%" cellpadding="2" cellspacing="2">
                <tr>
                    <td style="width: 10%; text-align: right">
                       Order Type
                    </td>
                    <td style="width: 12%; text-align: left">
                        <select style="width: 100%;" id="cboFDOTypes" onchange="ChangeFDOTypes()"></select>
                    </td>
                    <td style="width: 10%; text-align: right">
                        <label>Customer </label>
                    </td>
                    <td  style="width: 25%; text-align: left">
                        <input type="text" id="txtIssueTo" class="reset-text" style="width: 84%;" placeholder=" search issue to" />
                        <a id="btnPickIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                    <td style="width: 10%; text-align: right">
                        <label>Buying House </label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input type="text" id="txtBuyer" class="reset-text" style="width: 84%;" placeholder=" search issue to" />
                        <a id="btnPickBuyer" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                </tr>
            </table>

        </fieldset>
        <fieldset>
            <legend style="font-weight:bold"> Delivery Order entry: </legend>
            <table cellpadding="2" cellspacing="2" style="width:100%">
                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Deliver To</label>
                    </td>
                    <td style="width: 30%; text-align: left">
                        <select style="width: 100%;" id="cboDeliverTo"></select>
                    </td>
                    <td style="width: 12%; text-align: right">
                        <label>Concern Person:</label>
                    </td>
                    <td style="width: 18%; text-align: left">
                        <select style="width:80%;" id="cboConcernPerson"></select>
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" id="btnReloadCon"></a>
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>DO No</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input type="text" id="txtDONo" style="width: 90%;" class="reset-text" placeholder="Auto Generated" disabled="disabled" />
                    </td>
                </tr>
                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Delivery Point</label>
                    </td>
                    <td colspan="3" style="width: 60%; text-align: left">
                        <input type="text" id="txtDeliverPoint" style="width: 100%;" class="reset-text" />

                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>DO Date</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtDODate" type="text" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>
                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Remarks :</label>
                    </td>
                    <td colspan="3" style="width: 60%; text-align: left">
                        <input type="text" id="txtNote" style="width: 100%;" class="reset-text" />

                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Delivery Date</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtDeliveryDate" type="text" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>

            </table>
        </fieldset>

        <fieldset>
            <legend>Delivery Order Detail</legend>
            <div style="width:100%;">
                <table id="tblFabricDeliveryOrderDetail" class="easyui-datagrid" style="width:100%;height:250px;"
                       data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbar',onClickRow:onClickRow ">

                    <thead>
                        <tr>
                            
                            <th field="FEONo" width="12%" align="left">PO No</th>
                            <th field="FabricNo" width="10%" align="left">Mkt Ref No</th>
                            <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">Qty(Y)</th>
                            <th data-options="field:'Qty_Meter',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">Qty(M)</th>
                            <th field="Qty_DC" width="8%" align="right" formatter="formatPrice">Challan Qty</th>
                            <th field="Qty_RC" width="8%" align="right" formatter="formatPrice">Return Qty</th>
                            <th field="Construction" width="12%" align="left">Construction</th>
                            @*<th field="MUName" width="20%" align="left">Unit</th>*@
                            <th field="ExeNo" width="10%" align="left">Dispo No</th>
                            <th field="PINo" width="15%" align="left">P/I No</th>
                            <th field="ColorInfo" width="12%" align="left">ColorInfo</th>
                            <th field="StyleNo" width="12%" align="left">StyleNo</th>
                            <th field="BuyerRef" width="12%" align="left">BuyerRef</th>
                            <th data-options="field:'UnitPrice',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">U/P</th>
                            <th field="DOPriceTypeSt" width="10%" align="left">Yarn</th>
                            
                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <select style="width: 80px;" id="cboGoodType">
                        <option value="0">General</option>
                        <option value="1">From Excess</option>
                    </select>
                    <input id="txtExportPINo" style="width: 10%" class="reset-text" placeholder="Search by PI No" />
                    <a id="btnPickExportPI" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    <input id="txtExportLCNo" style="width: 10%" class="reset-text" placeholder="Search by LC No" />
                    <a id="btnPickExportLCNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                   
                    <input id="txtPONo" style="width: 10%" class="reset-text" placeholder="Search by PO No" />
                    <a id="btnPickPOList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Pick PO</a>
                    <input id="txtDispoNo" style="width: 10%" class="reset-text" placeholder="Search by Dispo No" />
                    <a id="btnPickDispo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>

                    <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    <a id="btnCopyDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="CopyDetail()" plain="true">Cut Piece</a>
                    <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                </div>
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                        <td style="width:50%;  text-align:right;font-weight:bold;">Total:</td>
                        <td style="width:10%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label> </td>
                        <td style="width:40%;  text-align:right;font-weight:bold;"> </td>

                    </tr>
                </table>
            </div>
        </fieldset>

        <fieldset>
            <legend>Action</legend>
            <div class="align-right">
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                    <tr>
                        <td style=" float:left;  width:10%; ">
                            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
                        </td>
                        <td style=" float:left;  width:40%; ">
                        </td>
                        <td style="width:50%;float:right; text-align:right">
                            <label id="lblCreateReviseNo">Create Revise No?</label> <input id="chkIsCreateReviseNo" type="checkbox" checked="checked" />
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnSave_Revise" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save(Revise)</a>
                            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Approve</a>
                            <a id="btnChecked" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Checked</a>
                            <a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Cancel</a>
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>

                </table>

            </div>

        </fieldset>
    </div>

</body>
</html>

<style type="text/css">
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oFabricDeliveryOrder=null;
    var _nMktAccountID=0;
    var _nContractorID=0;
    var _nDeliveryToID=0;
    var _nProductID=0;
    var _nExportSCDetailID=0;
    var _bIsIssueTo=true;
    var _oCPIssueTos=[];
    var _oCPDeliveryTos=[];
    var _oIsAdd=false;
    var _nFabricDeliveryOrderDetailID=0;
    var _nExportPIID=0;
    var _nSelectedRowIndex=0;
    var _oFDODetails=[];
    var _nBUID = 0;
    var _sBackLink="";
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFabricDeliveryOrder =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oFDODetails =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDODetails));
        var oFDOTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDOTypes));
        var oFDONotes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDONotes));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        @*_oCPIssueTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPIssueTos));
        _oCPDeliveryTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPDeliveryTos));*@
        var oMeasurementUnitCon =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MeasurementUnitCon));
        debugger;
        $("#cboFDOTypes").icsLoadCombo({
            List: oFDOTypes,
            OptionValue: "FDOTypeInt",
            DisplayText: "FDOName",

        });

        Initialization(_oFabricDeliveryOrder,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'));
        _sBackLink=sessionStorage.getItem("BackLink");

    });


    function Initialization(oFabricDeliveryOrder, sOperation){
        ResetControll();

        debugger;
        var oContractors=[];
        var oContractor={ContractorID:oFabricDeliveryOrder.ContractorID,DeliveryToName:oFabricDeliveryOrder.DeliveryToName}
        oContractors.push(oContractor);
        if(oFabricDeliveryOrder.IssueToID>0 && oFabricDeliveryOrder.ContractorID!=oFabricDeliveryOrder.IssueToID)
        {
            oContractor={ContractorID:oFabricDeliveryOrder.IssueToID,DeliveryToName:oFabricDeliveryOrder.ContractorName}
            oContractors.push(oContractor);
        }
        if(oFabricDeliveryOrder.BuyerID>0 && oFabricDeliveryOrder.BuyerID!=oFabricDeliveryOrder.ContractorID)
        {
            oContractor={ContractorID:oFabricDeliveryOrder.BuyerID,DeliveryToName:oFabricDeliveryOrder.BuyerName}
            oContractors.push(oContractor);
        }
        $("#cboDeliverTo").icsLoadCombo({
            List: oContractors,
            OptionValue: "ContractorID",
            DisplayText: "DeliveryToName",
        });
        var oCPers=[];
        if(oFabricDeliveryOrder.BCPID>0)
        {
            var oCPer={ContactPersonnelID:oFabricDeliveryOrder.BCPID,Name:oFabricDeliveryOrder.BuyerCPName}
            oCPers.push(oCPer);
        }
        $("#cboConcernPerson").icsLoadCombo({
            List: oCPers,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name"
        });

        RefreshControl(oFabricDeliveryOrder);

     

        $("#chkIsCreateReviseNo").hide();
        $("#lblCreateReviseNo").hide();

        if(sOperation=="View")
        {
            $('#toolbar,#btnApprove,#btnChecked,#btnSave,#btnCancel,#btnSave_Revise,.ics-pick').hide();
            $('input,select').not('#txtDONo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else  if(sOperation=="Revise")
        {
            $('#btnSave,#btnApprove,#btnChecked,#btnCancel').hide();
            $('#btnSave_Revise').show();
            $("#chkIsCreateReviseNo").show();
            $("#lblCreateReviseNo").show();
            $('input,select').not('#txtDONo').prop('disabled',false);
            $('#txtDODate').datebox('setValue', icsdateformat(new Date()));

        }
        else  if(sOperation=="Cancel")
        {
            $('#btnSave,#btnApprove,#btnChecked,#btnSave_Revise').hide();
            $('#btnCancel').show();
            $('input,select').not('#txtDONo').prop('disabled',false);
        }
        else if(sOperation=="Approve")
        {
            $('#toolbar,#btnSave,#btnChecked,#btnSave_Revise,#btnCancel,.ics-pick').hide();
            $('#btnApprove').show();
            $('input,select').not('#txtDONo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else if(sOperation=="Checked")
        {
            $('#toolbar,#btnSave,#btnApprove,#btnSave_Revise,#btnCancel,.ics-pick').hide();
            $('#btnChecked').show();
            $('input,select').not('#txtDONo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('#btnApprove,#btnChecked,#btnSave_Revise,#btnCancel').hide();
            $('input,select').not('#txtFabricDeliveryOrderNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
       
    }


    function LoadIssueContactPersonnel(oCPs){
        $("#cboConcernPerson").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }



    function ResetControll(){
        _oFabricDeliveryOrder=null;

        $('.reset-text').val("");
        $('#dtOrderDate,#dtSeekingDate').datebox('setValue', icsdateformat(new Date()));
        LoadIssueContactPersonnel(_oCPIssueTos);
        //LoadDeliveredContactPersonnel(_oCPDeliveryTos);
        //$('.number').val("0.00");
        ResetDetail();
        DynamicRefreshList([], 'tblFabricDeliveryOrderDetail');
        RefreshSummary();
    }

    
    function RefreshControl(oFabricDeliveryOrder){
        debugger;
        _oFabricDeliveryOrder=oFabricDeliveryOrder;
        _nDeliveryToID=oFabricDeliveryOrder.ContractorID;//

        $('#txtIssueTo').val(oFabricDeliveryOrder.ContractorName);
        $('#txtDeliverTo').val(oFabricDeliveryOrder.DeliveryToName);
        $('#txtBuyer').val(oFabricDeliveryOrder.BuyerName);
     
        $("#cboDeliverTo").val(parseInt(oFabricDeliveryOrder.ContractorID));
        $('#txtDONo').val(oFabricDeliveryOrder.DONo);
        $('#txtDODate').datebox('setValue',oFabricDeliveryOrder.DODateSt);
        $('#txtDeliveryDate').datebox('setValue',oFabricDeliveryOrder.ExpDeliveryDateSt);
        $("#cboConcernPerson").val(oFabricDeliveryOrder.BCPID),
        //$('#txtDeliverPoint').val(oFabricDeliveryOrder.DeliveryPoint);
        //$('#txtNote').val(oFabricDeliveryOrder.Note);
        ChangeFDOTypes();
        $('#cboFDOTypes').val(oFabricDeliveryOrder.FDOTypeInInt);
        //$('#txtExportPINo').val(oFabricDeliveryOrder.OrderNo);
        //$('#txtExportLCNo').val(oFabricDeliveryOrder.ExportLCNo);

        if(_oFDODetails!==null && _oFDODetails.length>0)
        {
            DynamicRefreshList(_oFDODetails, 'tblFabricDeliveryOrderDetail');
        }
        else{
            DynamicRefreshList([], 'tblFabricDeliveryOrderDetail');
        }
        RefreshSummary();
    }

    function ChangeFDOTypes()
    {
        debugger;
        //var ocboFDOTypes = document.getElementById("cboFDOTypes");
        //var sText = ocboFDOTypes.options[ocboFDOTypes.selectedIndex].text;
        var ncboFDOTypes=parseInt($("#cboFDOTypes").val());
        if((ncboFDOTypes==2))
        {
            $("#txtExportPINo").attr("placeholder", "Type Bill/Invoice No & Press Enter");
        }
        else{
            $("#txtExportPINo").attr("Type PI No & Press Enter");
        }

        if((ncboFDOTypes==8))
        {
            $("#btnCopyDetail").show();
        }
        else{
            $("#btnCopyDetail").hide();
        }

    }

    function Validation(){

        if(_oFabricDeliveryOrder.OrderID<=0)
        {
            $('#txtExportPINo').focus();
            $('#txtExportPINo').addClass("errorFieldBorder");
            alert('Pick Order No .');
            return false;
        }

        if(_oFabricDeliveryOrder.ContractorID<=0){
            $('#txtIssueTo').focus();
            $('#txtIssueTo').addClass("errorFieldBorder");
            alert('FabricDeliveryOrder issue to required.');
            alert(_oFabricDeliveryOrder.ContractorID);
            return false;
        }
        else{
            $('#txtIssueTo').removeClass("errorFieldBorder");
        }


        return true;
    }

    function RefreshObject()
    {
        var oFabricDeliveryOrder={
            FDOID: (_oFabricDeliveryOrder!=null && _oFabricDeliveryOrder.FDOID>0)? _oFabricDeliveryOrder.FDOID:0,
            DONo:$('#txtDONo').val(),
            FDOType:parseInt($("#cboFDOTypes").val()),
            FDOTypeInInt:parseInt($("#cboFDOTypes").val()),
            DODate:$('#txtDODate').datebox('getValue'),
            ExpDeliveryDate:$('#txtDeliveryDate').datebox('getValue'),
            ContractorID: parseInt($('#cboDeliverTo').val()),
            BCPID:parseInt($("#cboConcernPerson").val()),
            Note:$.trim($('#txtNote').val()),
            IsRevise:false,
            FDODetails:$('#tblFabricDeliveryOrderDetail').datagrid('getRows')
        };
        return oFabricDeliveryOrder;
    }



    function ResetDetail(){
        _nProductID=0;
        _nExportSCDetailID=0;

        $('#cboKnitPly').val(0);
        $('#txtColorSet,#txtShadeCount').val(3);
        $('#txtCombo').val(1);
        $('#txtProduct,#txtColorName,#txtRGB,#txtPantonNo,#txtReftNo,#txtApproveLotNo').val("");
    }






    $("#btnPickIssueTo").click(function () {

        var sContractorName=$.trim($("#txtIssueTo").val());
        _bIsIssueTo=true;
        GetContractors(sContractorName, _bIsIssueTo);
    });
    $("#txtIssueTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtIssueTo").val());
            _bIsIssueTo=true;
            GetContractors(sContractorName,_bIsIssueTo);
        }
        else if(nkeyCode==8){
            $("#txtIssueTo").val("");
            _nContractorID=0;
            $("#cboCPIssueTo").empty();
        }
    });
    $("#btnResetIssueTo").click(function () {
        $("#txtIssueTo").val("");
        _nContractorID=0;
    });
    $("#btnPickBuyer").click(function () {
        var sContractorName=$.trim($("#txtBuyer").val());
        _bIsIssueTo=false;
        GetContractors(sContractorName, _bIsIssueTo);
    });
    $("#txtBuyer").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtBuyer").val());
            _bIsIssueTo=false;
            GetContractors(sContractorName,_bIsIssueTo);
        }
        else if(nkeyCode==8){
            $("#txtIssueTo").val("");
            _nContractorID=0;
            $("#cboCPIssueTo").empty();
        }
    });
    //$("#btnResetIssueTo").click(function () {
    //    $("#txtIssueTo").val("");
    //    _nContractorID=0;
    //});

    $("#btnPickDeliverTo").click(function () {
        var sContractorName=$.trim($("#txtDeliverTo").val());
        GetDelivertTo(sContractorName);
    });
    $("#txtDeliverTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtDeliverTo").val());
            GetDelivertTo(sContractorName);
        }
        else if(nkeyCode==8){
            _oFabricDeliveryOrder.ContractorID=0;
            $("#txtDeliverTo").val();
            $("#cboCPDeliverTo").empty();
        }
    });
    $("#btnResetDeliverTo").click(function () {
        _oFabricDeliveryOrder.ContractorID=0;
        $("#txtDeliverTo").val();
        $("#cboCPDeliverTo").empty();
    });



    function GetContractors(sContractorName, bIsIssueTo){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }

    function GetDelivertTo(sContractorName){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winDelivertToPicker',
                        winclass:'clsDelivertToPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblDelivertToPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Delivert To List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }

    $("#btnReloadCon").click(function() {
       
        debugger;
        var nConPersonID=parseInt($("#cboDeliverTo").val());
        //if(parseInt(nConPersonID)<=0);
        //{
        //    $('#cboDeliverTo').focus();
        //    $('#cboDeliverTo').addClass("errorFieldBorder");
        //    alert('Select Delivery To Name .');
        //    return ;
        //}
        GetContactPersonel(nConPersonID);
        
    });

    function GetContactPersonel(nContractorID){

        var oContractor = {
            ContractorID: nContractorID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "GetContactPersonnels",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContactPersonnelID > 0)
                {
                        LoadIssueContactPersonnel(response.objs);
                }
            }
        });
    }

    $("#btnPickExportPI").click(function () {

     
        var oFabricDeliveryOrder = {
            PINo: $.trim($("#txtExportPINo").val()),
            FDOTypeInInt: parseInt($("#cboFDOTypes").val()),
            IssueToID:_oFabricDeliveryOrder.IssueToID,
            BuyerID: _oFabricDeliveryOrder.BuyerID,
            BUID:_nBUID
        };
        GetsExportPIs(oFabricDeliveryOrder);

    });

    $("#txtExportPINo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            debugger;
            var oFabricDeliveryOrder = {
                PINo: $.trim($("#txtExportPINo").val()),
                FDOTypeInInt: parseInt($("#cboFDOTypes").val()),
                IssueToID:_oFabricDeliveryOrder.IssueToID,
                BuyerID: _oFabricDeliveryOrder.BuyerID,
                BUID:_nBUID
            };

            GetsExportPIs(oFabricDeliveryOrder);
        }
        else if(nkeyCode==8){
            $("#txtExportPINo").val("");
            //_oFabricDeliveryOrder.OrderID=0;

        }
    });
    $("#btnResetExportPI").click(function () {
        $("#txtExportPINo").val("");
        _nExportPIID=0;
    });

    $("#btnPickExportLCNo").click(function () {

        var oFabricDeliveryOrder = {
            LCNo: $.trim($("#txtExportLCNo").val()),
            FDOTypeInInt: parseInt($("#cboFDOTypes").val()),
            IssueToID:_oFabricDeliveryOrder.IssueToID,
            BuyerID: _oFabricDeliveryOrder.BuyerID,
            BUID:_nBUID
        };
        GetsExportPIs(oFabricDeliveryOrder);
        
    });

    $("#txtExportLCNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var oFabricDeliveryOrder = {
                LCNo: $.trim($("#txtExportLCNo").val()),
                FDOTypeInInt: parseInt($("#cboFDOTypes").val()),
                IssueToID:_oFabricDeliveryOrder.IssueToID,
                BuyerID: _oFabricDeliveryOrder.BuyerID,
                BUID:_nBUID
            };
            GetsExportPIs(oFabricDeliveryOrder);
        }
        else if(nkeyCode==8){
            $("#txtExportLCNo").val("");
            $("#txtExportPINo").val("");
            _nExportPIID=0;
        }
    });
    $("#btnResetExportLCNo").click(function () {
        $("#txtExportLCNo").val("");
        _nExportPIID=0;
    });



    $("#btnPickPOList").click(function () {

        debugger;
        if(parseInt($('#cboFDOTypes').val())<=0)
        {
            alert("Please, Select DO Type"); $('#cboFDOTypes').focus(); return;
        }
        if((parseInt($('#cboFDOTypes').val())===1 && _nExportPIID<=0))
        {
            alert("Please, First Pick PI.");
            $('#txtExportPINo').focus();
            return;
        }

        var oDODetail = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');
        var sTemp="";
        if(oDODetail!=null && oDODetail.length>0)
        {
            for (var i = 0;i<oDODetail.length; i++)
            {
                sTemp = oDODetail[i].FEOID + "," + sTemp;
            }
            sTemp = sTemp.substring(0, sTemp.length - 1);
        }
        var oFabricDeliveryOrder = {
            SCNo:$.trim($("#txtPONo").val()),
            FDOTypeInInt: parseInt($('#cboFDOTypes').val()),
            IssueToID:_oFabricDeliveryOrder.IssueToID,
            BuyerID: _oFabricDeliveryOrder.BuyerID,
            ExportPIID:_nExportPIID,
            Params:sTemp,
            BUID:_nBUID,
            IsDisPo:false
        };

        GetPOs(oFabricDeliveryOrder);
    });
    //$("#btnResetProduct").click(function () {

    //    $("#txtProduct").val("");
    //    _nProductID=0;
    //    _nExportSCDetailID=0;
    //});
    $("#txtPONo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
          
            if(parseInt($('#cboFDOTypes').val())<=0)
            {
                alert("Please, Select DO Type"); $('#cboFDOTypes').focus(); return;
            }
            if((parseInt($('#cboFDOTypes').val())===1 && _nExportPIID<=0))
            {
                alert("Please, First Pick PI.");
                $('#txtExportPINo').focus();
                return;
            }

            var oDODetail = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');
            var sTemp="";
            if(oDODetail!=null && oDODetail.length>0)
            {
                for (var i = 0;i<oDODetail.length; i++)
                {
                    sTemp = oDODetail[i].FEOID + "," + sTemp;
                }
                sTemp = sTemp.substring(0, sTemp.length - 1);
            }
            var oFabricDeliveryOrder = {
                SCNo:$.trim($("#txtPONo").val()), // tri $("#txtPONo").val(),   // SCNo: (IsDispo ? $.trim($scope.FabricDeliveryOrder.DisPoNo) : $.trim($scope.FabricDeliveryOrder.SCNo)),
                FDOTypeInInt: parseInt($('#cboFDOTypes').val()),
                IssueToID:_oFabricDeliveryOrder.IssueToID,
                BuyerID: _oFabricDeliveryOrder.BuyerID,
                ExportPIID:_nExportPIID,
                Params:sTemp,
                BUID:_nBUID,
                IsDisPo:false
            };

            GetPOs(oFabricDeliveryOrder);
           
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
            _nExportSCDetailID=0;
        }
    });
    $("#txtDispoNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
          
            if(parseInt($('#cboFDOTypes').val())<=0)
            {
                alert("Please, Select DO Type"); $('#cboFDOTypes').focus(); return;
            }
            if((parseInt($('#cboFDOTypes').val())===1 && _nExportPIID<=0))
            {
                alert("Please, First Pick PI.");
                $('#txtExportPINo').focus();
                return;
            }
            var oDODetail = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');
            var sTemp="";
            if(oDODetail!=null && oDODetail.length>0)
            {
                for (var i = 0;i<oDODetail.length; i++)
                {
                    sTemp = oDODetail[i].FEOID + "," + sTemp;
                }
                sTemp = sTemp.substring(0, sTemp.length - 1);
            }
            if(parseInt($('#cboGoodType').val())==1)
            {
                var oFabricDeliveryOrderDetail = {
                    ExeNo:$.trim($("#txtDispoNo").val()), // tri $("#txtPONo").val(),   // SCNo: (IsDispo ? $.trim($scope.FabricDeliveryOrder.DisPoNo) : $.trim($scope.FabricDeliveryOrder.SCNo)),
                    FDOTypeInInt: parseInt($('#cboFDOTypes').val()),
                    IssueToID:_oFabricDeliveryOrder.IssueToID,
                    BuyerID: _oFabricDeliveryOrder.BuyerID,
                    ExportPIID:0,
                    Params:sTemp,
                    BUID:_nBUID
                    
                };

                GetsDispo(oFabricDeliveryOrderDetail);
            }
            else{
                var oFabricDeliveryOrder = {
                    SCNo:$.trim($("#txtPONo").val()), // tri $("#txtPONo").val(),   // SCNo: (IsDispo ? $.trim($scope.FabricDeliveryOrder.DisPoNo) : $.trim($scope.FabricDeliveryOrder.SCNo)),
                    FDOTypeInInt: parseInt($('#cboFDOTypes').val()),
                    IssueToID:_oFabricDeliveryOrder.IssueToID,
                    BuyerID: _oFabricDeliveryOrder.BuyerID,
                    ExportPIID:_nExportPIID,
                    Params:sTemp,
                    BUID:_nBUID,
                    IsDisPo:true
                };

                GetPOs(oFabricDeliveryOrder);
            }
           
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
            _nExportSCDetailID=0;
        }
    });

    function GetPOs(oFabricDeliveryOrder){

        debugger;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricDeliveryOrder,
            ControllerName: "FabricDeliveryOrder",
            ActionName: "GetsPO",
            IsWinClose: false
        };
        //$("#progressbar").progressbar({ value: 0 });
        //$("#progressbarParent").show();
        //setInterval(updateProgress,250);

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FEOID> 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "FEONo", title: "PO No", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FabricNo", title: "Mkt Ref No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty_PI", title: "Order Qty", width: 80, align: "right",formatter:formatPrice  };tblColums.push(oColumn);
                    oColumn = { field: "Qty_DO", title: "Prev. DO", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_DC", title: "Challan Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "ExeNo", title: "Dispo No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "PINo", title: "PI No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Issue To", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buying House", width: 80, align: "left" };tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 850,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.(Insufficient Balance DO balance)");
            }
        });


    }
    function GetsDispo(oFabricDeliveryOrderDetail){

        debugger;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricDeliveryOrderDetail,
            ControllerName: "FabricDeliveryOrder",
            ActionName: "GetsFormExcess",
            IsWinClose: false
        };
        //$("#progressbar").progressbar({ value: 0 });
        //$("#progressbarParent").show();
        //setInterval(updateProgress,250);

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FEOID> 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "FEONo", title: "PO No", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FabricNo", title: "Mkt Ref No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty_PI", title: "Order Qty", width: 80, align: "right",formatter:formatPrice  };tblColums.push(oColumn);
                    oColumn = { field: "Qty_DO", title: "Prev. DO", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_DC", title: "Challan Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "ExeNo", title: "Dispo No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "PINo", title: "PI No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Issue To", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buying House", width: 80, align: "left" };tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 850,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.(Insufficient Balance DO balance)");
            }
        });


    }


    //Pick PI /LC

    function GetsExportPIs(oFabricDeliveryOrder){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricDeliveryOrder,
            ControllerName: "FabricDeliveryOrder",
            ActionName: "GetsExportPI",
            IsWinClose: false
        };
        _nExportPIID=0;
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0)
            {
                if (response.objs[0].ExportPIID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "PINo", title: "P/I No", width: '20%', align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "P/I Qty", width: '10%', align: "right" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Customer", width: '20%', align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buying House", width: '20%', align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "L/C No", width: '20%', align: "left" };tblColums.push(oColumn);
                    oColumn = { field: 'LCNo', name: 'L/C No',width: '12%', enableSorting: false  };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winExportPIPicker',
                        winclass:'clsExportPIPicker',
                        winwidth: 660,
                        winheight: 460,
                        tableid: 'tblExportPIPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'PINo',
                        windowTittle: 'P/I List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data not found.");
            }
        });


    }
    //End PI LC Pick

    //End PI LC Pick
    

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winContractorPicker')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                debugger;
                if(_bIsIssueTo){
                    $('#txtIssueTo').val(oreturnObj.Name);
                    _nContractorID= oreturnObj.ContractorID;
                    if(_nDeliveryToID<=0){
                        $('#txtDeliverTo').val(oreturnObj.Name);
                        _nDeliveryToID= oreturnObj.ContractorID;
                    }
                }
                else{
                    $('#txtBuyer').val(oreturnObj.Name);
                    //_oFabricDeliveryOrder.= oreturnObj.ContractorID;
                }

                //  GetContactPersonel(oreturnObj.ContractorID, _bIsIssueTo);

            }
            else{
                alert("Data not found");
            }
        }
        else  if (oPickerobj.winid == 'winDelivertToPicker')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                debugger;
                _oFabricDeliveryOrder.ContractorID=oreturnObj.ContractorID;
                $('#txtDeliverTo').val(oreturnObj.Name);
                //GetContactPersonel(oreturnObj.ContractorID, _bIsIssueTo);
            }
            else{
                alert("Data not found");
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnobjs != null && oreturnobjs.length > 0)
            {
                SaveWithDetail(oreturnobjs);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid=='winExportPIPicker')
        {
            if(oreturnObj!=null && parseInt(oreturnObj.ExportPIID)>0)
            {
                debugger;
                var txtExportPINo = document.getElementById("txtExportPINo");
                txtExportPINo.style.color = "blue";
                txtExportPINo.style.fontWeight = "bold";
                $('#txtExportPINo').val(oreturnObj.PINo);
                oreturnObj.FDOID= (_oFabricDeliveryOrder!=null && _oFabricDeliveryOrder.FDOID>0)? _oFabricDeliveryOrder.FDOID:0;
               //returnObj.FabricDeliveryOrderDetails=$('#tblFabricDeliveryOrderDetail').datagrid('getRows');
                _nExportPIID=oreturnObj.ExportPIID;
                _oFabricDeliveryOrder.PINo=oreturnObj.PINo;
                _oFabricDeliveryOrder.LCNo=oreturnObj.LCNo;
                _oFabricDeliveryOrder.IssueToID=oreturnObj.ContractorID;
                _oFabricDeliveryOrder.IssueToID=oreturnObj.ContractorID;
                _oFabricDeliveryOrder.ContractorID=oreturnObj.ContractorID;
                _oFabricDeliveryOrder.ContractorName = oreturnObj.ContractorName;
                _oFabricDeliveryOrder.BuyerID=oreturnObj.BuyerID;
                _oFabricDeliveryOrder.BuyerName = oreturnObj.BuyerName;
                _oFabricDeliveryOrder.FDOTypeInInt= $('#cboFDOTypes').val();
                var oContractors=[];
                var oContractor={ContractorID:oreturnObj.ContractorID,DeliveryToName:oreturnObj.ContractorName}
                oContractors.push(oContractor);
                if(oreturnObj.BuyerID>0 && oreturnObj.BuyerID!=oreturnObj.ContractorID)
                {
                    oContractor={ContractorID:oreturnObj.BuyerID,DeliveryToName:oreturnObj.BuyerName}
                    oContractors.push(oContractor);
                }
                $("#cboDeliverTo").icsLoadCombo({
                    List: oContractors,
                    OptionValue: "ContractorID",
                    DisplayText: "DeliveryToName",
                });


                RefreshControl(_oFabricDeliveryOrder);
            }
            else
            {
                alert("Data Not Found.");
            }
        }



    }
    function IsExist(nFEOID)
    {
        var oDUDODetails = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');

        for (var i = 0; i < oDUDODetails.length; i++) {
            if (parseInt(oDUDODetails[i].FEOID) == parseInt(nFEOID))
            {
                return true;
            }
        }
        return false;
    }
   
   
    function SaveWithDetail(oFabricDeliveryOrderDetails)
    {
        for (i=0; i<oFabricDeliveryOrderDetails.length;i++)
        {
           
            var bExists= IsExist(oFabricDeliveryOrderDetails[i].FEOID)
            if(!bExists)
            {
                $('#tblFabricDeliveryOrderDetail').datagrid('appendRow', oFabricDeliveryOrderDetails[i]);
            }

        }

        endEditing();
        RefreshSummary();
      
    }





    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });


    $("#btnRemoveDetail").click(function () {

        var oFabricDeliveryOrderDetail = $("#tblFabricDeliveryOrderDetail").datagrid("getSelected");
        if (oFabricDeliveryOrderDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblFabricDeliveryOrderDetail').datagrid('getRowIndex',oFabricDeliveryOrderDetail);
        if (!confirm("Confirm to Delete?")) return false;
        $("#tblFabricDeliveryOrderDetail").datagrid("deleteRow", nIndex);
        RefreshSummary();
        editIndex = undefined;
    });



    function RefreshSummary()
    {
        var oDODetails = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');
        var nTotalQty = 0, nTotalAmount= 0;
        for(var i = 0; i<oDODetails.length;i++)
        {
            nTotalQty+=parseFloat(oDODetails[i].Qty);

        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0)+"Y";

    }
    //////////// Detail ////////
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblFabricDeliveryOrderDetail').datagrid('validateRow', editIndex)) {
            $('#tblFabricDeliveryOrderDetail').datagrid('endEdit', editIndex);
            $('#tblFabricDeliveryOrderDetail').datagrid('selectRow', editIndex);
            var oESCDetail = $('#tblFabricDeliveryOrderDetail').datagrid('getSelected');
            debugger;
            $('#tblFabricDeliveryOrderDetail').datagrid('updateRow', { index: editIndex, row: oESCDetail });

            RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblFabricDeliveryOrderDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblFabricDeliveryOrderDetail').datagrid('getSelected');

                editIndex = index;
            }
            else {
                $('#tblFabricDeliveryOrderDetail').datagrid('selectRow', editIndex);
            }
        }
    }
    $("#btnSave").click(function (){
        endEditing();
        if(!Validation()) return false;

        debugger;
        var oFabricDeliveryOrder=RefreshObject();
        //if(!ValidateInput_Two()) return;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricDeliveryOrder/Save",
            traditional: true,
            data:  JSON.stringify(oFabricDeliveryOrder),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO= jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oFabricDeliveryOrder=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oFabricDeliveryOrders =sessionStorage.getItem("FabricDeliveryOrders");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oFabricDeliveryOrders!=null)
                    {
                        oFabricDeliveryOrders = jQuery.parseJSON(oFabricDeliveryOrders);
                    }
                    else
                    {
                        oFabricDeliveryOrders=[];
                    }
                    if(nIndex!=-1)
                    {
                        oFabricDeliveryOrders[nIndex]=_oFabricDeliveryOrder;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricDeliveryOrders.length);
                        oFabricDeliveryOrders.push(_oFabricDeliveryOrder);
                    }
                    sessionStorage.setItem("FabricDeliveryOrders", JSON.stringify(oFabricDeliveryOrders));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });
    
    $('#btnChecked').click(function () {

        debugger;
        var conf = confirm("Are you sure you want to Confirm Checked ?");
        if(conf==false)return;

        if (_oFabricDeliveryOrder ==null || _oFabricDeliveryOrder.FDOID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oFabricDeliveryOrder.CheckedBy!=0)
        {
            alert("Already Checked.");
            return;
        }
        if( _oFabricDeliveryOrder.ApproveBy!=0)
        {
            alert("Already Approve.");
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/FabricDeliveryOrder/Checked",
            traditional: true,
            data:  JSON.stringify(_oFabricDeliveryOrder),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oFabricDeliveryOrder=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oFabricDeliveryOrders =sessionStorage.getItem("FabricDeliveryOrders");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oFabricDeliveryOrders!=null)
                    {
                        oFabricDeliveryOrders = jQuery.parseJSON(oFabricDeliveryOrders);
                    }
                    else
                    {
                        oFabricDeliveryOrders=[];
                    }
                    if(nIndex!=-1)
                    {
                        oFabricDeliveryOrders[nIndex]=_oFabricDeliveryOrder;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricDeliveryOrders.length);
                        oFabricDeliveryOrders.push(_oFabricDeliveryOrder);
                    }
                    sessionStorage.setItem("FabricDeliveryOrders", JSON.stringify(oFabricDeliveryOrders));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });
    $('#btnApprove').click(function () {

        debugger;
        var conf = confirm("Are you sure you want to Approve ?");
        if(conf==false)return;

        if (_oFabricDeliveryOrder ==null || _oFabricDeliveryOrder.FDOID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oFabricDeliveryOrder.ApproveBy!=0)
        {
            alert("Already Approve.");
            return;
        }


        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/FabricDeliveryOrder/Approved",
            traditional: true,
            data:  JSON.stringify(_oFabricDeliveryOrder),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oFabricDeliveryOrder=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oFabricDeliveryOrders =sessionStorage.getItem("FabricDeliveryOrders");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oFabricDeliveryOrders!=null)
                    {
                        oFabricDeliveryOrders = jQuery.parseJSON(oFabricDeliveryOrders);
                    }
                    else
                    {
                        oFabricDeliveryOrders=[];
                    }
                    if(nIndex!=-1)
                    {
                        oFabricDeliveryOrders[nIndex]=_oFabricDeliveryOrder;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricDeliveryOrders.length);
                        oFabricDeliveryOrders.push(_oFabricDeliveryOrder);
                    }
                    sessionStorage.setItem("FabricDeliveryOrders", JSON.stringify(oFabricDeliveryOrders));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });



    $("#btnSave_Revise").click(function (){
        debugger;
        endEditing();
        if(!Validation()) return false;

        var oFabricDeliveryOrder=RefreshObject();
        if ($("#chkIsCreateReviseNo").is(':checked'))
        {
            oFabricDeliveryOrder.IsRevise=true;

            if (!confirm("Confirm to Change this Order with Revise No ?")) return false;
        }else{
            oFabricDeliveryOrder.IsRevise=false;
            if (!confirm("Confirm to Change this Order without Revise No ?")) return false;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricDeliveryOrder/SaveLog",
            traditional: true,
            data:  JSON.stringify(oFabricDeliveryOrder),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO= jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oFabricDeliveryOrder=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oFabricDeliveryOrders =sessionStorage.getItem("FabricDeliveryOrders");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oFabricDeliveryOrders!=null)
                    {
                        oFabricDeliveryOrders = jQuery.parseJSON(oFabricDeliveryOrders);
                    }
                    else
                    {
                        oFabricDeliveryOrders=[];
                    }
                    if(nIndex!=-1)
                    {
                        oFabricDeliveryOrders[nIndex]=_oFabricDeliveryOrder;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oFabricDeliveryOrders.length);
                        oFabricDeliveryOrders.push(_oFabricDeliveryOrder);
                    }
                    sessionStorage.setItem("FabricDeliveryOrders", JSON.stringify(oFabricDeliveryOrders));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });
    $("#btnCancel").click(function (){
        debugger;
        if(!Validation()) return false;


        var oFabricDeliveryOrder=RefreshObject();
        if( oFabricDeliveryOrder==null)
        {
            alert(" Something Wrong. Please Check!!");
        }

        if(oFabricDeliveryOrder.FDOID>0)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricDeliveryOrder/DOCancel",
                traditional: true,
                data:  JSON.stringify(oFabricDeliveryOrder),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var  oFabricDeliveryOrder = jQuery.parseJSON(data);
                    if (oFabricDeliveryOrder.ErrorMessage=="" || oFabricDeliveryOrder.ErrorMessage==null) {
                        alert("Cancel successfully");
                        _oFabricDeliveryOrder=oFabricDeliveryOrder;

                        var oFabricDeliveryOrders =sessionStorage.getItem("FabricDeliveryOrders");
                        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));

                        if(oFabricDeliveryOrders!=null)
                        {
                            oFabricDeliveryOrders = jQuery.parseJSON(oFabricDeliveryOrders);
                        }
                        else
                        {
                            oFabricDeliveryOrders=[];
                        }
                        if(nIndex!=-1)
                        {
                            oFabricDeliveryOrders[nIndex]=_oFabricDeliveryOrder;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oFabricDeliveryOrders.length);
                            oFabricDeliveryOrders.push(oFabricDeliveryOrders);
                        }
                        sessionStorage.setItem("FabricDeliveryOrders", JSON.stringify(oFabricDeliveryOrders));
                        window.location.href = _sBackLink;
                    }
                    else
                    {
                        alert(oFabricDeliveryOrder.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }


            });
        }

        else
        {
            alert("Please Select valid Order.");
        }


    });



    $('#btnPrint').click(function (e)
    {
        if (_oFabricDeliveryOrder ==null || _oFabricDeliveryOrder.FDOID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        var _nBUID= sessionStorage.getItem("BUID");
        window.open(_sBaseAddress + '/FabricDeliveryOrder/PrintabricDeliveryOrderPreview?nFDOID='+_oFabricDeliveryOrder.FDOID+'&nBUID='+_nBUID+"&bIsMeter="+false);
    });

    $("#btnRefresh").click(function () {
        endEditing();
    });

    function CopyDetail()
    {
        debugger;
        var oFDODetail = $("#tblFabricDeliveryOrderDetail").datagrid("getSelected");
        if (oFDODetail == null) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to copy?")) return false;
        var SelectedRowIndex=$('#tblFabricDeliveryOrderDetail').datagrid('getRowIndex',oFDODetail);
         
            var oFDODetailNew=
              {
                  FEONo: oFDODetail.FEONo,
                  FabricNo : oFDODetail.FabricNo,
                  Qty_Meter :0,
                  Qty_DC : 0,
                  Qty:0,
                  ExeNo : oFDODetail.ExeNo,
                  Construction : oFDODetail.Construction,
                  PINo : oFDODetail.PINo,
                  ColorInfo : oFDODetail.ColorInfo,
                  Construction : oFDODetail.Construction,
                  StyleNo : oFDODetail.StyleNo,
                  BuyerRef : oFDODetail.BuyerRef,
                  DOPriceTypeSt: "Cut Price",
                  DOPriceType: 2,
                  UnitPrice : 0,
                  FEOID : oFDODetail.FEOID,
                  FabricID : oFDODetail.FabricID,
                  ExportPIID : oFDODetail.ExportPIID,
                  OrderType : oFDODetail.OrderType,
                  FDODID :   0,
                  FDOID :   0,
                  ProductID : oFDODetail.ProductID
              };

        var oFDODetails = $('#tblFabricDeliveryOrderDetail').datagrid('getRows');
        var nLength = oFDODetails.length;
        $('#tblFabricDeliveryOrderDetail').datagrid('appendRow',oFDODetailNew);
        $('#tblFabricDeliveryOrderDetail').datagrid('selectRow', nLength);
        endEditing();
        //editIndex = undefined;
    }
</script>