@{
    ViewBag.Title = "Fabric Transfer Packing List";
}
@model ESimSol.BusinessObjects.FabricTransferPackingList
@{var MenuID = HttpContext.Current.Session[SessionInfo.MenuID];}
<!DOCTYPE html>

<html>
    <head>
        <title>Fabric Transfer Packing List</title>
    </head>
    <body class="menuMainCollectionTable">
        <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
            <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
                <label style="font-size:18px;">Please wait</label>
                <div id="progressbar" style="width:100%;height:37px;"></div>
            </div>
        </div>
        <div class="easyui-layout" style="width:100%; height:490px;">
          
            <div region="west" split="true" title="FEO Informations" style="width:45%;">
                <div style="width:80%;margin:80px auto;">
                    <table style="width:100%;">
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Store : </label>
                            </td>
                            <td style="width:70%;">
                                <select id="cboStore" style="width:101%;"></select>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Dispo No : </label>
                            </td>
                            <td style="width:70%;">
                                <input id="txtEFONo" type="text" style="width:100%;" placeholder="Type Dispo No & Press Enter" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Buyer/Party : </label>
                            </td>
                            <td style="width:70%;">
                                <input id="txtBuyer" type="text" style="width:100%;" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Date : </label>
                            </td>
                            <td style="width:70%;">
                                <input id="dtFabricTransferDate" type="text" style="width: 101%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Fab Type : </label>
                            </td>
                            <td style="width:70%;">
                                <input id="txtFabType" type="text" style="width:100%;" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Fab. Construc : </label>
                            </td>
                            <td style="width:70%;">
                                <input id="txtConstruction" type="text" style="width:100%;" disabled />
                            </td>
                        </tr>
                       
                        <tr>
                            <td style="width:24%;text-align:right;">
                                <label>Note : </label>
                            </td>
                            <td style="width:70%;" colspan="5">
                                <textarea id="txtNote" style="width:99%;min-height:100px;" ></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div region="center" style="width:100%;overflow:hidden;">
                @*<table id="tblFTPLDetail" title="Detail List" style="width:100%;" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarFTPLDetail" data-options="onClickRow: onClickRow">*@
                <table id="tblFTPLDetail" title="Detail List" style="width:100%;" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarFTPLDetail">
                    <thead>
                        <tr>
                            <th field="LotNo" width="12%">Roll No</th>
                            @*<th formatter="formatPrice" data-options="field:'Qty',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="150" align="right">Qty(Y)</th>*@
                            <th field="QtySt" width="10%" align="right">Fab.Qty(Y)</th>
                            <th field="QtyInMeterSt" width="10%" align="right">Fab.Qty(M)</th>
                            <th field="GradeInString" width="10%">Grade</th>
                            <th field="StoreRcvDateStr" width="15%">Recv. date</th>
                            <th field="WarpLot" width="10%">Warp Lot</th>
                            <th field="WeftLot" width="15%">WeftLot</th>

                        </tr>
                    </thead>
                </table>
                <div id="toolbarFTPLDetail">
                    <input id="txtRollNo" type="text" style="width:160px;" placeholder="Search Roll No" />
                    <input id="txtRollQty" type="text" style="width:120px;" placeholder="Search Roll Qty" />
                    <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                    <a id="btnRemove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    <a id="btnReceivedItemsnew" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Received Roll</a>
                    @*<a id="btnReceivedItemFromAnotherExection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Other Exe. Roll</a>*@
                    <a id="btnReceiveFromLot" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Another Lot</a>
                    <input id="txtAnotherFEONo" type="text" style="width:120px;" placeholder="Search By Another FEO ." />
                    <span>/</span>
                    <input id="OrderDateExt" type="text" style="width:25px;"/>
                </div>
            </div>
        </div>
        <fieldset>
            <legend>Actions</legend>
            <a id="btnBack" href="javascript:void(0)" style="float:right;" class="easyui-linkbutton" iconcls="icon-back" plain="true">Back</a>
            <a id="btnSave" href="javascript:void(0)" style="float:right;" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
        </fieldset>
       
        <div id="winReceiveRoll" style="width:430px;width:600px;" class="easyui-window" title="Lot List" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div>
                <fieldset>
                    <table id="tblReceiveRollList" title="Lot List" class="easyui-datagrid" style="height:330px;width:99%;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#toolbarReceiveRoll">
                        <thead>
                            <tr>
                                <th data-options="field:'Selected',checkbox:true"></th>
                                <th field="LotNo" width="20%">Roll No</th>
                                <th field="BalanceSt" width="12%" align="right">Qty(Y)</th>
                                <th field="BalanceInMeterSt" width="12%" align="right">Qty(M)</th>
                                <th field="LotGrade" width="15%" align="center">Grade</th>
                                <th field="WUWrapLot" width="15%" align="center">Warp Lot</th>
                                <th field="WUWeftLot" width="15%" align="center">Weft Lot</th>

                            </tr>
                        </thead>
                    </table>
                    <div id="toolbarReceiveRoll">
                        Roll Length (Y): <input type="text" id="txtLengthY" style="width:60px;" class="number" placeholder="Yard" />&nbsp;<label style="display:none;">(Y)</label>
                        Roll Length (M):<input type="text" id="txtLengthM" style="width:60px;" class="number" placeholder="Meter" />&nbsp;(M)
                        Wrap Lot:<input type="text" id="txtWrapLot" style="width:60px;" placeholder="Wrap Lot" />&nbsp;
                        Weft Lot:<input type="text" id="txtWeftLot" style="width:60px;" placeholder="Weft Lot" />&nbsp;
                    </div>
                    <table style="width:99%;">
                        <tr>
                            <td></td>
                            <td width="39%"> Total</td>

                            <td width="30%"><label id="ttlqtyInYard"></label></td>
                            <td width="30%"><label id="ttlqtyInMeter"></label></td>
                            <td></td>
                        </tr>
                    </table>
                    <table style="width:99%;">
                        <tr>
                            <td><label id="ttlRecvRollMsg"></label></td>
                        </tr>
                    </table>
                    <table style="width:99%;">
                        <tr>
                            <td><label id="ttlRestQtylMsg"></label></td>
                        </tr>
                    </table>
                </fieldset>
             </div>
            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <a id="btnOkReceiveRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">OK</a>
                <a id="btnCloseReceiveRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>

        <div id="winSuggestedRoll" style="width:430px;width:450px;" class="easyui-window" title="Lot List" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div>
                <fieldset>
                    <table id="tblSuggestedRollList" title="Lot List" class="easyui-datagrid" style="height:330px;width:99%;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="false" autorowheight="false">
                        <thead>
                            <tr>
                                <th data-options="field:'Selected',checkbox:true"></th>
                                <th field="LotNo" width="30%">Roll No</th>
                                <th field="BalanceSt" width="20%" align="right">Qty(Y)</th>
                                <th field="BalanceInMeterSt" width="20%" align="right">Qty(M)</th>
                                <th field="LotGrade" width="15%" align="center">Grade</th>

                            </tr>
                        </thead>
                    </table>
            
                    <table style="width:99%;">
                        <tr>
                            <td></td>
                            <td width="39%"> Total</td>

                            <td width="30%"><label id="ttlqtyInYard"></label></td>
                            <td width="30%"><label id="ttlqtyInMeter"></label></td>
                            <td></td>
                        </tr>
                    </table>
                 
                </fieldset>
            </div>
            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <a id="btnOkSuggestedRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">OK</a>
                <a id="btnCloseSuggestedRoll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>
      
        <div id="winReceiveAnotherLot" style="width:430px;width:450px;" class="easyui-window" title="Lot List" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div>
                <fieldset>
                    <table id="tblAnotherLotList" title="Lot List" class="easyui-datagrid" style="height:150px;width:99%;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarAnotherLot">
                        <thead>
                            <tr>
                                
                                <th field="LotNo" width="25%">Roll No</th>
                                <th field="BalanceSt" width="20%" align="right">Qty(Y)</th>
                                <th field="BalanceInMeterSt" width="20%" align="right">Qty(M)</th>
                                <th field="LogNo" width="30%" align="right">Log</th>
                              
                            </tr>
                        </thead>
                    </table>
                    <div id="toolbarAnotherLot">
                        Lot No: <input type="text" id="txtAnotherLot" style="width:250px;"  placeholder="Enter Lot No & Press Enter" />
                    </div>
                    <table style="width:99%;">
                        <tr>
                            <td width="18%"><label>Lot Qty(Y) </label> </td>
                            <td width="25%"> <input type="text" id="txtAnotherLotgivenQtyY" style="width:80px;"  class="number" /></td>
                           
                            <td width="18%"><label>Qty(M)</label> </td>
                            <td width="20%"><input type="text" id="txtAnotherLotgivenqtyM" style="width:80px;" class="number" /></td>
                            <td></td>
                        </tr>
                    </table>
                
                </fieldset>
            </div>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <a id="btnOkReceiveAnotherLot" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">OK</a>
                <a id="btnCloseAnotherLot" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>
    </body>
</html>
<style>
    /*Step 2*/
    #progressbarParent {
        opacity: 0.8;
        background-color: #DCD9D4;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0px;
        left: 0px;
        z-index: 1000;
    }
</style>
<script type="text/javascript">
    var _nMenuid=0;
    var _sBaseAddress="";
    var _oFTPL=null;
    var _sBtnIDHtml="";
    var _nFEOID = 0;

    var _ttlQtyY= 0;
    var _ttlQtyM= 0;
    $(document).ready(function () {
        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(MenuID));
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFTPL = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBtnIDHtml = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BtnIDHtml));
        var oStores = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Stores));
        $("#cboStore").icsLoadCombo({List: oStores,OptionValue: "WorkingUnitID",DisplayText: "WorkingUnitName", InitialValue:"Nothing"});
        for(var i=0;i <oStores.length;i++){
            if(oStores[i].WorkingUnitID>0){
                $("#cboStore").val(oStores[i].WorkingUnitID);
                break;
            }
        }
        $(".easyui-datebox").datebox({ disabled: false });
        $(".easyui-datebox").datebox("setValue", icsdateformat(new Date()));

        RefreshControl(_oFTPL);
        $("#progressbar").progressbar({ value: 0 }); //Step 3
        $("#progressbarParent").hide(); //Step 3
        
        var sYear=(new Date()).getFullYear().toString();
        sYear=sYear.substring(2,sYear.length);
        $("#OrderDateExt")[0].value=sYear;

       
    });
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });
    
    function updateProgress() {    //Step 4
        var value =$('#progressbar').progressbar('getValue');
        if (value < 90){
            value += Math.floor(Math.random() * 15);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) { //Step 5
        $("#progressbarParent").hide();
    }

    function CheckPermission()
    {
        if(_sBtnIDHtml == "btnView"){
            alert("This operation is not possible.");
            return false;
        }
        return true;
    }

    function RefreshControl(oFTPL)
    {
        if(_sBtnIDHtml == "btnView")
        {
            $("#txtEFONo,#txtNote,#cboStore").prop("disabled",true);
            $("#dtFabricTransferDate").datebox({ disabled: true });
            $("#toolbarFTPLDetail,#btnSave").hide();
        }else{
            $("#txtEFONo,#txtNote,#cboStore").prop("disabled",false);
            $("#dtFabricTransferDate").datebox({ disabled: false });
            $("#toolbarFTPLDetail,#btnSave").show();
        }
        $("#dtFabricTransferDate").datebox("setValue", icsdateformat(new Date()));

        if(oFTPL.FTPListID > 0)
        {
            _nFEOID = oFTPL.FEOID;
            $("#txtEFONo").addClass("fontColorOfPickItem").val(oFTPL.OrderNo);
            $("#txtBuyer").val(oFTPL.BuyerName);
            $("#dtFabricTransferDate").datebox("setValue", oFTPL.PackingListDateSt);
            $("#txtFabType").val(oFTPL.FabType);
            $("#txtConstruction").val(oFTPL.Construction);
            $("#cboStore").val(oFTPL.StoreID);
            $("#txtNote").val(oFTPL.Note);
            DynamicRefreshList(oFTPL.FTPLDetails,"tblFTPLDetail");

            if(oFTPL.FTPLDetails.length > 0)
            {
                $("#txtEFONo,#cboStore").prop("disabled",true);
            }
        }
    }

    $("#btnBack").click(function(){
        window.location.href = _sBaseAddress + "/FabricTransferPackingList/View_FabricTransferPackingLists?menuid=" + _nMenuid;
    });

    $("#btnSave").click(function(){
        if(!CheckPermission()) return false;
        if(!Validation()) return false;
        var oDetails = $("#tblFTPLDetail").datagrid("getRows");
        if(oDetails.length <= 0){
            alert("Please insert detail.");
            return false;
        }

        var oFTPL = RefreshObject();

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPL,
            ObjectId: oFTPL.FTPListID,
            ControllerName: "FabricTransferPackingList",
            ActionName: "SaveFTPL",
            TableId: "",
            IsWinClose: false
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if($.trim(response.obj.ErrorMessage) == "")
                {
                    debugger;
                    var sBtnID = sessionStorage.getItem("BtnID");
                    if(sBtnID == "btnEdit" || sBtnID == "btnView")
                    {
                        var oSessionList = jQuery.parseJSON(sessionStorage.getItem("FTPLs"));
                        if(oSessionList!=null && oSessionList!="null" && oSessionList.length > 0)
                        {
                            var nLength = oSessionList.length;
                            for(var i=0;i<nLength;i++)
                            {
                                if(oSessionList[i].FTPListID == parseInt(response.obj.FTPListID))
                                {
                                    oSessionList[i] = response.obj;
                                    sessionStorage.setItem("FTPLs", JSON.stringify(oSessionList));
                                    break;
                                }
                            }
                        }
                        window.location.href = _sBaseAddress + "/FabricTransferPackingList/View_FabricTransferPackingLists?menuid=" + _nMenuid;
                    }
                    else if(sBtnID == "btnAdd")
                    {
                        debugger;
                        var oSessionList = jQuery.parseJSON(sessionStorage.getItem("FTPLs"));
                        if(oSessionList == null)
                        {
                            oSessionList = [];
                        }
                        oSessionList.push(response.obj);
                        sessionStorage.setItem("FTPLs", JSON.stringify(oSessionList));
                        sessionStorage.setItem("FTPListID", response.obj.FTPListID);
                        window.location.href = _sBaseAddress + "/FabricTransferPackingList/View_FabricTransferPackingLists?menuid=" + _nMenuid;
                    }
                    else{
                        alert("Invalid Fabric Transfer Packing List.");
                    }
                }
            }
        });
    });

    $("#btnRemove").click(function(){
        if(!CheckPermission()) return false;
        var oFTPLDetail = $("#tblFTPLDetail").datagrid("getSelected");

        if (oFTPLDetail == null || oFTPLDetail.FTPLDetailID <= 0) { 
            alert("Please select an item from list!"); return false; 
        }
        if (!confirm("Confirm to Delete?")) return false;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFTPLDetail,
            ControllerName: "FabricTransferPackingList",
            ActionName: "DeleteFTPLDetail",
            TableId: "tblFTPLDetail",
            IsWinClose: false
        };
        $.icsDelete(obj, function (response) {
            var oFTPLDetails=$("#tblFTPLDetail").datagrid("getRows");
            if(oFTPLDetails.length==0){
                _oFTPL=null;
            }
            DisabledEnabled();
        });
    });

    $("#btnReceivedItems").click(function(){
        GetReceivedItems();
    });


    
    $("#txtRollQty").keydown(function(e){
        if(e.keyCode === 13)
        {
            var nQty= icsRemoveComma($('#txtRollQty').val());

            if(isNaN(nQty) || nQty<=0)
            {
                alert("Roll qty required.");
                return;
            }
            GetReceivedItems();
        }
    });

    function GetReceivedItems(){
        if(!CheckPermission()) return false;
        if(!Validation()) return false;

        var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
        var nLength1 = oFTPLDetails1.length;
        var sLotIDs="";
        if(nLength1 > 0)
        {
            for(var i=0;i<nLength1;i++){
                sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
            }
            sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
        }

        var oFTPL = {
            StoreID : parseInt($("#cboStore").val()),
            FEOID : _nFEOID,
            LotIDs : sLotIDs,
            Params: icsRemoveComma($('#txtRollQty').val())
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPL,
            ControllerName: "FabricTransferPackingList",
            ActionName: "GetsLot",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "Roll No", width: "30%", align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BalanceSt", title: "Qty(Y)", width: "20%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "BalanceInMeterSt", title: "Qty(M)", width: "20%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "LotGrade", title: "Grade", width: "15%", align: "center" }; tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winLot',
                        winclass: 'clsLot',
                        winwidth: 430,
                        winheight: 460,
                        tableid: 'tblLots',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'OrderNo',
                        windowTittle: 'Lot List',
                        placeholder : "Search By Roll No"
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("No list found.");
            }
        });
    }

    function Validation()
    {
        var nStoreID = parseInt($("#cboStore").val());
        var sLotNo = $.trim($("#txtRollNo").val());

        if(_nFEOID == 0){
            alert("Select fabric execution order.");
            $("#txtEFONo").addClass("errorFieldBorder").focus();
            return false
        }else{
            $("#txtEFONo").removeClass("errorFieldBorder");
        }

        if(nStoreID == 0){
            alert("Please select store.");
            $("#cboStore").addClass("errorFieldBorder").focus();
            return false
        }else{
            $("#cboStore").removeClass("errorFieldBorder");
        }

        //if($.trim(sLotNo) == ""){
        //    alert("Give Roll No.");
        //    $("#txtRollNo").addClass("errorFieldBorder").focus();
        //    return false
        //}else{
        //    $("#txtRollNo").removeClass("errorFieldBorder");
        //}
       
        return true;
    }

    function SaveByAddButton()
    {
        if(!Validation()) return false;

        var nStoreID = parseInt($("#cboStore").val());
        var sLotNo = $.trim($("#txtRollNo").val()); 

        if(sLotNo=="")
        {
            alert("Give lot no.");
            $("#txtRollNo").addClass("errorFieldBorder").focus();
            return false;
        }else{
            $("#txtRollNo").removeClass("errorFieldBorder");
        }


        var oFTPLD = {
            FTPLDetailID : 0,
            FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
            LotNo : sLotNo,
            Qty : 0,
            IsSaveSingleLot:true,
            StoreID : nStoreID,
            FEOID:_nFEOID,
            FTPL : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? RefreshObject() : null)
        };

        var oFTPLDs = [];
        oFTPLDs.push(oFTPLD);
        var oFTPLDetails=$("#tblFTPLDetail").datagrid("getRows");
        var nLengthLot = oFTPLDetails.length;
        var sLotIDs="";

        if(nLengthLot>0)
        {
            for(var i=0;i<nLengthLot;i++){
                sLotIDs = oFTPLDetails[i].LotID + "," + sLotIDs;
            }
            sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
        }

        var oFTPLDetail={
            FTPLDetails : oFTPLDs,
            LotIDs : sLotIDs
        };
        SaveFTPLDetail(oFTPLDetail);
        $("#winReceiveRoll").icsWindow("close");
    }
    function GetLotsForKeDown(){
      
        var GetSugLotLists=[];
        var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
        var nLength1 = oFTPLDetails1.length;
        var sLotIDs="";
        if(nLength1 > 0)
        {
            for(var i=0;i<nLength1;i++)
            {
                sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
            }
            sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
        }

        var oFTPL = {
            StoreID : parseInt($("#cboStore").val()),
            FEOID : _nFEOID,
            LotIDs : sLotIDs,
            Params: icsRemoveComma($('#txtRollQty').val())
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPL,
            ControllerName: "FabricTransferPackingList",
            ActionName: "GetsLot",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    var results=response.objs;
                    debugger;
                    for(var i=0;i<results.length;i++)
                    {
                        var sLotNo = $.trim($("#txtRollNo").val()); 
                        var actRollNo=results[i].LotNo.split('-')[1];
                        //if(sLotNo==actRollNo)
                            GetSugLotLists.push(results[i]);
                    }
                    if(GetSugLotLists.length>0)
                    {
                        var oLots = GetSugLotLists;
                        var oFTPLDs=[];
                        for(var i=0;i<oLots.length;i++)
                        {
                            var oFTPLD = {
                                FTPLDetailID : 0,
                                FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
                                LotID : oLots[i].LotID,
                                Qty : oLots[i].Balance,
                                QtySt : formatPrice(oLots[i].Balance,2),
                                QtyInMeterSt : formatPrice(GetMeter(oLots[i].Balance,2)),
                                LotNo : oLots[i].LotNo,
                                IsSaveSingleLot:false,
                                FTPL:null
                            };
                            if(i==0 && (_oFTPL == null || _oFTPL.FTPListID == 0))
                            {
                                oFTPLD.FTPL = RefreshObject();
                            }
                            oFTPLDs.push(oFTPLD);
                        }

                        if(oFTPLDs.length > 0)
                        {
                            var oFTPLD = {
                                FTPLDetails : oFTPLDs
                            }
                          
                        }
                        $('#txtRollQty').val("");
                        if(GetSugLotLists.length==1){
                            SaveFTPLDetail(oFTPLD);
                        }
                        else{
                        $("#winSuggestedRoll").icsWindow("open");
                        InitializewinReceiveRoll(GetSugLotLists,"tblSuggestedRollList ");
                        }
                    }
                    
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("No list found.");
            }
        });
    }
    $("#txtRollNo").keydown(function(e){
        if(e.keyCode === 13)
        {
            if(!CheckPermission()) return false;
            //SaveByAddButton();
            GetLotsForKeDown();
        }
    });

    $("#btnAdd").click(function(){
        if(!CheckPermission()) return false;
        SaveByAddButton();
    });

    function SaveFTPLDetail(oFTPLD)
    {
      
        $("#winReceiveRoll").icsWindow("close");
        $("#winSuggestedRoll").icsWindow("close");
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPLD,
            ObjectId: oFTPLD.FTPLDetailID,
            ControllerName: "FabricTransferPackingList",
            ActionName: "SaveFTPLDetail",
            TableId: "",
            IsWinClose: false,
            Message: ""
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                var oFabricTransferPackingListDetail = response.obj;
                var oFTPLDetails = oFabricTransferPackingListDetail.FTPLDetails;
                var nLength = oFTPLDetails.length;
                if(nLength > 0)
                {
                    if(_oFTPL == null || _oFTPL.FTPListID == 0)
                    {
                        _oFTPL = oFabricTransferPackingListDetail.FTPLDetails[0].FTPL;
                    }

                    for(var i=0;i<nLength;i++)
                    {
                        $("#tblFTPLDetail").datagrid("appendRow", oFTPLDetails[i]);
                    }
                    $("#txtRollNo").val("").focus();
                    $("#tblFTPLDetail").datagrid("selectRow", ($("#tblFTPLDetail").datagrid("getRows").length - 1));
                }
             
                DisabledEnabled();
            }
        });
    }

    function DisabledEnabled()
    {
        var oFTPLDs = $("#tblFTPLDetail").datagrid("getRows");
        if(oFTPLDs.length > 0)
        {
            $("#txtEFONo,#cboStore").prop("disabled",true);
        }else{
            $("#txtEFONo,#cboStore").prop("disabled",false);
        }
    }

    function RefreshObject()
    {
        var oFTPL = {
            FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
            FTNID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTNID),
            FEOID : _nFEOID,
            StoreID : parseInt($("#cboStore").val()),
            PackingListDate : $('#dtFabricTransferDate').datebox('getValue'),
            Note : $.trim($("#txtNote").val())
        };

        return oFTPL;
    }

    function GetTransferPackingListByOtherFEO(sFEONO){
        if(!CheckPermission()) return false;
        var nStoreID = parseInt($("#cboStore").val());
           


        if(nStoreID == 0){
            alert("Please select store.");
            $("#cboStore").addClass("errorFieldBorder").focus();
            return false
        }else{
            $("#cboStore").removeClass("errorFieldBorder");
        }

        var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
        var nLength1 = oFTPLDetails1.length;
        var sLotIDs="";
        if(nLength1 > 0)
        {
            for(var i=0;i<nLength1;i++){
                sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
            }
            sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
        }

        var oFTPL = {
            StoreID : parseInt($("#cboStore").val()),
            FEOID : 0,
            LotIDs : sLotIDs,
            Params: icsRemoveComma($('#txtRollQty').val()),
            FEONo:sFEONO
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPL,
            ControllerName: "FabricTransferPackingList",
            ActionName: "GetsLot",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    InitializewinReceiveRoll(response.objs,"tblReceiveRollList");
                    $("#winReceiveRoll").icsWindow("open","Roll Information");
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("No list found.");
            }
        });
    }

    $("#txtEFONo").keydown(function(e){
        if (e.keyCode === 13) {
            if( $("#txtEFONo").val()=='' ||  $("#txtEFONo").val()==undefined)
            {
                alert("Please Enter Dispo No");
                return false;
            }

            var oFTPL = {
                FEONo : $.trim($(this).val()),
                StoreID: $('#cboStore').val()
            };
            $("#progressbar").progressbar({ value: 0 }); //Step 6
            $("#progressbarParent").show(); //Step 6
            var intervalID = setInterval(updateProgress, 250); //Step 7

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFTPL,
                ControllerName: "FabricTransferPackingList",
                ActionName: "GetsFabricSalesContractDetail",
                IsWinClose: false
            };
            $.icsMaxDataGets(obj, function (response) {
                $('#progressbar').progressbar('setValue', 100); //Step 8
                clearInterval(intervalID); //Step 9
                if (response.status && response.objs.length > 0) {
                    if (parseInt(response.objs[0].FabricSalesContractDetailID)> 0)
                    {
                        var tblColums = [];
                        var oColumn = { field: "ExeNo", title: "Dispo No", width: "90%", align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winFEO',
                            winclass: 'clsFEO',
                            winwidth: 400,
                            winheight: 460,
                            tableid: 'tblFEOs',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'OrderNo',
                            windowTittle: 'FEO List',
                            placeholder : "Search By Dispo No"
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                        setTimeout(hideShow, 1000); //Step 10
                    }
                    else {
                        setTimeout(hideShow, 1000); //Step 10
                        alert(response.objs[0].ErrorMessage);
                    }
                }
                else{
                    setTimeout(hideShow, 1000); //Step 10
                    alert("No list found.");
                }
                
            });
        }
        else if(e.keyCode === 8)
        {
            $("#txtEFONo").removeClass("fontColorOfPickItem");
            $("#txtBuyer,#txtFabType,#txtConstruction").val("");
            _nFEOID=0;
            DynamicRefreshList([],"tblFTPLDetail");
        }
    });

    $("#txtAnotherFEONo").keydown(function (e) {
        if (e.keyCode === 13) {
            if( $.trim($(this).val())!=null &&  $.trim($(this).val())!=""){
                if($.trim($('#OrderDateExt').val())==null ||  $.trim($('#OrderDateExt').val())==""){
                    alert("Enter Year");
                    $('#OrderDateExt').focus();
                    return false;
                }
                var oFabricExecutionOrder = {
                    FEONo: $.trim($(this).val())+'/'+$.trim($('#OrderDateExt').val())
                };
                var obj = {
                    BaseAddress: _sBaseAddress,
                    Object: oFabricExecutionOrder,
                    ControllerName: "FabricExecutionOrder",
                    ActionName: "GetsFEOrders",
                    IsWinClose: false
                };
                $.icsMaxDataGets(obj, function (response) {
                    
                    if (response.status && response.objs.length > 0) {
                        debugger;
                        if (response.objs[0].FEOID > 0 && response.objs.length>1) {
                            var tblColums = []; var oColumn = { field: "OrderNo", title: "Order No", width: 200, align: "left" }; tblColums.push(oColumn);
                            var oPickerParam = {
                                winid: 'winFabricExecutionOrders',
                                winclass: 'clsFabricExecutionOrder',
                                winwidth: 400,
                                winheight: 460,
                                tableid: 'tblFabricExecutionOrders',
                                tablecolumns: tblColums,
                                datalist: response.objs,
                                multiplereturn: true,
                                searchingbyfieldName: 'Name',
                                windowTittle: 'Fabric ExecutionOrder List'
                            };
                            $.icsPicker(oPickerParam);
                            IntializePickerbutton(oPickerParam);
                        }
                        if (response.objs[0].FEOID > 0 && response.objs.length==1) {
                            GetTransferPackingListByOtherFEO(response.objs[0].FEONo);
                        }

                        else {
                            alert(response.objs[0].ErrorMessage);
                        }
                    }
                    else {
                        alert("Sorry, No FEO found.");
                    }
                });
            }
            else{
                alert("Type FEONo & Press Enter");
                $('#txtAnotherFEONo').focus();
            }
        }
       
    });



    function IntializePickerbutton(oPickerObj) {
        $("#" + oPickerObj.winid).find("#btnOk").click(function () {
            IntializePickerbuttonPick(oPickerObj);
        });
        $(document).find('.' + oPickerObj.winclass).keydown(function (e) {
            if (e.which === 13) {
                IntializePickerbuttonPick(oPickerObj);
            }
        });
    }

    function IntializePickerbuttonPick(oPickerObj) {
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerObj.multiplereturn) {
            oreturnObjs = $('#' + oPickerObj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerObj.tableid).datagrid('getSelected');
        }
        if (oPickerObj.winid == 'winFEO')
        {
            if (oreturnObj != null && parseInt(oreturnObj.FabricSalesContractDetailID)>0)
            {
                debugger;
                var oFEO = oreturnObj;
                _nFEOID = oFEO.FabricSalesContractDetailID;
                $("#txtEFONo").addClass("fontColorOfPickItem").val(oFEO.ExeNo);
                $("#txtBuyer").val(oFEO.BuyerName);
                $("#txtConstruction").val(oFEO.Construction);
                $("#txtFabType").val(oFEO.ProcessTypeName);
                $("#txtRollNo").focus();

            } else 
            {
                alert("Select an item from list.");
                return false;
            }
        }
        else if (oPickerObj.winid == 'winLot') {
            debugger;
            if (oreturnObjs != null && oreturnObjs.length>0) 
            {
                if(oreturnObjs[0].LotID > 0 && $.trim(oreturnObjs[0].ErrorMessage) == "")
                {
                    var oLots = oreturnObjs;
                    var nLength = oLots.length;
                    var oFTPLDs=[];
                    for(var i=0;i<nLength;i++)
                    {
                        var oFTPLD = {
                            FTPLDetailID : 0,
                            FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
                            LotID : oLots[i].LotID,
                            Qty : oLots[i].Balance,
                            QtySt : formatPrice(oLots[i].Balance,2),
                            QtyInMeterSt : formatPrice(GetMeter(oLots[i].Balance,2)),
                            LotNo : oLots[i].LotNo,
                            IsSaveSingleLot:false,
                            FTPL:null
                        };
                        if(i==0 && (_oFTPL == null || _oFTPL.FTPListID == 0))
                        {
                            oFTPLD.FTPL = RefreshObject();
                        }
                        oFTPLDs.push(oFTPLD);
                    }

                    if(oFTPLDs.length > 0)
                    {
                        var oFTPLD = {
                            FTPLDetails : oFTPLDs
                        }
                        SaveFTPLDetail(oFTPLD);
                    }
                }
                else
                {
                    alert(oreturnObjs[0].ErrorMessage);
                }
            } 
            else {
                alert("Select item(s) from list.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winFabricExecutionOrders') {
            if (oreturnObj != null && oreturnObj.FEOID > 0) {
                GetTransferPackingListByOtherFEO(oreturnObjc.FEONo);
                
            }
            else {
                alert("Select item(s) from list.");
                return false;
            }
        }
        $("#" + oPickerObj.winid).icsWindow("close");
        $("#" + oPickerObj.winid).remove();
    }

    $("#txtLengthY").keyup(function (e) {
        $('#tblReceiveRollList').datagrid('unselectAll');
        $("#ttlRestQtylMsg").text("");
        var nVal =  $(this).val();
        if(nVal <=_ttlQtyY ){
            $("#ttlRecvRollMsg").text("Roll Receive possible !");
            document.getElementById('ttlRecvRollMsg').style.color = "green";
            
        }
        else{
            $("#ttlRecvRollMsg").text("Paritally Receive possible ,Qty not more than "+_ttlQtyY.toFixed(2) +" Y / "+ _ttlQtyM.toFixed(2) +" M");
            document.getElementById('ttlRecvRollMsg').style.color = "red";
        }
        $('#txtLengthM').val(GetMeter(nVal,2));
        GetSuggestedLotByYard();
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
       
    });

    $("#txtLengthM").keyup(function (e) {
        $('#tblReceiveRollList').datagrid('unselectAll');
        $("#ttlRestQtylMsg").text("");
        var nVal = $(this).val();
        if(nVal <=_ttlQtyM ){
            $("#ttlRecvRollMsg").text("Roll Receive possible !");
            document.getElementById('ttlRecvRollMsg').style.color = "green";
            
        }
        else{
            $("#ttlRecvRollMsg").text("Paritally Receive possible ,Qty not more than "+_ttlQtyY.toFixed(2) +" Y / "+ _ttlQtyM.toFixed(2) +" M");
            document.getElementById('ttlRecvRollMsg').style.color = "red";
        }
        $('#txtLengthY').val(GetYard(nVal,2));
        GetSuggestedLotByMeter();
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    function InitializewinReceiveRoll(oLots,dataGridName){
        DynamicRefreshList(oLots,dataGridName);
        $("#txtLengthY").val(0);
        $("#txtLengthM").val(0);
        _ttlQtyY= 0;
        _ttlQtyM= 0;
        for(var i=0; i< oLots.length; i++){
            _ttlQtyY+= oLots[i].Balance;
            _ttlQtyM+=oLots[i].BalanceInMtr;
        }
        $("#ttlqtyInYard").text(_ttlQtyY.toFixed(2) +" Y ");
        $("#ttlqtyInMeter").text(_ttlQtyM.toFixed(2) +" M ");
        $("#ttlRestQtylMsg,#ttlRecvRollMsg").text("");
         
    }
 

    $("#btnReceivedItemsnew").click(function(){
        if(!CheckPermission()) return false;
        if(!Validation()) return false;

        var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
        var nLength1 = oFTPLDetails1.length;
        var sLotIDs="";
        if(nLength1 > 0)
        {
            for(var i=0;i<nLength1;i++){
                sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
            }
            sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
        }

        var oFTPL = {
            StoreID : parseInt($("#cboStore").val()),
            FEOID : _nFEOID,
            LotIDs : sLotIDs,
            Params: icsRemoveComma($('#txtRollQty').val())
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFTPL,
            ControllerName: "FabricTransferPackingList",
            ActionName: "GetsLot",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    InitializewinReceiveRoll(response.objs,"tblReceiveRollList");
                    $("#winReceiveRoll").icsWindow("open","Roll Information");
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("No list found.");
            }
        });
    });
    $("#btnCloseReceiveRoll").click(function(){
        $("#winReceiveRoll").icsWindow("close");
    });
    $("#btnCloseSuggestedRoll").click(function(){
        $("#winSuggestedRoll").icsWindow("close");
    });
    $("#btnOkReceiveRoll").click(function(){
        var oSelectedRolls= $("#tblReceiveRollList").datagrid("getChecked");
        if (oSelectedRolls.length>0) 
        {
               var oLots = oSelectedRolls;
                var oFTPLDs=[];
                for(var i=0;i<oLots.length;i++)
                {
                    var oFTPLD = {
                        FTPLDetailID : 0,
                        FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
                        LotID : oLots[i].LotID,
                        Qty : oLots[i].Balance,
                        QtySt : formatPrice(oLots[i].Balance,2),
                        QtyInMeterSt : formatPrice(GetMeter(oLots[i].Balance,2)),
                        LotNo : oLots[i].LotNo,
                        IsSaveSingleLot:false,
                        FTPL:null
                    };
                    if(i==0 && (_oFTPL == null || _oFTPL.FTPListID == 0))
                    {
                        oFTPLD.FTPL = RefreshObject();
                    }
                    oFTPLDs.push(oFTPLD);
                }

                if(oFTPLDs.length > 0)
                {
                    var oFTPLD = {
                        FTPLDetails : oFTPLDs
                    }
                    SaveFTPLDetail(oFTPLD);
                }
           
        } 
        else {
            alert("Select item(s) from list.");
            return false;
        }
        

    });

    $("#btnOkSuggestedRoll").click(function(){
        var oSelectedRolls= $("#tblSuggestedRollList").datagrid("getChecked");
        if (oSelectedRolls.length>0) 
        {
            var oLots = oSelectedRolls;
            var oFTPLDs=[];
            for(var i=0;i<oLots.length;i++)
            {
                var oFTPLD = {
                    FTPLDetailID : 0,
                    FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
                    LotID : oLots[i].LotID,
                    Qty : oLots[i].Balance,
                    QtySt : formatPrice(oLots[i].Balance,2),
                    QtyInMeterSt : formatPrice(GetMeter(oLots[i].Balance,2)),
                    LotNo : oLots[i].LotNo,
                    IsSaveSingleLot:false,
                    FTPL:null
                };
                if(i==0 && (_oFTPL == null || _oFTPL.FTPListID == 0))
                {
                    oFTPLD.FTPL = RefreshObject();
                }
                oFTPLDs.push(oFTPLD);
            }

            if(oFTPLDs.length > 0)
            {
                var oFTPLD = {
                    FTPLDetails : oFTPLDs
                }
                SaveFTPLDetail(oFTPLD);
            }
           
        } 
        else {
            alert("Select item(s) from list.");
            return false;
        }
        

    });

    $("#txtWrapLot").keyup(function (e) {
        if(e.keyCode==13){
            $('#tblReceiveRollList').datagrid('unselectAll');
            $("#ttlRestQtylMsg").text("");
       
            $("#ttlRestQtylMsg,#ttlRecvRollMsg").text("");


            var oRolls = $("#tblReceiveRollList").datagrid("getRows");
           
            var selectRow=-1;
       
            for(var i=0; i<oRolls.length;i++)
            {   
                var ExistsMultipleLos =oRolls[i].WUWrapLot.indexOf("~");
                if(ExistsMultipleLos==-1){
                    console.log(oRolls[i].WUWrapLot.toUpperCase())
                    console.log($.trim($("#txtWrapLot").val()).toUpperCase());
                    if(oRolls[i].WUWrapLot.toUpperCase()== $.trim($("#txtWrapLot").val()).toUpperCase()){
                        selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                        $("#tblReceiveRollList").datagrid("selectRow", selectRow);
             
                    }
                }
                if(ExistsMultipleLos>1){
                    var getAllLots= oRolls[i].WUWrapLot.split('~');
                    for(var j=0; j<getAllLots.length;j++){
                       
                        if(getAllLots[i].toUpperCase()== $.trim($("#txtWrapLot").val()).toUpperCase()){
                            selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                            $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                            break;
             
                        }
                    }
                
                }
            
            }
        }
        if(e.keyCode==8)
        {
            $('#tblReceiveRollList').datagrid('unselectAll');
        }
        
       
    });
    $("#txtWeftLot").keyup(function (e) {
        if(e.keyCode==13){
            $('#tblReceiveRollList').datagrid('unselectAll');
            $("#ttlRestQtylMsg").text("");
       
            $("#ttlRestQtylMsg,#ttlRecvRollMsg").text("");


            var oRolls = $("#tblReceiveRollList").datagrid("getRows");
           
            var selectRow=-1;
       
            for(var i=0; i<oRolls.length;i++)
            {   
                var ExistsMultipleLos =oRolls[i].WUWeftLot.indexOf("~");
                if(ExistsMultipleLos==-1){
                   
                    if(oRolls[i].WUWeftLot.toUpperCase()== $.trim($("#txtWeftLot").val()).toUpperCase()){
                        selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                        $("#tblReceiveRollList").datagrid("selectRow", selectRow);
             
                    }
                }
                if(ExistsMultipleLos>1){
                    var getAllLots= oRolls[i].WUWeftLot.split('~');
                    for(var j=0; j<getAllLots.length;j++){
                       
                        if(getAllLots[i].toUpperCase()== $.trim($("#txtWeftLot").val()).toUpperCase()){
                            selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                            $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                            break;
             
                        }
                    }
                
                }
            
            }
        }
        if(e.keyCode==8)
        {
            $('#tblReceiveRollList').datagrid('unselectAll');
        }
        
       
    });

    function GetSuggestedLotByYard(){
      
        $("#ttlRestQtylMsg").text("");
        var oRolls = $("#tblReceiveRollList").datagrid("getRows");
        var nQty=parseFloat($("#txtLengthY").val());
        var selectRow=-1;
        var isExistsAsQty =false;
        for(var i=0; i<oRolls.length;i++)
        {   
            selectRow=-1;
            if(oRolls[i].Balance== nQty && nQty>0){
                selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                nQty =0;
                isExistsAsQty=true;
                break;
            }
        }
        if(!isExistsAsQty){
            for(var i=0; i<oRolls.length;i++)
            {   
                selectRow=-1;
                if(oRolls[i].Balance== nQty && nQty>0){
                    selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                    $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                    nQty =0;
                 
                }
                else if(oRolls[i].Balance < nQty && nQty>0){
                    selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                    $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                    nQty -= oRolls[i].Balance;
                }
         
            }
        }
        if(nQty>0){
            $("#ttlRestQtylMsg").text("Remaining Qty to Adjust " + nQty +" Y/ "+(GetMeter(nQty,2)) +" M");
            document.getElementById('ttlRestQtylMsg').style.color = "red";
        }
    }
    
    function GetSuggestedLotByMeter(){
        debugger;
        $("#ttlRestQtylMsg").text("");
        var oRolls = $("#tblReceiveRollList").datagrid("getRows");
        var nQty=parseFloat($("#txtLengthM").val());
        var selectRow=-1;
        var isExistsAsQty =false;
        for(var i=0; i<oRolls.length;i++)
        {   
            selectRow=-1;
            if(oRolls[i].BalanceInMtr== nQty && nQty>0){
                selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                nQty =0;
                isExistsAsQty=true;
                break;
            }
         }
        if(!isExistsAsQty){
            for(var i=0; i<oRolls.length;i++)
            {   
                selectRow=-1;
                if(oRolls[i].BalanceInMtr== nQty && nQty>0){
                    selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                    $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                    nQty =0;
                 
                }
                else if(oRolls[i].BalanceInMtr < nQty && nQty>0){
                    selectRow=$("#tblReceiveRollList").datagrid("getRowIndex", oRolls[i]);
                    $("#tblReceiveRollList").datagrid("selectRow", selectRow);
                    nQty -= oRolls[i].BalanceInMtr;
                }
         
            }
        }
        if(nQty>0){
            $("#ttlRestQtylMsg").text("Remaining Qty to Adjust " +(GetYard(nQty,2)) +" Y/ "+nQty +" M");
            document.getElementById('ttlRestQtylMsg').style.color = "red";
        }
    }
    //Added By Tonmoy For Edit Qty
    var editIndex = undefined;
    function endEditing(){
        debugger;
        if (editIndex == undefined)
        {
            return true;
        }
        if ($('#tblFTPLDetail').datagrid('validateRow', editIndex)){
            $('#tblFTPLDetail').datagrid('endEdit', editIndex);
            $('#tblFTPLDetail').datagrid('selectRow',editIndex);
            var oFTPLD=$('#tblFTPLDetail').datagrid('getSelected');
            if(_sBtnIDHtml == "btnView")
            {
                
                //var oFBRMS =[];
                //oFBRMS.push(oFabricBatchRawMaterial);
                //Out(oFBRMS, true,editIndex,true);
            }
            else
            {
                debugger;
                console.log(oFTPLD);
                UpdateFPLD(oFTPLD);
               
                $('#tblFabricBatchRawMaterial').datagrid('updateRow',{index: editIndex,	row: oFTPLD});
            }
            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }

    function onClickRow(index){
        if (editIndex != index){

            var oRow = $("#tblFTPLDetail").datagrid("getSelected");
            if(_sBtnIDHtml == "btnView")
            {
                $('#tblFTPLDetail').datagrid('endEdit', editIndex);
                editIndex = undefined;
                endEditing();
                return true;
            }

            if (endEditing())
            {
                $('#tblFTPLDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else
            {
                $('#tblFTPLDetail').datagrid('selectRow', editIndex);
            }
        }
    }

    function UpdateFPLD(oFPLD){
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricTransferPackingList/UpdateFTPLDetail",
            traditional: true,
            data: JSON.stringify(oFPLD),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFPLD =JSON.parse(data);
                $('#tblFabricBatchRawMaterial').datagrid('updateRow',{index: editIndex,	row: oFTPLD});
               
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    $("#txtAnotherLot").keydown(function(e){
        if (e.keyCode === 13) {
            if($(this).val()!=""|| $(this).val()!=undefined){

                var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
                 var nLength1 = oFTPLDetails1.length;
                 var sLotIDs="";
                 if(nLength1 > 0)
                 {
                     for(var i=0;i<nLength1;i++){
                         sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
                     }
                     sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
                 }

                 var oFTPL = {
                     StoreID : parseInt($("#cboStore").val()),
                     LotIDs : sLotIDs,
                     LotNo:$(this).val()
           
                 };

                 var obj = {
                     BaseAddress: _sBaseAddress,
                     Object: oFTPL,
                     ControllerName: "FabricTransferPackingList",
                     ActionName: "GetsAnotherLot",
                     IsWinClose: false
                 };
                 $.icsMaxDataGets(obj, function (response) {
                     if (response.status && response.objs.length > 0) {
                         if (response.objs[0].LotID > 0) {   
                             DynamicRefreshList(response.objs,"tblAnotherLotList");
                             $("#btnOkReceiveAnotherLot").show();
                         }
                         else {
                             alert(response.objs[0].ErrorMessage);
                         }
                     }
                     else
                     {
                         alert("No list found.");
                     }
                 });

            }
            else{
                alert("Enter Lot NO");
                return false;
            }
          
        }
        else if(e.keyCode === 8)
        {
          
            DynamicRefreshList([],"tblAnotherLotList");
        }
    });

    $("#btnReceiveFromLot").click(function(){
        $("#txtAnotherLotgivenQtyY").val(""); 
        $("#txtAnotherLotgivenqtyM").val("") ;
        $("#txtAnotherLot").val("");
        DynamicRefreshList([],"tblAnotherLotList");
        $("#btnOkReceiveAnotherLot").hide();  
        $("#winReceiveAnotherLot").icsWindow("open","Lot List");
      
       
    });
    $("#btnCloseAnotherLot").click(function(){
        $("#winReceiveAnotherLot").icsWindow("close");
    });
    $("#btnOkReceiveAnotherLot").click(function(){
         
        var oLots = $("#tblAnotherLotList").datagrid("getRows");
        if(oLots[0].Balance<$("#txtAnotherLotgivenQtyY").val()){
            alert("Qty Cna not be more than lot bance");
            return false;
        }
        var oFTPLDs=[];
        for(var i=0;i<oLots.length;i++)
        {
            var oFTPLD = {
                FTPLDetailID : 0,
                FTPListID : ((_oFTPL == null || _oFTPL.FTPListID == 0) ? 0 : _oFTPL.FTPListID),
                LotID : oLots[i].LotID,
                Qty : $("#txtAnotherLotgivenQtyY").val(),
                QtySt : formatPrice($("#txtAnotherLotgivenQtyY").val(),2),
                QtyInMeterSt : formatPrice(GetMeter($("#txtAnotherLotgivenQtyY").val(),2)),
                LotNo : oLots[i].LotNo,
                IsSaveSingleLot:false,
                FTPL:null
            };
            if(i==0 && (_oFTPL == null || _oFTPL.FTPListID == 0))
            {
                oFTPLD.FTPL = RefreshObject();
            }
            oFTPLDs.push(oFTPLD);
        }

        if(oFTPLDs.length > 0)
        {
            var oFTPLD = {
                FTPLDetails : oFTPLDs
            }
                          
        }
        if(oLots.length==1){
            SaveFTPLDetail(oFTPLD);
        }
    });
   
    $("#txtAnotherLotgivenQtyY").keyup(function (e) {
      
        var nVal =  $(this).val();
      
        $('#txtAnotherLotgivenqtyM').val(GetMeter(nVal,2));
      
       
    });

    $("#txtAnotherLotgivenqtyM").keyup(function (e) {
      
        var nVal = $(this).val();
       
        $('#txtAnotherLotgivenQtyY').val(GetYard(nVal,2));
      
        
    });

    //$("#txtAnotherFEONo").keydown(function (e) {
    //    if (e.keyCode === 13) {
    //        if( $.trim($(this).val())!=null &&  $.trim($(this).val())!=""){
    //            if(!CheckPermission()) return false;
    //            var nStoreID = parseInt($("#cboStore").val());
           


    //            if(nStoreID == 0){
    //                alert("Please select store.");
    //                $("#cboStore").addClass("errorFieldBorder").focus();
    //                return false
    //            }else{
    //                $("#cboStore").removeClass("errorFieldBorder");
    //            }

    //            var oFTPLDetails1 = $("#tblFTPLDetail").datagrid("getRows");
    //            var nLength1 = oFTPLDetails1.length;
    //            var sLotIDs="";
    //            if(nLength1 > 0)
    //            {
    //                for(var i=0;i<nLength1;i++){
    //                    sLotIDs = oFTPLDetails1[i].LotID + "," + sLotIDs;
    //                }
    //                sLotIDs = sLotIDs.substring(0, sLotIDs.length - 1);
    //            }

    //            var oFTPL = {
    //                StoreID : parseInt($("#cboStore").val()),
    //                FEOID : 0,
    //                LotIDs : sLotIDs,
    //                Params: icsRemoveComma($('#txtRollQty').val()),
    //                FEONo:$.trim($(this).val())
    //            };

    //            var obj = {
    //                BaseAddress: _sBaseAddress,
    //                Object: oFTPL,
    //                ControllerName: "FabricTransferPackingList",
    //                ActionName: "GetsLot",
    //                IsWinClose: false
    //            };
    //            $.icsMaxDataGets(obj, function (response) {
    //                if (response.status && response.objs.length > 0) {
    //                    if (response.objs[0].LotID > 0) {
    //                        InitializewinReceiveRoll(response.objs,"tblReceiveRollList");
    //                        $("#winReceiveRoll").icsWindow("open","Roll Information");
    //                    }
    //                    else {
    //                        alert(response.objs[0].ErrorMessage);
    //                    }
    //                }
    //                else
    //                {
    //                    alert("No list found.");
    //                }
    //            });
    //        }
    //        else{
    //            alert("Please Enter FN Exe No !")
    //        }
           
    //    }
       
    //});

</script>
