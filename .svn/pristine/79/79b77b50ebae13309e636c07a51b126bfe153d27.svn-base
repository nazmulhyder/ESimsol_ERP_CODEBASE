<html>
@{
    ViewBag.Title = "Production Execution";
}
<body>
@model ESimSol.BusinessObjects.ProductionExecution
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable" id="divPP"  class="easyui-panel" title="Production Execution" style="font-family:Tahoma; height:100%; width:100%">
        <fieldset>
            <legend> Production Sheet Information </legend>
            <table border="0" style="font-size:12px" width="100%">
                <tr>
                    <td style="width:10%; text-align:right">Buyer Name:</td>
                    <td style="width:20%; text-align:left">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:87%"><input type="text" id="txtContractorName" placeholder="Type Buyer & Press Enter" style="width:100%" /></td>
                                <td style="width:13%"><input type="button" id="btnPickContractor" value="Pick" /> </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width:10%; text-align:right">Sheet No:</td>
                    <td style="width:20%; text-align:left">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:87%"><input type="text" id="txtSheetNo" placeholder="Type Sheet No & Press Enter" style="width:100%" /></td>
                                <td style="width:13%"><input type="button" id="btnPickProductionSheet" value="Pick" /> </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width:10%; text-align:right">Mold Name:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtModelReferencenName" style="width:100%" disabled />
                    </td>
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">PI No:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtPINo" style="width:100%"  />
                    </td>
                    <td style="width:10%; text-align:right">Order Qty:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtPODetailQty" style="width:100%;text-align:right;" disabled />
                    </td>
                    <td style="width:10%; text-align:right">Recipe Name:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtRecipeName" style="width:100%" disabled />
                    </td>
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">Product Name:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtProductName" style="width:100%" disabled />
                    </td>
                    <td style="width:10%; text-align:right">Execut Date:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" style="width:180px;" id="txtExecutDate" class="easyui-datetimebox" required="required" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </td>
                    <td style="width:10%; text-align:right">Sheet Qty:</td>
                    <td style="width:20%; text-align:left">
                        <input type="text" id="txtQuantity" style="width:100%;text-align:right;" disabled />
                    </td>
                </tr>
            </table>
        </fieldset>
        <div>
            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                <tr>
                    <td style="width:28%">
                        <table id="tblProductionSteps" title="Production Steps" class="easyui-datagrid" style="width:100%; height:435px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolBar">
                            <thead>
                                <tr>
                                    <th field="StepName" width="160" align="left">Step Name</th>
                                    <th field="ExecutionQty" width="100" align="right">Execution Qty</th>
                                </tr>
                            </thead>
                        </table>
                    </td>
                    <td style="width:72%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:100%">
                                    <fieldset>
                                        <legend>Production Process Steps</legend>
                                        <table border="0" cellpadding="1" cellspacing="1" width="100%" style="font-weight:normal; font-size:12px;">
                                            <tr>
                                                <td style="width:11%; text-align:right;">Step Name :</td>
                                                <td colspan="2" style="width:50%">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:55%"><input type="text" id="txtStepName" style="width:100%; font-weight:bold;" disabled /></td>
                                                            <td style="width: 45%; text-align: right">
                                                                <label id="lblPriviousStepName" style="font-weight:normal">Order</label> Qty:
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>                                                
                                                <td style="width:20%; text-align:left;"><input type="text" id="txtPriviousStepQty" style="width:100%" disabled /></td>
                                                <td style="width:5%"><input type="text" id="txtPSMUName" style="width:100%" disabled /></td>
                                            </tr>
                                           
                                            <tr>
                                                <td style="width:10%; text-align:right;">CycleTime(sec):</td>
                                                <td style="width:40%; text-align:right;" >
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:20%"><input type="text" id="txtCycleTime" style="width:100%" /></td>
                                                            <td style="width:20%">Cavity(Pcs):</td>
                                                            <td style="width:20%"><input type="text" id="txtCavity" style="width:100%" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td style="width:10%;text-align:right;">ShortCount:</td>
                                                <td style="width:20%; text-align:left;"><input type="text" id="txtShortCounter"  style="width:100%" /></td>
                                                <td style="width:5%"><input type="text" id="txtSCMUName" value="Times" style="width:100%" disabled /></td>
                                            </tr>

                                            <tr>
                                                <td style="width:10%; text-align:right;">Operate By:</td>
                                                <td style="width:40%; text-align:right;">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:20%"><select id="cboOperateBy" style="width:100%"></select></td>
                                                            <td style="width:20%">Shift:</td>
                                                            <td style="width:20%"><select id="cboShift" style="width:100%"></select></td>
                                                        </tr>
                                                    </table>
                                                   
                                                </td>
                                                <td style="width:10%;text-align:right;">Prod. Hour:</td>
                                                <td style="width:20%; text-align:left;">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:25%"><input type="text" id="txtProductionHour" value="12" style="width:100%" disabled="disabled" /></td>
                                                            <td style="width:50%"><input type="text" value="YetTo Production" style="width:100%; text-align:right" disabled="disabled" /></td>
                                                            <td style="width:25%"><input type="text" id="txtYetToProductionHour" value="0" style="width:100%" disabled="disabled" /></td>
                                                        </tr>
                                                    </table>
                                                    
                                                </td>
                                                <td style="width:5%"><input type="text" id="txtPHUnit" value="Hour(s)" style="width:100%" disabled /></td>
                                            </tr>
                                            <tr>
                                                <td style="width:10%; text-align:right;">Machine:</td>
                                                <td style="width:40%; text-align:right;">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:50%"><input type="text" id="txtMachineName" placeholder="Type Machine Name & Press Enter" style="width:100%" /></td>
                                                            <td style="width:15%"><input type="button" id="btnPickMachine" style="width:100%" value="Pick" /> </td>
                                                            <td style="width:20%">Operator/Machine:</td>
                                                            <td style="width:15%"><input type="text" id="txtOperatorPerMachine" style="width:100%" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td style="width:10%;text-align:right;">Remarks:</td>
                                                <td style="width:25%; text-align:left;" colspan="2"><input type="text" id="txtRemark" style="width:100%" /></td>
                                            </tr>
                                            <tr>                                                
                                                <td colspan="2" style="width:50%; text-align:left;">
                                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                                        <tr>
                                                            <td style="width:45%; text-align:right;">Yet To <label id="lblSelectedStepName" style="font-weight:normal">Step2</label> Qty:</td>                                                            
                                                            <td style="width:40%"><input type="text" id="txtYetToSelectedStepQty" style="width:97%" disabled /></td>
                                                            <td style="width:15%"><input type="text" id="txtSelectedMUName" style="width:100%" disabled /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td style="width:10%; text-align:right;">Execut Qty:</td>
                                                <td style="width:28%; text-align:left;"><input type="text" id="txtExecutionQty" style="width:65%" />&nbsp;<input type="text" id="txtExeMUName" style="width:20%" disabled /></td>
                                                <td style="width:10%; text-align:right;"><input type="button" id="btnCommit" style="text-align:right; width:100%" onclick="Commit()" value="Commit" /></td>
                                            </tr>
                                         
                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr>
                                <td width="100%">
                                    <table id="tblPETransaction" title="Transaction History" class="easyui-datagrid" style="width:100%; height:280px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#DetailtoolBar">
                                        <thead>
                                            <tr>
                                                <th field="TransactionDateInString" width="10%" align="left">Date</th>
                                                <th field="Quantity" width="8%" align="right" formatter="formatPricewithoutdecimal">Quantity</th>
                                                <th field="OperationEmpByName" width="12%" align="left">Execute By</th>
                                                <th field="ShiftName" width="12%" align="left">Shift</th>
                                                <th field="EntryByName" width="12%" align="left">Entry By</th>
                                                <th field="CycleTime" width="10%" align="right">Cycle Time(s)</th>
                                                <th field="Cavity" width="10%" align="right">Cavity</th>
                                                <th field="ShortCounter" width="12%" align="right">Shot Counter</th>
                                                <th field="MachineName" width="12%" align="right">MachineName</th>

                                            </tr>
                                        </thead>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    var _sBaseAddress="";
    $(document).ready(function () {        
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oProductionExecution =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var BUID  =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        var oOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Operators));
        var oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.HRMShifts));
        var nProductNature =  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ProductNature));
        sessionStorage.setItem('BUID',BUID);
        sessionStorage.setItem('ProductNature',nProductNature);
        $('#txtExecutionQty,#txtYetToSelectedStepQty,#txtPriviousStepQty,#txtProductionHour,#txtYetToProductionHour,#txtShortCounter,#txtOperatorPerMachine, #txtCycleTime,#txtCavity').icsCurrencyBox(null,null,1);
        $('#divPP').data('ProductionSheet',null);
        $('#divPP').data('ProductionExecutions',[]);
        $('#divPP').data('ProductionExecution',oProductionExecution);
        $('#divPP').data('PETransactions', oProductionExecution.PETransactions);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        RefreshListTransactions(oProductionExecution.PETransactions);
        $('#tblProductionSteps').datagrid({ onSelect: function (rowIndex, rowData) { SetData(rowIndex, rowData); } });
        $("#cboOperateBy").icsLoadCombo({List: oOperators,OptionValue:"EmployeeID",DisplayText: "Name"});
        $("#cboShift").icsLoadCombo({List: oHRMShifts,OptionValue:"ShiftID",DisplayText: "Name"});
        $('#txtExecutDate').datetimebox('setValue', icsdatetimeformat(new Date()));
    });

    $('#txtCavity,#txtShortCounter').keyup(function(){
        $('#txtProductionHour').val(parseFloat(((icsRemoveComma($('#txtShortCounter').val())* icsRemoveComma($('#txtCycleTime').val()))/3600.00).toFixed(2)));
        $('#txtExecutionQty').val(formatPricewithoutdecimal(parseInt(icsRemoveComma($('#txtShortCounter').val()))*parseInt(icsRemoveComma($('#txtCavity').val())),0));
    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    function RefreshListTransactions(oPETransactions)
    {
        data=oPETransactions;
        data={"total":""+data.length+"","rows":data};
        $('#tblPETransaction').datagrid('loadData',data);
    }

///Contractor Pick
$("#txtContractorName").keydown(function (e) {
    debugger;
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13) // Enter Press
    {
        if($.trim($('#txtContractorName').val())==null || $.trim($('#txtContractorName').val())=="")
        {
            alert("Please Type Buyer Name & Press Enter");
            return;
        }
        GetContractors($.trim($('#txtContractorName').val()));
    }
});
$("#btnPickContractor").click(function ()
{
    GetContractors("");
});
$('#txtContractorName').keydown(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 8) //backspace=8
    {
        //debugger;
        $("#txtContractorName").removeClass("fontColorOfPickItem");
        $('#divPS').data('ProductionSheet').ContractorID = 0;
        $('#txtContractorName').val('');
    }
});
function GetContractors(sContractorName)
{
    var oContractor = { Params: 2 + '~' + sContractorName+'~'+sessionStorage.getItem("BUID") };
    var obj = {
        BaseAddress: _sBaseAddress,
        Object: oContractor,
        ControllerName: "Contractor",
        ActionName: "ContractorSearchByNameType",
        IsWinClose: false
    };
    $("#progressbar").progressbar({ value: 0 });
    $("#progressbarParent").show();
    var intervalID = setInterval(updateProgress, 250);
    $.icsDataGets(obj, function (response) {
        debugger;
        clearInterval(intervalID);
        $("#progressbarParent").hide();
        if (response.status && response.objs.length > 0) {
            if (response.objs[0].ContractorID > 0) {
                debugger;
                var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                var oPickerParam = {
                    winid: 'winContractors',
                    winclass: 'clsContractor',
                    winwidth: 600,
                    winheight: 460,
                    tableid: 'tblContractors',
                    tablecolumns: tblColums,
                    datalist: response.objs,
                    multiplereturn: false,
                    searchingbyfieldName: 'Name',
                    windowTittle: 'Contractor List'
                };
                $.icsPicker(oPickerParam);
                IntializePickerbutton(oPickerParam);
            }
            else { alert(response.objs[0].ErrorMessage); }
        }else{
            alert("Data Not Found.");
            return;
        }
    });
}

//Machin Pick   
$("#txtMachineName").keydown(function (e) {
    debugger;
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13) // Enter Press
    {
        if($.trim($('#txtMachineName').val())==null || $.trim($('#txtMachineName').val())=="")
        {
            alert("Please Type Machine Name And Press Enter.");
            return;
        }
        GetMachines($.trim($('#txtMachineName').val()));
    }else if(code==8)
    {
        $('#txtMachineName').val("");
        $('#txtMachineName').removeClass('fontColorOfPickItem');
        $('#divPP').data('ProductionExecution').MachineID = 0;
        $('#txtMachineName').focus();
        var sTransactionDate = $('#txtExecutDate').datebox('getValue');
        if(sTransactionDate!=null && sTransactionDate !="")
        {
            GetYetToProductionHour(sTransactionDate);
        }
    }
});
$("#btnPickMachine").click(function () 
{
    GetMachines("");
});
$('#txtMachineName').keydown(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 8) //backspace=8
    {
        //debugger;
        $("#txtMachineName").removeClass("fontColorOfPickItem");
        $("#txtMachineName").val('');
        $('#divPS').data('ProductionSheet').MachineID = 0;
    }
});

function GetMachines(sMachineName)
{
    var oCapitalResource = {ResourcesTypeInInt:2,BUID:sessionStorage.getItem('BUID'),Name:sMachineName};
    var obj = {
        BaseAddress: _sBaseAddress,
        Object: oCapitalResource,
        ControllerName:"CapitalResource",
        ActionName: "GetsCapitalResourceLastLayer",
        IsWinClose: false
    };
    $.icsDataGets(obj, function (response) {
        debugger;
        if (response.status && response.objs.length > 0) {
            if (response.objs[0].CRID > 0) {
                debugger;
                var tblColums = []; var oColumn = { field: "Name", title: "Machine Name", width:300, align: "left" }; tblColums.push(oColumn);
                var oPickerParam = {
                    winid: 'winMachine',
                    winclass: 'clsMachine',
                    winwidth: 500,
                    winheight: 400,
                    tableid: 'tblMachine',
                    tablecolumns: tblColums,
                    datalist: response.objs,
                    multiplereturn: false,
                    searchingbyfieldName: 'Name',
                    windowTittle: 'Machine List'
                };
                $.icsPicker(oPickerParam);
                IntializePickerbutton(oPickerParam);
            }
            else { alert(response.objs[0].ErrorMessage); }
        }else{
            alert("Data Not Found.");
        }
    });
}

$("#txtSheetNo").keydown(function (e) {
    debugger;
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13) // Enter Press
    {
        if($.trim($('#txtSheetNo').val())==null || $.trim($('#txtSheetNo').val())=="")
        {
            alert("Please Type ProductionSheet Name And Press Enter.");
            return;
        }
        GetSheets($.trim($('#txtSheetNo').val()),'');
    }
});

$("#txtPINo").keydown(function (e) {
    debugger;
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13) // Enter Press
    {
        if($.trim($('#txtPINo').val())==null || $.trim($('#txtPINo').val())=="")
        {
            alert("Please Type PI No And Press Enter.");
            return;
        }
        GetSheets('',$.trim($('#txtPINo').val()));
    }
});

$("#btnPickProductionSheet").click(function()
{
  debugger;
    GetSheets("",'');
});
function GetSheets(sSheetNo, sPINo)
{
    var oProductionSheet = {SheetNo:sSheetNo,ContractorID:$('#divPP').data('ProductionExecution').ContractorID,BUID:sessionStorage.getItem("BUID"),ProductNatureInInt:sessionStorage.getItem('ProductNature'),ExportPINo:sPINo};
    var obj = {
        BaseAddress: _sBaseAddress,
        Object: oProductionSheet,
        ControllerName: "ProductionSheet",
        ActionName: "GetsProductionSheets",
        IsWinClose: false
    };
    $("#progressbar").progressbar({ value: 0 });
    $("#progressbarParent").show();
    var intervalID = setInterval(updateProgress, 250);
    $.icsDataGets(obj, function (response) {
        debugger;
        clearInterval(intervalID);
        $("#progressbarParent").hide();
        if (response.status && response.objs.length > 0) {
            if (response.objs[0].ProductionSheetID > 0) {
                debugger;
                var tblColums = []; var oColumn = { field: "SheetNo", title: "Sheet No", width: 200, align: "left" }; tblColums.push(oColumn);
                oColumn = { field: "PONo", title: "PO No", width: 120, align: "left" }; tblColums.push(oColumn);
                oColumn = { field: "Quantity", title: "Sheet Qty", width: 120, align: "right" }; tblColums.push(oColumn);
                var oPickerParam = {
                    winid: 'winProductionSheets',
                    winclass: 'clsProductionSheet',
                    winwidth: 600,
                    winheight: 460,
                    tableid: 'tblProductionSheets',
                    tablecolumns: tblColums,
                    datalist: response.objs,
                    multiplereturn: false,
                    searchingbyfieldName: 'SheetNo',
                    windowTittle: 'Production Sheet List'
                };
                $.icsPicker(oPickerParam);
                IntializePickerbutton(oPickerParam);
            }
            else { alert(response.objs[0].ErrorMessage); }
        }else{
            alert("Data Not Found.");
        }
    });
}
$('#txtSheetNo').keydown(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 8) //backspace=8
    {
        //debugger;
        $("#txtSheetNo").removeClass("fontColorOfPickItem");
        $("#txtSheetNo").val('');
        $('#divPS').data('ProductionSheet').ProductionSheetID = 0;
    }
});

function IntializePickerbutton(oPickerobj) {
    $("#" + oPickerobj.winid).find("#btnOk").click(function () {
        //for Single Select
        SetPickerValueAssign(oPickerobj);
    });
    $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
        if (e.which == 13)//enter=13
        {
            SetPickerValueAssign(oPickerobj);

        }
    });
}

function SetPickerValueAssign(oPickerobj) {
    debugger;
    var oreturnObj = null, oreturnobjs = [];
    if (oPickerobj.multiplereturn) {
        oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
    } else {
        oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
    }
    $("#" + oPickerobj.winid).icsWindow("close");
    $("#" + oPickerobj.winid).remove();
    if (oPickerobj.winid == 'winContractors')
    {
        if (oreturnObj != null && oreturnObj.ContractorID > 0) {
            $('#txtContractorName').val(oreturnObj.Name);
            $('#txtContractorName').addClass('fontColorOfPickItem');
            $('#divPP').data('ProductionExecution').ContractorID= oreturnObj.ContractorID;
            $('#txtContractorName').focus();
        }
    }
    else if (oPickerobj.winid == 'winProductionSheets')
    {
        if (oreturnObj != null && oreturnObj.ProductionSheetID > 0)
        {
            $('#divPP').data('ProductionSheet',oreturnObj);
            $('#txtSheetNo').val(oreturnObj.SheetNo);
            $('#txtContractorName').val(oreturnObj.ContractorName);
            $('#txtModelReferencenName').val(oreturnObj.ModelReferencenName);
            $('#txtPINo').val(oreturnObj.ExportPINo);
            $('#txtProductName').val(oreturnObj.ProductName);
            $('#txtQuantity').val(formatPriceWithZeroDecimal(oreturnObj.Quantity,0)+' '+oreturnObj.UnitSymbol);
            $('#txtPODetailQty').val(formatPriceWithZeroDecimal(oreturnObj.ProdOrderQty,0)+' '+oreturnObj.UnitSymbol);
            $('#txtRecipeName').val(oreturnObj.RecipeName);
            $('#txtSheetNo,#txtContractorName').addClass('fontColorOfPickItem');
            $('#divPP').data('ProductionExecution').ProductionSheetID =oreturnObj.ProductionSheetID;
            $('#divPP').data('ProductionExecution').ContractorID= oreturnObj.ContractorID;

            $('#txtMachineName').val(oreturnObj.MachineName);
            $('#txtMachineName').addClass('fontColorOfPickItem');
            $('#divPP').data('ProductionExecution').MachineID = oreturnObj.MachineID;
            
            GetExecutions(oreturnObj.ProductionSheetID);
            $('#txtSheetNo').focus();
        }
    }else if (oPickerobj.winid=='winMachine')
    {
        if (oreturnObj != null && oreturnObj.CRID > 0)
        {
            $('#txtMachineName').val(oreturnObj.Name);
            $('#txtMachineName').addClass('fontColorOfPickItem');
            $('#divPP').data('ProductionExecution').MachineID = oreturnObj.CRID;
            $('#txtMachineName').focus();
            var sTransactionDate = $('#txtExecutDate').datebox('getValue');
            if(sTransactionDate!=null && sTransactionDate !="")
            {
                GetYetToProductionHour(sTransactionDate);
            }
        }
    }

}

function GetExecutions(nProductionSheetID)
{
    var oProductionExecution={
        ProductionSheetID : nProductionSheetID
    };
    $.ajax ({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+"/ProductionExecution/GetProductionExecutions",
        data:  JSON.stringify(oProductionExecution),
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            debugger;
            var  oProductionExecutions = jQuery.parseJSON(data);
            if(oProductionExecutions.length>0 && (oProductionExecutions[0].ErrorMessage=="" || oProductionExecutions[0].ErrorMessage==null))
            {
                DynamicRefreshList(oProductionExecutions, "tblProductionSteps");
                $('#divPP').data('ProductionExecutions',oProductionExecutions);

                var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                if(nIndex!=null)
                {
                    $('#tblProductionSteps').datagrid('selectRow',nIndex);
                }

            }else
            {
                alert(oProductionExecutions[0].ErrorMessage);
            }
        },
        error: function (xhr, status, error)
        {
            alert(error);
        }
    });
}

function SetData(nIndex, oProductionExecution)
{
    GetPETransactions(oProductionExecution.ProductionExecutionID);
    var nFivePercentQty = parseInt(parseInt($('#divPP').data('ProductionSheet').Quantity)*5)/100;
    $('#txtStepName').val(oProductionExecution.StepName);
    $('#lblSelectedStepName').html(oProductionExecution.StepName);
    $('#txtYetToSelectedStepQty').val( formatPricewithoutdecimal(parseFloat(parseFloat($('#divPP').data('ProductionSheet').Quantity)+nFivePercentQty)-parseFloat(oProductionExecution.ExecutionQty),0));
    $('#txtMUName,#txtPSMUName,#txtSelectedMUName,#txtExeMUName').val($('#divPP').data('ProductionSheet').UnitSymbol);
    if(parseInt(oProductionExecution.ProductionStepTypeInInt)==1)//molding type
    {
        $("#txtCycleTime,#txtCavity,#txtShortCounter,#cboOperateBy,#cboShift,#txtProductionHour,#txtMachineName,#btnPickMachine,#txtOperatorPerMachine").prop( "disabled",false);
        $("#txtCycleTime,#txtShortCounter,#cboOperateBy,#txtProductionHour,#cboShift,#txtOperatorPerMachine").val(0);
        $("#txtProductionHour").val(12);
        $("#txtExecutionQty").prop( "disabled", true );
        $('#txtCavity').val($('#divPP').data('ProductionSheet').Cavity);
    }else{
        $("#txtCycleTime,#txtCavity,#txtShortCounter,#cboOperateBy,#cboShift,#txtProductionHour,#txtMachineName,#btnPickMachine,#txtOperatorPerMachine").prop( "disabled", true );
        $("#txtCycleTime,#txtCavity,#txtShortCounter,#cboOperateBy,#cboShift,#txtProductionHour,#txtOperatorPerMachine").val(0);
        $("#txtExecutionQty").prop( "disabled", false );
    }

    if(oProductionExecution.Sequence!=1)
    {
        var oPriviousItem = GetPriviousItem(parseInt(oProductionExecution.Sequence)-1);
        $('#lblPriviousStepName').html(oPriviousItem.StepName);
        $('#txtPriviousStepQty').val(formatPricewithoutdecimal(oPriviousItem.ExecutionQty,0));
        $('#txtExecutionQty').val(formatPricewithoutdecimal(parseFloat(oPriviousItem.ExecutionQty)-parseFloat(oProductionExecution.ExecutionQty),0));
    }else
    {
        $('#lblPriviousStepName').html("Order");
        $('#txtPriviousStepQty').val(formatPricewithoutdecimal($('#divPP').data('ProductionSheet').Quantity,0));
        $('#txtExecutionQty').val(formatPricewithoutdecimal(parseFloat(parseFloat($('#divPP').data('ProductionSheet').Quantity)+nFivePercentQty)-parseFloat(oProductionExecution.ExecutionQty),0));
    }
}

function GetPriviousItem(nSequence)
{
    var oTempExecutions = $('#divPP').data('ProductionExecutions');
    for(var i =0;i<oTempExecutions.length;i++)
    {
        if(parseInt(oTempExecutions[i].Sequence)== parseInt(nSequence))
        {
            return oTempExecutions[i];
        }
    }
    return null;
}

function GetPETransactions(nProductionExecutionID)
{
    //debugger;
    var oProductionExecution={
        ProductionExecutionID : nProductionExecutionID
    };
    $.ajax ({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+"/ProductionExecution/GetPETransactions",
        data:  JSON.stringify(oProductionExecution),
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            //debugger;
            var  oPETransactions = jQuery.parseJSON(data);
            if(oPETransactions.length>0)
            {
                if((oPETransactions[0].ErrorMessage=="" || oPETransactions[0].ErrorMessage==null))
                {
                    RefreshListTransactions(oPETransactions);

                }else
                {

                    alert(oPETransactions[0].ErrorMessage);
                }
            }else
            {
                RefreshListTransactions([]);
            }
        },
        error: function (xhr, status, error)
        {
            alert(error);
        }
    });
}

function RefreshDetail()
{
    endEditing();
    var oPETransactions = $('#tblPETransaction').datagrid('getRows');
    if(oPETransactions!=null)
    {
        RefreshPETransactions(oPETransactions);
    }
}

function Commit()
{
   // debugger;

    if(!ValidateInput()) return;
    var oPETransaction =  RefreshObject();
    var oProductionExecution =  $('#tblProductionSteps').datagrid('getSelected');
    var SelectedRowIndex=$('#tblProductionSteps').datagrid('getRowIndex',oProductionExecution);
    sessionStorage.setItem("SelectedRowIndex",SelectedRowIndex);
    $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionExecution/SavePETransaction",
            traditional: true,
            data:  JSON.stringify(oPETransaction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oPETransaction= jQuery.parseJSON(data);
                if (parseInt(oPETransaction.PETransactionID)>0 && (oPETransaction.ErrorMessage==""||oPETransaction.ErrorMessage==null))
                {
                    alert("Successfully Executed.!!");
                    $('#tblPETransaction').datagrid('appendRow',oPETransaction);
                    GetExecutions($('#divPP').data('ProductionSheet').ProductionSheetID);
                    //$('#tblProductionSteps').datagrid('selectRow',SelectedRowIndex);
                }
                else
                {
                    alert(oPETransaction.ErrorMessage);
                }

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
}

function RefreshObject()
{
    var oProductionExecution =  $('#tblProductionSteps').datagrid('getSelected');
    var oPETransaction={
        PETransactionID : 0,
        ProductionExecutionID:oProductionExecution.ProductionExecutionID,
        MeasurementUnitID:$('#divPP').data('ProductionSheet').UnitID,
        Quantity :parseInt(icsRemoveComma($('#txtExecutionQty').val())),
        CycleTime : parseInt(icsRemoveComma($('#txtCycleTime').val())),
        Cavity : parseInt(icsRemoveComma($('#txtCavity').val())),
        ShortCounter : parseInt(icsRemoveComma($('#txtShortCounter').val())),
        OperatorPerMachine: parseInt(icsRemoveComma($('#txtOperatorPerMachine').val())),
        ProductionHour  : parseFloat(icsRemoveComma($('#txtProductionHour').val())),
        Remarks:$('#txtRemarks').val(),
        OperationEmpID :$('#cboOperateBy').val(),
        ShiftID :$('#cboShift').val(),
        MachineID:$('#divPP').data('ProductionExecution').MachineID,
        MachineName:$('#txtMachineName').val(),
        TransactionDate : $('#txtExecutDate').datebox('getValue')
    }
    return oPETransaction;
}

function ValidateInput()
{
    //debugger;
    var oProductionExecution =  $('#tblProductionSteps').datagrid('getSelected');
    if(oProductionExecution==null || parseInt(oProductionExecution.ProductionExecutionID)<=0)
    {
        alert("Please select Step.!");
        return false;
    }
    if(parseInt(oProductionExecution.ProductionStepTypeInInt)==1)//molding type
    {
        if(parseInt(icsRemoveComma($('#txtCycleTime').val()))<=0)
        {
            $('#txtCycleTime').focus();
            $('#txtCycleTime').addClass("errorFieldBorder");
            alert('Cycle Time Should be Greater than 0');
            return false;
        }
        if(parseInt($('#divPP').data('ProductionExecution').MachineID)<=0)
        {
            $('#txtMachineName').focus();
            $('#txtMachineName').addClass("errorFieldBorder");
            alert('Please Select A Machine!');
            return false;
        }
        if(parseInt(icsRemoveComma($('#txtCavity').val()))<=0)
        {
            $('#txtCavity').focus();
            $('#txtCavity').addClass("errorFieldBorder");
            alert('Cavity Should be Greater than 0');
            return false;
        }
        if(parseInt(icsRemoveComma($('#txtShortCounter').val()))<=0)
        {
            $('#txtShortCounter').focus();
            $('#txtShortCounter').addClass("errorFieldBorder");
            alert('Shot Counter Should be Greater than 0');
            return false;
        }
        if(parseInt(icsRemoveComma($('#txtOperatorPerMachine').val()))<=0)
        {
            $('#txtOperatorPerMachine').focus();
            $('#txtOperatorPerMachine').addClass("errorFieldBorder");
            alert('Operator/Machine Should be Greater than 0');
            return false;
        }
        if(parseInt($('#cboOperateBy').val())<=0)
        {
            $('#cboOperateBy').focus();
            $('#cboOperateBy').addClass("errorFieldBorder");
            alert('Please Select Operate By.');
            return false;
        }      
        if(parseFloat(icsRemoveComma($('#txtProductionHour').val()))<=0)
        {
            $('#txtProductionHour').focus();
            $('#txtProductionHour').addClass("errorFieldBorder");
            alert('Please Enter Production Hour!');
            return false;
        }
        var nBalance = (parseFloat(parseFloat(icsRemoveComma($('#txtYetToProductionHour').val())).toFixed(2)) - parseFloat(parseFloat(icsRemoveComma($('#txtProductionHour').val())).toFixed(2)));
        if(nBalance<0)
        {
            nBalance = (nBalance * (-1));
            if(nBalance > 0.5)
            {
                $('#txtProductionHour').focus();
                $('#txtProductionHour').addClass("errorFieldBorder");
                alert('Production Hour Must Be Less Than Or Equal '+ parseFloat(parseFloat(icsRemoveComma($('#txtYetToProductionHour').val())).toFixed(2)));
                return false;
            }
        }

        
        if(parseInt($('#cboShift').val())<=0)
        {
            $('#cboShift').focus();
            $('#cboShift').addClass("errorFieldBorder");
            alert('Please Select Shift.');
            return false;
        }
        var sTransactionDate = $('#txtExecutDate').datebox('getValue');
        if(sTransactionDate == null || sTransactionDate == "")
        {
            $('#txtExecutDate').focus();
            $('#txtExecutDate').addClass("errorFieldBorder");
            alert('Invalid Execute Date! Please select Execute Date!');
            return false;
        }
    }

    if(parseInt(icsRemoveComma($('#txtExecutionQty').val()))<=0)
    {
        $('#txtExecutionQty').focus();
        $('#txtExecutionQty').addClass("errorFieldBorder");
        alert('Execution Qty Should be Greater than 0');
        return false;
    }
    debugger;
    if(parseInt(oProductionExecution.Sequence)==1)
    {
        var nFivePercentQty = parseInt(parseInt($('#divPP').data('ProductionSheet').Quantity)*5)/100;
        if(parseInt(icsRemoveComma($('#txtExecutionQty').val()))+parseInt(oProductionExecution.ExecutionQty)> parseInt(parseInt($('#divPP').data('ProductionSheet').Quantity)+nFivePercentQty))//include 5%
        {
            alert("Sorr, You can Total Execute "+parseInt(parseInt($('#divPP').data('ProductionSheet').Quantity)+nFivePercentQty)+" "+$('#divPP').data('ProductionSheet').UnitSymbol);
            return false;
        }
    }else
    {
        var oPriviousItem = GetPriviousItem(oProductionExecution.Sequence-1);
        var nCurrentStepQty = parseInt(icsRemoveComma($('#txtExecutionQty').val()))+parseInt(oProductionExecution.ExecutionQty);
        if(parseInt(nCurrentStepQty)>parseInt(parseInt(oPriviousItem.ExecutionQty)+1)) //extra 1 Use for fixing pricition. 
        {
            alert("Execution Qty Should be Less than or Equal Privious Step Qty.");
            return false;
        }
    }
   return true;
}

function Close()
{
    window.location.href = sessionStorage.getItem("BackLink");
}

$('#txtExecutDate').datetimebox({
    onSelect: function(date){
        GetYetToProductionHour(icsdatetimeformat(date));
    }
});


$("#cboShift").change(function() {
    var sTransactionDate = $('#txtExecutDate').datebox('getValue');
    if(sTransactionDate!=null && sTransactionDate !="")
    {
        GetYetToProductionHour(sTransactionDate);
    }
});

function GetYetToProductionHour(sTransactionDate)
{
    if(sTransactionDate != "" && parseInt($('#cboShift').val()) > 0 && parseInt($('#divPP').data('ProductionExecution').MachineID)>0)
    {
        var oPETransaction = {
            TransactionDate : sTransactionDate,
            ShiftID : parseInt($('#cboShift').val()),
            MachineID : parseInt($('#divPP').data('ProductionExecution').MachineID)
        };
    
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionExecution/GetYetToProductionHour",
            traditional: true,
            data:  JSON.stringify(oPETransaction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {            
                var nYetToProductionHour = jQuery.parseJSON(data);
                //$("#txtProductionHour").val(nYetToProductionHour);
                $("#txtYetToProductionHour").val(nYetToProductionHour);

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }
    else
    {
        $("#txtYetToProductionHour").val(0);
    }
}

</script>