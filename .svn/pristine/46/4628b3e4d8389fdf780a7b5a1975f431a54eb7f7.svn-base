@{
    ViewBag.Title = "Stock Report Simplified";
}
@model IEnumerable<ESimSol.BusinessObjects.ReportingObject.RptStockReportSimplified>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable" id="regionRptStockReportSimplified">
        <table id="tblRptStockReportSimplifieds" title="Stock Report Simplified" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" showfooter="true" autorowheight="false" toolbar="#toolbar" showfooter="true">
            <thead>
                <tr>
                    <th field="ProductName" width="8%">Product Name</th>
                    <th field="Brand" width="12%">Brand</th>
                    <th field="Code" width="10%">Code</th>
                    <th field="UseInProcesss" width="10%">Use In Process</th>
                    <th field="CategoryName" width="10%">Category</th>
                    <th field="ProductReceivedDateST" width="10%">Received Date</th>
                    <th field="LotNo" width="10%">Lot No</th>
                    <th field="StoreName" width="10%">Store Name</th>
                    <th field="ImportedQty" align="right" formatter="formatPrice" width="10%">Imported Qty</th>
                    <th field="OpeningQty" align="right" formatter="formatPrice" width="10%">Opening Qty</th>
                    <th field="PTTransferedQty" align="right" formatter="formatPrice" width="10%">PT-TransferedQty</th>
                    <th field="DyeingTransferdQty" align="right" formatter="formatPrice" width="10%">Dyeing-TransferedQty</th>
                    <th field="PrintingTransferedQty" align="right" formatter="formatPrice" width="10%">Printing-TransferedQty</th>
                    <th field="FinisingTransferedQty" align="right" formatter="formatPrice" width="10%">Finishing-TransferedQty</th>
                    <th field="PretreatmentUsage" align="right" formatter="formatPrice" width="10%">PT-Useage</th>
                    <th field="DyeingUsage" align="right" formatter="formatPrice" width="10%">Dyeing Usage</th>
                    <th field="ClosingQty" align="right" formatter="formatPrice" width="10%">Printing Usage</th>
                    <th field="FinisingUsage" align="right" formatter="formatPrice" width="10%">Finising Usage</th>
                    <th field="StockInMainStore" align="right" formatter="formatPrice" width="10%">Stock In Main Store</th>
                    <th field="StockInProductionFloor" align="right" formatter="formatPrice" width="10%">Stock In Production Floor/th>
                    <th field="StockValue" align="right" formatter="formatPrice" width="10%">Stock Value</th>
                    <th field="ManufacturingDateST" align="center" width="10%">Manufacturing Date</th>
                    <th field="ExpireyDateST" align="center"  width="10%">Expirey Date</th>
                    <th field="LotAge" align="right" formatter="formatPrice" width="10%">Lot Age</th>
                    <th field="UnitPrice" align="right" formatter="formatPrice" width="10%">Unit Price</th>
                    <th field="LCNo" align="right" formatter="formatPrice" width="10%">LC No</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
            <a id="btnExcel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Excel</a>
        </div>
    </div>
    <div id="winAdvSearch" class="easyui-window winClass" style="width:700px;" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table style="width:100%;">
            <tr>
                <td>
                    <fieldset style="margin-bottom: 0px;">
                        <legend>Searching Criteria</legend>
                        <table style="width:100%">
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Date: </label>
                                </td>
                                <td colspan="3" style=" width:80%;">
                                    <select id="cboDateAdvS" onchange="DateActionsOrderDateAdvSearch();" style=" width:90px;height:22px;"></select>
                                    <input id="txtDateStart" type="text" style="width: 95px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="txtStartTime" class="easyui-timespinner" style="width:60px;" required="required" />To
                                    <input id="txtDateEnd" type="text" style="width: 95px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="txtEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                </td>
                            </tr>
                            <tr>
                                <td height="5px" colspan="4"></td>
                            </tr>
                        </table>
                    </fieldset>
                </td>
            </tr>
        </table>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
            <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>
    <script type="text/javascript">
    debugger;
    var _oRptStockReportSimplifieds=[];
    var _sBaseAddress="";
    var _oCompareOperators=[];
    var _nBUID = [];
    $(document).ready(function () {
        debugger;
        _oRptStockReportSimplifieds =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oCompareOperators =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        sessionStorage.setItem("BUID",_nBUID);
        RefreshList(_oRptStockReportSimplifieds);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
    });

        function RefreshList(oRptStockReportSimplifieds)
        {
            debugger;
            var data=oRptStockReportSimplifieds;
            data={"total":""+data.length+"","rows":data};
            $('#tblRptStockReportSimplifieds').datagrid('loadData',data);
            $.icsMakeFooterColumn('tblRptStockReportSimplifieds',['ProductName','ImportedQty','OpeningQty','PTTransferedQty','DyeingTransferdQty','PrintingTransferedQty','FinisingTransferedQty','PretreatmentUsage','DyeingUsage','PrintgingUsage','FinishingUsage']);
        }
            function updateProgress() {
                var value =$('#progressbar').progressbar('getValue');
                if (value < 96){
                    value += Math.floor(Math.random() * 10);
                    $('#progressbar').progressbar('setValue', value);
                }
            }
            function hideShow(miliseconds) {
                $("#progressbarParent").hide();
            }

            $("#btnCloseAdvSearch").click(function () {
                $("#winAdvSearch").icsWindow("close");
            });
           
            $("#btnReset").click(function () {
                ResetAdvSearchWindow();
                DateActionsOrderDateAdvSearch();
            });

            $("#btnAdvSearch").click(function () {
                debugger;
                DynamicResetAdvSearchWindow("winAdvSearch");
                $("#cboDateAdvS").icsLoadCombo({List: _oCompareOperators,OptionValue: "id",DisplayText: "Value"});
                $(".lblLoadingMessage").hide();
                $("#winAdvSearch").icsWindow("open", " Advance Search");
                DynamicDateActions("cboDateAdvS", "txtDateStart", "txtDateEnd");
                $("#txtDateStart,#txtDateEnd").datebox("setValue", icsdateformat(new Date()));
                $('#txtStartTime,#txtEndTime').timespinner('setValue', "09:00");
                ResetAdvSearchWindow();
            });

            function ResetAdvSearchWindow() {
                $("#winAdvSearch input").not("input[type='button']").val("");
                $("#winAdvSearch input").removeClass("fontColorOfPickItem");
                $("#winAdvSearch select").val(0);
                DateActionsOrderDateAdvSearch();
                $("#txtDateStart,#txtDateEnd").datebox({ disabled: true });
                $("#txtDateStart,#txtDateEnd").datebox("setValue", icsdateformat(new Date()));
                $('#txtStartTime,#txtEndTime').timespinner('setValue', "09:00");
            }

            function DateActionsOrderDateAdvSearch() {
                DynamicDateActions("cboDateAdvS", "txtDateStart", "txtDateEnd");
            }

            $("#btnSearch").click(function () {
                debugger;
                var checkDate = CheckFromAndToDateValidation("cboDateAdvS", "txtDateStart", "txtDateEnd");
                if (!checkDate) {
                    alert("Start date must be greater than end date.");
                    return false;
                }

                var StartDate= $('#txtDateStart').datebox('getValue');
                var nhr=$('#txtStartTime').timespinner('getHours');
                var nmin=$('#txtStartTime').timespinner('getMinutes');
                var oStartDate=new Date(StartDate);
                oStartDate.setHours(oStartDate.getHours()+nhr);
                oStartDate.setMinutes(oStartDate.getMinutes()+nmin);
                oStartDate = icsdatetimeformat(oStartDate);

                //end datetime start
                var EndDate= $('#txtDateEnd').datebox('getValue');
                var nhr=$('#txtEndTime').timespinner('getHours');
                var nmin=$('#txtEndTime').timespinner('getMinutes');
                var oEndDate=new Date(EndDate);
                oEndDate.setHours(oEndDate.getHours()+nhr);
                oEndDate.setMinutes(oEndDate.getMinutes()+nmin);
                oEndDate = icsdatetimeformat(oEndDate);

                var sDispoNo = $('#txtDispoNo').val();
                var _sContractorIds = $('#txtBuyer').data('BuyerIDs');
                var nCboDate = parseInt($("#cboDateAdvS").val());
                var nFabicStock= parseInt($("#cboGreyFabricStock").val());
                var QCGradeIDs = $('#txtQCGrade').data('FabricQCGradeID');

                if(nCboDate==0){
                    alert("Please Select at least one criteria!");
                    return;
                }

                debugger;
                var sParams = nCboDate+'~'+oStartDate+'~'+oEndDate;
                sessionStorage.setItem("AdvSearchString", sParams);
                var oRptStockReportSimplified = {
                    ErrorMessage: sParams
                }
                $(".lblLoadingMessage").show();
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url:_sBaseAddress +"/RptStockReportSimplified/AdvSearch",
                    traditional: true,
                    data: JSON.stringify(oRptStockReportSimplified),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        var oRptStockReportSimplifieds = jQuery.parseJSON(data);
                        debugger;
                        if (oRptStockReportSimplifieds != null) {
                            if (oRptStockReportSimplifieds.length > 0){
                                DynamicRefreshList(oRptStockReportSimplifieds, "tblRptStockReportSimplifieds");
                                //$.icsMakeFooterColumn('tblRptStockReportSimplifieds',['OrderTypeSt','OpeningQty','QtyIn','QtyOut','ClosingQty']);
                                $("#winAdvSearch").icsWindow("close");
                            }else{
                                alert("Sorry, No data found.");
                            }

                        } else {
                            alert("Sorry, No data found.");
                        }
                        $(".lblLoadingMessage").hide();
                    }
                });

            });

            $('#btnExcel').click(function (e){
                debugger;
                var nDate = $('#cboDateAdvS').val();
                if(nDate<=0)
                {
                    alert("Please select any searching criteria!");
                    return;
                }
                var sParam = sessionStorage.getItem("AdvSearchString");
                var nts=(new Date()).getTime()/1000;
                window.open(_sBaseAddress+"/RptStockReportSimplified/StockReportSimplifiedExcel?sValue="+sParam+"&nts="+nts);
            });

            function CheckFromAndToDateValidation(OperationComboId, FromDateId, ToDateId) {
                $("#" + OperationComboId).parent().parent().parent().find("select").removeClass("errorFieldBorder");
                var nCboVal = $("#" + OperationComboId).val();
                if (parseInt(nCboVal) == 5 || parseInt(nCboVal) == 6) {
                    var fromDate = $("#" + FromDateId).datebox("getValue");
                    var toDate = $("#" + ToDateId).datebox("getValue");
                    if (new Date(fromDate) > new Date(toDate)) {
                        $("#" + ToDateId).focus();
                        $("#" + OperationComboId).addClass("errorFieldBorder");
                        $(".lblLoadingMessage").hide();
                        return false;
                    } else {
                        $("#" + OperationComboId).removeClass("errorFieldBorder");
                        return true;
                    }
                } else {
                    return true;
                }
            }
    </script>
