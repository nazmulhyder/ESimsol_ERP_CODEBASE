<!DOCTYPE html>
<html>
<head>

    <title>@ViewBag.Title</title>

    <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
    @*<script src="@Url.Content("~/Scripts/jquery-2.2.4.min.js")" type="text/javascript"></script>*@
    <script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.ics.customize.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.easyui.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/datagrid-detailview.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/jquery.flot.animator.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.flot.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.flot.orderBars.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.flot.pie.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.ics.plugins.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/linq-ics.js")" type="text/javascript"></script>
    @*<script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.js")" type="text/javascript"></script>*@
    <script src="@Url.Content("~/Scripts/jgoogleAPI.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.autocomplete.min.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/angular.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/angular-animate.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/angular-ui/ui-bootstrap-tpls.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/bootstrap.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/ui-grid.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/moment.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/angular-material.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/angular-material.min.js")" type="text/javascript"></script>
    @*<script src="@Url.Content("~/Scripts/angular-aria.min.js")" type="text/javascript"></script>*@

    <script src="@Url.Content("~/Scripts/bootstrap-datepicker.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-datetimepicker.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/datetime-picker.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/Date-Format-1.2.3.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/angular-ics.js")" type="text/javascript"></script>
    
    <script src="@Url.Content("~/Scripts/color-picker.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.2.1.min.js")" type="text/javascript"></script>
    <script src="~/signalr/js"></script>

    <link href="@Url.Content("~/Content/Site.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/icon.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/mainstyle.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/easyui.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/notification.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/angular-csp.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/bootstrap.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/bootstrap-theme.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/ui-bootstrap-csp.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/ui-grid.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/bootstrap-datepicker.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/color-picker.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/angular-material.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/angular-material.min.css")" rel="stylesheet" type="text/css" />
</head>
<body>
    @{var CurrentUser = HttpContext.Current.Session[SessionInfo.CurrentUser];}
    @{var MenuList = HttpContext.Current.Session[SessionInfo.Menu];}
    @{var MenuID = HttpContext.Current.Session[SessionInfo.MenuID];}
    @if (CurrentUser == null)
    {
        CurrentUser = HttpContext.Current.Session[SessionInfo.CurrentUser];
        MenuList = HttpContext.Current.Session[SessionInfo.Menu];
        MenuID = HttpContext.Current.Session[SessionInfo.MenuID];
    }

    <div class="MainBody">
        <div id="AppMainLayout" class="easyui-layout" style="height:660px">
            <div region="north" split="false" style="width:100%;height:65px; background-color:#CFB53B">
                <table border="0" cellspacing="0" cellspacing="0" width="100%">
                    <tr style="height:60px">
                        <td style="width:20%; background-color:white">
                            <img id="imgCompanyLogo" src="@Url.Action("GetCompanyLogo", "Company", new { id = 1 })" alt="Company Logo" style="width:250px; height:55px; margin-left:10px" />
                        </td>
                        <td style="width:52%; text-align:center; font-weight:bold; font-size: xx-large; margin-right:50px">
                            <div style="font-weight:bold; font-size: 22px; margin-right:50px; color:White">
                                Welcome To ESimSol
                            </div>
                        </td>
                        <td style="width:8%; text-align:center; font-weight:bold; font-size:12px; margin-right:5px; margin-bottom:5px; color:white">
                            @*@Html.ActionLink("Back to Home", "Index", "Home")*@
                        </td>
                        <td style="width:5.5%;">
                            <span id="notification_count"></span>
                            <a id="notificationLink" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-notification" plain="true"></a>
                            <div id="notificationContainer">
                                <div id="notificationTitle">Notifications</div>
                                <div id="notificationsBody"></div>
                                <div id="notificationFooter"><a id="LinkSeeAll" href="#">See All</a></div>
                            </div>
                        </td>
                        <td style="width:9.5%;">
                            <div style="font-family: Tahoma; text-align:left;">
                                <a href="#" class="easyui-menubutton" data-options="menu:'#menu'" onmouseover="this.style.color='#190707'" onmouseout="this.style.color='#FFFFFF'" style="font-weight:bold; color:White"><label id="lblUserName"></label></a>
                            </div>
                            <div id="menu" style="font-family: Tahoma; width:50px;">
                                <div>@Html.ActionLink("Change Password", "ChangePassword", "User")</div>
                                <div>@Html.ActionLink("Logout", "LogOut", "User") </div>
                            </div>
                        </td>
                        <td>
                            <div style="width:5%;">
                                <a id="DocumentLink" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-help" plain="true"></a>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div region="west" split="true" title="Menu Bar" style="width:262px;">
                @if (Model != null)
                {
                    <div style="height:100%; overflow:auto">
                        <ul id="tt"></ul>
                    </div>
                }
            </div>
            <div region="center" style="width:100%; height:576px">
                <div id="icsprogressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
                    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:550px;">
                        <label style="font-size:18px;">Please wait</label>
                        <div id="icsprogressbar" style="width:100%;height:37px;"></div>
                    </div>
                </div>
                @RenderBody()
            </div>
            <div region="south" style="height:24px; width:100%; background-color:#CFB53B; text-align:center; color:White; font-weight:bold; font-size:12px">
                <a id="LinkICSInfo" href="http://www.infocratsolutions.com" style="text-align:center; font-size:12px" target="_blank"> www.infocratsolutions.com</a>
                <span style="margin-left:20px; font-size:small">© 2012 Infocrat Solutions Ltd.</span>
            </div>
        </div>
    </div>

</body>

</html>
<style type="text/css">

</style>
<script type="text/javascript">

    var _oNotifications=[];
    var _sBaseAddress="";
    $(document).ready(function () {
        ProgressBarHide();
        //debugger;
        
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oUserMenu=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(MenuList));
        var oCurrentUser= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(CurrentUser));
        var menuid= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(MenuID));
        $('#MainLayout').layout('collapse', 'west');
        $('#MainLayout').layout('expand', 'west');
        $('#MainLayout').layout('collapse', 'west');
        $('#MainLayout').layout('expand', 'west');
        //sessionStorage.clear();
        //sessionStorage.setItem("SelectedRowIndex",-1);

        if(oCurrentUser!=null)
        {
            //SetNotification();
            if(oCurrentUser.UserName!="")
            {
                document.getElementById('lblUserName').innerHTML =" "+ oCurrentUser.UserName;
            }
            else
            {
                document.getElementById('lblUserName').innerHTML = " ";
            }
        }


        if(oUserMenu!=null)
        {
            $('#tt').tree({
                data: [oUserMenu]
            });

            $('#tt').tree({
                onClick: function (node) {
                    if(node.attributes!="")
                    {
                        //node.attributes has two part first part is ControllerName & second part ActionName;
                        var ControllerName=node.attributes.split('~')[0];
                        var ActionName=node.attributes.split('~')[1];
                        if(ActionName!='aaa')
                        {
                            debugger;
                            var sparam='?';
                            if(ActionName.split('?').length>1)sparam='&'
                            sessionStorage.clear();
                            sessionStorage.setItem("SelectedRowIndex", -1);
                            if(_sBaseAddress==null){_sBaseAddress='';}
                            sessionStorage.setItem('BaseAddress', _sBaseAddress);
                            sessionStorage.setItem('MenuID', node.id);
                            sessionStorage.setItem('BUID', node.BUID);
                            sessionStorage.setItem('ProductNature', 0);
                            sessionStorage.setItem('IsSuperUser', oCurrentUser.IsSuperUser);
                            if(!node.IsActive) {
                                alert("You don't have enough permission to access this menu. Please contact with vendor.");
                                return;
                            }

                            if(node.IsWithBU)
                            {
                                window.location.href =  _sBaseAddress +'/'+ControllerName+'/'+ActionName+sparam+'buid='+node.BUID+'&menuid='+node.id;
                            }else{
                                window.location.href =  _sBaseAddress +'/'+ControllerName+'/'+ActionName+sparam+'menuid='+node.id;
                            }
                        }
                        else
                        {                            
                            if(node.state == "closed")
                            {
                                $('#tt').tree('expand', node.target);
                            }
                            else
                            {
                                $('#tt').tree('collapse', node.target);
                            }
                        }
                    }
                }
            });
            if(!isNaN(menuid))
            {
                if(menuid!=null)
                {
                    var node = $('#tt').tree('find', menuid);
                    $('#tt').tree('expandTo', node.target);
                    $('#tt').tree('select', node.target);
                }
            }
        }


        $("#notificationLink").click(function(){
            $.ajax({
                type: "POST",
                dataType: "json",
                url: '@Url.Action("GetsNotifications", "HumanInteractionAgent")',
                data:  JSON.stringify(),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    _oNotifications = jQuery.parseJSON(data);
                    if(_oNotifications.length>0)
                    {
                        if(_oNotifications[0].ErrorMessage=="")
                        {
                            var notificationsBodydiv =document.getElementById('notificationsBody');
                            notificationsBodydiv.innerHTML=DispalyNotification(_oNotifications);
                            notificationsBodydiv.scrollTop =0;
                        }
                    }
                    $("#notificationContainer").fadeToggle(300);
                    $("#notification_count").fadeOut("slow");
                    return false;
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        //Document Click hiding the popup
        $(document).click(function(){
            $("#notificationContainer").hide();
        });

        //Popup on click
        $("#notificationContainer").click(function(){
            return false;
        });

        $("#LinkSeeAll").click(function(){
            $("#notificationContainer").hide();
            var url = _sBaseAddress+"/HumanInteractionAgent/ViewNotifications";
            var oParameter=null;
            var nLeft=(window.screen.width/2)-(600/2);
            var nHeight=(window.screen.height/2)-(550/2);
            //window.showModalDialog(url, oParameter, 'dialogHeight:550px;dialogWidth:600px;dialogLeft:'+nLeft+';dialogTop:'+nHeight+';center:yes;resizable:no;status:no;scroll:yes');
            window.location.href =  _sBaseAddress +'/HumanInteractionAgent/ViewNotifications';
        });

        LoadBasicEventsFromLayout(); // Declear in jquery.ics.plugins.js

        //$("#divLoading").hide();
        //SetCanvasMaxZIndex();
        //LoadingCanvas();
    });

    function SetNotification()
    {

        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Action("SetNotification", "HumanInteractionAgent")',
            data:  JSON.stringify(),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var  nNotificationCount = jQuery.parseJSON(data);
                if(parseInt(nNotificationCount)>0)
                {
                    document.getElementById("notification_count").innerHTML=nNotificationCount.toFixed();
                }
                else
                {
                    document.getElementById("notification_count").innerHTML="";
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function DispalyNotification(oNotifications)
    {
        var sHTML="";
        for(var i=0; i<oNotifications.length; i++)
        {
            if(oNotifications[i].IsRead==true)
            {
                sHTML=sHTML+"<div onclick='NitificationRead("+oNotifications[i].HIAID+")' class='notifications' onmouseover=this.style.background='#D8D8D8'; onmouseout=this.style.background='white'><p>"+ oNotifications[i].SetupName+ " "+ SetApprovedButton(oNotifications[i].HIAID, oNotifications[i].LinkReference) +"<input type='image' src='@Url.Content("~/Content/CSS/icons/read.png")' value=''/></p>"+oNotifications[i].MessageBodyText+"</div>";
            }
            else
            {
                sHTML=sHTML+"<div onclick='NitificationRead("+oNotifications[i].HIAID+")' class='notifications' onmouseover=this.style.background='#D8D8D8'; onmouseout=this.style.background='white'><p>"+ oNotifications[i].SetupName+ " "+ SetApprovedButton(oNotifications[i].HIAID, oNotifications[i].LinkReference) +"</p>"+oNotifications[i].MessageBodyText+"</div>";
            }
        }
        return sHTML;
    }


    function SetApprovedButton(nHIAID, sLinkReference)
    {
        var sApprovedButton="";
        if(sLinkReference!="")
        {
            sApprovedButton = "<input type='image' src='@Url.Content("~/Content/CSS/icons/approved.png")' onclick='Approved("+nHIAID+")' value=''/>";
        }
        return sApprovedButton;
    }

    function NitificationRead(nNotificationID)
    {
        var oHIA ={HIAID:nNotificationID};
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Action("UpdateRead", "HumanInteractionAgent")',
            data:  JSON.stringify(oHIA),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function Approved(nHIAID)
    {

        var oHIA = GetHIA(nHIAID);

        //alert("ID :"+oHIA.HIAID + " Reference Link : "+oHIA.LinkReference+ " Height : "+ oHIA.View_Hight+ " width : "+ oHIA.View_Wight);
        var oParameter = new Object();
        oParameter.Operation="MgtEdit";
        var tsv=((new Date()).getTime())/1000;
        var url = _sBaseAddress+"/"+oHIA.LinkReference+"?nid="+oHIA.OperationObjectID;
        window.showModalDialog(url, oParameter, 'dialogHeight:'+oHIA.View_Hight+'px;dialogWidth:'+oHIA.View_Wight+';dialogLeft:300;dialogTop:80;center:yes;resizable:yes;WorkOrderStatus:no;scroll:no');
    }

    function GetHIA(nHIAID)
    {
        for(var i=0; i<_oNotifications.length; i++)
        {
            if(nHIAID==_oNotifications[i].HIAID)
            {
                return _oNotifications[i];
            }
        }
        return null;
    }
    function readURL(input)
    {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#imgCompanyLogo')
                .attr('src', e.target.result)
                .width(150)
                .height(100);
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

    $("#DocumentLink").click(function(){
        sBaseAddress="/sm";        
        var url=window.location.href;
        url=url.split('?')[0];
        url=url.split('/');
        var ActionName=url[url.length-1];
        var ControllerName=url[url.length-2];
        var tsv=((new Date()).getTime())/1000;
        window.open(sBaseAddress+"/DocMenu/ViewDocumentReader?menuID=0&ptype=2&surl="+ControllerName+"/"+ActionName+"&ts="+tsv, '_blank');
    });

    $(document).unbind('keydown').bind('keydown', function (event) {
        if (event.keyCode === 8) {
            var doPrevent = true;
            var types = ["text", "password", "file", "search", "email", "number", "date", "color", "datetime", "datetime-local", "month", "range", "search", "tel", "time", "url", "week"];
            var d = $(event.srcElement || event.target);
            var disabled = d.prop("readonly") || d.prop("disabled");
            if (!disabled) {
                if (d[0].isContentEditable) {
                    doPrevent = false;
                } else if (d.is("input")) {
                    var type = d.attr("type");
                    if (type) {
                        type = type.toLowerCase();
                    }
                    if (types.indexOf(type) > -1) {
                        doPrevent = false;
                    }
                } else if (d.is("textarea")) {
                    doPrevent = false;
                }
            }
            if (doPrevent) {
                event.preventDefault();
                return false;
            }
        }
    });


</script>