@{
    ViewBag.Title = "Add Order Setup";
}
@model ESimSol.BusinessObjects.MachineType

<div style="padding-top:5px" ng-app="MachineTypeAPP" ng-controller="MachineTypeCtrl" class="form-horizontal regionMachineType">
    <div class="ui-grid-top-panel panel-danger" style="height:50px; padding:10px 0 0 10px">
        <div class="col-md-2 text-right"><label class="control-label">Business Unit:</label></div>
        <div class="col-md-3 text-left">
            <select id="cboMachineType" ng-model="MachineType.BUID" ng-options="obj.BusinessUnitID as obj.ShortName for obj in BusinessUnits" ng-disabled="BU_disabled || disabled" class="form-control">
                <option value="">--Select Unit--</option>
            </select>
        </div>
    </div>
    <div>
    <fieldset>
        <legend>Machine Info</legend>
        <div class="col-md-7">
            <div class="row col-md-12" style="padding-top:50px">
                @*<div class="col-md-2 text-right"><label class="control-label">Order Type:</label></div>
                <div class="col-md-3 text-left">
                    <select id="cboOrderType" ng-model="MachineType.DyeingStepType" ng-options="obj.id as obj.Value for obj in DyeingStepTypes" ng-disabled="disabled" class="form-control"></select>
                </div>*@
                <div class="col-md-2 text-right"><label class="control-label">Name:</label></div>
                <div class="col-md-10 text-left">
                    <input ng-model="MachineType.Name" ng-disabled="disabled" class="form-control" placeholder="Machine Name.." required />
                </div>
            </div>
      
            <div class="row col-md-12" style="padding-bottom: 50px">
            <div class="col-md-2 text-right"><label class="control-label">Note:</label></div>
            <div class="col-md-10 text-left">
                <input ng-model="MachineType.Note" ng-disabled="disabled" class="form-control" />
            </div>
        </div>
        </div>
        <div class="col-md-5">
            <fieldset>
                <legend> Module </legend>
                <div class="ui-grid-top-panel">
                    <div class="col-md-12">
                        @*<select ng-model="ModlueID" ng-options="obj.id as obj.Value for obj in Modules" ng-disabled="disabled" class="form-control">
                            <option value="">--Select Unit--</option>
                        </select>*@
                        <button class="btn btn-sm btn-primary" ng-click="AddModule()">Add</button>
                        <button class="btn btn-sm btn-danger" ng-click="RemoveModule()">Remove</button>
                    </div>
                </div>
                <div ui-grid="gridOptions" ui-grid-selection ui-grid-resize-columns ui-grid-edit ui-grid-row-edit class="grid ui-grid-selectable"></div>
            </fieldset>
        </div>
    </fieldset>
   
    <fieldset>
        <legend>Action</legend>
        <div class="row col-md-12 text-right">
            <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save()" ng-hide="hide_Save"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Save</span> </button>
            <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
        </div>
    </fieldset>
    </div>
</div>


<style type="text/css">

    .grid{
        width:100%; 
        height:320px;
    }
    .regionMachineType .form-horizontal .control-label{
        padding-top:3px;
    }
    .regionMachineType .form-control{
        height:26px;
        padding:0px 6px;
        font-size:12px;
    }
    .regionMachineType .col-md-12{
        width:100%;
        padding-right:5px;
        padding-left:5px;
        margin-bottom:5px;
    }
    .regionMachineType .col-md-2{
        width:13%;
        padding-right:5px;
        padding-left:5px;
    }
    .regionMachineType .col-md-3{
        width:20%;
        padding-right:5px;
        padding-left:5px;
    }

    .regionMachineType .col-md-4{
        width:28%;
        padding-right:5px;
        padding-left:5px;
    }

    .regionMachineType .col-md-5{
        width:40%;
        padding-right:5px;
        padding-left:0px;
    }

     .regionMachineType .col-md-10{
        width:86%;
        padding-right:5px;
        padding-left:5px;
    }
    .regionMachineType .btn-sm{
         padding:3px 10px;
     }
     .regionMachineType .input-group-addon{
         padding: 4px 8px;
     }
</style>

<script type="text/javascript">

    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    var oMachineType =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var MachineTypeModule = angular.module('MachineTypeAPP', ['ngAnimate', 'ui.bootstrap', 'ui.grid', 'ui.grid.selection', 'ui.grid.edit','ms.service']);
    var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
    var oBusinessUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BusinessUnits));
    var oModules = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Modules));

    MachineTypeModule.controller('MachineTypeCtrl', function ($scope, $http, $uibModal, $log, uiGridConstants, msModal, userSession) {
        debugger;

        var viewType = sessionStorage.getItem("Operation");

        if (viewType == 'View')
        {
            $scope.MachineType.BUID=nBUID;
        }
        else if (viewType == 'View')
        {
            $scope.disabled= true;
            $scope.hide=true;

            $scope.hide_Approve=true;
            $scope.hide_Save=true;
        }
        else  if (viewType == 'Approve')
        {
            $scope.disabled= true;
            $scope.hide=true;
            $scope.hide_Save=true;
        }
        else
        {
            $scope.disabled= false;
            $scope.hide=false;
            $scope.hide_Save=false;
            //
        }

        $scope.Modules=oModules;
        $scope.MachineType=oMachineType;
        $scope.BusinessUnits=oBusinessUnits;

        if(nBUID>0)
        {
            $scope.BU_disabled=true;
        }
        $scope.MakeLabdipChallanDetail= function()
        {
            debugger;
            var oDetailColumns = [];
            var oColumn = { field: 'Value', name:'ModuleName', width:'100%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);

            $scope.gridOptions = {
                enableRowSelection: true,
                enableRowHeaderSelection: false,
                multiSelect: false,
                enableColumnResizing: true,
                showColumnFooter: false,
                enableHorizontalScrollbar: uiGridConstants.scrollbars.NEVER,
                columnDefs:oDetailColumns,
                data:  $scope.MachineType.Modules,
                onRegisterApi: function (gridApi)
                {
                    $scope.gridDetailApi = gridApi;
                }
            };

            //var oLabdipChallanDetails=$scope.LabdipChallan.LabdipChallanDetails;
            // $scope.gridOptionsLabdipChallanDetail.data=[];
            // $scope.gridOptionsLabdipChallanDetail.data= $scope.LabdipChallan.LabdipChallanDetails;
        }
        $scope.MakeLabdipChallanDetail();

        $scope.AddModule=function()
        {
            var modalObj={
                size: 'md',
                title:" Module List ",
                url:_sBaseAddress+'/Home/Modal',
                modalController:'ContractorModalCtrl',
                appController:'MachineTypeCtrl',
                objs:$scope.Modules,
                multiSelect:true,
                columns:[{ field: 'Value', name:'ModuleName', width:'100%',cellClass: 'text-left', enableCellEdit:false }],
                searchingbyfieldName:'Value',
                searchbyfieldName:'Search By Module Name',
            }

            var modalInstance=msModal.Instance(modalObj);
            modalInstance.result.then(function (result)
            {
                if(result!=undefined && result.length>0)
                {
                    for(var i=0;i<result.length;i++)
                    {
                        if(!chkDuplicate(result[i].id, $scope.gridOptions.data))
                        {
                            $scope.gridOptions.data.push(result[i])
                        }
                    }
                }
            },
            function ()
            {$log.info('Modal dismissed at: ' + new Date());});
        }
        function chkDuplicate(nPID,oList)
        {
            debugger;
            if(nPID<=0 || oList==undefined)
                return false;
            for(var i=0;i<oList.length;i++)
            {
                if(oList[i].LabDipDetailID==nPID)
                {
                    return true;
                }else false;
            }
        }
        $scope.RemoveModule= function ()
        {
            var oDetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            //var data=$scope.gridApi.selection.getSelectedRows();
            if(oDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptions.data.indexOf(oDetail);
            if (!confirm("Confirm to Remove?")) return ;
            $scope.gridOptions.data.splice(SelectedRowIndex,1); alert("Delete Successfully.");return;
        }

        $scope.save = function () {
            debugger;

            var oModuleIDs=""
            for(var i=0;i<$scope.gridOptions.data.length;i++)
            {
                if(i==0)oModuleIDs=$scope.gridOptions.data[i].id;
                else oModuleIDs+=","+$scope.gridOptions.data[i].id;
            }

            $scope.MachineType.ModuleIDs=oModuleIDs;
            
            $http.post(_sBaseAddress+'/MachineType/Save',JSON.stringify($scope.MachineType)).then(
                             function (response) {
                                 var result=jQuery.parseJSON(response.data);
                                 if(result.MachineTypeID>0)
                                 {
                                     debugger;
                                     alert('Save Successfully.');
                                     $scope.MachineType=result;
                                     userSession.setData('MachineTypes',$scope.MachineType);
                                     userSession.previousPage();
                                     // msModal.Message({headerTitle : '', bodyText:'Save Successfully.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                 }
                                 else
                                 {
                                     alert(result.ErrorMessage);
                                 }

                             },
                             function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                       );
        };
        $scope.close = function () {
            userSession.previousPage();
        };
    });

</script>


