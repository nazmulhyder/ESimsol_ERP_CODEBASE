<html>
@{
    ViewBag.Title = "View Loan";
}
<body>
    @model ESimSol.BusinessObjects.Loan

    <div class="menuMainCollectionTable" style="width:100%; height:99%;">
        <div id="divLoan" class="easyui-panel" title="Add Loan" style="margin-left: 0px; height:90%; width:100%; overflow:auto;">
            <div id="FinanceLoanDetails" style="width:100%;border:1px solid black;">
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold; text-align:center; width:100%">
                    <tr>
                        <td colspan="6" style="height:7px;"></td>
                    </tr>
                    <tr>
                        <td style="width:12%; text-align:right">File No :</td>
                        <td style="width:11%; text-align:left">
                            <input type="text" style="width: 100%" id="txtFileNo" placeholder="Auto Generated" disabled />
                        </td>
                        <td style="width:11%; text-align:right"> Loan Type :</td>
                        <td style="width:11%; text-align:left">
                            <select id="cboLoanType" style="width:100%;"></select>
                        </td>
                        <td style="width:11%; text-align:right">Loan No :</td>
                        <td style="width:42%; text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                                <tr>
                                    <td style="width:50%">
                                        <input type="text" style="width:100%" id="txtLoanNo" />
                                    </td>
                                    <td style="width:10%; text-align:right">
                                        B Unit :
                                    </td>
                                    <td style="width:40%">
                                        <select id="cboBU" style="width: 100%"></select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:12%;text-align:right">Issue Date :</td>
                        <td style="width:11%;text-align:left">
                            <input id="txtIssueDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:11%;text-align:right"> Loan Ref :</td>
                        <td style="width:11%;text-align:left">
                            <select id="cboLoanRef" style="width:100%;" disabled></select>
                        </td>
                        <td style="width:11%;text-align:right">
                            <span id="spanImportOrExportRefNo">ExportLC :</span>
                        </td>
                        <td style="width:42%;text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                                <tr>
                                    <td style="width:75%">
                                        <input type="text" style="width:100%;" id="txtImportOrExportRefNo" />
                                    </td>
                                    <td style="width:12%">
                                        <input type="button" style="width:100%; font-weight:bold" id="btnCancel" value="C" />
                                    </td>
                                    <td style="width:13%">
                                        <input type="button" style="width: 100%; font-weight: bold" id="btnPick" value="Pick" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <tr>
                        <td style="width:12%;text-align:right">Loan Start Date :</td>
                        <td style="width:11%;text-align:left">
                            <input id="txtLoanStartDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:11%;text-align:right">Sattlement Start :</td>
                        <td style="width:11%;text-align:left">
                            <input id="txtStlmtStartDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:11%;text-align:right">Principle Amount :</td>
                        <td style="width:42%;text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width:10%;"><input type="text" style="text-align:left;width:100%;" id="txtPrincipalAmountCurSymbol" disabled /></td>
                                    <td style="width:34%;"><input type="text" style="text-align: right;width:100%;" id="txtPrincipalAmount" disabled /></td>
                                    <td style="width:12%;"><input type="text" style="text-align: right;width:100%;" id="txtPrincipalAmountCRate" disabled /></td>
                                    <td style="width:34%;"><input type="text" style="text-align: right;width:100%;" id="txtPrincipalAmountBC" value="0.00" disabled /></td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <tr>
                        <td style="width:12%;text-align:right">Approx Settlement :</td>
                        <td style="width:11%;text-align:left">
                            <input id="txtApproxDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:11%;text-align:right">Interest Rate :</td>
                        <td style="width:11%;text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="width:50%">
                                        <input type="text" style="width:100%;text-align: right;" id="txtInterestRate" />
                                    </td>
                                    <td style="width:50%">
                                        <input type="text" style="width:100%" id="txtInterestdisabled" placeholder="%/Year" disabled />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:11%;text-align:right">Loan Amount :</td>
                        <td style="width:42%;text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width:10%;"><select id="cboLoanCurrency" style="width:100%;"></select></td>
                                    <td style="width:34%;"><input type="text" style="width:100%;text-align: right;" id="txtLoanAmount" /></td>
                                    <td style="width:12%;"><input type="text" style="width:100%;text-align: right;" id="txtLoanCRate" value="0.00" disabled /></td>
                                    <td style="width:34%;"><input type="text" style="width:100%;text-align: right;" id="txtLoanAmountInBC" value="0.00" disabled /></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:12%;text-align:right">Rcv Date :</td>
                        <td style="width:11%;text-align:left">
                            <input id="txtRcvDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:11%;text-align:right">Libor Rate :</td>
                        <td style="width:11%;text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="width:50%">
                                        <input type="text" style="width:100%; text-align:right;" id="txtLibor" disabled />
                                    </td>
                                    <td style="width:50%">
                                        <input type="text" style="width:100%" id="txtLibordisabled" placeholder="%/Year" disabled />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:11%;text-align:right">Loan Compound :</td>
                        <td style="width:42%;text-align:left">
                            <select id="cboLoanCompound" style="width:100%;"></select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:12%;text-align:right">Approx IR Amount:</td>
                        <td style="width:11%;text-align:left">
                            <input type="text" style="width:100%;text-align:right; text-align:right;" id="txtAppIRAmount" disabled />
                        </td>
                        <td style="width:11%;text-align:right">Process Fee(%) :</td>
                        <td style="width:11%;text-align:left">
                            <input type="text" style="width:100%;text-align:right; text-align:right;" id="txtProcessFeePercent" />
                        </td>
                        <td style="width:11%;text-align:right">Rcv Bank A/C :</td>
                        <td style="width:42%;text-align:left">
                            <select id="cboRcvBankAC" style="width:100%;"></select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:12%;text-align:right">Approx Settle Amount :</td>
                        <td style="width:11%;text-align:left">
                            <input type="text" style="width:100%;text-align:right; text-align:right;" id="txtAppSattleAmount" disabled />
                        </td>
                        <td style="width:11%;text-align:right">Process Fee :</td>
                        <td style="width:11%;text-align:left">
                            <input type="text" style="width:100%;text-align:right; text-align:right;" id="txtProcessFeeAmount" />
                        </td>
                        <td style="width:11%;text-align:right">Remarks :</td>
                        <td style="width:42%;text-align:left">
                            <input type="text" style="width:100%" id="txtRemarks" />
                        </td>
                    </tr>
                </table>
            </div>

            <div id="tabLoanTabs" class="easyui-tabs" style="width:100%; height:280px;">
                <div id="InstallmentDetails" title="Loan Installment" style="width:95%;margin-left:0px;">
                    <table id="tblInstallment" class="easyui-datagrid" style="height:245px; width:100%" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarInstallment">
                        <thead>
                            <tr>
                                <th field="InstallmentNo" width="8%">Installment</th>
                                <th field="InstallmentDateInString" width="7%">Installment DT</th>
                                <th field="PrincipalAmountSt" width="10%" align="right">Principle Amount</th>
                                <th field="InstallmentStartDateInString" width="7%">Start Date</th>
                                <th field="LoanTransferTypeSt" width="9%" align="center">Turf Type</th>
                                <th field="TransferDateInString" width="9%" align="center">Turf Date</th>
                                <th field="TransferDaysSt" width="9%" align="center">Turf Days</th>
                                <th field="TransferInterestRateSt" width="10%" align="right">Turf Rate</th>
                                <th field="TransferInterestAmountSt" width="12%" align="right">Turf IR Amount</th>
                                <th field="SettlementDateInString" width="9%" align="center">Settlement Date</th>
                                <th field="InterestRateSt" width="10%" align="right">Interest Rate</th>
                                <th field="InterestDaysSt" width="9%" align="center">Interest Days</th>
                                <th field="InterestAmountSt" width="10%" align="right">Interest Amount</th>
                                <th field="LiborRateSt" width="9%" align="right">Libor Rate</th>
                                <th field="LiborInterestAmountSt" width="10%" align="right">Libor IR Amount</th>
                                <th field="TotalInterestAmountSt" width="10%" align="right">Total Interest</th>
                                <th field="ChargeAmountSt" width="9%" align="right">Charge Amount</th>
                                <th field="DiscountPaidAmountSt" width="9%" align="right">Discount(Paid)</th>
                                <th field="DiscountRcvAmountSt" width="9%" align="right">Discount(Rcv)</th>
                                <th field="TotalPayableAmountSt" width="10%" align="right">Payable Amount</th>
                                <th field="PaidAmountSt" width="9%" align="right">Paid Amount</th>
                                <th field="PrincipalBalanceSt" width="9%" align="right">Balance Amount</th>
                                <th field="SettlementByName" width="10%">Settle By</th>
                            </tr>
                        </thead>
                    </table>
                    <div id="toolbarInstallment">
                        <table>
                            <tr>
                                <td style="width:10%;text-align:right" class="TermLonCls">No of Installment :</td>
                                <td style="width:15%;text-align:left" class="TermLonCls">
                                    <input type="text" style="width:98%; text-align:right;" id="txtInstallmentNo" />
                                </td>
                                <td style="width:5%;text-align:right" class="TermLonCls">Cycle:</td>
                                <td style="width:10%;text-align:left" class="TermLonCls">
                                    <select id="cboCycle" style="width:100%;"></select>
                                </td>
                                <td style="width:9%;text-align:right" class="TermLonCls">Start Date :</td>
                                <td style="width:11%; text-align: left" class="TermLonCls">
                                    <input id="txtStartDate" type="text" class="easyui-datebox" style="width: 80%;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                                <td style="width:7%;text-align:left" class="TermLonCls">Amount :</td>
                                <td style="width:11%;text-align:left" class="TermLonCls">
                                    <input type="text" style="width:100%; text-align:right;" id="txtAmountNo" />
                                </td>
                                <td style="width:7%;text-align:right" class="TermLonCls">
                                    <input type="button" style="width:98%" id="btnCalculate" value="Calculate" />
                                </td>
                                <td style="width:7%;text-align:left;">
                                    <input type="button" style="width:80px;" class="GeneralCls" id="btnAddSettlement" value="Add" />
                                    <input type="button" style="width:80px;" class="GeneralCls" id="btnEditSettlement" value="Edit" />
                                    <input type="button" style="width:80px;" class="GeneralCls" id="btnViewSettlement" value="View" />
                                    <input type="button" style="width:80px;" class="GeneralCls" id="btnRemoveSettlement" value="Remove" />
                                    <input type="button" style="width:80px;" class="GeneralCls" id="btnApprovedSettlement" value="Approved" />
                                </td>

                            </tr>
                        </table>
                    </div>
                </div>
                <div id="divLoanInterest" title="Loan Interest" style="width:95%;margin-left:0px;">
                    <table id="tblLoanInterest" class="easyui-datagrid" style="height:245px; width:100%" rownumbers="true" showfooter="true"  pagination="false" singleselect="true" autorowheight="false">
                        <thead>
                            <tr>
                                <th field="InterestTypeSt" width="8%">Interest Type</th>
                                <th field="InterestStartDateSt" width="7%">Start Date</th>
                                <th field="InterestEndDateSt" width="7%">End Date</th>
                                <th field="InterestEffectDateSt" width="7%">Effect Date</th>
                                <th field="InterestDays" width="5%" align="right">Days</th>
                                <th field="LoanAmountSt" width="10%" align="right">Loan Amount</th>
                                <th field="InterestRateSt" width="10%" align="right">Interest Rate</th>
                                <th field="InterestAmountSt" width="10%" align="right">Int. Amount</th>
                                <th field="CurrencySymbol" width="5%">Currency</th>
                                <th field="CRateSt" width="10%" align="right">CRate</th>
                                <th field="InterestAmountBCSt" width="10%" align="right">Int. Amount(BC)</th>
                                <th field="EntryUserName" width="7%">Entry User</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            
        </div>
        <div style="width:100%; height:10%">
            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold; width:100%;">
                    <tr>
                        <td style="width:90%; text-align:right">
                            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="false">Approve</a>
                            <a id="btnReceive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-receive" plain="false">Receive</a>
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="false">Save</a>
                        </td>
                        <td style="width:8%">
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="false">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <div id="winLoanInstallment" class="easyui-window" title="Loan Settlement" style="height: 515px; width: 1020px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div id="p" style="width:99%; height:100%; padding:1px">
            <div style="width:100%; height:85%; padding-top:2px">
                <fieldset style="width:100%; height:100%">
                    <legend>Loan Info:</legend>
                    <table border="0" cellpadding="2" cellspacing="2" style="width:100%">
                        <tr>
                            <td style="width:10%; text-align:right">File No:</td>
                            <td style="width:15%">
                                <input type="text" id="txtStlmtLoanFileNo" style="width:100%; font-weight:bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Loan No:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanNumber" style="width: 100%; font-weight: bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Loan Type:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanType" style="width: 100%; font-weight: bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Issue/Stlmt :</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtLoanIssueDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                                        </td>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtApproxStlmtDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">Loan Start DT:</td>
                            <td style="width:15%">
                                <input type="text" id="txtStlmtLoanStartDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Export LC:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanExportLC" style="width: 100%; font-weight: bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Loan A/C:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanAccountNo" style="width: 100%; font-weight: bold" disabled="disabled" />
                            </td>
                            <td style="width: 10%; text-align: right">Loan Amt:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtLoanAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtLoanAmount" style="width: 100%; text-align: right; font-weight: bold; " disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">Loan Transfer:</td>
                            <td style="width:15%">
                                <select id="cboStlmtLoanTransfer" style="width: 100%; font-weight: bold"></select>
                            </td>
                            <td style="width: 10%; text-align: right">Turf Date:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:50%">
                                            <input id="txtStlmtTransferDate" type="text" style="width: 100px" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                        </td>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtTransferInterestDays" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Transfer IR:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanTransferInterestRate" style="width: 100%; font-weight: bold" />
                            </td>
                            <td style="width: 10%; text-align: right">Turf Interest:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtTransferInterestCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtTransferInterest" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">Interest Rate:</td>
                            <td style="width:15%">
                                <input type="text" id="txtStlmtLoanInterestRate" style="width: 100%; font-weight: bold" />
                            </td>
                            <td style="width: 10%; text-align: right">Stlmt Date:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:50%">
                                            <input id="txtStlmtSettlementDate" type="text" style="width: 100px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                        </td>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtInterestDays" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Int. Amount:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtLoanInterestAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtLoanInterestAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Libor Interest:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtLiborRate" style="width: 100%; text-align: right; font-weight: bold" placeholder="Libor Rate" />
                                        </td>
                                        <td style="width:50%">
                                            <input type="text" id="txtStlmtLiborInterestAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">Total Interest:</td>
                            <td style="width:15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtTotalInterestAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtTotalInterestAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Principle Amt:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtLoanPrincipleAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtLoanPrincipleAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Total Charge:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtLoanTotalChargeCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtLoanTotalCharge" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Remarks:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtLoanStlmtRemarks" style="width: 100%; font-weight: bold" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">Dis(Paid) Amt:</td>
                            <td style="width:15%">
                                <input type="text" id="txtStlmtDiscountPaidAmount" style="width: 100%; font-weight: bold" />
                            </td>
                            <td style="width: 10%; text-align: right">Dis(Rcv) Amt:</td>
                            <td style="width: 15%">
                                <input type="text" id="txtStlmtDiscountRcvAmount" style="width: 100%; font-weight: bold" />
                            </td>
                            <td style="width: 10%; text-align: right">Payable Amt:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtTotalPayableAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtTotalPayableAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">Paid Amt:</td>
                            <td style="width: 15%">
                                <table border="0" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:25%">
                                            <input type="text" id="txtStlmtLoanPaidAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                        </td>
                                        <td style="width:75%">
                                            <input type="text" id="txtStlmtLoanPaidAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" style="width:50%">
                                <table style="height:210px; width:100%" id="tblStlmtLoanCharge" title="Loan Charge Details" class="easyui-datagrid" singleselect="true" showfooter="true" toolbar="#toolStlmtLoanCharge">
                                    <thead>
                                        <tr>
                                            <th field="AccountName" width="35%">Cost Head</th>
                                            <th field="CurrencySymbol" width="15%">Curency</th>
                                            <th field="Amount" formatter="formatPrice" width="15%" align="right">Amount</th>
                                            <th field="CRate" formatter="formatPrice" width="15%" align="right">C Rate</th>
                                            <th field="AmountBC" formatter="formatPrice" width="15%" align="right">Amount(TK)</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div style="width:100%" id="toolStlmtLoanCharge">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:40%">
                                                Expense Head
                                            </td>
                                            <td style="width:10%">                                                
                                            </td>
                                            <td style="width:12%; text-align:center">
                                                C Rate
                                            </td>
                                            <td style="width: 20%; text-align: center">
                                                Amount
                                            </td>
                                            <td style="width:8%">
                                                
                                            </td>
                                            <td style="width:8%">                                                
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width:40%">
                                                <select id="cboStlmtExpenseHead" style="width:100%;"></select>
                                            </td>
                                            <td style="width:10%">
                                                <select id="cboStlmtChargeCurSymbol" style="width:100%;" disabled></select>
                                            </td>
                                            <td style="width:12%">
                                                <input type="text" style="width:100%" id="txtStlmtLoanChargeCRate" />
                                            </td>
                                            <td style="width:20%">
                                                <input type="text" style="width:100%" id="txtStlmtLoanChargeAmount" />
                                            </td>
                                            <td style="width:8%">
                                                <a id="btnStlmtAddCharge" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-add" plain="true"></a>
                                            </td>
                                            <td style="width:8%">
                                                <a id="btnStlmtChargeDelete" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-remove" plain="true"></a>
                                            </td>
                                        </tr>
                                    </table>                                    
                                </div>
                            </td>
                            <td colspan="4" style="width:50%">
                                <table style="height:210px; width:99%" id="tblStlmtPayment" title="Payment Details" class="easyui-datagrid" singleselect="true" showfooter="true" toolbar="#toolbarStlmtLoanPayment">
                                    <thead>
                                        <tr>
                                            <th field="AccountName" width="35%">Bank A/C</th>
                                            <th field="CurrencySymbol" width="15%">Curency</th>
                                            <th field="Amount" formatter="formatPrice" width="17%" align="right">Amount</th>
                                            <th field="CRate" formatter="formatPrice" width="15%" align="right">C Rate</th>
                                            <th field="AmountBC" formatter="formatPrice" width="17%" align="right">Amount(TK)</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div style="width:100%" id="toolbarStlmtLoanPayment">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:40%">
                                                Bank Account
                                            </td>
                                            <td style="width:10%"></td>
                                            <td style="width:12%; text-align:center">
                                                C Rate
                                            </td>
                                            <td style="width: 20%; text-align: center">
                                                Amount
                                            </td>
                                            <td style="width:8%"></td>
                                            <td style="width:8%"></td>
                                        </tr>
                                        <tr>
                                            <td style="width:40%">
                                                <select id="cboStlmtBankAC" style="width:100%;"></select>
                                            </td>
                                            <td style="width:10%">
                                                <select id="cboStlmtPaymentCurrencySymbol" style="width:100%;" disabled></select>
                                            </td>
                                            <td style="width:12%">
                                                <input type="text" style="width:100%" id="txtStlmtPaymentCRate" />
                                            </td>
                                            <td style="width:20%">
                                                <input type="text" style="width:100%" id="txtStlmtPaymentAmount" />
                                            </td>
                                            <td style="width:8%">
                                                <a id="btnStlmtPaymentAdd" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-add" plain="true"></a>
                                            </td>
                                            <td style="width:8%">
                                                <a id="btnStlmtPaymentDelete" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-remove" plain="true"></a>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <div style="width:100%; height:15%">
                <fieldset style="width:100%; height:100%">
                    <legend> Action:</legend>
                    <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                        <tr style="height:100%">
                            <td style="width:70%; text-align:left; font-size:12px; font-weight:bold">
                                <label id="lblStlmtLoanBalance" style="font-size:15px; font-weight:bold; color:red">Balance : 0.00</label>
                            </td>
                            <td style="width:10%; text-align: right; font-size: 12px; font-weight: bold; vertical-align: bottom;">
                                <a id="btnStlmtApprovedLoanSettlement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true">Approved</a>
                            </td>
                            <td style="width:10%; text-align: right; font-size: 12px; font-weight: bold; vertical-align: bottom;">
                                <a id="btnStlmtSaveLoanSettlement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            </td>
                            <td style="width:10%; text-align:right; font-size:12px; font-weight:bold; vertical-align:bottom">
                                <a id="btnStlmtCloseLoan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>

        </div>
    </div>
</body>
</html>

<style>
    .disabledDiv {
        pointer-events: none;
        opacity: 0.7;
    }

    .footer {
        position: relative;
        left: 0;
        bottom: 0;
        overflow: hidden;
    }
</style>

<script type="text/javascript">
    var BankACList = [];
    var LoanchargeList = [];
    $(document).ready(function () {
        var oLoan =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var LoanTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LoanTypes));
        var LoanRefTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LoanRefTypes));
        var LoanCompoundTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LoanCompoundTypes));
        var CycleTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CycleTypes));
        var LoanTransferTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LoanTransferTypes));
        var BaseCurrency = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BaseCurrency));
        var Currencys = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Currencys));
        var BankAccounts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BankAccounts));
        var ExpenditureHeads = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.ExpenditureHeads));
        var BUs = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BUs));

        $('#AppMainLayout').layout('collapse', 'west');
        $('#AppMainLayout').layout('expand', 'west');
        $('#AppMainLayout').layout('collapse', 'west');

        $('#divLoan').data("Loan", oLoan);
        $('#divLoan').data("LoanTypes", LoanTypes);
        $('#divLoan').data("LoanRefTypes", LoanRefTypes);
        $('#divLoan').data("LoanCompoundTypes", LoanCompoundTypes);
        $('#divLoan').data("LoanTypes", LoanTypes);
        $('#divLoan').data("CycleTypes", CycleTypes);
        $('#divLoan').data("LoanTransferTypes", LoanTransferTypes);
        $('#divLoan').data("BaseCurrency", BaseCurrency);
        $('#divLoan').data("Currencys", Currencys);
        $('#divLoan').data("BankAccounts", BankAccounts);
        $('#divLoan').data("ExpenditureHeads", ExpenditureHeads);
        $('#divLoan').data("BUs", BUs);
        $("#btnSave,#btnApprove,#btnReceive").hide();
        $('#txtInterestRate,#txtLoanAmountInBC,#txtLoanAmount,#txtPADInterestAmt,#txtInterestAmount,#txtSettlementAmt,#txtPaidAmountInFC,#txtLoanChargeAmountInFC,#txtPaymentAmountInFC,#txtProcessFeePercent,#txtProcessFeeAmount').icsCurrencyBox(null, 0.000, 2);
        $('#txtLibor,#txtPADIR,#txtLiborInterest,#txtTotalInterest,#txtLoanChargeInFC,#txtLiborRate,#txtLoanChargeCRate,#txtPaymentCRate').icsCurrencyBox(null, 0.00, 4);
        $('#txtPADIRDays,#txtInterestAmountDys').icsCurrencyBox(null, 0, 0);

        $('#txtStlmtLoanInterestRate,#txtStlmtLoanChargeCRate,#txtStlmtPaymentCRate,#txtStlmtLoanTransferInterestRate,#txtStlmtLiborRate').icsCurrencyBox(null, null, 4);
        $('#txtStlmtPaymentAmount,#txtStlmtLoanChargeAmount,#txtStlmtDiscountPaidAmount,#txtStlmtDiscountRcvAmount,#txtStlmtLiborInterestAmount').icsCurrencyBox(null, null, 2);

        RefreshCboBox();
        Initialize();
        if(sessionStorage.getItem("Operation") != "Add Loan")
        {
            SetControl(oLoan);
        }
        ButtonControl();
        $("#cboLoanRef").prop("disabled", true);
    });

    $('#cboBU').change(function(){

        var oBankAccounts = $('#divLoan').data("BankAccounts");
        var oBUWiseList =oBankAccounts;
        if(parseInt($('#cboBU').val())>0)
        {
            oBUWiseList = ICS_FindObjects(oBankAccounts, 'BusinessUnitID',parseInt($('#cboBU').val()));
        }
        $("#cboRcvBankAC").icsLoadCombo({List:oBUWiseList,OptionValue: "BankAccountID",DisplayText: "AccountNo"});
    });

    $('#cboLoanTransfer').change(function(){
        ChangeLTType();
    });

    function ChangeLTType()
    {

        if(parseInt($('#cboLoanTransfer').val())==0)
        {
            $('#txtTransferDate').datebox({disabled:true});
            $('#txtPADIR').attr('disabled',true);
            $('#txtPADIR').val(0);$("#txtPADIRDays,#txtPADInterestAmt").val(0);


        }else{

            var oLoan = $('#divLoan').data("Loan");
            $('#txtTransferDate').datebox({disabled:false});
            $('#txtTransferDate').datebox('setValue',icsdateformat(new Date(oLoan.ApproxSettlement)));
            $('#txtPADIR').attr('disabled',false);
            $('#txtPADIR').val(oLoan.PADInterestRate);
            TransferDateChange();
        }
    }

    function ButtonControl()
    {
        if(sessionStorage.getItem("Operation") == "Add Loan" || sessionStorage.getItem("Operation")=="Edit Loan" || sessionStorage.getItem("Operation")=="Settlement Loan")
        {
            $("#btnSave").show();
        }
        if(sessionStorage.getItem("Operation") == "Approve Loan")
        {
            $("#btnApprove").show();
        }
        if(sessionStorage.getItem("Operation") == "Receive Loan")
        {
            $("#btnReceive").show();
        }
        if(sessionStorage.getItem("Operation") == "Settlement Loan")
        {
            $("#FinanceLoanDetails").addClass("disabledDiv");
        }
        if(sessionStorage.getItem("Operation") == "View Loan")
        {
            $("#FinanceLoanDetails").addClass("disabledDiv");
            //$("#SettlementDetails").addClass("disabledDiv");
            //$("#InstallmentDetails").addClass("disabledDiv");
            $("#btnSave,#btnApprove,#btnReceive").hide();
            var oLoan = $('#divLoan').data("Loan");

        }
    }

    function RefreshCboBox()
    {
        $("#cboLoanType").icsLoadCombo({
            List: $('#divLoan').data("LoanTypes"),
            OptionValue: "id",
            DisplayText: "Value"
        });
        $("#cboLoanRef").icsLoadCombo({
            List: $('#divLoan').data("LoanRefTypes"),
            OptionValue: "id",
            DisplayText: "Value"
        });
        $("#cboLoanCurrency").icsLoadCombo({
            List: $('#divLoan').data("Currencys"),
            OptionValue: "CurrencyID",
            DisplayText: "Symbol"
        });
        $("#cboLoanTransfer").icsLoadCombo({
            List: $('#divLoan').data("LoanTransferTypes"),
            OptionValue: "id",
            DisplayText: "Value"
        });
        $("#cboPaymentCurrencySymbol").icsLoadCombo({
            List: $('#divLoan').data("Currencys"),
            OptionValue: "CurrencyID",
            DisplayText: "Symbol"
        });
        $("#cboChargeCurSymbol").icsLoadCombo({
            List: $('#divLoan').data("Currencys"),
            OptionValue: "CurrencyID",
            DisplayText: "Symbol"
        });
        $("#cboLoanCompound").icsLoadCombo({
            List: $('#divLoan').data("LoanCompoundTypes"),
            OptionValue: "id",
            DisplayText: "Value"
        });
        $("#cboBU").icsLoadCombo({
            List: $('#divLoan').data("BUs"),
            OptionValue: "BusinessUnitID",
            DisplayText: "ShortName"
        });
        $("#cboBankAC").icsLoadCombo({
            List: $('#divLoan').data("BankAccounts"),
            OptionValue: "BankAccountID",
            DisplayText: "AccountNo"
        });
        $("#cboRcvBankAC").icsLoadCombo({
            List: $('#divLoan').data("BankAccounts"),
            OptionValue: "BankAccountID",
            DisplayText: "DisplayAccoountType"
        });
        $("#cboExpenseHead").icsLoadCombo({
            List: $('#divLoan').data("ExpenditureHeads"),
            OptionValue: "ExpenditureHeadID",
            DisplayText: "Name"
        });
        $("#cboCycle").icsLoadCombo({
            List: $('#divLoan').data("CycleTypes"),
            OptionValue: "id",
            DisplayText: "Value"
        });

    }

    function Initialize()
    {
        $('.TermLonCls').hide();
        $('.GeneralCls').show();
        $("#cboLoanCompound").val(0);
        $("#cboLoanCompound").prop("disabled", true);
        $('#txtSettlementDate,#txtTransferDate,#txtStartDate,#txtLiborRateDate,#txtRcvDate,#txtApproxDate,#txtIssueDate,#txtLoanStartDate,#txtStlmtStartDate').datebox('setValue',icsdateformat(new Date()));

        $("#txtLoanChargeBaseCurrency").val($('#divLoan').data("BaseCurrency").CurrencySymbol);
        $("#txtPaidBaseCurrency").val($('#divLoan').data("BaseCurrency").CurrencySymbol);
        $("#txtPADIRDaysText").val("Days");
        $("#txtInterestAmountDateText").val("Days");
        $("#txttxtLiborInterestDateText").val("Days");
        $("#txtLoanChargeForeignCur,#txtSettlementForeignCur").val("$");
        $("#txtPaidAmountDoller").val("$");
        $("#txtSettlementNote").val("N/A");
        $('#cboCycle').val(0);
    }

    function SetControl(oLoan)
    {
        $('#InstallmentDetails').panel('setTitle','Sattlement History');
        if(parseInt(oLoan.LoanStatusInt)>=3)//if receive
        {
            $("#btnAddSettlement,#btnEditSettlement").prop("disabled", false);
        }
        $("#txtFileNo").val(oLoan.FileNo);
        $("#cboLoanCompound").val(oLoan.CompoundType);
        $("#cboLoanCompound").prop("disabled", true);
        $('#txtIssueDate').datebox('setValue',oLoan.IssueDateInString);
        $('#txtLoanStartDate').datebox('setValue',oLoan.LoanStartDateInString);
        $('#txtStlmtStartDate').datebox('setValue',oLoan.StlmtStartDateInString);

        $('#txtApproxDate').datebox('setValue',oLoan.ApproxSettlementInString);
        $('#txtRcvDate').datebox('setValue',oLoan.RcvDateInString);
        $('#txtStartDate').datebox('setValue',oLoan.InstallmentStartDateInString);
        $("#txtLoanChargeTaka,#txtPaidBaseCurrency").val( $('#divLoan').data("BaseCurrency").CurrencySymbol);

        $("#txtLibor,#txtLiborRate").val(formatPrice(oLoan.LiborRate));
        $("#txtPADIR").val(formatPrice(oLoan.InterestRate));
        $("#txtLoanNo").val(oLoan.LoanNo);
        $("#txtImportOrExportRefNo").val(oLoan.LoanRefNo);
        $("#txtLoanIR").val(formatPrice(oLoan.InterestRate));
        $("#txtLoanAmount").val(formatPrice(oLoan.LoanAmount));
        $("#txtLoanCRate,#txtPrincipalAmountCRate").val(formatPrice(oLoan.CRate));
        $("#txtLoanAmountInBC").val(formatPrice(oLoan.LoanAmountInBC));

        $("#txtPrincipalAmountCurSymbol").val(oLoan.CurrencySymbol);
        $("#txtPrincipalAmount").val(formatPrice(oLoan.PrincipalAmount));
        $("#txtPrincipalAmountBC").val(formatPrice(oLoan.PrincipalAmountBC));

        $("#txtAmountNo").val(oLoan.InstallmentAmount);
        $("#txtStartDate").val(oLoan.InstallmentStartDateInString);
        $("#txtInstallmentNo").val(oLoan.NoOfInstallment);
        $("#txtInterestRate").val(formatPrice(oLoan.InterestRate));
        $("#txtRemarks").val(oLoan.LoanRemarks);
        $('#cboCycle').val(oLoan.InstallmentCycle);

        $('#cboLoanRef').val(oLoan.LoanRefType);
        $('#cboLoanType').val(oLoan.LoanType);
        $('#cboLoanCurrency').val(oLoan.LoanCurencyID);
        $('#cboChargeCurSymbol,#cboPaymentCurrencySymbol').val(parseInt(oLoan.LoanCurencyID));
        $('#cboRcvBankAC').val(oLoan.RcvBankAccountID);
        $('#cboBU').val(oLoan.BUID);
        $("#txtProcessFeePercent").val(formatPrice(oLoan.ProcessFeePercent));
        $("#txtProcessFeeAmount").val(formatPrice(oLoan.ProcessFeeAmount));
        ApproxrValueSet();
        DynamicRefreshList(oLoan.LoanInstallments, "tblInstallment");
        DynamicRefreshList(oLoan.LoanInterests, "tblLoanInterest");

        var nInterestAmount = 0;
        var nInterestAmountBC = 0;
        if(oLoan.LoanInterests != null && oLoan.LoanInterests.length>0)
        {
            for(var i=0; i<oLoan.LoanInterests.length; i++)
            {
                nInterestAmount = nInterestAmount + parseFloat(oLoan.LoanInterests[i].InterestAmount);
                nInterestAmountBC = nInterestAmountBC + parseFloat(oLoan.LoanInterests[i].InterestAmountBC);
            }
        }

        var FooterFieldInterest = [];
        var objInterest =new Object();
        objInterest['InterestTypeSt']="Grand Total:";
        objInterest['InterestAmountSt'] =  icsFormatPrice(parseFloat(nInterestAmount), null, 2);
        objInterest['InterestAmountBCSt'] = icsFormatPrice(parseFloat(nInterestAmountBC), null, 2);
        FooterFieldInterest.push(objInterest);
        $('#tblLoanInterest').datagrid('reloadFooter',FooterFieldInterest);
        

        if(oLoan.LoanRefType == 1)
        {
            $('#spanImportOrExportRefNo').html('Import Invoice :');
            oreturnObj = {
                ImportInvoiceNo : oLoan.LoanRefNo,
                ImportInvoiceID : oLoan.LoanRefID}
        }
        else
        {
            $('#spanImportOrExportRefNo').html('ExportLC :');
            oreturnObj = {
                ExportLCNo : oLoan.LoanRefNo,
                ExportLCID : oLoan.LoanRefID}
        }
        if(oLoan.LoanAmountType != parseInt($('#divLoan').data("BaseCurrency").BaseCurrencyID))
        {
            $("#txtLoanCRate").prop("disabled", false);
        }
        if(oLoan.LoanType== 5)
        {

            $('#InstallmentDetails').panel('setTitle','Installment Details');
        }
        if(oLoan.LoanType== 2)
        {
            $("#txtLibor").prop("disabled", false);
        }
        $('#txtImportOrExportRefNo').data('RefItem', oreturnObj);
    }

    function DisableFinanceLoan()
    {
        $("#FinanceLoanDetails").addClass("disabledDiv");
    }

    function Validation()
    {
        if($("#cboBU").val()==0)
        {
            alert("Please enter Business Unit Type!");
            $('#cboBU').focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtInterestRate").val()))<=0)
        {
            alert("Please enter Interest Rate!");
            $('#txtInterestRate').focus();
            return false;
        }


        if($("#txtLoanNo").val()==null || $("#txtLoanNo").val()=="")
        {
            alert("Please enter Loan No!");
            $('#txtLoanNo').focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtLoanAmount").val()))<=0)
        {
            alert("Please enter Loan Amount!");
            $('#txtLoanAmount').focus();
            return false;
        }


        if($("#txtIssueDate").datebox('getValue')==null || $("#txtIssueDate").datebox('getValue')=="")
        {
            alert("Please enter Issue Date!");
            $('#txtIssueDate').focus();
            return false;
        }

        if($("#txtLoanStartDate").datebox('getValue')==null || $("#txtLoanStartDate").datebox('getValue')=="")
        {
            alert("Please enter Loan Start Date!");
            $('#txtLoanStartDate').focus();
            return false;
        }

        if($("#txtApproxDate").datebox('getValue')==null || $("#txtApproxDate").datebox('getValue')=="")
        {
            alert("Please enter Approx Date!");
            $('#txtApproxDate').focus();
            return false;
        }

        var dLoanStartDate = new Date($("#txtLoanStartDate").datebox('getValue'));
        var dApproxSettlementDate = new Date($("#txtApproxDate").datebox('getValue'));
        var nInterestInTime = (dApproxSettlementDate.getTime() - dLoanStartDate.getTime());
        var nInterestDays = (nInterestInTime / (1000 * 3600 * 24));
        //alert(nInterestDays);
        if(nInterestDays<60)
        {
            alert("Please Enter Loan Approx Settlement Date At-least 60 Days!");
            $('#txtApproxDate').focus()
            return false;
        }

        
        if($("#txtRcvDate").datebox('getValue')==null || $("#txtRcvDate").datebox('getValue')=="")
        {
            alert("Please enter Receive Date!");
            $('#txtRcvDate').focus();
            return false;
        }
        
        if($("#cboLoanType").val()==0)
        {
            alert("Please enter Loan Type!");
            $('#cboLoanType').focus();
            return false;
        }
        if(parseInt($("#cboLoanType").val())!=5)//Not Term Loan
        {
            if($("#cboLoanRef").val()==0)
            {
                alert("Please enter Loan Referance Type.");
                $('#cboLoanRef').focus();
                return false;
            }
        }

        if($("#cboRcvBankAC").val()==0)
        {
            alert("Please enter Receive Bank Account!");
            $('#cboRcvBankAC').focus();
            return false;
        }

        if($("#cboLoanType").val() == 4)
        {
            if(txtLibor == "")
            {
                alert("Libor Rate is not given!");
                return false;
            }
            else if(parseInt($('#cboLoanCompound').val())== 0)
            {
                alert("Loan Compound Type is not given!");
                return false;
            }
        }



        var IssueDate = new Date($("#txtIssueDate").datebox('getValue'));
        var LoanStartDate = new Date($("#txtLoanStartDate").datebox('getValue'));
        var StlmtStartDate = new Date($("#txtStlmtStartDate").datebox('getValue'));
        var ApproxDate = new Date($("#txtApproxDate").datebox('getValue'));
        var RcvDate = new Date($("#txtRcvDate").datebox('getValue'));
        var InstallmentStartDate = new Date($("#txtStartDate").datebox('getValue'));

        if($("#cboLoanType").val()==5)//term Loan
        {

            if($("#txtInstallmentNo").val()==null || $("#txtInstallmentNo").val()=="")
            {
                alert("Please enter Installment No!");
                $('#txtInstallmentNo').focus();
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtAmountNo").val()))<=0)
            {
                alert("Amount Should be Greater than 0.");
                $('#txtAmountNo').focus();
                return false;
            }


            if($("#txtStartDate").datebox('getValue')==null || $("#txtStartDate").datebox('getValue')=="")
            {
                alert("Please enter Installment Start Date!");
                $('#txtStartDate').focus();
                return false;
            }
            if($("#cboCycle").val()==0)
            {
                alert("Please enter Cycle Type!");
                $('#cboCycle').focus();
                return false;
            }
        }
        return true;
    }

    function RefreshObject()
    {

        var txtImportOrExportRefNo = '';
        var ImportOrExportID = 0;
        if($("#cboLoanRef").val() == 1)//Import invoice
        {
            txtImportOrExportRefNo = $('#txtImportOrExportRefNo').data('RefItem').ImportInvoiceNo;
            ImportOrExportID = $('#txtImportOrExportRefNo').data('RefItem').ImportInvoiceID;
        }
        else
        {
            txtImportOrExportRefNo = $('#txtImportOrExportRefNo').data('RefItem').ExportLCNo;
            ImportOrExportID = $('#txtImportOrExportRefNo').data('RefItem').ExportLCID;
        }

        var oLoan = {
            LoanID : $('#divLoan').data("Loan").LoanID,
            BUID : parseInt($("#cboBU").val()),
            LoanTypeInt : parseInt($("#cboLoanType").val()),
            LoanRefTypeInt : parseInt($("#cboLoanRef").val()),
            RcvBankAccountID : parseInt($("#cboRcvBankAC").val()),
            LoanCurencyID : parseInt($("#cboLoanCurrency").val()),
            LoanAmount : parseFloat(icsRemoveComma($("#txtLoanAmountInBC").val())),
            CompoundTypeInt : parseInt($("#cboLoanCompound").val()),
            InstallmentCycleInt : parseInt($("#cboCycle").val()),
            IssueDate : $("#txtIssueDate").datebox('getValue'),
            LoanStartDate : $("#txtLoanStartDate").datebox('getValue'),
            StlmtStartDate:$("#txtStlmtStartDate").datebox('getValue'),
            ApproxSettlement : $("#txtApproxDate").datebox('getValue'),
            RcvDate : $("#txtRcvDate").datebox('getValue'),
            NoOfInstallment : $("#txtInstallmentNo").val(),
            InstallmentStartDate : $("#txtStartDate").datebox('getValue'),
            InstallmentAmount : $("#txtAmountNo").val(),
            InterestRate : parseFloat(icsRemoveComma($("#txtInterestRate").val())),
            LiborRate : parseFloat(icsRemoveComma($("#txtLibor").val())),
            CRate:parseFloat($("#txtLoanCRate").val()),
            LoanNo : $("#txtLoanNo").val(),
            LoanRefNo : txtImportOrExportRefNo,
            LoanRefID : ImportOrExportID,
            LoanAmount : parseFloat(icsRemoveComma($("#txtLoanAmount").val())),
            LoanRemarks : $("#txtRemarks").val(),
            ProcessFeePercent : parseFloat(icsRemoveComma($("#txtProcessFeePercent").val())),
            ProcessFeeAmount : parseFloat(icsRemoveComma($("#txtProcessFeeAmount").val())),
            LoanInstallments : $('#tblInstallment').datagrid('getRows')
        };

        return oLoan;

    }

    $("#btnSave").click(function () {

        var ActionName = "SaveLoan";
        if(!Validation()) return false;
        var oLoan = RefreshObject();

        if(sessionStorage.getItem("Operation") == "Edit Loan" || sessionStorage.getItem("Operation") == "Settlement Loan")
        {
            oLoan.LoanID = $('#divLoan').data("Loan").LoanID;
        }

        if(sessionStorage.getItem("Operation") == "Settlement Loan"){
            ActionName = "SettlementLoan";
        }

        $('#btnSave').hide();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/Loan/"+ActionName,
            traditional: true,
            data:  JSON.stringify({oLoan :oLoan}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                oLoan = jQuery.parseJSON(data);
                if (oLoan.ErrorMessage =="" || oLoan.ErrorMessage==null)
                {
                    alert("Data Saved sucessfully");
                    var oLoans = sessionStorage.getItem("Loans");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oLoans != null) {
                        oLoans = jQuery.parseJSON(oLoans);
                    }
                    else {
                        oLoans = [];
                    }
                    if (nIndex != -1) {
                        oLoans[nIndex] = oLoan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oLoans.length);
                        oLoans.push(oLoan);
                    }
                    sessionStorage.setItem("Loans", JSON.stringify(oLoans));
                    if(sessionStorage.getItem("BackLink")!=null && sessionStorage.getItem("BackLink")!="")
                    {

                        window.location.href = sessionStorage.getItem("BackLink");
                    }
                }
                else
                {
                    alert(oLoan.ErrorMessage);
                    $('#btnSave').show();
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $("#btnClose").click(function () {

        window.location.href = sessionStorage.getItem("BackLink");

    });

    $("#cboLoanType").change(function(e)
    {
        $("#txtLibor").prop("disabled", false);
        $("#cboLoanCompound").prop("disabled", false);
        $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", false);
        $('#txtImportOrExportRefNo').data('RefItem', null);

        //LoanRef Type : ImportInvoice = 1, ExportLC = 2
        //Loan Type : PADLoan = 1, EDFLoan = 2, PCLoan  = 3, LTRLoan = 4, TermLoan = 5, U_Pass = 6
        if(parseInt($("#cboLoanType").val()) === 1 || parseInt($("#cboLoanType").val()) === 6)
        {
            $('.TermLonCls').hide();
            $('.GeneralCls').show();
            $('#cboLoanRef').val(1);
            $('#spanImportOrExportRefNo').html('Import Invoice:');
            $('#txtLibor').val(0.00);
            $('#cboLoanCompound').val(0);
            $("#txtLibor").prop("disabled", true);
            $("#cboLoanCompound").prop("disabled", true);
            $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", false);
            $('#InstallmentDetails').panel('setTitle','Settlement History');
        }
        else if(parseInt($("#cboLoanType").val()) === 2)
        {
            $('.TermLonCls').hide();
            $('.GeneralCls').show();
            $('#cboLoanRef').val(1);
            $('#spanImportOrExportRefNo').html('Import Invoice:');
            $('#txtLibor').val(0.00);
            $('#cboLoanCompound').val(0);
            $("#txtLibor").prop("disabled", false);
            $("#cboLoanCompound").prop("disabled", true);
            $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", false);
            $('#InstallmentDetails').panel('setTitle','Settlement History');
        }
        else if(parseInt($("#cboLoanType").val()) === 3)
        {
            $('.TermLonCls').hide();
            $('.GeneralCls').show();
            $('#cboLoanRef').val(2);
            $('#spanImportOrExportRefNo').html('Export LC:');
            $('#txtLibor').val(0.00);
            $('#cboLoanCompound').val(0);
            $("#txtLibor").prop("disabled", true);
            $("#cboLoanCompound").prop("disabled", true);
            $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", false);
            $('#InstallmentDetails').panel('setTitle','Settlement History');
        }
        else if(parseInt($("#cboLoanType").val()) === 4)
        {
            $('.TermLonCls').hide();
            $('.GeneralCls').show();
            $('#cboLoanRef').val(0);
            $('#spanImportOrExportRefNo').html('Ref No:');
            $('#txtLibor').val(0.00);
            $('#cboLoanCompound').val(0);
            $("#txtLibor").prop("disabled", true);
            $("#cboLoanCompound").prop("disabled", false);
            $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", true);
            $('#InstallmentDetails').panel('setTitle','Settlement History');
        }
        else if(parseInt($("#cboLoanType").val()) === 5)
        {
            $('.TermLonCls').show();
            $('.GeneralCls').hide();
            $('#cboLoanRef').val(0);
            $('#spanImportOrExportRefNo').html('Ref No:');
            $('#txtLibor').val(0.00);
            $('#cboLoanCompound').val(0);
            $("#txtLibor").prop("disabled", true);
            $("#cboLoanCompound").prop("disabled", true);
            $("#txtImportOrExportRefNo,#btnCancel,#btnPick").prop("disabled", true);
            $('#InstallmentDetails').panel('setTitle','Installment Details');
        }
    });

    $("#cboLoanCurrency").change(function(e)
    {


        if(parseInt($("#cboLoanCurrency").val()) != 0)
        {
            $("#txtLoanChargeForeignCur,#txtSettlementForeignCur").val($("#cboLoanCurrency").find('option:selected').text());
            $("#txtPaidAmountDoller").val($("#cboLoanCurrency").find('option:selected').text());

        }

        if(parseInt($("#cboLoanCurrency").val()) == parseInt($('#divLoan').data("BaseCurrency").BaseCurrencyID))
        {
            $("#txtLoanCRate").val("1");
            $("#txtLoanCRate").attr("disabled", true);
        }
        else{
            $("#txtLoanCRate").val("0.00");
            $("#txtLoanCRate").attr("disabled", false);
        }

        CalculateTotalLoanAmount();

    });

    $("#cboPaymentCurrencySymbol").change(function(e)
    {

        if(parseInt($("#cboPaymentCurrencySymbol").val()) == parseInt($('#divLoan').data("BaseCurrency").BaseCurrencyID))
        {
            $("#txtPaymentCRate").val("1");
            $("#txtPaymentCRate").attr("disabled", true);
        }
        else
        {
            $("#txtPaymentCRate").val(0.00);
            $('#txtPaymentCRate').attr('disabled',false);
        }

        $("#txtPaidBaseCurrency").val($("#cboPaymentCurrencySymbol").find('option:selected').text());

    });

    $("#cboChargeCurSymbol").change(function(e)
    {

        if($("#cboChargeCurSymbol").val() == parseInt($('#divLoan').data("BaseCurrency").BaseCurrencyID))
        {
            $("#txtLoanChargeCRate").val("1");
            $("#txtLoanChargeCRate").prop("disabled", true);
        }
        else
        {
            $("#txtLoanChargeCRate").val("0.00");
            $("#txtLoanChargeCRate").prop("disabled", false);
        }

        $("#txtLoanChargeBaseCurrency").val($("#cboChargeCurSymbol").find('option:selected').text());

    });

    $("#cboLoanRef").change(function(e)
    {

        if($("#cboLoanRef").val() == 1)
        {
            $('#spanImportOrExportRefNo').html('Import Invoice :');
        }
        else
        {
            $('#spanImportOrExportRefNo').html('ExportLC :');
        }

        $("#txtImportOrExportRefNo").val("");
        $('#txtImportOrExportRefNo').data('RefItem', null);
        $("#txtImportOrExportRefNo").removeClass("fontColorOfPickItem");CRate

    });

    $("#txtLoanAmount,#txtInterestRate,#txtLibor").change(function() {

        var LoanAmount = parseFloat(icsRemoveComma($("#txtLoanAmount").val()));
        var LoanAmountdisabled = parseFloat(icsRemoveComma($("#txtLoanCRate").val()));
        var totalAmount = LoanAmount * LoanAmountdisabled;
        $("#txtLoanAmountInBC").val(icsFormatPrice(parseFloat(totalAmount), null, 2));
        ApproxrValueSet();
    });

    $("#txtProcessFeePercent").keyup(function (e) {
        var nLoanAmount = parseFloat(icsRemoveComma($("#txtLoanAmount").val()));
        var nProcessFeePercent = parseFloat(icsRemoveComma($("#txtProcessFeePercent").val()));
        var nProcessFeeAmount  = parseFloat(parseFloat(((nLoanAmount * nProcessFeePercent)/100.00)).toFixed(2));
        $("#txtProcessFeeAmount").val(icsFormatPrice(parseFloat(nProcessFeeAmount), null, 2));
    });

    $("#txtProcessFeeAmount").keyup(function (e) {
        var nLoanAmount = parseFloat(icsRemoveComma($("#txtLoanAmount").val()));
        if(nLoanAmount<=0){ nLoanAmount = 1.00; }
        var nProcessFeeAmount = parseFloat(icsRemoveComma($("#txtProcessFeeAmount").val()));
        var nProcessFeePercent  = parseFloat(parseFloat(((nProcessFeeAmount * 100)/nLoanAmount)).toFixed(2));
        $("#txtProcessFeePercent").val(icsFormatPrice(parseFloat(nProcessFeePercent), null, 4));
    });

    $('#txtIssueDate').datebox({
        onSelect: function(date)
        {

            var oLoan = $('#divLoan').data("Loan");
            if(parseInt(oLoan.LoanID)==0)
            {
                $('#txtLoanStartDate,#txtStlmtStartDate,#txtRcvDate').datebox('setValue',$('#txtIssueDate').datebox('getValue'));
            }
        }
    });

    $('#txtApproxDate').datebox({
        onSelect: function(date)
        {

            ApproxrValueSet();
        }
    });

    function ApproxrValueSet()
    {
        var LoanStartDate = new Date($('#txtLoanStartDate').datebox('getValue'));
        var AppSattleDate = new Date($('#txtApproxDate').datebox('getValue'));
        var  diffDays = parseInt((AppSattleDate - LoanStartDate)/(1000 * 60 * 60 * 24));
        if (diffDays < 0)
        {
            alert("Loan Approx  date can not be smaller than Loan start date!");
            $('#txtApproxDate').datebox('setValue', icsdateformat(new Date(ApproxDate)));
            return;
        }
        var nTempIR = parseFloat(icsRemoveComma($("#txtInterestRate").val()))+parseFloat(icsRemoveComma($("#txtLibor").val()));
        var nTotalAppIRAmount = ((parseFloat(icsRemoveComma($("#txtLoanAmount").val()))*(nTempIR/100))/360)* diffDays;
        var nTotalAppSattleAmount = parseFloat(nTotalAppIRAmount)+parseFloat(icsRemoveComma($("#txtLoanAmount").val()));

        $('#txtAppIRAmount').val(formatPrice(nTotalAppIRAmount));
        $('#txtAppSattleAmount').val(formatPrice(nTotalAppSattleAmount));
    }

    /* Import Export Picker*/

    $("#btnPick").click(function () {
        $('#txtImportOrExportRefNo').val('');
        PickImportOrExport();
    });

    $('#btnCancel').click(function(e){
        $("#txtImportOrExportRefNo").val("");
        $('#txtImportOrExportRefNo').data('RefItem', null);
        $("#txtImportOrExportRefNo").removeClass("fontColorOfPickItem");
    });

    function PickImportOrExport()
    {


        if($('#cboLoanRef').val()<1)
        {
            alert("Please Select Order Reference Export Or Import");
            return;
        }
        if(parseInt($('#cboBU').val())<1)
        {
            alert("Please Select BU");
            return;
        }

        var oRefObject = null, sRefControllerName="", sActionName="", sRefObjectID="",searchingbyfieldName = "", tblColums = [];
        if(parseInt($('#cboLoanRef').val()) == 1)//Import
        {
            sRefControllerName="Loan";
            sActionName="GetsImportInvoice";
            sRefObjectID = "ImportInvoiceID";
            oRefObject={
                BUID:parseInt($('#cboBU').val()),
                ImportInvoiceNo:$.trim($('#txtImportOrExportRefNo').val())
            };
            var oColumn = { field: "ImportInvoiceNo", title: "Invoice No", width: 200, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ContractorName", title: "Contractor", width: 300, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "InvoiceDateInString", title: "InvoiceDate", width: 100, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "AmountLCInSt", title: "Amount_LC", width: 100, align: "left" }; tblColums.push(oColumn);
            searchingbyfieldName="ImportInvoiceNo";

        }
        else  if(parseInt($('#cboLoanRef').val()) == 2)//Export
        {
            sRefControllerName="Loan";
            sActionName="GetExportLC";
            sRefObjectID = "ExportLCID";
            oRefObject={
                BUID:parseInt($('#cboBU').val()),
                ExportLCNo:$.trim($('#txtImportOrExportRefNo').val())
            };
            var oColumn = { field: "ExportLCNo", title: "LC No", width: 200, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ApplicantName", title: "Applicant", width: 300, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "OpeningDateST", title: "LC Date", width: 100, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "AmountSt", title: "Amount", width: 100, align: "right" }; tblColums.push(oColumn);
            searchingbyfieldName="ExportLCNo";
        }

        var obj = {
            BaseAddress: sessionStorage.getItem("BaseAddress"),
            Object: oRefObject,
            ControllerName:sRefControllerName,
            ActionName: sActionName,
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][sRefObjectID] > 0) {
                    var oPickerParam = {
                        winid: 'winExportOrImports',
                        winclass: 'clsExportOrImports',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblExportOrImports',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: searchingbyfieldName,
                        windowTittle: 'Item List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
                return;
            }
        });
    }

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    $("#txtImportOrExportRefNo").keydown(function (e) {

        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtImportOrExportRefNo').val())===null || $.trim($('#txtImportOrExportRefNo').val())==="")
            {
                alert("Press enter with Ref No");
                return;
            }
            PickImportOrExport();
        }else if (code == 8) //backspace=8
        {
            $("#txtImportOrExportRefNo").removeClass("fontColorOfPickItem");
            $('#txtImportOrExportRefNo').data('RefItem', null);
        }
    });

    function SetPickerValueAssign(oPickerobj) {

        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid === 'winExportOrImports')
        {
            if (oreturnObj != null)
            {
                if(parseInt($('#cboLoanRef').val()) == 1)
                    $('#txtImportOrExportRefNo').val(oreturnObj.ImportInvoiceNo);

                else if(parseInt($('#cboLoanRef').val()) == 2)
                    $('#txtImportOrExportRefNo').val(oreturnObj.ExportLCNo);

                $('#txtImportOrExportRefNo').addClass('fontColorOfPickItem');
                $('#txtImportOrExportRefNo').data('RefItem', oreturnObj);
                $('#txtImportOrExportRefNo').focus();
            }
        }

    }

    $("#btnApprove").click(function () {

        if(!Validation()) return false;
        if (!confirm("Confirm to Approve?")) return ;
        var oTempLoan = RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/Loan/ApproveLoan",
            traditional: true,
            data:  JSON.stringify({oLoan:oTempLoan}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                oLoan = jQuery.parseJSON(data);
                if (oLoan.ErrorMessage =="" || oLoan.ErrorMessage==null)
                {
                    alert("Sucessfully Approved.");
                    var oLoans = sessionStorage.getItem("Loans");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oLoans != null) {
                        oLoans = jQuery.parseJSON(oLoans);
                    }
                    else {
                        oLoans = [];
                    }
                    if (nIndex != -1) {
                        oLoans[nIndex] = oLoan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oLoans.length);
                        oLoans.push(oLoan);
                    }
                    sessionStorage.setItem("Loans", JSON.stringify(oLoans));
                    if(sessionStorage.getItem("BackLink")!=null && sessionStorage.getItem("BackLink")!="")
                    {

                        window.location.href = sessionStorage.getItem("BackLink");
                    }
                }
                else
                {
                    alert("Data not found!!");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $("#btnReceive").click(function () {

        if(!Validation()) return false;
        if (!confirm("Confirm to Receive?")) return ;
        var oTempLoan = RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/Loan/ReceiveLoan",
            traditional: true,
            data:  JSON.stringify({oLoan:oTempLoan}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                oLoan = jQuery.parseJSON(data);
                if (oLoan.ErrorMessage =="" || oLoan.ErrorMessage==null)
                {
                    alert("Sucessfully Received.");
                    var oLoans = sessionStorage.getItem("Loans");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oLoans != null) {
                        oLoans = jQuery.parseJSON(oLoans);
                    }
                    else {
                        oLoans = [];
                    }
                    if (nIndex != -1) {
                        oLoans[nIndex] = oLoan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oLoans.length);
                        oLoans.push(oLoan);
                    }
                    sessionStorage.setItem("Loans", JSON.stringify(oLoans));
                    if(sessionStorage.getItem("BackLink")!=null && sessionStorage.getItem("BackLink")!="")
                    {

                        window.location.href = sessionStorage.getItem("BackLink");
                    }
                }
                else
                {
                    alert("Data not found!!");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });
    /* End Import Export Picker*/


    //Start Loan Settlement
    $('#btnAddSettlement').click(function(e){
        var oLoan = $('#divLoan').data("Loan");
        if(oLoan===null || parseInt(oLoan.LoanID)<=0)
        {
            alert("Invalid Loan!");
            return;
        }
        if(oLoan===null || parseInt(oLoan.ReceivedBy) === 0)
        {
            alert("Please Select an Received Loan!");
            return;
        }
        var oLoanInstallment = { LoanInstallmentID : 0, LoanID : parseInt(oLoan.LoanID) };
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/GetLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    $("#winLoanInstallment").data('SelectedIndex', -1);
                    $("#winLoanInstallment").data('LoanInstallment', oLoanInstallment);
                    StlmtLoanRestControls();
                    StlmtLoanRefreshControls();
                    $("#btnStlmtSaveLoanSettlement").show();
                    $("#btnStlmtApprovedLoanSettlement").hide();
                    $("#btnStlmtAddCharge,#btnStlmtChargeDelete").show();
                    $("#btnStlmtPaymentAdd,#btnStlmtPaymentDelete").show();
                    $("#winLoanInstallment").icsWindow('open');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnEditSettlement').click(function(e){
        var oLoan = $('#divLoan').data("Loan");
        if(oLoan===null || parseInt(oLoan.LoanID)<=0)
        {
            alert("Invalid Loan!");
            return;
        }
        if(oLoan===null || parseInt(oLoan.ReceivedBy) === 0)
        {
            alert("Please Select an Received Loan!");
            return;
        }

        var oLoanInstallment = $("#tblInstallment").datagrid("getSelected");
        if(oLoanInstallment === null ||     parseInt(oLoanInstallment.LoanInstallmentID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        var nSelectedIndex  = $("#tblInstallment").datagrid("getRowIndex", oLoanInstallment);
        $("#winLoanInstallment").data('SelectedIndex', nSelectedIndex);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/GetLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    $("#winLoanInstallment").data('LoanInstallment', oLoanInstallment);
                    StlmtLoanRestControls();
                    StlmtLoanRefreshControls();
                    $("#btnStlmtSaveLoanSettlement").show();
                    $("#btnStlmtApprovedLoanSettlement").hide();
                    $("#btnStlmtAddCharge,#btnStlmtChargeDelete").show();
                    $("#btnStlmtPaymentAdd,#btnStlmtPaymentDelete").show();
                    $("#winLoanInstallment").icsWindow('open');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnViewSettlement').click(function(e){
        var oLoan = $('#divLoan').data("Loan");
        if(oLoan===null || parseInt(oLoan.LoanID)<=0)
        {
            alert("Invalid Loan!");
            return;
        }
        if(oLoan===null || parseInt(oLoan.ReceivedBy) === 0)
        {
            alert("Please Select an Received Loan!");
            return;
        }

        var oLoanInstallment = $("#tblInstallment").datagrid("getSelected");
        if(oLoanInstallment === null ||     parseInt(oLoanInstallment.LoanInstallmentID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        var nSelectedIndex  = $("#tblInstallment").datagrid("getRowIndex", oLoanInstallment);
        $("#winLoanInstallment").data('SelectedIndex', nSelectedIndex);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/GetLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    $("#winLoanInstallment").data('LoanInstallment', oLoanInstallment);
                    StlmtLoanRestControls();
                    StlmtLoanRefreshControls();
                    $("#btnStlmtSaveLoanSettlement").hide();
                    $("#btnStlmtApprovedLoanSettlement").hide();
                    $("#btnStlmtAddCharge,#btnStlmtChargeDelete").hide();
                    $("#btnStlmtPaymentAdd,#btnStlmtPaymentDelete").hide();
                    //$("#winLoanInstallment :input").attr("disabled", true);
                    $("#winLoanInstallment").icsWindow('open');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnApprovedSettlement').click(function(e){
        var oLoan = $('#divLoan').data("Loan");
        if(oLoan===null || parseInt(oLoan.LoanID)<=0)
        {
            alert("Invalid Loan!");
            return;
        }
        if(oLoan===null || parseInt(oLoan.ReceivedBy) === 0)
        {
            alert("Please Select an Received Loan!");
            return;
        }

        var oLoanInstallment = $("#tblInstallment").datagrid("getSelected");
        if(oLoanInstallment === null ||     parseInt(oLoanInstallment.LoanInstallmentID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        if(parseInt(oLoanInstallment.SettlementBy)!=0)
        {
            alert("Your Selected Installment Already Approved!");
            return;
        }


        var nSelectedIndex  = $("#tblInstallment").datagrid("getRowIndex", oLoanInstallment);
        $("#winLoanInstallment").data('SelectedIndex', nSelectedIndex);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/GetLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    $("#winLoanInstallment").data('LoanInstallment', oLoanInstallment);
                    StlmtLoanRestControls();
                    StlmtLoanRefreshControls();
                    $("#btnStlmtSaveLoanSettlement").hide();
                    $("#btnStlmtApprovedLoanSettlement").show();
                    $("#btnStlmtAddCharge,#btnStlmtChargeDelete").hide();
                    $("#btnStlmtPaymentAdd,#btnStlmtPaymentDelete").hide();
                    //$("#winLoanInstallment :input").attr("disabled", true);
                    $("#winLoanInstallment").icsWindow('open');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnRemoveSettlement').click(function(e){
        var oLoanInstallment = $("#tblInstallment").datagrid("getSelected");
        if(oLoanInstallment === null ||     parseInt(oLoanInstallment.LoanInstallmentID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        if(parseInt(oLoanInstallment.SettlementBy)!=0)
        {
            alert("Your Selected Installment Already Approved!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblInstallment").datagrid("getRowIndex", oLoanInstallment);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/DeleteLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage == "Deleted")
                {
                    alert("Data Delete Successfully");
                    $("#tblInstallment").datagrid("deleteRow", nSelectedIndex);
                }
                else
                {
                    alert(sFeedBackMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    function StlmtLoanRestControls()
    {
        StlmtRefreshLoanComboBox();
        $("#txtStlmtLoanFileNo").val("");
        $("#txtStlmtLoanType").val("");
        $("#txtStlmtLoanNumber").val("");
        $("#txtStlmtLoanIssueDate").val("");
        $("#txtStlmtApproxStlmtDate").val("");

        $("#txtStlmtLoanStartDate").val("");
        $("#txtStlmtLoanExportLC").val("");
        $("#txtStlmtLoanAccountNo").val("");
        $("#txtStlmtLoanAmountCurrency").val("");
        $("#txtStlmtLoanAmount").val("0.00");

        $("#cboStlmtLoanTransfer").val("");
        $('#txtStlmtTransferDate').datebox('setValue', "");
        $("#txtStlmtTransferInterestDays").val("0");
        $("#txtStlmtLoanTransferInterestRate").val("0.00");
        $("#txtStlmtTransferInterestCurrency").val("");
        $("#txtStlmtTransferInterest").val("0.00");

        $("#txtStlmtLoanInterestRate").val(0.00);
        $('#txtStlmtSettlementDate').datebox('setValue', "");
        $("#txtStlmtInterestDays").val(0);
        $("#txtStlmtLoanInterestAmountCurrency").val("");
        $("#txtStlmtLoanInterestAmount").val("0.00");
        $("#txtStlmtTotalInterestAmountCurrency").val("");
        $("#txtStlmtTotalInterestAmount").val("0.00");
        $("#txtStlmtLiborRate").val(0.00);
        $("#txtStlmtLiborInterestAmount").val(0.00);


        $("#txtStlmtLoanPrincipleAmountCurrency").val("");
        $("#txtStlmtLoanPrincipleAmount").val("0.00");
        $("#txtStlmtLoanTotalChargeCurrency").val("");
        $("#txtStlmtLoanTotalCharge").val("0.00");
        $("#txtStlmtLoanStlmtRemarks").val("");

        $("#txtStlmtDiscountPaidAmount").val("0.00");
        $("#txtStlmtDiscountRcvAmount").val("0.00");
        $("#txtStlmtTotalPayableAmountCurrency").val("");
        $("#txtStlmtTotalPayableAmount").val("0.00");
        $("#txtStlmtLoanPaidAmountCurrency").val("");
        $("#txtStlmtLoanPaidAmount").val("0.00");

        $("#txtStlmtPaymentCRate").val("0.00");
        $("#txtStlmtLoanChargeCRate").val("0.00");
        $("#txtStlmtPaymentCRate").prop("disabled", false);
        $("#txtStlmtLoanChargeCRate").prop("disabled", false);

        $("#cboStlmtChargeCurSymbol").prop("disabled", false);
        $("#cboStlmtPaymentCurrencySymbol").prop("disabled", false);

        DynamicRefreshList([], "tblStlmtLoanCharge");
        DynamicRefreshList([], "tblStlmtPayment");
        StlmtRefreshLoanSummery();
    }

    function StlmtLoanRefreshControls()
    {
        var oLoanInstallment = $("#winLoanInstallment").data('LoanInstallment');
        var oCompany = $('#divLoan').data("BaseCurrency");
        StlmtRefreshLoanComboBox();
        $("#txtStlmtLoanFileNo").val(oLoanInstallment.FileNo);
        $("#txtStlmtLoanType").val(oLoanInstallment.LoanTypeSt);
        $("#txtStlmtLoanNumber").val(oLoanInstallment.LoanNo);
        $("#txtStlmtLoanIssueDate").val(oLoanInstallment.IssueDateShortSt);
        $("#txtStlmtApproxStlmtDate").val(oLoanInstallment.ApproxSettlementShortSt);

        $("#txtStlmtLoanStartDate").val(oLoanInstallment.InstallmentStartDateInString);
        $("#txtStlmtLoanExportLC").val(oLoanInstallment.LoanRefNo);
        $("#txtStlmtLoanAccountNo").val(oLoanInstallment.BankAccNo);
        $("#txtStlmtLoanAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtLoanAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.PrincipalAmount), null, 2));

        $("#cboStlmtLoanTransfer").val(parseInt(oLoanInstallment.LoanTransferTypeInt));
        $('#txtStlmtTransferDate').datebox('setValue', oLoanInstallment.TransferDateInString);
        $("#txtStlmtTransferInterestDays").val(oLoanInstallment.TransferDays);
        $("#txtStlmtLoanTransferInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.TransferInterestRate), null, 4));
        $("#txtStlmtTransferInterestCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtTransferInterest").val(icsFormatPrice(parseFloat(oLoanInstallment.TransferInterestAmount), null, 2));

        $("#txtStlmtLoanInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestRate), null, 4));
        $('#txtStlmtSettlementDate').datebox('setValue', oLoanInstallment.SettlementDateInString);
        $("#txtStlmtInterestDays").val(oLoanInstallment.InterestDays);
        $("#txtStlmtLoanInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtLoanInterestAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestAmount), null, 2));
        $("#txtStlmtTotalInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtTotalInterestAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.TotalInterestAmount), null, 2));
        $("#txtStlmtLiborRate").val(icsFormatPrice(parseFloat(oLoanInstallment.LiborRate), null, 4));
        $("#txtStlmtLiborInterestAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.LiborInterestAmount), null, 4));

        $("#txtStlmtLoanPrincipleAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtLoanPrincipleAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.LoanPrincipalAmount), null, 2));
        $("#txtStlmtLoanPrincipleAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtLoanTotalCharge").val(icsFormatPrice(parseFloat(oLoanInstallment.ChargeAmount), null, 2));
        $("#txtStlmtLoanStlmtRemarks").val(oLoanInstallment.Remarks);


        $("#txtStlmtDiscountPaidAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.DiscountPaidAmount), null, 2));
        $("#txtStlmtDiscountRcvAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.DiscountRcvAmount), null, 2));
        $("#txtStlmtTotalPayableAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtTotalPayableAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.TotalPayableAmount), null, 2));
        $("#txtStlmtLoanPaidAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtStlmtLoanPaidAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.PaidAmount), null, 2));


        $("#cboStlmtChargeCurSymbol").val(oLoanInstallment.LoanCurencyID);
        $("#cboStlmtPaymentCurrencySymbol").val(oLoanInstallment.LoanCurencyID);
        $("#cboStlmtChargeCurSymbol,#cboStlmtPaymentCurrencySymbol").prop("disabled", true);

        if(parseInt(oCompany.BaseCurrencyID) === parseInt(oLoanInstallment.LoanCurencyID))
        {
            $("#txtStlmtPaymentCRate").val("1.00");
            $("#txtStlmtLoanChargeCRate").val("1.00");

            $("#txtStlmtPaymentCRate").prop("disabled", true);
            $("#txtStlmtLoanChargeCRate").prop("disabled", true);
        }
        else
        {
            $("#txtStlmtPaymentCRate").val("0.00");
            $("#txtStlmtLoanChargeCRate").val("0.00");

            $("#txtStlmtPaymentCRate").prop("disabled", false);
            $("#txtStlmtLoanChargeCRate").prop("disabled", false);
        }

        DynamicRefreshList(oLoanInstallment.LoanchargeList, "tblStlmtLoanCharge");
        DynamicRefreshList(oLoanInstallment.PaymentList, "tblStlmtPayment");
        StlmtRefreshLoanSummery();
    }

    function StlmtRefreshLoanComboBox()
    {
        var oCurrencys = $('#divLoan').data("Currencys");
        var oBankAccounts = $('#divLoan').data("BankAccounts");
        var oExpenditureHeads = $('#divLoan').data("ExpenditureHeads");
        var oTrnasferTypes = $('#divLoan').data("LoanTransferTypes");

        $("#cboStlmtBankAC").icsLoadCombo({List: oBankAccounts, OptionValue:"BankAccountID",DisplayText: "AccountNo", InitialValue:"--Bank A/C--" });
        $("#cboStlmtExpenseHead").icsLoadCombo({List: oExpenditureHeads, OptionValue:"AccountHeadID",DisplayText: "AccountHeadName", InitialValue:"--Expense Head--"});
        $("#cboStlmtChargeCurSymbol").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "Symbol", InitialValue:"--Currency--"});
        $("#cboStlmtPaymentCurrencySymbol").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "Symbol", InitialValue:"--Currency--"});
        $("#cboStlmtLoanTransfer").icsLoadCombo({List: oTrnasferTypes, OptionValue:"id",DisplayText: "Value" });
    }

    function StlmtRefreshLoanSummery()
    {
        var oLoan = $('#divLoan').data("Loan");
        var oLoanInstallment = $("#winLoanInstallment").data('LoanInstallment');
        if(oLoanInstallment != null && oLoanInstallment != undefined)
        {
            var oPayments = $("#tblStlmtPayment").datagrid("getRows");
            var oLoanCharges = $("#tblStlmtLoanCharge").datagrid("getRows");
            var nPaymentBC = 0; var nPayment =0;
            var nLoanChargeBC = 0; var nLoanCharge =0;
            var nLoanTransferInterestAmount =0;
            var nLoanInterestAmount =0;
            var nLiborInterestAmount =0;
            var nTotalInterestAmount =0;
            var nTotalPayableAmount = 0;
            var nLoanTransferType = parseInt($('#cboStlmtLoanTransfer').val());
            var dLoanStartDate = new Date(oLoanInstallment.InstallmentStartDateInString);
            if(nLoanTransferType != 0)
            {
                var dtxtTransferDate = new Date($('#txtStlmtTransferDate').datebox('getValue'));
                var nLoanTransferDays = parseInt((dtxtTransferDate - dLoanStartDate)/(1000 * 60 * 60 * 24));                
                $("#txtStlmtTransferInterestDays").val(parseInt(nLoanTransferDays));
                var nLoanTransferInterestRate = parseFloat(icsRemoveComma($("#txtStlmtLoanTransferInterestRate").val()));
                nLoanTransferInterestAmount = ((((parseFloat(oLoanInstallment.PrincipalAmount) * parseFloat(nLoanTransferInterestRate))/100.00) / 360.00) * parseFloat(nLoanTransferDays));
                $("#txtStlmtTransferInterest").val(oLoanInstallment.LoanCurency+ " "+  icsFormatPrice(parseFloat(nLoanTransferInterestAmount), null, 2));
                dLoanStartDate = new Date($('#txtStlmtTransferDate').datebox('getValue'));
            }
            var dSettlementDate = new Date($('#txtStlmtSettlementDate').datebox('getValue'));
            var nLoanDays = parseInt((dSettlementDate - dLoanStartDate)/(1000 * 60 * 60 * 24));
            if(parseInt(oLoan.LoanTypeInt) === 2)
            {
                nLoanDays = (nLoanDays +1);
            }
            var nInterestRate = parseFloat(icsRemoveComma($("#txtStlmtLoanInterestRate").val()));
            nLoanInterestAmount = ((((parseFloat(oLoanInstallment.PrincipalAmount) * parseFloat(nInterestRate))/100.00) / 360.00) * parseFloat(nLoanDays));

            var nLiborInterestRate = parseFloat(icsRemoveComma($("#txtStlmtLiborRate").val()));
            nLiborInterestAmount = ((((parseFloat(oLoanInstallment.PrincipalAmount) * parseFloat(nLiborInterestRate))/100.00) / 360.00) * parseFloat(nLoanDays));
            nTotalInterestAmount = (nLoanTransferInterestAmount + nLoanInterestAmount + nLiborInterestAmount);
            for(var i=0; i < oLoanCharges.length; i++)
            {
                nLoanChargeBC = nLoanChargeBC + parseFloat(oLoanCharges[i].AmountBC);
                nLoanCharge = nLoanCharge + parseFloat(oLoanCharges[i].Amount);
            }

            for(var i=0; i < oPayments.length; i++)
            {
                nPaymentBC = nPaymentBC + parseFloat(oPayments[i].AmountBC);
                nPayment = nPayment + parseFloat(oPayments[i].Amount);
            }

            var nDiscountPaidAmount = parseFloat(icsRemoveComma($("#txtStlmtDiscountPaidAmount").val()));
            var nDiscountRcvAmount = parseFloat(icsRemoveComma($("#txtStlmtDiscountRcvAmount").val()));
            nTotalPayableAmount = (parseFloat(oLoanInstallment.PrincipalAmount) + parseFloat(nTotalInterestAmount) + parseFloat(nLoanCharge) + parseFloat(nDiscountPaidAmount) - parseFloat(nDiscountRcvAmount));
            $("#txtStlmtInterestDays").val(parseInt(nLoanDays));
            $("#txtStlmtLoanInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtStlmtLoanInterestAmount").val(icsFormatPrice(parseFloat(nLoanInterestAmount), null, 2));
            $("#txtStlmtLiborInterestAmount").val(icsFormatPrice(parseFloat(nLiborInterestAmount), null, 2));
            $("#txtStlmtTotalInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtStlmtTotalInterestAmount").val(icsFormatPrice(parseFloat(nTotalInterestAmount), null, 2));
            $("#txtStlmtTotalPayableAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtStlmtTotalPayableAmount").val(icsFormatPrice(parseFloat(nTotalPayableAmount), null, 2));

            var FooterField=[];
            var obj=new Object();
            obj['AccountName'] = "Grand Total:";
            obj['Amount'] = parseFloat(parseFloat(nLoanCharge).toFixed(2));
            obj['AmountBC'] = parseFloat(parseFloat(nLoanChargeBC).toFixed(2));
            FooterField.push(obj);
            $('#tblStlmtLoanCharge').datagrid('reloadFooter',FooterField);
            $("#txtStlmtLoanTotalChargeCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtStlmtLoanTotalCharge").val(icsFormatPrice(parseFloat(nLoanCharge), null, 2));

            var FooterFieldPmt = [];
            var objPmt =new Object();
            objPmt['AccountName']="Grand Total:";
            objPmt['Amount'] = parseFloat(parseFloat(nPayment).toFixed(2));
            objPmt['AmountBC'] = parseFloat(parseFloat(nPaymentBC).toFixed(2));
            FooterFieldPmt.push(objPmt);
            $('#tblStlmtPayment').datagrid('reloadFooter',FooterFieldPmt);
            $("#txtStlmtLoanPaidAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtStlmtLoanPaidAmount").val(icsFormatPrice(parseFloat(nPayment), null, 2));
            $("#txtStlmtLoanPaidAmount").data('PaymentBC', parseFloat(nPaymentBC));

            var nBalanceAmount = (parseFloat(nTotalPayableAmount)  - parseFloat(nPayment));
            if(nBalanceAmount>=0)
            {
                $("#lblStlmtLoanBalance").text("Balance : "+oLoanInstallment.LoanCurency+" "+ icsFormatPrice(parseFloat(nBalanceAmount), null, 2));
            }
            else
            {
                nBalanceAmount = (nBalanceAmount * (-1));
                $("#lblStlmtLoanBalance").text("Balance : "+oLoanInstallment.LoanCurency+" ("+ icsFormatPrice(parseFloat(nBalanceAmount), null, 2)+ ")");
            }
        }
    }

    function StlmtRefreshObjectLoanInstallment()
    {
        var oTempLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var oLoanInstallment = {
            LoanInstallmentID : parseInt(oTempLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oTempLoanInstallment.LoanID),
            InstallmentNo : oTempLoanInstallment.InstallmentNo,
            InstallmentStartDate : oTempLoanInstallment.InstallmentStartDateInString,
            InstallmentStartDateInString : oTempLoanInstallment.InstallmentStartDateInString,
            InstallmentDate : $('#txtStlmtSettlementDate').datebox('getValue'),
            InstallmentDateInString : $('#txtStlmtSettlementDate').datebox('getValue'),
            PrincipalAmount : parseFloat(oTempLoanInstallment.PrincipalAmount),
            LoanTransferType : parseInt($('#cboStlmtLoanTransfer').val()),
            LoanTransferTypeInt : parseInt($('#cboStlmtLoanTransfer').val()),
            TransferDate : $('#txtStlmtTransferDate').datebox('getValue'),
            TransferDateInString : $('#txtStlmtTransferDate').datebox('getValue'),
            TransferDays : parseInt($("#txtStlmtTransferInterestDays").val()),
            TransferInterestRate : parseFloat(icsRemoveComma($("#txtStlmtLoanTransferInterestRate").val())),
            TransferInterestAmount : parseFloat(icsRemoveComma($("#txtStlmtTransferInterest").val())),
            SettlementDate : $('#txtStlmtSettlementDate').datebox('getValue'),
            SettlementDateInString : $('#txtStlmtSettlementDate').datebox('getValue'),
            InterestDays : parseInt($("#txtStlmtInterestDays").val()),
            InterestRate : parseFloat(icsRemoveComma($("#txtStlmtLoanInterestRate").val())),
            InterestAmount : parseFloat(icsRemoveComma($("#txtStlmtLoanInterestAmount").val())),
            LiborRate : parseFloat(icsRemoveComma($("#txtStlmtLiborRate").val())),
            LiborInterestAmount : parseFloat(icsRemoveComma($("#txtStlmtLiborInterestAmount").val())),
            TotalInterestAmount : parseFloat(icsRemoveComma($("#txtStlmtTotalInterestAmount").val())),
            ChargeAmount : parseFloat(icsRemoveComma($("#txtStlmtLoanTotalCharge").val())),
            DiscountPaidAmount : parseFloat(icsRemoveComma($("#txtStlmtDiscountPaidAmount").val())),
            DiscountRcvAmount : parseFloat(icsRemoveComma($("#txtStlmtDiscountRcvAmount").val())),
            TotalPayableAmount : parseFloat(icsRemoveComma($("#txtStlmtTotalPayableAmount").val())),
            PaidAmount : parseFloat(icsRemoveComma($("#txtStlmtLoanPaidAmount").val())),
            PaidAmountBC : parseFloat(parseFloat($("#txtStlmtLoanPaidAmount").data('PaymentBC')).toFixed(2)),
            PrincipalDeduct : (0.00),
            PrincipalBalance : (0.00),
            Remarks : $('#txtStlmtLoanStlmtRemarks').val(),
            SettlementBy : parseInt(oTempLoanInstallment.SettlementBy),
            SettlementByName : oTempLoanInstallment.SettlementByName,
            FileNo : oTempLoanInstallment.FileNo,
            LoanNo : oTempLoanInstallment.LoanNo,
            LoanRefType : parseInt(oTempLoanInstallment.LoanRefType),
            LoanCRate : parseFloat(oTempLoanInstallment.LoanCRate),
            LoanPrincipalAmount : parseFloat(oTempLoanInstallment.LoanPrincipalAmount),
            LoanRefID : parseInt(oTempLoanInstallment.LoanRefID),
            LoanRefNo : oTempLoanInstallment.LoanRefNo,
            LoanType : (oTempLoanInstallment.LoanType),
            LoanTypeSt : oTempLoanInstallment.LoanTypeSt,
            ApproxSettlement : oTempLoanInstallment.ApproxSettlementSt,
            ApproxSettlementSt : oTempLoanInstallment.ApproxSettlementSt,
            IssueDate : oTempLoanInstallment.IssueDateSt,
            IssueDateSt : oTempLoanInstallment.IssueDateSt,
            BankAccNo : oTempLoanInstallment.BankAccNo,
            LoanCurencyID : parseInt(oTempLoanInstallment.LoanCurencyID),
            LoanCurency : oTempLoanInstallment.LoanCurency,
            LoanchargeList : $("#tblStlmtLoanCharge").datagrid("getRows"),
            PaymentList : $("#tblStlmtPayment").datagrid("getRows")
        }
        return oLoanInstallment;
    }

    function StlmtValidateLoanInstallment()
    {
        var oTempLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        if(oTempLoanInstallment === undefined || oTempLoanInstallment === null || parseInt(oTempLoanInstallment.LoanID)<=0)
        {
            alert("Invalid Loan! Please Try Again!");
            return false;
        }

        var sSettlementDate = $('#txtStlmtSettlementDate').datebox('getValue');
        if(sSettlementDate === null || sSettlementDate === "")
        {
            alert("Please Select Loan Settlement Date!!");
            return false;
        }

        if(parseInt($('#cboStlmtLoanTransfer').val())!=0)
        {
            var sTransferDate = $('#txtStlmtTransferDate').datebox('getValue');
            if(sTransferDate === null || sTransferDate === "")
            {
                alert("Please Select Loan Transfer Date!!");
                return false;
            }
            if(parseInt($("#txtStlmtTransferInterestDays").val())<=0)
            {
                alert("Invalid Transfer Days Count!!");
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtStlmtLoanTransferInterestRate").val()))<=0)
            {
                alert("Please Enter Transfer Interest Rate!!");
                $('#txtStlmtLoanTransferInterestRate').focus();
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtStlmtTransferInterest").val()))<=0)
            {
                alert("Please Enter Transfer Interest Amount!!");
                $('#txtStlmtLoanTransferInterestRate').focus();
                return false;
            }
        }
        if(parseInt($("#txtStlmtInterestDays").val())<=0)
        {
            alert("Invalid Interest Days Count!!");
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtLoanInterestRate").val()))<=0)
        {
            alert("Please Enter Interest Rate!!");
            $('#txtLoanInterestRate').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtLoanInterestAmount").val()))<=0)
        {
            alert("Please Enter Interest Amount!!");
            $('#txtStlmtLoanInterestAmount').focus();
            return false;
        }

        if(parseInt(oTempLoanInstallment.LoanTypeInt) != 1)//LoanType : PADLoan = 1 || Loan Transfer Type : PADTOEDF = 1
        {
            if(parseInt($('#cboStlmtLoanTransfer').val()) === 1)
            {
                alert("Loan Transfer PAD --> EDF only for PAD Loan!!");
                $('#txtStlmtLiborRate').focus();
                return false;
            }
        }

        if(parseInt(oTempLoanInstallment.LoanTypeInt) === 2 || parseInt($('#cboStlmtLoanTransfer').val()) === 1)//LoanType : EDFLoan = 2 || Loan Transfer Type : PADTOEDF = 1
        {
            if(parseFloat(icsRemoveComma($("#txtStlmtLiborRate").val()))<=0)
            {
                alert("Please Enter Libor Rate!!");
                $('#txtStlmtLiborRate').focus();
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtStlmtLiborInterestAmount").val()))<=0)
            {
                alert("Please Enter Libor Interest Amount!!");
                $('#txtStlmtLiborInterestAmount').focus();
                return false;
            }
        }

        if(parseInt(oTempLoanInstallment.LoanTypeInt) != 2 && parseInt($('#cboStlmtLoanTransfer').val()) != 1)//LoanType : EDFLoan = 2 || Loan Transfer Type : PADTOEDF = 1
        {
            if(parseFloat(icsRemoveComma($("#txtStlmtLiborRate").val()))>0)
            {
                alert("Libor Rate Only for EDF Loan!!");
                $('#txtStlmtLiborRate').focus();
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtStlmtLiborInterestAmount").val()))>0)
            {
                alert("Libor Interest Only for EDF Loan!!");
                $('#txtStlmtLiborInterestAmount').focus();
                return false;
            }
        }

        if(parseFloat(icsRemoveComma($("#txtStlmtTotalInterestAmount").val()))<=0)
        {
            alert("Please Enter Total Interest Amount!!");
            $('#txtStlmtTotalInterestAmount').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtTotalPayableAmount").val()))<=0)
        {
            alert("Invalid Total Payable Amount!!");
            $('#txtStlmtTotalPayableAmount').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtLoanPaidAmount").val()))<=0)
        {
            alert("Please Enter Paid Amount!!");
            $('#txtStlmtLoanPaidAmount').focus();
            return false;
        }

        var nTotalPayableAmount =  parseFloat(icsRemoveComma($("#txtStlmtTotalPayableAmount").val()));
        var nTotalPaidAmount =  parseFloat(icsRemoveComma($("#txtStlmtLoanPaidAmount").val()));
        var nTempBalanceAmount = (nTotalPayableAmount - nTotalPaidAmount);
        if(nTempBalanceAmount<0)
        {
            nTempBalanceAmount = (nTempBalanceAmount * (-1));
            if(nTempBalanceAmount>0.05)
            {
                alert("Principle Balance Amount Must Be Non Negetive!!");
                $('#txtStlmtLoanPaidAmount').focus();
                return false;
            }
        }
        return true;
    }

    $("#btnStlmtSaveLoanSettlement").click(function (){
        if(!StlmtValidateLoanInstallment()) return;
        var oLoanInstallment = StlmtRefreshObjectLoanInstallment();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/SaveLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    alert("Data Save Successfully");
                    var nSelectedIndex =  parseInt($("#winLoanInstallment").data('SelectedIndex'));
                    if(nSelectedIndex<0)
                    {
                        $('#tblInstallment').datagrid('appendRow', oLoanInstallment);
                    }
                    else
                    {
                        $('#tblInstallment').datagrid('updateRow',{ index: nSelectedIndex, row: oLoanInstallment });
                    }
                    $("#winLoanInstallment").icsWindow('close');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $("#btnStlmtApprovedLoanSettlement").click(function (){
        if(!StlmtValidateLoanInstallment()) return;
        var oLoanInstallment = StlmtRefreshObjectLoanInstallment();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress") + "/Loan/ApprovedLoanInstallment",
            traditional: true,
            data:  JSON.stringify(oLoanInstallment),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oLoanInstallment = jQuery.parseJSON(data);
                if (oLoanInstallment.ErrorMessage == null || oLoanInstallment.ErrorMessage == "")
                {
                    alert("Approved Successfully");
                    var nSelectedIndex =  parseInt($("#winLoanInstallment").data('SelectedIndex'));
                    if(nSelectedIndex<0)
                    {
                        $('#tblInstallment').datagrid('appendRow', oLoanInstallment);
                    }
                    else
                    {
                        $('#tblInstallment').datagrid('updateRow',{ index: nSelectedIndex, row: oLoanInstallment });
                    }
                    $("#winLoanInstallment").icsWindow('close');
                }
                else
                {
                    alert(oLoanInstallment.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $("#btnStlmtCloseLoan").click(function (){
        $("#winLoanInstallment").icsWindow('close');
    });

    $('#txtStlmtSettlementDate,#txtStlmtTransferDate').datebox({
        onSelect: function(date){
            StlmtRefreshLoanSummery();
        }
    });

    $("#txtStlmtLoanInterestRate,#txtStlmtLiborRate,#txtStlmtLoanTransferInterestRate,#txtStlmtDiscountPaidAmount,#txtStlmtDiscountRcvAmount").keyup(function (e) {
        StlmtRefreshLoanSummery();
    });

    $("#cboStlmtLoanTransfer").change(function(e){
        var nLoanTransfer = parseInt($("#cboStlmtLoanTransfer").val());
        if(nLoanTransfer === 0)
        {
            $('#txtStlmtTransferDate').datebox('setValue', "");
            $("#txtStlmtTransferInterestDays").val("0");
            $("#txtStlmtLoanTransferInterestRate").val("0.00");
            $("#txtStlmtTransferInterest").val("0.00");
        }
        else
        {
            var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
            if(oLoanInstallment != null && oLoanInstallment != undefined)
            {
                $('#txtStlmtTransferDate').datebox('setValue', oLoanInstallment.SettlementDateInString);
                $("#txtStlmtLoanTransferInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestRate), null, 4));
            }
        }
        StlmtRefreshLoanSummery();
    });

    $('#btnStlmtAddCharge').click(function(e){
        if(parseInt($('#cboStlmtExpenseHead').val())<=0)
        {
            alert("Please Select Charge Head!");
            $('#cboStlmtExpenseHead').focus();
            return;
        }
        if(parseInt($('#cboStlmtChargeCurSymbol').val())<=0)
        {
            alert("Please Select Charge Currency!");
            $('#cboStlmtChargeCurSymbol').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtLoanChargeCRate").val()))<=0)
        {
            alert("Please Enter Charge Currency Rate!");
            $('#txtStlmtLoanChargeCRate').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtLoanChargeAmount").val()))<=0)
        {
            alert("Please Enter Charge Amount!");
            $('#txtStlmtLoanChargeCRate').focus();
            return;
        }

        var oLoanCharges = $("#tblStlmtLoanCharge").datagrid("getRows");
        for(var i=0; i<oLoanCharges.length; i++)
        {
            if(parseInt($('#cboStlmtExpenseHead').val()) === parseInt(oLoanCharges[i].ExpenseHeadID))
            {
                alert("Your Selected Charge Head Already Exists!");
                $('#cboStlmtExpenseHead').focus();
                return;
            }
        }

        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var nLoanChargeCRate = parseFloat(icsRemoveComma($("#txtStlmtLoanChargeCRate").val()));
        var nLoanChargeAmount = parseFloat(icsRemoveComma($("#txtStlmtLoanChargeAmount").val()));
        var oLoanCharge = {
            LoanSettlementID : 0,
            LoanInstallmentID : parseInt(oLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oLoanInstallment.LoanID),
            BankAccountID : 0,
            ExpenseHeadID : parseInt($('#cboStlmtExpenseHead').val()),
            CurrencyID : parseInt($('#cboStlmtChargeCurSymbol').val()),
            AmountBC : parseFloat((parseFloat(nLoanChargeCRate) * parseFloat(nLoanChargeAmount)).toFixed(2)),
            CRate : parseFloat(nLoanChargeCRate),
            Amount : parseFloat(parseFloat(nLoanChargeAmount).toFixed(2)),
            Remarks : "N/A",
            AccountName : $("#cboStlmtExpenseHead option:selected").text(),
            CurrencySymbol : $("#cboStlmtChargeCurSymbol option:selected").text()
        }
        $('#tblStlmtLoanCharge').datagrid('appendRow', oLoanCharge);
        $('#cboStlmtExpenseHead').val(0);
        $("#txtStlmtLoanChargeAmount").val("0.00");
        StlmtRefreshLoanSummery();
    });

    $('#btnStlmtChargeDelete').click(function(e){
        var oLoanCharge = $("#tblStlmtLoanCharge").datagrid("getSelected");
        if(oLoanCharge === null ||     parseInt(oLoanCharge.ExpenseHeadID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblStlmtLoanCharge").datagrid("getRowIndex", oLoanCharge);
        $("#tblStlmtLoanCharge").datagrid("deleteRow", nSelectedIndex);
        StlmtRefreshLoanSummery();
    });

    $('#btnStlmtPaymentAdd').click(function(e){
        if(parseInt($('#cboStlmtBankAC').val())<=0)
        {
            alert("Please Select Bank Account!");
            $('#cboStlmtBankAC').focus();
            return;
        }
        if(parseInt($('#cboStlmtPaymentCurrencySymbol').val())<=0)
        {
            alert("Please Select Paid Currency!");
            $('#cboPStlmtaymentCurrencySymbol').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtPaymentCRate").val()))<=0)
        {
            alert("Please Enter Paid Currency Rate!");
            $('#txtStlmtPaymentCRate').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtStlmtPaymentAmount").val()))<=0)
        {
            alert("Please Enter Paid Amount!");
            $('#txtStlmtPaymentAmount').focus();
            return;
        }

        var oPayments = $("#tblStlmtPayment").datagrid("getRows");
        for(var i=0; i<oPayments.length; i++)
        {
            if(parseInt($('#cboStlmtBankAC').val()) === parseInt(oPayments[i].BankAccountID))
            {
                alert("Your Selected Bank A/C Head Already Exists!");
                $('#cboStlmtBankAC').focus();
                return;
            }
        }

        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var nPaymentCRate = parseFloat(icsRemoveComma($("#txtStlmtPaymentCRate").val()));
        var nPaymentAmount = parseFloat(icsRemoveComma($("#txtStlmtPaymentAmount").val()));
        var oPayment = {
            LoanSettlementID : 0,
            LoanInstallmentID : parseInt(oLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oLoanInstallment.LoanID),
            BankAccountID : parseInt($('#cboStlmtBankAC').val()),
            ExpenseHeadID : 0,
            CurrencyID : parseInt($('#cboStlmtPaymentCurrencySymbol').val()),
            AmountBC : parseFloat((parseFloat(nPaymentCRate) * parseFloat(nPaymentAmount)).toFixed(2)),
            CRate : parseFloat(nPaymentCRate),
            Amount : parseFloat(parseFloat(nPaymentAmount).toFixed(2)),
            Remarks : "N/A",
            AccountName : $("#cboStlmtBankAC option:selected").text(),
            CurrencySymbol : $("#cboStlmtPaymentCurrencySymbol option:selected").text()
        }
        $('#tblStlmtPayment').datagrid('appendRow', oPayment);
        $('#cboStlmtBankAC').val(0);
        $("#txtStlmtPaymentAmount").val("0.00");
        StlmtRefreshLoanSummery();
    });

    $('#btnStlmtPaymentDelete').click(function(e){
        var oPayment = $("#tblStlmtPayment").datagrid("getSelected");
        if(oPayment === null ||     parseInt(oPayment.BankAccountID)<=0)
        {
            alert("Please Select an Item From List!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblStlmtPayment").datagrid("getRowIndex", oPayment);
        $("#tblStlmtPayment").datagrid("deleteRow", nSelectedIndex);
        StlmtRefreshLoanSummery();
    });
    //end Loan Settlement

</script>



