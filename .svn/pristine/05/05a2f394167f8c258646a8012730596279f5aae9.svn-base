@{
    ViewBag.Title = "FN Production";
}
@model ESimSol.BusinessObjects.FNProduction

<div class="menuMainCollectionTable" style="width:100%">
    <div id="divPanel" class="ics-panel-header" title="FN Batch" style="font-family:Tahoma;text-align:left; width:100%">
        <label> Treatment </label>
        <select id="cboFNTreatment" class="cbo-styler" style="width:26%; height:22px; background-color:#EFF5FF; font-size:12px; font-weight:bold" disabled></select>
    </div>
    <div id="divPanel" title="FN Batch" style="font-family:Tahoma;text-align:center; width:100%">
        <fieldset>
            <legend class="text-left">Search Criteria : </legend>
            <table border="0" cellpadding="1" cellspacing="1" style="margin:0 auto">
                <tr>
                    <td style="width:6%; text-align:right;"><label class="text-right" style="padding-top:5px">Process : </label></td>
                    <td style="width:22%;text-align:left;">
                        <input type="text" id="txtFNProcess_Entry" style="font-weight:bold; width:100%" placeholder="Search By Process Name" />
                    </td>
                       
                    <td style="width:6%; text-align:right;"><label class="text-right" style="padding-top:5px">Machine : </label></td>
                    <td style="width:22%;text-align:left;">
                        <input id="txtFNMachine" style="width:100%" onkeydown="SearchKeyMachine(event)" placeholder="Search By Machine Name" />
                    </td>

                    <td style="width:5%; text-align:right;"><label class="text-right">Start :</label></td>
                    <td style="width:16%;text-align:left;">
                        <input id="dtStart_FNP" class="easyui-datetimebox" style="width:100%" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </td>
                    <td style="width:4%; text-align:right;"><label class="text-right">End :</label></td>
                    <td style="width:15%;text-align:left;">
                        <input id="dtEnd_FNP" class="easyui-datetimebox" style="width:100%" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
    <div style="height:410px; width:100%">
        <table id="tblFNPBatch" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" showfooter="true" autorowheight="false" toolbar="#toolbarFNBatch">
            <thead>
                <tr>
                    <th field="BatchNo" width="10%">Batch No</th>
                    @*<th field="Code" width="10%">Code</th>*@
                    <th field="FNProcess" width="10%"> Process</th>
                    @*<th field="StartDateSt" width="10%">Start Date</th>
                    <th field="EndDateSt" width="10%">End Date</th>*@
                    <th field="StartQty" width="10%" align="right" formatter="formatPrice">Start Qty(Y)</th>
                    <th field="EndQty" width="10%" align="right" formatter="formatPrice">End Qty(Y)</th>
                    @*<th field="FNTreatmentSt" width="15%" align="left">Treatment</th>*@
                    <th field="QCStatusStr" width="10%" align="center">QC Status</th>
                    <th field="QCStatus" width="115" formatter="formatDoneInfo" align="center">QC Pass/Fail</th>
                    @*<th field="SequenceNo" width="10%" align="center">Sequence</th>*@
                    <th field="IsProductionInString" width="10%"> Batch Type</th>
                </tr>
            </thead>
        </table>
        <div id="toolbarFNBatch">
            <select id="cboType" style="height:22px;"><option value="0">Fresh</option><option value="1">Reproduction</option></select>
            <input type="text" id="txtFNBatchNo" style="font-weight:bold;width:180px" placeholder="Type Batch no & press enter" />
            <a id="btnUpdateProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-edit" plain="true">Production Process</a>
            <a id="btnRemoveProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-remove" plain="true">Remove</a>
            <a id="btnRequestForQC" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-forword" plain="true" onclick="RequestForQC(1)"> Forword</a>
            <a id="btnUndoRequest" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true" onclick="RequestForQC(0)"> Undo</a>
            @*<a id="btnAddProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-add" plain="true">Add New Process</a>*@
            @*<a id="btnSequenceProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-add" plain="true">Sequence Process</a>*@

            @*<a id="btnPrintXL" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintXL()">WIP In XL</a>*@
            <a id="btnPrint_Production" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print_Production()">Production Statement</a>
            <a id="btnPrint" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print()">Batch Statement</a>
        </div>
    </div>

    <fieldset style="margin-bottom:3px">
        <legend style="font-weight:bold"> Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:100%">
            <tr>
                <td style="width:79%; text-align:right"></td>
                <td style="width:7%">
                    <a id="btnRunOut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="RunOut()"> RunOut</a>
                </td>
                <td style="width:7%">
                    <a id="btnSaveFNProduction" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="SaveFNProduction()"> Save</a>
                </td>
                <td style="width:7%">
                    <a id="btnCloseFNProduction" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="CloseFNP()">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>

<div id="winFNPBatch" class=" easyui-window winclass" title="Update Process" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div id="divFNPB">
        <fieldset>
            <div style="width:1200px;font-size: 11px; font-weight: bold; padding-left:30px">
                <div class="col-md-12 top">
                    <div class="col-md-1" style="text-align: right"><label>Department:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtTreatment" style="width:76%" class="txt-styler" type="text" disabled />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Process:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtProcess" style="width:76%" class="txt-styler" type="text" disabled />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Machine:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtMachineName" type="text" style="width:76%; height:22px" disabled />
                    </div>
                </div>
             
                <div class="col-md-12">
                    <div class="col-md-1" style="text-align: right"><label>Qty ST:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtProcessQty" style="width:32%" class="txt-styler number" type="text" />
                        <label>Y</label>
                        <input id="txtProcessQtyM" style="width:32%" class="txt-styler number" type="text" />
                        <label>M</label>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Qty EN:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtProcessQty_End" style="width:32%" class="txt-styler number" type="text" />
                        <label>Y</label>
                        <input id="txtProcessQty_EndM" style="width:32%" class="txt-styler number" type="text" />
                        <label>M</label>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Date:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="dtIssue" style="width:76%" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" disabled />
                    </div>
                </div>
                <div class="col-md-12">
                   
                   
                    <div class="col-md-1" style="text-align:right"><label>Start Batcher:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <div class="input-group" style="width:78%">
                            <input id="txtStartBatcherName" type="text" style="width:86%" onkeydown="SearchKeyStartBatcher(event)" placeholder="Start Batcher Name" />
                            <button type="button" aria-label="Left Align" onclick="btnSearchStartBatcher()"> P </button>
                        </div>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>End Batcher:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <div class="input-group" style="width:78%">
                            <input id="txtEndBatcherName" type="text" style="width:86%" onkeydown="SearchKeyEndBatcher(event)" placeholder="End Batcher Name" />
                            <button type="button" aria-label="Left Align" onclick="btnSearchEndBatcher()"> P </button>
                        </div>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Shift:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboShift" class="cbo-styler" style="width:76%; height:22px"></select>
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Start Date:</label></div>
                    <div class="col-md-3" style="text-align: left">
                       
                        <input id="dtStart" class="easyui-datetimebox" style="width:76%;" type="text" required="required" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>End Date:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="dtEnd" class="easyui-datetimebox" style="width:76%;" type="text" required="required" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Pro. Hour:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtTtoalProHour" class="txt-styler" style="width:76%" type="text" disabled />
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Start Width:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtStartWidth" style="width:76%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>End Width:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtEndWidth" style="width:76%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Shade:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboShade" class="cbo-styler" style="width:76%; height:22px"></select>
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label style="font-size:11px">Machine Speed:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtMachineSpeed_Actual" style="width:35%" class="txt-styler number" type="text" disabled/>
                        <input id="txtMachineSpeed" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right;"><label style="font-size:10px">Paddder Pressure:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtPressure_Bar_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtPressure_Bar" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Temp (C):</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtTemp_C_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtTemp_C" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Intensity:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtFlameIntensity_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtFlameIntensity" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>Position:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtFlamePosition" style="width:76%" class="txt-styler number" type="text" />
                        @*<input id="txtFlamePosition_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtFlamePosition" style="width:40%" class="txt-styler number" type="text" />*@
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Process Type:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboProcessType" style="width:76%;height:22px;"></select>
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align:right;"><label>Remark:</label></div>
                    <div class="col-md-11" style=" text-align: left;">
                        <input id="txtRemark" style="width:93%;margin-left:-15px;"  type="text" />
                    </div>
                </div>
                @*Shade, StartWidth, EndWidth, Pressure_Bar, Temp_C, MachineSpeed, FlameIntensity, FlamePosition, Remark*@ 
            </div>
        </fieldset>
        <fieldset>
            <legend>Consumption Details:</legend>
            <table id="tblFNPConsumption" title="Process List" class="easyui-datagrid" style="width:100%;height:250px"
                   data-options="onClickCell : onClickCellPD, idField:'id',treeField:'code',singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false" toolbar="#toolbar_consumption">
                @*data-options=", rownumbers:'true'">*@
                <thead>
                    <tr>
                        <th field="ProductCode" width="10%" align="left">Code</th>
                        <th field="ProductName" width="12%" align="left">Product</th>
                        <th field="LotNo" width="10%" align="left">Lot No</th>
                        <th field="MUName" width="10%" align="left">M Unit</th>
                        <th field="LotBalance" width="10%" align="right">Lot Balance</th>
                        <th field="Qty" width="10%" align="center" editor="{type:'numberbox',options:{precision:3}}">Qty</th>
                        <th field="IsQCDoneSt" width="10%" align="left">Status</th>
                        
                    </tr>
                </thead>
            </table>
            <div id="toolbar_consumption">
                <input id="txtProductName" type="text" style="width:16%" placeholder="Type Name & Press Enter.." /> @*onkeydown="SearchKeyStartBatcher(event)"*@ 
                <button type="button" aria-label="Left Align" onclick="PickProduct()"> Pick Dyes/Chem. </button>

                <input id="txtLotNo" type="text" style="width:16%" placeholder="Type Lot No & Press Enter.." /> @*onkeydown="SearchKeyStartBatcher(event)"*@
                <button type="button" aria-label="Left Align" onclick="PickLot()"> Update Lot </button>
                <button type="button" aria-label="Left Align" onclick="PickLotAll()"> Update Lot (All)</button>

                <button type="button" aria-label="Left Align" onclick="RemoveProductConsumption()"> Remove Product</button>
            </div>
        </fieldset>
        <div style="width:100%;">
            <fieldset>
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:80%; text-align:left">
                            <span>
                                <label id="lblRemarks"></label>
                            </span>
                        </td>
                        <td style="width: 10%">
                            <a id="btnSaveFNP" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width: 10%">
                            <a id="btnCloseFNP" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<div id="winFNPConsumption" class=" easyui-window winclass" title="Add Plan Date" style="width:600px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div>
        <table id="tblFNPConsumption" title="Process List" class="easyui-datagrid" style="width:100%;height:500px"
               data-options="onClickCell : onClickCellPD, idField:'id',treeField:'code',singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false,toolbar: '#toolbar'">
            @*data-options=", rownumbers:'true'">*@
            <thead>
                <tr>
                    <th field="ProductCode" width="30%" align="left">Code</th>
                    <th field="ProductName" width="30%" align="left">ProductName</th>
                    <th field="Qty" width="30%" align="center" editor="{type:'number'}">Qty</th>
                    <th field="MUName" width="30%" align="left">M Unit</th>
                    <th field="LotNo" width="30%" align="left">Lot No</th>
                    <th field="LotBalance" width="30%" align="right">Lot Balance</th>
                    <th field="FNRNo" width="30%" align="left">Req. No</th>
                </tr>
                @*
                    ProductID = oFNR.ProductID,
                    ProductName = oFNR.ProductName,
                    ProductCode = oFNR.ProductCode,
                    FNPBatchID = oFNRecipe.FNPBatchID,
                    Qty = oFNRecipe.Qty,
                    LotID = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotID).FirstOrDefault(),
                    LotNo = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotNo).FirstOrDefault(),
                    LotBalance = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotBalance).FirstOrDefault(),
                    MUID = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.MeasurementUnitID).FirstOrDefault(),
                    MUName = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.MUName).FirstOrDefault()
                *@
            </thead>
        </table>
        <div style="width:100%;">
            <fieldset>
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:80%; text-align:left">
                            <span>
                                @*<label id="lblRemarks"></label>*@
                            </span>
                        </td>
                        <td style="width: 10%">
                            <a id="btnSavePlanedDate" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width: 10%">
                            <a id="btnCloseFNPConsumption" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<div id="winDone" class="easyui-window" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma">
        <fieldset style="margin-top:3px">
            <div align="left" style="padding:10px 10px 10px 10px">
                <table id="tblUser" border="0" style="font-size:12px;">
                    <tr>
                        <td style="text-align:right; width:15%"><label>QC Status :</label></td>
                        <td style="width:85%">
                            <select id="cboQCStatus" style="width:100%;">
                                <option value="">--Select One--</option>
                                <option value="2">QC Pass (OK)</option>
                                <option value="3">Qc Fail (Not OK)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right; width:15%"><label>Note :</label></td>
                        <td style="width:85%">
                            <input id="txtQCNote" type="text" required="required" style="width:100%;" />
                        </td>
                    </tr>
                </table>
            </div>
        </fieldset>
        <fieldset style="margin-bottom:3px">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                <tr>
                    <td style="width:300px; text-align:right"></td>
                    <td style="width:50px">
                        <a id="btnConfirm" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="Confirm()">Done</a>
                    </td>
                    <td style="width:50px">
                        <a id="btnCloseForDone" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

<div id="winBatch_Entry" class="easyui-window" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma">
        <fieldset style="margin-top:3px">
            <div align="left" style="padding:10px 10px 10px 10px">
                <table border="0" style="font-size:12px;">
                    <tr>
                        @*<td style="text-align:right; width:15%"><label>Process Code :</label></td>*@
                        <td style="width:15%; text-align:right;"><label class="text-right" style="padding-top:5px">Process :</label></td>
                        <td style="width:20%;text-align:left;">
                            @*<input type="text" id="txtFNProcess_Entry" style="font-weight:bold; width:76%" placeholder="Type Process name & press enter" />*@
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right; width:15%"><label>Plan Date :</label></td>
                        <td style="width:85%">
                            <input id="dtPlanDate_Entry" style="width:76%" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                    </tr>
                </table>
            </div>
        </fieldset>
        <fieldset style="margin-bottom:3px">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                <tr>
                    <td style="width:300px; text-align:right"></td>
                    <td style="width:50px">
                        <a id="btnSaveFNBatch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                    </td>
                    <td style="width:50px">
                        <a id="btnClose_Batch_Entry" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

<div id="winBatch_Sequence" class="easyui-window" style="width:800px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma; height:480px">
        <table id="tblFNPBatch_Sequence" class="easyui-datagrid" fit="true" style="width:98%;height:480px" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" showfooter="true" autorowheight="false" toolbar="#toolbarFNBatch_Sequence">
            <thead>
                <tr>
                    <th field="Code" width="10%">Code</th>
                    <th field="FNProcess" width="10%"> Process</th>
                    <th field="PlannedDateSt" width="10%">Plan Date</th>
                    <th field="FNTreatmentSt" width="15%" align="left">Treatment</th>
                    <th field="QCStatusStr" width="10%" align="center">QC Status</th>
                    <th field="SequenceNo" width="10%" align="center">Sequence</th>
                </tr>
            </thead>
        </table>
        <div id="toolbarFNBatch_Sequence">
            <a id="btnUp_Process" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-up" plain="true" onclick="SetSequence(1)"> Process Up</a>
            <a id="btnDown_Process" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-down" plain="true" onclick="SetSequence(2)"> Process Down</a>
        </div>
    </div>
    <fieldset style="margin-bottom:3px">
        <legend style="font-weight:bold"> Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:98%">
            <tr>
                <td style="width:600px; text-align:right"></td>
                <td style="width:50px">
                    <a id="btnSaveFNBatchSequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                </td>
                <td style="width:50px">
                    <a id="btnClose_Batch_Sequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>

<style type="text/css">
     
     /*.form-control {
        height: 22px;
        padding: 0px 4px;
        font-size: 12px;
    }*/
     .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 10px;
        margin-top: 0px;
        margin-bottom: 5px;
    }
     .col-md-12 .top{
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-top: 10px;
    }
       .col-md-12 .bottom{
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 10px;
    }
     
     .col-md-1 {
        width: 8.3%;
        padding-right: 3px;
        padding-left: 0px;
    }
     .col-md-3 {
        width: 24%;
        padding-right: 3px;
        padding-left: 0px;
    }

     .col-md-9 {
        width: 72%;
        padding-right: 2px;
        padding-left: 2px;
    }

    .btn-sm {
        padding: 2px 7px;
    }

     .input-group-addon {
        padding: 3px 6px;
    }
</style>

<script type="text/javascript">
    var _sBaseAddress="";
    var _oFNBatchs=[];
    var BackLink = "";
    var _oFNBatch = [];
    var _nMenuid = 0;
    var FabricSCReport = [];
    var BatchObjForPrint = [];
    var _nYardtoMeter=0;
    $(document).ready(function ()
    {
        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFNProduction =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oFNBatchs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNBatchs));
        _oFNBatch =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        FabricSCReport = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricSCReport));
        var oWUs =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WUs));
        var oFNTreatments =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNTreatments));
        
        oFNMachineProcessList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNMachineProcessList));
        oShades = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Shades));
        oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.HRMShifts));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _nFNTreatment = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Treatment));

        $("#cboShift").icsLoadCombo({
            List: oHRMShifts,
            OptionValue: "ShiftID",
            DisplayText: "Name",
            InitialValue:"Default"
        });
        //$("#cboMachine").icsLoadCombo({
        //    List: oFNMachineProcessList,
        //    OptionValue: "FNMachineID",
        //    DisplayText: "NameCode",
        //    InitialValue:"Default"
        //});
        $("#cboFNTreatment").icsLoadCombo({
            List: oFNTreatments,
            OptionValue: "id",
            DisplayText: "Value",
            InitialValue:"Default"
        });
      
        $("#cboFNTreatment").val(_nFNTreatment);
        $("#divPanel").data("FNProduction",_oFNProduction);
        $("#divPanel").data("FNExO",{});
        $("#divPanel").data("FNBatch",{});
       
        $("#txtFNProcess_Entry").focus();
        RefreshControl(_oFNProduction);
        $("#btnRunOut").hide();
        if(_oFNProduction.FNProductionID>0)
        {
            $("#btnRunOut").show();
        }

        $('.number').icsCurrencyBox();
        $('#dtIssue').datebox('setValue',_oFNBatch.IssueDateStr);
        $('#dtDelivery').datebox('setValue',_oFNBatch.IssueDateStr);
        $('#txtFNExONo').data('FNExOID',_oFNBatch.FNExOID);
        $('#txtGLM').data('GLM',_oFNBatch.GLM);
        $("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(_oFNBatch.ExeQty,2)));
        $('#txtQtyMeter').val(formatPrice(GetMeter(_oFNBatch.Qty,2)));

        debugger;
        if(sessionStorage.getItem("Operation") == "View")
        {
            $('#btnUpdateProcess, #btnRemoveProcess, #btnSaveFNProduction').hide();
            $(".menuMainCollectionTable").find('input, button, select, a').attr('disabled','disabled');
        }
        _nYardtoMeter=0.9144;
       
    });
    function RefreshControl(oModel)
    {
        if(oModel.FNProductionID>0)
        {
            $('#txtFNProcess_Entry').val(oModel.FNProcess);
            $('#txtFNMachine').val(oModel.FNMachineName);
            $('#cboFNTreatment').val(oModel.FNTreatment);
            $('#dtStart_FNP').datetimebox('setValue',oModel.StartDateTimeSt);
            $('#dtEnd_FNP').datetimebox('setValue',oModel.EndDateTimeSt);
            DynamicRefreshList(oModel.FNProductionBatchs,'tblFNPBatch');
        }
        else
        {
            $('#dtStart_FNP').datetimebox('setValue',icsdatetimeformat(new Date()));
            ////$('#dtEnd_FNP').datetimebox('setValue',icsdatetimeformat(new Date()));
        }
    }

    function MakeFooterColumn(sTable, FieldNames)
    {
        var FooterField=[];
        var obj=new Object();

        obj['BuyerName']="Gross Total: ";
        for(var j=0; j<FieldNames.length;j++)
        {
            obj[FieldNames[j]]=GetSum(FieldNames[j],sTable);
        }
        FooterField.push(obj);
        $('#'+sTable).datagrid('reloadFooter',FooterField);
    }
    function GetSum(sFieldName,sTable)
    {
        debugger;
        var data=$('#'+sTable).datagrid('getRows').select(sFieldName);
        var sum = 0;

        for (i = 0; i < data.length; i++)
        {
            sum+=parseFloat(data[i]);
        }
        return sum;
    }

    /* ====QC OK / NOT OK ===== */
    function formatDoneInfo(value,row,index)
    {
        debugger;
        if(value==2)
        {
            return "<label style='color:green'>"+row.QCStatusStr+"</label>";
        }
        else if(value==3)
        {
            //return "<label style='color:red'>"+row.QCStatusStr+"</label>";

            return "<input type=button id='btnDone'"+index+" Value='Reprocess' style='width:65px;height:28px;text-align:center;vertical-align: middle' onclick='QC_Reprocess("+index+")' />";
        }
        else if(value==1)
        {
            return "<input type=button id='btnDone'"+index+" Value='Update' style='width:55px;height:28px;text-align:center;vertical-align: middle' onclick='QC_FaillPass("+index+")' />";
        }
    }

    $('#btnCloseForDone').click(function(e) {
        $("#winDone").icsWindow('close');
    });

    function QC_FaillPass(nIndex)
    {
        debugger;
        if (nIndex >= 0)
        {
            $('#tblFNPBatch').datagrid('selectRow',nIndex);
            var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');

            if(parseInt(oFNBatchCard.QCStatus)!=1)
            {
                alert("Invalid QC Operation!");
                return;
            }

            $('#winDone').data("FNBatchCard_Index",nIndex);
            $('#winDone').data("FNBatchCard_QC",oFNBatchCard);

            $('#cboQCStatus').val(0);
            $('#txtQCNote').val("");
            $("#winDone").icsWindow('open','Update QC Status');
        }
        else
        {
            alert("Invalid Batch Card!");
            return;
        }
    }

    function Confirm() {
        debugger;
        var oFNBatchCard  = $('#winDone').data("FNBatchCard_QC");
        var nIndex = $('#winDone').data("FNBatchCard_Index");

        if (!confirm("Confirm to Update QC?")) return ;

        var bIsOK = ($('#cboQCStatus').val()==2 ? true : false);

        var oFNProductionBatchQuality = {
            FNPBQualityID:0,
            FNPBatchID:oFNBatchCard.FNPBatchID,
            IsOk : bIsOK,
            Remark: ( $('#txtQCNote').val()==undefined?"":$('#txtQCNote').val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FNProductionBatchQuality/Save",
            traditional: true,
            data:  JSON.stringify(oFNProductionBatchQuality),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var oFNPBQ = jQuery.parseJSON(data);
                if (oFNPBQ.ErrorMessage == "" || oFNPBQ.ErrorMessage == null)
                {
                    alert("Succefully Complete QC.");
                    $("#winDone").icsWindow('close');
                    var oRows=$('#tblFNPBatch').datagrid('getRows');
                    oRows[nIndex].QCStatus = $('#cboQCStatus').val();
                    oRows[nIndex].QCStatusStr = oFNPBQ.QCStatusStr;
                    $('#tblFNPBatch').datagrid('updateRow',{row: oRows[nIndex], index: nIndex});
                }
                else {
                    alert(oFNPBQ.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function QC_Reprocess(nIndex)
    {
        debugger;
        if (nIndex >= 0)
        {
            $('#tblFNPBatch').datagrid('selectRow',nIndex);
            var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');

            if(parseInt(oFNBatchCard.QCStatus)!=3)
            {
                alert("Invalid Reprocess !");
                return;
            }


            if (!confirm("Confirm to Update QC?")) return ;


            var oFNProductionBatchQuality = oFNBatchCard;

            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FNProductionBatchQuality/Reprocess",
                traditional: true,
                data:  JSON.stringify(oFNProductionBatchQuality),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oFNPBQ = jQuery.parseJSON(data);
                    if (oFNPBQ.ErrorMessage == "" || oFNPBQ.ErrorMessage == null)
                    {
                        alert("Succefully Reprocessed.");
                        $("#winDone").icsWindow('close');
                        var oRows=$('#tblFNPBatch').datagrid('getRows');
                        oRows[nIndex].QCStatus = 4;
                        oRows[nIndex].QCStatusStr = oFNPBQ.QCStatusStr;
                        $('#tblFNPBatch').datagrid('updateRow',{row: oRows[nIndex], index: nIndex});
                        $('#tblFNPBatch').datagrid('appendRow',oFNPBQ.FNProductionBatch);
                    }
                    else {
                        alert(oFNPBQ.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }
        else
        {
            alert("Invalid Batch Card!");
            return;
        }
    }

    /* ===== END ====== */

    function Print()
    {
        var oFNBatch = $("#divPanel").data("FNBatch"); // $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID == undefined || oFNBatch.FNBatchID <=0 )
        {
            alert("Please select a batch first.");
            return ;
        }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/Print_FNPProcess_Consumtion?nFNBatchID="+oFNBatch.FNBatchID+"&nBUID="+_nBUID+"&treatment="+_nFNTreatment+"&nts="+tsv);
    }
    function Print_Production()
    {
        var oFNBatch = $("#divPanel").data("FNBatch"); // $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNExOID == undefined || oFNBatch.FNExOID <=0 )
        {
            alert("Please select a dispo first.");
            return ;
        }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/Print_FNProduction_Consumtion?nID="+oFNBatch.FNExOID+"&nBUID="+_nBUID+"&treatment="+_nFNTreatment+"&nts="+tsv);
    }


    $('#btnPrintPB').click(function (e)
    {
        var oFNExO=$("#divPanel").data("FNExO");
        if(oFNExO.FabricID==undefined || oFNExO.FabricID<=0){ alert("Please pick a dispo first & try again!"); $('#txtFNExONo').focus(); return; }
        console.log(oFNExO);
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/FNBatch/Print_FNPProcess?nFabricID="+oFNExO.FabricID+"&nBUID="+_nBUID+"&nts="+tsv, "_blank");
    });
    function PrintXL()
    {
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/PrintXL?buid="+_nBUID+"&nTreatment="+_nFNTreatment+"&sDateCriteria=''&nts="+tsv);
    }
    function PrintBatch()
    {
        if($('#txtFNBatchNo').val() == "")
        {
            alert("Please Enter The lot No");
            return;
        }
        window.open(_sBaseAddress+"/FNBatch/PrintBatch?buid="+_nBUID+"&treatment="+_nFNTreatment+"&nFNBatchID="+BatchObjForPrint.FNBatchID);
    }

    function RefreshList(oFNBatchs)
    {
        debugger;
        $('#tblFNPBatch').empty();
        data = oFNBatchs;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblFNPBatch').datagrid('loadData', data);

        if(parseInt(sessionStorage.getItem("SelectedRowIndexBatch"))>0 && sessionStorage.getItem("OperationSave")=="OperationSave")
        {
            $('#tblFNPBatch').datagrid('selectRow',parseInt(sessionStorage.getItem("SelectedRowIndexBatch")));
        }
    }
    function ResetFNExe()
    {
        $('.reset-fnexe').val("");
        $('#txtGLM').val($('#txtGLM').data('GLM'));
        $('#txtFNExONo').data('FNExOID',0);
        $('#txtQtyYard').data('YetToOutQty',0);
        $('#txtQtyYard,#txtQtyMeter').val('');
        $('#txtFabricNo').val("");
        $('#txtSCNoFull').val("");
        $('#txtFNBatchNo').val("");
        DynamicRefreshList([],'tblFNPBatch');
    }

    function ValidateInput_FNP()
    {
        if(parseInt($("#divPanel").data("FNProduction").FNTPID)<=0)
        {
            alert("Process not found! Please pick a process & try again.");
            $('#txtFNProcess_Entry').focus();
            return false;
        }
        if(parseInt($("#divPanel").data("FNProduction").FNMachineID)<=0)
        {
            alert("Machine not found! Please pick a machine & try again.");
            $('#txtFNMachine').focus();
            return false;
        }

        var oFBCs = $('#tblFNPBatch').datagrid('getRows');
        if(oFBCs.length<=0)
        {
            alert("Production details not found!");
            $('#txtFNBatchNo').focus();
            return false;
        }
        return true;
    }
    function RefreshObject_FNP()
    {
        debugger;
        var oFNPBs = [];
        var oFNPBRows = $('#tblFNPBatch').datagrid('getRows');

        for(var i=0; i< oFNPBRows.length; i++)
        {
            // if(oFNPBRows[i].FNPBatchID == 0)
            oFNPBs.push(oFNPBRows[i]);
        }

        var oFNProduction= {
            FNProductionID : $("#divPanel").data("FNProduction").FNProductionID,
            FNTPID : $("#divPanel").data("FNProduction").FNTPID,
            FNMachineID : $("#divPanel").data("FNProduction").FNMachineID,
            IssueDate : new Date(),//$('#dtIssue').datebox('getValue'),
            StartDateTime : $('#dtStart_FNP').datetimebox('getValue'),
            EndDateTime : $('#dtEnd_FNP').datetimebox('getValue'),
            FNProductionBatchs: oFNPBs
        };
        return oFNProduction;
    }
    function SaveFNProduction()
    {
        debugger;
        if(!ValidateInput_FNP()) return;
        var oFNProduction = RefreshObject_FNP();

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNProduction/Save",
            traditional: true,
            data:  JSON.stringify(oFNProduction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oResult = jQuery.parseJSON(data);
                if (oResult.ErrorMessage=="") 
                {
                    alert("Data Saved sucessfully");
                    $("#btnRunOut").show();
                    $("#divPanel").data("FNProduction",oResult);
                    DynamicRefreshList(oResult.FNProductionBatchs,'tblFNPBatch');

                    //sessionStorage.setItem("SelectedRowIndexBatch", _oFNBatchs.length);
                    //sessionStorage.setItem("OperationSave", "OperationSave");
                    //$('#tblFNPBatch').datagrid('appendRow',oResult);
                    //location.reload();
                    //MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    //var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndexBatch"));
                    //$('#tblFNPBatch').datagrid('selectRow',nIndex);
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function RunOut()
    {
        debugger;
        if(!ValidateInput_FNP()) return;
        var oFNProduction = RefreshObject_FNP();
        if(oFNProduction.FNProductionID<=0)
        {
            alert("First Save Production.");
            $('#btnSaveFNProduction').focus();
            return false;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNProduction/RunOut",
            traditional: true,
            data:  JSON.stringify(oFNProduction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oResult = jQuery.parseJSON(data);
                if (oResult.ErrorMessage=="") 
                {
                    alert("Data Saved sucessfully");
                    
                    $("#divPanel").data("FNProduction",oResult);
                    DynamicRefreshList(oResult.FNProductionBatchs,'tblFNPBatch');

                    //sessionStorage.setItem("SelectedRowIndexBatch", _oFNBatchs.length);
                    //sessionStorage.setItem("OperationSave", "OperationSave");
                    //$('#tblFNPBatch').datagrid('appendRow',oResult);
                    //location.reload();
                    //MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    //var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndexBatch"));
                    //$('#tblFNPBatch').datagrid('selectRow',nIndex);
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }
    function RequestForQC(nQCStatus)
    {
        debugger;
        var oFNBatch = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        var nSelectedRowIndex = $('#tblFNPBatch').datagrid('getRowIndex', oFNBatch);
        oFNBatch.QCStatus=nQCStatus;
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNProduction/QCRequest",
            traditional: true,
            data:  JSON.stringify(oFNBatch),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oResult = jQuery.parseJSON(data);
                if (oResult.ErrorMessage=="") 
                {
                    $('#tblFNPBatch').datagrid('updateRow', { index: nSelectedRowIndex, row: oResult });
                    //$('#tblFNPBatch').datagrid('selectRow',nIndex);
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }


    $('#btnDelete').click(function(e){
        var oFNBatch = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        //if (parseFloat(oFNBatch.OutQty)>0 ) { alert("Unable to delete. Already Update Process."); return ; }
        if (!confirm("Confirm to delete?")) return;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatch,
            ControllerName: "FNBatch",
            ActionName: "Delete",
            TableId: "tblFNPBatch",
            IsWinClose: false
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: obj.BaseAddress + "/" + obj.ControllerName + "/" + obj.ActionName,
            traditional: true,
            data: JSON.stringify(obj.Object),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sMessage = jQuery.parseJSON(data);
                if (sMessage != null) {
                    if (sMessage.toLowerCase() == "deleted")
                    {
                        alert("Delete successfully.");
                        if ($.trim(obj.TableId).length)
                        {
                            var oSelectedObject = $("#" + obj.TableId).datagrid("getSelected");
                            var nRowIndexBank = $("#" + obj.TableId).datagrid("getRowIndex", oSelectedObject);
                            $("#" + obj.TableId).datagrid("deleteRow", nRowIndexBank);
                        }
                        MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    }
                    else {
                        alert(sMessage);
                    }
                }
                else { alert("Operation Unsuccessful."); }

                if (defaultSettings.IsWinClose) { IcsWindowClose(oActiveWindows); };
                if (callback != null) { return callback({ status: true, Message: sMessage.toLowerCase() }); }
            },
            error: function (xhr, status, error) {
                alert(error);
                if (callback != null) { return callback({ status: false, Message: "" }); }
            }
        });
    });
    function CloseFNP()
    {
        var isClsoe = true;
        var oFBCs = $('#tblFNPBatch').datagrid('getRows');
        for(var i=0; i < oFBCs.length; i++)
        {
            if(oFBCs[i].FNPBatchID<=0) { if (!confirm(oFBCs[i].BatchNo+" yet not saved. Do you Want to close?")) { isClsoe =false; break; } }
        }

        if(isClsoe)
            window.location.href = sessionStorage.getItem("BackLink");
    }

    //------------PICK FN BATCH --------------//
    $('#txtFNBatchNo').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            PickFNBatchCard( $.trim($("#txtFNBatchNo").val()) );
        }
    });

    function PickFNBatchCard(oTxtName)
    {
        if($("#divPanel").data("FNProduction") == null || $("#divPanel").data("FNProduction").FNTPID<=0)
        {
            alert("Please select a process & try again!");return;
        }        

        var oFNBCard =
        {
            FNBatchNo: (typeof(oTxtName) != 'undefined'?oTxtName:""),
            FNTreatmentProcessID : $("#divPanel").data("FNProduction").FNTPID
        };
        debugger;
        var nType = parseInt($('#cboType').val());
        if(nType == 0){
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNBCard,
                ControllerName: "FNBatch",
                ActionName: "GetsFNBatchCardByNo",
                IsWinClose: false
            };

            var tblColums = [];
            var oColumn = { field: "FNBatchNo", title: "Batch No", width: 100, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "Code", title: "Code", width: 80, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "FNProcess", title: "Process", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "PlannedDateSt", title: "Plan Date", width: 80, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "Qty_FNBatch", title: "Batch Qty(y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "Qty_Prod", title: "Prod Qty(y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "Qty_YetTo", title: "Yet To Qty(y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "Qty_ReProd", title: "Re. Pro Qty(y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "FNTreatmentSt", title: "Treatment", width: 90, align: "left" }; tblColums.push(oColumn);
      
            //DynamicPiker('FNBatcher',obj,tblColums,false,'Name','FNMachineID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

            var oPickerParam = {
                winid: 'winFNBatchs',
                winclass: 'clsFNBatch',
                winwidth: 900,
                winheight: 560,
                tableid: 'tblFNBatchs',
                tablecolumns: tblColums,
                multiplereturn: true,
                searchingbyfieldName: 'Name',
                windowTittle: 'Batch Card List',
                paramObj: obj,
                pkID: 'FNBatchID',
                callBack: SetFNBatchCard
            };
            $.icsDynamicPicker(oPickerParam);
        }
        else{
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNBCard,
                ControllerName: "FNProduction",
                ActionName: "GetsFNProductionByBatchNo",
                IsWinClose: false
            };

            var tblColums = [];
            var oColumn = { field: "BatchNo", title: "Batch No", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "FNProcess", title: "Process", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "Qty", title: "Qty(Y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "Qty_Prod", title: "Prod Qty(Y)", width: 90, align: "right"}; tblColums.push(oColumn);
            oColumn = { field: "Qty_YetTo", title: "Yet To Qty(Y)", width: 90, align: "right"}; tblColums.push(oColumn);
      
            //DynamicPiker('FNBatcher',obj,tblColums,false,'Name','FNMachineID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

            var oPickerParam = {
                winid: 'winReproductions',
                winclass: 'clsReproduction',
                winwidth: 800,
                winheight: 560,
                tableid: 'tblReproductions',
                tablecolumns: tblColums,
                multiplereturn: true,
                searchingbyfieldName: 'BatchNo',
                windowTittle: 'Reproduction List',
                paramObj: obj,
                pkID: 'FNBatchID',
                callBack: SetFNReProRequest
            };
            $.icsDynamicPicker(oPickerParam);
        }
        
        
    }
    function SetFNBatchCard(result) 
    {
        if(result.length>0)
        {
            var oFBCs = $('#tblFNPBatch').datagrid('getRows');
            for(var i=0; i < result.length; i++)
            {
                var isNotExist = true;
                result[i].BatchNo = result[i].FNBatchNo;
                result[i].StartQty = result[i].Qty_YetTo;
                result[i].IsProductionInString = "Fresh";
                result[i].IsProduction = false;
                for(var j=0; j < oFBCs.length; j++)
                {
                    if(result[i].FNBatchCardID == oFBCs[j].FNBatchCardID) { isNotExist =false; break; }
                }
                if(isNotExist) $('#tblFNPBatch').datagrid('appendRow',result[i]);
            }
            $('#txtFNBatchNo').val('');
            $('#txtFNBatchNo').focus();
        }
    }
    function SetFNReProRequest(result) 
    {
        debugger;
        if(result.length>0)
        {
            var oFBCs = $('#tblFNPBatch').datagrid('getRows');
            for(var i=0; i < result.length; i++)
            {
                var isNotExist = true;
                //result[i].BatchNo = result[i].FNBatchNo;
                result[i].StartQty = result[i].Qty_YetTo;
                result[i].IsProductionInString = "Reproduction";
                result[i].IsProduction = true;
                result[i].FNPBatchID=0;
                for(var j=0; j < oFBCs.length; j++)
                {
                    if(result[i].FNBatchCardID == oFBCs[j].FNBatchCardID) { isNotExist =false; break; }
                }
                if(isNotExist) $('#tblFNPBatch').datagrid('appendRow',result[i]);
            }
            $('#txtFNBatchNo').val('');
            $('#txtFNBatchNo').focus();
        }
    }
    //------------END FN BATCH --------------//

    //------------PICK FN BATCHER --------------//
    function SearchKeyStartBatcher(event)
    {
        debugger;
        var code = (event.keyCode ? event.keyCode : event.which);
        if (code == 13)
        {
            if ($.trim($("#txtStartBatcherName").val()).length == 0) {
                alert("Please Type Batch Name To Search !");
                $("#txtStartBatcherName").focus();
                return false;
            }
            PickFNBatcher(true, $.trim($("#txtStartBatcherName").val()));
        }
        else if(code==27 || code==08){
            ResetFNBatcher_Start();
        }
    };
    function SearchKeyEndBatcher(e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            if ($.trim($("#txtEndBatcherName").val()).length == 0) {
                alert("Please Type Batch Name To Search !");
                $("#txtEndBatcherName").focus();
                return false;
            }
            PickFNBatcher(false, $.trim($("#txtEndBatcherName").val()));
        }
        else if(code==27 || code==08){
            ResetFNBatcher_End();
        }
    };
    function ResetFNBatcher_Start()
    {
        $("#divFNPB").data('FNBatcher_Start',{});
    }
    function ResetFNBatcher_End()
    {
        $("#divFNPB").data('FNBatcher_End',{});
    }

    function btnSearchStartBatcher()
    {
        PickFNBatcher(true,"");
    }
    function btnSearchEndBatcher()
    {
        PickFNBatcher(false,"");
    }

    function PickFNBatcher(bIsStartBatcher,sBatcherName)
    {
        var oFNMachine = {
            Name: $.trim(sBatcherName),
            Params:"2,3"//Batcher=2,Trolly=3
        };

        var obj = {
            BaseAddress:_sBaseAddress,
            Object: oFNMachine,
            ControllerName: "FNMachine", //TechnicalSheet
            ActionName: "GetFNMachines",//ViewStyleSearch
            IsWinClose: false
        };
        console.log(oFNMachine);
        var tblColums = [];
        var oColumn = { field: "Code", title: "Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Name", title: "Name", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "FNMachineTypeSt", title: "Type", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "FreeTime", title: "Free Time", width: 90, align: "left" }; tblColums.push(oColumn);

        sessionStorage.setItem('bIsStartBatcher',bIsStartBatcher);
        //DynamicPiker('FNBatcher',obj,tblColums,false,'Name','FNMachineID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winFNBatchers',
            winclass: 'clsFNBatcher',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBatchers',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'Name',
            windowTittle: 'Bathcer List',
            paramObj: obj,
            pkID: 'FNMachineID',
            callBack: SetBatcher
        };

        $.icsDynamicPicker(oPickerParam);

    }
    function SetBatcher(result) {
        debugger;
        var bIsStartBatcher = sessionStorage.getItem('bIsStartBatcher');
        if(bIsStartBatcher=="true")
        {
            //$scope.StartBatcherName = result.Name+'['+result.Code+']';
            //$scope.FNProductionBatch.StartBatcherID = result.FNMachineID;

            $('#txtStartBatcherName').val(result.Name+'['+result.Code+']');
            $('#divFNPB').data('FNBatcher_Start',result);
            $('#txtEndBatcherName').focus();
        }
        else{
            //$scope.EndBatcherName = result.Name+'['+result.Code+']';
            //$scope.FNProductionBatch.EndBatcherID = result.FNMachineID;

            $('#txtEndBatcherName').val(result.Name+'['+result.Code+']');
            $('#divFNPB').data('FNBatcher_End',result);
            //$('#txtFNBStartTime').focus();
        }
    }
    //------------END FN BATCH --------------//
    
    /* ================ Gets FN Treatment Process ====================*/
    $('#txtFNProcess_Entry').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            GetsFNTreatmentProcess();
        }
        else if(code == 8)
        {
            //if($("#divPanel").data("FNProduction").FNProductionID > 0)
            //{
            //    alert("Unable to change process after production started!"); 
            //    $('#txtFNProcess_Entry').val($("#divPanel").data("FNProduction").FNProcess);
            //    return;
            //}
            
            document.getElementById("txtFNProcess_Entry").style.color = "red";
            document.getElementById("txtFNProcess_Entry").style.fontWeight = "bold";
            $('#txtFNProcess_Entry').val('');
            $("#divPanel").data("FNProduction").FNTPID = 0;
            
            $("#divPanel").data("FNProduction").FNMachineID = 0;
            $('#txtFNMachine').val('');
        }
    });
    $("#btnFNTreatmentProcess").click(function () {
        GetsFNTreatmentProcess()
    });
    function SetFNProcess(oResult)
    {
        if(oResult.FNTPID > 0)
        {
            debugger;
            $("#divPanel").data("FNTreatmentProcess",{FNTreatmentProcessID: oResult.FNTPID});
            $("#divPanel").data("FNProduction").FNTPID =  oResult.FNTPID;
            $("#divPanel").data("FNProduction").FNTreatment =  oResult.FNTreatment;
            
            $("#cboFNTreatment").val(oResult.FNTreatment);

            $("#txtFNMachine").focus();
            $('#txtFNProcess_Entry').val(oResult.FNProcess);
            document.getElementById("txtFNProcess_Entry").style.color = "green";
            document.getElementById("txtFNProcess_Entry").style.fontWeight = "bold";
        }
    }
    function GetsFNTreatmentProcess()
    {
        var ProcessName = $('#txtFNProcess_Entry').val();
       
        var oFNTreatmentProcess = {
            FNProcess: ProcessName,
            FNTreatmentInt : _nFNTreatment,
            ErrorMessage: $('#txtFNExONo').data('FNExOID')
        };
        console.log(oFNTreatmentProcess);
        var obj = 
            {
                BaseAddress: _sBaseAddress,
                Object: oFNTreatmentProcess,
                ControllerName: "FNTreatmentProcess",
                ActionName: "GetsFNTProductionProcess",
                IsWinClose: false
            };

        debugger;
        var oColumns = [];
        oColumn = { field: 'FNTreatmentSt', name: 'FNTreatment', width: '35%', enableSorting: false }; oColumns.push(oColumn);
        oColumn = { field: 'Code', name: 'Code', width: '20%' }; oColumns.push(oColumn);
        oColumn = { field: 'FNProcess', name: 'Process Name', width: '35%', enableSorting: false }; oColumns.push(oColumn);


        var oPickerParam = {
            winid: 'winFNBC',
            winclass: 'clsFNBC',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBCs',
            tablecolumns: oColumns,
            multiplereturn: false,
            searchingbyfieldName: 'Code',
            windowTittle: 'Process List',
            paramObj: obj,
            pkID: 'FNTPID',
            callBack: SetFNProcess
        };

        $.icsDynamicPicker(oPickerParam);
    }

    function SearchKeyMachine(e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            //if ($.trim($("#txtFNMachine").val()).length == 0) 
            //{
            //    alert("Please Type Machine Name To Search !");
            //    $("#txtFNMachine").focus();
            //    return false;
            //}
            PickFNMachine($.trim($("#txtFNMachine").val()));
        }
        else if(code==27 || code==08)
        {
            debugger;
            if($("#divPanel").data("FNProduction") != null && $("#divPanel").data("FNProduction").FNProductionID>0)
            {
                alert("Unable to change machine after production started!"); 
                $('#txtFNMachine').val($("#divPanel").data("FNProduction").FNMachineName);
                return;
            }
            $("#divPanel").data("FNProduction").FNMachineID = 0;
            $('#txtFNMachine').val('');

            document.getElementById("txtFNMachine").style.color = "red";
            document.getElementById("txtFNMachine").style.fontWeight = "bold";
        }
    };
    function PickFNMachine(sBatcherName)
    {
        if($("#divPanel").data("FNProduction") == null || $("#divPanel").data("FNProduction").FNTPID<=0)
        {
            alert("Please select a process & try again!");return;
        }

        var oFNMachine = {
            Name: $.trim(sBatcherName),
            FNTPID: $("#divPanel").data("FNProduction").FNTPID,
            FNTreatment: $("#divPanel").data("FNProduction").FNTreatment,
            Params:"1"//Batcher = 2,Trolly=3
        };

        var obj = {
            BaseAddress:_sBaseAddress,
            Object: oFNMachine,
            ControllerName: "FNMachine", //TechnicalSheet
            ActionName: "GetFNMachines",//ViewStyleSearch
            IsWinClose: false
        };

        var tblColums = [];
        var oColumn = { field: "Code", title: "Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Name", title: "Name", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "FNMachineTypeSt", title: "Type", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "FreeTime", title: "Free Time", width: 90, align: "left" }; tblColums.push(oColumn);

        //DynamicPiker('FNBatcher',obj,tblColums,false,'Name','FNMachineID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winFNMachines',
            winclass: 'clsFNMachine',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNMachines',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'Name',
            windowTittle: 'Machine List',
            paramObj: obj,
            pkID: 'FNMachineID',
            callBack: SetMachine
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function SetMachine(result) 
    {
        $("#divPanel").data("FNProduction").FNMachineID = result.FNMachineID;
        $('#txtFNMachine').val(result.Name+'['+result.Code+']');
        
        document.getElementById("txtFNMachine").style.color = "green";
        document.getElementById("txtFNMachine").style.fontWeight = "bold";
    }
    //------------ END FN PROCESS & MACHINE --------------//

    //------------PICK FN PRODUCT --------------//
    $('#txtProductName').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            //if ($.trim($("#txtFNBatchNo").val()).length == 0) {
            //    alert("Please Type Batch No To Search !");
            //    $("#txtFNBatchNo").focus();
            //    return false;
            //}

            PickProduct( $.trim($("#txtProductName").val()) );
        }
        else if(code==27 || code==08){
            //ResetProduct();
        }
    });
    function PickProduct(oTxtName)
    {
        var oStyleSearch = {
            BUID: _nBUID,
            ProductName: (typeof(oTxtName) != 'undefined'?oTxtName:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetProducts",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "ProductCode", title: "Product Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 280, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        //oColumn = { field: "FNBatchStatusStr", title: "Status", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winFNBatchProducts',
            winclass: 'clsFNBatchProduct',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBatchProducts',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetProduct
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function RemoveProductConsumption()
    {
      
        debugger;
        var oFNPConsumption = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPConsumption ==null || oFNPConsumption.ProductID <=0 ) { alert("Please select an item from list."); return ; }
        var nIndex=$('#tblFNPConsumption').datagrid('getRowIndex',oFNPConsumption);
        if (!confirm("Confirm to remove product: "+ oFNPConsumption.ProductName +"?")) return false;

        if(oFNPConsumption.FNPConsumptionID<=0)
        {
            $("#tblFNPConsumption").datagrid("deleteRow", nIndex);
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oFNPConsumption,
                         ControllerName: "FNProduction",
                         ActionName: "DeleteFNPConsumption",
                         TableId: "tblFNPConsumption",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
        }
        //RefreshSummary();
        editIndex = undefined;
    }
    function SetProduct(result)
    {
        debugger;
        if(result.ProductID>0)
        {
            $('#txtProductName').val('');
            result.FNPBatchID=parseInt($('#divFNPB').data('FNPBatchID'));
            result.FNPBatchID =$('#divFNPB').data('FNPBatchID');
            result.FNPConsumptionID =0;
            $('#tblFNPConsumption').datagrid('appendRow',result);
        }
    }
    //------------PICK FN PRODUCT ENDS--------------//

    //------------PICK LOT --------------//
    $('#txtLotNo').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            PickLot( $.trim($("#txtLotNo").val()) );
        }
        else if(code==27 || code==08){
            //ResetProduct();
        }
    });
    function PickLotAll()
    {
        var txtLotNo = $.trim($("#txtLotNo").val());
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPBatch ==null || oFNPBatch.ProductID <=0 ) { alert("Please select an item from list."); return ; }

        var oStyleSearch = {
            Params : "",
            BUID: _nBUID,
            ProductID: oFNPBatch.ProductID,
            LotNo: (typeof(txtLotNo) != 'undefined'?txtLotNo:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetLots",//ViewStyleSearch
            IsWinClose: false
        };
       
        var tblColums = []; var oColumn = { field: "LotNo", title: "Lot No", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 150, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Balance", title: "Balance", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "OperationUnitName", title: "Store", width: 150, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winLots',
            winclass: 'clsLot',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblLots',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetLot
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function PickLot(txtLotNo)
    {
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPBatch ==null || oFNPBatch.ProductID <=0 ) { alert("Please select an item from list."); return ; }

        var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatchCard.FNExOID  == undefined|| oFNBatchCard.FNExOID <=0 ) { alert("Please select a valid item from list."); return ; }
        //oFNBatchCard.FSCDID=$("#txtFNExONo").data('FNExOID');

        var oStyleSearch = {
            BUID : _nBUID,
            Params : oFNBatchCard.FNExOID,
            ProductID: oFNPBatch.ProductID,
            LotNo: (typeof(txtLotNo) != 'undefined'?txtLotNo:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetLots",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "LotNo", title: "Lot No", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 150, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Balance", title: "Balance", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "OperationUnitName", title: "Store", width: 150, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winLots',
            winclass: 'clsLot',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblLots',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetLot
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function SetLot(result)
    {
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        var nIndex = $('#tblFNPConsumption').datagrid('getRowIndex',oFNPBatch);
        if(result.LotID>0 && oFNPBatch.ProductID>0)
        {
            $('#txtLotNo').val('');
            //result.FNPBatchID=parseInt($('#divFNPB').data('FNPBatchID'));
            //result.FNPBatchID =$('#divFNPB').data('FNPBatchID');
            oFNPBatch.LotID = result.LotID;
            oFNPBatch.LotNo = result.LotNo;
            oFNPBatch.LotBalance = result.Balance;
            oFNPBatch.MUID = result.MUID;
            oFNPBatch.FNRDetailID = result.FNRDetailID;

            //FNRD.ProductID, FNRD.ProductCode, FNRD.ProductName, FNRD.LotID, FNRD.LotNo, FNRD.MeasurementUnitID, FNRD.MUName

            $('#tblFNPConsumption').datagrid('updateRow',{row: oFNPBatch, index: nIndex});
        }
    }
    //------------PICK FN PRODUCT ENDS--------------//

    function ValidateInput()
    {
        if(parseInt($('#txtFNExONo').data('FNExOID'))<=0)
        {
            alert("Dispo No order required.!");
            $('#txtFNExONo').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($('#txtQtyYard').val()))<=0)
        {
            alert("Issue qty required!");
            $('#txtQtyYard').focus();
            return false;
        }
        return true;
    }
    function RefreshObject()
    {
        debugger;
        var oFNBatch= {
            FNBatchID : 0,
            FNExOID : parseInt($("#txtFNExONo").data('FNExOID')),
            Qty: icsRemoveComma($('#txtQtyYard').val()),
            FNBatchStatus : _oFNBatch.FNBatchStatus,
            GLM : 0,// icsRemoveComma($('#txtGLM').val()),
            FNPPID :_oFNBatch.FNPPID ,
            IssueDate : $('#dtIssue').datebox('getValue'),
            ExpectedDeliveryDate:$('#dtDelivery').datebox('getValue')// $('#dtDelivery').datebox('getValue'),
        };
        debugger;
        return oFNBatch;
    }
    function Save()
    {
        debugger;
        if(!ValidateInput()) return;
        var oFNBatch=RefreshObject();
        var nBatchQty = $('#txtQtyMeter').val();
        var nBalance = parseInt($('#lblBalance').text());
        if(parseInt(nBalance)<=0)
        {
            alert("You Cannot Add More Quantity Than Balance ");
            return;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNBatch/Save",
            traditional: true,
            data:  JSON.stringify(oFNBatch),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oResult = jQuery.parseJSON(data);
                if (oResult.ErrorMessage=="") {
                    alert("Data Saved sucessfully");
                    sessionStorage.setItem("SelectedRowIndexBatch", _oFNBatchs.length);
                    sessionStorage.setItem("OperationSave", "OperationSave");
                    $('#tblFNPBatch').datagrid('appendRow',oResult);
                    //location.reload();
                    MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndexBatch"));
                    $('#tblFNPBatch').datagrid('selectRow',nIndex);
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }
    $('#btnDelete').click(function(e){
        var oFNBatch = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        //if (parseFloat(oFNBatch.OutQty)>0 ) { alert("Unable to delete. Already Update Process."); return ; }
        if (!confirm("Confirm to delete?")) return;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatch,
            ControllerName: "FNBatch",
            ActionName: "Delete",
            TableId: "tblFNPBatch",
            IsWinClose: false
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: obj.BaseAddress + "/" + obj.ControllerName + "/" + obj.ActionName,
            traditional: true,
            data: JSON.stringify(obj.Object),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sMessage = jQuery.parseJSON(data);
                if (sMessage != null) {
                    if (sMessage.toLowerCase() == "deleted")
                    {
                        alert("Delete successfully.");
                        if ($.trim(obj.TableId).length)
                        {
                            var oSelectedObject = $("#" + obj.TableId).datagrid("getSelected");
                            var nRowIndexBank = $("#" + obj.TableId).datagrid("getRowIndex", oSelectedObject);
                            $("#" + obj.TableId).datagrid("deleteRow", nRowIndexBank);
                        }
                        MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    }
                    else {
                        alert(sMessage);
                    }
                }
                else { alert("Operation Unsuccessful."); }

                if (defaultSettings.IsWinClose) { IcsWindowClose(oActiveWindows); };
                if (callback != null) { return callback({ status: true, Message: sMessage.toLowerCase() }); }
            },
            error: function (xhr, status, error) {
                alert(error);
                if (callback != null) { return callback({ status: false, Message: "" }); }
            }
        });
        //location.reload();
    });
    function Close()
    {
        debugger;
        //var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
        //sessionStorage.setItem("SelectedRowIndex",nIndex);
        //var FabricSalesContractID = parseInt(sessionStorage.getItem("FabricSalesContractID"));
        //$.ajax({
        //    type: "GET",
        //    dataType: "json",
        //    url : _sBaseAddress+"/FNBatch/GetFabricSaleReport",
        //    traditional: true,
        //    data: { nId: FabricSalesContractID},
        //    contentType: "application/json; charset=utf-8",
        //    success: function (data) {
        //        debugger;
        //        var oResult = jQuery.parseJSON(data);
        //        if(oResult.FabricSalesContractID>0)
        //        {
        //            sessionStorage.setItem("FabricSCReport",oResult);
        //        }


        //    },
        //    error: function (xhr, status, error) {
        //        alert(error);
        //    }

        //});
        //window.location.href = sessionStorage.getItem('BaseAddress')+ "/FNBatch/ViewFNBatchs_FSC?menuid="+_nMenuid;
        window.location.href = sessionStorage.getItem("BackLink");
    }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });

    function Reset_FNP(oFNBatchCard, oRecipe)
    {
        var oFSCD  =  $("#divPanel").data("FNExO");
        var oFNBatch = $("#divPanel").data("FNBatch");
        //console.log("RESET::",oFNBatchCard);
        $('#divFNPB').data('FNBatchID',oFNBatchCard.FNBatchID);
        $('#divFNPB').data('FNBatchCardID',oFNBatchCard.FNBatchCardID);
        $("#divFNPB").data('FNBatcher_Start',{});
        $("#divFNPB").data('FNBatcher_End',{});
        $('#txtStartBatcherName').val("");
        $('#txtEndBatcherName').val("");

        $('#txtBatchNo').val(oFNBatchCard.BatchNo);
        $('#txtProcess').val(oFNBatchCard.FNProcess);
        //$('#txtUser').val(oFNBatchCard.PreparedByName);
        $('#cboShift').val(0);
        ///$('#cboMachine').val(0);

        debugger;
        $('#txtProcessQty').val(0);
        if(oFNBatchCard.SequenceNo==1)
        {
            $('#txtProcessQty').val(oFNBatch.Qty);
            $('#txtStartWidth').val(0.00);
        }
        else
        {
            $('#txtProcessQty').val(oFNBatchCard.Qty_End_Prv);
            $('#txtStartWidth').val(oFNBatchCard.FabricWidth_End_Prv);
        }
        $('#txtProcessQty_End').val(0);

        $('#txtEndWidth').val(0.0);
        $('#txtPressure_Bar').val(0);
        $('#txtTemp_C').val(0.0);
        $('#txtMachineSpeed').val(0);
        $('#txtFlameIntensity').val(0);
        $('#txtFlamePosition').val(0);
        $('#cboProcessType').val(0);

        $('#txtPressure_Bar').val(oRecipe.Pressure_Bar);
        $('#txtTemp_C').val(oRecipe.Temp_C);
        $('#txtMachineSpeed').val(oRecipe.MachineSpeed);
        $('#txtFlameIntensity').val(oRecipe.FlameIntensity);
        $('#txtFlamePosition').val(oRecipe.FlamePosition);

        $('#txtPressure_Bar_Actual').val(oRecipe.Pressure_Bar_Actual);
        $('#txtTemp_C_Actual').val(oRecipe.Temp_C_Actual);
        $('#txtMachineSpeed_Actual').val(oRecipe.MachineSpeed_Actual);
        $('#txtFlameIntensity_Actual').val(oRecipe.FlameIntensity_Actual);
        $('#txtFlamePosition_Actual').val(oRecipe.FlamePosition_Actual);

        $('#txtShade').val(0);
        $('#txtRemark').val("");
        debugger;
        $('#txtTreatment').val(oFNBatchCard.FNTreatmentSt);
        //$('#dtIssue,#dtExpDelivery').datebox({'disabled':true})
        $('#dtIssue').datebox('setValue',icsdateformat(new Date()));
        $('#dtStart').datetimebox('setValue',icsdatetimeformat(new Date()));
        $('#dtEnd').datetimebox('setValue',icsdatetimeformat(new Date()));

        DynamicRefreshList([],'tblFNPConsumption');
        //$('#dtExpDelivery').datebox('setValue',response.obj.ExpectedDeliveryDateStr);
        //$('#txtCount').val(response.obj.CountName);
        //$('#txtConstruction').val(response.obj.Construction);
        //$('#txtProcessQty').val(formatPrice(oFNBatchCard.Qty));
    }
    function Set_FNP(oFNPBatch, oFNBC)
    {
        //console.log("SET::",oFNBatchCard);
        $('#divFNPB').data('FNBatchID',oFNPBatch.FNBatchID);
        $('#divFNPB').data('FNBatchCardID',oFNPBatch.FNBatchCardID);
        $('#divFNPB').data('FNPBatchID',oFNPBatch.FNPBatchID);
        $("#divFNPB").data('FNBatcher_Start', { FNMachineID: oFNPBatch.StartBatcherID });
        $("#divFNPB").data('FNBatcher_End', { FNMachineID: oFNPBatch.EndBatcherID });

        $('#txtBatchNo').val(oFNPBatch.BatchNo);
        $('#txtProcess').val(oFNPBatch.FNProcess);
        //$('#txtUser').val(oFNPBatch.PreparedByName);
        $('#cboShift').val(oFNPBatch.ShiftID);
        $('#cboShade').val(oFNPBatch.ShadeID);
        //$('#cboMachine').val(oFNPBatch.FNMachineID);

        $('#txtMachineName').val($("#divPanel").data("FNProduction").FNMachineName);

        debugger;

        $('#txtTreatment').val(oFNPBatch.FNTreatmentSt);
        $('#txtStartBatcherName').val(oFNPBatch.StartBatcherName);
        $('#txtEndBatcherName').val(oFNPBatch.EndBatcherName);

        $('#txtEndWidth').val(oFNPBatch.EndWidth);
        $('#txtPressure_Bar').val(oFNPBatch.Pressure_Bar);
        $('#txtTemp_C').val(oFNPBatch.Temp_C);
        $('#txtMachineSpeed').val(oFNPBatch.MachineSpeed);
        $('#txtFlameIntensity').val(oFNPBatch.FlameIntensity);
        $('#txtFlamePosition').val(oFNPBatch.FlamePosition);
        $('#cboProcessType').val(oFNPBatch.FNTreatmentSubProcessID);

        $('#txtPressure_Bar_Actual').val(oFNPBatch.Pressure_Bar_Actual);
        $('#txtTemp_C_Actual').val(oFNPBatch.Temp_C_Actual);
        $('#txtMachineSpeed_Actual').val(oFNPBatch.MachineSpeed_Actual);
        $('#txtFlameIntensity_Actual').val(oFNPBatch.FlameIntensity_Actual);
        $('#txtFlamePosition_Actual').val(oFNPBatch.FlamePosition_Actual);

        $('#txtShade').val(oFNPBatch.ShadeID);
        $('#txtRemark').val(oFNPBatch.Remark);
        
        $('#dtIssue').datebox('setValue',$("#divPanel").data("FNProduction").IssueDateSt);
       
     
     
        if(oFNPBatch.FNBatchID<=0)
        {
            $('#dtStart').datetimebox('setValue',oFNBC.StartDateTimeSt);
            $('#dtEnd').datetimebox('setValue',oFNBC.EndDateTimeSt);
        }
        else{
            $('#dtStart').datetimebox('setValue', oFNPBatch.StartDateTimeSt);
            $('#dtEnd').datetimebox('setValue',oFNPBatch.EndDateTimeSt);
        }
      
        //$('#dtExpDelivery').datebox('setValue',response.obj.ExpectedDeliveryDateStr);

        $('#txtStartWidth').val(oFNPBatch.StartWidth);
        $('#txtProcessQty').val(oFNPBatch.StartQty);
        //if(oFNBC.SequenceNo!=1)
        //{
        //    $('#txtProcessQty').val(oFNBC.Qty_End_Prv);
        //    $('#txtStartWidth').val(oFNBC.FabricWidth_End_Prv);
        //}
     
        $('#txtProcessQty_End').val(oFNPBatch.EndQty);

       
        DynamicRefreshList(oFNPBatch.FNProductionConsumptions,'tblFNPConsumption');
        //$('#txtConstruction').val(response.obj.Construction);
        //$('#txtProcessQty').val(formatPrice(oFNPBatch.Qty));
    }

    // ------ OPEN UPDATE PROCESS WIN ----- //
    $("#btnUpdateProcess").click(function () {
        debugger;
        editIndex = undefined;
        $('#cboStore').val($("#cboStore").data("WorkingUnitID"));
        $('#lblRemarks').html('');

        $('#divFNPB').data('FNBatchID',0);
        $('#divFNPB').data('FNBatchCardID',0);
        $('#divFNPB').data('FNPBatchID',0);
        $("#divFNPB").data('FNBatcher_Start',{});
        $("#divFNPB").data('FNBatcher_End',{});

        var oFNBatchCards = $('#tblFNPBatch').datagrid('getRows');
        var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNPBatchID <=0 ) { alert("Please select a saved item from list."); return ; }
        if ( $("#divPanel").data("FNProduction") ==null || $("#divPanel").data("FNProduction").FNProductionID <=0 ) { alert("Please save the production first."); return ; }

        $("#divPanel").data("FNProduction").FNProductionID
        // TRUN OFF FOR V2
        //if(oFNBatchCard.SequenceNo<=0) { alert("Please update plan date to set sequence number!"); return ; }


        var bIsTreatmentDone = false;
        var nPrvFNTP = oFNBatchCard.FNTreatment - 1;
        for(var i=0; i<oFNBatchCards.length;i++)
        {
            if(parseInt(oFNBatchCards[i].SequenceNo) >= parseInt(oFNBatchCard.SequenceNo)) break;

            if(parseInt(oFNBatchCards[i].SequenceNo) < parseInt(oFNBatchCard.SequenceNo) && parseInt(oFNBatchCards[i].QCStatus)==0)
            { alert("Please First Update Production For : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] . Then try again!'); return ; }

            if(parseInt(oFNBatchCards[i].FNTreatment) == parseInt(nPrvFNTP) && !bIsTreatmentDone && oFNBatchCards[i].QCStatus!=2)
            { alert("QC is not done for : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] !!'); return ; }
        }


        oFNBatchCard.FSCDID=$("#txtFNExONo").data('FNExOID');

        var nIndex=$('#tblFNPBatch').datagrid('getRowIndex',oFNBatchCard);
        oFNBatchCard_Prv = $('#tblFNPBatch').datagrid('getRows')[nIndex-1];
        if(oFNBatchCard_Prv!=undefined)
        {
            oFNBatchCard.Qty_End_Prv = oFNBatchCard_Prv.EndQty;
            oFNBatchCard.FabricWidth_End_Prv = oFNBatchCard_Prv.EndWidth;
        }else
        {
            oFNBatchCard.Qty_End_Prv = 0;
            oFNBatchCard.FabricWidth_End_Prv = "";
        }
        //oFNBatchCard.oFNBatch.FNTreatmentProcessID,
        //FNPBatchID : $('#divFNPB').data('FNPBatchID'),
        debugger;
        LoadSubProcess(oFNBatchCard);

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatchCard,
            ControllerName: "FNProduction",
            ActionName: "GetsFNProductionBatch",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null)
            {
                $("#cboShift").icsLoadCombo({
                    List: oHRMShifts,
                    OptionValue: "ShiftID",
                    DisplayText: "Name",
                    InitialValue:"Default"
                });
                $("#cboShade").icsLoadCombo({
                    List: oShades,
                    OptionValue: "id",
                    DisplayText: "Value",
                    InitialValue:"Default"
                });
                debugger;

                if(response.obj.ErrorMessage.length>0){ alert(response.obj.ErrorMessage); return; }

                //$("#cboMachine").icsLoadCombo({
                //    List: response.obj[0].FNMachines,
                //    OptionValue: "FNMachineID",
                //    DisplayText: "NameCode",
                //    InitialValue:"Default"
                //});
                if(response.obj.FNPBatchID>0)
                {
                    response.obj.FNProcess = $("#divPanel").data("FNProduction").FNProcess;
                    response.obj.FNTreatment = $("#divPanel").data("FNProduction").FNTreatment;
                    response.obj.FNTreatmentSt = $("#divPanel").data("FNProduction").FNTreatmentSt; 
                    // added by akram to show Trtment Name
                 
                    Set_FNP(response.obj, $("#divPanel").data("FNProduction"));
                  
                    ConvertIntoMeter_Qty();
                    ConvertIntoYard_Qty();
                    ConvertIntoMeter_QtyEND();
                    ConvertIntoYard_QtyEND();
                    $("#winFNPBatch").icsWindow('open', "Update Process");
                }
            }
        });


    });

    function LoadSubProcess(oFNBatchCard){
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNTreatmentProcess/GetSubProcessList",
            traditional: true,
            data:  JSON.stringify(oFNBatchCard),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oFNSubProcess = data;
                $("#cboProcessType").icsLoadCombo({ List: oFNSubProcess, OptionValue: "FNTreatmentSubProcessID", DisplayText: "SubProcessName", InitialValue:"Default" });
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function hasLotAssign()
    {
        var data = $('#tblFNPConsumption').datagrid('getRows');
        for(var i=0; i<data.length; i++)
        {
            if(data[i].LotID==0 || data[i].LotID== undefined){ alert("Please select a lot for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
            if(data[i].Qty<=0){ alert("Please enter a valid  Qty for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
            //if(data[i].IsQc  data[i].Qty > data[i].LotBalance){ alert("Insufficient Balance for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
        }
        return true;
    }
    function Refresh_FNP()
    {
        var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        var oFNP={
            FNPBatchID : $('#divFNPB').data('FNPBatchID'),
            FNProductionID : $("#divPanel").data("FNProduction").FNProductionID,
            FNBatchID : oFNBatchCard.FNBatchID,
            FNBatchCardID : $('#divFNPB').data('FNBatchCardID'),
            StartQty : $('#txtProcessQty').val(),
            EndQty : $('#txtProcessQty_End').val(),
            FNMachineID : $("#divPanel").data("FNProduction").FNMachineID,
            StartDateTime : $('#dtStart').datetimebox('getValue'),
            EndDateTime : $('#dtEnd').datetimebox('getValue'),
            StartBatcherID : $('#divFNPB').data('FNBatcher_Start').FNMachineID,
            EndBatcherID : $('#divFNPB').data('FNBatcher_End').FNMachineID,
            // StartWidth, EndWidth,Pressure_Bar, Temp_C,MachineSpeed,FlameIntensity,FlamePosition,Remark, ShadeID
            MachineSpeed : parseInt($('#txtMachineSpeed').val()),
            StartWidth : $('#txtStartWidth').val(),
            EndWidth :  $('#txtEndWidth').val(),
            FlameIntensity :  parseInt($('#txtFlameIntensity').val()),
            FlamePosition : parseInt($('#txtFlamePosition').val()),
            Pressure_Bar : $('#txtPressure_Bar').val(),
            Temp_C :  $('#txtTemp_C').val(),
            Remark :  $('#txtRemark').val(),
            ShiftID : $('#cboShift').val(),
            ShadeID : $('#cboShade').val(),
            IsProduction: oFNBatchCard.IsProduction,
            FNTreatmentSubProcessID : parseInt($('#cboProcessType').val()),
            FNProductionConsumptions: $('#tblFNPConsumption').datagrid('getRows')
        };
        return oFNP;
    }
    $('#btnSaveFNP').click(function(e){

        if($('#cboStore').val()<=0){
            alert("Please select a store.");
            $('#cboStore').focus();
            return false;
        }

        var oFNBatchCard = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }

        if($('#divFNPB').data('FNBatcher_Start').FNMachineID<=0){alert("Please select Start Batcher & try again."); return ;}
        if($('#divFNPB').data('FNBatcher_End').FNMachineID<=0){alert("Please select End Batcher & try again."); return ;}
        if($('#divFNPB').data('FNBatchCardID') <=0 || $('#divFNPB').data('FNBatchCardID') == undefined){alert("Production Batch Card Is Invalid!"); return ;}
        if($("#divPanel").data("FNProduction").FNMachineID <=0 || $("#divPanel").data("FNProduction").FNMachineID == undefined){alert("Please select a machine!"); return ;}
        if($("#divPanel").data("FNProduction").FNProductionID <=0 || $("#divPanel").data("FNProduction").FNProductionID == undefined){alert("Please select a production first!"); return ;}
        if(parseFloat($('#txtProcessQty').val()) <= 0) {alert("Start Qty should be greater than zero!"); return ;}
        if(parseFloat($('#txtProcessQty_End').val()) <= 0) {alert("End Qty should be greater than zero!"); return ;}
        endEditing_PD();
        var oFNPBatch = Refresh_FNP();

        if(oFNPBatch.StartQty==0){alert("Start Qty Should Be Greater Than Zero!! Please Update Previous End Qty."); return;}
        if(oFNPBatch.EndQty==0){alert("End Qty Should Be Greater Than Zero!!"); return;}
        if(!hasLotAssign())return;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNPBatch,
            ObjectId:"FNPBatchID",
            ControllerName: "FNProduction",
            ActionName: "SaveFNPBatch_Process",
            TableId:"",
            IsWinClose: false,
            Message: ""
        };

        $.icsSave(obj, function (response)
        {
            if (response.status && response.obj!=null) {
                if (response.obj.FNPBatchID > 0)
                {
                    if (response.obj.ErrorMessage!="")return;

                    alert("Process Is Updated successfully.");
                    $("#winFNPBatch").icsWindow('close');
                    //var nOutQty=0;
                    //for(var i=0;i<response.obj.FNBatchRawMaterials.length;i++){
                    //    nOutQty=nOutQty+parseFloat(response.obj.FNBatchRawMaterials[i].Qty);
                    //}
                    var oFNBatchCard=$('#tblFNPBatch').datagrid('getSelected');
                    var nIndex=$('#tblFNPBatch').datagrid('getRowIndex',oFNBatchCard);

                    debugger;

                    oFNBatchCard.FNMachineName = response.obj.FNMachineName;
                    oFNBatchCard.QCStatus = 1;
                    oFNBatchCard.FNPBatchID = response.obj.FNPBatchID;

                    oFNBatchCard.QCStatusStr = "In QC";//response.obj.QCStatusStr;
                    oFNBatchCard.StartQty= parseFloat(response.obj.StartQty);
                    oFNBatchCard.EndQty=parseFloat(response.obj.EndQty);
                    oFNBatchCard.StartWidth=parseFloat(response.obj.StartWidth);
                    oFNBatchCard.EndWidth=parseFloat(response.obj.EndWidth);
                    //$('#tblFNPBatch').datagrid("updateRow", { index: editIndex, row: oFNBatch });
                    $("#tblFNPBatch").datagrid("updateRow", { index: nIndex, row: oFNBatchCard });

                }
            }
            else{
                alert("Unable to Update Process.");
            }
        });
    });
    $("#btnCloseFNP").click(function () {
        $("#winFNPBatch").icsWindow('close');
    });

    $('#btnRemoveProcess').click(function(e){
        var oFNBatch = $('#tblFNPBatch').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        //if (parseFloat(oFNBatch.OutQty)>0 ) { alert("Unable to delete. Already Update Process."); return ; }
        if (!confirm("Confirm to delete?")) return;

        if(oFNBatch.FNPBatchID>0)
            DeleteFNP(oFNBatch);
        else
        {
            var nRowIndexBank = $("#tblFNPBatch").datagrid("getRowIndex", oFNBatch);
            $("#tblFNPBatch").datagrid("deleteRow", nRowIndexBank);
        }
        //location.reload();
    });

    function DeleteFNP(oFNBatch)
    {
        var obj =
       {
           BaseAddress: _sBaseAddress,
           Object: oFNBatch,
           ControllerName: "FNProduction",
           ActionName: "DeleteFNPBatch",
           TableId: "tblFNPBatch",
           IsWinClose: false
       };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: obj.BaseAddress + "/" + obj.ControllerName + "/" + obj.ActionName,
            traditional: true,
            data: JSON.stringify(obj.Object),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sMessage = jQuery.parseJSON(data);
                if (sMessage != null) {
                    if (sMessage.toLowerCase() == "deleted")
                    {
                        alert("Delete successfully.");
                        if ($.trim(obj.TableId).length)
                        {
                            var oSelectedObject = $("#" + obj.TableId).datagrid("getSelected");
                            var nRowIndexBank = $("#" + obj.TableId).datagrid("getRowIndex", oSelectedObject);
                            $("#" + obj.TableId).datagrid("deleteRow", nRowIndexBank);
                        }
                        MakeFooterColumn('tblFNPBatch', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    }
                    else {
                        alert(sMessage);
                    }
                }
                else { alert("Operation Unsuccessful."); }

                if (defaultSettings.IsWinClose) { IcsWindowClose(oActiveWindows); };
                if (callback != null) { return callback({ status: true, Message: sMessage.toLowerCase() }); }
            },
            error: function (xhr, status, error) {
                alert(error);
                if (callback != null) { return callback({ status: false, Message: "" }); }
            }
        });
    }
    //---------------------------Consumption Production--------------------------//
    var nIndex=undefined;
    function onClickCellPD(index)
    {
        debugger;
        nIndex=index;
        if (endEditing_PD('tblFNPConsumption'))
        {
            debugger;
            $('#tblFNPConsumption').datagrid('selectRow', parseInt(index));
            $('#tblFNPConsumption').datagrid('beginEdit', parseInt(index));
            var oMLC=$('#tblFNPConsumption').datagrid('getSelected');
            editIndex = index;
        }
        else
        {
            $('#tblFNPConsumption').datagrid('selectRow', editIndex);
        }
    }
    function endEditing_PD(tblId) {
        debugger;
        tblId="tblFNPConsumption";
        if (editIndex == undefined) {
            return true;
        }
        if ($('#'+tblId).datagrid('validateRow', editIndex))
        {
            $('#'+tblId).datagrid('endEdit', editIndex);
            $('#'+tblId).datagrid('selectRow', editIndex);

            var oFNBatch=$('#'+tblId).datagrid('getSelected');
            oFNBatch.PlannedDate= new Date(oFNBatch.PlannedDateSt);
            $('#'+tblId).datagrid("updateRow", { index: editIndex, row: oFNBatch });

            if(editIndex==nIndex)
                editIndex = undefined;
            else
            {
                editIndex = nIndex;
                $('#'+tblId).datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
            }
            return true;
        }
        else { return false; }
    }
    var editIndex=undefined;
    $('#btnCloseFNPConsumption').click(function(){
        $('#winFNPConsumption').icsWindow('close');
    })
    function FNPConsumption()
    {
        debugger;
        var oFNBatchC = $("#divPanel").data("FNProduction");
        if (oFNBatchC ==null || oFNBatchC.FNBatchID <=0 )
        {
            alert("Please select an item from list.");
            return ;
        }
        var oFNBatchCard = {
            FNBatchID : oFNBatchC.FNBatchID,
            FSCDID:$("#txtFNExONo").data('FNExOID'),
            FNTPID:oFNBatchC.FNTreatmentProcessID,
            FNPBatchID : $('#divFNPB').data('FNPBatchID'),
            //FNBatchCardID : FabricSCReport.FabricSalesContractID
        }
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatchCard,
            ControllerName: "FNBatch",
            ActionName: "GetsFNProductionConsumption",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            //console.log(response);
            if (response.status && response.obj != null) {
                if(response.obj.length>0)
                {
                    if(response.obj[0].ErrorMessage!=""){alert(response.obj[0].ErrorMessage); return;};
                    //$('#winFNPConsumption').icsWindow('open');
                    DynamicRefreshList(response.obj,'tblFNPConsumption');
                }
                else
                {
                    alert("No Production Consumption Found.");
                }
            }
        });
    }
    $('#btnSavePlanedDate').click(function(){
        debugger;
        endEditing_PD();
        var oLists=$('#tblFNPConsumption').datagrid('getRows');

        for(var i=0; i<oLists.length;i++)
        {
            if(oLists[i].PlannedDateSt!="")
            {
                oLists[i].PlannedDate = icsdateformat(new Date(oLists[i].PlannedDateSt));
            }
        }
        debugger;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLists,
            ControllerName: "FNExecutionOrder",
            ActionName: "SaveFNPConsumption",
            IsWinClose: false
        };
        $.icsSave(obj, function (response) {

            if (response.status && response.obj!=null) {
                debugger;
                if (response.ErrorMessage=="" || response.ErrorMessage==null) {
                    $('#winFNPConsumption').icsWindow('close');
                }
                else{
                    alert("Unable to Save");
                }
            }
        });
    });

    //------------------- PICKER FUNCTION ---------------------------//
    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID)
    {
        debugger;
        $.icsProgressBar(true);

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][pID] > 0) {
                    debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    $.icsProgressBar(false);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data Not Found.");
                $.icsProgressBar(false);
                return;
            }
        });
    }
    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
            else if (e.which == 27)//enter=13
            {
                $("#" + oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
            }
        });
    }
    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oResult;
        if (oPickerobj.multiplereturn)
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }
        else
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }
        if (oPickerobj.winid == 'winFNBatch')
        {
            SetBatch(oResult);
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }


    $("#txtProcessQty").keyup(function (e){
        debugger;
        ConvertIntoMeter_Qty();
    });
    $("#txtProcessQtyM").keyup(function (e){
        debugger;
        ConvertIntoYard_Qty();
    });
    function ConvertIntoYard_Qty()
    {
        var nQtyInTwo =$('#txtProcessQtyM').val();//icsRemoveComma($('#txtProcessQtyM').val());
        var nQtyInOne= parseFloat(nQtyInTwo/_nYardtoMeter ).toFixed(4);
        $('#txtProcessQty').val(nQtyInOne);
    }
    function ConvertIntoMeter_Qty()
    {
        var nQtyInOne =$('#txtProcessQty').val();  //icsRemoveComma($('#txtProcessQty').val());
        var nQtyInTwo= parseFloat(nQtyInOne*_nYardtoMeter).toFixed(10);
        $('#txtProcessQtyM').val(nQtyInTwo);
    }


    ////
    $("#txtProcessQty_End").keyup(function (e){
        debugger;
        ConvertIntoMeter_QtyEND();
    });
    $("#txtProcessQty_EndM").keyup(function (e){
        debugger;
        ConvertIntoYard_QtyEND();
    });
    function ConvertIntoYard_QtyEND()
    {
        var nQtyInTwo =$('#txtProcessQty_EndM').val();//icsRemoveComma($('#txtProcessQtyM').val());
        var nQtyInOne= parseFloat(nQtyInTwo/_nYardtoMeter ).toFixed(4);
        $('#txtProcessQty_End').val(nQtyInOne);
    }
    function ConvertIntoMeter_QtyEND()
    {
        var nQtyInOne =$('#txtProcessQty_End').val();  //icsRemoveComma($('#txtProcessQty').val());
        var nQtyInTwo= parseFloat(nQtyInOne*_nYardtoMeter).toFixed(10);
        $('#txtProcessQty_EndM').val(nQtyInTwo);
    }


</script>








