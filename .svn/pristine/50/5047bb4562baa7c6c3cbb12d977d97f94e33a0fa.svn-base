@{
    ViewBag.Title = "Delivery Challan";
}

<html>
<body>

    @model ESimSol.BusinessObjects.DUDeliveryChallan


    <div id="winPacking" class=" easyui-window winclass" title="Delivery Challan Pack List" style="width:600px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div>
            <table id="tblPacking" title="dynamic" class="easyui-datagrid" style="width:100%;height:500px"
                   data-options="singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false,toolbar: '#toolbarPDate', onClickRow:onClickRowPacking, resizable:true,checkOnSelect:false,selectOnCheck:false">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th data-options="field:'QTY',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="20%" formatter="formatPrice">Net Weight</th>
                        <th data-options="field:'BagWeight',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="20%" formatter="formatPrice">Bag Weight</th>
                        <th field="GrossWeight" width="20%" align="right" formatter="formatPrice">Gross Weight</th>
                        <th field="BagNo" width="10%" align="right">Bag No</th>
                        <th field="PackingWeight" width="20%" align="right" formatter="formatPrice">Packing Balance</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarPDate">
                <a id="btnRefreshPacking" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-reload" plain="true"> Refresh</a>
                <a id="btnDeletePacking" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-remove" plain="true"> Delete</a>
                <a id="btnReloadPacking" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-reload" plain="true"> Reload</a>

            </div>
            <div style="width:100%;">
                <fieldset>
                    <legend style="font-weight: bold">Action : </legend>
                    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                        <tr>
                            <td style="width:80%; text-align:left"></td>
                            <td style="width: 10%">
                                <a id="btnSavePacking" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            </td>
                            <td style="width: 10%">
                                <a id="btnClosePacking" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
    </div>


    <div class="menuMainCollectionTable">

        <fieldset>
         <legend style="font-weight:bold"> </legend>
            <table style="width:100%" cellpadding="1" cellspacing="0">

                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Deliver To:</label>
                    </td>
                    <td style="width: 60%; text-align: left">
                        <input id="txtDeliverTo" style="width: 70%;" class="reset-text" placeholder="Search Delivery To" />
                        <a id="btnPickDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                   
                    <td style="width: 8%; text-align: right">
                        <label>Challan No:</label>
                    </td>
                    <td style="width: 14%; text-align: left">
                        <input id="txtChallanNo" style="width: 75%" placeholder="Auto Generate" disabled="disabled" />
                    </td>
                    <td style="width: 8%; text-align: right">
                        <label>Date:</label>
                    </td>
                    <td style="width: 10%; text-align: left">
                        <input id="txtChallanDate" type="text" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend style="font-weight:bold"> Delivery Challan entry: </legend>
            <table cellpadding="2" cellspacing="2" style="width:100%">
                <tr>
                    
                    <td style="width: 15%; text-align: right">
                        <label>Store:</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <select style="width: 100%;" id="cboWorkingUnit" ></select>
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Order Type: </label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <select style="width: 100%;" id="cboOrderType" onchange="ChangeOrderType()"></select>
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Order No: </label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input id="txtOrderNo" style="width: 100%;" class="reset-text" />
                    </td>
                  
                </tr>
                <tr>

                    <td style="width: 15%; text-align: right">
                        <label>Driver Name:</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtReceivedByName" style="width: 100%;" class="reset-text" />
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Carrier:</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtCarrier" style="width: 100%;" class="reset-text" />
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Vehicle No:</label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input id="txtVehicleNo" style="width: 100%;" class="reset-text"/>
                    </td>

                </tr>

                <tr>
                    <td style="width: 15%; text-align: right">
                        <label>Gate Pass No:</label>
                    </td>
                    <td style="width: 15%; text-align: left">
                        <input id="txtGatePassNo" style="width: 100%;" class="reset-text" />
                    </td>
                    
                    <td style="width: 15%; text-align: right">
                        <label>Remarks:</label>
                    </td>
                    <td  style="width: 15%; text-align: left">
                        <input id="txtNote" style="width: 100%;" class="reset-text" placeholder="Remarks" />
                    </td>
                    <td style="width: 15%; text-align: right">
                        <label>Delivery Man:</label>
                    </td>
                    <td style="width: 25%; text-align: left">
                        <input id="txtDeliveryBY" style="width: 50%;" class="reset-text" />
                        <select style="width: 37%;height:22px;" id="cboPackCountBy"></select>
                        <a id="btnUpdate" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"></a>
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend style="font-weight:bold">Delivery Order info </legend>
            <table style="width:100%" cellpadding="0" cellspacing="1">

                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>DO No:</label>
                    </td>
                    <td style="width: 30%; text-align: left">
                        <input id="txtDONo" style="width: 80%;" class="reset-text" placeholder="Search DO No" />
                        <a id="btnPickDO" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>

                    <td style="width: 20%; text-align: right">
                        <label>Order No: </label>
                    </td>
                    <td style="width: 20%; text-align: left">
                        <input id="txtProduct" style="width: 80%" class="reset-text" />
                        <a id="btnPickDODetail" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                </tr>
                <tr>
                    <td style="width: 10%; text-align: left">
                        <label>Color:</label>
                    </td>
                    <td style="width: 30%; text-align: left">
                        <input id="txtPTU" style="width: 80%;" class="reset-text" placeholder="Search Color" />
                        <a id="btnPickPTU" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>

                    <td style="width:20%; text-align: right">
                        <label>Lot:</label>
                    </td>
                    <td style="width: 20%; text-align: left">
                        <input id="txtLot" style="width: 80%" class="reset-text" />
                        <a id="btnPickLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend>Delivery Challan Detail</legend>
            <div style="width:100%">
                <table id="tblDUDeliveryChallanDetail" class="easyui-datagrid" style="width:100%;height:200px;"
                       data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbar',onClickRow:onClickRow ">

                    <thead>
                        <tr>
                            <th field="OrderNo" width="10%" align="left">Order No</th>
                           
                            <th field="ProductName" width="20%" align="left">Yarn</th>
                            <th field="ColorName" width="10%" align="left">Color Name</th>
                            <th field="ShadeSt" width="5%" align="left">Shade</th>
                            <th field="LotNo" width="12%" align="left">Lot No</th>
                            <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">Qty</th>
                            <th field="MUnit" width="6%" align="left">Unit</th>
                            <th data-options="field:'BagQty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">Bag  </th>
                            <th data-options="field:'HanksCone',align:'right',editor:{type:'numberbox',options:{precision:0}}" width="8%">Hank/Cone</th>
                            <th data-options="field:'Note',width:100,height:60 ,align:'Left',editor:{type:'text'}" width="20%" align="Left">Remark</th>
                            <th data-options="field:'GYLotNo',width:100,height:60 ,align:'Left',editor:{type:'text'}" width="20%" align="Left">G.Y.LotNo</th>
                            
                            <th field="DONo" width="10%" align="center">DO No</th>
                            @*<th field="Qty" width="10%" align="right" formatter="formatPrice">Qty(Lbs)</th>*@

                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <a id="btnRefreshDCDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                    <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    <a id="btnPacking" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Packing</a>
                </div>
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                        <td style="width:65%;  text-align:right;font-weight:bold;">Total:</td>
                        <td style="width:10%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label> </td>
                        <td style="width:5%;  text-align:right;font-weight:bold;"> </td>

                    </tr>
                </table>
            </div>
</fieldset>

        <fieldset>
            <legend>Action</legend>
            <div class="align-right">
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                    <tr>
                        <td style=" float:left;  width:10%; ">
                            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                        </td>
                        <td style=" float:left;  width:10%; ">
                        </td>
                        <td style=" float:left;  width:60%; "></td>
                        <td style=" float:right;  width:20%; ">
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnDisburse" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Disburse</a>
                            <a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Cancel</a>
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>

                </table>

            </div>

        </fieldset>
    </div>
    
</body>
</html>

<style type="text/css">
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oDUDeliveryChallan=null;
    var _nContractorID=0;
    var _nProductID=0;

    var _oCPIssueTos=[];
    var _oCPDeliveryTos=[];
    var _oOrderTypes=[];
    var _nDOID=0;
    var _nDUDeliveryOrderDetailID=0;
    var _oDUDeliveryChallanDetail=null;
    var _nSelectedRowIndex=0;
    var _sBackLink="";
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oDUDeliveryChallan =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oCPIssueTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPIssueTos));
        _oCPDeliveryTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPDeliveryTos));
        var oOrderTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.OrderTypes));
        var oWorkingUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WorkingUnits));
        var oPackCountList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PackCountList));
        debugger;
        $("#cboOrderType").icsLoadCombo({
            List: oOrderTypes,
            OptionValue: "OrderType",
            DisplayText: "ShortName"
        });
        $("#cboPackCountBy").icsLoadCombo({
            List: oPackCountList,
            OptionValue: "id",
            DisplayText: "Value",
        });
        $("#cboWorkingUnit").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName"
        });
        if(oWorkingUnits!=null && oWorkingUnits.length==1){
            $("#cboWorkingUnit").val(oWorkingUnits[0].WorkingUnitID);
        }
        _oDUDeliveryChallanDetail={ProductID:0,DOID:0,DODetailID:0,WorkingUnitID:0,DyeingOrderDetailID:0};
        Initialization(oDUDeliveryChallan,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'));
        _sBackLink=sessionStorage.getItem("BackLink");
        // Control_disabled();
        sessionStorage.setItem("QtyFormat",true);//default set
        sessionStorage.setItem("ImageFormat",2);//default set
    });


    function Initialization(oDUDeliveryChallan, sOperation){
        ResetControll();
        $('#txtChallanDate').datebox('setValue',icsdateformat(new Date()));
        if(oDUDeliveryChallan.DUDeliveryChallanID>0)
        {
            RefreshControl(oDUDeliveryChallan);
        }


        if(sOperation=="View")
        {
            $('#toolbar,#btnDisburse,#btnSave,#btnCancel,.ics-pick').hide();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }

        else if(sOperation=="Approve")
        {
            $('#toolbar,#btnSave,#btnCancel,.ics-pick').hide();
            $('#btnDisburse').show();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('#btnDisburse,#btnCancel').hide();
            $('input,select').not('#txtDUDeliveryChallanNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
        ChangeOrderType();
    }

    function LoadIssueContactPersonnel(oCPs){
        $("#cboCPIssueTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }

    function LoadDeliveredContactPersonnel(oCPs){
        $("#cboCPDeliverTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }

    function ResetControll(){
        _oDUDeliveryChallan=null;

        $('.reset-text').val("");
        //$('#dtOrderDate,#dtSeekingDate').datebox('setValue', icsdateformat(new Date()));
        //LoadIssueContactPersonnel(_oCPIssueTos);
        //LoadDeliveredContactPersonnel(_oCPDeliveryTos);
        ////$('.number').val("0.00");
        //ResetDetail();
        DynamicRefreshList([], 'tblDUDeliveryChallanDetail');
        RefreshSummary();
    }

    function RefreshControl(oDUDeliveryChallan){
        debugger;

        _oDUDeliveryChallan=oDUDeliveryChallan;
        _nContractorID=oDUDeliveryChallan.ContractorID;//
        if(oDUDeliveryChallan.DUDeliveryChallanID<=0)
        {
            $('#txtChallanDate').datebox('setValue',icsdateformat(new Date()));
        }
        else{
            $('#txtChallanDate').datebox('setValue',oDUDeliveryChallan.ChallanDateSt);
        }
        $('#txtDeliverTo').val(oDUDeliveryChallan.ContractorName);
        $('#txtChallanNo').val(oDUDeliveryChallan.ChallanNo);

        $('#cboWorkingUnit').val(oDUDeliveryChallan.WorkingUnitID);
        $('#cboOrderType').val(oDUDeliveryChallan.OrderType);
        $('#cboPackCountBy').val(oDUDeliveryChallan.PackCountBy);
        $('#txtOrderNo').val(oDUDeliveryChallan.OrderNos);
        $('#txtNote').val(oDUDeliveryChallan.Note);
        $('#txtReceivedByName').val(oDUDeliveryChallan.ReceivedByName);
        $('#txtCarrier').val(oDUDeliveryChallan.VehicleName);
        $('#txtVehicleNo').val(oDUDeliveryChallan.VehicleNo);
        $('#txtGatePassNo').val(oDUDeliveryChallan.GatePassNo);
        $('#txtDeliveryBY').val(oDUDeliveryChallan.DeliveryBy);

        $('#txtDONo').val(oDUDeliveryChallan.DONos);
        if(oDUDeliveryChallan.DUDeliveryChallanDetails!==null && oDUDeliveryChallan.DUDeliveryChallanDetails.length>0)
        {
            DynamicRefreshList(oDUDeliveryChallan.DUDeliveryChallanDetails, 'tblDUDeliveryChallanDetail');
        }
        else{
            DynamicRefreshList([], 'tblDUDeliveryChallanDetail');
        }
        RefreshSummary();

    }

    function ChangeOrderType()
    {

        var ncboOrderType=parseInt($("#cboOrderType").val());
       // if(ncboOrderType===2)
       // {
       //     $(".lblLCNo").html("Invoice No");
       //     $(".lblOrderNo").html("Sample No");
       // }
       //else
       // {
       //    $(".lblLCNo").html("L/C No");
       //    $(".lblOrderNo").html("P/I No");
       // }

    }

    function Validation(){

        //if(_oDUDeliveryChallan.OrderID<=0)
        //{
        //    $('#txtExportPINo').focus();
        //    $('#txtExportPINo').addClass("errorFieldBorder");
        //    alert('Pick Order No .');
        //    return false;
        //}
        if( parseInt($('#cboWorkingUnit').val())<=0)
        {
            $('#cboWorkingUnit').focus();
            $('#cboWorkingUnit').addClass("errorFieldBorder");
            alert('Store  required.');
            return false;
        }
        else{
            $('#cboWorkingUnit').removeClass("errorFieldBorder");
        }

        if(_nContractorID<=0){
            $('#txtDeliverTo').focus();
            $('#txtDeliverTo').addClass("errorFieldBorder");
            alert('Challan issue to required.');
            return false;
        }
        else{
            $('#txtDeliverTo').removeClass("errorFieldBorder");
        }
        return true;
    }

    function RefreshObject()
    {
        var oDUDeliveryChallan={
            DUDeliveryChallanID: (_oDUDeliveryChallan!=null && _oDUDeliveryChallan.DUDeliveryChallanID>0)? _oDUDeliveryChallan.DUDeliveryChallanID:0,
            ContractorID: _nContractorID,
            ContactPersonnelID: 0,
            WorkingUnitID: $('#cboWorkingUnit').val(),
            OrderType: $('#cboOrderType').val(),
            PackCountBy: $('#cboPackCountBy').val(),
            Note:$.trim($('#txtNote').val()),
            ChallanDate:$('#txtChallanDate').datebox('getValue'),
            ReceivedByName:$.trim($('#txtReceivedByName').val()),
            VehicleName:$.trim($('#txtCarrier').val()),
            VehicleNo:$.trim($('#txtVehicleNo').val()),
            GatePassNo:$.trim($('#txtGatePassNo').val()),
            DeliveryBy: $.trim($('#txtDeliveryBY').val()),
            DUDeliveryChallanDetails:$('#tblDUDeliveryChallanDetail').datagrid('getRows')

        };
        return oDUDeliveryChallan;
    }


    $("#btnPickDeliverTo").click(function () {
        var sContractorName=$.trim($("#txtDeliverTo").val());

        GetContractors(sContractorName);
    });
    $("#txtDeliverTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtDeliverTo").val());
            _bIsIssueTo=false;
            GetContractors(sContractorName);
        }
        else if(nkeyCode==8){
            $("#txtDeliverTo").val("");
            _nContractorID=0;
            $("#txtDeliverTo").empty();

        }
    });
    $("#btnResetDeliverTo").click(function () {
        $("#txtDeliverTo").val("");
        _nContractorID=0;
        $("#cboCPDeliverTo").empty();
    });
    function GetContractors(sContractorName){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }


    //Pick DO
    $("#btnPickDO").click(function ()
    {
        var oDO = {
            ContractorID:_nContractorID,
            OrderType:$("#cboOrderType").val(),
            DONo:""
        };
        GetsDOs(oDO);
    });
    $("#txtDONo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sDONo=$.trim($("#txtDONo").val());
            var oDO = {
                ContractorID:_nContractorID,
                OrderType:$("#cboOrderType").val(),
                DONo:sDONo
            };
            GetsDOs(oDO);
        }
        else if(nkeyCode==8){
            $("#txtDONo").val("");
        }
    });
    function GetsDOs(oDO){
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDO,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetDOs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0)
            {
                if (response.objs[0].DUDeliveryOrderID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "DONoFull", title: "DO No", width: 160, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderTypeSt", title: "Type", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "Order No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "DeliveryDateSt", title: "Delivery Date", width: 100, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winDOPicker',
                        winclass:'clsDOPicker',
                        winwidth: 660,
                        winheight: 460,
                        tableid: 'tblDOPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'DONoFull',
                        windowTittle: 'DO List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data not found.");
            }
        });


    }
    //End DO Pick

    //Pick DODetail
    $("#btnPickDODetail").click(function () {

        if(_nDOID<=0)
        {
            alert("Please, first Pick DO");
            $("#txtDONo").focus()
            return;
        }
        GetProducts(_nDOID)
    });
    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            //if(_nDOID<=0)
            //{
            //    alert("Please, first Pick DO");
            //    $("#txtDONo").focus()
            //    return;
            //}

            GetProducts(_nDOID);
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
        }
    });
    function GetProducts(nDOID){

        var oDO = {
            DUDeliveryOrderID:nDOID,
            OrderNo:$("#txtProduct").val(),
            DONo:""
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDO,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetDODs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "DONo", title: "DO No", width: 120, align: "left" };tblColums.push(oColumn);

                    if(parseInt($("#cboOrderType").val())==3||parseInt($("#cboOrderType").val())==4)
                    {
                        oColumn = { field: "ProductName", title: "Product", width: 120, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "MUName", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "Qty", title: "DO Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "Qty_DC", title: "Delivery Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "YetToDC", title: "Yet To Delivery", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "Lotbalance", title: "Stock in Hand", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    }
                    else
                    {
                        oColumn = { field: "OrderNo", title: "Order No", width: 110, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "ProductName", title: "Product", width: 100, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "ColorName", title: "Color Name", width: 70, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "MUName", title: "Unit", width: 40, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "Qty", title: "DO Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "Qty_DC", title: "Delivery Qty", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "YetToDC", title: "Yet To Delivery", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                        oColumn = { field: "Lotbalance", title: "Stock in Hand", width: 90, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    }
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 850,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    //End DODetail

    //Pick PTU
    $("#btnPickPTU").click(function ()
    {

        debugger;
        //if(parseInt(_nDUDeliveryOrderDetailID)<=0)
        //{
        //    alert("Product required ");
        //    $('#txtProduct').focus();
        //    $('#txtProduct').addClass("errorFieldBorder");
        //}
        if(parseInt(_nDOID)<=0)
        {
            alert("DO  required ");
            $('#txtDONo').focus();
            $('#txtDONo').addClass("errorFieldBorder");
            return;
        }
        var oDCD = {
            DOID:_nDOID,
            OrderType:$("#cboOrderType").val(),
            ProductID:_nProductID,
            DODetailID :_nDUDeliveryOrderDetailID

        };
        GetsPTU(oDCD)
    });
    $("#txtPTU").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            //if(parseInt(_nDUDeliveryOrderDetailID)<=0)
            //{
            //    alert("Product required ");
            //    $('#txtProduct').focus();
            //    $('#txtProduct').addClass("errorFieldBorder");
            //}
            debugger;
            if(parseInt(_nDOID)<=0)
            {
                alert("DO  required ");
                $('#txtDONo').focus();
                $('#txtDONo').addClass("errorFieldBorder");
                return;
            }

            var oDCD = {
                DOID:_nDOID,
                OrderType:$("#cboOrderType").val(),
                ProductID:_nProductID,
                DODetailID :_nDUDeliveryOrderDetailID
            };
            GetsPTU(oDCD)
        }
        else if(nkeyCode==8){
            $("#txtPTU").val("");
            _oDUDeliveryChallanDetail={ProductID:0,DOID:0,DODetailID:0,WorkingUnitID:0,DyeingOrderDetailID:0};
            _nDUDeliveryOrderDetailID=0;
        }
    });
    function GetsPTU(oDCD){


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDCD,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetsOrders",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DyeingOrderDetailID > 0) {
                    debugger;
                    var tblColums = [];

                    var oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 200, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Yet To Delivery", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "OrderQty", title: "Order Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "StockInHand", title: "Stock In Hand", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "DeliveryQty", title: "Delivery Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 60, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winPTUPicker',
                        winclass:'clsPTUPicker',
                        winwidth: 950,
                        winheight: 460,
                        tableid: 'tblPTUPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    //End PTU

    //Pick Lot
    $("#btnPickLot").click(function ()
    {
        debugger;
        if( parseInt($('#cboWorkingUnit').val())<=0)
        {
            $('#cboWorkingUnit').focus();
            $('#cboWorkingUnit').addClass("errorFieldBorder");
            alert('Store  required.');
            return ;
        }
        else{
            $('#cboWorkingUnit').removeClass("errorFieldBorder");
        }

        if( parseInt(_nDUDeliveryOrderDetailID)<=0)
        {
            alert("Product required ");
            $('#txtProduct').focus();
            $('#txtProduct').addClass("errorFieldBorder");
            return ;
        }
        else{
            $('#txtProduct').removeClass("errorFieldBorder");
        }
        if( parseInt(_oDUDeliveryChallanDetail.DyeingOrderDetailID)<=0)
        {
            alert("Color required ");
            $('#txtPTU').val("");
            $('#txtPTU').focus();
            $('#txtPTU').addClass("errorFieldBorder");
            return ;
        }
        else{
            $('#txtPTU').removeClass("errorFieldBorder");
        }

        _oDUDeliveryChallanDetail.DODetailID=_nDUDeliveryOrderDetailID;
        _oDUDeliveryChallanDetail.WorkingUnitID= $('#cboWorkingUnit').val();
        GetsLot(_oDUDeliveryChallanDetail);

        //var oDUDeliveryChallanDetail={DODetailID:_nDUDeliveryOrderDetailID,
        //    WorkingUnitID:parseInt( $('#cboWorkingUnit').val()),
        //    PTUID:_oDUDeliveryChallanDetail.PTUID,
        //    DyeingOrderDetailID:_oDUDeliveryChallanDetail.DyeingOrderDetailID,
        //    LotID:0,
        //    ProductID:_nProductID
        //};

        //if(_oDUDeliveryChallanDetail!==null && _oDUDeliveryChallanDetail.PTUID>0)
        //{
        //    GetsLot(_oDUDeliveryChallanDetail)
        //}
        //else{
        //    GetsLot(oDUDeliveryChallanDetail)
        //}
    });
    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){

            if( parseInt($('#cboWorkingUnit').val())<=0)
            {
                $('#cboWorkingUnit').focus();
                $('#cboWorkingUnit').addClass("errorFieldBorder");
                alert('Store  required.');
                return ;
            }
            else{
                $('#cboWorkingUnit').removeClass("errorFieldBorder");
            }
            if( parseInt(_nDUDeliveryOrderDetailID)<=0)
            {
                alert("Product required ");
                $('#txtProduct').focus();
                $('#txtProduct').addClass("errorFieldBorder");
                return ;
            }
            else{
                $('#txtProduct').removeClass("errorFieldBorder");
            }

            if( parseInt(_oDUDeliveryChallanDetail.DyeingOrderDetailID)<=0)
            {
                alert("Color required ");
                $('#txtPTU').val("");
                $('#txtPTU').focus();
                $('#txtPTU').addClass("errorFieldBorder");
                return ;
            }
            else{
                $('#txtPTU').removeClass("errorFieldBorder");
            }
            //var oDUDeliveryChallanDetail={DODetailID:_nDUDeliveryOrderDetailID,
            //    WorkingUnitID:parseInt( $('#cboWorkingUnit').val()),
            //    PTUID:_oDUDeliveryChallanDetail.PTUID,
            //    LotID:0,
            //    ProductID:_nProductID,
            //    DyeingOrderDetailID:_oDUDeliveryChallanDetail.DyeingOrderDetailID,
            //};
            _oDUDeliveryChallanDetail.DODetailID=_nDUDeliveryOrderDetailID;
            _oDUDeliveryChallanDetail.WorkingUnitID= $('#cboWorkingUnit').val();
            GetsLot(_oDUDeliveryChallanDetail);
            //if(_oDUDeliveryChallanDetail!==null )
            //{
            //    GetsLot(_oDUDeliveryChallanDetail)
            //}
            //else{
            //    GetsLot(oDUDeliveryChallanDetail)
            //}
        }
        else if(nkeyCode==8)
        {
            $("#txtPTU").val("");
            _oDUDeliveryChallanDetail={ProductID:0,DOID:0,DODetailID:0,WorkingUnitID:0,DyeingOrderDetailID:0};
        }
    });
    function GetsLot(oDCD){


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDCD,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetLots",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "LotNo", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "MUName", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Balance", width: 100, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 200, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data not found.");
            }
        });


    }
    //End PTU

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winContractorPicker')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                $('#txtDeliverTo').val(oreturnObj.Name);
                _nContractorID= oreturnObj.ContractorID;
                //  GetContactPersonel(oreturnObj.ContractorID);
            }
            else{
                $('#txtDeliverTo').focus();
                $('#txtDeliverTo').addClass("errorFieldBorder");
                alert("Data not found");
                return;
            }
        }
        else if (oPickerobj.winid=='winDOPicker')
        {
            if(oreturnObj!=null && parseInt(oreturnObj.DUDeliveryOrderID)>0)
            {
                debugger;
                var txtDONo = document.getElementById("txtDONo");
                txtDONo.style.color = "blue";
                txtDONo.style.fontWeight = "bold";
                _nDOID=oreturnObj.DUDeliveryOrderID;
                _nProductID=0;
                $('#txtDONo').val(oreturnObj.DONoFull);
                $('#txtDeliverTo').val(oreturnObj.DeliveryToName);
                _nContractorID= oreturnObj.ContractorID;
                $('#txtOrderNo').val(oreturnObj.OrderNo);
                $('#cboOrderType').val(oreturnObj.OrderType);
                $('#txtProduct').focus();
                $('#txtProduct').addClass("errorFieldBorder");
            }
            else
            {
                $('#txtDONo').focus();
                $('#txtDONo').addClass("errorFieldBorder");
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnObj != null && oreturnObj.ProductID > 0)
            {
                debugger;
                _nProductID=oreturnObj.ProductID ;
                _nDUDeliveryOrderDetailID=oreturnObj.DUDeliveryOrderDetailID;

                //_oDUDeliveryChallanDetail=null;
                _oDUDeliveryChallanDetail.ProductID=_nProductID;
                _oDUDeliveryChallanDetail.DODetailID=_nDUDeliveryOrderDetailID;
                _nDOID=oreturnObj.DUDeliveryOrderID;
                //if( parseInt(_oDUDeliveryChallanDetail.DyeingOrderDetailID)<=0)
                //{

                //}
                _oDUDeliveryChallanDetail.DyeingOrderDetailID= oreturnObj.DyeingOrderDetailID;
                $('#txtDONo').val(oreturnObj.DONo);
                _oDUDeliveryChallanDetail.WorkingUnitID= $('#cboWorkingUnit').val();
                $('#txtDeliverTo').val(oreturnObj.DeliveryToName);
                _nContractorID= oreturnObj.ContractorID;
                if(parseInt($("#cboOrderType").val())==3||parseInt($("#cboOrderType").val())==4)
                {
                    $('#txtProduct').val(oreturnObj.ProductName);
                    //$('#cboOrderType').val(oreturnObj.OrderType);
                    $('#txtPTU').val("");
                    $('#txtPTU').focus();
                    $('#txtPTU').addClass("errorFieldBorder");
                }
                else
                {
                    $('#txtProduct').val(oreturnObj.OrderNo);
                    //$('#cboOrderType').val(oreturnObj.OrderType);
                    $('#txtLot').val("");
                    $('#txtLot').focus();
                    $('#txtLot').addClass("errorFieldBorder");
                }
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winPTUPicker')
        {
            if (oreturnObj.DyeingOrderDetailID > 0)
            {
                _oDUDeliveryChallanDetail=oreturnObj;
                $('#txtPTU').val(_oDUDeliveryChallanDetail.ProductName+", Color:"+_oDUDeliveryChallanDetail.ColorName);
                $('#txtLot').val("");
                $('#txtLot').focus();
                $('#txtLot').addClass("errorFieldBorder");
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winLotPicker')
        {
            if (oreturnobjs.length > 0)
            {
                debugger;
                if(_nDUDeliveryOrderDetailID<=0 || _nDUDeliveryOrderDetailID==null)
                {
                    $('#txtProduct').focus();
                    $('#txtProduct').addClass("errorFieldBorder");
                    alert("Product not Found.");
                    return;
                }
                for (i=0; i<oreturnobjs.length;i++)
                {
                    //_oDUDeliveryChallanDetail.LotID=oreturnobjs[i].LotID;
                    //_oDUDeliveryChallanDetail.LotNo=oreturnobjs[i].LotNo;
                    //_oDUDeliveryChallanDetail.Qty=oreturnobjs[i].Qty;
                    var oDCD={
                        DUDeliveryChallanDetailID:0,
                        DONo: $('#txtDONo').val(),
                        ProductName:oreturnobjs[i].ProductName,
                        //ProductName:_oDUDeliveryChallanDetail.ProductName,
                        ColorName:oreturnobjs[i].ColorName,
                        LotNo:oreturnobjs[i].LotNo,
                        Qty:oreturnobjs[i].Qty,
                        DyeingOrderDetailID:oreturnobjs[i].DyeingOrderDetailID,
                        Note:"",
                        ProductID:_oDUDeliveryChallanDetail.ProductID,
                        LotID:oreturnobjs[i].LotID,
                        HanksCone:oreturnobjs[i].HanksCone,
                        BagQty:oreturnobjs[i].BagQty,
                        OrderID:oreturnobjs[i].OrderID, //  _oDUDeliveryChallanDetail.OrderID,
                        DODetailID :_nDUDeliveryOrderDetailID,
                        OrderType: _oDUDeliveryChallanDetail.OrderType,
                        PTUID:_oDUDeliveryChallanDetail.PTUID
                    }
                    var bExists= IsExist(oDCD)
                    if(!bExists)
                    {
                        $('#tblDUDeliveryChallanDetail').datagrid('appendRow', oDCD);
                    }
                    else
                    {
                        alert("Already Exists");
                        return;
                    }

                }
                endEditing();
                RefreshSummary();
                _oDUDeliveryChallanDetail={ProductID:0,DOID:0,DODetailID:0,WorkingUnitID:0,DyeingOrderDetailID:0};
                $('#txtPTU').val("");
                //_nProductID=0;
                //$('#txtProduct').val("");
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
    }

    function IsExist(oDCD)
    {
        var oDUDCD = $('#tblDUDeliveryChallanDetail').datagrid('getRows');

        for (var i = 0; i < oDUDCD.length; i++) {
            if (parseInt(oDUDCD[i].LotID) == parseInt(oDCD.LotID) && parseInt(oDUDCD[i].DyeingOrderDetailID) == parseInt(oDCD.DyeingOrderDetailID) && parseInt(oDUDCD[i].DODetailID) == parseInt(oDCD.DODetailID))
            {
                return true;
            }
        }
        return false;
    }
    

    $("#btnSave").click(function (){
        debugger;
        $("#btnSave").hide();
        endEditing();
        if(!Validation()) return false;

        debugger;
        var oDUDeliveryChallan=RefreshObject();
        //if(!ValidateInput_Two()) return;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/DUDeliveryChallan/Save",
            traditional: true,
            data:  JSON.stringify(oDUDeliveryChallan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO= jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oDUDeliveryChallan=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oDUDeliveryChallans =sessionStorage.getItem("DUDeliveryChallans");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oDUDeliveryChallans!=null)
                    {
                        oDUDeliveryChallans = jQuery.parseJSON(oDUDeliveryChallans);
                    }
                    else
                    {
                        oDUDeliveryChallans=[];
                    }
                    if(nIndex!=-1)
                    {
                        oDUDeliveryChallans[nIndex]=_oDUDeliveryChallan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oDUDeliveryChallans.length);
                        oDUDeliveryChallans.push(_oDUDeliveryChallan);
                    }
                    sessionStorage.setItem("DUDeliveryChallans", JSON.stringify(oDUDeliveryChallans));
                    $("#btnSave").show();
                    window.location.href = _sBackLink;
                }
                else
                {
                    $("#btnSave").show();
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnRemoveDetail").click(function () {

        var oDUDeliveryChallanDetail = $("#tblDUDeliveryChallanDetail").datagrid("getSelected");
        if (oDUDeliveryChallanDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblDUDeliveryChallanDetail').datagrid('getRowIndex',oDUDeliveryChallanDetail);
        if (!confirm("Confirm to Delete?")) return false;

        if(oDUDeliveryChallanDetail.DUDeliveryChallanDetailID<=0)
        {
            $("#tblDUDeliveryChallanDetail").datagrid("deleteRow", nIndex);
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oDUDeliveryChallanDetail,
                         ControllerName: "DUDeliveryChallan",
                         ActionName: "DeleteDetail",
                         TableId: "tblDUDeliveryChallanDetail",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
        }
        RefreshSummary();
        editIndex = undefined;
    });

    function RefreshSummary()
    {
        var oDODetails = $('#tblDUDeliveryChallanDetail').datagrid('getRows');
        var nTotalQty = 0, nTotalAmount= 0;
        for(var i = 0; i<oDODetails.length;i++)
        {
            nTotalQty+=parseFloat(oDODetails[i].Qty);

        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0)+"LBS";

    }

    $("#btnRefreshDCDetail").click(function () {
        endEditing();
    });
    //////////// Detail ////////

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblDUDeliveryChallanDetail').datagrid('validateRow', editIndex)) {
            $('#tblDUDeliveryChallanDetail').datagrid('endEdit', editIndex);
            $('#tblDUDeliveryChallanDetail').datagrid('selectRow', editIndex);
            var oESCDetail = $('#tblDUDeliveryChallanDetail').datagrid('getSelected');

            debugger;
            $('#tblDUDeliveryChallanDetail').datagrid('updateRow', { index: editIndex, row: oESCDetail });

            RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblDUDeliveryChallanDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblDUDeliveryChallanDetail').datagrid('getSelected');

                editIndex = index;
            }
            else {
                $('#tblDUDeliveryChallanDetail').datagrid('selectRow', editIndex);
            }
        }
    }

    $('#btnDisburse').click(function () {

        debugger;
        var conf = confirm("Are you sure you want to Approve ?");
        if(conf==false)return;

        if (_oDUDeliveryChallan ==null || _oDUDeliveryChallan.DUDeliveryChallanID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oDUDeliveryChallan.ApproveBy!=0)
        {
            alert("Already Approve.");
            return;
        }


        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/DUDeliveryChallan/Approve",
            traditional: true,
            data:  JSON.stringify(_oDUDeliveryChallan),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oDUDeliveryChallan=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oDUDeliveryChallans =sessionStorage.getItem("DUDeliveryChallans");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oDUDeliveryChallans!=null)
                    {
                        oDUDeliveryChallans = jQuery.parseJSON(oDUDeliveryChallans);
                    }
                    else
                    {
                        oDUDeliveryChallans=[];
                    }
                    if(nIndex!=-1)
                    {
                        oDUDeliveryChallans[nIndex]=_oDUDeliveryChallan;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oDUDeliveryChallans.length);
                        oDUDeliveryChallans.push(_oDUDeliveryChallan);
                    }
                    sessionStorage.setItem("DUDeliveryChallans", JSON.stringify(oDUDeliveryChallans));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $('#btnPrint').click(function (e)
    {

        if (_oDUDeliveryChallan ==null || _oDUDeliveryChallan.DUDeliveryChallanID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/DUDeliveryChallan/PrintDUDeliveryChallan?nId="+_oDUDeliveryChallan.DUDeliveryChallanID+"&nts="+tsv+ "&bPrintFormat="+sessionStorage.getItem("QtyFormat") + "&nTitleType="+sessionStorage.getItem("ImageFormat"), "_blank");


    });

    $('#btnClosePacking').click(function(){
        $('#winPacking').icsWindow('close');
    })

    $("#btnPacking").click(function () {

        var oDUDeliveryChallanDetail = $("#tblDUDeliveryChallanDetail").datagrid("getSelected");
        if (oDUDeliveryChallanDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblDUDeliveryChallanDetail').datagrid('getRowIndex',oDUDeliveryChallanDetail);

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oDUDeliveryChallanDetail,
            ControllerName: "DUDeliveryChallan",
            ActionName: "GetDUDeliveryChallanPacks",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj != null) {
                if(response.obj.length>0){
                    DynamicRefreshList(response.obj,'tblPacking');
                    debugger;
                    for(var i=0;i<response.obj.length;i++){
                        if(response.obj[i].DUDeliveryChallanPackID > 0){
                            var n = $('#tblPacking').datagrid('getRowIndex',response.obj[i]);
                            $('#tblPacking').datagrid('checkRow', n);
                        }
                    }
                    debugger;
                    var smsg = "Yarn[" + oDUDeliveryChallanDetail.ProductName + "], Color[" + oDUDeliveryChallanDetail.ColorName + "], Lot No[" + oDUDeliveryChallanDetail.LotNo + "]";
                    var p = $('#tblPacking').datagrid('getPanel');  // get the panel object
                    p.panel('setTitle', smsg);
                    $('#winPacking').icsWindow('open');

                }
                else{alert("No Data found.");
                }
            }
        });

    });

    var editIndexPacking = undefined;
    function endEditingPacking() {
        if (editIndexPacking == undefined) { return true }
        if ($('#tblPacking').datagrid('validateRow', editIndexPacking)) {
            $('#tblPacking').datagrid('endEdit', editIndexPacking);
            $('#tblPacking').datagrid('selectRow', editIndexPacking);
            var oPackingDetail = $('#tblPacking').datagrid('getSelected');

            debugger;
            oPackingDetail.GrossWeight = parseFloat(oPackingDetail.QTY) + parseFloat(oPackingDetail.BagWeight);
            $('#tblPacking').datagrid('updateRow', { index: editIndexPacking, row: oPackingDetail });
            editIndexPacking = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRowPacking(index) {

        if (editIndexPacking != index) {
            if (endEditingPacking()) {
                $('#tblPacking').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblPacking').datagrid('getSelected');

                editIndexPacking = index;
            }
            else {
                $('#tblPacking').datagrid('selectRow', editIndexPacking);
            }
        }
    }

    $("#btnRefreshPacking").click(function () {
        endEditingPacking();
    });

    $("#btnSavePacking").click(function (){
        debugger;
        endEditingPacking();
        //var oPackingDetails = $('#tblPacking').datagrid('getRows');
        var oPackingDetails = $('#tblPacking').datagrid('getChecked');
        if(oPackingDetails.length <= 0){
            alert("No Packing Details Found!!");
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/DUDeliveryChallan/SavePackingDetails",
            traditional: true,
            data:  JSON.stringify(oPackingDetails),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDeliveryChallanPacks= jQuery.parseJSON(data);
                if(oDUDeliveryChallanPacks.length > 0){
                    if (oDUDeliveryChallanPacks[0].ErrorMessage=="" || oDUDeliveryChallanPacks[0].ErrorMessage==null)
                    {
                        alert("Data Save Succesfully!!");
                        DynamicRefreshList(oDUDeliveryChallanPacks,'tblPacking');
                        for(var i=0;i<oDUDeliveryChallanPacks.length;i++){
                            if(oDUDeliveryChallanPacks[i].DUDeliveryChallanPackID > 0){
                                var n = $('#tblPacking').datagrid('getRowIndex',oDUDeliveryChallanPacks[i]);
                                $('#tblPacking').datagrid('checkRow', n);
                            }
                        }

                        var nTotalQty = 0, nTotalBagQty = 0;
                        for(var i=0;i<oDUDeliveryChallanPacks.length;i++){
                            nTotalQty += oDUDeliveryChallanPacks[i].QTY;
                            nTotalBagQty +=oDUDeliveryChallanPacks[i].BagWeight;
                        }
                        var oDUDeliveryChallanDetail = $("#tblDUDeliveryChallanDetail").datagrid("getSelected");
                        var nIndex=$('#tblDUDeliveryChallanDetail').datagrid('getRowIndex',oDUDeliveryChallanDetail);
                        oDUDeliveryChallanDetail.Qty = nTotalQty;
                        oDUDeliveryChallanDetail.BagQty = nTotalBagQty;
                        $('#tblDUDeliveryChallanDetail').datagrid('updateRow', { index: nIndex, row: oDUDeliveryChallanDetail });
                    }
                    else
                    {
                        alert(oDUDeliveryChallanPacks[0].ErrorMessage);
                    }
                }else{
                    alert("no data Found!!");
                }

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    $("#btnDeletePacking").click(function () {
        endEditingPacking();
        var oDUDeliveryChallanPack = $("#tblPacking").datagrid("getSelected");
        if (oDUDeliveryChallanPack == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblPacking').datagrid('getRowIndex',oDUDeliveryChallanPack);
        if (!confirm("Confirm to Delete?")) return false;

        if(oDUDeliveryChallanPack.DUDeliveryChallanPackID<=0)
        {
            $("#tblPacking").datagrid("deleteRow", nIndex);
        }
        else
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/DUDeliveryChallan/DeletePackingDetail",
                traditional: true,
                data:  JSON.stringify(oDUDeliveryChallanPack),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    debugger;
                    var sMsg = jQuery.parseJSON(data);
                    if (sMsg=="Data delete successfully")
                    {
                        $("#tblPacking").datagrid("deleteRow", nIndex);
                        alert("Delete Succesfully!!");
                    }
                    else
                    {
                        alert(sMsg);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });

        }
    });

    $("#btnReloadPacking").click(function () {
        endEditingPacking();
        var oPackingDetails = $('#tblPacking').datagrid('getRows');
        var ids = "";
        debugger;
        for(var i=0;i<oPackingDetails.length;i++){
            ids += oPackingDetails[i].RouteSheetPackingID+",";
        }
        if(ids.length > 0) ids = ids.substring(0,ids.length-1);
        var oDUDeliveryChallanDetail = $("#tblDUDeliveryChallanDetail").datagrid("getSelected");
        oDUDeliveryChallanDetail.ErrorMessage = ids;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/DUDeliveryChallan/GetAllRSPacking",
            traditional: true,
            data:  JSON.stringify(oDUDeliveryChallanDetail),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDeliveryChallanPacks= jQuery.parseJSON(data);
                if(oDUDeliveryChallanPacks.length > 0){
                    if (oDUDeliveryChallanPacks[0].ErrorMessage=="" || oDUDeliveryChallanPacks[0].ErrorMessage==null)
                    {
                        for(var i=0;i<oDUDeliveryChallanPacks.length;i++){
                            $('#tblPacking').datagrid('appendRow',oDUDeliveryChallanPacks[i]);
                        }
                        //DynamicRefreshList(oDUDeliveryChallanPacks,'tblPacking');
                    }
                    else
                    {
                        alert(oDUDeliveryChallanPacks[0].ErrorMessage);
                    }
                }else{
                    alert("no data Found!!");
                }

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    $("#btnUpdate").click(function () {
        if(_oDUDeliveryChallan.DUDeliveryChallanID <= 0){
            alert("Delivery Challan not found!!");
            return;
        }
        var obj = {
            DUDeliveryChallanID: (_oDUDeliveryChallan!=null && _oDUDeliveryChallan.DUDeliveryChallanID>0)? _oDUDeliveryChallan.DUDeliveryChallanID:0,
            PackCountBy: $('#cboPackCountBy').val(),
            DeliveryBy: $.trim($('#txtDeliveryBY').val())
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUDeliveryChallan/UpdateFields",
            traditional: true,
            data: JSON.stringify(obj),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oDUDC = jQuery.parseJSON(data);
                if(oDUDC.ErrorMessage=="" || oDUDC.ErrorMessage == null){
                    alert("Updated Successfully!!");
                    $('#cboPackCountBy').val(oDUDC.PackCountBy);
                    $('#txtDeliveryBY').val(oDUDC.DeliveryBy);
                }else{
                    alert(oDUDC.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

</script>