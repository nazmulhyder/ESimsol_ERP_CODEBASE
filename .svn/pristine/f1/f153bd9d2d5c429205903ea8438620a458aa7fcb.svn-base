<html>
<head>
    @{
    ViewBag.Title = "FabricPlan Order";
    }
</head>
<body>

    @model IEnumerable<ESimSol.BusinessObjects.FabricPlan>

    <div class="menuMainCollectionTable">
   
        <fieldset>
            <legend>FabricPlan Detail For : <label id="lblFabricNo"></label></legend>

            <table style="width:100%; margin-top:10px">
                @*<tr>
                    <td style=" float:left; width:10%;">
                        <label>Product</label>
                    </td>
                    <td style="float:left; width:60%;">
                        <input id="txtProduct" style="float:left; width:75%;" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                   
                </tr>*@
                <tr>
                    <td style=" width:10%;">
                        <label>Type:</label>
                        <select style="width: 60%;" id="cboWarp">
                           
                        </select>
                   
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Yarn:</label>
                    </td>
                    <td style="width:20%; text-align:left">
                        <input id="txtProduct" style="float:left; width:70%;" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Color: </label>
                    </td>
                    <td style="width:30%; text-align:left">
                        <input id="txtRGB" onkeydown="ColorChange(1)" type="text">
                        <input id="txtRGBPriview" type="color" onchange="ColorChange(2)">
                        <button id="btnPickColor">Color Picker</button>
                    </td>
                    <td style="width:30%;">
                      
                    </td>
                </tr>
            </table>

        </fieldset>
        <div style="padding-left:2px; padding-right:2px;">
            @*<table id="tblFabricPlan" class="easyui-datagrid" style="height: 415px; width:100%;" fitcolumns="true" rownumbers="true" pagination="false" 
                   singleselect="true" autorowheight="false" toolbar="#toolbar" >*@
            <table id="tblFabricPlan" title="Fabric Pattern" class="easyui-datagrid" style="width:100%;height:415px;" fitcolumns="true"  singleselect="true" rownumbers="true" pagination="false" autorowheight="false"
                   data-options="toolbar: '#toolbar',onClickRow:onClickRow,onLoadSuccess: onLoadSuccess"></table>
               
            <div id="toolbar">
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true"><label id="lblEditUpdate">Edit</label></a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnMakeTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Create Group</a>
                <a id="btnRemoveTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Remove Group</a>
                <a id="btnCopyDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="CopyDetail()" plain="true">Copy</a>
                <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                <a id="btnAddColumn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Column</a>
                <a id="btnRepeatSection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-redo" plain="true">Repeat Section</a>
            </div>
        </div>
        <fieldset>
            <legend>Action</legend>
            <table border="0" cellpadding="0" cellspacing="0" style="float:right; width:100%;">
                <tr>
                    <td style=" float:left;  width:10%; ">
                    </td>
                    <td style="float:left;  width:20%; ">
                    </td>
                    <td style="width:70%;float:right; text-align:right">
                        <a id="btnSaveFPDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Save</a>
                        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                        @*<a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>*@
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
   
</body>
</html>
<div id="winFabricPlanRepeat" class="easyui-window winstyle" style=" height:auto;width:50%" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="overflow:hidden;display:block;">
    </div>
    <div title="Fabric Plan Repeat" style="display:block;overflow:hidden;height:300px">
        <table id="tblFabricPlanRepeat" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#toolbar4" style="height:310px">
            <thead>
                <tr>
                    @*<th data-options="field:'Selected',checkbox:true"></th>*@
                    <th field="SLNo" align="center" width="5%">SL</th>
                    <th field="WarpWeftTypeST" align="center" width="15%">Warp Weft Type</th>
                    <th field="StartColST" align="center" width="10%">Start Col</th>
                    <th field="EndColST" align="center" width="10%">End Col</th>
                    <th field="RepeatNo" align="center" width="15%">Repeat No</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar4">
            <select id="cboWarpWeftType" style="width:100px;"></select>
            <input type="text" id="txtRepeatNo" style="width:100px;"  placeholder="Repeat No"/>
            Start Col:<select id="cboStartCol" style="width:100px;"></select>
            End Col:<select id="cboEndCol" style="width:100px;"></select>
            <a id="btnAddFabricPlanRepeat" href="javascript:void(0)" class="easyui-linkbutton"  iconcls="icon-add" plain="true">Add</a>
            <a id="btnRemoveFabricPlanRepeat" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
        </div>
    </div>
    <div style="display:block;overflow:hidden;">
        <fieldset style="height:10%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:60%; text-align:left;">
                    </td>
                    <td style="width:40%; float:right">                       
                        <a id="btnFabricPlanRepeatClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

<style type="text/css">

     .col-md-12{
        width:100%;
        padding-right:3px;
        padding-left:3px;
        margin-bottom:3px;
    }
    .col-md-1{
        width:8%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-2{
        width:13%;
        padding-right:3px;
        padding-left:3px;
    }
     .col-md-3{
        width:16.66%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-4{
        width:25%;
        padding-right:3px;
        padding-left:3px;
    }
    .col-md-5{
        width:39%;
        padding-right:3px;
        padding-left:0px;
    }
    .col-md-6{
        width:46%;
        padding-right:0px;
        padding-left:3px;
    }
     .col-md-8{
        width:65%;
        padding-right:0px;
        padding-left:3px;
    }
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }

    .td-col-3 input {
        width: 92%;
    }

    .td-col-6 input {
        width: 70%;
    }

    .td-col-13 input {
        width: 86%;
    }

    .send-to .td-col-13 input {
        width: 85.7%;
    }


    .hp-ph .td-col-8 input {
        width: 66%;
    }

    .hp-ph .td-col-8 select {
        width: 96%;
    }

    .td-Note input {
        width: 97.5%;
    }

    .td-col-13 select {
        width: 15%;
    }

    .td-product input {
        width: 66%;
    }

    .td-KnitPly select {
        width: 95%;
    }

    .combo-number {
        width: 85%;
    }

    .td-ColorName input {
        width: 90%;
    }

    .td-PantonNo-Ref input {
        width: 34.5%;
    }

    .custom-styler {
        width: 85%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oFabricPlan=null;
    var _nProductID=0;
    var _oWarpWeftTypes=[];
    var _nFabricID=0;
    var _oCellRowSpans=[];
    var _oFabricSCReport=[];
    var _oFabricPlanOrder=[];
    var _oStartEndCols = [];
    $(document).ready(function ()
    {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oFabricPlans =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _nFabricID=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricID));
        _oFabricSCReport=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricSCReport));
        _oFabricPlanOrder=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricPlanOrder));
        _oWarpWeftTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WarpWeftTypes));;
        $('#txtRepeatNo').icsCurrencyBox(null, 0);
        debugger
        $("#cboWarp").icsLoadCombo({
            List: _oWarpWeftTypes,
            OptionValue: "id",
            DisplayText: "Value",
        });
        $("#cboWarpWeftType").icsLoadCombo({
            List: _oWarpWeftTypes,
            OptionValue: "id",
            DisplayText: "Value",
        });
        if(_oFabricPlanOrder.ColumnCount<=0)
        {
            _oFabricPlanOrder.ColumnCount=10;
        }
        MakeGrid();
        if(oFabricPlans.length>0)
        {
            _oCellRowSpans=oFabricPlans[0].CellRowSpans;
        }
        
        for(var i = 1; i <=_oFabricPlanOrder.ColumnCount; i++)
        {              
            //oVal= { field :"EndsCount"+i, title:"Count" + i};
            oVal= { field :i, title:"Count" + i};
            _oStartEndCols.push(oVal);
        }

        $("#cboStartCol").icsLoadCombo({
            List: _oStartEndCols,
            OptionValue: "field",
            DisplayText: "title",
        });

        $("#cboEndCol").icsLoadCombo({
            List: _oStartEndCols,
            OptionValue: "field",
            DisplayText: "title",
        });

        Refresh(oFabricPlans);debugger;
    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winFabricPlanOrder').icsWindow('close'); } });

    function Refresh(oData)
    {
        debugger;
        for(var i=0;i<oData.length;i++)
        {
            oData[i].ColorInHEX="#"+CP.RGB2HEX(oData[i].RGB.split(','));
        }
        var oFPDs=[];
        for(var i=0;i<oData.length;i++)
        {
            var oFabricPlanDetails=oData[i].FabricPlanDetails;
            oFPDs=[];
            //var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo:5, EndsCount:20, SLNo:0};
            //oFabricPlanDetails.push(oFPD);
            //var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo:7, EndsCount:25, SLNo:0};
            //oFabricPlanDetails.push(oFPD);
            //var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo:1, EndsCount:11, SLNo:0};
            //oFabricPlanDetails.push(oFPD);
            
            for(j=0; j <=_oFabricPlanOrder.ColumnCount; j++)
            {
                var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo:j, EndsCount:0, SLNo:j};
                oFPDs.push(oFPD);
            }

            for(k=0; k < oFabricPlanDetails.length; k++)
            {
                var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo: oFabricPlanDetails[k].ColNo, EndsCount:oFabricPlanDetails[k].EndsCount, SLNo:k};
                oFPDs.splice( oFabricPlanDetails[k].ColNo, 1, oFPD);
            }

            for(p=0; p < oFPDs.length; p++)
            {
                oData[i]["EndsCount"+p] = oFPDs[p].EndsCount;
                oData[i]["ColNo"+p] = oFPDs[p].ColNo;
            }
        }
        DynamicRefreshList(oData, 'tblFabricPlan');
    }
 

    function MakeGrid()
    {
        var tblColums=[];
        var oColumn=null;
        oColumn=  {field : 'FabricPlanID',title:'',width:10,checkbox:true}; tblColums.push(oColumn);
        oColumn= { field :"WarpWeftTypeSt", title:"Type", width:"5%"}; tblColums.push(oColumn);
        oColumn= { field :"ProductName", title:"ProductName", width:"10%"}; tblColums.push(oColumn);
        oColumn= { field :"RGB", title:"Color", width:"10%"}; tblColums.push(oColumn);
        oColumn= { field:'ColorInHEX', title:'ColorView', width:'15%',
            formatter:function(val, row, idx)
            {
                return '<div style="background-color:'+val+';">('+val+')</div>';
            } }; tblColums.push(oColumn);

           

            for(var i = 1; i <=_oFabricPlanOrder.ColumnCount; i++)
            {
               
                oColumn= { field :"EndsCount"+i, title:"Count" + i, width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }};
                tblColums.push(oColumn);
            }
            oColumn= { field :"EndsCount", title:"Total", width:"5%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
          
            $('#tblFabricPlan').datagrid({ columns:[tblColums]});
    }
   
   
    $('#btnSaveFPDetail').click(function (e) {
        
        debugger;
        var oFabricPlanDetails=[];
        var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');

        if (oFabricPlans.length==0) {
            alert("No Yarn/Color found!");
            return false;
        }

        for(var i=0;i<oFabricPlans.length;i++)
        {
            var oFabricPlan=  oFabricPlans[i]
            for(var j=1;j<=_oFabricPlanOrder.ColumnCount;j++)
            {
                var nEndsCount=  oFabricPlan["EndsCount"+j];

                if(nEndsCount>0)
                {
                    var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:nEndsCount, SLNo:0};
                    oFabricPlanDetails.push(oFPD);
                }
            }
        }

        debugger;
        if (oFabricPlanDetails.length==0) {
            alert("No EPI/PPI found!");
            return false;
        }


        if (!confirm("Confirm to Save ?")) return false;


        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricPlan/SaveAll",
            traditional: true,
            data: JSON.stringify(oFabricPlanDetails),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFabricPlanDetails = jQuery.parseJSON(data);

                if (oFabricPlanDetails[0].ErrorMessage == '' || oFabricPlanDetails[0].ErrorMessage == null) {
                    alert("Data Save Successfully");
                }
                else {
                    alert(oFabricPlanDetails[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(xhr + '~' + status + '~' + error);
            }
        });
    });


    /*============COLOR PICKER CODE START============================*/
    var picker = new CP(document.getElementById('btnPickColor')),
        output = document.getElementById('txtRGB');
    picker.on("change", function(color)
    {
        // convert to RGB
        $('#txtRGBPriview').val('#'+color);
        var rgb = CP.HEX2RGB(color);
        output.value = rgb.join(', ');
    });
    function ColorChange(nType)
    {
        debugger;
        if(nType==1 && $('#txtRGB').val().split(',').length==3)
        {
            var color=$('#txtRGB').val();
            var hex = CP.RGB2HEX(color.split(','));
            $('#txtRGBPriview').val('#'+hex);
        }
        else if(nType==2)
        {
            var color=$('#txtRGBPriview').val();
            var rgb = CP.HEX2RGB(color.replace('#',''));
            output.value = rgb.join(', ');
        }
    };
    /*============COLOR PICKER CODE ENDS============================*/

    function GetWarpWeftTypes(nId){
        if(nId==true)
            return "Warp";
        return 'Weft';
    }

    $('#tblFabricPlan').datagrid({selectOnCheck:false, checkOnSelect:false});

    function Initialization(oFabricPlan, sOperation){
        ResetControll();
        if(sOperation=="View")
        {
            $('#toolbar,#btnSave,.ics-pick').hide();
            $('input,select').not('#txtFabricPlanNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('input,select').not('#txtFabricPlanNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
    }

  

    function ResetDetail(bIsProductReset){
        _oFabricPlanDetail=null;
        if(bIsProductReset)
        {
            _nProductID=0;
            _nFabricPlanColorID=0;
            $('#txtProduct').val("");
            
        }
        $('#lblEditUpdate').text('Edit');
    }

    function ValidationDetail(){

        if(_nProductID<=0){
            $('#txtProduct').focus();
            $('#txtProduct').addClass("errorFieldBorder");
            alert('No product found.');
            return false;
        }
        else{
            $('#txtProduct').removeClass("errorFieldBorder");
        }

        if($('#txtRGB').val().split(',').length!=3)
        {
            $('#txtRGB').focus();
            $('#txtRGB').addClass("errorFieldBorder");
            alert('Valid RGB Color Is required.');
            return false;
        }
        else{
            $('#txtRGB').removeClass("errorFieldBorder");
        }

        //if($.trim($('#cboWarp').val())==0){
        //    alert('Planning Type Is required.');$('#cboWarp').focus();
        //    return false;
        //}
        return true;
    }

    function RefreshObjectDetail(bIsUpdate){
        var oFabricPlanDetail={
            FabricPlanID: (bIsUpdate? (_oFabricPlan.FabricPlanID>0 ? _oFabricPlan.FabricPlanID:0) : 0 ),
            FSCDID:( _oFabricSCReport.FabricSalesContractDetailID>0 ? _oFabricSCReport.FabricSalesContractDetailID:0) ,
            FabricID:_nFabricID,
            ProductID:_nProductID,
            RGB:$('#txtRGB').val(),
            ColorInHEX:"#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
            WarpWeftType:$('#cboWarp').val(),
            WarpWeftTypeSt:GetWarpWeftTypes($('#cboWarp').val())
        }
        return oFabricPlanDetail;
    }

    function SaveFabricPlanDetail(bIsUpdate){
        debugger;
        if (!ValidationDetail()) return false;
        var oFabricPlanDetail =null;
        if(bIsUpdate==true)
        {
            oFabricPlanDetail=_oFabricPlan;
            oFabricPlanDetail.ProductID=_nProductID,
            oFabricPlanDetail.RGB=$('#txtRGB').val(),
            oFabricPlanDetail.ColorInHEX="#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
            oFabricPlanDetail.WarpWeftType=$('#cboWarp').val(),
            oFabricPlanDetail.WarpWeftTypeSt=GetWarpWeftTypes($('#cboWarp').val())
        }
        else
        {
            oFabricPlanDetail = RefreshObjectDetail(bIsUpdate);
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanDetail,
            ObjectId: oFabricPlanDetail.FabricPlanID,
            ControllerName: "FabricPlan",
            ActionName: "SavePlanning",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oFabricPlanDetail.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
        };

        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) 
            {
                debugger;
                if (response.obj.FabricPlanID > 0 && response.obj.ErrorMessage=='') 
                {    
                    var oFabricPlan=response.obj;
                    oFabricPlan.ColorInHEX="#"+CP.RGB2HEX(oFabricPlan.RGB.split(','));

                    if(bIsUpdate)
                        $('#tblFabricPlan').datagrid('updateRow',{row:oFabricPlan, index: parseInt(sessionStorage.getItem("SelectedRowIndex_Detail"))});
                    else
                        $('#tblFabricPlan').datagrid('appendRow',oFabricPlan);
                    ResetDetail(false);
                }
                else alert(response.obj.ErrorMessage);
            }
        });
    }

    $("#btnAddDetail").click(function () {
        //if($('#cboWarp').val()==3)
        //{
        //    SaveFabricPlanDetail(false,1);
        //    SaveFabricPlanDetail(false,2);
        //}else 
        SaveFabricPlanDetail(false);
    });

    $('#btnEditDetail').click(function(e){
        debugger;
        if($('#lblEditUpdate').text()=='Edit')
        {
            var oFabricPlanDetail = $("#tblFabricPlan").datagrid("getSelected");
            if (oFabricPlanDetail == null || oFabricPlanDetail.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }
            ResetDetail(true);
            sessionStorage.setItem("SelectedRowIndex_Detail",$('#tblFabricPlan').datagrid('getRowIndex', oFabricPlanDetail));
            _nProductID=oFabricPlanDetail.ProductID;
            _oFabricPlan=oFabricPlanDetail;
            $('#txtProduct').val(oFabricPlanDetail.ProductName);
            $('#txtRGB').val(oFabricPlanDetail.RGB);ColorChange(1);
            $('#cboWarp').val(oFabricPlanDetail.WarpWeftType);
            $('#lblEditUpdate').text('Update');
        }
        else
        {
            //var oFabricPlanDetail = $("#tblFabricPlan").datagrid("getSelected");
            //if (oFabricPlanDetail == null || oFabricPlanDetail.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }
            ////oFabricPlanDetail.FabricID=_nFabricID;
            //oFabricPlanDetail.ProductID=_nProductID;
            //oFabricPlanDetail.RGB=$('#txtRGB').val();
            //oFabricPlanDetail.ColorInHEX="#"+CP.RGB2HEX($('#txtRGB').val().split(','));
            //oFabricPlanDetail.WarpWeftType=$('#cboWarp').val();
            //UpdateFabricPlanDetail(oFabricPlanDetail);
            SaveFabricPlanDetail(true);
        }

    });

    $("#btnRemoveDetail").click(function () {

        var oFabricPlanDetail = $("#tblFabricPlan").datagrid("getSelected");
        if (oFabricPlanDetail == null || oFabricPlanDetail.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }

        if (!confirm("Confirm to Delete?")) return false;
        var nIndex = $("#tblFabricPlan").datagrid("getRowIndex", oFabricPlanDetail);
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlanDetail,
            ControllerName: "FabricPlan",
            ActionName: "DeletePlanning",
            TableId: "tblFabricPlan",
            IsWinClose: false,
            Message:''
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message == 'deleted') 
            {
                var oFabricPlandetails=$('#tblFabricPlan').datagrid('getRows');
                DynamicRefreshList(oFabricPlandetails, 'tblFabricPlan');
            }
        });
    });

   





    $('#btnAddPlanDetail').click(function (e) {
        var oFabricPlanDetail = $("#tblFabricPlan").datagrid("getSelected");
        if (oFabricPlanDetail == null || oFabricPlanDetail.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }
        window.open(sessionStorage.getItem('BaseAddress')+"/FabricPlan/ViewFabricPlanDetail?nFabricPlanID="+oFabricPlanDetail.FabricPlanID, '_blank');
    });

    $("#btnResetProduct").click(function () {

        $("#txtProduct").val("");
        _nProductID=0;
    });
    $("#btnPickProduct").click(function () {
        var sProductName=$.trim($("#txtProduct").val());
        GetProducts(sProductName);
    });
    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct").val());
            //if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName);
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
        }
    });

    function SetProduct(oProduct)
    {
        if(oProduct !=null  && oProduct.ProductID>0){
            $('#txtProduct').val(oProduct.ProductNameCode);
            _nProductID= oProduct.ProductID;
           
        }
    }
    function GetProducts(sProductName){

        var oProduct = {
            BUID: sessionStorage.getItem("BUID"),
            ProductName: sProductName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "FabricPlan",
            ActionName: "GetProducts",
            IsWinClose: false
        };

        var tblColums = [];
        var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
        oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

        var oPickerParam = {
            winid: 'winProductPicker',
            winclass:'clsProductPicker',
            winwidth: 520,
            winheight: 460,
            tableid: 'tblProductPicker',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName:'ProductName',
            windowTittle: 'Product List',
            paramObj:obj,
            pkID:'ProductID',
            callBack:SetProduct
        };
        

        $.icsDynamicPicker(oPickerParam);
    }
    function GetProducts_OFF(sProductName){ //ProdyctPIckByFSCID

        if(_nFSCID==0)
        {
            alert('Please Pick A PO And Tray Again!');
        }
        var oFabricSalesContract = {
            FabricSalesContractID:_nFSCID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricSalesContract,
            ControllerName: "FabricSalesContract",
            ActionName: "GetsDetailByFSC",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeProductPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    ///Color Code

    function IntializeProductPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function ()
        {
            ProductSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ProductSelect(oPickerobj);
            }
        });
    }
    function ProductSelect(oPickerobj){
        var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winProductPicker')
        {
            if(oProduct !=null  && oProduct.ProductID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtProduct').val(oProduct.ProductNameCode);
                _nProductID= oProduct.ProductID;
               
            }
            else{
                alert("Please select product.");
            }
        }
        else if (oPickerobj.winid == 'winPOPicker')
        {debugger;
            if (oProduct != null && oProduct.ContractorID > 0)
            {
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                var oFabricSalesContract = oProduct;
                $('#txtPO').val(oFabricSalesContract.SCNo);
                $("#txtPO").addClass("fontColorOfPickItem");
                $('#txtIssueTo').val(oProduct.ContractorName);
                $('#txtDeliverTo').val(oProduct.BuyerName);
                _nDeliveryToID= oProduct.BuyerID;
                _nContractorID= oProduct.ContractorID;
                _nFSCID = oFabricSalesContract.FabricSalesContractID;
            }
            else {
                alert("Please select an item from.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winFabricPicker')
        {
            if (oProduct!= null && oProduct.FabricSalesContractDetailID> 0)
            {
                $('#txtFabricNo').val(oProduct.FabricNo);
                $('#txtFabricNo').addClass('fontColorOfPickItem');
                _nFSCDetailID = oProduct.FabricSalesContractDetailID;
                $('#txtConstruction').val(oProduct.Construction);
                $('#txtComposition').val(oProduct.ProductName);
                debugger;
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtFabricNo').focus();
            }
        }
       

    }

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
   
    $('#btnPrint').click(function (e)
    {
        debugger;

        var oLDpDetail = $('#tblFabricPlan').datagrid('getRows');
        if (_nFabricID ==null || _nFabricID<=0 ) { alert("Please select an item from list."); return ; }
       
        window.open(_sBaseAddress + '/FabricPlan/PrintFabricPlan?nFSCDID='+_oFabricSCReport.FabricSalesContractDetailID+"&buid="+1, "_blank");

    });

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblFabricPlan').datagrid('validateRow', editIndex)) {
            $('#tblFabricPlan').datagrid('endEdit', editIndex);
            $('#tblFabricPlan').datagrid('selectRow', editIndex);
            debugger;
            //InvoiceType: Standard = 1, Advance = 2
            //ReferenceType : Open = 1, PO = 2, Import = 3
            var oFabricPlan = $('#tblFabricPlan').datagrid('getSelected');
            //if (oFabricPlan.FabricPlanID>0) {
            //    UpdateFP(oFabricPlan, editIndex);
            //}
            //else
            //{
            //    $('#tblFabricPlan').datagrid('updateRow', { index: editIndex, row: oFabricPlan });
            //}
            $('#tblFabricPlan').datagrid('updateRow', { index: editIndex, row: oFabricPlan });

          //  RefreshSummery();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {
        if (editIndex != index) {
            if (endEditing()) {
                $('#tblFabricPlan').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oFabricPlan= $('#tblFabricPlan').datagrid('getSelected');
                //if(oPurchaseInvoiceDetail.PurchaseInvoiceDetailID<=0){
                //    $('#btnAddSpecification').hide();
                //}
                //else{
                //    $('#btnAddSpecification').show();
                //}
                editIndex = index;
            }
            else {
                $('#tblFabricPlan').datagrid('selectRow', editIndex);
            }
        }
    }

    function UpdateFP(oFabricPlan, SelectedRowIndex)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricPlan/SavePlanning",
            traditional: true,
            data: JSON.stringify(oFabricPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
            
                var oFabricPlan = jQuery.parseJSON(data);
            
                if (parseInt(oFabricPlan.FabricPlanID) > 0) {
                    $('#tblFabricPlan').datagrid('updateRow', { index: SelectedRowIndex, row: oFabricPlan });
                   // RefreshTotalSummery();
                }
                else {
                    alert(oFabricPlan.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    /////Twist
    function formatTwisted(value){

        if(value>0){
            return "Twisted";
        }
        else{
            return "";
        }
    }
    function onLoadSuccess(data)
    {
        debugger;
        var nIndex=0;
        var nSpan=0;
        for(var i=0;i<_oCellRowSpans.length;i++){
            var oMCell=[_oCellRowSpans[i].mergerCell];
            nIndex=oMCell[0][0];
            nSpan= oMCell[0][1];
            if(_oCellRowSpans[i].FieldName=="ComboNo"){
                $(this).datagrid('mergeCells',{index: nIndex, field: 'ComboNo', rowspan: nSpan});
                $(this).datagrid('mergeCells',{index: nIndex, field: 'RepeatNo', rowspan: nSpan});
 
            }
        }
    }
   


    $('#btnMakeTwisted').click(function(e){
        
        debugger;
        var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');

        if(oFabricPlans.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sFabricPlanIDs="";
        for(var i=0; i<oFabricPlans.length; i++){
            sFabricPlanIDs = sFabricPlanIDs + oFabricPlans[i].FabricPlanID +",";
        }
        sFabricPlanIDs=sFabricPlanIDs.substring(0,sFabricPlanIDs.length-1);

        var oFabricPlan={
            FSCDID: oFabricPlans[0].FSCDID,
            FabricID:oFabricPlans[0].FabricID,
            FabricPlanID: oFabricPlans[0].FabricPlanID,
            ComboNo: 0,
            ErrorMessage: sFabricPlanIDs
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlan,
            ObjectId: oFabricPlan.FabricPlanID,
            ControllerName: "FabricPlan",
            ActionName: "MakeCombo",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oDyeingOrderDetail.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID>0) {
                
                    _oCellRowSpans=response.obj.FabricPlans[0].CellRowSpans;
                 //   DynamicRefreshList(response.obj.FabricPlans, 'tblFabricPlan');
                    Refresh(response.obj.FabricPlans);debugger;

                }
                else if(response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID<=0){
                    alert(response.obj.FabricPlans[0].ErrorMessage);
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    $('#btnRemoveTwisted').click(function(e){

        var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');

        if(oFabricPlans.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sFabricPlanIDs="";
        for(var i=0; i<oFabricPlans.length; i++){
            sFabricPlanIDs = sFabricPlanIDs + oFabricPlans[i].FabricPlanID +",";
        }
        sFabricPlanIDs=sFabricPlanIDs.substring(0,sFabricPlanIDs.length-1);

        var oFabricPlan={
            FSCDID: oFabricPlans[0].FSCDID,
            FabricID:oFabricPlans[0].FabricID,
            FabricPlanID: oFabricPlans[0].FabricPlanID,
            ComboNo: 0,
            ErrorMessage: sFabricPlanIDs
        }


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricPlan,
            ObjectId: oFabricPlan.FabricPlanID,
            ControllerName: "FabricPlan",
            ActionName: "RemoveComboGroup",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oDyeingOrderDetail.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID>0) {
                    _oCellRowSpans=response.obj.FabricPlans[0].CellRowSpans;
                 //   DynamicRefreshList(response.obj.DyeingOrderDetails, 'tblFabricPlan');
                    Refresh(response.obj.FabricPlans);debugger;
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    function formatPrice(val,row)
    {
   
        val=parseFloat(val);
        var test = val.toFixed(0);
        if (val <= 0)
        {
            test=(-1*test);
        }
        var tests =test;// addComma(test);
        if (val <= 0)
        {
            return '';
        }
        else 
        {
            return tests;
        }

    }
    function CopyDetail()
    {
        debugger;
        if(parseInt($('#cboWarp').val())<=0)    {alert("Please Selet Warp/Weft Type"); return false}

        var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');
        var oFabricPlans_New=[];
        for(var i =0;i<oFabricPlans.length;i++)
        {

            var oFabricPlan={
                FabricPlanID:0,
                FabricPlanID: 0,
                ProductID:oFabricPlans[i].ProductID,
                RGB:oFabricPlans[i].RGB,
                //ColorSet:$('#txtColorSet').val(),
                ColorInHEX:oFabricPlans[i].ColorInHEX,
                WarpWeftType:(oFabricPlans[i].WarpWeftType==true)?false:true,
                WarpWeftTypeSt:(oFabricPlans[i].WarpWeftType==true)?"Weft":"Warp",
                Color:oFabricPlans[i].Color,
                FabricID:oFabricPlans[i].FabricID,
                ProductName:oFabricPlans[i].ProductName,
                RGB:oFabricPlans[i].RGB,
                Value:oFabricPlans[i].Value
            }

            //var bExists= IsExist(oFabricPlan)
            //if(!bExists)
            //{
            $('#tblFabricPlan').datagrid('appendRow',oFabricPlan);
            var oLDpDetail = $('#tblFabricPlan').datagrid('getRows');
            UpdateFP(oFabricPlan,oLDpDetail.length );
            //}
           
            //oFabricPlans_New.push(oFabricPlan);
        }
    }
    
    function IsExist(oFabricPlan)
    {
        var oLDpDetail = $('#tblFabricPlan').datagrid('getRows');
        for (var i = 0; i < oLDpDetail.length; i++) {
            if (parseInt(oLDpDetail[i].WarpWeftType) ==parseInt(oFabricPlan.WarpWeftType) && oLDpDetail[i].ColorName ==oFabricPlan.ColorName)
            {
                return true;
            }
        }

        return false;
    }
    $('#btnRefresh').click(function(e){

        endEditing();
    });

    $('#btnAddColumn').click(function(e){

        endEditing();
        _oFabricPlanOrder.ColumnCount= _oFabricPlanOrder.ColumnCount+5;

        debugger
        var oFabricPlanDetails=[];
        var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');

        for(var i=0;i<oFabricPlans.length;i++)
        {
            var oFabricPlan=  oFabricPlans[i];
            oFabricPlanDetails=[];
            for(var j=0;j<=_oFabricPlanOrder.ColumnCount;j++)
            {
                var nEndsCount=  oFabricPlan["EndsCount"+j];
                var nColNo=  oFabricPlan["ColNo"+j];
                if(nEndsCount>0)
                {
                    var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:nColNo, EndsCount:nEndsCount, SLNo:0};
                    oFabricPlanDetails.push(oFPD);
                }
                //else{
                //    var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:0, SLNo:0};
                //    oFabricPlanDetails.push(oFPD);
                //}
            }
            oFabricPlans[i].FabricPlanDetails=oFabricPlanDetails;
        }

        MakeGrid();
        Refresh(oFabricPlans);

    });

    //NAZMUL 9/12/19
    $("#btnRepeatSection").click(function(){
        debugger;
        var oFabricPlanRepeat={
            FabricPlanOrderID : parseInt(_oFabricPlanOrder.FabricPlanOrderID)
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url :  _sBaseAddress+ "/FabricPlan/GetFabricPlanRepeat",
            traditional: true,
            data:  JSON.stringify(oFabricPlanRepeat),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                _oFabricPlanRepeats = data;
                if (_oFabricPlanRepeats.length>0)
                {
                    DynamicRefreshList(_oFabricPlanRepeats,'tblFabricPlanRepeat');
                }
                else
                {
                    //RefreshConsumption();
                    DynamicRefreshList([],'tblFabricPlanRepeat');
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

        $("#winFabricPlanRepeat").icsWindow('open',"Add Faric Plan Repeat");
    });

    $("#btnFabricPlanRepeatClose").click(function(){ 
        $("#winFabricPlanRepeat").icsWindow('close');
    });

    function ValidateInput(){
        var nStartCol =  parseInt($("#cboStartCol").val())
        var nEndCol =  parseInt($("#cboEndCol").val())
        var nWarpWeftType =  parseInt($("#cboWarpWeftType").val())
        if(nEndCol<nStartCol || nEndCol ==nStartCol){
            alert("Start Col Must be greater then End Col");
            return false;
        }

        if(nWarpWeftType == 3){
            alert("Choose Warp or Weft!");
            return false;
        }
        
        return true;
    }
    $('#btnAddFabricPlanRepeat').click(function(){
        debugger;  
        sessionStorage.setItem("FabricPlanRepeatHeader","Add FabricPlanRepeat")
        var oFabricPlanRepeat =
            {
                FabricPlanRepeatID :  0,
                FabricPlanOrderID : parseInt(_oFabricPlanOrder.FabricPlanOrderID),
                WarpWeftType : parseInt($("#cboWarpWeftType").val()),
                RepeatNo : parseInt(icsRemoveComma($('#txtRepeatNo').val())),
                StartCol :   parseInt($("#cboStartCol").val()),
                EndCol :  parseInt($("#cboEndCol").val())
            }
        debugger;
        if(!ValidateInput()){return;}
        $.ajax({
            type: "POST",
            dataType: "json",
            url :  _sBaseAddress+ "/FabricPlan/FabricPlanRepeatSave",
            traditional: true,
            data:  JSON.stringify(oFabricPlanRepeat),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                oFabicPlanRepeat = jQuery.parseJSON(data);
                var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                if (oFabicPlanRepeat.ErrorMessage=="" || oFabicPlanRepeat.ErrorMessage==null)
                {
                    alert("Data Saved sucessfully");
                    if(sessionStorage.getItem("FabricPlanRepeatHeader") == "Add FabricPlanRepeat")
                    {
                        $('#tblFabricPlanRepeat').datagrid('appendRow',oFabicPlanRepeat);
                        var oData = $('#tblFabricPlanRepeat').datagrid('getRows');
                        $('#tblFabricPlanRepeat').datagrid('selectRow',oData.length-1);

                    }                                          
                    RefreshConsumption();                   
                    //$("#winFabricPlanRepeat").icsWindow('close');
                }
                else
                {
                    alert(oFabicPlanRepeat.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    });

    $("#btnRemoveFabricPlanRepeat").click(function(){
        debugger;
        var oFabricPlanRepeat = $('#tblFabricPlanRepeat').datagrid('getSelected');
        if(oFabricPlanRepeat==null || oFabricPlanRepeat.FabricPlanRepeatID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblFabricPlanRepeat').datagrid('getRowIndex',oFabricPlanRepeat);
        $.ajax({
            type: "GET",
            dataType: "json",
            url :  _sBaseAddress+ "/FabricPlan/FabricPlanRepeatDelete",
            data: {id: oFabricPlanRepeat.FabricPlanRepeatID},
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                feedbackmessage = jQuery.parseJSON(data);
                if (feedbackmessage == "Deleted")
                {
                    alert("Delete sucessfully");
                    $('#tblFabricPlanRepeat').datagrid('deleteRow',SelectedRowIndex);

                }
                else
                {
                    alert(feedbackmessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });
       
    function RefreshConsumption()
    {
        $('#txtRepeatNo').val(0);
        $("#cboWarpWeftType").val(0);
        $("#cboStartCol").val(0);
        $("#cboEndCol").val(0);
    }
</script>