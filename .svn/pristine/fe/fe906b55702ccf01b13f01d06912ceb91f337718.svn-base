<html>
<head>
    @{ViewBag.Title = "Production Sheet";}
</head>
<body>
    @model ESimSol.BusinessObjects.ProductionSheet
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable" id="divPS">
        <div class="easyui-panel" title="Production Sheet(Poly)" style="font-family:Tahoma; text-align:center; height:88%;">
            <div style="width:100%;" id="divBasicInfo">
                <fieldset>
                    <legend style="font-weight:bold">Production Sheet info: </legend>
                    <table style="width:100%" cellpadding="1" cellspacing="1">
                        <tr>
                            <td style="width: 10%; text-align: right">
                                Sheet No:
                            </td>
                            <td style="width: 25%; text-align: left">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:30%">@Html.TextBoxFor(model => model.SheetNo, new { style = "width: 100%;", id = "txtSheetNo", disabled = "disabled" })</td>
                                        <td style="width:30%; text-align:right;">Issue Date:</td>
                                        <td style="width:40%"><input id="txtIssueDate" type="date" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                    </tr>
                                </table>

                            </td>
                            <td style="width: 10%; text-align:right;">
                                Customer :
                            </td>
                            <td style="width:20%; text-align:left;">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:84%;">@Html.TextBoxFor(model => model.ContractorName, new { style = "width: 100%;", id = "txtContractorName" })</td>
                                        <td style="width:16%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPickContractor" /></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width:10%; text-align: right">
                                PI No:
                            </td>
                            <td style="width: 25%; text-align: right">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:85%">@Html.TextBoxFor(model => model.ExportPINo, new { style = "width:100%;", id = "txtExportPINo" })</td>
                                        <td style="width:15%; text-align:right;"><input type="button" id="btnPickPI" value="Pick" /></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr>
                            <td style="width: 10%; text-align: right">
                                Measurement:
                            </td>
                            <td style="width: 25%; text-align: left">
                                @Html.TextBoxFor(model => model.Measurement, new { style = "width: 100%;", id = "txtMeasurement" })
                            </td>
                            <td style="width: 10%; text-align: right">
                                Product:
                            </td>
                            <td style="width: 20%; text-align: left">
                                        @Html.TextBoxFor(model => model.ProductName, new { style = "width: 100%;", id = "txtProductName" })
                                       
                            </td>
                            <td style="width:10%; text-align: right">
                                Order Qty:
                            </td>
                            <td style="width: 25%; text-align: right">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:85%">@Html.TextBoxFor(model => model.ProdOrderQty, new { style = "width:97%;text-align:right", id = "txtProdOrderQty", disabled = "disabled" })</td>
                                        <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbol", disabled = "disabled" })</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr>
                            <td style="width: 10%; text-align: right">
                                F.G Weight:
                            </td>
                            <td style="width: 25%; text-align: left">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%" style="font-size:11px;">
                                    <tr>
                                        <td style="width:20%;">@Html.TextBoxFor(model => model.FGWeight, new { style = "width:95%;text-align:right", id = "txtFGWeight" })</td>
                                        <td style="width:20%; text-align:right;">@Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width:90%;text-align:right", id = "txtFGWeightUnitSymbol", disabled = "disabled" })</td>
                                        <td style="width:26%; text-align:right;">Wastage:</td>
                                        <td style="width:20%;">@Html.TextBoxFor(model => model.NaliWeight, new { style = "width:95%;text-align:right", id = "txtNaliWeight" })</td>
                                        <td style="width:14%; text-align:right;">@Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width:90%;text-align:right", id = "txtNaliFGWeightUnitSymbol", disabled = "disabled" })</td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">
                                Total Weight:
                            </td>
                            <td style="width: 20%; text-align: left">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:80%">
                                            @Html.TextBoxFor(model => model.TotalWeight, new { style = "width:90%;text-align:right", id = "txtTotalWeight", disabled = "disabled" })
                                        </td>
                                        <td style="width:20%; text-align:right;">
                                            @Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width: 95%;text-align:right", id = "txtTotalFGWeightUnitSymbol", disabled = "disabled" })
                                        </td>
                                </table>
                            </td>
                            <td style="width: 10%; text-align: right">
                                Remaining Qty:
                            </td>
                            <td style="width: 25%; text-align: right">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:85%">@Html.TextBoxFor(model => model.YetToSheetQty, new { style = "width:97%;text-align:right", id = "txtYetToSheetQty", disabled = "disabled" })</td>
                                        <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbolRemainingQty", disabled = "disabled" })</td>
                                    </tr>
                                </table>
                            </td>

                        </tr>
                        <tr>
                            <td style="width: 10%; text-align: right">
                                Recipe Name:
                            </td>
                            <td style="width: 25%; text-align: left">
                               @Html.TextBoxFor(model => model.RecipeName, new { style = "width: 100%;", id = "txtRecipeName" })
                            </td>
                            <td style="width: 10%; text-align: right">
                                Color Name:
                            </td>
                            <td style="width: 20%; text-align: left">
                                @Html.TextBoxFor(model => model.ColorName, new { style = "width: 100%;", id = "txtColorName", disabled = "disabled" })
                            </td>
                            <td style="width: 10%; text-align: right">
                                Poly Qty:
                            </td>
                            <td style="width: 25%; text-align: right">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:85%">@Html.TextBoxFor(model => model.Quantity, new { style = "width:97%;text-align:right", id = "txtQuantity" })</td>
                                        <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbolQty", disabled = "disabled" })</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 10%; text-align: right">
                                Machine:
                            </td>
                            <td style="width:25%; text-align: left">
                               @Html.TextBoxFor(model => model.MachineName, new { style = "width: 100%;", id = "txtMachineName", placeholder = "Type Machine Name and Press Enter" })</td>
                                      
                            <td style="width: 10%; text-align: right">
                                Qty Per Carton :
                            </td>
                            <td style="width:25%; text-align: left">
                                @Html.TextBoxFor(model => model.PerCartonFGQty, new { style = "width: 100%;", id = "txtPerCartonFGQty" })
                            </td>
                            <td style="width: 10%; text-align: right">
                                Note:
                            </td>
                            <td style="width: 25%; text-align: right">@Html.TextBoxFor(model => model.Note, new { style = "width:99%;", id = "txtNote" })</td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <table id="tblProductionRecipe" title="Production Recipe Details" class="easyui-datagrid" style="height:268px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar" data-options="onClickRow: onClickRow">
                <thead>
                    <tr>
                        <th field="ProductName" width="25%" align="left">Raw Material Name</th>
                        <th width="10%" align="left" field="QtyTypeSt">Qty Type</th>
                        <th width="10%" align="left" field="MUName">Unit Name</th>
                        <th width="10%" align="left" data-options="field:'QtyInPercent',editor:{type:'numberbox',options:{precision:4}}">Qty(%)</th>
                        <th width="20%" align="right" field="RequiredQty" formatter="formatPrice4digit">Required Qty</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar">
                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="RefreshGrid()">Refresh</a>
                <select id="cboQtyType" style="width:150px"><option value="0">--Select Qty Type--</option><option value="1">Percent</option><option value="2">Count</option></select>
                <input type="text" id="txtRawMaterialName" placeholder="Type Raw Material Name & Press Enter" style="width:180px" />
                <a id="btnPickRawMaterial" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Pick</a>
                <a id="btnRemoveRawmaterial" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="RemoveRawMaterial()">Remove</a>
            </div>
        </div>
        <fieldset style="height:7.5%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:83%; text-align:right"></td>
                    <td style="width:17%;text-align:right;">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="Close()" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oPaymentTypes=[];
    var _oPriorityLevels=[];
    var _oMktPersons = [];
    var _oProduct = null;
    var _oColorCategory = null;
    var _oSizeCategory =  null;
    var _bIsBuyer= true;
    var _oCurrencyList = [];
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oProductionSheet =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oUnitConversions = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.UnitConversions));
        
        $('#divPS').data('ProductionSheet',oProductionSheet);
        $('#divPS').data('UnitConversions', oUnitConversions);
        debugger;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $('#txtFGWeight,#txtNaliWeight,#txtPerCartonFGQty,#txtQuantity,#txtYetToSheetQty').icsCurrencyBox();
        $('#txtIssueDate').datebox('setValue',oProductionSheet.IssueDateInString);
        if(parseInt(oProductionSheet.ProductionSheetID)>0)
        {
            GetsUnitConversion(parseInt(oProductionSheet.RecipeID));
            RefreshControl(oProductionSheet);
        }
        if(parseInt(oProductionSheet.PTUUnit2ID)>0)
        {
            $("#txtExportPINo,#txtContractorName,#txtProductName,#txtModelReferencenName").addClass("fontColorOfPickItem");
        }
        $('#tblRecipes').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowData);}});
        $('#divBasicInfo *').attr("disabled", true);
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    function RowSelect(oRecipe)
    {
        DynamicRefreshList(oRecipe.RecipeDetails, "tblRecipeDetails");
        //GetsUnitConversion(parseInt(oRecipe.RecipeID));
    }
    function CloseRecipePicker()
    {
        $("#winRecipePicker").icsWindow('close');
    }

    $('#txtNaliWeight,#txtFGWeight,#txtQuantity').keyup(function()
    {
        $('#txtTotalWeight').val(parseFloat($('#txtFGWeight').val())+parseFloat($('#txtNaliWeight').val()));
        CalculateRequiredQty();
    });

    function GetUnitConversion(nProductID, nFromUnitID, nToUnitID)
    {
        var nConversionValue = 0;
        var oUnitConversions = $('#divPS').data('UnitConversions');
        for(var i=0; i<oUnitConversions.length; i++)
        {
            if(parseInt(oUnitConversions[i].ProductID)===parseInt(nProductID) &&  parseInt(oUnitConversions[i].MeasurementUnitID)===parseInt(nFromUnitID) && parseInt(oUnitConversions[i].ConvertedUnitID)===parseInt(nToUnitID))
            {
                return parseFloat(oUnitConversions[i].ConvertedUnitValue);
            }
        }
        return nConversionValue;
    }

    function CalculateRequiredQty()
    {
        debugger;
        var nTotalWeight = parseFloat(icsRemoveComma($('#txtTotalWeight').val()));
        var nFGQty = parseFloat(icsRemoveComma($('#txtQuantity').val()));
        var  nFGMUnitID = parseInt($('#divPS').data('ProductionSheet').FGWeightUnitID);
        if(nTotalWeight<=0)
        {
            alert("Invalid Poly Total Weight!");
            return;
        }

        var oProductionRecipes = $('#tblProductionRecipe').datagrid('getRows');
        for(var i = 0;i<oProductionRecipes.length;i++)
        {
            if(parseInt(oProductionRecipes[i].QtyTypeInt)==1)
            {
                var nConvertedValue=1;
                var nPerPolyReqQty = (nTotalWeight * parseFloat(parseFloat(oProductionRecipes[i].QtyInPercent))/100);
                if(parseInt(oProductionRecipes[i].MUnitID)!= nFGMUnitID)
                {
                    nConvertedValue=GetUnitConversion(oProductionRecipes[i].ProductID, nFGMUnitID, oProductionRecipes[i].MUnitID);
                }
                if(nConvertedValue<=0)
                {
                    alert("Unit conversion required for "+ oProductionRecipes[i].ProductName +"!");
                    return;
                }
                nPerPolyReqQty= (nPerPolyReqQty * nConvertedValue);
                oProductionRecipes[i].RequiredQty =parseFloat((nPerPolyReqQty*nFGQty));
            }
            else
            {
                oProductionRecipes[i].RequiredQty = parseFloat(oProductionRecipes[i].QtyInPercent * nFGQty);
            }
        }
        RefreshProductionRecipeList(oProductionRecipes);
    }

    function RefreshControl(oProductionSheet){
        if(parseInt(oProductionSheet.ProductionSheetID)>0)
        {
            $("#txtExportPINo,#txtRecipeName,#txtContractorName,#txtMachineName,#txtProductName").addClass("fontColorOfPickItem");
            RefreshProductionRecipeList(oProductionSheet.ProductionRecipes);
        }
    }

    function RefreshProductionRecipeList(oOrderDetailList)
    {
        var data=oOrderDetailList;
        data={"total":""+data.length+"","rows":data};
        $('#tblProductionRecipe').datagrid('loadData',data);
    }

    function Validation(){

        if(parseInt($('#divPS').data('ProductionSheet').PTUUnit2ID)<=0)
        {
            $('#txtExportPINo').focus();
            $('#txtExportPINo').addClass("errorFieldBorder");
            alert('Please Pick Prodction Order.');
            return false;
        }else{
            $('#txtExportPINo').removeClass("errorFieldBorder");
        }


        if(parseInt($('#divPS').data('ProductionSheet').ContractorID)<=0){
            $('#txtContractorName').focus();
            $('#txtContractorName').addClass("errorFieldBorder");
            alert('Please Pick Buyer.');
            return false;
        }
        else{
            $('#txtContractorName').removeClass("errorFieldBorder");
        }

        if(parseInt($('#divPS').data('ProductionSheet').RecipeID)<=0){
            $('#txtRecipeName').focus();
            $('#txtRecipeName').addClass("errorFieldBorder");
            alert('Please Pick Recipe');
            return false;
        }
        else{
            $('#txtRecipeName').removeClass("errorFieldBorder");
        }

        if(parseInt($('#divPS').data('ProductionSheet').MachineID)<=0)
        {
            $('#txtMachine').focus();
            $('#txtMachine').addClass("errorFieldBorder");
            alert('Please Pick Machine.');
            return false;
        }else{
            $('#txtMachine').removeClass("errorFieldBorder");
        }
        if(parseInt(icsRemoveComma($('#txtPerCartonFGQty').val()))<=0)
        {
            $('#txtPerCartonFGQty').focus();
            $('#txtPerCartonFGQty').addClass("errorFieldBorder");
            alert('Finish Good Qty in per Carton should be greater than 0.');
            return false;
        }else{
            $('#txtPerCartonFGQty').removeClass("errorFieldBorder");
        }

        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
        {
            alert('Sheet Quantity Should be Greater than 0.');
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))> parseFloat(icsRemoveComma($('#txtYetToSheetQty').val())))
        {
            alert('Sheet Quantity Should be Less than Remianing Qty.');
            return false;
        }

        return true;
    }

    function RefreshObject()
    {
        var oTempProductionSheet = $('#divPS').data('ProductionSheet');
        var oProductionSheet={
            ProductionSheetID: oTempProductionSheet.ProductionSheetID,
            ProductionRecipes:$('#tblProductionRecipe').datagrid('getRows')
        };
        return oProductionSheet;
    }

    $("#btnSave").click(function (){
        debugger;
        endEditing();
        if(!Validation()) return false;
        var oProductionSheet=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionSheet/ChangeRawMaterial",
            traditional: true,
            data:  JSON.stringify(oProductionSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oProductionSheet = jQuery.parseJSON(data);
                if (oProductionSheet.ErrorMessage==null || oProductionSheet.ErrorMessage=="")
                {
                    alert("Successfully Changed Rawmaterial. You Can Change it Until Out Raw Material From Store.");
                    var oProductionSheets = sessionStorage.getItem("ProductionSheets");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oProductionSheets != null) {
                        oProductionSheets = jQuery.parseJSON(oProductionSheets);
                    }
                    else {
                        oProductionSheets = [];
                    }
                    if (nIndex != -1) {
                        oProductionSheets[nIndex] = oProductionSheet;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oProductionSheets.length);
                        oProductionSheets.push(oProductionSheet);
                    }
                    sessionStorage.setItem("ProductionSheets", JSON.stringify(oProductionSheets));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oProductionSheet.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });


    //Raw Material
    //Product Pick
    $("#btnPickRawMaterial").click(function ()
    {
        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
        {
            alert('Sheet Quantity Should be Greater than 0.');
            return false;
        }
        if(parseInt($('#cboQtyType').val())<=0)
        {
            alert("Please select Qty Type!");
            $('#cboQtyType').focus();
            return;
        }
        GetRawMaterials("");
    });

    $("#txtRawMaterialName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
            {
                alert('Sheet Quantity Should be Greater than 0.');
                return false;
            }

            if($.trim($('#txtRawMaterialName').val())==null || $.trim($('#txtRawMaterialName').val())=="")
            {
                alert("Type Raw Material Name and Press Enter.");
                $('#txtRawMaterialName').focus();
                return;
            }
            if(parseInt($('#cboQtyType').val())<=0)
            {
                alert("Please select Qty Type!");
                $('#cboQtyType').focus();
                return;
            }
            var sProductName = $.trim($('#txtRawMaterialName').val());
            GetRawMaterials(sProductName);
        }else if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtRawMaterialName").removeClass("fontColorOfPickItem");
        }
    });
    function GetRawMaterials(sProductName)
    {
        var oProduct = {ProductName:sProductName, BUID:sessionStorage.getItem("BUID")};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Recipe",
            ActionName: "SearchByProductBUModuleWise",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = []; var oColumn = { field: "ProductCode", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 130, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductCategoryName", title: "Category Name", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winRawMaterialPicker',
                        winclass: 'clsRawMaterialPicker',
                        winwidth: 640,
                        winheight: 460,
                        tableid: 'tblRawMaterialPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'RawMaterial List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }

    $("#btnRefreshDetail").click(function (){
        endEditing();
    });

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
         if(oPickerobj.winid == 'winRawMaterialPicker')
        {
            debugger;
            if(oreturnobjs.length>0)
            {
                var oProductionRecipes=$('#tblProductionRecipe').datagrid('getRows');
                for(var i = 0;i<oreturnobjs.length;i++)
                {
                    if(!ICS_IsExist(oProductionRecipes,"ProductID",oreturnobjs[i].ProductID))
                    {
                        var nQtyType = parseInt($('#cboQtyType').val())
                        var oProductionRecipe = {
                            ProductionRecipeID:0,
                            ProductionSheetID:$('#divPS').data('ProductionSheet').ProductionSheetID,
                            ProductID :oreturnobjs[i].ProductID,
                            QtyInPercent:0,
                            RequiredQty : 0,
                            QtyType :nQtyType,
                            QtyTypeInt : nQtyType,
                            QtyTypeSt:$('#cboQtyType option:selected').text(),
                            Remarks :"",
                            ProductCode  :oreturnobjs[i].ProductCode,
                            ProductName: oreturnobjs[i].ProductName,
                            MUnitID : oreturnobjs[i].MeasurementUnitID,
                            MUName :  oreturnobjs[i].MUnit
                        };
                        $('#tblProductionRecipe').datagrid('appendRow',oProductionRecipe);
                        GetsUnitConversionByProduct(oProductionRecipe.ProductID);
                    }
                }
            }
        }
    }

    function RemoveRawMaterial()
    {
        ////debugger;
        var oRawMaterialDetail = $('#tblProductionRecipe').datagrid('getSelected');
        if(oRawMaterialDetail==null)
        {
            alert("Please select a item from list!");
            return;
        }
        var conf = confirm("Confirm to delete?");
        if(conf==false)return;
        ////debugger;
        var SelectedRowIndex=$('#tblProductionRecipe').datagrid('getRowIndex',oRawMaterialDetail);
        $('#tblProductionRecipe').datagrid('deleteRow',SelectedRowIndex);
        RefreshGrid();
    }

    function RefreshGrid()
    {
        endEditing();
        data=$('#tblProductionRecipe').datagrid('getRows');
        data={"total":""+data.length+"","rows":data};
        $('#tblProductionRecipe').datagrid('loadData',data);
        $('#tblProductionRecipe').datagrid({selectOnCheck:false, checkOnSelect:false})
    }
    function GetsUnitConversion(nRecipeID)
    {
        var oUnitConversions = [];
        $('#divPS').data('UnitConversions', oUnitConversions);

        var oRecipe={
            RecipeID : nRecipeID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/MeasurementUnit/GetsUCByReceipe",
            data:  JSON.stringify(oRecipe),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oUnitConversions = jQuery.parseJSON(data);
                if(oUnitConversions.length>0)
                {
                    $('#divPS').data('UnitConversions', oUnitConversions);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function GetsUnitConversionByProduct(nProductID)
    {
        var oProduct ={
            ProductID : nProductID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/MeasurementUnit/GetsUCByProduct",
            data:  JSON.stringify(oProduct),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oTempUnitConversions = jQuery.parseJSON(data);
                if(oTempUnitConversions.length>0)
                {
                    var oUnitConversions = $('#divPS').data('UnitConversions');
                    for(var i=0; i<oTempUnitConversions.length;i++)
                    {
                        oUnitConversions.push(oTempUnitConversions[i]);
                    }
                    $('#divPS').data('UnitConversions', oUnitConversions);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }
    function GetProductionRecipes(nRecipeID)
    {
        var oUnitConversions = [];
        $('#divPS').data('UnitConversions', oUnitConversions);

        //debugger;
        var oRecipe={
            RecipeID : nRecipeID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionSheet/GetProductionRecipes",
            data:  JSON.stringify(oRecipe),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var  oProductionSheet = jQuery.parseJSON(data);
                if((oProductionSheet.ErrorMessage=="" || oProductionSheet.ErrorMessage==null) && oProductionSheet.ProductionRecipes.length>0)
                {
                    $('#divPS').data('UnitConversions', oProductionSheet.UnitConversions);
                    RefreshProductionRecipeList(oProductionSheet.ProductionRecipes);
                    CalculateRequiredQty();
                }else
                {
                    alert(oProductionSheet.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }


    function ValidateInputDetail()
    {
        if(_oProduct==null || $('#txtProductName').val()=="")
        {
            $('#txtProductName').focus();
            $('#txtProductName').addClass("errorFieldBorder");
            alert('Select Product');
            return false;
        }
        if(_oProduct.IsApplyColor)
        {
            if(parseInt(_oColorCategory.ColorCategoryID)<=0)
            {
                $('#txtColorName').focus();
                $('#txtColorName').addClass("errorFieldBorder");
                alert('Select Color');
                return false;
            }
        }

        if($('#cboUnit').val()<=0)
        {
            $('#cboUnit').focus();
            alert('Select Unit.');
            return false;
        }
        if(_oProduct.IsApplyMeasurement)
        {
            if( $('#txtMeasurement').val()==""|| $('#txtMeasurement').val()==null)
            {
                $('#txtMeasurement').focus();
                $('#txtMeasurement').addClass("errorFieldBorder");
                alert('Select Measurement');
                return false;
            }
        }
        if(parseInt(icsRemoveComma($('#txtQty').val()))<=0)
        {
            $('#txtQty').focus();
            $('#txtQty').addClass("errorFieldBorder");
            alert('Qty Should be Greater than 0');
            return false;
        }
        if(parseFloat(icsRemoveComma($('#txtRate').val()))<=0)
        {
            $('#txtRate').focus();
            $('#txtRate').addClass("errorFieldBorder");
            alert('Rate Should be Greater than 0');
            return false;
        }
        return true;
    }

    function ResetDetail(){
        _oProduct = null;_oColorCategory = null;_oSizeCategory = null;
        $('#txtQty,#txtRate').val('');
        $('#txtColorQty').val(0);
        $('#txtProductName,#txtColorName,#txtProductDescription,#txtMeasurement,#txtStyleDescription,#txtBuyerRef').removeClass("fontColorOfPickItem");
        $('#txtProductName,#txtColorName,#txtProductDescription,#txtMeasurement,#txtStyleDescription,#txtBuyerRef').val("");

        var oUnits = [];
        $("#cboUnit").icsLoadCombo({List: oUnits,OptionValue: "MeasurementUnitID",DisplayText: "Symbol"});
        $('#txtProductName').focus();
    }

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnRemoveDetail").click(function () {

        var oProductionRecipe = $("#tblProductionRecipe").datagrid("getSelected");
        if (oProductionRecipe == null || parseInt(oProductionRecipe.ProductID) <= 0) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to Delete?")) return false;
        var SelectedRowIndex=$('#tblProductionRecipe').datagrid('getRowIndex',oProductionRecipe);
        alert("Data Delete Successfully.");
        $('#tblProductionRecipe').datagrid('deleteRow',SelectedRowIndex);
        SetTotal();
    });

    var editIndex = undefined;
    function endEditing(){
        if (editIndex == undefined){return true}
        if ($('#tblProductionRecipe').datagrid('validateRow', editIndex)){
            $('#tblProductionRecipe').datagrid('endEdit', editIndex);
            $('#tblProductionRecipe').datagrid('selectRow',editIndex);
            var oProductionRecipe=$('#tblProductionRecipe').datagrid('getSelected');
            if(oProductionRecipe!=null)
            {
                $('#tblProductionRecipe').datagrid('updateRow',{index: editIndex,	row: oProductionRecipe});
            }
            var oDetails = $('#tblProductionRecipe').datagrid('getRows');
            //for(var i =0;i<oDetails.length;i++)
            //{
            //    if(oDetails[i].)
            //}
            CalculateRequiredQty();
            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRow(index){
        if (editIndex != index){
            if (endEditing())
            {
                $('#tblProductionRecipe').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else
            {
                $('#tblProductionRecipe').datagrid('selectRow', editIndex);
            }
        }
    }



</script>