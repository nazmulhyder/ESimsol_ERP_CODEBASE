@model ESimSol.BusinessObjects.RouteSheetPacking
    @{
        ViewBag.Title = "Packing & QC";
    }
    <div class="menuMainCollectionTable">
        <div id="region-error">
            <center style="font-size:20px;">
                @Html.ValidationMessage("Error")
            </center>
        </div>
        
        <fieldset style="width:100%; height:25%">
            <legend>Dye Line Info</legend>
            <table cellpadding="2" class="tbl-Win routesheet-info">
                <tr>
                    <td class="td-col-2 align-right">
                        <label id="lblRSNo" class="header-text">Dyeing Lot No :</label>
                    </td>
                    <td class="td-col-3 align-left">
                        <input id="txtRouteSheet" class="reset-text txt-styler" placeholder="Search DL" />
                    </td>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Buyer :</label>
                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblBuyerName"></label>
                    </td>
                    <td class="td-col-2 align-right">
                        <label class="header-text"> Status :</label>
                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblRSState"></label>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Machine No :</label>
                    </td>
                    <td class="td-col-3 align-left">
                        <label id="lblMachineNo"></label>
                    </td>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Order No:</label>

                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblDyeingOrderNo"></label>
                    </td>
                   
                    <td class="td-col-2 align-right">
                        <label class="header-text">Product :</label>
                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblProduct"></label>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Color & Shade :</label>
                    </td>
                    <td class="td-col-3 align-left">
                        <label id="lblColorShade"></label>
                    </td>
                    <td class="td-col-2 align-right">
                        <label id="lblHeaderHanksCone" class="header-text">Hanks/Cone :</label>
                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblNoOfHanksCone"></label>
                    </td>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Weight :</label>
                    </td>
                    <td class="td-col-5 align-left">
                        <label id="lblWeight"></label>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-2 align-right">
                        <label class="header-text">Received Qty :</label>
                    </td>
                    <td class="td-col-3 align-left">
                        <label id="lblQty_Received"></label>
                    </td>
                    <td class="td-col-2 align-right">
                        @*<label id="lblHeaderHanksCone" class="header-text">Hanks/Cone :</label>*@
                    </td>
                    <td class="td-col-5 align-left">
                      
                    </td>
                    <td class="td-col-2 align-right">
                        
                    </td>
                    <td class="td-col-5 align-left">
                       
                    </td>
                    
                </tr>
            </table>
        </fieldset>
      
        <div style="padding-left:2px;">
            <div id="tabPackingQC" style="width:100%;" class="easyui-tabs">
                <div title="Packing" style="padding:2px; width:100%;">
                    <table id="tblRouteSheetPacking" class="easyui-datagrid" style="width:100%;height:370px;"  fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" autorowwidth="false" toolbar="#toolbarPacking">
                        <thead>
                            <tr>
                                <th field="BagNo" width="10%">BagNo</th>
                                <th field="Weight" width="12%" formatter="formatPrice" align="right">Weight(<label id="lblMUOne"></label>)</th>
                                <th field="WeightTwo" width="12%" formatter="formatPrice" align="right">Weight(<label id="lblMUTwo"></label>)</th>
                                <th field="NoOfHankCone" width="10%" formatter="formatPrice" align="right">Hanks/Cone</th>
                                <th field="YarnTypeSt" width="10%" align="left">Type</th>
                                @*<th field="Length" width="15%" align="left">Length</th>*@
                                <th field="Note" width="5%" align="left">Note</th>
                                <th field="QCBYName" width="8%" align="left">QC By</th>
                                <th field="QCDateSt" width="8%" align="left">QCDate</th>
                            </tr>
                        </thead>
                    </table>
                    <div id="toolbarPacking">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:70%" class="align-left">
                                    <a id="btnAddPacking" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-add" plain="true">Add</a>
                                    <a id="btnEditPacking" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-edit" plain="true">Edit</a>
                                    <a id="btnDeletePacking" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-remove" plain="true">Delete</a>
                                    <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Label)</a>
                                    <a id="btnPrintCard" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Card)</a>
                                    <a id="btnPrintLabelDynamic" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Dynamic Label)</a>
                                    <a id="btnPrintCardDynamic" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Dynamic Card)</a>
                                </td>
                                <td style="width:30%" class="align-right">
                                    <label id="lblPackingRemarks"></label>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div title="QC" style="padding:2px">
                    @*<table id="tblRouteSheetQC" title="" class="easyui-datagrid" style="width: 100%; height:300px; margin: 0;" data-options=" fit:true, singleSelect: true,fitColumns:true, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarQC',onclickrow: 'onclickrow' ">*@
                    <table id="tblRouteSheetQC" class="easyui-datagrid" style="width:100%;height:300px" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" toolbar="#toolbarQC" data-options="onClickRow: onClickRow">
                        <thead>
                            <tr>
                                <th field="QCSetupName" width="5px">Type</th>
                                <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="3px">Qty</th>
                                <th data-options="field:'Note',align:'left',editor:{type:'text'}" width="10px">Note</th>
                                <th field="RSInQCDetailID" width="5px" align="center" formatter="formatInspection"></th>
                            </tr>
                        </thead>
                    </table>
                        <div id="toolbarQC">
                            <table style="width:100%;">
                                <tr>
                                    <td style="width:50%" class="align-left">
                                        <label id="lblShortQty"></label>
                                       <input type="number" id="txtShortQty" style="width:13%" class="number" />
                                        <a id="btnQCDone" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-ok" plain="true">QC Passed</a>
                                        <a id="btnAddMoreFreshDyedYarn" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-ok" plain="true">Add More</a>
                                        <a id="btnDeleteQCItem" href="javascript:void(0)" class="easyui-linkbutton active-QC" iconcls="icon-remove" plain="true">Remove</a>
                                    </td>
                                    <td style="width:50%" class="align-right">
                                        <label id="lblQCRemarks"></label>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <table style="width:100%;">
                            <tr>
                                <td style="width:8%;text-align:right ">
                                    <label>Shift:</label>
                                </td>
                                <td style="width:10%;text-align:left ">
                                    <select id="cboRSShift" style="width:100%;"></select>
                                </td>
                                <td style="width:10%;text-align:right ">
                                    <label>Remarks :</label>
                                </td>
                                <td style="width:75%;text-align:left ">
                                    <input id="txtRemark_QC" style="width:100%;text-align:left;" placeholder="Write Remarks" />
                                </td>
                            </tr>

                        </table>
</div>
            </div>
        </div>
        
        <div id="winPacking" class="easyui-window winstyle" title="Add Packing" style="width:450px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table class="tbl-Win">
                <tr>
                    <td class="td-col-6 align-right">
                        <label id="lblBag">No of Bags :</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <input type="number" id="txtNumberBags" class="reset-text txt-styler only-number" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>
                <tr>
                    <td class="td-col-6 align-right">
                        <label id="lbsPerBag">Lbs Per Bag :</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <input id="txtQty" class="reset-text number txt-styler" />
                    </td>
                    <td class="td-styler td-col-1">
                        <label></label>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-6 align-right">
                        <label>Kg Per Bag :</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <input id="txtQtyTwo" class="reset-text number txt-styler" />
                    </td>
                    <td class="td-styler td-col-1">
                        <label></label>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-6 align-right">
                        <label id="lblHeaderHankCone-Picker">No of Hanks:</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <input id="txtHanksCone" class="reset-text number txt-styler" />
                    </td>
                    <td class="td-styler td-col-1">
                    </td>
                </tr>
                <tr class="region-cone">
                    <td class="td-col-6 align-right">
                        <label>Warp/Weft :</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <select id="cboWarpWeft" class="reset-select cbo-styler"></select>
                    </td>
                    <td class="td-styler td-col-1">
                    </td>
                </tr>
                <tr class="region-cone">
                    <td class="td-col-6 align-right">
                        <label>Length :</label>
                    </td>
                    <td class="td-styler td-col-13">
                        <input id="txtLength" class="reset-text txt-styler" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>
                <tr>
                    <td class="td-col-6 align-right">
                        <label>Note :</label>
                    </td>
                    <td class="td-styler td-col-3">
                        <input id="txtNote" class="reset-text txt-styler" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>

                <tr>
                    <td colspan="3" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                        <a id="btnSavePacking" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnClosePacking" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </div>


        <div id="winCardPrint" class="easyui-window winstyle" title="Card Print" style="width:250px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table class="tbl-Win">
                <tr>
                    <td class="td-col-2 align-right">
                        <label>Type :</label>
                    </td>
                    <td class="td-styler td-col-8">
                        <select id="cboCardType" style="width:100%;"></select>
                    </td>
                    @*<td class="td-col-1 align-right"></td>*@
                </tr>
                <tr>
                    <td colspan="3" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                        <a id="btnCardPrintOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnCardPrintClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <style type="text/css">

        .header-text{
            font-weight:bold;
        }
        .tbl-Win {
            width: 100%;
        }

        .td-styler input, select {
            padding-left: 5px;
        }
        .txt-styler{
            width:95%;
        }
        .txt-styler-picker{
            width:70%;
        }
        .cbo-styler{
            width:97.5%;
        }

    </style>

    <script type="text/javascript">

    var _sBaseAddress="";
    var _oRouteSheetPacking=null;
    var _oRouteSheet=null;
    var _nUsableQty=0;
    var _nMUnit="Lbs";
    var _nMUnitTwo="Kg";
    var _oRouteSheetSetup=null;

    $(document).ready(function ()
    {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheetPacking =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var IsError =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.IsError));
        var oWarpWefts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.EnumWarpWefts));
        var oRSShifts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.RSShifts));
        _oRouteSheetSetup =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.RouteSheetSetup));
        $('#txtShortQty').val(0);
        if(IsError)
        {
            $(".menuMainCollectionTable div,fieldset").not('#region-error').hide();
            $('#Mainlayout').layout('collapse', 'west');
            $('#region-error').css({height:"100%", width:"100%", 'line-height':"500px"});
        }
        $('.active-QC').hide();
        $("#cboWarpWeft").icsLoadCombo({
            List: oWarpWefts,
            OptionValue: "Value",
            DisplayText: "Text",
            InitialValue:"Default"
        });

        $("#cboRSShift").icsLoadCombo({
            List: oRSShifts,
            OptionValue: "RSShiftID",
            DisplayText: "Name",
           
        });
        RefreshMUnit(_oRouteSheetSetup);
        $('#lblShortQty').html("Short/Gain Qty:");
    });

    function RefreshMUnit(oRouteSheetSetup)
    {
        if(oRouteSheetSetup==undefined)return;

        _nMUnit=oRouteSheetSetup.MUnit;
        _nMUnitTwo=oRouteSheetSetup.MUnitTwo;
        $('#lblMUOne').html(_nMUnit);
        $('#lblMUTwo').html(_nMUnitTwo);
        $('#lbsPerBag').html(_nMUnit+" Per Bag");
        $('#lblRSNo').html(oRouteSheetSetup.RSShortName+":");
        $("#txtRouteSheet").attr("placeholder", "Type "+oRouteSheetSetup.RSShortName);

    }

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


    $('#tblRouteSheetQC').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData) {
        $('#btnDeleteQCItem').hide();
        if (rowData != null && rowData.RSInQCDetailID > 0) {
            if(_oRouteSheet.Params!='QCDone')
            {
                $('#btnDeleteQCItem').show();
            }
        }
    }


    /*.......... Searching ............. */

    function ResetRouteSheet(){
        _oRouteSheet=null;
        $('.reset-text').val("");
        $('.rs-info').text("");
        $('#lblHeaderHanksCone').text("No of "+_oRouteSheet.DyeingType+': ');
        DynamicRefreshList([], 'tblRouteSheetPacking');
        DynamicRefreshList([], 'tblRouteSheetQC');
        $('.active-QC').hide();
        ResetGridEdit();
    }

    //$("#txtRouteSheet").keyup(function (e) {
    //    var keyCode = e.keyCode || e.which;
    //    if (keyCode == 13)
    //    {
    //        if($.trim($("#txtRouteSheet").val()).length<4){
    //            alert("Please enter 4 character to search.");
    //            return;
    //        }

    //        var oRouteSheet={RouteSheetNo:$.trim($("#txtRouteSheet").val())}

    //        var obj =
    //         {
    //             BaseAddress: _sBaseAddress,
    //             Object: oRouteSheet,
    //             ControllerName: "RouteSheet",
    //             ActionName: "GetRouteSheetWithPacking",
    //             IsWinClose: false
    //         };

    //        $.icsDataGet(obj, function (response) {

    //            if (response.status && response.obj != null) {
    //                if (response.obj.RouteSheetID > 0) {
    //                    _oRouteSheet=response.obj;

    //                    // $('#lblHeaderHanksCone').text(((response.obj.HanksCone)?"No of Hanks :":"No of Cone :"));
    //                    $('#lblHeaderHanksCone').text("No of "+_oRouteSheet.DyeingType+": ");

    //                    $('#txtRouteSheetNo').val(response.obj.RouteSheetNo);
    //                    $('#lblMachineNo').text(response.obj.MachineName);
    //                    $('#lblRSState').text(response.obj.RSStateStr);

    //                    $('#lblDyeingOrderNo').text(response.obj.OrderNoFull);
    //                    $('#lblBuyerName').text(response.obj.PTU.BuyerName);
    //                    $('#lblProduct').text(response.obj.ProductName);

    //                    $('#lblColorShade').text(response.obj.PTU.ColorNameShade);
    //                    $('#lblNoOfHanksCone').text(response.obj.NoOfHanksCone);
    //                    $('#lblWeight').text(formatPrice(response.obj.Qty)+ " "+_nMUnit);

    //                    $('#txtRemark_QC').val(response.obj.Note);
    //                    $('#cboRSShift').val(response.obj.RSShiftID);

    //                    if(response.obj.HanksCone)
    //                    {
    //                        $("#tblRouteSheetPacking").datagrid("hideColumn", "WarpStr");
    //                        $("#tblRouteSheetPacking").datagrid("hideColumn", "Length");
    //                    }
    //                    else
    //                    {
    //                        $("#tblRouteSheetPacking").datagrid("showColumn", "WarpStr");
    //                        $("#tblRouteSheetPacking").datagrid("showColumn", "Length");
    //                    }

    //                    debugger;
    //                    DynamicRefreshList(response.obj.RouteSheetPackings, 'tblRouteSheetPacking');
    //                    DynamicRefreshList(response.obj.RSInQCDetails, 'tblRouteSheetQC');
    //                    PackingQtyRemarks(GetPackingQty());
    //                    GenerateGainLoss();

    //                    if(_oRouteSheet.RSState<=12){
    //                        $('.active-QC').show();
    //                    }
    //                    else if(_oRouteSheet.RSState==13|| _oRouteSheet.RSState==16)
    //                    {
    //                        $('.active-QC').show();
    //                    }
    //                    else{
    //                        $('.active-QC').hide();
    //                    }

    //                }
    //                else { alert(response.obj.ErrorMessage); }
    //            }
    //        });

    //    }
    //    else if(keyCode == 8){
    //        ResetRouteSheet();
    //    }

    //});

    $("#txtRouteSheet").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtRouteSheet").val());
            //if(sRouteSheetNo==""){ alert("Type Dyeing Lot no to search."); return false; }
            GetsRouteSheet(sRouteSheetNo);
        }
        else if(nkeyCode==8){
            $('#winYarnOut input').val('');
            $('#winYarnOut select').val(0);
            _oRouteSheet=null;
          
        }
    });
   
    function GetsRouteSheet(sRouteSheetNo){

        debugger;
        var oRouteSheet = {
            RouteSheetNo:sRouteSheetNo
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsRouteSheetSubFinishing",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "Dyeing Card No", width: 140, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNoFull", title: "OrderNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 90, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MachineName", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "RSStateStr", title: "Status", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRouteSheetPicker',
                        winclass:'clsRouteSheetPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblRouteSheetPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Dyeing Lot No',
                        windowTittle: 'RouteSheet List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeRouteSheetPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Date not found.");
            }
        });


    }

    function IntializeRouteSheetPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            RouteSheetSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                RouteSheetSelect(oPickerobj);
            }
        });
    }

    function RouteSheetSelect(oPickerobj){
        var oRouteSheet = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winRouteSheetPicker')
        {
            if(oRouteSheet !=null  && oRouteSheet.RouteSheetID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                SetRouteSheet (oRouteSheet)
            
            }
            else{
                alert("Data not found.");
            }
        }
    }
    function SetRouteSheet (oRS)
    {
        var oRouteSheet={RouteSheetID:oRS.RouteSheetID}

        if(oRouteSheet.RouteSheetID<=0)
        {
            alert("Not Found")
            return;
        }

        var obj =
         {
             BaseAddress: _sBaseAddress,
             Object: oRouteSheet,
             ControllerName: "RouteSheet",
             ActionName: "GetRouteSheetWithPacking",
             IsWinClose: false
         };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) {
                    _oRouteSheet=response.obj;

                    // $('#lblHeaderHanksCone').text(((response.obj.HanksCone)?"No of Hanks :":"No of Cone :"));
                    $('#lblHeaderHanksCone').text("No of "+_oRouteSheet.DyeingType+": ");

                    $('#txtRouteSheet').val(response.obj.RouteSheetNo);
                    $('#lblMachineNo').text(response.obj.MachineName);
                    $('#lblRSState').text(response.obj.RSStateStr);

                    $('#lblDyeingOrderNo').text(response.obj.OrderNoFull);
                    $('#lblBuyerName').text(response.obj.PTU.BuyerName);
                    $('#lblProduct').text(response.obj.ProductName);

                    $('#lblQty_Received').text(formatPrice(response.obj.RouteSheetDOs[0].Qty_Finish)+ " "+_nMUnit);

                    $('#lblColorShade').text(response.obj.PTU.ColorNameShade);
                    $('#lblNoOfHanksCone').text(response.obj.NoOfHanksCone);
                    $('#lblWeight').text(formatPrice(response.obj.Qty)+ " "+_nMUnit);

                    $('#txtRemark_QC').val(response.obj.Note);
                    $('#cboRSShift').val(response.obj.RSShiftID);

                    if(response.obj.HanksCone)
                    {
                        $("#tblRouteSheetPacking").datagrid("hideColumn", "WarpStr");
                        $("#tblRouteSheetPacking").datagrid("hideColumn", "Length");
                    }
                    else
                    {
                        $("#tblRouteSheetPacking").datagrid("showColumn", "WarpStr");
                        $("#tblRouteSheetPacking").datagrid("showColumn", "Length");
                    }

                    debugger;
                    DynamicRefreshList(response.obj.RouteSheetPackings, 'tblRouteSheetPacking');
                    DynamicRefreshList(response.obj.RSInQCDetails, 'tblRouteSheetQC');
                    PackingQtyRemarks(GetPackingQty());
                    GenerateGainLoss();

                    //if(_oRouteSheet.RSState<=12){
                    //    $('.active-QC').show();
                    //}
                    //else 
                    if(_oRouteSheet.Params != "QCDone")
                    {
                        $('.active-QC').show();
                    }
                    else{
                        $('.active-QC').hide();
                    }

                }
                else { alert(response.obj.ErrorMessage); }
            }
        });
    }

    /*...............  Packing ................. */

    $("#txtQty").keyup(function (e) {
        if($.trim($('#txtQty').val())!="" && parseFloat(icsRemoveComma($('#txtQty').val()))>=0){
            $('#txtQtyTwo').val(formatPrice((parseFloat(icsRemoveComma($('#txtQty').val())))*_oRouteSheetSetup.SMUnitValue));
        }
        else{
            $('#txtQtyTwo').val("");
        }
    });

    $("#txtQtyTwo").keyup(function (e) {
        if($.trim($('#txtQtyTwo').val())!="" && parseFloat(icsRemoveComma($('#txtQtyTwo').val()))>=0){
            debugger
            //$('#txtQty').val(formatPrice(GetLBS(parseFloat(icsRemoveComma($('#txtQtyTwo').val())),4)));
            $('#txtQty').val(formatPrice((parseFloat(icsRemoveComma($('#txtQtyTwo').val())))/_oRouteSheetSetup.SMUnitValue));
        }
        else{
            $('#txtQty').val("");
        }
    });

    $("#txtNumberBags").keyup(function (e) {
        if($("#txtNumberBags").val()==''){
            $$('#txtQty').val(formatPrice(_nUsableQty));
            //$('#txtQtyTwo').val(formatPrice(GetKG(_nUsableQty,2)));
            $('#txtQtyTwo').val(formatPrice(parseFloat(_nUsableQty)/_oRouteSheetSetup.SMUnitValue));
        }
        else{
            var nQty= parseFloat((parseFloat(_nUsableQty)/ parseFloat($('#txtNumberBags').val())).toFixed(2));

            $('#txtQty').val(formatPrice(nQty));
            //$('#txtQtyTwo').val(formatPrice(GetKG(nQty,2)));
            $('#txtQtyTwo').val(formatPrice(parseFloat(nQty)/_oRouteSheetSetup.SMUnitValue));
        }
    });

    $('#txtNumberBags').change(function(e){

        if($('#txtNumberBags').val()<=0){
            $('#txtNumberBags').val(1);
        }

        var nQty= parseFloat((parseFloat(_nUsableQty)/ parseFloat($('#txtNumberBags').val())).toFixed(2));

        $('#txtQty').val(formatPrice(nQty));
        //$('#txtQtyTwo').val(formatPrice(GetKG(nQty,2)));
        $('#txtQtyTwo').val(formatPrice(parseFloat(nQty)/_oRouteSheetSetup.SMUnitValue));

    });

    function GetPackingQty(){
        var oRouteSheetPackings= $('#tblRouteSheetPacking').datagrid('getRows');
        var nPackingQty=0;
        if(oRouteSheetPackings.length>0)
        {
            for(var i=0; i<oRouteSheetPackings.length;i++){
                nPackingQty= parseFloat(nPackingQty) + parseFloat(oRouteSheetPackings[i].Weight);
            }
            nPackingQty=nPackingQty.toFixed(2);
        }
        return nPackingQty;
    }

    function PackingQtyRemarks(nPackingQty){
        var stext="";
        if(parseFloat(nPackingQty)>0){
            stext= "<b>Weight: </b>"+ formatPrice(parseFloat(nPackingQty)) +""+_nMUnit+"  "+"<b> Or   </b>"+ formatPrice(parseFloat(nPackingQty*_oRouteSheetSetup.SMUnitValue)) +" "+_nMUnitTwo ;
        }
        $('#lblPackingRemarks').html(stext);
    }

    function GetUseableWeight(){
        var oRows=$('#tblRouteSheetPacking').datagrid('getRows');
        var nMaxAllowedQty= parseFloat(_oRouteSheet.Qty);
        var nQty=0;
        if(oRows.length>0){
            for(var i=0; i<oRows.length;i++){
                nQty=parseFloat(nQty)+parseFloat(oRows[i].Weight);
            }
        }

        return (nMaxAllowedQty>nQty)? parseFloat(nMaxAllowedQty)-parseFloat(nQty):0;
    }

    function ResetRouteSheetPacking(bIsHank){

        $('#winPacking .reset-text').val("");
        $('#winPacking .reset-select').val(0);
        _oRouteSheetPacking=null;
        $("#txtNumberBags").prop('disabled',false);
        $("#txtNumberBags").val(1);

        _nUsableQty=GetUseableWeight();
        $('#txtQty').val(formatPrice(_nUsableQty));
        //$('#txtQtyTwo').val(formatPrice(GetKG(icsRemoveComma($('#txtQty').val()) ,2)));
        $('#txtQtyTwo').val(formatPrice((icsRemoveComma($('#txtQty').val())*_oRouteSheetSetup.SMUnitValue)));



        //  $('#lblHeaderHankCone-Picker').text(((bIsHank)?"No of Hanks :": "No of Cone :"));
        $('#lblHeaderHankCone-Picker').text(_oRouteSheet.DyeingType);

        if(bIsHank==2)
        {
            $('.region-cone').show();
            $("#tblRouteSheetPacking").datagrid("showColumn", "WarpStr");
            $("#tblRouteSheetPacking").datagrid("showColumn", "Length");
        }
        else
        {
            $('.region-cone').hide();
            $("#tblRouteSheetPacking").datagrid("hideColumn", "WarpStr");
            $("#tblRouteSheetPacking").datagrid("hideColumn", "Length");

        }

    }

    function Validate(bIsHank)
    {
        debugger;
        if($.trim($('#txtNumberBags').val())==""){
            $('#txtNumberBags').focus();
            $('#txtNumberBags').addClass("errorFieldBorder");
            alert('Bag no required.');
            return false;
        }
        else{
            $('#txtNumberBags').removeClass("errorFieldBorder");
        }
        if($.trim($('#txtNumberBags').val())<0){
            $('#txtNumberBags').focus();
            $('#txtNumberBags').addClass("errorFieldBorder");
            alert('Bag no must be non negative.');
            return false;
        }
        else{
            $('#txtNumberBags').removeClass("errorFieldBorder");
        }

        if($.trim($('#txtQty').val())==""){
            $('#txtQty').focus();
            $('#txtQty').addClass("errorFieldBorder");
            alert('Quantity required.');
            return false;
        }
        else{
            $('#txtQty').removeClass("errorFieldBorder");
        }

        if( parseFloat(icsRemoveComma($('#txtQty').val()))<=0){
            $('#txtQty').focus();
            $('#txtQty').addClass("errorFieldBorder");
            alert('Quantity required.');
            return false;
        }
        else{
            $('#txtQty').removeClass("errorFieldBorder");
        }
        if(_oRouteSheetPacking!=null && _oRouteSheetPacking.PackingID>0){
            var nQty= parseFloat(_oRouteSheet.Qty) + parseFloat(_oRouteSheet.Qty*_oRouteSheetSetup.GainPercentage/100) ;
            if(nQty< parseFloat(icsRemoveComma($('#txtQty').val())) ){
                $('#txtQty').focus();
                $('#txtQty').addClass("errorFieldBorder");
                alert("Maximum allowed quantity per bag "+ formatPrice(nQty) +" "+_nMUnit);
                return false;
            }
            else{
                $('#txtQty').removeClass("errorFieldBorder");
            }
        }
        else if(_oRouteSheetPacking==null){
            var nQty= parseFloat(_oRouteSheet.Qty) + parseFloat(_oRouteSheet.Qty*_oRouteSheetSetup.GainPercentage/100) ;
            if(nQty< parseFloat($('#txtNumberBags').val())*parseFloat(icsRemoveComma($('#txtQty').val())) ){
                $('#txtQty').focus();
                $('#txtQty').addClass("errorFieldBorder");
                alert("Maximum allowed quantity per bag "+ formatPrice((nQty/$('#txtNumberBags').val()).toFixed(2)) +" "+_nMUnit);
                return false;
            }
            else{
                $('#txtQty').removeClass("errorFieldBorder");
            }
        }

        if(!bIsHank && $('#cboWarpWeft').val()==0){
            $('#cboWarpWeft').focus();
            $('#cboWarpWeft').addClass("errorFieldBorder");
            alert('Select warp/ weft');
            return false;
        }
        else{
            $('#cboWarpWeft').removeClass("errorFieldBorder");
        }

        return true;
    }

    function RefreshObject(){
        var oRouteSheetPacking={
            PackingID: (_oRouteSheetPacking==null)? 0: _oRouteSheetPacking.PackingID,
            RouteSheetID: _oRouteSheet.RouteSheetID,
            Weight:parseFloat(icsRemoveComma($('#txtQty').val())),
            NoOfHankCone:parseFloat(icsRemoveComma($('#txtHanksCone').val())),
            Warp: $("#cboWarpWeft").val(),
            Length:$.trim($('#txtLength').val()),
            Note:$.trim($('#txtNote').val()),
            Params:(_oRouteSheetPacking ==null)? $("#txtNumberBags").val(): 0
        };
        return oRouteSheetPacking;
    }

    function GetRouteSheetPacking(stitle)
    {
        var oRouteSheetPacking=$('#tblRouteSheetPacking').datagrid('getSelected');
        if (oRouteSheetPacking==null || oRouteSheetPacking.PackingID<=0) { alert('Please select an item from list.'); return false;}

        var obj =
       {
           BaseAddress: _sBaseAddress,
           Object: oRouteSheetPacking,
           ControllerName: "RouteSheet",
           ActionName: "GetRouteSheetPacking",
           IsWinClose: false
       };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.PackingID > 0) {
                    _oRouteSheetPacking=response.obj;
                    $("#txtNumberBags").prop('disabled',true);
                    $("#txtNumberBags").val(_oRouteSheetPacking.BagNo);
                    $("#txtQty").val(_oRouteSheetPacking.Weight);
                    $("#txtQtyTwo").val(formatPrice(_oRouteSheetPacking.Weight*_oRouteSheetSetup.SMUnitValue));
                    $("#txtHanksCone").val(formatPrice(_oRouteSheetPacking.NoOfHankCone,2));
                    $('#cboWarpWeft').val(_oRouteSheetPacking.Warp);
                    $("#txtLength").val(_oRouteSheetPacking.length);
                    $('#txtNote').val(_oRouteSheetPacking.Note);

                    $("#winPacking").icsWindow("open", stitle);
                }
                else { alert(response.obj.ErrorMessage); }
            }
        });
    }


    $("#btnAddPacking").click(function (e) {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert(_oRouteSheetSetup.RSShortName+" required to add packing."); return false;
        }
        ResetRouteSheetPacking(_oRouteSheet.HanksCone);
        $('#lblBag').text("No of Bags :");
        $("#winPacking").icsWindow("open", "Add Packing Items");
    });

    $('#btnEditPacking').click(function (e)
    {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert( _oRouteSheetSetup.RSShortName+" required to add packing."); return false;
        }
        ResetRouteSheetPacking(_oRouteSheet.HanksCone);
        $('#lblBag').text("Bag No :");
        GetRouteSheetPacking("Edit Packing Item");
    });

    $('#btnDeletePacking').click(function (e)
    {
        var oRouteSheetPacking=$('#tblRouteSheetPacking').datagrid('getSelected');
        if (oRouteSheetPacking==null || oRouteSheetPacking.PackingID<=0) { alert('Please select an item from list.'); return false;}

        if (!confirm("Confirm to Delete?")) return ;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetPacking,
            ControllerName: "RouteSheet",
            ActionName: "DeletePacking",
            TableId: "tblRouteSheetPacking",
            IsWinClose: false
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message =='deleted') {
                PackingQtyRemarks(GetPackingQty());
                UpdateQC();
            }
        });
    });

    $("#btnSavePacking").click(function (e) {

        if (!Validate(_oRouteSheet.HanksCone)) return false;
        var oRouteSheetPacking=RefreshObject();
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetPacking,
            ObjectId: oRouteSheetPacking.PackingID,
            ControllerName: "RouteSheet",
            ActionName: (oRouteSheetPacking.PackingID>0)? "SavePacking" : "PackingMultiple",
            TableId: (oRouteSheetPacking.PackingID>0)? "tblRouteSheetPacking" : "",
            IsWinClose: true,
            Message: "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetPackings.length > 0 && response.obj.RouteSheetPackings[0].PackingID>0) {
                    for(var i=0; i<response.obj.RouteSheetPackings.length;i++){
                        $('#tblRouteSheetPacking').datagrid('appendRow',response.obj.RouteSheetPackings[i]);
                    }
                    ResetRouteSheetPacking(false);
                }
                else if(response.obj.PackingID>0){
                    ResetRouteSheetPacking(false);
                }
                PackingQtyRemarks(GetPackingQty());
                UpdateQC();
            }
        });
    });

    $("#btnClosePacking").click(function (e) {
        $("#winPacking").icsWindow("close");
    });


    /*.............QC .............. */
    $('#btnDeleteQCItem').click(function (e)
    {
        var oRSInQCDetail = $('#tblRouteSheetQC').datagrid('getSelected');
        if (oRSInQCDetail==null || oRSInQCDetail.PackingID<=0) { alert('Please select an item from list.'); return false;}

        if (!confirm("Confirm to Delete?")) return ;
        DeleteQCItem(oRSInQCDetail);
    });
    $('#btnQCDone').click(function (e)
    {
        var nTotalQty=0;
        var nLossGain=0;
        endEditing();
        if($('#tblRouteSheetPacking').datagrid('getRows').length<=0){
            alert("No packing items found. Please add packing items.");
            return false;
        }
        if(parseInt($("#cboRSShift").val())<=0)
        {
            alert("Please Select Shift First.");
            $('#cboRSShift').focus();
            $('#cboRSShift').addClass("errorFieldBorder");
            return false;
        }

        var oRSInQCDetails = $('#tblRouteSheetQC').datagrid('getRows');

        var bIsDyedYarn=false;
        for(var i=0;i<oRSInQCDetails.length;i++){
            if(oRSInQCDetails[i].RSInQCDetailID>0 && oRSInQCDetails[i].YarnType==1 && oRSInQCDetails[i].Qty>0){
                debugger;
                if(parseFloat(oRSInQCDetails[i].Qty) != parseFloat(GetPackingQty())){
                    alert("Fresh dyed yarn quantity must be equal to packing quantity." );
                    return false;
                }
                bIsDyedYarn=true;
            }
        }
        debugger;
        for(var i=0; i<oRSInQCDetails.length;i++){
            
            nTotalQty= parseFloat(nTotalQty) + parseFloat(oRSInQCDetails[i].Qty);
        }
        nLossGain=parseFloat($('#txtShortQty').val());
     
        if(parseFloat($('#txtShortQty').val()<=0))
        {
            alert("Please Entry Short Qty.");
            $('#txtShortQty').focus();
            $('#txtShortQty').addClass("errorFieldBorder");
            return false;
        }
        if(isNaN(nLossGain))
        {
            nLossGain = 0;
        }
       
        

        if(parseFloat(_oRouteSheet.Qty)<parseFloat(nTotalQty)) // Gain
        {
            nLossGain=parseFloat(_oRouteSheet.Qty)-(parseFloat(nTotalQty)-parseFloat(nLossGain));
        }
        else 
        {
            nLossGain=parseFloat(_oRouteSheet.Qty)-(parseFloat(nTotalQty)+parseFloat(nLossGain));
        }


        if(parseFloat(nLossGain.toFixed(2))<0.00)
        {
            alert("Dyeing quantity must be equal to packing quantity. Confirm Gain/Short Qty:"+ nLossGain.toFixed(2) );
            return false;
        }
        if(parseFloat(nLossGain.toFixed(2))>0.0)
        {
            alert("Dyeing quantity must be equal to packing quantity. Confirm Gain/Short Qty:"+ nLossGain.toFixed(2) );
            return false;
        }


        if(!bIsDyedYarn){
            alert("No frsh dyed yarn added.");
            return false;
        }
        if (!confirm("Confirm to QC passed. No way to back again.?")) return ;

        var oRouteSheet={
            RouteSheetID : _oRouteSheet.RouteSheetID,
            RSShiftID:parseInt($("#cboRSShift").val()),
            Note: $("#txtRemark_QC").val()
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ObjectId: oRouteSheet.RouteSheetID,
            ControllerName: "RouteSheet",
            ActionName:"QCDOne",
            TableId: "",
            IsWinClose: false,
            Message: "QC Passed successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID> 0 && response.obj.RSState==13) {
                    _oRouteSheet.RSState=response.obj.RSState;
                    $('#lblRSState').text(response.obj.RSStateStr);
                    $('.active-QC').hide();
                }
            }
        });

    });
    function DeleteQCItem(oRSInQCDetail){
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRSInQCDetail,
            ControllerName: "RouteSheet",
            ActionName: "DeleteRSInQCDetail",
            TableId: "",
            ShowMessage:false,
            IsWinClose: false
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message =='deleted') {
                var obj={
                    RSInQCDetailID : 0,
                    RouteSheetID : 0,
                    ColorGroupID : 0,
                    RSInQCSetupID : oRSInQCDetail.RSInQCSetupID,
                    Qty : 0,
                    Note : '',
                    ColorName : '',
                    QCSetupName : oRSInQCDetail.QCSetupName,
                    YarnType : oRSInQCDetail.YarnType
                };
                var nIndex = $("#tblRouteSheetQC").datagrid("getRowIndex", oRSInQCDetail);
                $('#tblRouteSheetQC').datagrid("updateRow", { index: nIndex, row: obj });
                GenerateGainLoss();
                ResetGridEdit();
                endEditing();
            }
        });
    }

    function GetInspectionQty(){

        var oRows=$('#tblRouteSheetQC').datagrid('getRows');
        var nMaxAllowedQty= parseFloat((_oRouteSheet.Qty)) + parseFloat((((_oRouteSheet.Qty)*_oRouteSheetSetup.GainPercentage)/100).toFixed(2));

        var nQty=0;
        if(oRows.length>0){
            for(var i=0; i<oRows.length;i++){
                nQty=parseFloat(nQty)+parseFloat(oRows[i].Qty);
            }
        }

        return parseFloat(nMaxAllowedQty)-parseFloat(nQty);
    }

    function GenerateGainLoss(){

        var oRSInQCDetails= $('#tblRouteSheetQC').datagrid('getRows');
        var nShort=0, nLoss=0, nGain=0;
        var nTotalQty= 0;
        var stext="";
        if(oRSInQCDetails.length>0)
        {
            for(var i=0; i<oRSInQCDetails.length;i++){
                //if(oRSInQCDetails[i].YarnType==1){
                //    nProduction= parseFloat(nProduction) + parseFloat(oRSInQCDetails[i].Qty);
                //}
                //else{
                //    nLoss= parseFloat(nLoss) + parseFloat(oRSInQCDetails[i].Qty);
                //}
                nTotalQty= parseFloat(nTotalQty) + parseFloat(oRSInQCDetails[i].Qty);
            }

            debugger;
            // nTotalQty= parseFloat(nProduction) + parseFloat(nLoss);
            nGain= parseFloat((parseFloat(nTotalQty - _oRouteSheet.Qty)*100)/parseFloat(_oRouteSheet.Qty)).toFixed(2);
            nLoss= parseFloat((parseFloat(_oRouteSheet.Qty - nTotalQty)*100)/parseFloat(_oRouteSheet.Qty)).toFixed(2);
            nShort=parseFloat(nTotalQty - _oRouteSheet.Qty).toFixed(2);
            if(nShort<0){nShort=nShort*-1;    $('#lblShortQty').html("Short Qty:"); } else {$('#lblShortQty').html("Gain Qty:");}
            stext= "<b>Weight: </b>"+ parseFloat(nTotalQty)  +" "+_nMUnit+ (((nTotalQty)>_oRouteSheet.Qty)? ("<b>  Gain Qty: "+ nShort +" Gain: </b>"+ nGain +"%") : ("<b>  Short Qty: "+ nShort +" Loss: </b>"+ nLoss +"%")) ;
            
            //$('#txtShortQty').val(nShort);
            
          
            //nProduction= parseFloat(((nProduction*100)/_oRouteSheet.Qty).toFixed(2));
            //nLoss= parseFloat(((nLoss*100)/_oRouteSheet.Qty).toFixed(2));
            //nGain= (nProduction>0)? (nProduction)-100 :0;
            //stext=(nGain>0)? ("<b>Gain: </b>"+ nGain +"%") : ("<b>Loss: </b>"+ nLoss +"%");
        }
        $('#lblQCRemarks').html(stext);
    }


    var _sNote='';
    var _nQty=0;
    var editIndex=undefined;
    var _nIndex=-1;


    function ResetGridEdit(){
        _nIndex=-1;
        _sNote='';
        _nQty=0;
        editIndex=undefined;
    }

    function endEditing() {
        debugger;
        if (editIndex == undefined) {
            return true;
        }
        if ($('#tblRouteSheetQC').datagrid('validateRow', editIndex)) {

            $('#tblRouteSheetQC').datagrid('endEdit', editIndex);
            $('#tblRouteSheetQC').datagrid('selectRow', editIndex);
            var oRSInQCDetail = $('#tblRouteSheetQC').datagrid('getSelected');
            debugger;
            var nAllowedQty=GetInspectionQty() + parseFloat(oRSInQCDetail.Qty);

            if (parseFloat(oRSInQCDetail.Qty)== _nQty && oRSInQCDetail.Note ==_sNote ) {
                editIndex = undefined;
                return true;
            }
            //if(parseFloat(oRSInQCDetail.Qty)<=0 && parseFloat(oRSInQCDetail.Qty)!= _nQty){
            //    alert("Quantity must be greater than zero." );
            //    oRSInQCDetail.Qty=_nQty;
            //    $('#tblRouteSheetQC').datagrid("updateRow", { index: editIndex, row: oRSInQCDetail });
            //    $('#tblRouteSheetQC').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
            //    return false;
            //}

            if(parseFloat(nAllowedQty)<parseFloat(oRSInQCDetail.Qty)){
                alert("Maximum allowed quantity "+ formatPrice(nAllowedQty)  +" "+_nMUnit );
                _nQty =  oRSInQCDetail.Qty;
                oRSInQCDetail.Qty=parseFloat(nAllowedQty);
                $('#tblRouteSheetQC').datagrid("updateRow", { index: editIndex, row: oRSInQCDetail });
                $('#tblRouteSheetQC').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
                return false;
            }

            else {
                oRSInQCDetail.RouteSheetID=_oRouteSheet.RouteSheetID;
                var obj = {
                    BaseAddress: _sBaseAddress,
                    Object: oRSInQCDetail,
                    ObjectId: oRSInQCDetail.RSInQCDetailID,
                    ControllerName: "RouteSheet",
                    ActionName: "SaveRSInQCDetail",
                    TableId: '',
                    IsWinClose: false,
                    Message: ""
                };

                $.icsSave(obj, function (response) {
                    if (response.status && response.obj != null && response.obj.RSInQCDetailID>0) {
                        $('#tblRouteSheetQC').datagrid("updateRow", { index: editIndex, row: response.obj });
                        editIndex = _nIndex;
                        $('#tblRouteSheetQC').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
                        _nQty =  parseFloat($('#tblRouteSheetQC').datagrid('getSelected').Qty);
                        _sNote =  $('#tblRouteSheetQC').datagrid('getSelected').Note;
                    }
                    else{
                        oRSInQCDetail.Qty=_nQty;
                        $('#tblRouteSheetQC').datagrid("updateRow", { index: editIndex, row: oRSInQCDetail });
                        $('#tblRouteSheetQC').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
                        editIndex = undefined;
                    }
                    GenerateGainLoss();
                    return;
                });
            }
        }
        else { return false; }
    }

    function onClickRow(index) {
        if (editIndex != index && _oRouteSheet.Params!='QCDone') {
            _nIndex=index;
            if (endEditing()) {
                $('#tblRouteSheetQC').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oRSInQCDetail=$('#tblRouteSheetQC').datagrid('getSelected');
                _nQty = parseFloat(oRSInQCDetail.Qty);
                _sNote = oRSInQCDetail.Note;
                editIndex = index;
            }
            else {
                $('#tblRouteSheetQC').datagrid('selectRow', editIndex);
            }
        }
    }


    /*-----------------------------------------*/

    $('.only-number').keydown(function (e) {

        if ((e.which >= 48 && e.which <= 57) || (e.which >= 96 && e.which <= 105)|| e.which==9 || e.which==38 || e.which==40 || e.which==8 || e.which==37 || e.which==39 || e.which==46) {
            return true;
        }
        else {
            return false
        }
    });

    function formatInspection(value){

        if(value<=0){
            return '<label style="color:red"> Yet Not Added </label>';
        }
        else{
            return '<label style="color:green"> Added </label>';
        }

    }

    $('#btnPrint').click(function (e)
    {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert(_oRouteSheetSetup.RSShortName+ " required to add packing."); return false;
        }
        window.open(_sBaseAddress+ "/RouteSheet/PrintRSPacking?nId="+_oRouteSheet.RouteSheetID, "_blank");
    });

    $('#btnPrintCard').click(function (e)
    {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert(_oRouteSheetSetup.RSShortName+ " required to add packing."); return false;
        }
        window.open(_sBaseAddress+ "/RouteSheet/PrintRSPackingCard?nId="+_oRouteSheet.RouteSheetID, "_blank");
    });

    $('#btnPrintLabelDynamic').click(function (e)
    {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert(_oRouteSheetSetup.RSShortName+ " required to add packing."); return false;
        }
        //RouteSheet = 172
        var oDocument = { ModuleID : 172 };

        var obj =
        {
           BaseAddress: _sBaseAddress,
           Object: oDocument,
           ControllerName: "DocPrintEngine",
           ActionName: "GetStickerDocumentsByModule",//GetsDocumentByModule
           IsWinClose: false
        };

        $.icsDataGet(obj, function (response) 
        {
            debugger;
            if (response.status && response.obj != null && response.obj.length>0) 
            {
                if (response.obj[0].DocPrintEngineID > 0) 
                {
                    if(response.obj.length==1)
                    {
                        window.open(_sBaseAddress+ "/RouteSheet/PrintDynamicLabel?nId="+_oRouteSheet.RouteSheetID+"&docId="+response.obj[0].DocPrintEngineID, "_blank");
                    }else
                    {
                        $("#cboCardType").icsLoadCombo({
                            List: response.obj,
                            OptionValue: "DocPrintEngineID",
                            DisplayText: "LetterName",
                            InitialValue:"Default"
                        });
                        $('#cboCardType').val(0);
             
                        $("#winCardPrint").icsWindow("open", "Select Type");
                    }
                }
                else { alert(response.obj[0].ErrorMessage); }
            }
            else alert("No Document Setup Found To print!");
        });

    });

    $('#btnPrintCardDynamic').click(function (e)
    {
        debugger
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            alert(_oRouteSheetSetup.RSShortName+ " required to add packing."); return false;
        }
        //RouteSheet = 172
        var oDocument = { ModuleID : 172 };
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oDocument,
            ControllerName: "DocPrintEngine",
            ActionName: "GetCardDocumentsByModule",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) 
        {
            debugger;
            if (response.status && response.obj != null && response.obj.length>0) 
            {
                if (response.obj[0].DocPrintEngineID > 0) 
                {
                    window.open(_sBaseAddress+ "/RouteSheet/PrintDynamicCard?nId="+_oRouteSheet.RouteSheetID+"&docId="+response.obj[0].DocPrintEngineID, "_blank");
                }
                else { alert(response.obj[0].ErrorMessage); }
            }
            else alert("No Document Setup Found To print!");
        });


    });
    

    $('#btnCardPrintOk').click(function (e)
    {
        if($('#cboCardType').val()==null || $('#cboCardType').val()<=0){
            alert("Please select a type & try again."); return false;
        }
        window.open(_sBaseAddress+ "/RouteSheet/PrintDynamicLabel?nId="+_oRouteSheet.RouteSheetID+"&docId="+$('#cboCardType').val(), "_blank");
    });
    $('#btnCardPrintClose').click(function (e)
    {
        $("#winCardPrint").icsWindow("close");       
    });

    /*-----------------------------------------*/

    $('#tabPackingQC').tabs({

        onSelect:function(title){

            if(title=="QC")
            {
                UpdateQC();
                endEditing();
            }
        }
    });


    function UpdateQC(){
        debugger;
        var nPackingQty= parseFloat(GetPackingQty());
        var oRSInQCDetails = $('#tblRouteSheetQC').datagrid('getRows');
        var oRSInQCDetail=null;
        var nIndex=-1;
        for(var i=0;i<oRSInQCDetails.length;i++){
            if(oRSInQCDetails[i].YarnType==1){
                nIndex=i;
                oRSInQCDetail=oRSInQCDetails[i];
                break;
            }
        }

        if(nPackingQty==0 && oRSInQCDetail!=null){
            if(oRSInQCDetail.RSInQCDetailID>0)
                DeleteQCItem(oRSInQCDetail);
        }

        else if(parseFloat(oRSInQCDetail.Qty) != parseFloat(nPackingQty)){
            oRSInQCDetail.Qty=parseFloat(nPackingQty);
            oRSInQCDetail.RouteSheetID=_oRouteSheet.RouteSheetID;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oRSInQCDetail,
                ObjectId: oRSInQCDetail.RSInQCDetailID,
                ControllerName: "RouteSheet",
                ActionName: "SaveRSInQCDetail",
                TableId: '',
                IsWinClose: false,
                Message: ""
            };

            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null && response.obj.RSInQCDetailID>0) {
                    $('#tblRouteSheetQC').datagrid("updateRow", { index: nIndex, row: response.obj });
                }
                GenerateGainLoss();
            })

        }
    }

    $('#btnAddMoreFreshDyedYarn').click(function (e)
    {

        if(_oRouteSheet.RouteSheetID<=0)
        {
            alert(_oRouteSheetSetup.RSShortName+ " required")
            return;
        }

        var oRSInQCDetail={RouteSheetID:_oRouteSheet.RouteSheetID
                           ,Qty:0
                           ,RSInQCDetailID:0
                           ,RSInQCSetupID:7
                           ,Note:''

        };

        //oRSInQCDetail.Qty=parseFloat(nPackingQty);
        //oRSInQCDetail.RouteSheetID=_oRouteSheet.RouteSheetID;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSInQCDetail,
            ObjectId: oRSInQCDetail.RSInQCDetailID,
            ControllerName: "RouteSheet",
            ActionName: "SaveRSInQCDetail",
            TableId: '',
            IsWinClose: false,
            Message: ""
        };

        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null && response.obj.RSInQCDetailID>0) {
                //$('#tblRouteSheetQC').datagrid("updateRow", { index: nIndex, row: response.obj });
                $('#tblRouteSheetQC').datagrid('appendRow',response.obj);
            }
            GenerateGainLoss();
        })


    });

    </script>
