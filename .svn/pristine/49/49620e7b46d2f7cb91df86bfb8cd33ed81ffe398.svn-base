@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "FN Recipes";
}
@model IEnumerable <ESimSol.BusinessObjects.FNRecipe>



    <div class="menu-main-collection-table" ng-app="FNRecipeModule">
        <div ng-controller="FNRecipeController" class="form-horizontal regionFNRecipe" style="height:500px;">
            <label class="ics-panel-header" style="font-size:12px; text-align:left;">Dispo No: {{FabricSalesContractDetail.ExeNo}},  PO No: {{FabricSalesContractDetail.SCNoFull}}, Weave Type: {{FabricSalesContractDetail.FabricWeaveName}}; Finish Type: {{FabricSalesContractDetail.FinishTypeName}}</label>
            <fieldset>
                <div class="row col-md-12">
                    <div class="col-md-1 text-right"><label class="control-label">Buyer:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.BuyerName" style="width:100%;" disabled="disabled" />
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">Panton No:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.PantonNo" style="width:100%;" disabled="disabled" />
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">Fabric Code:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.Code" style="width:100%;" disabled="disabled" />
                    </div>
                    
                </div>
                <div class="row col-md-12">
                    <div class="col-md-1 text-right"><label class="control-label">Constraction:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.Construction" style="width:100%;" disabled="disabled" />
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">MKT Ref No:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.FabricNo" style="width:100%;" disabled="disabled" />
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">Color:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.ColorInfo" style="width:100%;" disabled="disabled" />
                    </div>
                </div>
                <div class="row col-md-12">
                    <div class="col-md-1 text-right"><label class="control-label">Composition:</label></div>
                    <div class="col-md-3 text-left">
                        <input ng-model="FabricSalesContractDetail.ProductName" style="width:100%;" disabled="disabled" />
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">Shade:</label></div>
                    <div class="col-md-3 text-left">
                        <select style="width:100%;height:22px;" ng-model="ShadeID" ng-options="obj.id as obj.Value for obj in Shades" ng-change="GetProcessNew($event)" class="form-control"></select>@*ng-change="GetProcessFromLabByShade($event)"*@
                    </div>
                    <div class="col-md-1 text-right"><label class="control-label">LD No:</label></div>
                    <div class="col-md-3 text-left">
                        <div class="col-md-12 text-left" style="padding:0; width:100%">
                            <input type="text" ng-model="FnOrderExecute.LDNo" ng-keydown="GetLabDipDetail($event)" style="width:100%;" placeholder="Enter LD No" />
                        </div>
                        @*<div class="col-md-4 text-left" style="margin:0;padding:0; width:30%">
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" ng-click="SaveLDNo($event)" plain="true">Save</a>
                        </div>*@
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Finished Fabric info :</legend>
                <div class="row col-md-12 form-group">
                    <label class="control-label" style="margin-left:10px; margin-right:10px">Issue Date :</label>
                    <div style="width:110px; display:inline-block" class="date date-container">
                        @*<input type="text" style="width:90px;padding:0px; margin:0px; display:inline-block" ng-model="FnOrderExecute.IssueDateInString">
                        <span style="width:15px; padding:0px;margin:0px; display:inline-block" class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>*@
                        <input type="text" style="width:90px;padding:0px; margin:0px; display:inline-block" class=" form-control" ng-model="FnOrderExecute.IssueDateInString"><span style="width:15px; padding:0px;margin:0px; display:inline-block" class=" input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                    </div>
                    <label class="control-label" style="margin-left: 40px">Finish Width :</label>
                    <input ng-model="FnOrderExecute.FinishWidth" class="number" type="text" style="width:100px;margin-left:5px" />
                    <label class="control-label" style="margin-left: 10px">No Of Frame :</label>
                    <input ng-model="FnOrderExecute.NoOfFrame" type="text" style="width:100px;margin-left:10px">
                    <label class="control-label" style="margin-left:17px">Dye Type :</label>
                    <input ng-model="FnOrderExecute.DyeType" type="text" style="width:190px;margin-left:5px" />
                </div>
                <div class="row col-md-12">
                    <label class="control-label" style="margin-left:15px;">Order Qty :</label>
                    <input ng-model="FnOrderExecute.QtyOrder" type="text" class="number" style="width:50px; margin-left:10px;" disabled>
                    <label class="control-label" style="margin-left:5px;">+</label>
                    <input ng-model="FnOrderExecute.Percentage" type="text" class="number" style="width:35px; margin-left:3px" ng-keyup="GetPercent($event)" />%
                    <label class="control-label" style="margin-left:10px;">Req Qty :</label>
                    <span style="margin-left:2px;">
                        <input ng-model="FnOrderExecute.Qty" type="text" class="number" style="width:50px;">
                    </span>
                    <label style="margin-left:15px"> Width  :</label>
                    <input ng-model="FnOrderExecute.GreigeWidth" class="number" type="text" style="margin-left:5px; width:30px" />
                    <label style="margin-left:50px"> G/LM  :</label>
                    <input ng-model="FnOrderExecute.GL" type="text" style="margin-left:12px; width:100px" />
                    <label style="margin-left:20px"> Remarks :</label>
                    <input ng-model="FnOrderExecute.Note" type="text" style="margin-left:4px; width:120px" />
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" ng-click="SaveFnOrderExecute($event)" plain="true">Save</a>
                </div>
            </fieldset>
            <fieldset>
                <div class="row col-md-12">
                    <div class="col-md-2 text-left" style="width:13%; padding:0; margin:0; margin-left:2%">
                        <input ng-model="ProcessName" ng-keydown="GetProcess($event)" style="width:100%;" placeholder="Type Process Name" />
                    </div>
                    <div class="col-md-1" style="width:14%;padding:0; margin:0">
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" ng-click="PickProcess($event)">Pick Process</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" style="float:right" iconcls="icon-remove" plain="true" ng-click="DeleteProcess($event)"></a>
                    </div>


                    <div class="col-md-1 text-left" style="width:10%; padding:0; margin:0;margin-left:20px;">
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true" ng-click="CopyFromDispoPicker($event)">From Dispo</a>
                    </div>
                    <div class="col-md-1 text-left" style="width:14%; padding:0; margin:0;">                        
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true" ng-click="CopyFromLabDip($event)">From Lab Dip</a>
                    </div>


                    <div class="col-md-2 text-left" style="width:16%; padding:0; margin:0">
                        <input ng-model="DyesChemical" ng-keydown="GetDyesChemical($event)" style="width:100%;" placeholder="Type Dyes Chemical Name" />
                    </div>
                    <div class="col-md-2" style="width:20%;padding:0; padding:0; margin:0;">
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" ng-click="GetDyes($event)">Pick Dyes Chemical</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" style="float:right" iconcls="icon-remove" plain="true" ng-click="DeleteDyes($event)"></a>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <div class="row col-md-12" style="height:200px; width:100%; margin: 0 auto">
                    <div style="width:48%; float:left">
                        <div ui-grid="gridOptionsProcess" external-scopes="clickHandler" ui-grid-selection ui-grid-resize-columns class="grid-angular" style="width:100%; height:190px; margin:0; padding:0"></div>
                    </div>
                    <div style="width:48%; float:right">
                        <div ui-grid="gridOptionsDyes" ui-grid-selection ui-grid-resize-columns ui-grid-edit class="grid-angular" style="width:100%; height:190px;"></div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Action</legend>
                <div class="row col-md-12 text-right">
                    <div class="col-md-8 text-left" style="width:80%">
                        <button type="button" class="btn btn-info" aria-label="Left Align" ng-click="Print()"> <span class="glyphicon glyphicon-print" aria-hidden="true"> Recipe Preview</span> </button>
                        <button type="button" class="btn btn-success" aria-label="Left Align" ng-click="PrintRouteCart()"> <span class="glyphicon glyphicon-print" aria-hidden="true"> Route Card</span> </button>
                     </div>
                    <div class="col-md-2 text-left" style="width:10%">
                    </div>
                    <div class="col-md-2 text-left" style="width:10%">
                        <button type="button" class="btn btn-danger" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
                    </div>
                </div>
            </fieldset>
        </div>
        <script type="text/ng-template" id="FNRecipe.html">
            <div class="modal-header">
                <h4 class="modal-title" id="modal-title">Add Parameter</h4>
            </div>
            <div class="modal-body form-horizontal regionExportUP ms-custom-control" id="modal-body">
                <div class="row">
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">Padder Pressure :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.PadderPressure" style="width:100%" />
                        </div>
                    </div>
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">Temperature :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.Temp" style="width:100%" />
                        </div>
                    </div>
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">Speed :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.Speed" style="width:100%" />
                        </div>
                    </div>
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">PH :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.PH" style="width:100%" />
                        </div>
                    </div>
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">Flem :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.Flem" style="width:100%" />
                        </div>
                    </div>
                    <div class="row col-md-12">
                        <div class="col-md-5 text-right">
                            <label class="control-label">Caustic Strength :</label>
                        </div>
                        <div class="col-md-7 text-left">
                            <input class="form-control" ng-model="FNRecipe.CausticStrength" style="width:100%" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary btn-sm" aria-label="Left Align" ng-click="SaveProcessParameter()" ng-hide="hide"> <span class="glyphicon glyphicon-save" aria-hidden="true"></span> Save</button>
                <button type="button" class="btn-danger btn-sm" aria-label="Left Align" ng-click="cancel()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel</button>
            </div>
        </script>
    </div>

    <style type="text/css">
        .Page-Button {
        }

        .form-control {
            height: 26px;
            padding: 0px 6px;
            font-size: 12px;
        }

        .grid {
            height: 500px;
            width: 95%;
        }

        .custom-pagination {
            margin-top: -15px;
            margin-bottom: -15px;
        }

        .spacing {
            padding-bottom: 5px;
        }

        .col-md-1 {
            width: 13%;
        }

        .col-md-2 {
            width: 16%;
        }

        .col-md-3 {
            width: 20%;
        }

        .col-md-4 {
            width: 32%;
        }

        .col-md-5 {
            width: 40%;
        }

        .col-md-6 {
            width: 48%;
        }

        .col-md-7 {
            width: 53%;
        }

        .col-md-8 {
            width: 60%;
        }

        .col-md-12 {
            width: 98%;
        }

        .bg1 {
            background: green;
            font-size: 15px;
            font-weight: bold;
        }

            .bg1 .panel-title {
                font-size: 15px;
                font-weight: bold;
                color: #fff;
            }
    </style>

    <script type="text/javascript">

    var oFNRecipes =[];
    var _oFabricSalesContractDetail = [];
    var _oFNTreatmentProcessList = [];
    var _oDyesChemicals = [];
    var _oFnOrderExecute  = [];
    var _nBUID=0;
    var FNTPID = 0;
    var sPantonNo = "";
    var sColorInfo = "";
    var nShadeApprove = 0;
    var _oShades = [];
    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    oFNRecipes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
   _oFnOrderExecute  =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FnOrderExecute));
   _oShades =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Shades));
    
    _nBUID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
    _oFabricSalesContractDetail =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricSalesContractDetail));
        _oFNTreatmentProcessList =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNTreatmentProcessList));

    var FSCDID = _oFabricSalesContractDetail.FabricSalesContractDetailID;
        //var nFNLabdipDetailID = _oFabricSalesContractDetail.FNLabdipDetailID;
    var nFNLabdipDetailID = _oFnOrderExecute.FNLabdipDetailID;
    debugger;
    var  FNRecipeModule = angular.module('FNRecipeModule', ['ngAnimate', 'ui.bootstrap', 'ui.grid', 'ui.grid.selection', 'ui.grid.edit','ms.service','ui.grid.resizeColumns']);
    FNRecipeModule.controller('FNRecipeController', function ($scope, $http, $uibModal, $log, uiGridConstants, msModal, userSession) {
        debugger;

        $scope.Shades = _oShades;
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });
        $scope.ShadeID = _oFnOrderExecute.ShadeID;
        //oFNRecipes= (userSession.getData('FNRecipes').length>0)? userSession.getData('FNRecipes'):oFNRecipes;
        $scope.FabricSalesContractDetail = _oFabricSalesContractDetail;
        $scope.FnOrderExecute  = _oFnOrderExecute ;

        $scope.PickProcess = function (e) {
            debugger;
            var ProcessName = $.trim($scope.ProcessName);
            if (ProcessName == "" || ProcessName == null) {
                ProcessName = "";
            }
            $scope.LoadProcess(ProcessName);
        };
        $scope.GetProcess = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ProcessName = $.trim($scope.ProcessName);
                if (ProcessName == "" || ProcessName == null) {
                    ProcessName = "";
                }
                $scope.LoadProcess(ProcessName);
            } else if (code == 8) //backspace=8
            {
                $scope.ProcessName = '';
            }
        };
        //$scope.ChangeValue = function(e)
        //{
        //    FabricExecutionOrderSpecification.QtyOrder
        //    FabricExecutionOrderSpecification.GriegeDemandFSPercentage
        //    FabricExecutionOrderSpecification.GreigeDemand


        //    $scope.FabricExecutionOrderSpecification.GreigeDemand = $scope.FabricExecutionOrderSpecification.QtyOrder + $scope.FabricExecutionOrderSpecification.GriegeDemandFSPercentage * $scope.FabricExecutionOrderSpecification.QtyOrder/100;
        //    $scope.FabricExecutionOrderSpecification.GriegeDemandFSPercentage = $scope.FabricExecutionOrderSpecification.GreigeDemand - $scope.FabricExecutionOrderSpecification.QtyOrder / $scope.FabricExecutionOrderSpecification.QtyOrder * 100;



        //}
        $scope.LoadProcess = function (ProcessName) {
            debugger;
            var oFNTreatmentProcess = {
                FNProcess: ProcessName,
                ErrorMessage: FSCDID
            };
            if($scope.ShadeID<=0 || $scope.ShadeID == undefined)
            {
                alert("Please Select Any Shade");
                return;
            }
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNTreatmentProcess/GetsFNTreatmentProcessForFNRecipeLab', $.param(oFNTreatmentProcess), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    oColumn = { field: 'FNTreatmentSt', name: 'FNTreatment', width: '35%', enableSorting: false }; oColumns.push(oColumn);
                                    var oColumn = { field: 'Code', name: 'Code', width: '20%' }; oColumns.push(oColumn);
                                    oColumn = { field: 'FNProcess', name: 'Process Name', width: '35%', enableSorting: false }; oColumns.push(oColumn);
                                    var results = JSON.parse(response.data);
                                    var modalObj = {
                                        size: 'lg',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'FNRecipeController',
                                        objs: results,
                                        multiSelect: true,
                                        pickertitle: 'Process List',
                                        searchingbyfieldName: 'FNProcess',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        var nCount = result.length;
                                        for(var i = 0; i<nCount; i++)
                                        {
                                            //$scope.gridOptionsProcess.data.push(result[i]);
                                            $scope.SaveProcess(result[i]);
                                        }
                                        $scope.ProcessName = '';
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        };
        $scope.SaveProcess = function(oProcess)
        {
            var oFNRecipe = {
                FNRecipeID : 0,
                FSCDID : FSCDID,
                FNTPID : oProcess.FNTPID,
                //ShadeID : _oFabricSalesContractDetail.ShadeID,
                ShadeID : $scope.ShadeID,
                IsProcess : true,
            }
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/Saveprocess',oFNRecipe).then(
                  function (response)
                  {
                      var oFNRecipe = JSON.parse(response.data)
                      if (oFNRecipe.ErrorMessage=="" || oFNRecipe.ErrorMessage==null)
                      {
                          $scope.gridOptionsProcess.data.push(oFNRecipe);

                          //var win = $.messager.show({
                          //    title:'Notification',
                          //    msg:'Process Successfully Added',
                          //    timeout:2000,
                          //    showType:'slide'
                          //});
                          //win.window('window').addClass('bg1');
                      }
                      else
                      {
                          alert(oFNRecipe.ErrorMessage);
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );

        }
        $scope.CopyFromLabDip = function(e)
        {
            debugger;
            //if($scope.FnOrderExecute.ShadeID != $scope.ShadeID)
            //{
            //    alert("Please Save Shade And LD No First!!");
            //    return;
            //}
            if(nFNLabdipDetailID==0)
            {
                alert("Please Select Lab Dip No!!");
                return;
            }
            
            var oFNRecipe = {
                ShadeID : $scope.ShadeID,
                ErrorMessage : nFNLabdipDetailID + '~' + FSCDID + '~' + 0 + '~' + true
            }
            //var nShadeID = _oFabricSalesContractDetail.ShadeID;
            
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/CopyOrder',oFNRecipe).then(
                  function (response)
                  {debugger;
                      var results = JSON.parse(response.data);
                      if(results.length>0)
                      {
                          alert("Copied From LabDip Successfully!!");
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsProcess.data = results;
                          $scope.gridOptionsDyes.data = [];
                      }
                      else
                      {
                          alert("No Item Copied!!");
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsDyes.data = [];
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        }
        
        $scope.GetProcessNew = function (e)
        {
            debugger;
            if($scope.ShadeID<=0 || $scope.ShadeID == undefined)
            {
                alert("Please Select Any Shade");
                return;
            }
            var oFNRecipe = {
                ShadeID : $scope.ShadeID,
                FSCDID : $scope.FabricSalesContractDetail.FabricSalesContractDetailID
            };
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/GetsProcessByShade',oFNRecipe).then(

                  function (response)
                  {
                      debugger;
                      var results = JSON.parse(response.data)
                      if(results.length>0)
                      {
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsProcess.data = results;
                          $scope.gridOptionsDyes.data = [];
                      }
                      else
                      {
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsDyes.data = [];
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        };
        $scope.GetProcessNew();

        $scope.CopyFromDispoPicker = function () {
            debugger;
            if($scope.ShadeID<=0 || $scope.ShadeID == undefined)
            {
                alert("Please Select Any Shade");
                return;
            }

            var oObj = {
                //FNProcess: ProcessName,
                FSCDID: FSCDID
            };
            
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNRecipe/GetsDispo', $.param(oObj), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    oColumn = { field: 'ExeNoFull', name: 'Dispo No', width: '35%', enableSorting: false }; oColumns.push(oColumn);
                                    var oColumn = { field: 'Qty', name: 'Qty', width: '20%' }; oColumns.push(oColumn);
                                    //oColumn = { field: 'FNProcess', name: 'Process Name', width: '35%', enableSorting: false }; oColumns.push(oColumn);
                                    //var results = JSON.parse(response.data);
                                    var results = response.data;
                                    var modalObj = {
                                        size: 'md',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'DispoController',
                                        objs: results,
                                        multiSelect: false,
                                        pickertitle: 'Dispo List',
                                        searchingbyfieldName: 'ExeNoFull',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        //alert(result.ExeNoFull);
                                        $scope.CopyFromDispo(result);
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        };

        $scope.CopyFromDispo = function(result)
        {
            debugger;
            //if($scope.FnOrderExecute.ShadeID != $scope.ShadeID)
            //{
            //    alert("Please Save Shade And LD No First!!");
            //    return;
            //}
            //if(nFNLabdipDetailID==0)
            //{
            //    alert("Please Select Lab Dip No!!");
            //    return;
            //}
            
            var oFNRecipe = {
                ShadeID : $scope.ShadeID,
                ErrorMessage : nFNLabdipDetailID + '~' + FSCDID + '~' + result.FabricSalesContractDetailID + '~' + false
            }
            //var nShadeID = _oFabricSalesContractDetail.ShadeID;
            debugger;
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/CopyOrder',oFNRecipe).then(
                  function (response)
                  {
                      var results = JSON.parse(response.data);
                      alert("Copied From Dispo Successfully!!");
                      if(results.length>0)
                      {
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsProcess.data = results;
                          $scope.gridOptionsDyes.data = [];
                      }
                      else
                      {
                          $scope.gridOptionsProcess.data = [];
                          $scope.gridOptionsDyes.data = [];
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        }

        $scope.gridOptionsProcess= {
            multiSelect: false,
            enableFullRowSelection: true,

            columnDefs: [
              { field: 'FNTreatmentSt', name:'FNTreatment', width:'25%' },
              { field: 'Code', name:'Code', width:'12%' },
              { field: 'FNProcess', name:'Process Name', width:'35%' },
              {name:'Action',cellTemplate: '<div><button style="width:100%" ng-click="grid.appScope.AddParameter(row.entity)">Add</button></div>'},
              { field: 'IsHaveParameter', name:'', width:'8%' },
            ],
            data: _oFNTreatmentProcessList,
            onRegisterApi : function(gridApi)
            {
                $scope.gridApiProcess = gridApi;
                $scope.gridApiProcess.selection.clearSelectedRows();
                $scope.gridApiProcess.core.refresh();
                $scope.gridApiProcess.selection.on.rowSelectionChanged($scope, function (row) {$scope.RowSelect(row.entity );
                });
            }
        };
        $scope.RowSelect =  function (entity){
            debugger;
            FNTPID = entity.FNTPID;
            $scope.LoadDyesChemical(entity);
        }
        $scope.LoadDyesChemical=function(entity)
        {
            debugger;
            if(entity.FNTPID<1) return;

            var oFNRecipe = {
                FSCDID : FSCDID,
                ShadeID : $scope.ShadeID,// _oFabricSalesContractDetail.ShadeID,
                FNTPID : FNTPID
            };
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/GetsFNRecipeByTreatmentProcessAndFSCDID',oFNRecipe).then(

                  function (response)
                  {
                      debugger;
                      var results = JSON.parse(response.data)
                      if(results.length>0)
                      {
                          $scope.gridOptionsDyes.data = [];
                          $scope.gridOptionsDyes.data = results;

                      }
                      else
                      {
                          $scope.gridOptionsDyes.data = [];
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        }
        $scope.gridOptionsDyes= {
            multiSelect: false,
            enableFullRowSelection: true,
            enableCellEdit:false,
            columnDefs: [
              { field: 'ProductName', name:'Name', width:'32%' },
              { field: 'GL', name:'G/L', width:'20%',cellClass: 'number',cellFilter:'number:2', enableCellEdit:true},
              { field: 'BathSize', name:'BathSize', width:'20%',cellClass: 'number',cellFilter:'number:2', enableCellEdit:true},
              { field: 'Qty', name:'Qty (KG)',cellClass: 'number', width:'18%', },
            ],
            data: _oDyesChemicals,
            onRegisterApi : function(gridApi)
            {
                $scope.gridApi = gridApi;
                gridApi.edit.on.afterCellEdit($scope,
                     function (rowEntity, colDef, newValue, oldValue)
                     {
                         if(rowEntity.GL>0 && rowEntity.BathSize>0 )
                         {
                             rowEntity.Qty = rowEntity.GL * rowEntity.BathSize/1000;
                             //$scope.Save();
                         }
                         $scope.SaveDyesList();
                         return rowEntity;
                     });
            }
        };
        $scope.GetDyes = function (e) {
            debugger;
            var DyesChemical = $.trim($scope.DyesChemical);
            if (DyesChemical == "" || DyesChemical == null) {
                alert("Type Any Dyes Chemical Name and Press Enter");
                return;
            }
            if(FNTPID<1)
            {
                alert("Please Select Any Treatment Process");
                return;
            }
            $scope.PickDyesChemical(DyesChemical);
        };
        $scope.GetDyesChemical = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var DyesChemical = $.trim($scope.DyesChemical);
                if (DyesChemical == "" || DyesChemical == null) {
                    alert("Type Any Dyes Chemical Name and Press Enter");
                    return;
                }
                if(FNTPID<1)
                {
                    alert("Please Select Any Treatment Process");
                    return;
                }
                $scope.PickDyesChemical(DyesChemical);
            } else if (code == 8) //backspace=8
            {
                $scope.DyesChemical = '';
            }
        };
        $scope.PickDyesChemical = function (DyesChemical) {
            debugger;
            var oProduct = {
                ProductName: DyesChemical,
                BUID:_nBUID
            };
            if($scope.ShadeID<=0 || $scope.ShadeID == undefined)
            {
                alert("Please Select Any Shade");
                return;
            }
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNLabDipDetail/GetProducts', $.param(oProduct), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    oColumn = { field: 'ProductCode', name: 'Code', width: '30%' }; oColumns.push(oColumn);
                                    var oColumn = { field: 'ProductName', name: 'Product Name', width: '60%' }; oColumns.push(oColumn);
                                    var results = response.data;
                                    var modalObj = {
                                        size: 'md',
                                        //url: sessionStorage.getItem('BaseAddress') + '/Home/Modal',
                                        modalcontroller: 'ModalPp',
                                        appcontroller: 'FNRecipeController',
                                        objs: results,
                                        multiSelect: true,
                                        pickertitle: 'Process List',
                                        searchingbyfieldName: 'ProductName',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        var oList = [];
                                        var data = $scope.gridOptionsDyes.data;
                                        for(var i=0;i<result.length;i++){
                                            var isExist=false;
                                            for(var j=0;j<data.length;j++){
                                                if(data[j].ProductID == result[i].ProductID){
                                                    isExist=true;
                                                    break;
                                                }
                                            }
                                            if(!isExist){
                                                var oFNRecipe = {
                                                    FNRecipeID : 0,
                                                    FSCDID : FSCDID,
                                                    FNTPID : FNTPID,
                                                    ProductTypeInInt : result[i].ProductTypeInInt,
                                                    ProductID : result[i].ProductID,
                                                    ProductName : result[i].ProductName,
                                                    ShadeID : $scope.ShadeID,
                                                    GL : 0.0,
                                                    QtyColor : 0.0,
                                                    Qty : 0.0,
                                                    BathSize : 0.00,
                                                    Note : "",
                                                    ErrorMessage : ""
                                                }
                                                oList.push(oFNRecipe);
                                                $scope.gridOptionsDyes.data.push(oFNRecipe);
                                            }
                                        }
                                        debugger;                                        
                                        $scope.DyesChemical = '';
                                        //$scope.Save(oFNRecipe);
                                        //$scope.gridOptionsDyes.data.push(oFNRecipe);
                                        $scope.SaveDyesList();
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        };
        $scope.Save = function (oFNRecipe)
        {
            var data = oFNRecipe;
            debugger;
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/SaveProcess',data).then(
                  function (response)
                  {
                      debugger;
                      var oFNRecipe = JSON.parse(response.data)
                      if (oFNRecipe.ErrorMessage=="" || oFNRecipe.ErrorMessage==null)
                      {
                          $scope.gridOptionsDyes.data.push(oFNRecipe);
                      }
                      else
                      {
                          alert(oFNRecipe.ErrorMessage);
                      }
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        }
        $scope.SaveDyesList = function (e)
        {
            var data=JSON.stringify($scope.gridOptionsDyes.data);
            debugger;
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/Save',data).then(
                  function (response)
                  {
                      debugger;
                      var oFNRecipes = JSON.parse(response.data)
                      if(oFNRecipes.length > 0){
                          if (oFNRecipes[0].ErrorMessage=="" || oFNRecipes[0].ErrorMessage==null)
                          {
                              $scope.gridOptionsDyes.data = oFNRecipes;
                          }
                          else
                          {
                              alert(oFNRecipes[0].ErrorMessage);
                          }
                      }else{
                          alert("No Data Found!!");
                      }
                      
                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );
        }
        $scope.Close = function(e)
        {
            window.close();
        }

        $scope.Print = function()
        {
            debugger;
            var oFDCRegister = {
                Params:$scope.sParam,
            }
            window.open(_sBaseAddress+'/FNRecipe/Print?nFSCDID='+FSCDID+"&nBUID="+_nBUID+"&nShadeID="+$scope.ShadeID);
        }
        $scope.PrintRouteCart = function()
        {
            debugger;
            if($scope.ShadeID<=0 || $scope.ShadeID == undefined)
            {
                alert("Please Select Any Shade");
                return;
            }
            //window.open(_sBaseAddress+"/FNExecutionOrder/PrintProcessPDF?id="+FSCDID+"&FNBatchID=0");
            window.open(_sBaseAddress+"/FNExecutionOrder/PrintProcessPDFForShadeWise?id="+FSCDID+"&nShadeID="+$scope.ShadeID+"&nFSCDID=0");
        }
        $scope.AddParameter = function (oFNRecipe) {
            debugger;
            //var oFNRecipe = $scope.gridApiProcess.selection.getSelectedRows()[0];
            if(oFNRecipe==null || oFNRecipe.FNRecipeID<=0)
            {
                alert("Please Select an Process from list");
                return;
            }
            var nIndex = $scope.gridOptionsProcess.data.indexOf(oFNRecipe);
            var oData = $scope.gridApiProcess.selection.getSelectedRows()[0];
            var SelectedRowIndex= $scope.gridOptionsProcess.data.indexOf(oData);
            var modalInstance = $uibModal.open({
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                size: 'md',
                templateUrl: 'FNRecipe.html',
                controller: 'FNRecipeCtrl',
                controllerAs: 'FNRecipeController',
                resolve: {
                    obj: function () {
                        return { value:oFNRecipe, Operation: 'Edit'  };
                    }
                }
            });

            modalInstance.result.then(function (result) {
                debugger;
                $scope.gridOptionsProcess.data[nIndex]=result;

            }, function () {
                $log.info('Modal dismissed at: ' + new Date());
            });
        };
        //*****************LDNo Picker****************************************************************************
        $scope.GetLabDipDetail = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var LabDipNo = $.trim($scope.FnOrderExecute.LDNo);
                if (LabDipNo == "" || LabDipNo == null) {
                    alert("Type Any Lab Dip No and Press Enter");
                    return;
                }
                $scope.PickLabDipDetail(LabDipNo);
            } else if (code == 8) //backspace=8
            {
                $scope.ProcessName = '';
            }
        };
        $scope.GetPercent = function(e)
        {
            debugger; 
            $scope.FnOrderExecute.Qty = $scope.FnOrderExecute.QtyOrder + $scope.FnOrderExecute.QtyOrder * $scope.FnOrderExecute.Percentage / 100;
        }
        $scope.DeleteDyes = function (e) {
            debugger;
            var oFNRecipe = $scope.gridApi.selection.getSelectedRows()[0];
            var SelectedRowIndex= $scope.gridOptionsDyes.data.indexOf(oFNRecipe);
            if(oFNRecipe==null || oFNRecipe.FNRecipeID<=0)
            {
                alert("Please Select Any Dyes Chemical from list");
                return;
            }
            if (!confirm("Confirm to Delete?")) return false;
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/DeleteDyes',oFNRecipe).then(
                  function (response)
                  {
                      debugger;
                      var oFNRecipe = JSON.parse(response.data)
                      if (oFNRecipe.ErrorMessage=="Deleted")
                      {
                          alert("Data Deleted");
                          $scope.gridOptionsDyes.data.splice(SelectedRowIndex,1);
                          $scope.gridApi.core.refresh();
                      }
                      else
                      {
                          alert(oFNRecipe.ErrorMessage);
                      }

                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );

        };
        $scope.DeleteProcess = function (e) {
            debugger;
            var oFNRecipe = $scope.gridApiProcess.selection.getSelectedRows()[0];
            var SelectedRowIndex= $scope.gridOptionsProcess.data.indexOf(oFNRecipe);
            if(oFNRecipe==null || oFNRecipe.FNRecipeLabID<=0)
            {
                alert("Please Select Any Process from list");
                return;
            }
            if (!confirm("Confirm to Delete?")) return false;
            $http.post(sessionStorage.getItem('BaseAddress')+'/FNRecipe/DeleteProcess',oFNRecipe).then(
                  function (response)
                  {
                      debugger;
                      var oFNRecipe = JSON.parse(response.data);
                      if (oFNRecipe.ErrorMessage=="Deleted")
                      {
                          alert("Successfully Deleted");
                          $scope.gridOptionsProcess.data.splice(SelectedRowIndex,1);
                          $scope.gridApiProcess.core.refresh();
                      }
                      else
                      {
                          alert(oFNRecipe.ErrorMessage);
                      }

                  },
                      function (response) { alert(jQuery.parseJSON(response.data).Message);}
              );

        };
        $scope.PickLabDipDetail = function (LabDipNo) {
            debugger;
            var oFNLabDipDetail = {
                LabdipNo: LabDipNo
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNLabDipDetail/GetByLDNoOrDispoNo', $.param(oFNLabDipDetail), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    oColumn = { field: 'LabdipNo', name: 'Labdip No', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'PantonNo', name: 'Panton No', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'ColorName', name: 'Color Name', width: '30%', enableSorting: false }; oColumns.push(oColumn);

                                    var results = JSON.parse(response.data);
                                    var modalObj = {
                                        size: 'md',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'FNRecipeController',
                                        objs: results,
                                        multiSelect: false,
                                        pickertitle: 'LD No List',
                                        searchingbyfieldName: 'LabdipNo',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        $scope.FnOrderExecute.LDNo = result.LabdipNo;
                                        nFNLabdipDetailID = result.FNLabDipDetailID;
                                        sPantonNo = result.PantonNo;
                                        sColorInfo = result.ColorName;
                                        nShadeApprove = result.ShadeID_Ap;
                                        //$('#LabDipNo').val(result.LabdipNo);
                                        //$scope.SaveLDNo(result.FNLabDipDetailID);
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        };
        

        $scope.SaveLDNo = function(e)
        {
            debugger;

            var oFabricSalesContractDetail = {
                FabricSalesContractDetailID : FSCDID,
                ShadeID : $scope.ShadeID,
                FNLabdipDetailID : nFNLabdipDetailID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNLabDipDetail/SaveLDNo', $.param(oFabricSalesContractDetail), config).then(
                                function (response) {
                                    debugger;
                                    var obj = JSON.parse(response.data);
                                    if(obj.FNLabdipDetailID>0 || obj.ErrorMessage=="")
                                    {
                                        location.reload();
                                        alert("LD No Updated");
                                        //$scope.FabricSalesContractDetail.PantonNo = sPantonNo;
                                        //$scope.FabricSalesContractDetail.ColorInfo = sColorInfo;
                                    }
                                    else
                                    {
                                        alert(obj.ErrorMessage);
                                    }
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        }
        $scope.SaveFnOrderExecute = function(e)
        {
            debugger;            
            $scope.FnOrderExecute.IssueDate = new Date($scope.FnOrderExecute.IssueDateInString).getFullYear() + "/" + (new Date($scope.FnOrderExecute.IssueDateInString).getMonth() + 1) + "/" + new Date($scope.FnOrderExecute.IssueDateInString).getDate();
            $scope.FnOrderExecute.ShadeID = $scope.ShadeID;
            $scope.FnOrderExecute.FNLabdipDetailID = nFNLabdipDetailID;
            
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress + '/FNRecipe/SaveFnOrderExecute', $.param($scope.FnOrderExecute), config).then(
                                function (response) 
                                {
                                    var obj = JSON.parse(response.data);
                                    if(obj.ErrorMessage=="" || obj.ErrorMessage==null)
                                    {
                                        alert("Data save sussfully");
                                        $scope.ShadeID = obj.ShadeID;
                                        nFNLabdipDetailID = obj.FNLabdipDetailID;
                                    }
                                    else
                                    {
                                        alert(obj.ErrorMessage);
                                    }
                                },
                                  function (response) { alert(response.statusText); }
                            );
        }
        //*****************DIspo No*******************************************************************************
        $scope.GetDispoNo = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var DispoNo = $.trim($scope.FabricSalesContractDetail.DispoNo);
                if (DispoNo == "" || DispoNo == null) {
                    alert("Type Any Dispo No and Press Enter");
                    return;
                }
                $scope.PickDispoDetail(DispoNo);
            } else if (code == 8) //backspace=8
            {
                $scope.ProcessName = '';
            }
        };
        $scope.PickDispoDetail = function (DispoNo) {
            debugger;
            var oFNLabDipDetail = {
                DispoNo: DispoNo
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNLabDipDetail/GetByLDNoOrDispoNo', $.param(oFNLabDipDetail), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    oColumn = { field: 'DispoNo', name: 'Labdip No', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'PantonNo', name: 'Panton No', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    //oColumn = { field: 'ColorNo', name: 'Color No', width: '20%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'ColorName', name: 'Color Name', width: '30%', enableSorting: false }; oColumns.push(oColumn);


                                    var results = JSON.parse(response.data);
                                    var modalObj = {
                                        size: 'md',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'FNRecipeController',
                                        objs: results,
                                        multiSelect: false,
                                        pickertitle: 'LD No List',
                                        searchingbyfieldName: 'DispoNo',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        //$scope.FnOrderExecute.LDNo = result.DispoNo;
                                        nFNLabdipDetailID = result.FNLabDipDetailID;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        };
        $scope.SaveDispoNo = function(e)
        {
            debugger;

            var oFabricSalesContractDetail = {
                FabricSalesContractDetailID : FSCDID,
                FNLabdipDetailID : nFNLabdipDetailID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/FNLabDipDetail/SaveLDNo', $.param(oFabricSalesContractDetail), config).then(
                                function (response) {
                                    debugger;
                                    var obj = JSON.parse(response.data);
                                    if(obj.FNLabdipDetailID>0 || obj.ErrorMessage=="")
                                    {
                                        alert("LD No Updated");
                                    }
                                    else
                                    {
                                        alert(obj.ErrorMessage);
                                    }
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message); }
                            );
        }
    });

    FNRecipeModule.controller('FNRecipeCtrl', function ($scope, $http, $uibModalInstance, uiGridConstants, msModal, obj) {
        debugger;
        $scope.FNRecipe = obj.value;

        $scope.SaveProcessParameter = function ()
        {
            $http.post(_sBaseAddress+'/FNRecipe/Saveprocess',JSON.stringify($scope.FNRecipe)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    if(result.FNRecipeID>0)
                    {
                        debugger;
                        msModal.Message({headerTitle : '', bodyText:'Process Successful.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                        $scope.FNRecipe=result; $uibModalInstance.close($scope.FNRecipe);
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert((response.statusText));}
            );
        };


        $scope.cancel= function () {
            $uibModalInstance.close($scope.FNRecipe);
        };

    });
    FNRecipeModule.filter('formatNumber', function() {
        return function(input, decimalPlaces) {
            if(isNaN(input))
                return 0;
            else {
                return input.toFixed(decimalPlaces);
            }
        };
    });
    </script>



