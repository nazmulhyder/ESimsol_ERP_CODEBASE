@model IEnumerable<ESimSol.BusinessObjects.FNLabDipDetail>
    @{
        ViewBag.Title = " LabDip";
    }
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>

    <div class="menuMainCollectionTable">
        <fieldset>
            <legend>Fabric Info</legend>
            <div class="align-right">
                <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                    <tr>
                        <td style="width:10%;text-align:right">
                            Fabric ID:
                        </td>

                        <td style="width:20%">
                            <input type="text" id="txtFabricNo" style="width:100%" disabled="disabled" />
                        </td>
                        <td style="width:15%;text-align:right">
                            Buyer Name:
                        </td>
                        <td style="width:20%">
                            <input type="text" id="txtBuyerName" style="width:100%" disabled="disabled" />
                        </td>
                        <td style="width:15%;text-align:right">
                           Style/Buyer Ref:
                        </td>
                        <td style="width:20%">
                            <input type="text" id="txtStyleNo" style="width:100%" disabled="disabled" />
                        </td>

                    </tr>

                    <tr>
                        <td style="width:10%;text-align:right">
                            Composition:
                        </td>

                        <td style="width:20%">
                            <input type="text" id="txtComposition" style="width:100%" disabled="disabled" />
                        </td>
                        <td style="width:15%;text-align:right">
                            Construction:
                        </td>
                        <td style="width:20%">
                            <input type="text" id="txtConstruction" style="width:100%" disabled="disabled" />
                        </td>
                        <td style="width:15%;text-align:right">
                            Process Type :
                        </td>
                        <td style="width:20%">
                            <input type="text" id="txtProcessTypeName" style="width:100%" disabled="disabled" />
                        </td>
                    </tr>

                </table>

            </div>

        </fieldset>
        <table id="tblFNLabDipDetails" title="LabDip List" class="easyui-datagrid" style="width: 100%; height:70%; margin: 0;" data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarFNLabDipDetail' ">

            <thead>
                <tr>
                    @*<th field="IssueDateSt" width="10%" align="left">IssueDate</th>*@
                    @*<th field="Construction" width="10%" align="left">Construction</th>
                    <th field="ProductName" width="15%" align="left">Composition </th>*@
                    <th field="LabdipNo" width="15%" align="left">LabdipNo</th>
                    <th field="ColorName" width="20%" align="left">ColorName</th>
                    <th field="PantonNo" width="20%" align="left">PantonNo</th>
                    <th field="Status" width="10%" align="left">Status</th>
                    <th field="ShadeStr" width="6%" align="left">Shade(Approve)</th>
                    <th field="LightSourceDesc" width="10%" align="left">Light SourCe</th>



                </tr>
            </thead>
        </table>

        <div id="toolbarFNLabDipDetail">
            @*<input id="txtSearchByLDNo" type="text" placeholder="Search by LD No" style="width:120px" />
            <input id="txtSearchByFabricNo" type="text" placeholder="Search by Fabric No" style="width:120px" />
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>*@
            <a id="btnReceived" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Receive</a>
            @*<a id="btnMultipleColor" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Multiple Color</a>*@
            <a id="btnSahdeReceipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Receipe</a>
            <a id="btnViewSahdeReceipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">Receipe</a>
            <a id="btnPrintRecipe" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Preview(Recipe)</a>
            <a id="btnPrintSubmission" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Preview(Submission)</a>
            @*<a id="btnPrintToExcel" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-excel" plain="true">Excel</a>*@
            <a id="btnLDNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Change Color No</a>
            <a id="btnSubmited" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Submit</a>
            <a id="btnAssignShade" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Assign Shade</a>
        </div>
        <fieldset>
            <legend>Action</legend>
            <div>
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                        <td style=" float:left;  width:10%; ">
                        </td>
                        <td style=" float:left;  width:80%; ">
                        </td>
                        <td style="width:10%;float:right; text-align:right">
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>

                </table>

            </div>

        </fieldset>
    </div>
    
    <div id="WinShadeRecipe" class="easyui-window" title="Sahde & Recipe" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div id="divWinShadeRecipe" tabindex="-1">
            <fieldset>
                <legend style="font-weight:bold"> Color info: </legend>
                <table cellpadding="2" cellspacing="2" style="width:100%">
                    <tr>
                        <td style="width:5% " align="right">
                            <label>Yarn Type</label>
                        </td>
                        <td style="width:35%; text-align: left" align="left">
                            <input id="txtYarn_LDD" style="width:90%" disabled />
                        </td>
                        <td style="width:6%" align="right">
                            <label>Color</label>
                        </td>
                        <td style="width:24%; text-align: left">
                            <input id="txtColor_LDD" style="width:90%" disabled />
                        </td>
                        <td style="width:10%" align="right">
                            <label>Ref Lot</label>
                        </td>
                        <td style="width:20%">
                            <input id="txtLot_LDD" style="width:95%" />
                        </td>
                    </tr>
                </table>
            </fieldset>
            <fieldset>
                <legend>Labdip Shade</legend>
                <table id="tblFNLabdipShade" class="easyui-datagrid" style="height: 180px; width:90%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolLabdipSahde">
                    <thead>
                        <tr>
                            <th field="ShadeStr" width="10%" align="left">Shade</th>
                            <th field="Qty" width="10%" align="center">Qty</th>
                            <th field="ShadePercentage" width="10%" align="center">Shade(%)</th>
                            <th field="Note" width="50%" align="center">Note</th>
                            <th field="ApproveByName" width="25%" align="center">Approved By</th>
                        </tr>
                    </thead>
                </table>

                <div id="toolLabdipSahde">
                    <span>Shade: </span>
                    <select id="cboSahde" style="width:11%"></select>
                    <span>Qty: </span>
                    <input id="txtQty_Shade" placeholder="" class="number" min="0" max="100" style="width:40px" />
                    <span>Percentage(%): </span>
                    <input id="txtShadePercentage" placeholder="" class="number" min="0" max="100" style="width:40px" />
                    <span>Note: </span>
                    <input id="txtNoteShade" placeholder="Note" style="width:15%" />
                    <a id="btnAddShade" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                    <a id="btnDeleteShade" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                    <a id="btnApproveShade" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"></a>
                    <a id="btnCopyShade" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true"></a>
                </div>
            </fieldset>
            <div style="width:100%; float:left;">
                <div style="width:50%; float:left;">
                    <fieldset>
                        <legend>Labdip Recipe With Dyes</legend>
                        <table id="tblRecipeDyes" class="easyui-datagrid" style="height: 160px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarDyes" data-options="onClickRow: onClickRowDyes">
                            <thead>
                                <tr>
                                    <th field="ProductNameCode" width="50%" align="left">Dyes Name</th>
                                    <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:5}}" width="15%">Qty(g)</th>
                                    <th field="PerTage" width="6%" align="center">%</th>
                                    <th field="IsGLSt" width="6%" align="center">IsGL</th>
                                    <th field="Note" width="25%" align="center">Note</th>
                                </tr>
                            </thead>
                        </table>

                        <div id="toolbarDyes">
                            <input id="txtProductDyes" placeholder="Search Dyes" />
                            <a id="btnPickDyes" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                            <a id="btnResetDyes" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            <span>Qty: </span>
                            <input id="txtQtyDyes" placeholder="Qty" class="number" style="width:10%" />
                            <input id="txtPerDyes" placeholder="%" class="number" style="width:8%" />
                            <span>%</span>
                            <input id="chkIsGLDyes" type="checkbox" checked="checked" /> Is GL?
                            <input id="txtNoteDyes" placeholder="Note" style="width:15%" />
                            <a id="btnAddDyes" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                            <a id="btnDeleteDyes" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                        </div>
                    </fieldset>
                </div>
                <div style="width:50%; float:left;">
                    <fieldset>
                        <legend>Labdip Recipe With Chemicals</legend>
                        <table id="tblRecipeChemical" class="easyui-datagrid" style="height: 160px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarChemicals" data-options="onClickRow: onClickRowChemical">
                            <thead>
                                <tr>
                                    <th field="ProductNameCode" width="50%" align="left">Chemical Name</th>
                                    <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:5}}" width="15%">Qty(g)</th>
                                    <th field="IsGLSt" width="6%" align="center">IsGL</th>
                                    <th field="Note" width="24%" align="center">Note</th>

                                </tr>
                            </thead>
                        </table>

                        <div id="toolbarChemicals">
                            <input id="txtProductChemical" placeholder="Search Chemicals" />
                            <a id="btnPickChemical" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                            <a id="btnResetChemical" href="javascript:void(0)" class="easyui-linkbutton ics-remove" iconcls="icon-clear" plain="true"></a>
                            <input id="txtQtyChemical" placeholder="Qty" class="number" style="width:12%" />
                            <input id="chkIsGL" type="checkbox" checked="checked" /> Is GL?
                            <input id="txtNoteChemical" placeholder="Note" style="width:15%" />
                            <a id="btnAddChemical" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                            <a id="btnDeleteChemical" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                        </div>
                    </fieldset>
                </div>
            </div>


        </div>

        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnSaveWinShadeRecipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
            <a id="btnCloseWinShadeRecipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>
    <div id="winColorNoEntry" style="width:300px;" class="easyui-window" title="Color No Change" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:true">
        <div id="divInvoiceStatusUpdate">
            <table>
                <tr>
                    <td style="width:30%;text-align:right">
                        LD/Color No:
                    </td>
                    <td colspan="3" style="width:50%">
                        <input type="text" id="txtColorNoLD" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:30%;text-align:right">
                        Color Name:
                    </td>
                    <td colspan="3" style="width:50%">
                        <input type="text" style="width:150px;" id="txtColorName_LD" />
                    </td>
                </tr>

                <tr>
                    <td style="width:30%;text-align:right">
                        new LD No:
                    </td>
                    <td colspan="3" style="width:50%">
                        <input type="text" style="width:150px;" id="txtColorNew" />
                    </td>
                </tr>
            </table>

        </div>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnSaveColorNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
            <a id="btnCloseColorNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>
    <style type="text/css">
        .lines-no .datagrid-body td {
            border-right: 1px dotted transparent;
            border-bottom: 1px dotted transparent;
        }
    </style>

    <script type="text/javascript">
        var _sBaseAddress="";
        var _oFNLabDipDetail=null;
        var _oFNLabDipDetails=[];
        var _oCompareOperators=[];
        var _nBUID = 0;
        var _sContractorIds = '';

        var _oBU = null;
        var _nReportType=0;
        var _sProductIds="";
        var _oLabdipDetail=null;
        var _oFNLabdipShade=null;
        var _nProductIDDyes=0;
        var _nProductIDChemicals=0;
        var _nLabdipColorID=0;
        var _sMAccountIds="";
        var _oShades=[];
        var _oTempShades=[];
        var _oRecipeDyes=[];
        var _oRecipeChemicals=[];
        var _sOperation="";
        $(document).ready(function () {

            _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
            _oFNLabDipDetails =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
            _oCompareOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
            _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
            _oShades= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumShades));
            var oFabric = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Fabric));
            $('#tblFNLabDipDetails').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowIndex, rowData);}});
            debugger;
            if(sessionStorage.getItem("FNLabDipDetails")!=null && sessionStorage.getItem("FNLabDipDetails").length>0){
                _oFNLabDipDetails= jQuery.parseJSON(sessionStorage.getItem('FNLabDipDetails'));
                var nIndex= sessionStorage.getItem('SelectedRowIndex');
                DynamicRefreshList(_oFNLabDipDetails, 'tblFNLabDipDetails');
                if(nIndex>-1){
                    $('#tblFNLabDipDetails').datagrid('selectRow',nIndex);
                }
            }
            else{
                DynamicRefreshList(_oFNLabDipDetails, 'tblFNLabDipDetails');
            }
            
            RefreshFabricInfo(oFabric);

            //$(".lblBUSName").html(_oBU.ShortName);
            $('#btnViewSahdeReceipe,#btnSubmited,#btnLDNo,#btnSahdeReceipe').hide();
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").hide();
            $(".lblLoadingMessage").hide();
            $('#btnReceived').show();
            debugger;

        });

        $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


        function RowSelect(rowIndex, rowData)
        {
            debugger;
            $('#btnViewSahdeReceipe,#btnSubmited,#btnLDNo,#btnReceived,#btnSahdeReceipe,#btnAssignShade').hide();
            if(parseInt(rowData.ApprovedBy)!=0 && parseInt(rowData.ReceiveBY)==0)//Initialize
            {
                $('#btnReceived').show();
            }
            else  if(parseInt(rowData.ApprovedBy)!=0 && parseInt(rowData.ReceiveBY)!=0 && parseInt(rowData.SubmitBy)==0)//Initialize
            {
                $('#btnSahdeReceipe,#btnSubmited,#btnLDNo').show();
            }
            else  if(parseInt(rowData.ApprovedBy)!=0 && parseInt(rowData.ReceiveBY)!=0 && parseInt(rowData.SubmitBy)!=0)//SubmitBy
            {
                $('#btnViewSahdeReceipe,#btnAssignShade').show();
            }
        }

        function RefreshFabricInfo(oFabric)
        {
            $("#txtFabricNo").val(oFabric.FabricNo);
            $("#txtBuyerName").val(oFabric.BuyerName);
            $("#txtStyleNo").val(oFabric.StyleNo+" "+oFabric.BuyerReference);
            $("#txtComposition").val(oFabric.ProductName);
            $("#txtConstruction").val(oFabric.Construction);
            $("#txtProcessTypeName").val(oFabric.ProcessTypeName);

        }

        //$("#btnPrint").click(function () {

        //    var sParams=sessionStorage.getItem("ParamsSO");
        //    window.open(_sBaseAddress + '/FNLabDipDetail/Print_SampleOrderReport?sTempString=' + sParams, "_blank");
        //});
        //$("#btnPartyWisePrint").click(function () {
        //    var sParams=sessionStorage.getItem("ParamsSO");
        //    window.open(_sBaseAddress + '/FNLabDipDetail/Print_PartyWiseSOReport?sTempString=' + sParams, "_blank");
        //});
        //$("#btnProductWisePrint").click(function () {

        //    var sParams=sessionStorage.getItem("ParamsSO");
        //    window.open(_sBaseAddress + '/FNLabDipDetail/Print_ProductWiseSOReport?sTempString=' + sParams, "_blank");
        //});
        //$("#btnPrintXL").click(function () {

        //    var sParams=sessionStorage.getItem("ParamsSO");
        //    window.open(_sBaseAddress + '/FNLabDipDetail/Print_SampleOrderReportXL?sTempString=' + sParams, "_blank");
        //});



        ////Start adv Searching

        function updateProgress() {
            var value =$('#progressbar').progressbar('getValue');
            if (value < 96){
                value += Math.floor(Math.random() * 10);
                $('#progressbar').progressbar('setValue', value);
            }
        }
        function hideShow(miliseconds) {
            $("#progressbarParent").hide();
        }
        //Account Of Picker

  

        /////Pick Shade
        $("#btnAssignShade").click(function () {
            GetsShade();
        });
        function GetsShade(){

            var oFNLabDipDetail=$('#tblFNLabDipDetails').datagrid('getSelected');
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            if(oFNLabDipDetail==null || oFNLabDipDetail.FNLabDipDetailID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            //if(oFNLabDipDetail.ReceiveBY==0)
            //{
            //    alert("Yet Not Receive!");
            //    return;
            //}
            //if(oFNLabDipDetail.SubmitBy==0)
            //{
            //    alert("Yet Not Submited!");
            //    return;
            //}

            var oFNLabDipDetailTemp = {
                FNLabDipDetailID:oFNLabDipDetail.FNLabDipDetailID
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNLabDipDetailTemp,
                ControllerName: "FNLabDipDetail",
                ActionName: "GetsShade",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].FNLabdipShadeID > 0) {
                        debugger;
                        var tblColums = [];
                        var oColumn = { field: "ShadeStr", title: "Shade", width: 100, align: "left" };tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winShadePicker',
                            winclass:'clsShadePicker',
                            winwidth: 120,
                            winheight: 300,
                            tableid: 'tblShadePicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName:'ShadeStr',
                            windowTittle: 'Shade List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No marketing person found.");
                }
            });


        }
        //End Pick Mkt
        ///





        function IntializePickerbutton(oPickerobj) {
            $("#" + oPickerobj.winid).find("#btnOk").click(function () {
                SetPickerValueAssign(oPickerobj);
            });
            $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
                if (e.which === 13) {
                    SetPickerValueAssign(oPickerobj);
                }
            });
        }

        function SetPickerValueAssign(oPickerobj) {
            var oreturnObj = null, oreturnObjs = [];
            if (oPickerobj.multiplereturn) {
                oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
            } else {
                oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
            }

            if (oPickerobj.winid == 'winContractorPicker')
            {
                if (oreturnObjs != null && oreturnObjs.length> 0)
                {

                    _sContractorIds=''; var sMessage='';
                    sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Contractors Selected" : oreturnObjs[0].Name;
                    $('#txtContractorAdvS').val(sMessage);
                    $("#txtContractorAdvS").addClass("fontColorOfPickItem");

                    for(var i=0;i<oreturnObjs.length;i++){
                        _sContractorIds=_sContractorIds+oreturnObjs[i].ContractorID+',';
                    }
                    _sContractorIds=_sContractorIds.substring(0,_sContractorIds.length-1);

                }
                else
                {
                    alert("Data not found.");
                    return false;
                }
            }
            else if (oPickerobj.winid == 'winMktAccount')
            {
                if (oreturnObjs != null && oreturnObjs.length> 0)
                {
                    _sMAccountIds=''; var sMessage='';
                    sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Mkt Person Selected" : oreturnObjs[0].Name;
                    $('#txtMktAccount').val(sMessage);
                    $("#txtMktAccount").addClass("fontColorOfPickItem");

                    for(var i=0;i<oreturnObjs.length;i++){
                        _sMAccountIds=_sMAccountIds+oreturnObjs[i].MarketingAccountID+',';
                    }
                    _sMAccountIds=_sMAccountIds.substring(0,_sMAccountIds.length-1);

                }
                else
                {
                    alert("Data not found.");
                    return false;
                }
            }
            else if (oPickerobj.winid == 'winShadePicker')
            {
                if (oreturnObj != null)
                {
                    var oFNLabDipDetail=$('#tblFNLabDipDetails').datagrid('getSelected');
                    var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
                    if(oFNLabDipDetail==null || oFNLabDipDetail.FNLabDipDetailID<=0)
                    {
                        alert("Please select a item from list!");
                        return;
                    }

                    oFNLabDipDetail.ShadeID_Ap=oreturnObj.ShadeID;
                    oFNLabDipDetail.ShadeStr=oreturnObj.ShadeStr;

                    UpdateShade(oFNLabDipDetail);
                }
                else
                {
                    alert("Data not found.");
                    return false;
                }
            }

            else if (oPickerobj.winid == 'winProductPicker')
            {
                if (oreturnObjs!= null && oreturnObjs.length> 0)
                {
                    _sProductIds=''; var sMessage='';
                    sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" ProductName Selected" : oreturnObjs[0].ProductName;
                    $('#txtProductName').val(sMessage);
                    $("#txtProductName").addClass("fontColorOfPickItem");

                    for(var i=0;i<oreturnObjs.length;i++){
                        _sProductIds=_sProductIds+oreturnObjs[i].ProductID+',';
                    }
                    _sProductIds=_sProductIds.substring(0,_sProductIds.length-1);

                }
                else
                {
                    alert("Data not found.");
                    return false;
                }
            }
            $("#" + oPickerobj.winid).icsWindow("close");
            $("#" + oPickerobj.winid).remove();
        }
        /// end Adv Searching
        $("#btnPrintShowDetail").click(function() {
            var oDyeingOrder= $('#tblFNLabDipDetails').datagrid('getSelected');
            if(oDyeingOrder==null || oDyeingOrder.DyeingOrderID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            var nts = ((new Date()).getTime()) / 1000;
            window.open(_sBaseAddress + '/FNLabDipDetail/PrintStatement_DO?nDOID=' + parseInt(oDyeingOrder.DyeingOrderID) + "&nProductID=" + parseInt(0) + "&nts=" + nts, "_blank");
        });
        ////////////////////////////////
        /*----------------  Labdip Shade & Recipe --------------- */

        $('#tblFNLabdipShade').datagrid({ onSelect: function (rowIndex, rowData) { FNLabdipShadeOperationPerforms(rowIndex, rowData); } });

        function FNLabdipShadeOperationPerforms(rowIndex, rowData){
            var nTotalPerTage=0;
            ResetGridCellEdit();
            var oRecipeDyes=[], oRecipeChemicals=[];
            if(rowData!=null && rowData.FNLabdipShadeID>0){
                nTotalPerTage=0;
                for(var i=0; i<_oRecipeDyes.length;i++)
                {
                    if(_oRecipeDyes[i].FNLabdipShadeID==rowData.FNLabdipShadeID)
                    {
                        _oRecipeDyes[i].PerTage=(_oRecipeDyes[i].Qty*100)/rowData.Qty;
                        nTotalPerTage=nTotalPerTage+_oRecipeDyes[i].PerTage;
                        oRecipeDyes.push(_oRecipeDyes[i]);
                    }
                }
                rowData.ShadePercentage=nTotalPerTage;
                $("#tblFNLabdipShade").datagrid("updateRow", { index: rowIndex, row: rowData });
                for(var i=0; i<_oRecipeChemicals.length;i++){
                    if(_oRecipeChemicals[i].FNLabdipShadeID==rowData.FNLabdipShadeID){
                        oRecipeChemicals.push(_oRecipeChemicals[i]);
                    }
                }
            }
            DynamicRefreshList(oRecipeDyes, 'tblRecipeDyes');
            DynamicRefreshList(oRecipeChemicals, 'tblRecipeChemical');
        }

        function ResetFNLabdipShadeRecipe(nShadeCount){
            _oFNLabdipShade=null;
            _nProductIDDyes=0;
            _nProductIDChemicals=0;
            $('#cboSahde').val(0);
            $('#txtNoteShade, #txtProductDyes, #txtNoteDyes,  #txtProductChemical, #txtNoteChemical').val("");
            $('#txtQtyDyes, #txtQtyChemical').val("0.00");

            nShadeCount= (nShadeCount>_oShades.length)?_oShades.length:nShadeCount;
            _oTempShades=[];
            for(var i=0;i<=nShadeCount;i++){
                _oTempShades.push(_oShades[i]);
            }

            $("#cboSahde").icsLoadCombo({
                List: _oTempShades,
                OptionValue: "id",
                DisplayText: "Value",
                InitialValue:"Default"
            });

            _oRecipeDyes=[];
            _oRecipeChemicals=[];
            DynamicRefreshList([], 'tblFNLabdipShade');
            DynamicRefreshList(_oRecipeDyes, 'tblRecipeDyes');
            DynamicRefreshList(_oRecipeChemicals, 'tblRecipeChemical');
            ResetGridCellEdit();
        }

        function ResetGridCellEdit(){
            _nDyesQty=0;
            _nChamicalQty=0;
            editIndexDyes=undefined;
            editIndexChemical=undefined;
            nDyesIndex=-1;
            nChemicalIndex=-1;
        }


        function GetShadeReceipe(_sOperation){
            debugger;
            _oFNLabDipDetail = $("#tblFNLabDipDetails").datagrid("getSelected");
            if (_oFNLabDipDetail == null || _oFNLabDipDetail.FNLabDipDetailID <= 0) { alert("Please select an item from list."); return false; }
            if(_oFNLabDipDetail.ColorNo ==""){
                alert(((_sOperation=="View")? "Color yet no issued." : "Please issue color for this item."));
                return false;
            }
            $('#txtYarn_LDD').val(_oFNLabDipDetail.ProductName);
            $('#txtColor_LDD').val(_oFNLabDipDetail.ColorName);
            $('#txtLot_LDD').val(_oFNLabDipDetail.LotNo);
            ResetFNLabdipShadeRecipe(_oFNLabDipDetail.ShadeCount);

            if(_sOperation=="View"){
                $('#toolLabdipSahde,#toolbarChemicals,#toolbarDyes,#btnSaveWinShadeRecipe').hide();
            }
            else{
                $('#toolLabdipSahde,#toolbarChemicals,#toolbarDyes,#btnSaveWinShadeRecipe').show();
            }
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: _oFNLabDipDetail,
                ControllerName: "FNLabDipDetail",
                ActionName: "GetsFNLabdipShade",
                IsWinClose: false
            };
            $.icsDataGet(obj, function (response) {

                debugger;
                if (response.status && response.obj.FNLabdipShades.length>0) {
                    _oRecipeDyes=response.obj.RecipeDyes;
                    _oRecipeChemicals=response.obj.RecipeChemicals;

                    DynamicRefreshList(response.obj.FNLabdipShades, 'tblFNLabdipShade');
                    DynamicRefreshList([], 'tblRecipeDyes');
                    DynamicRefreshList([], 'tblRecipeChemical');
                }

                $('#WinShadeRecipe').icsWindow('open');
            });
        }

        $('#btnViewSahdeReceipe').click(function(e){

            GetShadeReceipe("View");
        });


        $('#btnSahdeReceipe').click(function(e){

            GetShadeReceipe("");

        });

        $('#btnCloseWinShadeRecipe').click(function(e){

            $('#WinShadeRecipe').icsWindow('close');
        });

        $('#btnSaveWinShadeRecipe').click(function(e){


            debugger;
            endEditing('tblRecipeDyes');
            endEditing('tblRecipeChemical');
            _oFNLabDipDetail.LotNo =  $('#txtLot_LDD').val();

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: _oFNLabDipDetail,
                ObjectId: _oFNLabDipDetail.FNLabDipDetailID,
                ControllerName: "FNLabDipDetail",
                ActionName: "UpdateLot",
                TableId: "",
                IsWinClose: false,
                Message: ""// (oFNLabDipDetail.FNLabDipDetailID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    debugger;
                    if (response.obj.FNLabDipDetailID > 0) {
                        alert("Data Save Successfully")
                    }
                }
            });



        });

        function ValidationShade(){

            if($('#cboSahde').val()<=0){
                $('#cboSahde').focus();
                $('#cboSahde').addClass("errorFieldBorder");
                alert('Select Shade.');
                return false;
            }
            else{
                $('#cboSahde').removeClass("errorFieldBorder");
            }

            //if($.trim($('#txtShadePercentage').val())==""){
            //    $('#txtShadePercentage').focus();
            //    $('#txtShadePercentage').addClass("errorFieldBorder");
            //    alert('Please enter shade percentage.');
            //    return false;
            //}
            //else{
            //    $('#txtShadePercentage').removeClass("errorFieldBorder");
            //}

            //if(parseFloat(icsRemoveComma($('#txtShadePercentage').val()))<=0){
            //    $('#txtShadePercentage').focus();
            //    $('#txtShadePercentage').addClass("errorFieldBorder");
            //    alert('Shade percentage must be greater than zero.');
            //    return false;
            //}
            //else{
            //    $('#txtShadePercentage').removeClass("errorFieldBorder");
            //}

            var oFNLabdipShades = $("#tblFNLabdipShade").datagrid("getRows");
            if(oFNLabdipShades.length>0){
                for(var i=0;i<oFNLabdipShades.length;i++){
                    if(oFNLabdipShades[i].ShadeID==$('#cboSahde').val()){
                        alert("Already this added.");
                        return false;
                    }
                }

                if(oFNLabdipShades.length>=_oTempShades.length){
                    alert("No remaining shade found to add.");
                    return false;
                }

                if(parseInt(oFNLabdipShades[oFNLabdipShades.length-1].ShadeID)+1!=$('#cboSahde').val()){
                    $('#cboSahde').focus();
                    $('#cboSahde').addClass("errorFieldBorder");
                    alert('Please select '+ _oTempShades[oFNLabdipShades.length].Value +' shade qq');
                    return false;
                }
            }
            else{

                if(_oTempShades.length==0){
                    $('#cboSahde').focus();
                    $('#cboSahde').addClass("errorFieldBorder");
                    alert('No shade found.');
                    return false;
                }
                //else if($('#cboSahde').val()!=_oTempShades[0].Value){
                //    $('#cboSahde').focus();
                //    $('#cboSahde').addClass("errorFieldBorder");
                //    alert('Please select '+ _oTempShades[0].Value +' shade aa');
                //    return false;
                //}
                //else{
                //    $('#cboSahde').removeClass("errorFieldBorder");
                //}
            }

            return true;
        }

        function RefreshObjectShade()
        {

            var oFNLabdipShade={
                FNLabdipShadeID : 0,
                FNLabDipDetailID : _oFNLabDipDetail.FNLabDipDetailID,
                ShadeID : $('#cboSahde').val(),
                ShadePercentage: parseFloat(icsRemoveComma($('#txtShadePercentage').val())),
                Qty: parseFloat(icsRemoveComma($('#txtQty_Shade').val())),
                Note : $('#txtNoteShade').val()

            };
            return oFNLabdipShade;
        }

        $("#btnAddShade").click(function (){
            if(!ValidationShade()) return false;

            var oFNLabdipShade=RefreshObjectShade();
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipShade,
                ObjectId: oFNLabdipShade.FNLabdipShadeID,
                ControllerName: "FNLabDipDetail",
                ActionName: "SaveFNLabdipShade",
                TableId: "tblFNLabdipShade",
                IsWinClose: false,
                Message: (oFNLabdipShade.FNLabdipShadeID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    if (response.obj.FNLabdipShadeID > 0) {

                    }
                }
            });
        });

        $("#btnDeleteShade").click(function () {
            debugger;
            var oFNLabdipShades = $("#tblFNLabdipShade").datagrid("getRows");
            var oFNLabdipShade = $("#tblFNLabdipShade").datagrid("getSelected");
            if (oFNLabdipShade == null || oFNLabdipShade.FNLabdipShadeID <= 0) { alert("Please select an item from list."); return false; }

            if(oFNLabdipShades[oFNLabdipShades.length-1].FNLabdipShadeID!=oFNLabdipShade.FNLabdipShadeID){ alert("Please delete last item first."); return false; }

            if (oFNLabdipShade.ApproveBy > 0) { alert("Already Approvd. Unable to delete."); return false; }

            if (!confirm("Confirm to Delete?")) return false;

            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipShade,
                ControllerName: "FNLabDipDetail",
                ActionName: "DeleteFNLabdipShade",
                TableId: "tblFNLabdipShade",
                IsWinClose: false,
                Message:''
            };
            $.icsDelete(obj, function (response) {
                if (response.status && response.Message == 'deleted') {

                    var oRecipeDyes=[], oRecipeChemicals=[];
                    for(var i=0; i<_oRecipeDyes.length;i++){
                        if(_oRecipeDyes[i].FNLabdipShadeID!=oFNLabdipShade.FNLabdipShadeID){
                            oRecipeDyes.push(_oRecipeDyes[i]);
                        }
                    }
                    for(var i=0; i<_oRecipeChemicals.length;i++){
                        if(_oRecipeChemicals[i].FNLabdipShadeID!=oFNLabdipShade.FNLabdipShadeID){
                            oRecipeChemicals.push(_oRecipeChemicals[i]);
                        }
                    }
                    _oRecipeDyes=oRecipeDyes;
                    _oRecipeChemicals=oRecipeChemicals;
                    DynamicRefreshList([], 'tblRecipeDyes');
                    DynamicRefreshList([], 'tblRecipeChemical');
                }
            });

        });

        $("#btnApproveShade").click(function (){

            var oFNLabdipShade = $("#tblFNLabdipShade").datagrid("getSelected");
            if (oFNLabdipShade == null || oFNLabdipShade.FNLabdipShadeID <= 0) { alert("Please select an item from list."); return false; }
            if (oFNLabdipShade.ApproveBy > 0) { alert("Already Approved."); return false; }

            if (!confirm("Confirm to Approve?")) return false;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipShade,
                ObjectId: oFNLabdipShade.FNLabdipShadeID,
                ControllerName: "FNLabDipDetail",
                ActionName: "ApproveFNLabdipShade",
                TableId: "tblFNLabdipShade",
                IsWinClose: false,
                Message: "Approved Successfully."
            };
            $.icsSave(obj);
        });

        $("#btnCopyShade").click(function (){

            var oFNLabdipShade = $("#tblFNLabdipShade").datagrid("getSelected");
            if (oFNLabdipShade == null || oFNLabdipShade.FNLabdipShadeID <= 0) { alert("Please select an item from list."); return false; }

            var oFNLabdipShades=$("#tblFNLabdipShade").datagrid("getRows");
            if(oFNLabdipShades.length>=_oTempShades.length){
                alert("No remaining shade found to add.");
                return false;
            }

            if (!confirm("Confirm to copy this item as new shade?")) return false;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipShade,
                ObjectId: oFNLabdipShade.FNLabdipShadeID,
                ControllerName: "FNLabDipDetail",
                ActionName: "CopyFNLabdipShade",
                TableId: "",
                IsWinClose: false,
                Message: "Copy Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null && response.obj.FNLabdipShadeID>0) {

                    $("#tblFNLabdipShade").datagrid('appendRow',response.obj);
                    $("#tblFNLabdipShade").datagrid("selectRow", oFNLabdipShades.length);
                    for(var i=0; i<response.obj.RecipeDyes.length;i++){
                        _oRecipeDyes.push(response.obj.RecipeDyes[i]);
                    }
                    for(var i=0; i<response.obj.RecipeChemicals.length;i++){
                        _oRecipeChemicals.push(response.obj.RecipeChemicals[i]);
                    }
                    DynamicRefreshList(response.obj.RecipeDyes, 'tblRecipeDyes');
                    DynamicRefreshList(response.obj.RecipeChemicals, 'tblRecipeChemical');
                }
            });
        });


        function ValidationRecipe(bIsDyes){

            _oFNLabdipShade = $("#tblFNLabdipShade").datagrid("getSelected");
            if (_oFNLabdipShade == null || _oFNLabdipShade.FNLabdipShadeID <= 0) { alert("Please select an item from list."); return false; }
            //if (_oFNLabdipShade.ApproveBy == 0) { alert("Yet not approved. Please approve labdip shade first."); return false; }


            if(bIsDyes){
                if(_nProductIDDyes<=0){
                    $('#txtProductDyes').focus();
                    $('#txtProductDyes').addClass("errorFieldBorder");
                    alert('No dyes found to add.');
                    return false;
                }
                else{
                    $('#txtProductDyes').removeClass("errorFieldBorder");
                }

                if($.trim($('#txtQtyDyes').val())==""){
                    $('#txtQtyDyes').focus();
                    $('#txtQtyDyes').addClass("errorFieldBorder");
                    alert('Please enter quantity.');
                    return false;
                }
                else{
                    $('#txtQtyDyes').removeClass("errorFieldBorder");
                }

                ////if(parseFloat(icsRemoveComma($('#txtQtyDyes').val()))<=0){
                ////    $('#txtQtyDyes').focus();
                ////    $('#txtQtyDyes').addClass("errorFieldBorder");
                ////    alert('Quantity must be greater than zero.');
                ////    return false;
                ////}
                ////else{
                ////    $('#txtQtyDyes').removeClass("errorFieldBorder");
                ////}
            }
            else{
                if(_nProductIDChemicals<=0){
                    $('#txtProductChemical').focus();
                    $('#txtProductChemical').addClass("errorFieldBorder");
                    alert('No chemical found to add.');
                    return false;
                }
                else{
                    $('#txtProductChemical').removeClass("errorFieldBorder");
                }

                if($.trim($('#txtQtyChemical').val())==""){
                    $('#txtQtyChemical').focus();
                    $('#txtQtyChemical').addClass("errorFieldBorder");
                    alert('Please enter quantity.');
                    return false;
                }
                else{
                    $('#txtQtyChemical').removeClass("errorFieldBorder");
                }

                if(parseFloat($('#txtQtyChemical').val())<=0){
                    $('#txtQtyChemical').focus();
                    $('#txtQtyChemical').addClass("errorFieldBorder");
                    alert('Quantity must be greater than zero.');
                    return false;
                }
                else{
                    $('#txtQtyChemical').removeClass("errorFieldBorder");
                }
            }


            return true;
        }

        function RefreshObjectRecipe(bIsDyes)
        {
            var bIsGL=false;
            bIsGL= (bIsDyes)? $("#chkIsGLDyes").is(":checked"):$("#chkIsGL").is(":checked");
            var oFNLabdipRecipe={
                FNLabdipRecipeID : 0,
                FNLabdipShadeID : _oFNLabdipShade.FNLabdipShadeID,
                ProductID : (bIsDyes)? _nProductIDDyes:_nProductIDChemicals,
                IsGL : bIsGL,
                PerTage: (bIsDyes)? parseFloat($('#txtPerDyes').val()):0,
                Qty : (bIsDyes)? parseFloat($('#txtQtyDyes').val()):parseFloat($('#txtQtyChemical').val()),
                IsGLSt:(bIsGL)? "GL":"%",
                Note : (bIsDyes)? $.trim($('#txtNoteDyes').val()):$.trim($('#txtNoteChemical').val()),
                IsDyes : bIsDyes
            };
            return oFNLabdipRecipe;
        }

        $("#btnAddDyes").click(function (){
            if(!ValidationRecipe(true)) return false;
            var oFNLabdipRecipe=RefreshObjectRecipe(true);
            SaveFNLabdipRecipe(oFNLabdipRecipe, 'tblRecipeDyes');
        });

        $("#btnDeleteDyes").click(function () {

            var oFNLabdipRecipe = $("#tblRecipeDyes").datagrid("getSelected");
            if (oFNLabdipRecipe == null || oFNLabdipRecipe.FNLabdipRecipeID <= 0) { alert("Please select an item from list."); return false; }
            DeleteFNLabdipRecipe(oFNLabdipRecipe,'tblRecipeDyes');
        });


        $("#btnAddChemical").click(function (){
            if(!ValidationRecipe(false)) return false;
            var oFNLabdipRecipe=RefreshObjectRecipe(false);
            SaveFNLabdipRecipe(oFNLabdipRecipe, 'tblRecipeChemical');
        });

        $("#btnDeleteChemical").click(function () {

            var oFNLabdipRecipe = $("#tblRecipeChemical").datagrid("getSelected");
            if (oFNLabdipRecipe == null || oFNLabdipRecipe.FNLabdipRecipeID <= 0) { alert("Please select an item from list."); return false; }
            DeleteFNLabdipRecipe(oFNLabdipRecipe,'tblRecipeChemical');
        });


        function SaveFNLabdipRecipe(oFNLabdipRecipe, tableID){

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipRecipe,
                ObjectId: oFNLabdipRecipe.FNLabdipRecipeID,
                ControllerName: "FNLabDipDetail",
                ActionName: "SaveFNLabdipRecipe",
                TableId: tableID,
                IsWinClose: false,
                Message: (oFNLabdipRecipe.FNLabdipRecipeID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    if (response.obj.FNLabdipRecipeID > 0) {

                        if(response.obj.IsDyes){

                            _oRecipeDyes.push(response.obj);
                            $('#txtProductDyes').val("");
                            $('#txtProductDyes').focus();
                            $('#txtProductDyes').addClass("errorFieldBorder");
                        }
                        else{
                            _oRecipeChemicals.push(response.obj);
                            $('#txtProductChemical').val("");
                            $('#txtProductChemical').focus();
                            $('#txtProductChemical').addClass("errorFieldBorder");
                        }
                    }
                }
            });

        }

        function DeleteFNLabdipRecipe(oFNLabdipRecipe, tableID){

            if (!confirm("Confirm to Delete?")) return false;
            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oFNLabdipRecipe,
                ControllerName: "FNLabDipDetail",
                ActionName: "DeleteFNLabdipRecipe",
                TableId: tableID,
                IsWinClose: false,
                Message:''
            };
            $.icsDelete(obj, function (response) {
                if (response.status && response.Message =='deleted') {

                    if(tableID=='tblRecipeDyes'){
                        _nDyesQty=0;
                        _nChamicalQty=0;
                        _oRecipeDyes.pop(oFNLabdipRecipe);
                        editIndexDyes=undefined;
                    }
                    else if(tableID=='tblRecipeChemical'){
                        _oRecipeChemicals.pop(oFNLabdipRecipe);
                        editIndexChemical=undefined;
                        nDyesIndex=-1;
                        nChemicalIndex=-1;
                    }

                }
            });
        }



        /*--------------- Grid Edit--------------*/

        var _nDyesQty=0;
        var _nChamicalQty=0;
        var editIndexDyes=undefined;
        var editIndexChemical=undefined;
        var nDyesIndex=-1;
        var nChemicalIndex=-1;


        function endEditing(tblId) {

            debugger;
            var editIndex = ((tblId == 'tblRecipeDyes')?editIndexDyes:editIndexChemical);

            if (editIndex == undefined) {
                return true;
            }
            if ($('#'+tblId).datagrid('validateRow', editIndex)) {

                $('#'+tblId).datagrid('endEdit', editIndex);
                $('#'+tblId).datagrid('selectRow', editIndex);
                var oFNLabdipRecipe = $('#'+tblId).datagrid('getSelected');
                if ( parseFloat(oFNLabdipRecipe.Qty)<=0 || parseFloat(oFNLabdipRecipe.Qty)== ((tblId == 'tblRecipeDyes')?parseFloat(_nDyesQty):parseFloat(_nChamicalQty)) ) {
                    editIndex = undefined;
                    return true;
                }
                else {
                    var obj = {
                        BaseAddress: _sBaseAddress,
                        Object: oFNLabdipRecipe,
                        ObjectId: oFNLabdipRecipe.FNLabdipRecipeID,
                        ControllerName: "FNLabDipDetail",
                        ActionName: "SaveFNLabdipRecipe",
                        TableId: tblId,
                        IsWinClose: false,
                        Message: ""
                    };

                    $.icsSave(obj, function (response) {

                        if(tblId == 'tblRecipeDyes'){
                            if(editIndex==nDyesIndex){
                                editIndexDyes = undefined;
                            }
                            else{
                                editIndexDyes = nDyesIndex;
                                $('#'+tblId).datagrid('selectRow', editIndexDyes).datagrid('beginEdit', editIndexDyes);
                                var oFNLabdipRecipe=$('#'+tblId).datagrid('getSelected');
                                _nDyesQty =  parseFloat(oFNLabdipRecipe.Qty);
                            }
                        }
                        else{
                            if(editIndex==nChemicalIndex){
                                editIndexChemical = undefined;
                            }
                            else{
                                editIndexChemical = nChemicalIndex;
                                $('#'+tblId).datagrid('selectRow', editIndexChemical).datagrid('beginEdit', editIndexChemical);
                                var oFNLabdipRecipe=$('#'+tblId).datagrid('getSelected');
                                _nChamicalQty =  parseFloat(oFNLabdipRecipe.Qty);
                            }
                        }
                        return true;
                    });
                }
            }
            else { return false; }
        }

        function onClickRowDyes(index) {
            if (editIndexDyes != index && _sOperation!="View") {
                nDyesIndex=index;
                if (endEditing('tblRecipeDyes')) {
                    debugger;
                    $('#tblRecipeDyes').datagrid('selectRow', index).datagrid('beginEdit', index);
                    var oFNLabdipRecipe=$('#tblRecipeDyes').datagrid('getSelected');
                    _nDyesQty = parseFloat(oFNLabdipRecipe.Qty);
                    editIndexDyes = index;
                }
                else {
                    $('#tblRecipeDyes').datagrid('selectRow', editIndexDyes);
                }
            }
        }

        function onClickRowChemical(index) {

            if (editIndexChemical != index) {
                nChemicalIndex=index;
                if (endEditing('tblRecipeChemical')) {
                    $('#tblRecipeChemical').datagrid('selectRow', index).datagrid('beginEdit', index);
                    var oFNLabdipRecipe=$('#tblRecipeChemical').datagrid('getSelected');
                    _nChamicalQty = parseFloat(oFNLabdipRecipe.Qty);
                    editIndexChemical = index;
                }
                else {
                    $('#tblRecipeChemical').datagrid('selectRow', editIndexChemical);
                }
            }
        }




        /*-------------------- Product ---------------*/


        $("#btnResetDyes").click(function () {
            $("#txtProductDyes").val("");
            _nProductIDDyes=0;
        });

        $("#btnPickDyes").click(function () {
            var sProductName=$.trim($("#txtProductDyes").val());
            GetProducts(sProductName, true);
        });

        $("#txtProductDyes").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sProductName=$.trim($("#txtProductDyes").val());
                GetProducts(sProductName,true);
            }
            else if(nkeyCode==8){
                $("#txtProductDyes").val("");
                _nProductIDDyes=0;
            }
        });



        $("#btnResetChemical").click(function () {
            $("#txtProductChemical").val("");
            _nProductIDChemicals=0;
        });

        $("#btnPickChemical").click(function () {
            var sProductName=$.trim($("#txtProductChemical").val());
            GetProducts(sProductName, false);
        });

        $("#txtProductChemical").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sProductName=$.trim($("#txtProductChemical").val());
                GetProducts(sProductName,false);
            }
            else if(nkeyCode==8){
                $("#txtProductChemical").val("");
                _nProductIDChemicals=0;
            }
        });

        function GetProducts(sProductName, bIsDyes){
            var bProductCategoryID=0;
            if(bIsDyes)
            {
                bProductCategoryID=7;
            }
            else{
                bProductCategoryID=8;
            }

            var oProduct = {
                BUID:_nBUID,
                ProductName:sProductName,
                ProductCategoryName: (bIsDyes)? 'Dyes':'Chemicals',
                ProductCategoryID:bProductCategoryID

            };

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oProduct,
                ControllerName: "FNLabDipDetail",
                ActionName: "GetProducts",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ProductID > 0) {
                        debugger;
                        var tblColums = [];
                        var oColumn = { field: "ProductCode", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "ProductName", title: "Name", width: 160, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "ProductCategoryName", title: "Category Name", width: 270, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winProductPicker',
                            winclass:'clsProductPicker',
                            winwidth: 460,
                            winheight: 460,
                            tableid: 'tblProductPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName:'ProductName',
                            windowTittle: 'Product List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializeProductPickerbutton(oPickerParam,bIsDyes);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No product found.");
                }
            });


        }

        function IntializeProductPickerbutton(oPickerobj, bIsDyes)
        {
            $("#" + oPickerobj.winid).find("#btnOk").click(function () {
                ProductSelect(oPickerobj, bIsDyes);
            });
            $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
                if (e.which == 13)//enter=13
                {
                    ProductSelect(oPickerobj, bIsDyes);
                }
            });
        }

        function ProductSelect(oPickerobj, bIsDyes){
            var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
            if (oPickerobj.winid == 'winProductPicker')
            {
                if(oProduct !=null  && oProduct.ProductID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    debugger;
                    if(bIsDyes){
                        $('#txtProductDyes').val(oProduct.NameCode);
                        _nProductIDDyes= oProduct.ProductID;
                        $('#txtQtyDyes').focus();
                    }
                    else{
                        $('#txtProductChemical').val(oProduct.NameCode);
                        _nProductIDChemicals= oProduct.ProductID;
                        $('#txtQtyChemical').focus();
                    }

                }
                else{
                    alert("Please select product.");
                }
            }
            if (oPickerobj.winid == 'winLDColorPicker')
            {
                if(oProduct !=null  && oProduct.LabdipColorID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    $('#txtLDCode').val(oProduct.Code+""+oProduct.CodeNo);
                    _nLabdipColorID= oProduct.LabdipColorID;
                    $('#txtColorName').focus().select();
                    SaveColorNo();
                }
                else{
                    alert("Please select product.");
                }
            }
        }

        $('#btnPrintToExcel').click(function (e)
        {
            var Params= sessionStorage.getItem("ParamsSO");
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/FNLabDipDetail/PrintLabDipsXL?Params="+(Params==null?"":Params)+"&nts="+tsv, "_blank");
        });
        $('#btnPrintRecipe').click(function (e)
        {
            _oFNLabDipDetail = $("#tblFNLabDipDetails").datagrid("getSelected");
            if (_oFNLabDipDetail == null || _oFNLabDipDetail.FNLabDipDetailID <= 0) { alert("Please select an item from list."); return false; }
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/FNLabDipDetail/PrintLabDipRecipe?nId="+ _oFNLabDipDetail.FabricID+"&nDetailID="+_oFNLabDipDetail.FNLabDipDetailID+"&nts="+tsv, "_blank");
        });
        $('#btnPrintSubmission').click(function (e)
        {
            _oFNLabDipDetail = $("#tblFNLabDipDetails").datagrid("getSelected");
            if (_oFNLabDipDetail == null || _oFNLabDipDetail.FNLabDipDetailID <= 0) { alert("Please select an item from list."); return false; }
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/FNLabDipDetail/PrintLabDipSubCard?nId="+ _oFNLabDipDetail.FabricID+"&nDetailID="+_oFNLabDipDetail.FNLabDipDetailID+"&buid="+0+"&nts="+tsv, "_blank");
        });


        /// Update Color No
        $("#btnLDNo").click(function () {
            var oFNLabDipDetail = $('#tblFNLabDipDetails').datagrid('getSelected');
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            if (oFNLabDipDetail ==null || oFNLabDipDetail.FNLabDipDetailID<=0) { alert("Please select an item from list."); return ; }
            $('#txtLDCode').val("");
            $('#txtColorName_LD').val(oFNLabDipDetail.ColorName);
            $('#txtColorNoLD').val(oFNLabDipDetail.LabdipNo);

            $('#txtColorName_LD').prop('disabled',true);
            $('#txtColorNoLD').prop('disabled',true);
            $('#txtLDCode').prop('disabled',false);
            $('#txtColorNew').prop('disabled',false);
            $('#txtColorNew').val('');
            $("#winColorNoEntry").icsWindow('open', "Update LD No Entry");

        });

        $("#btnSaveColorNo").click(function (e) {

            var oFNLabDipDetail=$('#tblFNLabDipDetails').datagrid('getSelected');
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            if(oFNLabDipDetail==null || oFNLabDipDetail.FNLabDipDetailID<=0)
            {
                alert("Please select a item from list!");
                return;
            }

            if(oFNLabDipDetail.SubmitBy!=0)
            {
                alert("Already Submited!");
                return;
            }
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            oFNLabDipDetail.LDNo= $('#txtColorNew').val();
            oFNLabDipDetail.ReceiveBY=0; // Up
            SaveColorNo(oFNLabDipDetail,nSelectedIndex);
        });
        $("#btnReceived").click(function (e) {

            if (!confirm("Confirm to Receive?")) return false;
            //alert("");
            var oFNLabDipDetail=$('#tblFNLabDipDetails').datagrid('getSelected');
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            if(oFNLabDipDetail==null || oFNLabDipDetail.FNLabDipDetailID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(oFNLabDipDetail.ReceiveBY!=0)
            {
                alert("Already Received!");
                return;
            }
            if(oFNLabDipDetail.SubmitBy!=0)
            {
                alert("Already Submited!");
                return;
            }
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            oFNLabDipDetail.LDNo= $('#txtColorNew').val();
            oFNLabDipDetail.ReceiveBY=1; // Up
            SaveColorNo(oFNLabDipDetail);
        });
        function SaveColorNo(oFNLabDipDetail,nSelectedIndex)
        {
            debugger;



            var obj =
                {
                    BaseAddress: _sBaseAddress,
                    Object: oFNLabDipDetail,
                    ObjectId: oFNLabDipDetail.FNLabDipDetailID,
                    ControllerName: "FNLabDipDetail",
                    ActionName: "Save_LDNo",
                    TableId: "tblFNLabDipDetails",
                    IsWinClose: true
                };
            $.icsSave(obj, function (response) {
                if (response.status) {
                    RowSelect(nSelectedIndex, response.obj);
                }
            });
        }

        $("#btnCloseColorNo").click(function () {
            $("#winColorNoEntry").icsWindow("close");
        });

        //Update Color No
        $("#btnSubmited").click(function (e) {

            if (!confirm("Confirm to Submit?")) return false;
            var oFNLabDipDetail=$('#tblFNLabDipDetails').datagrid('getSelected');
            var nSelectedIndex= $('#tblFNLabDipDetails').datagrid('getRowIndex',oFNLabDipDetail);
            if(oFNLabDipDetail==null || oFNLabDipDetail.FNLabDipDetailID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(oFNLabDipDetail.ReceiveBY==0)
            {
                alert("Yet Not Receive!");
                return;
            }
            if(oFNLabDipDetail.SubmitBy!=0)
            {
                alert("Already Submited!");
                return;
            }
            var obj =
              {
                  BaseAddress: _sBaseAddress,
                  Object: oFNLabDipDetail,
                  ObjectId: oFNLabDipDetail.FNLabDipDetailID,
                  ControllerName: "FNLabDipDetail",
                  ActionName: "Submited",
                  TableId: "tblFNLabDipDetails",
                  IsWinClose: true
              };
            $.icsSave(obj, function (response) {
                if (response.status) {
                    RowSelect(nSelectedIndex, response.obj);
                }
            });

        });

        function UpdateShade(oFNLabDipDetail)
        {
            var obj =
              {
                  BaseAddress: _sBaseAddress,
                  Object: oFNLabDipDetail,
                  ObjectId: oFNLabDipDetail.FNLabDipDetailID,
                  ControllerName: "FNLabDipDetail",
                  ActionName: "UpdateShade",
                  TableId: "tblFNLabDipDetails",
                  IsWinClose: true
              };
            $.icsSave(obj, function (response) {
                if (response.status) {
                    RowSelect(nSelectedIndex, response.obj);
                }
            });

        }
        $('#btnClose').click(function(e){
            window.location.href = sessionStorage.getItem("BackLink");
        });
    </script>


