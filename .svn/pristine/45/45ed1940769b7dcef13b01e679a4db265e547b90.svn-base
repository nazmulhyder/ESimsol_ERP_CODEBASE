@{
    ViewBag.Title = "RouteSheet";
}

@model IEnumerable<ESimSol.BusinessObjects.RouteSheet>

    <head>
        <title>Route Sheet</title>
    </head>

    <body>
        <div class="menuMainCollectionTable">
            <table id="tblRouteSheet" title="Route Sheet List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbarRouteSheet" showfooter="true">
                <thead>
                    <tr>
                        <th field="EventTimeStr" width="10%">Yarn Out Date</th>
                        <th field="RouteSheetNo" width="10%">DL No</th>
                        <th field="OrderNoFull" width="10%">Order No</th>
                        <th field="RSStateStr" width="15%">Current State</th>
                        <th field="ProductName" width="22%">Product Name</th>
                        <th field="LotNo" width="12%">Lot No</th>
                        <th field="WUName" width="18%">Store Name</th>
                        <th field="Qty" width="10%" formatter="formatPrice" align="right">Qty</th>
                        <th field="UserName" width="18%">Out By</th>

                    </tr>
                </thead>

            </table>

            <div id="toolbarRouteSheet">
                <input type="text" id="txtRouteSheetNo" placeholder="Search RouteSheet" style="width:12%;" />
                <input id="dtFrom" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                <a id="btnExcel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Excel</a>
                
            </div>
        </div>

        <div id="winYarnOut" class="easyui-window winstyle" title="Yarn Out" style="width:600px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 100%; font-family: Tahoma;">
                <fieldset>
                    <table class="tbl-Win">
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Dye Line No :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <input id="txtRSNo" class="reset-text txt-styler" placeholder="Search RouteSheet" />
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Order :</label>
                            </td>
                            <td class="td-styler td-col-7">
                                <input id="txtOrderNo" placeholder="Order No" disabled="disabled" />
                                @*<a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Yarn :</label>
                            </td>
                            <td class="td-styler td-col-16" colspan="3">
                                <input id="txtProduct" style="width:82%;" placeholder=" search product" />
                                <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>

                        </tr>
                        <tr>

                            <td class="td-col-4 align-right">
                                <label>Store :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <select id="cboStore" class="cbo-styler"></select>
                            </td>

                            <td class="td-styler td-col-3 align-right">
                                <label>Lot :</label>
                            </td>
                            <td class="td-styler td-col-7">
                                <input id="txtLot" style="width:55%;" placeholder="Search Lot" />
                                <a id="btnPickLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Batch No :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <input id="txtBatchNo" class="reset-text txt-styler" placeholder="Search Batch No" />
                            </td>
                            <td class="td-col-3 align-right">
                                <label>Quantity :</label>
                            </td>
                            <td class="td-styler td-col-7">
                                <input id="txtQty" class="reset-text txt-styler number" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Status :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <input id="txtRSState" class="reset-text txt-styler" disabled />
                            </td>
                            <td class="td-col-3 align-right align-right">
                                <label>Batch Man :</label>
                            </td>
                            <td class="td-styler td-col-7">
                                <select id="cboBatchman" class="cbo-styler"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Note :</label>
                            </td>
                            <td class="td-styler td-col-16" colspan="3">
                                <input id="txtNote" class="reset-text txt-styler-Note" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                                
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <legend>Action</legend>
                    <div style="width:100%;height:10%">
                        <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                            <tr>
                                <td style=" float:left;  width:50%; text-align: left ">
                                  
                                </td>
                                @*<td style=" float:right;  width:15%; "> </td>*@
                                <td style="width: 20%; text-align: right"></td>
                                <td style="width:30%; text-align: right">
                                    <a id="btnSaveYarnOut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Yarn Out</a>
                                    <a id="btnCloseYarnOut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </fieldset>
            </div>
        </div>

        <div id="winAdvanceSearch" class="easyui-window winstyle" title="Adv Search" style="width:575px; height:270px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 100%; font-family: Tahoma;">
                <fieldset>
                    <legend>Searching Criteria</legend>
                    <table class="tbl-AdvSearch">
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Store :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboStore-Adv"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Product :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtProduct-Adv" class="reset-text pickersearch" placeholder="Search product" />
                                <a id="btnPickProduct-Adv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetProduct-Adv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Lot :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtLot-Adv" class="reset-text pickersearch" placeholder="Search lot" />
                                <a id="btnPickLot-Adv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetLot-Adv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level"> 
                                Yarn Out Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboDateCompare-Adv" style="width:22%"></select>
                                <input id="dtYarnOutFrom-Adv" type="text" style="width: 90px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                 To
                                <input id="dtYarnOutTo-Adv" type="text" style="width: 90px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                             
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <legend>Action</legend>
                    <table class="tbl-AdvSearch">
                        <tr>
                            <td style="text-align:right">
                                <a id="btnReset-Adv" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                                <a id="btnSearchOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Search</a>
                                <a id="btnSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
    </body>

    <style type="text/css">

        .tbl-Win{
            width:100%;
        }
        .td-styler input, select {
            padding-left: 5px;
        }
        .txt-styler{
            width:95%;
        }
        .txt-styler-picker{
            width:65%;
        }
        .cbo-styler{
            width:98%;
        }
        .txt-styler-Note{
             width:97.5%;
        }


        .tbl-AdvSearch{
            width:100%;
        }
        .td-AdvSearch-Level {
            width: 18%;
            text-align: right;
            font-weight: bold;
        }

        .td-AdvSearch-Input {
            width: 82%;
        }

        .td-AdvSearch-Input select {
            width: 98%;
        }

        .td-AdvSearch-Input .textSearch {
            width: 96%;
        }

        .td-AdvSearch-Input .pickersearch {
            width: 84%;
        }
        .region-parent{
        float:left; width:100%;
        }
        .region-child{
            float:left; width:50%;
        }
        .cbo-styler{
            width:98%;
         }
    </style>



    <script type="text/javascript">
    var _sBaseAddress = "";
    var _oRouteSheets = [];
    var _oRouteSheet = null;
    var _nProductID=0;
    var _nLotID=0;
    var _sProductIDs="";
    var _sLotIDs="";

    $(document).ready(function () {
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheets =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var o =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Employees));
        var oWorkingUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        var oEmployees =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Employees));
        var oCompareOperators=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumCompareOperators));
        $('.number').icsCurrencyBox();
        DynamicRefreshList(_oRouteSheets, 'tblRouteSheet');
        $('#dtFrom').datebox('setValue', icsdateformat(new Date()));


        $("#cboStore-Adv").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:"Default"
        });
        
        $("#cboDateCompare-Adv").icsLoadCombo({
            List: oCompareOperators,
            OptionValue: "Value",
            DisplayText: "Text",
            InitialValue:""
        });

        $("#cboStore").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:""
        });
        
        $("#cboBatchman").icsLoadCombo({
            List: oEmployees,
            OptionValue: "EmployeeID",
            DisplayText: "Name",
            InitialValue:""
        });
        sessionStorage.setItem("Params", "");
        $.icsMakeFooterColumn('tblRouteSheet',['EventTimeStr','Qty']);
    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });



    /*.......... Searching ............. */


    $("#txtRouteSheetNo").keyup(function (e) {
        var oRouteSheets =[];
        var keyCode = e.keyCode || e.which;
        $('#txtRouteSheetNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if (!$.trim($("#txtRouteSheetNo").val()).length) {

                alert("Please enter routesheet no to search.");
                $('#txtRouteSheetNo').focus();
                $('#txtRouteSheetNo').val("");
                return;
            }
            else { $('#txtRouteSheetNo').removeClass("errorFieldBorder"); }

            var oRouteSheet={
                //Params:   $.trim($("#txtRouteSheetNo").val())+'~'+ 0+ '~'+ $('#dtFrom').datebox('getValue')
                Params:  $.trim($("#txtRouteSheetNo").val())+"~"+0+'~'+ "" +'~'+ "" +'~'+ 0+ '~'+ icsdatetimeformat(new Date()) +'~'+ icsdatetimeformat(new Date())
            };
            GetsRouteSheet(oRouteSheet, 'GetsYarnOut',false);
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oRouteSheets.length;++i)
            {
                sTempName=oRouteSheets[i]['RouteSheetNo'];
                if(sTempName.toUpperCase().indexOf($('#txtRouteSheetNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oRouteSheets[i]);
                }
            }
            $('#tblRouteSheet').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oRouteSheets, "tblRouteSheet");}
            else { DynamicRefreshList(oSearchedData, "tblRouteSheet"); }

        }
    });

    

    function GetsRouteSheet(oRouteSheet, sActionName ,bIsAdvSearch) {

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: sActionName,
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs != null) {
                if (response.objs.length > 0) {
                    if(response.objs[0].RouteSheetID>0){
                        _oRouteSheets=response.objs;
                        DynamicRefreshList(response.objs, "tblRouteSheet");
                        $.icsMakeFooterColumn('tblRouteSheet',['EventTimeStr','Qty']);
                        if(response.objs.length > 0)
                            $("#winAdvanceSearch").icsWindow("close");
                    }
                    else{
                        DynamicRefreshList([], "tblRouteSheet"); alert(response.objs[0].ErrorMessage);
                        $.icsMakeFooterColumn('tblRouteSheet',['EventTimeStr','Qty']);
                    }
                }
                else { 
                    DynamicRefreshList([], "tblRouteSheet"); alert("No RouteSheet found.");
                    $.icsMakeFooterColumn('tblRouteSheet',['EventTimeStr','Qty']);
                }
            }
        });
    }


    /*..........Adv Searching ............. */

    function ResetAdvSearchPicker(){
        _sProductIDs="";
        _sLotIDs="";
        $("#cboStore-Adv, #cboDateCompare-Adv").val(0);
        $('#txtProduct-Adv,#txtLot-Adv').val("");
        $('#dtYarnOutFrom-Adv, #dtYarnOutTo-Adv').datebox('setValue', icsdateformat(new Date()));
        $('#tpStartTime').timespinner('setValue', 0+":"+0);
        $('#tpEndTime').timespinner('setValue', 0+":"+0);
    }

    $("#btnAdvSearch").click(function (e) {
        ResetAdvSearchPicker();
        $("#winAdvanceSearch").icsWindow("open", "Adv Search");
    });

    $("#btnSearchOk").click(function (e) {

        if($("#cboStore-Adv").val()<=0 && _sProductIDs =="" && _sLotIDs=="" &&  $("#cboDateCompare-Adv").val()<=0 ){
            alert("No searching criteria found to search.");
            return false;
        }

        var dStartDate =$('#dtYarnOutFrom-Adv').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var dEndtDate =$('#dtYarnOutTo-Adv').datebox('getValue');
        var EndtTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndtTime.split(':');
        var hEndtTime= parseFloat(sTime[0]);
        var mEndtTime= parseFloat(sTime[1]);
        dEndtDate = new Date(dEndtDate);
        dEndtDate.setHours(hEndtTime);
        dEndtDate.setMinutes(mEndtTime);

        var oRouteSheetYarnOut={
            Params:  "~"+$("#cboStore-Adv").val()+'~'+ _sProductIDs +'~'+ _sLotIDs +'~'+ $("#cboDateCompare-Adv").val()+ '~'+ icsdatetimeformat(dStartDate) +'~'+ icsdatetimeformat(dEndtDate)
            //Params:  "~"+$("#cboStore-Adv").val()+'~'+ _sProductIDs +'~'+ _sLotIDs +'~'+ $("#cboDateCompare-Adv").val()+ '~'+ $('#dtYarnOutFrom-Adv').datebox('getValue') +'~'+ $('#dtYarnOutTo-Adv').datebox('getValue')
        };
        sessionStorage.setItem("Params", oRouteSheetYarnOut.Params);
        GetsRouteSheet(oRouteSheetYarnOut, 'GetsYarnOutAdv',true);
    });

    $('#btnSearch').click(function(e){

      
        _sProductIDs="";
        _sLotIDs="";
        var oRouteSheetYarnOut={
            Params:   $.trim($("#txtRouteSheetNo").val())+'~'+0+'~'+ _sProductIDs +'~'+ _sLotIDs +'~'+ 1+ '~'+ $('#dtFrom').datebox('getValue')+'~'+ $('#dtFrom').datebox('getValue')
        };
        sessionStorage.setItem("Params", oRouteSheetYarnOut.Params);
        GetsRouteSheet(oRouteSheetYarnOut, 'GetsYarnOut' ,false) ;
    });

    $("#btnSearchClose").click(function (e) {
        $("#winAdvanceSearch").icsWindow("close");
    });

    $("#btnReset-Adv").click(function (e) {
        ResetAdvSearchPicker();
    });

    /*-------------Yarn Out---------*/

    function ResetYarnOut(){
        _nProductID=0;
        _nLotID=0;
        $('#winYarnOut input').val("");
        $('#winYarnOut select').val(0);
    }

    $("#btnAdd").click(function (e) {
        ResetYarnOut();
        $("#winYarnOut").icsWindow("open", "Yarn Out");
    });


    $("#btnExcel").click(function (e) {
        
        var oRows=$('#tblRouteSheet').datagrid('getRows');
        if(oRows.length<=0){
            alert("No items found in the list."); return false;
        }
        var sIDs="";
        for(var i=0; i<oRows.length;i++){
            sIDs=sIDs+oRows[i].RouteSheetID+',';
        }
        sIDs=sIDs.substring(0,sIDs.length-1);

        var nts=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/ExcelYarnOut?sIDs="+sIDs+"&nts="+nts, "_blank");
        
    });

    $('#btnPrint').click(function (e)
    {
      
       var sParams=sessionStorage.getItem("Params");
       window.open(_sBaseAddress+ "/RouteSheet/Print_YarnOut?sParams="+sParams, "_blank");
        
    });


    $("#btnCloseYarnOut").click(function (e) {
        $("#winYarnOut").icsWindow("close");
    });


    function Validation()
    {
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            $('#txtRSNo').focus();
            $('#txtRSNo').addClass("errorFieldBorder");
            alert('No Routesheet Found.');
            return false;
        }
        else{
            $('#txtRSNo').removeClass("errorFieldBorder");
        }

        //if($('#cboBatchman').val()<=0){
        //    $('#cboBatchman').focus();
        //    $('#cboBatchman').addClass("errorFieldBorder");
        //    alert('Select Batchman.');
        //    return false;
        //}
        //else{
        //    $('#cboBatchman').removeClass("errorFieldBorder");
        //}
        return true;
    }

    $("#btnSaveYarnOut").click(function (){
        debugger;
        if(!Validation()) return false;

        _oRouteSheet.ProductID_Raw=(_nProductID>0) ?_nProductID: _oRouteSheet.ProductID_Raw;
        _oRouteSheet.LotID=(_nLotID>0) ?_nLotID: _oRouteSheet.LotID;
        _oRouteSheet.Note=$.trim($('#txtNote').val());
        _oRouteSheet.Params= $('#cboBatchman').val();


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: _oRouteSheet,
            ObjectId: 0,
            ControllerName: "RouteSheet",
            ActionName: "RouteSheetYarnOut",
            TableId: "",
            IsWinClose: true,
            Message: "Yarn Out Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) {
                    var oRouteSheetYarnOut={
                            RouteSheetID : response.obj.RouteSheetID,
                            RouteSheetNo : response.obj.RouteSheetNo,
                            Qty : response.obj.Qty,
                            RSState : response.obj.RSState,
                            ProductCode : response.obj.ProductCode,
                            ProductName : response.obj.ProductName,
                            LotNo : response.obj.LotNo,
                            RSStateStr : response.obj.RSStateStr,
                            EventTimeStr : response.obj.RSSateDateStr,
                            ProductName : response.obj.ProductName,
                            WUName : $('#cboStore option:selected').text(),
                    };
                    
                    $('#tblRouteSheet').datagrid('appendRow',oRouteSheetYarnOut);
                    ResetYarnOut();
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    function ValidationRouteSheet(){
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            $('#txtRSNo').focus();
            $('#txtRSNo').addClass("errorFieldBorder");
            alert('No Routesheet Found.');
            return false;
        }
        else{
            $('#txtRSNo').removeClass("errorFieldBorder");
        }
        return true;
    }

    /*----------Routesheet Pick----------------*/

    $("#txtRSNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtRSNo").val());
            //if(sRouteSheetNo==""){ alert("Type routesheet no to search."); return false; }
            GetsRouteSheetForYarnOut(sRouteSheetNo);
        }
        else if(nkeyCode==8){
            $('#winYarnOut input').val('');
            $('#winYarnOut select').val(0);
            _oRouteSheet=null;
            _nLotID=0;
            _nProductID=0;
        }
    });
  
    $("#txtBatchNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtBatchNo").val());
            if(sRouteSheetNo==""){ alert("Type routesheet no to search."); return false; }
            GetsRouteSheetForYarnOut(sRouteSheetNo);
        }
        else if(nkeyCode==8){
            $('#winYarnOut input').val('');
            $('#winYarnOut select').val(0);
            _oRouteSheet=null;
            _nLotID=0;
            _nProductID=0;
        }
    });

    function GetsRouteSheetForYarnOut(sRouteSheetNo){

        debugger;
        var oRouteSheet = {
            RouteSheetNo:sRouteSheetNo
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsRouteSheetForYarnOut",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "RouteSheet No", width: 140, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNoFull", title: "OrderNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 90, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MachineName", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRouteSheetPicker',
                        winclass:'clsRouteSheetPicker',
                        winwidth: 450,
                        winheight: 460,
                        tableid: 'tblRouteSheetPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'RouteSheetNo',
                        windowTittle: 'RouteSheet List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeRouteSheetPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No routesheet found.");
            }
        });


    }

    function IntializeRouteSheetPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            RouteSheetSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                RouteSheetSelect(oPickerobj);
            }
        });
    }

    function RouteSheetSelect(oPickerobj){
        var oRouteSheet = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winRouteSheetPicker')
        {
            if(oRouteSheet !=null  && oRouteSheet.RouteSheetID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                //$('#cboStore').val(oRouteSheet.WorkingUnitID);
                $('#txtRSNo').val(oRouteSheet.RouteSheetNo);
                $('#txtBatchNo').val(oRouteSheet.RouteSheetNo);
                $('#txtRSState').val(oRouteSheet.RSStateStr);
               
                $('#txtProduct').val(oRouteSheet.ProductName_Raw);
                $('#txtLot').val(oRouteSheet.LotNo);
                $('#txtQty').val(formatPrice(oRouteSheet.Qty));
                $('#txtOrderNo').val(oRouteSheet.OrderNoFull);
                
                _oRouteSheet= oRouteSheet;
                _nLotID=oRouteSheet.LotID;
                _nProductID=oRouteSheet.ProductID_Raw;
            }
            else{
                alert("Please select routesheet.");
            }
        }
    }


    /*----------Product Pick----------------*/

    function ResetProduct(bReset){
        if(bReset && _oRouteSheet!=null && _oRouteSheet.RouteSheetID>0)
        {
            _nProductID=_oRouteSheet.ProductID_Raw;
            $('#txtProduct').val(_oRouteSheet.ProductName);
        }
        else
        {
            _nProductID=0;
            $('#txtProduct').val("");
        }
    }
 
    $("#btnResetProduct").click(function () {
        ResetProduct(true);
        ResetLot(true);
    });

    $("#btnPickProduct").click(function () {
        if(!ValidationRouteSheet()) return;
        var sProductName=$.trim($("#txtProduct").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        GetProducts(sProductName, false);
    });

    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(!ValidationRouteSheet()) return;
            var sProductName=$.trim($("#txtProduct").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName, false);
        }
        else if(nkeyCode==8){
            ResetProduct(false);
            ResetLot(false);
        }
    });


    $("#btnResetProduct-Adv").click(function () {
        _sProductIDs="";
        $("#txtProduct-Adv").val("");
    });

    $("#btnPickProduct-Adv").click(function () {
        var sProductName=$.trim($("#txtProduct-Adv").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        GetProducts(sProductName, true);
    });

    $("#txtProduct-Adv").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct-Adv").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName, true);
        }
        else if(nkeyCode==8){
            _sProductIDs="";
            $("#txtProduct-Adv").val("");
        }
    });


    function GetProducts(sProductName, bIsMultiple){

        var oProduct = {
            BUID:1,
            ProductName:sProductName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bIsMultiple,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeProductPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }

    function IntializeProductPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            ProductSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ProductSelect(oPickerobj);
            }
        });
    }

    function ProductSelect(oPickerobj){
       
        
        if (oPickerobj.winid == 'winProductPicker')
        {
            if(oPickerobj.multiplereturn)
            {
                var oProducts = $('#'+oPickerobj.tableid).datagrid('getChecked');
                if(oProducts.length>0){
                    for(var i=0;i<oProducts.length;i++){
                        _sProductIDs=_sProductIDs + oProducts[i].ProductID+',';
                    }
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    $('#txtProduct-Adv').val((oProducts.length>1)? oProducts.length + " Product selected" : oProducts[0].ProductName);
                    _sProductIDs=_sProductIDs.substring(0,_sProductIDs.length-1);
                    
                }
                else{
                    alert("Please select product.");
                }
            }
            else{
                var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
                if(oProduct !=null  && oProduct.ProductID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    $('#txtProduct').val(oProduct.ProductNameCode);
                    _nProductID= oProduct.ProductID;

                }
                else{
                    alert("Please select product.");
                }
            }
           
        }
    }


    /*----------Lot Pick----------------*/

    function ResetLot(bReset){
        if(bReset && _oRouteSheet!=null && _oRouteSheet.RouteSheetID>0)
        {
            _nLotID=_oRouteSheet.LotID;
            $('#txtLot').val(_oRouteSheet.LotNo);
        }
        else
        {
            _nLotID=0;
            $('#txtLot').val("");
        }
    }
    
    $("#btnResetLot").click(function () {
        ResetLot(true);
    });

    $("#btnPickLot").click(function () {
        if(!ValidationRouteSheet()) return;
        var sLotNo=$.trim($("#txtLot").val());
        if(sLotNo==""){ alert("Type lot no to search."); return false; }
        if($('#cboStore').val()==null || parseInt($('#cboStore').val())<=0){
            $('#cboStore').focus();
            $('#cboStore').addClass("errorFieldBorder");
            alert('No Store Found.');
            return false;
        }
        else{
            $('#cboStore').removeClass("errorFieldBorder");
        }
        GetLots(sLotNo, false);
    });

    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(!ValidationRouteSheet()) return;
            var sLotNo=$.trim($("#txtLot").val());
            if(sLotNo==""){ alert("Type lot no to search."); return false; }
            if($('#cboStore').val()==null || parseInt($('#cboStore').val())<=0){
                $('#cboStore').focus();
                $('#cboStore').addClass("errorFieldBorder");
                alert('No Store Found.');
                return false;
            }
            else{
                $('#cboStore').removeClass("errorFieldBorder");
            }
            GetLots(sLotNo, false);
        }
        else if(nkeyCode==8){
            ResetLot(false);
        }
    });

    
     $("#btnResetLot-Adv").click(function () {
         _sLotIDs="";
         $("#txtLot-Adv").val("");
    });

     $("#btnPickLot-Adv").click(function () {
         var sLotNo=$.trim($("#txtLot-Adv").val());
        if(sLotNo==""){ alert("Type lot no to search."); return false; }
        GetLots(sLotNo, true);
    });

     $("#txtLot-Adv").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLotNo=$.trim($("#txtLot-Adv").val());
            if(sLotNo==""){ alert("Type lot no to search."); return false; }
            GetLots(sLotNo, true);
        }
        else if(nkeyCode==8){
            _sLotIDs="";
            $("#txtLot-Adv").val("");
        }
    });

   
     function GetLots(sLotNo,bIsMultiple){
         debugger;
         if($('#cboStore').val()==null || parseInt($('#cboStore').val())<=0){
             $('#cboStore').focus();
             $('#cboStore').addClass("errorFieldBorder");
             alert('No Store Found.');
             return false;
         }
         else{
             $('#cboStore').removeClass("errorFieldBorder");
         }

         if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
             $('#txtRSNo').focus();
             $('#txtRSNo').addClass("errorFieldBorder");
             alert('No Routesheet Found.');
             return false;
         }
         else{
             $('#txtRSNo').removeClass("errorFieldBorder");
         }

         var oRouteSheet = {
             RouteSheetID:_oRouteSheet.RouteSheetID,
            ProductID_Raw:_nProductID,
            LotNo:sLotNo,
            WorkingUnitID: $('#cboStore').val()
        };

         if( parseInt(oRouteSheet.WorkingUnitID)<=0){
            $('#cboStore').focus();
            $('#cboStore').addClass("errorFieldBorder");
            alert('No Store Found.');
            return ;
        }
        else{
            $('#cboStore').removeClass("errorFieldBorder");
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsLotForRS",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "Lot No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 180, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Balance", title: "Qty", width: 80, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "LotStatusSt", title: "Running", width:30, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 70, align: "left"};tblColums.push(oColumn);
                    oColumn = { field: "OperationUnitName", title: "Store", width: 70, align: "left"};tblColums.push(oColumn);


                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: (bIsMultiple)?500:450,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bIsMultiple,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeLotPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No lot found.");
            }
        });
    }

     function IntializeLotPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            LotSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                LotSelect(oPickerobj);
            }
        });
    }

     function LotSelect(oPickerobj){
        
        if (oPickerobj.winid == 'winLotPicker')
        {
            if(oPickerobj.multiplereturn)
            {
                var oLots = $('#'+oPickerobj.tableid).datagrid('getChecked');
                if(oLots.length>0){
                    for(var i=0;i<oLots.length;i++){
                        _sLotIDs=_sLotIDs + oLots[i].LotID+',';
                    }
                    
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    _sLotIDs=_sLotIDs.substring(0,_sLotIDs.length-1);
                    $('#txtLot-Adv').val((oLots.length>1)? oLots.length + " Lot selected" : oLots[0].LotNo);

                }
                else{
                    alert("Please select lot.");
                }
            }
            else{
                var oLot = $('#'+oPickerobj.tableid).datagrid('getSelected');
                if(oLot !=null  && oLot.LotID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    $('#txtLot').val(oLot.LotNo);
                    _nLotID= oLot.LotID;
                }
                else{
                    alert("Please select lot.");
                }
            }
        }
    }


</script>
