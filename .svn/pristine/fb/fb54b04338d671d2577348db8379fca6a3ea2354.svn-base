@{
    ViewBag.Title = "RouteSheet Cancel";
}

@model IEnumerable<ESimSol.BusinessObjects.RouteSheetCancel>

    <head>
        <title>Route Sheet Cancel</title>
    </head>

    <body>
        <div id="region-error">
            <center style="font-size:20px;">
                @Html.ValidationMessage("Error")
            </center>
        </div>
    
       <div class="menuMainCollectionTable">
           <table id="tblRouteSheetCancel" title="Route Sheet List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" showfooter="true" toolbar="#toolbarRouteSheet">
               <thead>
                   <tr>
                       <th field="RouteSheetNo" width="10%">Batch/Lot No</th>
                       <th field="OrderNo" width="10%">Order No</th>
                       <th field="LotNo" width="10%">Raw Lot No</th>
                       <th field="Qty" align="right" formatter="formatPrice" width="10%">Qty</th>
                       <th field="IsNewLotStr" width="14%">Assign Lot</th>
                       <th field="StoreName" width="25%">Store</th>
                       <th field="ContractorName" width="25%">Customer</th>
                       <th field="BuyerName" width="25%">Buyer</th>
                       <th field="RequestedByName" width="20%">Requested By</th>
                       <th field="ApprovedByName" width="20%">Approved By</th>
                   </tr>
               </thead>
           </table>

            <div id="toolbarRouteSheet">
                <input type="text" id="txtRouteSheetNo" placeholder="Search by Batch/DL No" style="width:12%;" />
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
                <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approve</a>
                <a id="btnPrintList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print List</a>
                <a id="btnExcelList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">XL</a>
            </div>
        </div>

        <div id="winRouteSheetCancel" class="easyui-window winstyle" title="RouteSheet Cancel" style="width:700px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 100%; font-family: Tahoma;">

                <fieldset>
                    <legend>RouteSheet info</legend>
                    <table class="tbl-Win" cellpadding="2">
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>RouteSheet No :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <input id="txtRSNo" class="reset-text txt-styler" placeholder="Search RouteSheet" />
                            </td>
                            <td class="td-styler td-col-4 align-right">
                                <label>Status :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblRSState" class="reset-lbl"></label>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>PI/ Sample :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblPISample" class="reset-lbl"></label>
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Store :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblStore" class="reset-lbl"></label>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Yarn :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblYarn" class="reset-lbl"></label>
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Lot :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblLot" class="reset-lbl"></label>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Color :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblColor" class="reset-lbl"></label>
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Color Shade :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblColorShade" class="reset-lbl"></label>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Qty :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblQty" class="reset-lbl"></label>
                            </td>
                            <td class="td-col-4 align-right">
                                <label id="lblHanksCone">No of Bales :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <label id="lblBalesCone" class="reset-lbl"></label>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                
                <fieldset>
                    <legend>Cancel Info</legend>
                    <table class="tbl-Win" cellpadding="2">
                        <tr>
                            <td class="td-col-2 align-right"></td>
                            <td class="td-col-8 align-right">
                                <input type="checkbox" id="chkMainLot" />
                                <span> <label>Goto Main Lot</label> </span>
                                <input type="checkbox" id="chkNewLot" />
                                <span> <label>Select a Store</label> </span>
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Receive Store :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <select id="cboStore" class="cbo-styler reset-select"></select>
                            </td>
                        </tr>
                    </table>

                    <table class="tbl-Win" cellpadding="2">
                        <tr>
                            <td class="td-col-4 align-right">
                                <label>Re-Dyeing Status :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <select id="cboReDyeingStatus" class="cbo-styler reset-select"></select>
                            </td>
                            <td class="td-col-4 align-right">
                                <label>Note :</label>
                            </td>
                            <td class="td-styler td-col-6">
                                <input id="txtRemarks" class="reset-text txt-styler-Note" /> 
                            </td>
                        </tr>
                        <tr class="region-approval">
                            <td class="td-col-3 align-right">
                                <label>Comment :</label>
                            </td>
                            <td class="td-styler td-col-17" colspan="3">
                                <input id="txtApprovalRemarks" class="reset-text txt-styler-Note" />
                            </td>
                        </tr>
                    </table>
                </fieldset>
      
                <fieldset>
                    <legend>Action</legend>
                    <table class="tbl-Win" cellpadding="2">
                        <tr>
                            <td class="align-left td-col-6">
                                <label id="lblRequestedBy" class="reset-lbl"></label>
                            </td>
                            <td class="align-left td-col-6">
                                <label id="lblApprovedBy" class="reset-lbl"></label>
                            </td>
                            <td class="align-right td-col-8">
                                 
                                <a id="btnDone" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Done</a>
                                <a id="btnFreeze" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-freeze" plain="true">Freeze</a>

                                <a id="btnSaveRouteSheetCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                <a id="btnCloseRouteSheetCancel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>

            </div>
        </div>

        <div id="winAdvanceSearch" class="easyui-window winClass" style=" width:500px;" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%;">
                <tr>
                    <td>
                        <fieldset style="margin-bottom: 0px;">
                            <legend>Searching Criteria</legend>
                            <table>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Waiting for Approve : </label>
                                    </td>
                                    <td colspan="3" style="width:70%;text-align:left;">
                                        <input type="checkbox" id="chkInilialized" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Return Date : </label>
                                    </td>
                                    <td colspan="3">
                                        <select id="cboDateCompareAdv" style="width:26%;height:22px;" class="cbo-styler" onclick="DateActions_ReturnDateAdv()" ></select>
                                        <input id="dtFromAdv" type="text" style="width: 33%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="dtToAdv" type="text" style="width: 33%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Batch No : </label>
                                    </td>
                                    <td colspan="3" style="width:70%;text-align:left;">
                                        <input id="txtBatchNoAdv" type="text" style="width:98%" />
                                    </td>
                                </tr>
                                <tr>
                                    <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Order No : </label>
                                    </td>
                                    <td colspan="3" style="width:70%;text-align:left;">
                                        <input id="txtOrderNoAdv" type="text" style="width:98%" />
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td height="5px" colspan="4"></td>
                                </tr>
                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
                <a id="btnResetAdv" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                <a id="btnSearchOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                <a id="btnSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>

    </body>

    <style type="text/css">
        .header-text {
            font-weight: bold;
        }

        .tbl-Win{
            width:100%;
        }
        .td-styler input, select {
            padding-left: 5px;
        }
        .txt-styler{
            width:95%;
        }
        .txt-styler-picker{
            width:65%;
        }
        .cbo-styler{
            width:98%;
        }
        .txt-styler-Note{
             width:98%;
        }

        .tbl-AdvSearch{
            width:100%;
        }
        .td-AdvSearch-Level {
            width: 25%;
            text-align: right;
            font-weight: bold;
        }
        .td-AdvSearch-Input {
            width: 79%;
        }
    </style>

    <script type="text/javascript">

    var _sBaseAddress="";
    var _oRouteSheet=null;
    var _oRouteSheetCancel=null;
    var _oRouteSheetCancels=null;
    var _bIsNewLot=false;
    var _nSelectedRowIndex = -1;

    $(document).ready(function ()
    {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheetCancels =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var IsError =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.IsError));
        var oWorkingUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        var oCompareOperators=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumCompareOperators));
        var oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        var oReDyeingStatusList =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.ReDyeingStatusList));

        RefreshControlLayout(oAuthorizationRolesMapping);
        if(IsError)
        {
            $(".menuMainCollectionTable div,fieldset").not('#region-error').hide();
            $('#Mainlayout').layout('collapse', 'west');
            $('#region-error').css({height:"100%", width:"100%", 'line-height':"500px"});
        }
        $("#cboStore").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:"Default"
        });
        $("#cboDateCompareAdv").icsLoadCombo({
            List: oCompareOperators,
            OptionValue: "Value",
            DisplayText: "Text"
        });
        $("#cboReDyeingStatus").icsLoadCombo({
            List: oReDyeingStatusList,
            OptionValue: "id",
            DisplayText: "Value"
        });
        DynamicRefreshList(_oRouteSheetCancels,'tblRouteSheetCancel');
        $.icsMakeFooterColumn('tblRouteSheetCancel',['','Qty']);

    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


    $('#tblRouteSheetCancel').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData) {
        debugger;
        $('#btnEdit,#btnDelete,#btnApprove,#btnFreeze').hide();
        if (rowData != null && rowData.ApproveBy == 0) {
            $('#btnEdit,#btnDelete,#btnApprove, #btnFreeze').show();
        }
    }
    function RefreshControlLayout(oAuthorizationRolesMapping)
    {

        $("#btnAdd,#btnEdit,#btnView,#btnDelete,#btnApprove").hide();

        if (PermissionChecker('Add', 'RouteSheetCancel',oAuthorizationRolesMapping)) {$("#btnAdd").show();}
        if (PermissionChecker('Edit', 'RouteSheetCancel',oAuthorizationRolesMapping)) {$("#btnEdit").show();}
        if (PermissionChecker('View', 'RouteSheetCancel',oAuthorizationRolesMapping)) {$("#btnView").show();}
        if (PermissionChecker('Delete', 'RouteSheetCancel',oAuthorizationRolesMapping)) {$("#btnDelete").show();}
        if (PermissionChecker('Approved', 'RouteSheetCancel',oAuthorizationRolesMapping)) {$("#btnApprove").show();}

    }
    /*.......... Searching ............. */
    $("#txtRouteSheetNo").keyup(function (e) {
        var oRouteSheetCancels =[];
        var keyCode = e.keyCode || e.which;
        $('#txtRouteSheetNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oRouteSheetCancels = _oRouteSheetCancels; }
        else{ oRouteSheetCancels = $('#tblRouteSheetCancel').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if($.trim($("#txtRouteSheetNo").val()).length == 0){
                alert("Please enter routesheet no to search!!");
                $('#txtRouteSheetNo').focus();
                $('#txtRouteSheetNo').val("");
                return;
            }
            //if (!$.trim($("#txtRouteSheetNo").val()).length || $.trim($("#txtRouteSheetNo").val()).length<4) {

            //    alert((($.trim($("#txtRouteSheetNo").val()).length>0)?"At least 4 characters need to search" :"Please enter routesheet no to search."));
            //    $('#txtRouteSheetNo').focus();
            //    $('#txtRouteSheetNo').val("");
            //    return;
            //}
            //else { $('#txtRouteSheetNo').removeClass("errorFieldBorder"); }


            var oRouteSheetCancel={
                RouteSheetNo: $.trim($("#txtRouteSheetNo").val()),
                Params:  false +'~'+ 0 + '~'+ icsdateformat(new Date()) + '~'+ icsdateformat(new Date())+ '~'+""
            };
            GetsRouteSheet(oRouteSheetCancel, 'GetsRouteSheetCancel' ,false) ;
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oRouteSheetCancels.length;++i)
            {
                sTempName=oRouteSheetCancels[i]['RouteSheetNo'];
                if(sTempName.toUpperCase().indexOf($('#txtRouteSheetNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oRouteSheetCancels[i]);
                }
            }
            $('#tblRouteSheetCancel').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oRouteSheetCancels, "tblRouteSheetCancel");}
            else { DynamicRefreshList(oSearchedData, "tblRouteSheetCancel"); }

        }
    });

    function GetsRouteSheet(oRouteSheetCancel, sActionName ,bIsAdvSearch) {

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetCancel,
            ControllerName: "RouteSheet",
            ActionName: sActionName,
            IsWinClose: bIsAdvSearch
        };
        $(".lblLoadingMessage").show();
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs != null) {
                if (response.objs.length > 0) {
                    if(response.objs[0].RouteSheetID>0){
                        _oRouteSheetCancels=response.objs;
                        DynamicRefreshList(response.objs, "tblRouteSheetCancel");
                        $.icsMakeFooterColumn('tblRouteSheetCancel',['','Qty']);
                        $("#winAdvanceSearch").icsWindow("close");
                    }
                    else{DynamicRefreshList([], "tblRouteSheetCancel"); alert(response.objs[0].ErrorMessage);}
                }
                else { DynamicRefreshList([], "tblRouteSheetCancel"); alert("No RouteSheet found."); }
            }
            $(".lblLoadingMessage").hide();
        });
    }

        /*..........Adv Searching ............. */
    function DateActions_ReturnDateAdv() {
        DynamicDateActions("cboDateCompareAdv", "dtFromAdv", "dtToAdv");
    }
    function ResetAdvSearchPicker(){
        $('#chkInilialized').prop('checked',false);
        $("#cboDateCompareAdv").val(0);
        //$('#dtFromAdv, #dtToAdv').datebox('setValue', icsdateformat(new Date()));        
        $(".lblLoadingMessage").hide();
        $("#winAdvanceSearch input").not("input[type='button']").val("");
        $("#txtBatchNoAdv,#txtOrderNoAdv").val("");
        $("#dtFromAdv,#dtToAdv").datebox({ disabled: true });
        $("#dtFromAdv,#dtToAdv").datebox("setValue", icsdateformat(new Date()));
    }
    $("#btnAdvSearch").click(function (e) {
        ResetAdvSearchPicker();
        $("#winAdvanceSearch").icsWindow("open", "Adv Search");
    });
    $("#btnSearchOk").click(function (e) {

        if(!$('#chkInilialized').is(':checked') && $("#cboDateCompareAdv").val()<=0 && $("#txtBatchNoAdv").val() == "" && $("#txtOrderNoAdv").val() == ""){
            alert("No searching criteria found to search.");
            return false;
        }

        var oRouteSheetCancel={
            RouteSheetNo: $("#txtBatchNoAdv").val(),
            Params: $('#chkInilialized').is(':checked') +'~'+ $("#cboDateCompareAdv").val()+ '~'+ $('#dtFromAdv').datebox('getValue')+'~'+ $('#dtToAdv').datebox('getValue')+'~'+ $("#txtOrderNoAdv").val()

        };
        GetsRouteSheet(oRouteSheetCancel, 'GetsRouteSheetCancel',false);
    });
    $("#btnSearchClose").click(function (e) {
        $("#winAdvanceSearch").icsWindow("close");
    });
    $("#btnResetAdv").click(function (e) {
        ResetAdvSearchPicker();
    });

    /*----------Routesheet Pick----------------*/
    function GetRouteSheet(oRouteSheet){
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetRouteSheet",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj.RouteSheetID>0) {
                RefreshControlRouteSheet(response.obj);
            }
            else{
                ResetRouteSheetCancel();
                alert("Please refresh & try again.");
            }
        });
    }
    $("#txtRSNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtRSNo").val());
            if(sRouteSheetNo==""){ alert("Type routesheet no to search."); return false; }
            GetsRouteSheetForCancel(sRouteSheetNo);
        }
        else if(nkeyCode==8){
            ResetRouteSheetCancel();
        }
    });
    function GetsRouteSheetForCancel(sRouteSheetNo){

        debugger;
        var oRouteSheet = {
            RouteSheetNo:sRouteSheetNo
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsRouteSheetForCancel",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "RouteSheet No", width: 140, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MachineName", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 90, align: "right", formatter:formatPrice };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRouteSheetPicker',
                        winclass:'clsRouteSheetPicker',
                        winwidth: 450,
                        winheight: 460,
                        tableid: 'tblRouteSheetPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'RouteSheetNo',
                        windowTittle: 'RouteSheet List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeRouteSheetPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No routesheet found.");
            }
        });


    }
    function IntializeRouteSheetPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            RouteSheetSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                RouteSheetSelect(oPickerobj);
            }
        });
    }
    function RouteSheetSelect(oPickerobj){
        var oRouteSheet = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winRouteSheetPicker')
        {
            if(oRouteSheet !=null  && oRouteSheet.RouteSheetID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                GetRouteSheet(oRouteSheet);
            }
            else{
                alert("Please select routesheet.");
            }
        }
    }

    /*----------Routesheet Cancel----------------*/
    $('#chkNewLot').change(function(e){
        if($('#chkNewLot').is(':checked')){
            $('#chkMainLot').prop('checked',false);
            $('#cboStore').prop('disabled',false);
            _bIsNewLot=true;
        }
        else{
            $('#chkMainLot').prop('checked',true);
            $('#cboStore').val(0);
            $('#cboStore').prop('disabled',true);
            _bIsNewLot=false;
        }
    });
    $('#chkMainLot').change(function(e){

        if($('#chkMainLot').is(':checked')){
            $('#chkNewLot').prop('checked',false);
            $('#cboStore').val(0);
            $('#cboStore').prop('disabled',true);
            _bIsNewLot=false;
        }
        else{
            $('#chkNewLot').prop('checked',true);
            $('#cboStore').prop('disabled',false);
            _bIsNewLot=true;
        }

    });
    function ResetRouteSheetCancel(){
        _oRouteSheet=null;
        _oRouteSheetCancel=null;
        _bIsNewLot=false;
        $('#winRouteSheetCancel input,select').prop('disabled',false);

        $('#winRouteSheetCancel .reset-text').val("");
        $('#winRouteSheetCancel .reset-lbl').text("");
        $('#winRouteSheetCancel .reset-select').val(0);

        $('#chkMainLot').prop('checked',true);
        $('#chkNewLot').prop('checked',false);
        $('#cboStore').prop('disabled',true);
        $('.region-approval').hide();
        $('#btnDone, #btnFreeze').hide();
        $('#btnSaveRouteSheetCancel').show();
        $('#cboReDyeingStatus').val();
    }
    function RefreshControlRouteSheet(oRouteSheet){

        debugger;
        _oRouteSheet=oRouteSheet;
        $('#txtRSNo').val(oRouteSheet.RouteSheetNo);
        $('#lblRSState').text(oRouteSheet.RSStateStr);

        $('#lblPISample').text(oRouteSheet.PTU.OrderNo);
        $('#lblStore').text(oRouteSheet.StoreName);

        $('#lblYarn').text(oRouteSheet.ProductName);
        $('#lblLot').text(oRouteSheet.LotNo);

        $('#lblColor').text(oRouteSheet.PTU.ColorNo);
        $('#lblColorShade').text(oRouteSheet.PTU.ColorNameShade);

        $('#lblQty').text( formatPrice(oRouteSheet.Qty) +" kg   or  "+ formatPrice(GetLBS(oRouteSheet.Qty,2)) +" lbs");
        $('#lblHanksCone').text(((oRouteSheet.HanksCone)?"No of Bales :":"No of Cone :"));
        $('#lblBalesCone').text(formatPrice(oRouteSheet.NoOfHanksCone));
    }

    function RefreshControlRouteSheetCancel(oRouteSheetCancel, IsApprove, IsView){

        RefreshControlRouteSheet(oRouteSheetCancel.RouteSheet);
        _oRouteSheetCancel=oRouteSheetCancel;

        _bIsNewLot=oRouteSheetCancel.IsNewLot;
        if(oRouteSheetCancel.IsNewLot){
            $('#chkNewLot').prop('checked',true);
            $('#chkMainLot').prop('checked',false);
            $('#cboStore').prop('disabled',false);
        }
        else{
            $('#chkNewLot').prop('checked',false);
            $('#chkMainLot').prop('checked',true);
        }
        $('#cboStore').val(oRouteSheetCancel.WorkingUnitID);
        $('#cboReDyeingStatus').val(oRouteSheetCancel.ReDyeingStatus);
        $('#txtRemarks').val(oRouteSheetCancel.Remarks);
        $('#txtApprovalRemarks').val(oRouteSheetCancel.ApprovalRemarks);

        $('#lblRequestedBy').text("Requested By: "+ oRouteSheetCancel.RequestedByName);
        $('#lblApprovedBy').text(((oRouteSheetCancel.ApproveBy!=0)?"Approved By: "+ oRouteSheetCancel.ApprovedByName : ""));
        if(IsApprove){
            $('.region-approval').show();
            $('#btnDone, #btnFreeze').show();
            $('#btnSaveRouteSheetCancel').hide();
        }

        if(IsView){
            $('.region-approval').show();
            $('#btnDone, #btnFreeze,#btnSaveRouteSheetCancel').hide();
            $('#winRouteSheetCancel input,select').prop('disabled',true);
        }
    }

    function Validation(){
        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            $('#txtRSNo').focus();
            $('#txtRSNo').addClass("errorFieldBorder");
            alert('Routesheet required.');
            return false;
        }
        else{
            $('#txtRSNo').removeClass("errorFieldBorder");
        }
        if($('#chkMainLot').is(':checked')==false && $('#chkNewLot').is(':checked')==false)
        {
            $('#chkNewLot').focus();
            $('#chkNewLot').addClass("errorFieldBorder");
            alert('Please Checked one(Main lot or New Lot).');
            return false;
        }
        else{
            $('#chkNewLot').addClass("errorFieldBorder");
        }

        if($('#chkNewLot').is(':checked') && $('#cboStore').val()<=0){
            $('#cboStore').focus();
            $('#cboStore').addClass("errorFieldBorder");
            alert('Please select store.');
            return false;
        }
        else{
            $('#cboStore').removeClass("errorFieldBorder");
        }
        return true;
    }

    function RefreshObject(){
        var oRouteSheetCancel={
            RouteSheetID : (_oRouteSheetCancel==null || _oRouteSheetCancel.RouteSheetID<=0)? 0 : _oRouteSheet.RouteSheetID,
            IsNewLot : _bIsNewLot,
            WorkingUnitID : $('#cboStore').val(),
            Remarks : $.trim($('#txtRemarks').val()),
            ApprovalRemarks : $.trim($('#txtApprovalRemarks').val()),
            Params: (_oRouteSheetCancel==null || _oRouteSheetCancel.RouteSheetID<=0)? _oRouteSheet.RouteSheetID : "",
            ReDyeingStatus: $('#cboReDyeingStatus').val()
        };
        return oRouteSheetCancel;
    }

    function GetRouteSheetCancel(oRouteSheetCancel,sTitle, IsApprove, IsView){
        var obj =
       {
           BaseAddress: _sBaseAddress,
           Object: oRouteSheetCancel,
           ControllerName: "RouteSheet",
           ActionName: "GetRouteSheetCancel",
           IsWinClose: false
       };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) {
                    RefreshControlRouteSheetCancel(response.obj, IsApprove, IsView);
                    $("#winRouteSheetCancel").icsWindow("open", sTitle);
                }
                else { alert(response.obj.ErrorMessage); }
            }
        });
    }
    function Save(sActionName, IsApprove){

        if(IsApprove){
            if(!confirm('Are you sure to approve?')) return false;
        }
        if (!Validation()) return false;
        var oRouteSheetCancel=RefreshObject();
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetCancel,
            ObjectId: oRouteSheetCancel.RouteSheetID,
            ControllerName: "RouteSheet",
            ActionName: sActionName,
            TableId: 'tblRouteSheetCancel',
            IsWinClose: true,
            Message: (IsApprove)? "Approved Successfuly." : "Save Successfully."
        };

        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID>0) {
                    //if(_nSelectedRowIndex > -1)
                    //    $('#tblRouteSheetCancel').datagrid('updateRow',{ index: _nSelectedRowIndex, row: response.obj });
                    ResetRouteSheetCancel();
                    if(IsApprove){
                        OperationPerforms(-1,response.obj);
                    }
                }
            }
        });
    }
    function Delete(oRouteSheetCancel, sActionName, bIsWinOpen){
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetCancel,
            ControllerName: "RouteSheet",
            ActionName: sActionName,
            TableId: "tblRouteSheetCancel",
            IsWinClose: (bIsWinOpen)? true:false
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message =='deleted' && bIsWinOpen) {
                ResetRouteSheetCancel();
            }
        });
    }
    $("#btnAdd").click(function (e) {
        ResetRouteSheetCancel();
        _nSelectedRowIndex=-1;
        $("#winRouteSheetCancel").icsWindow("open", "Add Routesheet Cancel");
    });
    $('#btnEdit').click(function (e)
    {
        var oRouteSheetCancel=$('#tblRouteSheetCancel').datagrid('getSelected');
        _nSelectedRowIndex=$('#tblRouteSheetCancel').datagrid('getRowIndex',oRouteSheetCancel);
        if (oRouteSheetCancel==null || oRouteSheetCancel.RouteSheetID<=0) { alert('Please select an item from list.'); return false;}

        if(oRouteSheetCancel.ApproveBy!=0){
            alert("Already canceled"); return false;
        }
        ResetRouteSheetCancel();
        GetRouteSheetCancel(oRouteSheetCancel,"Edit Routesheet Cancel",false, false);

    });
    $('#btnDelete').click(function (e)
    {
        var oRouteSheetCancel=$('#tblRouteSheetCancel').datagrid('getSelected');
        _nSelectedRowIndex=$('#tblRouteSheetCancel').datagrid('getRowIndex',oRouteSheetCancel);
        if (oRouteSheetCancel==null || oRouteSheetCancel.RouteSheetID<=0) { alert('Please select an item from list.'); return false;}
        if(!confirm('Are you sure to delete?')) return false;
        Delete(oRouteSheetCancel,'DeleteRouteSheetCancel',false);
    });
    $('#btnView').click(function (e)
    {
        var oRouteSheetCancel=$('#tblRouteSheetCancel').datagrid('getSelected');
        _nSelectedRowIndex=$('#tblRouteSheetCancel').datagrid('getRowIndex',oRouteSheetCancel);
        if (oRouteSheetCancel==null || oRouteSheetCancel.RouteSheetID<=0) { alert('Please select an item from list.'); return false;}

        ResetRouteSheetCancel();
        GetRouteSheetCancel(oRouteSheetCancel,"View Routesheet Cancel",false, true);

    });
    $('#btnApprove').click(function (e)
    {
        var oRouteSheetCancel=$('#tblRouteSheetCancel').datagrid('getSelected');
        _nSelectedRowIndex=$('#tblRouteSheetCancel').datagrid('getRowIndex',oRouteSheetCancel);
        if (oRouteSheetCancel==null || oRouteSheetCancel.RouteSheetID<=0) { alert('Please select an item from list.'); return false;}

        if(oRouteSheetCancel.ApproveBy!=0){
            alert("Already canceled"); return false;
        }
        ResetRouteSheetCancel();
        GetRouteSheetCancel(oRouteSheetCancel,"Approval For Routesheet Cancel",true, false);

    });
    $("#btnSaveRouteSheetCancel").click(function (e) {
        Save('SaveRouteSheetCancel',false);
    });
    $("#btnDone").click(function (e) {
        Save('ApproveRouteSheetCancel',true);
    });
    $("#btnFreeze").click(function (e) {
        if(_oRouteSheetCancel==null || _oRouteSheetCancel.RouteSheetID<=0){
            alert("No routesheet found.");
            return false;
        }
        if(!confirm('Are you sure to freeze?')) return false;

        Delete(_oRouteSheetCancel,'DeleteRouteSheetCancel',true);
    });
    $("#btnCloseRouteSheetCancel").click(function (e) {
        $("#winRouteSheetCancel").icsWindow("close");
    });

    $('#btnPrintList').click(function(){
        debugger;
        var oRouteSheetCancels= $('#tblRouteSheetCancel').datagrid('getRows');
        if(oRouteSheetCancels.length<=0)
        {
            alert("Data not found ");
            return;
        }
        var sRouteSheetIDs = "";
        for(var i = 0;i<oRouteSheetCancels.length;i++)
        {
            sRouteSheetIDs+= oRouteSheetCancels[i].RouteSheetID+",";
        }
        sRouteSheetIDs = sRouteSheetIDs.substring(0, sRouteSheetIDs.length-1);
        var oRouteSheetCancel = {ErrorMessage:sRouteSheetIDs};
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/RouteSheet/SetRouteSheetData",
            traditional: true,
            data:  JSON.stringify(oRouteSheetCancel),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open (_sBaseAddress+ "/RouteSheet/PrintRouteSheetCancels");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $('#btnExcelList').click(function(){

        var oRouteSheetCancels= $('#tblRouteSheetCancel').datagrid('getRows');
        if(oRouteSheetCancels.length<=0)
        {
            alert("Data not found ");
            return;
        }
        var sRouteSheetIDs = "";
        for(var i = 0;i<oRouteSheetCancels.length;i++)
        {
            sRouteSheetIDs+= oRouteSheetCancels[i].RouteSheetID+",";
        }
        sRouteSheetIDs = sRouteSheetIDs.substring(0, sRouteSheetIDs.length-1);
        var oRouteSheetCancel = {ErrorMessage:sRouteSheetIDs};
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/RouteSheet/SetRouteSheetData",
            traditional: true,
            data:  JSON.stringify(oRouteSheetCancel),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open (_sBaseAddress+ "/RouteSheet/ExcelRouteSheetCancels");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    </script>
