@{
    ViewBag.Title = "Marketing Projection Report";
}
@model IEnumerable<ESimSol.BusinessObjects.MarketingAccount>
    <div class="menuMainCollectionTable">
        <div class="easyui-panel" fit="true" style="margin-left:0px; height:100%;width:100%">
            <table border="0" cellpadding="0" cellspacing="0" style="height:100%;width:100%;">
                <tr>
                    <td style="height:100%; width:18%">
                        <div style="height:99%;">
                            <table id="tblMarketingHeads" title="Group Head List" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarGroup">
                                <thead>
                                    <tr>
                                        <th field="Name" width="150" align="left"> Name </th>
                                    </tr>
                                </thead>
                            </table>   
                            <div id="toolbarGroup">
                                Searching By:<select id="cboMktType" style="width:120px;">
                                 <option value="1"selected>Mkt.Group wise</option>
                                 <option value="2">Mkt.Person wise</option>
                                </select>
                                <table>
                                    <!-- nothing -->
                                </table>
                            </div>                        
                        </div>
                    </td>
                    <td style="height:100%;width:80%">
                        <div style="height:99%;">
                            <table id="tblMktProjections" title="Marketing Projection Report" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
                                <thead>
                                  
                                </thead>
                            </table>   
                            <div id="toolbar">
                                <table>
                                    <tr>
                                        <td>
                                            Year: <input id="txtYear" type="text" style="width:70px" />
                                             View: <select id="cboReportType" style="width:100px">
                                                <option value="0" selected>All</option>
                                                <option value="1">Buyer Wise</option>
                                                <option value="2">Vendor Wise</option>
                                            </select>
                                            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Search</a>
                                            <a id="btnAddMktSale" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Mkt Projection</a>
                                            <a id="btnApproveMktSale" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approve Mkt Projection</a>
                                            <a id="btnPrintPDF" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                                            <a id="btnPrintExcel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Excel</a>
                                            <a id="btnMKTPersonWisePrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print Detail</a>
                                            <a id="btnMKTPersonWiseXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Detail XL</a>
                                            <a id="btnPrintSummary" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Summary</a>
                                        </td>
                                    </tr>
                                </table>
                            </div>                     
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <!--MARKETING Projection Setup-->
    <div id="winMktProjection" class="easyui-window winstyle" title="Add Mkt Projection" style=" height:auto;width:90%" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="overflow:hidden;display:block;">
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Add Marketing Projection</legend>
                <div style="overflow:hidden;display:block">                       
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:20%;text-align:right">
                           Mkt. Group:
                        </div>
                        <div style="overflow:hidden;float:left;width:80%">
                            <input id="txtMktPerson" type="text" style=" width:95%;" disabled />
                        </div>
                    </div>   
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:20%;text-align:right">
                            <label id="lblBuyer">Buyer:</label>                           
                        </div>
                        <div style="overflow:hidden;float:left;width:80%">
                            <input id="txtBuyer" type="text" style=" width:85%;" placeholder=" Write buyer type and press enter...." />
                            @*<input type="button"  id="BuyerPick" onclick="PickBuyer()"  value="Pick"/>*@
                        </div>
                    </div>                 
                </div>
                <div style="overflow:hidden;display:block">
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:20%;">
                           
                        </div>
                        <div style="overflow:hidden;float:right;width:80%">
                            <a id="btnPreviousMktSaleTarget" href="javascript:void(0)" class="easyui-linkbutton" class="easyui-linkbutton easyui-tooltip" title="Previous" iconcls="icon-back" plain="true"></a>
                            <input id="txtDateMktSaleTarget" type="text" class="easyui-datebox" required="required" data-options="formatter:icsmonthformat,parser:icsmonthparser" style="width:118px" />
                            <a id="btnNextMktSaleTarget" href="javascript:void(0)" class="easyui-linkbutton" class="easyui-linkbutton easyui-tooltip" title="Next" iconcls="icon-forword" plain="true"></a>
                            <a id="btnSearchMktSaleTarget" href="javascript:void(0)" class="easyui-linkbutton" class="easyui-linkbutton easyui-tooltip" title="Next" iconcls="icon-reload" plain="true">Refresh All</a>
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:20%;text-align:right">
                           
                        </div>
                        <div style="overflow:hidden;float:left;width:80%">
                            
                        </div>
                    </div>
                </div>                            
            </fieldset>
        </div>
        <div title="Mkt Sale Target" style="display:block;overflow:hidden;height:300px">
            <table id="tblMktSaleTarget" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#toolbarMktSaleTarget" style="height:310px">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th field="BuyerName" align="center" width="10%">Buyer</th>
                        <th field="DateInString" align="center" width="10%">Date</th>
                        <th field="OrderTypeST" width="10%" align="center">Order Type</th>
                        <th field="Value" width="10%" align="right" formatter="formatPrice">Sale Target</th>
                        <th field="OrderQty" width="10%" align="right" formatter="formatPrice">Est.Order Qty</th>
                        <th field="BuyerPosition" width="10%" align="left">Buyer Position</th>
                        <th field="BuyerPercentInST" width="10%" align="left">Buyer Percentage(%)</th>
                        <th field="Construction" width="10%" align="left">Contruction</th>
                        <th field="ProductName" width="10%" align="left">Composition</th>
                        <th field="WeaveTypeName" width="10%" align="left">WeaveType</th>
                        <th field="FinishTypeName" width="10%" align="left">FinishType</th>
                        <th field="ApprovedByName" width="10%" align="left">Approve By</th>
                        <th field="LastUpdateByName" width="10%" align="left">Last Update By</th>
                        <th field="LastUpdateDateTimeInString" width="10%" align="center">Last Update Date</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarMktSaleTarget">
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                @*<a id="btnUpdate" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Update</a>*@
                <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approve</a>
                <a id="btnUnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Undo Approve</a>
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print Detail</a>
            </div>
        </div>  
        <div style="display:block;overflow:hidden;">
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:60%; text-align:right"></td>
                        <td style="width:40%;text-align:right;">
                            <a id="btnMktSaleTargetClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>    
    </div>
    <div id="winMktProjectionSetup" class="easyui-window winstyle" title="Add Mkt Projection" style=" height:auto;width:80%" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="overflow:hidden;display:block;">
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Add Marketing Projection</legend>
                <div style="overflow:hidden;display:block;margin-top:5px">
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:40%;text-align:right">
                            Date:
                        </div>
                        <div style="overflow:hidden;float:left;width:60%">
                            <input id="txtDate" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" style=" width:100%;" />
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:35%;text-align:right">
                            Order Type:
                        </div>
                        <div style="overflow:hidden;float:left;width:65%">
                            <select id="cboOrderType" style="float:left;width:94%"> </select>
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:45%;text-align:right">
                            Buyer Position:
                        </div>
                        <div style="overflow:hidden;float:left;width:55%">
                            <input id="txtBuyerPosition" type="text" style=" width:100%;" placeholder="Search By B.Pos and Enter " />
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:40%;text-align:right">
                            Buyer Per.(%):
                        </div>
                        <div style="overflow:hidden;float:left;width:58%">
                            <input id="txtBuyerPercent" type="text" style=" width:100%;" disabled />
                        </div>
                    </div>

                </div>
                <div style="overflow:hidden;display:block;margin-top:5px">
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:40%;text-align:right">
                            E. Order Qty:
                        </div>
                        <div style="overflow:hidden;float:left;width:60%">
                            <input id="txtOrderQty" type="text" style=" width:100%;" />
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:35%;text-align:right">
                            Sale Target:
                        </div>
                        <div style="overflow:hidden;float:left;width:65%">
                            <input id="txtValue" type="text" style=" width:94%;" />
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:22%;text-align:right">
                            Product:
                        </div>
                        <div style="overflow:hidden;float:left;width:78%">
                            <input id="txtProduct" type="text" style=" width:75%;" placeholder="Type P.Name & Enter" />
                            <input id="btnProductPick" type="button" style=" width:10%; text-align:center" value="P" />
                            <input id="btnProductClear" type="button" style=" width:10%;  text-align:center" value="C" />
                        </div>
                    </div>
                </div>
                <div style="overflow:hidden;display:block;margin-top:5px">
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:40%;text-align:right">
                            Weave Type:
                        </div>
                        <div style="overflow:hidden;float:left;width:60%">
                            <select id="cboWeaveType" style=" width:100%;"></select>
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:24%">
                        <div style="overflow:hidden;float:left;width:35%;text-align:right">
                            Finish Type:
                        </div>
                        <div style="overflow:hidden;float:left;width:60%">
                            <select id="cboFinishType" style=" width:100%;"></select>
                        </div>
                    </div>
                    <div style="overflow:hidden;float:left; width:49%">
                        <div style="overflow:hidden;float:left;width:22%;text-align:right">
                            Contruction:
                        </div>
                        <div style="overflow:hidden;float:left;width:78%">
                            <input id="txtContruction" type="text" style=" width:96%;" />
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>        
        <div style="display:block;overflow:hidden;">
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:60%; text-align:right"></td>
                        <td style="width:40%;text-align:right;">
                            <a id="btnMktSaleTargetSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnMktProjectionSetupClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <script type="text/javascript">
        var _nBUID = [];
        var month = new Array();
        month[0] = "January";
        month[1] = "February";
        month[2] = "March";
        month[3] = "April";
        month[4] = "May";
        month[5] = "June";
        month[6] = "July";
        month[7] = "August";
        month[8] = "September";
        month[9] = "October";
        month[10] = "November";
        month[11] = "December";
        var _nMktProjection = [];
        var _nMktProjection_Dist = [];
        var _results = [];
        var MKTID = [];
        var oMktProjections = [];
        var _oAuthorizationRolesMapping=[];
        var oOrderTypes = [];

    $(document).ready(function (){
        debugger;
        oMktProjections  = @Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        MKTID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MKTID));
        var oWeaveTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricWeaves));
        var oFinishTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FinishTypes));
        $('#tblMktProjections').data('BaseAddress', sBaseAddress);
        $('#tblMktProjections').data('MktProjection', oMktProjections);
        oOrderTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.OrderType));
        $("#cboOrderType").icsLoadCombo({List: oOrderTypes, OptionValue: "id", DisplayText: "Value", InitialValue:"-Select One-" });
        $("#cboWeaveType").icsLoadCombo({List: oWeaveTypes, OptionValue: "FabricProcessID", DisplayText: "Name", InitialValue:"-Select One-" });
        $("#cboFinishType").icsLoadCombo({List: oFinishTypes, OptionValue: "FabricProcessID", DisplayText: "Name", InitialValue:"-Select One-" });
        var oTempMktProjections =sessionStorage.getItem("oMktProjections");
        $('#txtDateMktSaleTarget').datebox('setValue', icsmonthformat(new Date()));


        if(oTempMktProjections!=null)
        {
            oMktProjections = jQuery.parseJSON(oTempMktProjections);
        }
        $("#btnUpdate").hide();
        $('#txtYear').val("2020");
        $('#txtYear').datepicker({
            autoclose: true,
            format: "yyyy",
            viewMode: "years",
            minViewMode: "years",
            startDate: '2000',
            endDate: new Date()
        });

        $('#lblBuyer').show();
        $('#txtBuyer').show();    
        $('#txtValue').icsCurrencyBox();
        $('#txtOrderQty').icsCurrencyBox();
        $('#txtDate').datebox('setValue',icsdateformat(new Date()));
        DynamicRefreshList([], "tblMktProjections");
        RefreshList(oMktProjections);
        if(_oAuthorizationRolesMapping > 0 || _oAuthorizationRolesMapping!=0)
        {
            RefreshControlLayout();
        }
    });

        $("#btnPreviousMktSaleTarget").click(function () {
            debugger;
            //marketing date schedule
            var sDate = $('#txtDateMktSaleTarget').datebox('getValue');
            var date = icsmonthparser(sDate);
            var year = date.getFullYear();
            var month = date.getMonth() - 1;
            $('#txtDateMktSaleTarget').datebox('setValue', icsmonthformat(new Date(year, month, 1)));
            ///
            $('#lblBuyer').show();
            $('#txtBuyer').show();
            $('#BuyerPick').show();            
            RefreshConsumption();
            var oMktSaleTarget = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktProjection = $('#tblMktProjections').datagrid('getSelected');
           
            if(oMktSaleTarget==null || oMktSaleTarget.MarketingAccountID<=0)
            {
                alert("Please select a Marketing Head from list!");
                return;
            }
            $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
            $('#txtMktPerson').data('MarketingAccounName',oMktSaleTarget.Name);

            if(oMktProjection!=null){
                $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                $('#txtBuyer').data('BuyerName',oMktProjection.BuyerName);
            }
          
            $('MktPersonName').data("Group Name"+oMktSaleTarget.GroupName);
            if(oMktProjection!=null || $('#txtBuyer').data('ContractorID')>0){
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    ContractorID : parseInt($('#txtBuyer').data('ContractorID')),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : true
                    
                }
            }
           else
            {
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : true
                }
            }
            
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/GetAllMktSaleTarget",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oMktSaleTarget = jQuery.parseJSON(data);
                    if (_oMktSaleTarget.length>0)
                    {
                        RefreshConsumption();
                        DynamicRefreshList(_oMktSaleTarget,'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').addClass('fontColorOfPickItem');
                        $('#tblMktSaleTarget').datagrid('hideColumn', 'BuyerName'); 
                    }
                    else
                    {
                        RefreshConsumption();
                        DynamicRefreshList([],'tblMktSaleTarget');
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').addClass('fontColorOfPickItem');
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

            $("#winMktProjection").icsWindow('open',"Add Mkt Sales Target");

        });
        $("#btnNextMktSaleTarget").click(function () {
            debugger;
            var sDate = $('#txtDateMktSaleTarget').datebox('getValue');
            var date = icsmonthparser(sDate);
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            $('#txtDateMktSaleTarget').datebox('setValue', icsmonthformat(new Date(year, month, 1)));
            ///
            $('#lblBuyer').show();
            $('#txtBuyer').show();
            $('#BuyerPick').show();            
            RefreshConsumption();
            var oMktSaleTarget = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktProjection = $('#tblMktProjections').datagrid('getSelected');
           
            if(oMktSaleTarget==null || oMktSaleTarget.MarketingAccountID<=0)
            {
                alert("Please select a Marketing Head from list!");
                return;
            }
            $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
            $('#txtMktPerson').data('MarketingAccounName',oMktSaleTarget.Name);

            if(oMktProjection!=null){
                 $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                 $('#txtBuyer').data('BuyerName',oMktProjection.BuyerName);
            }
         
            $('MktPersonName').data("Group Name"+oMktSaleTarget.GroupName);
            if(oMktProjection!=null){
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    ContractorID : parseInt($('#txtBuyer').data('ContractorID')),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : true
                }
            }
            else{
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : true
                }
            }
            
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/GetAllMktSaleTarget",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oMktSaleTarget = jQuery.parseJSON(data);
                    if (_oMktSaleTarget.length>0)
                    {
                        RefreshConsumption();
                        DynamicRefreshList(_oMktSaleTarget,'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').addClass('fontColorOfPickItem');
                        $('#tblMktSaleTarget').datagrid('hideColumn', 'BuyerName'); 
                    }
                    else
                    {
                        RefreshConsumption();
                        DynamicRefreshList([],'tblMktSaleTarget');
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').addClass('fontColorOfPickItem');
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

            $("#winMktProjection").icsWindow('open',"Add Mkt Sales Target");
        })

        function RefreshControlLayout()
        {
            $("#btnAdd,#btnEdit,#btnDelete,#btnApprove,#btnUnApprove,#btnUpdate").hide();
            if (PermissionChecker('Add', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnAdd").show();}
            if (PermissionChecker('Edit', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
            if (PermissionChecker('Delete', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
            if (PermissionChecker('Approved', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnApprove").show();}
            if (PermissionChecker('UnApproved', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnUnApprove").show();}
            if (PermissionChecker('Update', 'MktProjectionReport',_oAuthorizationRolesMapping)) {$("#btnUpdate").show();}
        }

        $('#tblMktSaleTarget').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });
        function OperationPerforms(rowIndex, rowData)
        {
            debugger;
            if (rowData != null && rowData.MktSaleTargetID > 0)
            {
                if(rowData.ApproveBy!=0)
                {
                    $('#btnDelete,#btnEdit,#btnUpdate,#btnApprove').hide();
                    $("#btnUnApprove").show();
                }
                else{
                    $('#btnDelete,#btnEdit,#btnApprove').show();
                    $("#btnUnApprove").hide();
                }
            }
        }

        //********************************(Prduct Picker)****************************//
        $("#btnProductPick").click(function(){
            debugger;    
            var sProduct =  $('#txtProduct').val();
            if(sProduct!=""){
                GetProducts();
            }
            else{
                alert("Search Product by Product Name");
                return;
            }
        });
        $("#btnProductClear").click(function(){

            $('#txtProduct').val('');
            $('#txtProduct').data('ProductID', 0);
        });
        $("#txtProduct").keydown( function(e)
        {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) //enter
            {
                var sProduct  =$('#txtProduct').val();
                if( sProduct!=""){
                    GetProducts();
                }
                else{
                    alert("Please type Product Name and Enter!");
                    return;
                }
           
            }
            else if(code == 8) //backspace
            {
                $('#txtProduct').data('ProductID', 0);
                $('#txtProduct').removeClass('fontColorOfPickItem');
            }
        });    
        function GetProducts(){
            debugger;
            var oProduct = {
                BUID : _nBUID,
                ProductName: $("#txtProduct").val()

            };
            var obj = {
                BaseAddress:$('#tblMktProjections').data('BaseAddress'),
                Object: oProduct,
                ControllerName: "Product",
                ActionName: "SearchProductByName",
                IsWinClose: false

            };
            var tblColums = [];
            var oColumn = { field: "ProductCode", title: "Product Code", width: 100, align: "left" }; tblColums.push(oColumn);
            oColumn = { field:"ProductName", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);

            var oPickerParam = {
                winid: 'winMktSaleProduct',
                winclass: 'clsMktSaleProduct',
                winwidth: 400,
                winheight: 460,
                tableid: 'tblMktSaleProduct',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName: 'ProductName',
                windowTittle: 'Product List',
                paramObj: obj,
                pkID: 'ProductID',
                callBack: SetProduct
            };

            $.icsDynamicPicker(oPickerParam);
        }
        function SetProduct(oResult)
        {
            debugger;
            if(oResult.ProductID>0)
            {
                $("#txtProduct").val(oResult.ProductName);
                $('#txtProduct').data('ProductID', oResult.ProductID);
                $('#txtProduct').addClass('fontColorOfPickItem');
            }
        }
        //*********************************(END)*************************************//
        //****************************(Buyer Picker)*********************************//
        $("#txtBuyer").keydown(function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) // Enter Press
            {
                if($.trim($('#txtBuyer').val())===null || $.trim($('#txtBuyer').val())==="")
                {
                    $('#txtBuyer').val('');
                    PickBuyer();
                }
                else{
                    PickBuyer();
                }

            }

        });
        ///Buyer Pick
        function PickBuyer()
        {
            var oContractor = { Params: 2 + '~' + $.trim($('#txtBuyer').val())+'~'+ _nBUID };//here 1 is Buyer
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            debugger;
            var tblColums = [];
            var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);

            var oPickeMktPerson = {
                winid: 'winBuyer',
                winclass: 'clsBuyer',
                winwidth: 600,
                winheight: 460,
                tableid: 'tblBuyer',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName: 'Name',
                windowTittle: 'Buyer List',
                paramObj: obj,
                pkID: 'ContractorID',
                callBack: SetBuyer
            };
            $.icsDynamicPicker(oPickeMktPerson);
        }
        function SetBuyer(oResult)
        {
            debugger;
            if(oResult.ContractorID>0)
            {
                $('#txtBuyer').data('ContractorID', oResult.ContractorID);
                $('#txtBuyer').val(oResult.Name);
                $('#txtBuyer').addClass('fontColorOfPickItem');
            }
            else
            {
                $('#txtBuyer').val('');
                 $('#txtBuyer').data('ContractorID', '');
                $('#txtBuyer').removeClass('fontColorOfPickItem');
            }
        }

        //*****************************(END)*****************************************//
        //****************************(Buyer Position Picker)***********************//
        $("#txtBuyerPosition").keydown( function(e)
        {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) //enter
            {
                if($('#txtBuyerPosition').val()!=""){
                    
                    GetBuyerPosition($('#txtBuyerPosition').val());
                }
                else{
                    GetBuyerPosition("");
                }

            } 
            else if(code == 8) //backspace
            {
                //id = 0
            } 
        });
        function GetBuyerPosition(sBuyerPos)
        {
            var oBuyerPosition = {
                BPosition : sBuyerPos
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oBuyerPosition,
                ControllerName: "BuyerPercent",
                ActionName: "GetsBuyerPosition",
                IsWinClose: false
            };

            debugger;
            var tblColums = []; 
            var oColumn = { field: "BPosition", title: "Buyer Position", width: 200, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "BPercent", title: "Buyer Percent", width: 120, align: "left" }; tblColums.push(oColumn);
            var oPickerParam = {
                winid: 'winProducts',
                winclass: 'clsProduct',
                winwidth: 600,
                winheight: 460,
                tableid: 'tblProducts',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName: 'BPosition',
                windowTittle: 'Buyer Position List',
                paramObj: obj,
                pkID: 'BuyerPercentID',
                callBack: SetBuyerPosition
            };

            $.icsDynamicPicker(oPickerParam);
        }
        function SetBuyerPosition(oResult)
        {
            if(oResult.BuyerPercentID>0)
            {
                $('#txtBuyerPosition').data('BuyerPercentID', oResult.BuyerPercentID);
                $('#txtBuyerPosition').val(oResult.BPosition);
                $('#txtBuyerPercent').val(oResult.BPercent);
                $('#txtBuyerPosition').addClass('fontColorOfPickItem');
                $('#txtBuyerPercent').addClass('fontColorOfPickItem');

            }
            else{
                $('#txtBuyerPosition').data('BuyerPercentID', '');
                $('#txtBuyerPosition').val('');
                $('#txtBuyerPercent').val('');
                $('#txtBuyerPosition').removeClass('fontColorOfPickItem');
                $('#txtBuyerPercent').removeClass('fontColorOfPickItem');
            }
        }
        //*****************************(END)*****************************************//

        $("#cboMktType").change(function(){
            debugger;
            var GroupID =  parseInt($('#cboMktType').val());
            var oMarketingHeads = $('#tblMarketingHeads').datagrid('getRows');
            var MarketingAccountIDs = ICS_PropertyConcatation(oMarketingHeads, 'MarketingAccountID');     
            var oMktType ={ErrorMessage:GroupID+'~'+MarketingAccountIDs+'~'+_nBUID};
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/SalesReport/LoadMktHeads",
                traditional: true,
                data:  JSON.stringify(oMktType),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oMktHeads = jQuery.parseJSON(data);
                    if (oMktHeads.length>0)
                    {
                        DynamicRefreshList(oMktHeads, 'tblMarketingHeads');
                    }
                    else
                    {
                        alert("Data Not found");
                        DynamicRefreshList([], 'tblMarketingHeads');
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });           

        });
        function ValidateInput(){
            debugger;
            var nOrderType = parseInt($('#cboOrderType').val());
            var nValue = parseFloat($('#txtValue').val());
            var nOrderQty = parseFloat($('#txtOrderQty').val());
            var nContractorID =  $('#txtBuyer').data('ContractorID');

            if(nContractorID == 0 || nContractorID==undefined){
                alert("Please Enter Buyer.")
                $('#txtBuyer').focus();
                return false;
            }

            if(nOrderType <= 0){
                alert("Please Select Order Type.")
                $('#cboOrderType').focus();
                return false;
            }

            if(nValue <= 0){
                alert("Sale  Target is Required!.")
                $('#txtValue').focus();
                return false;
            }

            return true;
        }
        $("#btnAddMktSale").click(function(){
            debugger;
            $('#lblBuyer').show();
            $('#txtBuyer').show();
            $('#BuyerPick').show();             
            RefreshConsumption();
            var oMktAccount = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktProjection = $('#tblMktProjections').datagrid('getSelected');
           
            if(oMktAccount==null || oMktAccount.MarketingAccountID<=0)
            {
                alert("Please select a Marketing Head from list!");
                return;
            }

            $('#txtMktPerson').data('MarketingAccountID',oMktAccount.MarketingAccountID);
            $('#txtMktPerson').data('MarketingAccounName',oMktAccount.Name);

            if(oMktProjection==null){
                $('#txtBuyer').data('ContractorID',0);
                $('#txtBuyer').val("");                
            }
            if(oMktProjection!=null)
            {
                $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                $('#txtBuyer').data('BuyerName',oMktProjection.BuyerName);
            }
          
            $('MktPersonName').data("Group Name"+oMktAccount.GroupName);
            if(oMktProjection!=null){
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktAccount.MarketingAccountID),
                    ContractorID : parseInt($('#txtBuyer').data('ContractorID')),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : false
                }
            }
            else{
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktAccount.MarketingAccountID),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    IsMonth : false
                }
            }
            
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/GetAllMktSaleTarget",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oMktSaleTarget = jQuery.parseJSON(data);
                    if (_oMktSaleTarget.length>0)
                    {
                        RefreshConsumption();
                        DynamicRefreshList(_oMktSaleTarget,'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#txtBuyer').val( $('#txtBuyer').data('BuyerName'));
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').addClass('fontColorOfPickItem');
                        $('#tblMktSaleTarget').datagrid('hideColumn', 'BuyerName'); 
                    }
                    else
                    {
                        RefreshConsumption();
                        DynamicRefreshList([],'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                        $('#txtBuyer').val( $('#txtBuyer').data('BuyerName'));
                        $('#txtBuyer').addClass('fontColorOfPickItem');

                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

            $("#winMktProjection").icsWindow('open',"Add Mkt Sales Target");
        });
        $("#btnSearchMktSaleTarget").click(function(){
            debugger;
            $('#lblBuyer').show();
            $('#txtBuyer').show();
            $('#BuyerPick').show();       
            $('#txtDateMktSaleTarget').datebox('setValue', icsmonthformat(new Date()));
            RefreshConsumption();
            var oMktSaleTarget = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktProjection = $('#tblMktProjections').datagrid('getSelected');
           
            if(oMktSaleTarget==null || oMktSaleTarget.MarketingAccountID<=0)
            {
                alert("Please select a Marketing Head from list!");
                return;
            }
            $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
            $('#txtMktPerson').data('MarketingAccounName',oMktSaleTarget.Name);

            if(oMktProjection!=null){
                 $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                $('#txtBuyer').data('BuyerName',oMktProjection.BuyerName);
            }
          
            $('MktPersonName').data("Group Name"+oMktSaleTarget.GroupName);
            if(oMktProjection!=null){
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    ContractorID : parseInt(oMktProjection.ContractorID),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    Month : 0
                }
            }
            else{
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date())),
                    Month : 0
                }
            }
            
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/GetAllMktSaleTarget",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oMktSaleTarget = jQuery.parseJSON(data);
                    if (_oMktSaleTarget.length>0)
                    {
                        RefreshConsumption();
                        DynamicRefreshList(_oMktSaleTarget,'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#tblMktSaleTarget').datagrid('hideColumn', 'BuyerName'); 
                    }
                    else
                    {
                        RefreshConsumption();
                        DynamicRefreshList([],'tblMktSaleTarget');
                        //alert(_oMktSaleTarget.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

            $("#winMktProjection").icsWindow('open',"Add Mkt Sales Target");
        });
        $("#btnApproveMktSale").click(function(){
            debugger;          
            $('#lblBuyer').hide();
            $('#txtBuyer').hide();           
            RefreshConsumption();
            var oMktSaleTarget = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktProjection = $('#tblMktProjections').datagrid('getSelected');
           
            if(oMktSaleTarget==null || oMktSaleTarget.MarketingAccountID<=0)
            {
                alert("Please select a Marketing Head from list!");
                return;
            }
            $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
            $('#txtMktPerson').data('MarketingAccounName',oMktSaleTarget.Name);

            if(oMktProjection!=null){
                $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                $('#txtBuyer').data('BuyerName',oMktProjection.BuyerName);
            }
          
            $('MktPersonName').data("Group Name"+oMktSaleTarget.GroupName);
            if(oMktProjection!=null){
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    ContractorID : parseInt(oMktProjection.ContractorID),
                    Year:$('#txtYear').val(),
                    ErrorMessage : $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date()))
                }
            }
            else{
                var oMktSaleTarget={
                    MarketingAccountID : parseInt(oMktSaleTarget.MarketingAccountID),
                    Year:$('#txtYear').val()
                }
            }
            
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/GetAllMktSaleTarget",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oMktSaleTarget = jQuery.parseJSON(data);
                    if (_oMktSaleTarget.length>0)
                    {
                        RefreshConsumption();
                        DynamicRefreshList(_oMktSaleTarget,'tblMktSaleTarget');
                        $('#txtMktPerson').data('MarketingAccountID',oMktSaleTarget.MarketingAccountID);
                        $('#tblMktSaleTarget').datagrid('showColumn', 'BuyerName'); 
                        $('#BuyerPick').hide();      
                    }
                    else
                    {
                        RefreshConsumption();
                        DynamicRefreshList([],'tblMktSaleTarget');
                        //alert(_oMktSaleTarget.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

            $("#winMktProjection").icsWindow('open',"Add Mkt Sales Target");
        });

        $("#btnMktSaleTargetClose").click(function(){
            debugger;
            $('#txtBuyer').data('ContractorID',0);
            $('#txtBuyer').val('');
            $('#txtMktPerson').data('MarketingAccountID',0);
            $('#txtMktPerson').val('');           
            $('#txtDate').datebox('setValue',icsdateformat(new Date()));
            parseInt($('#cboOrderType').val(0));
            $('#txtValue').val("");
            $('#txtOrderQty').val("");
            $('#txtBuyerPosition').val("");
            $('#txtBuyerPercent').val("");
            $('#txtDateMktSaleTarget').datebox('setValue', icsmonthformat(new Date()));
            DynamicRefreshList([],'tblMktSaleTarget');
            $("#winMktSaleTarget").icsWindow('close');
        })
        $('#btnAdd').click(function(){
            debugger;
            var nContractorID =  $('#txtBuyer').data('ContractorID');
            if(nContractorID==0 || nContractorID==undefined){
                alert("Buyer is required!");
                $('#txtBuyer').focus();
                return;
            }
            RefreshConsumption();
            $('#cboOrderType').val(3);
            sessionStorage.setItem("SelectedRowIndex", -1);
            sessionStorage.setItem("MktSaleTargetHeader","Add MktSaleTarget")
            $("#winMktProjectionSetup").icsWindow('open', "Add Marketing Projection Setup");
        });
        $('#btnMktProjectionSetupClose').click(function(){
            debugger;
            $("#btnMktProjectionSetupClose").icsWindow('close');
        });
        $('#btnMktSaleTargetSave').click(function(){
            debugger;
            var oMktPersonHead = $('#tblMarketingHeads').datagrid('getSelected');
            var _oMktSaleTarget = $('#tblMktProjections').datagrid('getSelected');    
            var oMktSaleTarget =
                {
                    MktSaleTargetID : $('#txtMktPerson').data('MktSaleTargetID'),
                    MarketingAccountID : parseInt(oMktPersonHead.MarketingAccountID),
                    OrderType : parseInt($("#cboOrderType").val()),
                    Date : $('#txtDate').datebox('getValue'),
                    Value : parseFloat(TempRemoveComma($("#txtValue").val())),
                    OrderQty : parseFloat(TempRemoveComma($("#txtOrderQty").val())),
                    ContractorID :  $('#txtBuyer').data('ContractorID'),
                    BuyerPosition : $("#txtBuyerPosition").val(),
                    BPercent : $("#txtBuyerPercent").val(),
                    BuyerPercentID : parseInt($('#txtBuyerPosition').data('BuyerPercentID')),
                    ProductID: parseInt($('#txtProduct').data('ProductID')),
                    WeaveType : parseInt($("#cboWeaveType").val()),
                    FinishType : parseInt($("#cboFinishType").val()),
                    Construction :  $("#txtContruction").val()
                }
            debugger;
            if(!ValidateInput()){return;}
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/MktSaleTargetSave",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    oMktSaleTarget = jQuery.parseJSON(data);
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oMktSaleTarget.ErrorMessage=="" || oMktSaleTarget.ErrorMessage==null)
                    {
                        alert("Data Saved sucessfully");
                        if(sessionStorage.getItem("MktSaleTargetHeader") == "Add MktSaleTarget")
                        {
                            $('#tblMktSaleTarget').datagrid('appendRow',oMktSaleTarget);
                            var oData = $('#tblMktSaleTarget').datagrid('getRows');
                            $('#tblMktSaleTarget').datagrid('selectRow',oData.length-1);

                        }                        
                        if(sessionStorage.getItem("MktSaleTargetHeader") == "Edit MktSaleTarget")
                        {
                            $('#tblMktSaleTarget').datagrid('updateRow',{index : nIndex, row:oMktSaleTarget});
                        }
                        RefreshConsumption();                   
                        $("#winMktProjectionSetup").icsWindow('close');
                    }
                    else
                    {
                        alert(oFabricQCParName.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }

            });

        });
        $("#btnEdit").click(function(){
            debugger;
            var oMktProjection= $('#tblMktSaleTarget').datagrid('getSelected');
            oMktProjection.ApproveBy = (oMktProjection.ApproveBy == undefined?0:oMktProjection.ApproveBy);
            if (oMktProjection.ApproveBy != 0) {
                alert("your selected item already approved!unable to edit.");
                return;
            }
            var SelectedRowIndex=$('#tblMktSaleTarget').datagrid('getRowIndex',oMktProjection);
            sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
            sessionStorage.setItem("MktSaleTargetHeader","Edit MktSaleTarget")
            RefreshControl(oMktProjection);
            $("#btnEdit").hide();
            $("#btnUpdate").show();
        });
        function RefreshControl(oMktProjection){
            debugger;
            $("#winMktProjectionSetup").icsWindow('open', "Edit Marketing Projection Setup");
                $('#txtMktPerson').data('MktSaleTargetID',parseInt(oMktProjection.MktSaleTargetID));
                $('#txtDate').datebox('setValue',oMktProjection.DateInString);
                $('#txtValue').val(TempAddComma(parseFloat(oMktProjection.Value)));
                $('#txtOrderQty').val(TempAddComma(parseFloat(oMktProjection.OrderQty)));
                $('#cboOrderType').val(parseInt(oMktProjection.OrderType));
                $('#txtBuyerPosition').val(oMktProjection.BuyerPosition);
                $('#txtBuyerPercent').val(oMktProjection.BPercent);
                $('#txtProduct').data('ProductID',parseInt(oMktProjection.ProductID));
                $('#txtProduct').val(oMktProjection.ProductName);
                $('#cboFinishType').val(parseInt(oMktProjection.FinishType));
                $('#cboWeaveType').val(parseInt(oMktProjection.WeaveType));
                $('#txtContruction').val(oMktProjection.Construction);
                $('#txtBuyer').data('ContractorID',oMktProjection.ContractorID);
                $('#txtBuyer').val(oMktProjection.BuyerName);
                
                if(oMktProjection.MktSaleTargetID>0){
                    $('#txtBuyerPosition').addClass('fontColorOfPickItem');
                    $('#txtProduct').addClass('fontColorOfPickItem');
                }
        }

        $('#btnUpdate').click(function(){
            debugger;
            var oMktPersonHead = $('#tblMarketingHeads').datagrid('getSelected');
            var oMktSaleTarget =
                {
                    MktSaleTargetID :  $('#txtMktPerson').data('MktSaleTargetID'),
                    MarketingAccountID : parseInt(oMktPersonHead.MarketingAccountID),
                    ContractorID : parseInt(_oMktSaleTarget.ContractorID),
                    OrderType : parseInt($("#cboOrderType").val()),
                    Date : $('#txtDate').datebox('getValue'),
                    Value : parseFloat(TempRemoveComma($("#txtValue").val())),
                    OrderQty : parseFloat(TempRemoveComma($("#txtOrderQty").val())),
                    ContractorID : $('#txtBuyer').data('ContractorID'),
                    BuyerPosition : $("#txtBuyerPosition").val(),
                    BPercent : $("#txtBuyerPercent").val(),
                    BuyerPercentID : parseInt($('#txtBuyerPosition').data('BuyerPercentID')),
                    ProductID: parseInt($('#txtProduct').data('ProductID')),
                    WeaveType : parseInt($("#cboWeaveType").val()),
                    FinishType : parseInt($("#cboFinishType").val()),
                    Construction :  $("#txtContruction").val()
                }
            debugger;
            if(!ValidateInput()){return;}
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/MktSaleTargetSave",
                traditional: true,
                data:  JSON.stringify(oMktSaleTarget),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    oMktSaleTarget = jQuery.parseJSON(data);
                    if (oMktSaleTarget.ErrorMessage=="" || oMktSaleTarget.ErrorMessage==null)
                    {
                        alert("Data Update sucessfully");
                        RefreshConsumption();
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if(sessionStorage.getItem("MktProjectionHeader") == "Edit MktProjection")
                        {
                            $('#tblMktSaleTarget').datagrid('updateRow',{index : nIndex, row:oMktSaleTarget});
                            $("#btnEdit").show();
                            $("#btnUpdate").show();
                        }


                    }
                    else
                    {
                        alert(oFabricQCParName.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }

            });

        });
        $("#btnDelete").click(function(){
            debugger;
            var oMktSaleTarget = $('#tblMktSaleTarget').datagrid('getSelected');
            if(oMktSaleTarget==null || oMktSaleTarget.MktSaleTargetID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            var SelectedRowIndex=$('#tblMktSaleTarget').datagrid('getRowIndex',oMktSaleTarget);
            $.ajax({
                type: "GET",
                dataType: "json",
                url :  _sBaseAddress+ "/SalesReport/MktSaleTargetDelete",
                data: {id: oMktSaleTarget.MktSaleTargetID},
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $('#tblMktSaleTarget').datagrid('deleteRow',SelectedRowIndex);

                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

        });
        $('#btnApprove').click(function(){
            debugger;
            var count = 0;
            var oMktSaleTargetChecked= $('#tblMktSaleTarget').datagrid('getChecked');
            var oMktSaleTargets = $('#tblMktSaleTarget').datagrid('getRows');
            var SelectedRowIndex = [];
            var nSelectedIndex = 0;

            for (var i = 0; i < oMktSaleTargetChecked.length; i++) {
                SelectedRowIndex[i] = $('#tblMktSaleTarget').datagrid('getRowIndex', oMktSaleTargetChecked[i]);
                if (parseInt(oMktSaleTargetChecked[i].ApproveBy) == 0) {
                    count++;
                }
            }
            if (count == 0) {
                alert("your entry already approved!");
                return false;
            }           
            var oMktSaleTarget = {
                oMktSaleTargets : oMktSaleTargetChecked,   
                ContractorName : ICS_PropertyConcatation(oMktSaleTargets, 'MktSaleTargetID')
            };

            if (!confirm("Confirm to Approve?")) return ;
             $.ajax
                ({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+ "/SalesReport/Approve",
                    data: JSON.stringify(oMktSaleTarget),
                    contentType:"application/json; charset=utf-8",
                    success: function (data) {
                        var oMktSaleTargets = jQuery.parseJSON(data);
                        if (oMktSaleTargets.length>0)
                        {
                            if (oMktSaleTargets.length>0) {          
                                alert("Approved sucessfully");
                                DynamicRefreshList([],'tblMktSaleTarget');
                                DynamicRefreshList(oMktSaleTargets,'tblMktSaleTarget');
                            }
                        }
                        else
                        {
                            alert("Failed to Approve");
                        }
                    },
                    error: function (xhr, status, error)
                    {
                        alert(error);
                    }

                });
            
        });
        $('#btnUnApprove').click(function(){
            debugger;
            var count = 0;
            var oMktSaleTargetChecked= $('#tblMktSaleTarget').datagrid('getChecked');
            var oMktSaleTargets = $('#tblMktSaleTarget').datagrid('getRows');
            var SelectedRowIndex = [];
            var nSelectedIndex = 0;

            for (var i = 0; i < oMktSaleTargetChecked.length; i++) {
                SelectedRowIndex[i] = $('#tblMktSaleTarget').datagrid('getRowIndex', oMktSaleTargetChecked[i]);
                if (parseInt(oMktSaleTargetChecked[i].ApproveBy) != 0) {
                    count++;
                }
            }
            if (count == 0) {
                alert("Your entry already Unapproved!");
                return false;
            }                
            var oMktSaleTarget = {
                oMktSaleTargets : oMktSaleTargetChecked,   
                ContractorName : ICS_PropertyConcatation(oMktSaleTargets, 'MktSaleTargetID')
            };
            if (!confirm("Confirm to Undo Approve?")) return ;
            $.ajax
               ({
                   type: "POST",
                   dataType: "json",
                   url : _sBaseAddress+ "/SalesReport/UndoApprove",
                   data: JSON.stringify(oMktSaleTarget),
                   contentType:"application/json; charset=utf-8",
                   success: function (data) {
                       var oMktSaleTargets = jQuery.parseJSON(data);
                       if (oMktSaleTargets.length>0)
                       {
                           if (oMktSaleTargets.length>0) {          
                               alert("UnApproved sucessfully");
                               DynamicRefreshList([],'tblMktSaleTarget');
                               DynamicRefreshList(oMktSaleTargets,'tblMktSaleTarget');
                           }
                       }
                       else
                       {
                           alert("Failed to UnApprove");
                       }
                   },
                   error: function (xhr, status, error)
                   {
                       alert(error);
                   }

               });
        });


        function RefreshConsumption(){
            var sBuyerName = $('#txtBuyer').val();
            sBuyerName == undefined?x="":x = $('#txtBuyer').data('BuyerName');
            if(sBuyerName ==""){
                $('#txtBuyer').data('ContractorID',0);
                $('#txtBuyer').val("");
            }
            else{
                $('#txtBuyer').data('ContractorID',parseInt( $('#txtBuyer').data('ContractorID')));
                //$('#txtBuyer').val($('#txtBuyer').data('BuyerName'));
            }

            $('#txtMktPerson').data('MarketingAccountID',parseInt($('#txtMktPerson').data('MarketingAccountID')));
            $('#txtMktPerson').val($('#txtMktPerson').data('MarketingAccounName'));
            $('#txtMktPerson').data('MktSaleTargetID',0);
            $('#txtDate').datebox('setValue',icsdateformat(new Date()));
            parseInt($('#cboOrderType').val(0));
            $('#txtValue').val("");
            $('#txtOrderQty').val("");
            $('#txtBuyerPosition').val("");
            $('#txtBuyerPercent').val("");
            $('#txtProduct').val("");
            parseInt($('#cboWeaveType').val(0));
            parseInt($('#cboFinishType').val(0));
            $('#txtContruction').val("");

            if(x==""){
                $('#BuyerPick').attr('disabled',false);
            }
            else{
                $('#BuyerPick').attr('disabled',true);
            }

        }
        
        $("#btnClose").click(function(){
            $("#winMktProjection").icsWindow('close');
        });

        function RefreshList(oMktProjections) {
            debugger;
            data={"total":""+oMktProjections.length+"","rows":oMktProjections};
            $('#tblMarketingHeads').datagrid('loadData',data);
            var nSelectedRowIndex =parseInt(sessionStorage.getItem("SelectedRowIndex"));
        }
        $('#btnSearch').click(function (e)
        {
            debugger;   
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead == null){alert("Please Select Group Head!");}
            var dateYear = $("#txtYear").val();
            if(dateYear == "")
            {
                alert("Please Select Year And Try Again!!");
                return;
            }

            if(oMarketingHead.MarketingAccountID<=0){
                alert("Select Marketing Head and try again!");

            }
            oParams = {
                Year : dateYear,
                BUID : _nBUID,
                ViewType : parseInt($("#cboReportType").val()),
                MarketingAccountID : parseInt(oMarketingHead.MarketingAccountID),
                MKTViewType : parseInt($("#cboMktType").val())

            }
            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress+ "/SalesReport/SearchMarketingProjection",
                data:JSON.stringify(oParams),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _results = data;
                    _nMktProjection = _results.Item1;
                    _nMktProjection_Dist = _results.Item2;
                    if(_nMktProjection.length>0)
                    {
                        GetDynamicColumn();
                        GetDynamicColumnData('ContractorID');
                    }
                    else
                    {
                        alert("No Data Found!");
                        DynamicRefreshList([],'tblMktProjections');
                    }
                    //RefreshList([]);
                },
            });       
        });

        function GetDynamicColumn()
        {
            var oDetailColumns = [];
            var oColumn = "";
            oColumn =  { field:'BuyerName', title: 'Buyer', width:'12%',  cellClass: 'text-left',rowspan:2 };oDetailColumns.push(oColumn);
            oColumn =  { field:'BuyerPosition', title: 'Buyer Position', width:'10%',  cellClass: 'text-left',rowspan:2  };oDetailColumns.push(oColumn);
            oColumn =  { field:'OrderQty', title: 'Est. Order Qty', width:'10%',  align:'right', cellClass: 'text-left',rowspan:2  };oDetailColumns.push(oColumn);
            
            var sYear=$("#txtYear").val()+"";
            for(var i=0; i<12;i++)
            {
                oColumn = { field: month[i], title: month[i]+" "+sYear.substring(2, 4),align:'center', width: '27%',formatter:formatPrice,colspan:3};oDetailColumns.push(oColumn);       

            }                      
            //oColumn = { field: 'Total', title: 'Total', width: '10%',formatter:formatPrice};oDetailColumns.push(oColumn);
            //$('#tblMktProjections').datagrid({
            //    columns:[oDetailColumns]
            //});
            var childcolumns = [];
            var sYear=$("#txtYear").val()+"";
            for(var i=0; i<12;i++)
            {              
                oColumn = { field:month[i]+'Value', title: "Projection Qty", width: '9%',align:'right',formatter:formatPrice};childcolumns.push(oColumn);   
                oColumn = { field:month[i]+'ReceiveQty', title: "Achive Qty", width: '9%',align:'right',formatter:formatPrice};childcolumns.push(oColumn); 
                oColumn = { field:month[i]+'Amount', title: "Amount", width: '9%',align:'right',formatter:formatPrice};childcolumns.push(oColumn); 
            }
            
            //oColumn = { field: 'Total', title: 'Total', width: '10%',formatter:formatPrice};oDetailColumns.push(oColumn);
            //$('#tblMktProjections').datagrid({
            //    columns:[oDetailColumns]
            //});
            $('#tblMktProjections').datagrid({columns:[oDetailColumns,childcolumns]});
        }
        function GetDynamicColumnData(nRef)
        {
            var nRefID=0; var oMktProjections=[];
            _nMktProjection =_results.Item1;
            _nMktProjection_Dist =_results.Item2;

            if(_nMktProjection_Dist == null)
            {
                alert("No Data Found!!"); return;
            }debugger;
            for(var i=0; i<_nMktProjection_Dist.length ;i++ )
            {
                var nTotal=0.00;
                var oMktProjection = new Object();
                oMktProjection.BuyerName =_nMktProjection_Dist[i].BuyerName;
                oMktProjection.BuyerPosition =_nMktProjection_Dist[i].BuyerPosition;
                oMktProjection.OrderQty =_nMktProjection_Dist[i].OrderQty;
                oMktProjection.MarketingAccountID=_nMktProjection_Dist[i].MarketingAccountID;
                oMktProjection.ContractorID=_nMktProjection_Dist[i].ContractorID;
                
                var nValue = 0;
                for(var k=0; k<_nMktProjection.length;k++)
                {
                    if(_nMktProjection[k][nRef]==_nMktProjection_Dist[i][nRef])
                    {
                        if(isNaN(oMktProjection[month[_nMktProjection[k].Month-1]+'Value'])){
                            oMktProjection[month[_nMktProjection[k].Month-1]+'Value'] = 0;
                        }

                        if(isNaN(oMktProjection[month[_nMktProjection[k].Month-1]+'ReceiveQty'])){
                            oMktProjection[month[_nMktProjection[k].Month-1]+'ReceiveQty'] = 0;
                        }

                        if(isNaN(oMktProjection[month[_nMktProjection[k].Month-1]+'Amount'])){
                            oMktProjection[month[_nMktProjection[k].Month-1]+'Amount'] = 0;
                        }
                      
                        for(var x=0; x<12; x++){
                            oMktProjection[month[_nMktProjection[k].Month-1]+'Amount'] = _nMktProjection[k].Amount;
                            oMktProjection[month[_nMktProjection[k].Month-1]+'Value'] = _nMktProjection[k].Value;
                            oMktProjection[month[_nMktProjection[k].Month-1]+'ReceiveQty'] =_nMktProjection[k].ReceiveQty;                           
                        }                                             
                    }
                }
                //oMktProjection.Total=nTotal;
                oMktProjections.push(oMktProjection);
            }
            debugger;
            $('#tblMktProjections').datagrid('loadData', oMktProjections);
        }

        $('#btnPrintPDF').click(function (e){
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead.MarketingAccountID<=0){
                alert("Please Select Marketing Head!");
                return;
            }
            if( parseInt($("#cboMktType").val())<=0){
                alert("Please Select Marketing Head!");
                $("#cboMktType").focus();
                return;
            }
            var MktHeadID = parseInt(oMarketingHead.MarketingAccountID);
            var MktHeadName = oMarketingHead.Name;
            var nYear = $('#txtYear').val();
            var ViewType = parseInt($('#cboReportType').val());
            var BUID = _nBUID;
            var sValue = MktHeadID+'~'+nYear+'~'+ViewType+'~'+BUID+'~'+MktHeadName+"~"+parseInt($("#cboMktType").val());
            var nts=(new Date()).getTime()/1000;
            window.open(_sBaseAddress+"/SalesReport/MKTProjectionReport?sValue="+sValue+"&nts="+nts);     
        });

        $('#btnMKTPersonWisePrint').click(function (e)
        {
            debugger;
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead.MarketingAccountID<=0){
                alert("Please Select Marketing Head!");
                return;
            }
            var oMktProjectionReport = {
                MarketingAccountID : parseInt(oMarketingHead.MarketingAccountID),
                Year :  $('#txtYear').val(),
                ViewType : parseInt($('#cboReportType').val()),
                MKTViewType :  parseInt($('#cboMktType').val()),
                BUID : _nBUID
            }
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/SalesReport/SetMktReportParam",
                traditional: true,
                data:  JSON.stringify(oMktProjectionReport),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var sFeedBackMessage = jQuery.parseJSON(data);
                    if (sFeedBackMessage==="Successful")
                    {
                        window.open (_sBaseAddress+ "/SalesReport/MktPersonWiseReport");
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });
        $('#btnPrint').click(function (e)
        {
            debugger;
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead.MarketingAccountID<=0){
                alert("Please Select Marketing Head!");
                return;
            }
            var MarketingAccountID = parseInt(oMarketingHead.MarketingAccountID);
            var ViewType = parseInt($('#cboReportType').val());
            var MKTViewType = parseInt($('#cboMktType').val());
            var ErrorMessage = $('#txtDateMktSaleTarget').datebox('getValue', icsmonthformat(new Date()));

            var sParams = MarketingAccountID+'~'+ViewType+'~'+MKTViewType+'~'+_nBUID+'~'+ErrorMessage;
            var nts=(new Date()).getTime()/1000;
            window.open(_sBaseAddress+'/SalesReport/MktSalesTargetPrintDetail?sParams='+sParams+'&nts='+nts,"_blank");
     
        });

        $('#btnMKTPersonWiseXL').click(function (e)
        {
            debugger;
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead.MarketingAccountID<=0){
                alert("Please Select Marketing Head!");
                return;
            }
            var oMktProjectionReport = {
                MarketingAccountID : parseInt(oMarketingHead.MarketingAccountID),
                Year :  $('#txtYear').val(),
                ViewType : parseInt($('#cboReportType').val()),
                BUID : _nBUID,
                MKTViewType :  parseInt($('#cboMktType').val()),
            }
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/SalesReport/SetMktReportParam",
                traditional: true,
                data:  JSON.stringify(oMktProjectionReport),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var sFeedBackMessage = jQuery.parseJSON(data);
                    if (sFeedBackMessage==="Successful")
                    {
                        window.open (_sBaseAddress+ "/SalesReport/MktPersonWiseXL");
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });

        $('#btnPrintExcel').click(function (e){
            var oMarketingHead= $('#tblMarketingHeads').datagrid('getSelected');
            if(oMarketingHead.MarketingAccountID<=0){
                alert("Please Select Marketing Head!");
                return;
            }
            var MktHeadID = parseInt(oMarketingHead.MarketingAccountID);
            var MktHeadName = oMarketingHead.Name;
            var nYear = $('#txtYear').val();
            var ViewType = parseInt($('#cboReportType').val());
            var BUID = _nBUID;
            var sValue = MktHeadID+'~'+nYear+'~'+ViewType+'~'+BUID+'~'+MktHeadName+"~"+ parseInt($("#cboMktType").val());
            var nts=(new Date()).getTime()/1000;
            window.open(_sBaseAddress+"/SalesReport/MarketingProjectionExcel?sValue="+sValue+"&nts="+nts);     
        });

        $('#btnPrintSummary').click(function (e){
            debugger;
            var oMarketingHeads = $('#tblMarketingHeads').datagrid('getRows');
            var MarketingAccountIDs = ICS_PropertyConcatation(oMarketingHeads, 'MarketingAccountID');     
            var nYear = $('#txtYear').val();
            var BUID = _nBUID;
            var sValue = MarketingAccountIDs+'~'+nYear+'~'+BUID;
            var nts=(new Date()).getTime()/1000;
            window.open(_sBaseAddress+"/SalesReport/MarketingProjectionSummary?sValue="+sValue+"&nts="+nts);     
        });

        //REMOVE COMMA
        function TempRemoveComma(userInput) {
            debugger;
            var amountInString = "";
            if (userInput === null || userInput === "") {
                amountInString = "0.00";
            }
            else {
                amountInString = "";
                for (var i = 0; i < userInput.length; i++) {
                    var char = userInput.charAt(i);
                    var charForCheck = char;
                    char = char.match(/\d+/g);
                    if (char != null) {
                        amountInString = amountInString + userInput.charAt(i);
                        count = 1;
                    }
                    else if (charForCheck == ",") {
                        continue;
                    }
                    else if (charForCheck == ".") {
                        amountInString = amountInString + userInput.charAt(i);
                    }
                }
            }
            //debugger;
            return (isNaN(parseFloat(amountInString)) ? parseFloat(0.00) : parseFloat(amountInString)).toFixed(3);
        }
        function TempAddComma(nStr) {
            debugger;
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var process = /(\d+)(\d{3})/;
            while (process.test(x1)) {
                x1 = x1.replace(process, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }

    </script>
