@{
    ViewBag.Title = "Dye Line Progress";
}

<body>

    @model ESimSol.BusinessObjects.RouteSheet
    <div class="menuMainCollectionTable">
        <fieldset>
            <legend>Batch Card Sheet Info</legend>
            <table id="tblRouteSheet">
                <tr>
                    <td class="td-col-3 align-right">
                        <label>Dye line No </label>
                    </td>
                    <td class="td-col-7 align-left">
                        <input id="txtRouteSheetNo" type="text" style="width:75%" placeholder="Search Batch No" />
                        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true"></a>
                    </td>
                    <td class="td-col-3 align-right">
                        <label>Order No </label>
                    </td>
                    <td colspan="3" class="td-col-7 align-left">
                        <input id="txtOrderNo" type="text" placeholder="Search Order No" disabled />
                    </td>

                </tr>
                <tr>
                    <td class="td-col-3 align-right">
                        <label>Machine </label>
                    </td>
                    <td class="td-col-7 align-left">
                        @*<input id="txtMachine" type="text" disabled />*@

                        <div class="input-group" style="width:90%">
                            <input id="txtMachine" onkeydown="SearchKeyFNMachine(event,3)" placeholder="Type Name & Press Enter.." />
                            <button id="btnMachine" type="button" aria-label="Left Align" onclick="GetFNMachine(3)"> P </button>
                        </div>
                    </td>
                    <td class="td-col-3 align-right">
                        <label> Batch No </label>
                    </td>
                    <td class="td-col-2 align-left">
                        <input id="txtBatchNo" type="text" disabled />
                    </td>
                    <td class="td-col-2 align-right">
                        <label> Status </label>
                    </td>
                    <td class="td-col-3 align-left">
                        <input style="width:78%" id="txtRSState" type="text" disabled />
                    </td>

                </tr>
                <tr>
                    <td class="td-col-3 align-right">
                        <label>Buyer </label>
                    </td>
                    <td class="td-col-7 align-left">
                        <input id="txtBuyer" type="text" disabled />
                    </td>
                    <td class="td-col-3 align-right">
                        <label>Product  </label>
                    </td>
                    <td colspan="3" class="td-col-7 align-left">
                        <input id="txtProduct" type="text" disabled />
                    </td>

                </tr>
                <tr>
                    <td class="td-col-3 align-right">
                        <label>Color & Shade  </label>
                    </td>
                    <td class="td-col-7 align-left">
                        <table style="width:95%">
                            <tr>
                                <td style="width:45%">
                                    <input id="txtColorShade" type="text" disabled />
                                </td>
                                <td style="width:15%">
                                    <label id="lblYPCode">YP No </label>
                                </td>
                                <td style="width:40%">
                                    <input id="txtYPCode" type="text" disabled />
                                </td>
                            </tr>
                        </table>
                    </td>

                    <td class="td-col-3 align-right">
                        <label> Quantity </label>
                    </td>
                    <td class="td-col-2 align-left">
                        <input id="txtQuantity" type="text" disabled />
                    </td>
                    <td class="td-col-2 align-right">
                        <label id="lblDyeingType">Cone</label>
                    </td>
                    <td class="td-col-3 align-left">
                        <input style="width:78%" id="txtDyeingType" type="text" disabled />
                    </td>


                </tr>
                <tr>
                    <td class="td-col-3 align-right">
                        <label>Yarn Out By: </label>
                    </td>
                    <td class="td-col-7 align-left">
                        <input id="txtYarnOutBy" type="text" disabled />
                    </td>

                    <td class="td-col-3 align-right">
                        <label> Yarn Out Time: </label>
                    </td>
                    <td class="td-col-2 align-left">
                        <input id="txtYarnOutTime" type="text" disabled />
                    </td>
                    <td class="td-col-2 align-right"></td>
                    <td class="td-col-3 align-left"></td>

                </tr>
            </table>
        </fieldset>

        <div>
            <div class="region-Styler">
                <fieldset class="process-flied-dye">
                    <legend>Dye Machine Load</legend>
                    <table id="tbl-batch">
                        <tr>
                            <td class="td-col-6 batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboDyeLoadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Load Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="dtDyeLoadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                                @*<input id="tpDyeLoadTime" class="easyui-timespinner" style="width:25%;" required="required" />*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtDyeLoadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnDyeLoad" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <div class="region-Styler">
                <fieldset class="process-flied-dye">
                    <legend>Dye Machine Unload</legend>
                    <table id="tbl-batch">
                        <tr>
                            <td class="td-col-6 batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboDyeUnloadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Unload Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                @*<input id="dtDyeUnloadTime" type="text" class="easyui-datetimebox" style="width:70%" data-options="  showSeconds:false" />*@
                                <input id="dtDyeUnloadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                                @*<input id="tpDyeUnloadTime" class="easyui-timespinner" style="width:25%;" required="required" />*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtDyeUnloadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnDyeUnload" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
        <div>
            <div class="region-Styler">
                <fieldset class="process-flied">
                    <legend>Hydro Machine Load</legend>
                    <table id="tbl-batch">
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Hydro Machine</label>
                            </td>
                            <td class="td-col-14 align-left">
                                <div class="input-group" style="width:90%">
                                    <input id="txtHydroMachineName" onkeydown="SearchKeyFNMachine(event,1)" placeholder="Type Name & Press Enter.." />
                                    <button type="button" aria-label="Left Align" onclick="GetFNMachine(1)"> P </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboHydroLoadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Load Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                @*<input id="dtHydroLoadTime" type="text" class="easyui-datetimebox" style="width:70%" data-options="  showSeconds:false" />*@
                                <input id="dtHydroLoadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Machine Speed</label>
                            </td>
                            <td class="td-col-14 align-left">
                                <div class="input-group" style="width:100%">
                                    <input id="txtMachineSpeed" class="number" placeholder="Type Machine Speed.." />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtHydroLoadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnHydroLoad" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>

                    </table>
                </fieldset>
            </div>
            <div class="region-Styler">
                <fieldset class="process-flied">
                    <legend>Hydro Machine Unload</legend>
                    <table id="tbl-batch">
                        <tr>
                            <td class="td-col-6  batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboHydroUnloadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Unload Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                @*<input id="dtHydroUnloadTime" type="text" class="easyui-datetimebox" style="width:70%" data-options="  showSeconds:false" />*@
                                <input id="dtHydroUnloadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                                @*<input id="tpHydroUnloadTime" class="easyui-timespinner" style="width:25%;" required="required" />*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtHydroUnloadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnHydroUnload" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
        <div>
            <div class="region-Styler">
                <fieldset class="process-flied">
                    <legend>Dryer Machine Load</legend>
                    <table id="tbl-batch">

                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Dryer Machine</label>
                            </td>
                            <td class="td-col-14 align-left">
                                <div class="input-group" style="width:90%">
                                    <input id="txtDryerMachineName" onkeydown="SearchKeyFNMachine(event,2)" placeholder="Type Name & Press Enter.." />
                                    <button type="button" aria-label="Left Align" onclick="GetFNMachine(2)"> P </button>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td class="td-col-6 batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboDryerLoadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Load Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                @*<input id="dtDryerLoadTime" type="text" class="easyui-datetimebox" style="width:70%" data-options="  showSeconds:false" />*@
                                <input id="dtDryerLoadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                                @*<input id="tpDryerLoadTime" class="easyui-timespinner" style="width:25%;" required="required" />*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>R.B Speed</label>
                            </td>
                            <td class="td-col-14 align-left">
                                <div class="input-group" style="width:100%">
                                    <input id="txtRBSpeed" class="number" placeholder="Type Machine Speed.." />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtDryerLoadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnDryerLoad" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <div class="region-Styler">
                <fieldset class="process-flied">
                    <legend>Dryer Machine Unload</legend>
                    <table id="tbl-batch">
                        <tr>
                            <td class="td-col-6 batch-padding align-right">
                                <label>Batch Man </label>
                            </td>
                            <td class="td-col-14 batch-padding align-left">
                                <select id="cboDryerUnloadBatchman" class="process-batchman"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Unload Time </label>
                            </td>
                            <td class="td-col-14 align-left">
                                @*<input id="dtDryerUnloadTime" type="text" class="easyui-datetimebox" style="width:70%" data-options="  showSeconds:false" />*@
                                <input id="dtDryerUnloadTime" style="width:70%;" type="text" class="easyui-datetimebox" required="required" disabled="disabled" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                                @*<input id="tpDryerUnloadTime" class="easyui-timespinner" style="width:25%;" required="required" />*@
                            </td>
                        </tr>
                        <tr>
                            <td class="td-col-6 align-right">
                                <label>Remarks </label>
                            </td>
                            <td class="td-col-14 align-left">
                                <input id="txtDryerUnloadNote" class="process-note" type="text" placeholder="Remarks" />
                                <a id="btnDryerUnload" href="javascript:void(0)" class="easyui-linkbutton process-btn" iconcls="icon-ok" plain="true">Process</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
       
    </div>
</body>

<style type="text/css">
     #tblRouteSheet{
         width:100%;
     }

     #tbl-batch{
         width:100%;
     }

     .td-col-7 input{
         width:90%;
     }

     .region-Styler{
         float:left;
         width:50%;
     }
 
     .td-col-14 select{
         width:70%;
     }
     .td-col-14 input{
         width:68%;
     }
     .process-flied{
         min-height:180px;
     }
     .process-flied-dye{
         min-height:115px;
     }
     .batch-padding{
         padding-top:0px;
     }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oRouteSheet=null;
    var _dtEventTime = new Date();
    var _nEventEmpID = 0;
    var _sNote = "";
    var _oRouteSheetSetup=null;
    var _oAuthorizationRolesMapping=null;
    var _oDyeingProgress=null;
    var _oUser = null;
    $(document).ready(function () {

        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oRouteSheet =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oEmployees =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Employees));
        _oRouteSheetSetup=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RouteSheetSetup));
        _oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oUser =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.User));
        _nBUID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BUID));
        $("#cboDyeLoadBatchman,#cboDyeUnloadBatchman,#cboHydroLoadBatchman,#cboHydroUnloadBatchman,#cboDryerLoadBatchman,#cboDryerUnloadBatchman").icsLoadCombo({
            List: oEmployees,
            OptionValue: "EmployeeID",
            DisplayText: "Name",
            InitialValue:"Default"
        });
        debugger;
        ResetRouteSheetProcess();
        $('#txtRouteSheetNo').focus();

    });


    function HistoryYarnOut(oRSHistorysYarnOut){
        if(oRSHistorysYarnOut.length>0)
        {
            $('#txtYarnOutBy').val(oRSHistorysYarnOut[0].UserName);
            $('#txtYarnOutTime').val(oRSHistorysYarnOut[0].EventTimeStr);
        }
    }

    function ResetRouteSheetProcess(){
        $(".process-batchman").prop('disabled',true);
        $("#dtDyeLoadTime, #dtDyeUnloadTime, #dtHydroLoadTime, #dtHydroUnloadTime, #dtDryerLoadTime, #dtDryerUnloadTime").datetimebox('setValue', "");
        $('.process-note').prop('disabled',true);
        $('#tblRouteSheet input').val('');
        $('#tbl-batch select').val(0);
        $('.process-btn').hide();
        _dtEventTime = new Date();
        _nEventEmpID = 0;
        _sNote = "";
        _oRouteSheet=null;
        _oDyeingProgress=null;
        var nHour=_dtEventTime.getHours();
        var nMin=_dtEventTime.getMinutes();
        if(isNaN(nHour))
        {
            nHour=0;
        }
        if(isNaN(nMin))
        {
            nMin=0;
        }
        //$('#tpDyeLoadTime,#tpDyeUnloadTime,#tpHydroLoadTime,#tpHydroUnloadTime,#tpDryerLoadTime,#tpDryerUnloadTime').timespinner('setValue', nHour+":"+nMin);
    }

    function RefreshControlHistory(nRSState, oRSHs){

        debugger;

        var dtEventTime=new Date();
        var dtCurrentTime=new Date();

        if(dtEventTime>=dtCurrentTime){
            dtCurrentTime=dtEventTime;
            dtCurrentTime.setMinutes(dtCurrentTime.getMinutes()+1);
        }

        dtCurrentTime = icsdatetimeformat(new Date(dtCurrentTime));

        if(nRSState==4) // Wating To Load Dye
        {
            // DYE LOAD
            $('#cboDyeLoadBatchman').prop('disabled',false);
            //$("#dtDyeLoadTime").datetimebox({'disabled':false});
            $('#dtDyeLoadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtDyeLoadNote').prop('disabled',false);    
            
            $('#txtMachine').prop('disabled',false);   
            $('#btnMachine').prop('disabled',false);  
            $('#btnDyeLoad').show();
        }
        else if(nRSState==6) // Dye Loadded
        {            
            // DYE UN-LOAD
            $('#cboDyeUnloadBatchman').prop('disabled',false);
            //$("#dtDyeUnloadTime").datetimebox({'disabled':false});
            $('#dtDyeUnloadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtDyeUnloadNote').prop('disabled',false);
            $('#btnDyeUnload').show();
        }
        else if(nRSState==7) // Dye Unloadded
        {
            // HYDRO LOAD
            $('#cboHydroLoadBatchman').prop('disabled',false);
            //$("#dtHydroLoadTime").datetimebox({'disabled':false});
            $('#dtHydroLoadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtHydroLoadNote').prop('disabled',false);
            $('#btnHydroLoad').show();
            $('#btnDryerLoad').show();
            $('#cboDryerLoadBatchman').prop('disabled',false);
               
        }
        else if(nRSState==8)  // Hydro Loadded
        {
            $('#btnHydroLoad').hide();
            // HYDRO UN-LOAD
            $('#cboHydroUnloadBatchman').prop('disabled',false);
            //$("#dtHydroUnloadTime").datetimebox({'disabled':false});
            $('#dtHydroUnloadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtHydroUnloadNote').prop('disabled',false);
            $('#btnHydroUnload').show();

            // DRYER LOAD
            $('#cboDryerLoadBatchman').prop('disabled',false);
            $("#dtDryerLoadTime").datetimebox({'disabled':false});
            $('#dtDryerLoadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtDryerLoadNote').prop('disabled',false);
            $('#btnDryerLoad').show();
        }
        else if(nRSState==9) // Hydro Unloadded
        {
            $('#btnHydroUnload').hide();

            $('#cboDryerLoadBatchman').prop('disabled',false);
            //$("#dtDryerLoadTime").datetimebox({'disabled':false});
            $('#dtDryerLoadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtDryerLoadNote').prop('disabled',false);
            $('#btnDryerLoad').show();
            $('#cboDryerUnloadBatchman').prop('disabled',false);
            $('#btnDryerUnload').show();
        }
        else if(nRSState==10)
        {            
            $('#btnDryerLoad').hide();
            // HYDRO UN-LOAD
            $('#cboHydroUnloadBatchman').prop('disabled',false);
            //$("#dtHydroUnloadTime").datetimebox({'disabled':false});
            $('#dtHydroUnloadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtHydroUnloadNote').prop('disabled',false);
            $('#btnHydroUnload').show();

            $('#cboDryerUnloadBatchman').prop('disabled',false);
            $("#dtDryerUnloadTime").datetimebox({'disabled':false});
            $('#dtDryerUnloadTime').datetimebox('setValue',(dtCurrentTime));
            $('#txtDryerUnloadNote').prop('disabled',false);
            $('#btnDryerUnload').show();
        }
        else if(nRSState==11)    // DRY UN-LOAD
        {            
            $('#btnHydroUnload').hide();
            $('#btnDryerUnload').hide();
            // HYDRO UN-LOAD
            //$('#cboHydroUnloadBatchman').prop('disabled',false);
            //$("#dtHydroUnloadTime").datetimebox({'disabled':false});
            //$('#dtHydroUnloadTime').datetimebox('setValue',(dtCurrentTime));
            //$('#txtHydroUnloadNote').prop('disabled',false);
            //$('#btnHydroUnload').show();
        }

        if(oRSHs.length>0)
        {
            for(var i=0; i<oRSHs.length; i++)
            {
                dtEventTime=new Date(oRSHs[i].EventTimeStr);

                if(oRSHs[i].CurrentStatus==6)
                {
                    $('#cboDyeLoadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtDyeLoadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtDyeLoadNote').val(oRSHs[i].Note);
                    
                    $('#txtMachine').prop('disabled','disabled');   
                    $('#btnMachine').prop('disabled','disabled');  
                    $('#btnDyeLoad').hide();
                }
                else if(oRSHs[i].CurrentStatus==7)
                {
                    $('#cboDyeUnloadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtDyeUnloadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtDyeUnloadNote').val(oRSHs[i].Note);
                    $('#btnDyeUnload').hide();
                }
                else if(oRSHs[i].CurrentStatus==8)
                {
                    $('#cboHydroLoadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtHydroLoadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtHydroLoadNote').val(oRSHs[i].Note);
                    $('#btnHydroLoad').hide();
                }
                else if(oRSHs[i].CurrentStatus==9)
                {
                    $('#cboHydroUnloadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtHydroUnloadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtHydroUnloadNote').val(oRSHs[i].Note);
                    $('#btnHydroUnload').hide();
                   
                }
                else if(oRSHs[i].CurrentStatus==10)
                {
                    $('#cboDryerLoadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtDryerLoadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtDryerLoadNote').val(oRSHs[i].Note);
                    $('#btnDryerLoad').hide();
                }
                else if(oRSHs[i].CurrentStatus==11)
                {
                    $('#cboDryerUnloadBatchman').val(oRSHs[i].EventEmpID);
                    $('#dtDryerUnloadTime').datetimebox('setValue', oRSHs[i].EventTimeStr);
                    $('#txtDryerUnloadNote').val(oRSHs[i].Note);
                    $('#btnDryerUnload').hide();
                }
            }
        }
    }

    function GetDateTime(dt)
    {

        var date=new Date(dt);
        var nMonth=date.getMonth()+1;
        var nDate=date.getDate();
        var nYear=date.getFullYear();
        var nHour=date.getHours();
        var nMin=date.getMinutes();

        if(nMonth<10)
        {
            nMonth='0'+nMonth;
        }
        if(nDate<10)
        {
            nDate='0'+nDate;
        }
        if(nHour<10)
        {
            nHour='0'+nHour;
        }
        if(nMin<10)
        {
            nMin='0'+nMin;
        }
        date= nMonth+'/'+nDate+'/'+nYear+' '+nHour+':'+nMin;

        return date;

    }

    /*----------Routesheet Pick----------------*/

    $("#txtRouteSheetNo").keyup(function (e) {//keydown
        //var nkeyCode = e.keyCode || e.which;
        var nkeyCode = (e.keyCode ? e.keyCode : e.which);
        debugger;
        if($.trim($("#txtRouteSheetNo").val()).length==9){
            GetRouteSheetForProcess("", $.trim($("#txtRouteSheetNo").val()));
        }
        else if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtRouteSheetNo").val());
            if(sRouteSheetNo==""){ alert("Type Batch no/Dyeing Card no to search."); return false; }
            GetsRouteSheet(sRouteSheetNo);
          //  GetRouteSheetForProcess(sRouteSheetNo, 0);
        }
        else if(nkeyCode==8){
            if($.trim($("#txtRouteSheetNo").val())==''){
                ResetRouteSheetProcess();
            }

        }
    });

    function GetsRouteSheet(sRouteSheetNo){

        debugger;
        var oRouteSheet = {
            RouteSheetNo:sRouteSheetNo
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheetHistory",
            ActionName: "GetsRouteSheet",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "RouteSheet No", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNoFull", title: "OrderNo", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 80, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MachineName", title: "Machine Name", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "RSStateStr", title: "Status", width: 100, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRouteSheetPicker',
                        winclass:'clsRouteSheetPicker',
                        winwidth: 450,
                        winheight: 460,
                        tableid: 'tblRouteSheetPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'RouteSheetNo',
                        windowTittle: 'RouteSheet List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeRouteSheetPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No routesheet found.");
            }
        });


    }

    function IntializeRouteSheetPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            RouteSheetSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                RouteSheetSelect(oPickerobj);
            }
        });
    }

    function RouteSheetSelect(oPickerobj){
        var oRouteSheet = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winRouteSheetPicker')
        {
            if(oRouteSheet !=null  && oRouteSheet.RouteSheetID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                GetRouteSheetForProcess("", oRouteSheet.RouteSheetID);
            }
            else{
                alert("Please select routesheet.");
            }
        }
    }

    //$("#txtBatchNo").keydown(function (e) {
    //    var nkeyCode = e.keyCode || e.which;
    //    if(nkeyCode==13){
    //        var sRouteSheetNo=$.trim($("#txtBatchNo").val());
    //        if(sRouteSheetNo==""){ alert("Type Batch no/Dyeing Card no to search."); return false; }
    //        GetRouteSheetForProcess(sRouteSheetNo);
    //    }
    //    else if(nkeyCode==8){
    //        if($.trim($("#txtRouteSheetNo").val())==''){
    //            ResetRouteSheetProcess();
    //        }
    //    }
    //});

    function GetRouteSheetForProcess(sRouteSheetNo, nRSID){

        ResetRouteSheetProcess();

        var oRouteSheet = {
            RouteSheetNo:sRouteSheetNo,
            RouteSheetID: nRSID
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetRouteSheetForProcess",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) {
                    _oRouteSheet=response.obj;
                    debugger;
                    
                    $('#txtRouteSheetNo').val(response.obj.RouteSheetNo);
                    $('#txtBatchNo').val(response.obj.RouteSheetNo);

                    $('#txtRouteSheetNo').val(_oRouteSheet.RouteSheetNo);
                    $('#txtBatchNo').val(_oRouteSheet.RouteSheetNo);
                    _oDyeingProgress= _oRouteSheet.DyeingProgress;
                    $('#txtMachine').val(_oRouteSheet.MachineName);
                    $('#txtRSState').val(_oRouteSheet.RSStateStr);
                    $('#txtOrderNo').val(_oRouteSheet.OrderNoFull);

                    $('#txtBuyer').val(_oRouteSheet.PTU.BuyerName);
                    $('#txtProduct').val(_oRouteSheet.ProductName);

                    $('#txtColorShade').val(_oRouteSheet.PTU.ColorNameShade);
                    $('#txtQuantity').val(formatPrice(_oRouteSheet.Qty+" "+_oRouteSheetSetup.MUnit));
                    $('#lblDyeingType').html("No Of "+_oRouteSheet.DyeingType);
                    $('#txtDyeingType').val(_oRouteSheet.NoOfHanksCone);
                    $("#txtHydroMachineName").val(_oDyeingProgress.MachineName_Hydro);
                    $("#txtDryerMachineName").val(_oDyeingProgress.MachineName_Dryer);
                    $("#txtMachineSpeed").val(_oDyeingProgress.MachineSpeed);
                    $("#txtRBSpeed").val(_oDyeingProgress.RBSpeed);

                    $("#lblYPCode").text(_oRouteSheetSetup.BatchCode);
                    $("#txtYPCode").val(_oDyeingProgress.Params);

                    $('#txtYarnOutBy').val(_oDyeingProgress.UserName);
                    $('#txtYarnOutTime').val(_oDyeingProgress.EventTimeStr);

                    RefreshControlHistory(response.obj.RSState,response.obj.RSHistorys);
                }
                else { alert(response.obj.ErrorMessage); }
            }
            else{
                alert("No routesheet found.");
            }
        });


    }

    /*----------Routesheet Pick----------------*/

    /*=============== MACHINE PICK ============*/

    function SetHydroMachien(oResult)
    {
        console.log(oResult);
        $("#txtHydroMachineName").val(oResult.Name);
        _oDyeingProgress.MachineID_Hydro = oResult.MachineID;
    }
    function SetDryerMachien(oResult)
    {
        console.log(oResult);
        $("#txtDryerMachineName").val(oResult.Name);
        _oDyeingProgress.MachineID_Dryer = oResult.MachineID;
    }
    function UpdateDyeMachine(oResult)
    {
        if(oResult.MachineID<=0 || isNaN(parseInt(oResult.MachineID)))
        {
            alert("Please select a dye machine & try again!"); return;
        } 
        if(_oRouteSheet.RouteSheetID<=0 || isNaN(parseInt(_oRouteSheet.RouteSheetID)))
        {
            alert("Please select a valid batch card & try again!"); return;
        }

        if(!confirm("Confirm to update dye machine?"))
        {
            $('#txtMachine').val(_oRouteSheet.MachineName); return;
        }

        var oRSH=
            {
                MachineID : oResult.MachineID,
                RouteSheetID: _oRouteSheet.RouteSheetID
            }
        
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSH,
            ObjectId: 0,
            ControllerName: "RouteSheet",
            ActionName: "UpdateMachine",
            TableId: "",
            IsWinClose: false,
            Message: "Batch card updated successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) 
                {
                    _oRouteSheet.MachineID = response.obj.MachineID;
                    _oRouteSheet.MachineName = response.obj.MachineName;
                }
            }
            //else
            //{
            //    _oRouteSheet.MachineID
            //}
        });
    }
    function SearchKeyFNMachine(e, nType)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            debugger;

            var sMachineName ="";
            if(nType==1) sMachineName = $.trim($("#txtHydroMachineName").val());
            if(nType==2) sMachineName = $.trim($("#txtDryerMachineName").val());
            if(nType==3) sMachineName = $.trim($("#txtMachine").val());

            if (sMachineName.length == 0)
            {
                alert("Please Type Machine Name To Search !");
                if(nType==1) $("#txtHydroMachineName").focus();
                if(nType==2) $("#txtDryerMachineName").focus();
                if(nType==3) $("#txtMachine").focus();

                return false;
            }
            GetFNMachine(nType, sMachineName);
        }
        else if(code==27 || code==08)
        {
            if(nType==1) ResetHydroMachine();
            if(nType==2) ResetDryerMachine();
        }
    };

    function GetFNMachine(nType, sMachineName)
    {
        var oFNMachine = {
            Name: $.trim(sMachineName),
            BUID: _nBUID,
        };

        var sActionName = "GetsMachine_Hydro";
        var sControllerName = "RouteSheet";

        if(nType==2) sActionName= "GetsMachine_Dryer";

        if(nType==3) 
        {
            sControllerName = "DUPSchedule";
            sActionName= "GetsMachine";
        }

        var obj = {
            BaseAddress:_sBaseAddress,
            Object: oFNMachine,
            ControllerName: sControllerName, //TechnicalSheet
            ActionName: sActionName,//ViewStyleSearch
            IsWinClose: false
        };

        var tblColums = [];
        var oColumn = { field: "Code", title: "Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Name", title: "Name", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "LocationName", title: "Location", width: 90, align: "right" }; tblColums.push(oColumn);
        //oColumn = { field: "FNMachineTypeSt", title: "Type", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "MachineTypeName", title: "MachineTypeName", width: 90, align: "left" }; tblColums.push(oColumn);

        var oPickerParam = {
            winid: 'winFNBatchers',
            winclass: 'clsFNBatcher',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBatchers',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'Name',
            windowTittle: 'Machine List',
            paramObj: obj,
            pkID: 'MachineID',
            callBack: SetHydroMachien
        };

        if(nType==2) oPickerParam.callBack = SetDryerMachien;
        if(nType==3) oPickerParam.callBack = UpdateDyeMachine;

        $.icsDynamicPicker(oPickerParam);
    }
    /*================= MACHINE END ============*/

    function Validation(nRSState){

        if(_oRouteSheet==null || _oRouteSheet.RouteSheetID<=0){
            $('#txtRouteSheetNo').focus();
            $('#txtRouteSheetNo').addClass("errorFieldBorder");
            alert('No Routesheet Found.');
            return false;
        }
        else{
            $('#txtRouteSheetNo').removeClass("errorFieldBorder");
        }

        if(nRSState==6)
        {
            if($('#cboDyeLoadBatchman').val()<=0){
                $('#cboDyeLoadBatchman').focus();
                $('#cboDyeLoadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboDyeLoadBatchman').removeClass("errorFieldBorder");
            }

            //if(new Date($('#dtDyeLoadTime').datetimebox('getValue'))< new Date(GetDateTime(new Date()))){
            //    alert("Dye load time must be later or equal current time.");
            //    return false;
            //}
            _nEventEmpID=$('#cboDyeLoadBatchman').val();
            _sNote= $.trim($('#txtDyeLoadNote').val());

            _dtEventTime =$('#dtDyeLoadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);
        }
        else if(nRSState==7){

            if($('#cboDyeUnloadBatchman').val()<=0){
                $('#cboDyeUnloadBatchman').focus();
                $('#cboDyeUnloadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboDyeUnloadBatchman').removeClass("errorFieldBorder");
            }

            if(new Date($('#dtDyeUnloadTime').datetimebox('getValue'))< new Date($('#dtDyeLoadTime').datetimebox('getValue'))){
                alert("Dye unload time must be later than dye load time.");
                return false;
            }
            _nEventEmpID=$('#cboDyeUnloadBatchman').val();
            //_dtEventTime=$('#dtDyeUnloadTime').datetimebox('getValue');
            _sNote= $.trim($('#txtDyeUnloadNote').val());
            _dtEventTime =$('#dtDyeUnloadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);
        }

        else if(nRSState==8)
        {
            if($('#cboHydroLoadBatchman').val()<=0){
                $('#cboHydroLoadBatchman').focus();
                $('#cboHydroLoadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboHydroLoadBatchman').removeClass("errorFieldBorder");
            }

            if(new Date($('#dtHydroLoadTime').datetimebox('getValue'))< new Date($('#dtDyeLoadTime').datetimebox('getValue'))){
                alert("Hydro load time must be later than dye load time.");
                return false;
            }
            _nEventEmpID=$('#cboHydroLoadBatchman').val();
            _sNote= $.trim($('#txtHydroLoadNote').val());
            _dtEventTime =$('#dtHydroLoadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);
        }

        else if(nRSState==9){

            if($('#cboHydroUnloadBatchman').val()<=0){
                $('#cboHydroUnloadBatchman').focus();
                $('#cboHydroUnloadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboHydroUnloadBatchman').removeClass("errorFieldBorder");
            }

            if(new Date($('#dtHydroUnloadTime').datetimebox('getValue'))< new Date($('#dtHydroLoadTime').datetimebox('getValue'))){
                alert("Hydro unload time must be later than hydro load time.");
                return false;
            }
            _nEventEmpID=$('#cboHydroUnloadBatchman').val();
            _sNote= $.trim($('#txtHydroUnloadNote').val());
            _dtEventTime =$('#dtHydroUnloadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);

        }

        else if(nRSState==10){

            if($('#cboDryerLoadBatchman').val()<=0){
                $('#cboDryerLoadBatchman').focus();
                $('#cboDryerLoadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboDryerLoadBatchman').removeClass("errorFieldBorder");
            }

            if(new Date($('#dtDryerLoadTime').datetimebox('getValue'))< new Date($('#dtHydroLoadTime').datetimebox('getValue'))){
                alert("Dryer load time must be later than hydro load time.");
                return false;
            }
            _nEventEmpID=$('#cboDryerLoadBatchman').val();
            //_dtEventTime=$('#dtDryerLoadTime').datetimebox('getValue');
            _sNote= $.trim($('#txtDryerLoadNote').val());

            _dtEventTime =$('#dtDryerLoadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);
        }
        else if(nRSState==11)
        {

            if($('#cboDryerUnloadBatchman').val()<=0){
                $('#cboDryerUnloadBatchman').focus();
                $('#cboDryerUnloadBatchman').addClass("errorFieldBorder");
                alert('Select Batchman.');
                return false;
            }
            else{
                $('#cboDryerUnloadBatchman').removeClass("errorFieldBorder");
            }

            if(new Date($('#dtDryerUnloadTime').datetimebox('getValue'))< new Date($('#dtDryerLoadTime').datetimebox('getValue'))){
                alert("Dryer unload time must be later than dryer load time.");
                return false;
            }
            _nEventEmpID=$('#cboDryerUnloadBatchman').val();
            _sNote= $.trim($('#txtDryerUnloadNote').val());

            _dtEventTime =$('#dtDryerUnloadTime').datetimebox('getValue');
            _dtEventTime = new Date(_dtEventTime);
        }
        else 
        {
            alert("Dyeing process completed. Please try with another routesheet.");
            return false;
        }
        return true;
    }
    function RefreshObject(nRSState)
    {
        var oRSH={
            RouteSheetHistoryID: 0,
            RouteSheetID : _oRouteSheet.RouteSheetID,
            EventTime : _dtEventTime,
            EventEmpID : _nEventEmpID,
            CurrentStatus : nRSState,
            PreviousState : _oRouteSheet.RSState,
            MachineSpeed : $('#txtMachineSpeed').val(),
            RBSpeed : $('#txtRBSpeed').val(),
            MachineID_Hydro : _oDyeingProgress.MachineID_Hydro,
            MachineID_Dryer : _oDyeingProgress.MachineID_Dryer,
            Note : _sNote,
        };
        return oRSH;
    }
    function SaveRouteSheetProgress(datetimeboxId, nRSState)
    {
        debugger;
        if(!Validation(nRSState)) return false;

        var oRSH=RefreshObject(nRSState); console.log(oRSH); //return;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSH,
            ObjectId: 0,
            ControllerName: "RouteSheet",
            ActionName: "RouteSheetProgressHistory",
            TableId: "",
            IsWinClose: false,
            Message: "Process execute Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetHistoryID > 0) {
                    _oRouteSheet.RSState=response.obj.CurrentStatus;
                    _oRouteSheet.RSStateStr=response.obj.CurrentStatusStr;


                    _oDyeingProgress.MachineID_Hydro = response.obj.MachineID_Hydro,
                    _oDyeingProgress.MachineID_Dryer = response.obj.MachineID_Dryer,

                    $('#txtRSState').val(response.obj.CurrentStatusStr);
                    $(".process-batchman").prop('disabled',true);
                    $('.process-btn').hide();
                    $('.process-note').prop('disabled',true);
                    $('#'+datetimeboxId).datetimebox({'disabled':true});
                    $('#'+datetimeboxId).datetimebox('setValue', icsdatetimeformat(new Date()));
                    
                    _oRouteSheet.RSHistorys.push(response.obj);
                    RefreshControlHistory(response.obj.CurrentStatus, _oRouteSheet.RSHistorys);
                    
                    if(nRSState==8)  // Hydro Loadded
                        $('#btnHydroLoad').hide();
                    else if(nRSState==9) // Hydro Unloadded
                        $('#btnHydroUnload').hide();
                    else if(nRSState==10)
                        $('#btnDryerLoad').hide();
                    else if(nRSState==11)    // DRY UN-LOAD
                    {   
                        $('#btnHydroUnload').hide();
                        $('#btnDryerUnload').hide();
                    }
                }
            }
        });
    }


    $("#btnDyeLoad").click(function (){ SaveRouteSheetProgress('dtDyeLoadTime', 6); });
    $("#btnDyeUnload").click(function (){ SaveRouteSheetProgress('dtDyeUnloadTime',7); });
    $("#btnHydroLoad").click(function (){ SaveRouteSheetProgress('dtHydroLoadTime',8); });
    $("#btnHydroUnload").click(function (){ SaveRouteSheetProgress('dtHydroUnloadTime',9); });
    $("#btnDryerLoad").click(function (){ SaveRouteSheetProgress('dtDryerLoadTime',10); });
    $("#btnDryerUnload").click(function (){ SaveRouteSheetProgress('dtDryerUnloadTime',11); });

    $('#btnPrint').click(function (e)
    {
       
        if (_oRouteSheet ==null || _oRouteSheet.RouteSheetID <=0 ) { alert("Require Batch No."); $('#txtRouteSheetNo').focus(); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheet?nId="+_oRouteSheet.RouteSheetID+"&bIsCommon="+true+"&nts="+tsv, "_blank");
    });


</script>