@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Assign Bill";
}
@model ESimSol.BusinessObjects.ExportPI
<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>
<div class="menuMainCollectionTable" style="width:100%;height:100%">
    <div class="easyui-panel" title="" style="font-family:Tahoma; text-align:center; height:89%;">
        <div id="tabExportPITabs" class="easyui-tabs" style="width:100%; height:100%;">
            <div  title="Export PI" style="width:100%;height:100%">
                <div id="divPIInformation">
                    <fieldset>
                        <legend style="font-weight:bold"> PI Information : </legend>
                        <table border="0" cellspacing="1" cellpadding="1" style="width:100%;text-align:left;">
                            <tr>
                                <td style="width:12%; text-align:right">
                                    Unit :
                                </td>
                                <td style="width:15%">
                                    <select id="cboBUType" onchange="cboBUChange()" style=" width:100%;"></select>
                                </td>
                                <td style="width:9%; text-align:right">
                                    P/I No :
                                </td>
                                <td style="width:12%">@Html.TextBoxFor(model => model.PINo, new { style = "width:100%;", id = "txtPINo", placeholder = "Auto Generated", disabled = "disabled" })</td>
                                <td style="width:12%;text-align:right;">PI Type : </td>
                                <td style="width:15%">
                                    <select id="cboPIType" style="width:48%;" class="changePIType">
                                        <option value="0">Open</option>
                                        <option value="1">PO</option>
                                    </select>
                                    <select id="cboPaymentType" style=" width:48%;"></select>
                                </td>
                                <td style="width:12%;text-align:right;">Issue Date : </td>
                                <td style="width:9%"><input type="text" style="width:100%;" id="txtIssueDate" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </tr>
                            <tr>
                                <td style="width:12%; text-align:right">
                                    Account Of:
                                </td>
                                <td style="width:15%">@Html.TextBoxFor(model => model.ContractorName, new { style = "width:100%;", id = "txtContractorName", placeholder = "Type & Press Enter" })</td>
                                <td style="width:9%;text-align:right;">C.Person: </td>
                                <td style="width:12%"><select id="cboContractorContactPerson" style=" width:100%;"></select></td>
                                <td style="width:12%; text-align:right">
                                    <span class="lblBUSName"></span>  Concern Person:
                                </td>
                                <td style="width:15%"><select id="cboMktPersons" style="width:100%;"></select></td>
                                <td style="width:12%;text-align:right;">Validate Date : </td>
                                <td style="width:9%"><input type="text" style="width:100%;" id="txtValidateDate" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                            </tr>
                            <tr>
                                <td style="width:12%; text-align:right">
                                    Buying House :
                                </td>
                                <td style="width:15%">@Html.TextBoxFor(model => model.BuyerName, new { style = "width:100%;", id = "txtBuyerName", placeholder = "Type & Press Enter" }) </td>
                                <td style="width:9%;text-align:right;">C.Person: </td>
                                <td style="width:12%"><select id="cboBuyerContactPerson" style=" width:100%;"></select></td>
                                <td style="width:12%; text-align:right">
                                    Yarn Count  :
                                </td>
                                <td style="width:15%">@Html.TextBoxFor(model => model.YarnCount, new { style = "width:100%;", id = "txtYarnCount" })</td>
                                <td style="width:12%;text-align:right;">Currency: </td>
                                <td style="width:9%"><select id="cboCurrency" style=" width:100%;" name="cboCurrency" class="_select_changeA"></select></td>
                            </tr>
                            <tr>
                                <td style="width:12%; text-align:right">
                                    Delivery To :
                                </td>
                                <td style="width:36%" colspan="3">@Html.TextBoxFor(model => model.DeliveryToName, new { style = "width:100%;", id = "txtDeliveryToName", placeholder = "Type & Press Enter" }) </td>
                                <td style="width:12%; text-align:right">
                                    Color Info :
                                </td>
                                <td style="width:15%">@Html.TextBoxFor(model => model.ColorInfo, new { style = "width:100%;", id = "txtColorInfo" }) </td>
                                <td style="width:12%;text-align:right;">Depth of Shade : </td>
                                <td style="width:9%;text-align:right;"><select id="cboDepthOfShade" style="width:100%;"></select></td>
                            </tr>
                            <tr>
                                <td style="width:12%; text-align:right">
                                    Advising Bank :
                                </td>
                                <td style="width:15%"><select style="width:100%;" id="cboBank" /></td>
                                <td style="width:9%;text-align:right;">Bank Account : </td>
                                <td style="width:12%"><select style="width:100%;" id="cboBankAccount" /></td>

                                <td style="width:12%; text-align:right">
                                    Note :
                                </td>
                                <td style="width:36%" colspan="3">
                                    @Html.TextBoxFor(model => model.Note, new { style = "width:100%;", id = "txtNote" })
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
                <table id="tblExportPIDetail" title="Products/Item Description" class="easyui-datagrid" style="width:100%;height:260px;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarPIDetail">
                    <thead>
                        <tr>
                            <th field="ProductCode" width="120" align="left">Product Code</th>
                            <th field="ProductName" width="120" align="left">Name</th>
                            <th field="FSCNo" width="120" align="left">PO No</th>
                            <th field="FabricNo" width="120" align="left"><label id="lblFabricNo2">Mkt Ref No</label></th>
                            <th field="Construction" width="120">Construction</th>
                            <th data-options="field:'ColorInfo',width:120,height:60 ,align:'Left',editor:{type:'text'}" align="Left">ColorInfo</th>

                            <th data-options="field:'Qty',width:100,align:'right',editor:{type:'numberbox',options:{precision:8}}" align="right">Qty(Y)</th>
                            @*<th field="MUName" width="70" align="left">Unit</th>*@
                            <th data-options="field:'UnitPrice',width:60,align:'right',editor:{type:'numberbox',options:{precision:8}}" formatter="formatPricePrice" align="right">UP(Y)</th>
                            <th data-options="field:'QtyTwo',width:100,align:'right',editor:{type:'numberbox',options:{precision:8}}" align="right">Qty(M)</th>
                            @*<th field="MUNameTwo" width="70" align="left">Unit</th>*@
                            <th data-options="field:'UnitPriceTwo',width:60,align:'right',editor:{type:'numberbox',options:{precision:8}}" formatter="formatPricePrice" align="right">UP(M)</th>
                            <th field="AmountSt" width="100" align="right">Value</th>

                            <th data-options="field:'StyleNo',width:100,height:60 ,align:'Left',editor:{type:'text'}" align="Left">Style No</th>
                            <th field="FabricWidth" width="80">Fabric Width</th>
                            <th data-options="field:'BuyerReference',width:100,height:60 ,align:'Left',editor:{type:'text'}" align="Left">B.Ref</th>

                            @*<th data-options="field:'AdjQty',width:100,align:'right',editor:{type:'numberbox',options:{precision:4}}" align="right">AdjQty</th>
                                <th data-options="field:'AdjRate',width:100,align:'right',editor:{type:'numberbox',options:{precision:4}}" align="right">AdjRate</th>*@
                            <th data-options="field:'DocCharge',width:100,align:'right',editor:{type:'numberbox',options:{precision:4}}" align="right">DocCharge</th>
                            <th data-options="field:'CRate',width:100,align:'right',editor:{type:'numberbox',options:{precision:4}}" align="right">CRate</th>
                            @*<th field="AdjValue" width="100" align="right">AdjValue</th>*@
                        </tr>
                    </thead>
                </table>

                <div id="toolbarPIDetail">
                    @*<label id="lblExportPIDetailLabel">Product :</label>*@

                    @*<input id="txtFabricSCDetail" class="fabricFabricSCDetail" type="text" placeholder="Type PO No & Press Enter" />*@
                    @*<input id="btnPickFabricSCDetail" class="fabricFabricSCDetail" type="button" value="P" />*@
                    @*<input id="txtFabricNoExportPIDetail" class="fabricItemsExportPI" type="text" placeholder="Type P Number & Press Enter" />*@
                    @*<input id="btnPickFabricExportPIDetail" class="fabricItemsExportPI" type="button" value="P" />*@
                    @*<input type="text" id="txtProductName" class="productItemsExportPI" placeholder="Type Product & Press Enter" style="width:15%;" />*@
                    @*<input id="btnProductPiker" class="productItemsExportPI" type="button" value="P" />*@
                    @*<a id="btnPickOrderSheet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Pick</a>*@
                    <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    @*<a id="btnRefreshPIDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>*@
                    @*<a id="btnPickDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Change</a>*@
                    @*<a id="btnCopyDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" onclick="CopyDetail()" plain="true">Copy</a>*@
                    <a id="btnProductFormDeliveryBill" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">Add From Bill</a>
                </div>

                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                    <tr>
                        <td style="width:65%;  text-align:right;font-weight:bold;">Total:</td>
                        <td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label> </td>
                        <td style="width:2%;  text-align:right;font-weight:bold;"> </td>
                        <td style="width:15%; text-align:right; font-weight:bold;"><label id="lblTotalValue"> </label> </td>
                        <td style="width:3%;  text-align:right;font-weight:bold;"> </td>
                    </tr>
                </table>

            </div>

            <div title="Terms & Condition" style="padding:2px">
                <fieldset id="fsTemsCondition">
                    <legend style="font-weight:bold"> Terms & Conditions : </legend>
                    <table border="0" cellspacing="2" cellpadding="2" class="CaptionStyle" style="width:100%;">
                        <tr>
                            <td style="width:15%; text-align:right">Libor Rate</td>
                            <td style="width:18%"><select id="cboLiborRate" style="width:100%" /></td>
                            <td style="width:15%; text-align:right">LC Terms</td>
                            <td style="width:18%"><select style="width:100%;" id="cboLCTerm" /></td>
                            <td style="width:15%; text-align:right">App LC Open Date</td>
                            <td style="width:18%"><input type="text" style="width:100%;" id="txtLCOpenDate" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                        </tr>
                        <tr>
                            <td style="width:15%; text-align:right">Bank FDD</td>
                            <td style="width:18%"><select id="cboBankFDD" style="width:100%" /></td>
                            <td style="width:15%; text-align:right">Over Due Rate(%)</td>
                            <td style="width:18%">@Html.TextBoxFor(model => model.OverdueRateSt, new { style = "width:100%;", id = "txtOverDueRate" })</td>
                            <td style="width:15%; text-align:right">App Delivery Date</td>
                            <td style="width:18%"><input type="text" style="width:100%;" id="txtDeliveryDate" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                        </tr>
                        <tr>
                            <td style="width:15%; text-align:right">Shipment Term</td>
                            <td style="width:18%"><select id="cboShipmentTermFDD" style="width:100%" /></td>
                            <td style="width:15%; text-align:right">Note(Non Print)</td>
                            @*<td style="width:18%"></td>
                                <td style="width:15%; text-align:right"></td>
                                <td style="width:18%"></td>*@
                            <td colspan="3" style="width:50%"><input type="text" style="width:100%;" id="txtNoteTwo" /></td>
                        </tr>
                    </table>
                </fieldset>
                <table id="tblPITandCClauses" title="Commercial Terms and Condition" class="easyui-datagrid" style="width:100%; height:340px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#TCtoolbar" data-options="singleSelect: true, fitColumns:false,  rownumbers:true,pagination:false,autoRowHeight:false">
                    <thead>
                        <tr>
                            <th field="CaptionName" width="12%">Caption</th>
                            <th field="TermsAndCondition" width="88%" align="left" data-options="field:'TermsAndCondition',editor:{type:'text',options:{precision:0}}"> Terms & Condition </th>
                        </tr>
                    </thead>
                </table>
                <div id="TCtoolbar" style=" height:25px;">
                    @*Ratin*@
                    <a id="btnAddTermsAndConditon" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick Term And Condition</a>
                    <a id="btnRemoveTermsAndCondition" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    <a id="btnRemoveTnCALL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove All</a>
                    <a id="btnRefreshTermsAndCondition" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                </div>
            </div>
            <div id="divPIPreview" title="PI Preview" style="padding:2px; margin-top:3px">
                <fieldset>
                    <table border="0" cellspacing="2" cellpadding="2" style="width:100%">
                        <tr>
                            <td style="width:100%; text-align:center">
                                <input type="text" style="width:100%;" id="txtSetupNote" readonly="readonly" />
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <table border="0" cellspacing="2" cellpadding="2" style="width:100%">
                        <tr>
                            <td style="width:100%; text-align:center">
                                <input type="text" style="width:100%;" id="txtPreface" disabled="disabled" />
                            </td>

                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <table id="tblShipment" border="0" cellspacing="2" cellpadding="2" class="CaptionStyle" style="width:100%">
                        <tr>
                            <td style="width:15%; text-align:right">
                                Part Shipment
                            </td>
                            <td style="width:30%; text-align:right">
                                <input type="text" style="width:100%;" id="txtPartShipment" disabled="disabled" />
                            </td>
                            <td style="width:10%; text-align:right"></td>
                            <td style="width:15%; text-align:right">
                                Shipment By
                            </td>
                            <td style="width:30%">
                                <input type="text" style="width:100%;" id="txtShipmentBy" disabled="disabled" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:15%; text-align:right">
                                Place Of Shipment
                            </td>
                            <td style="width:30%">
                                <input type="text" style="width:100%;" id="txtPlaceofShipment" disabled="disabled" />
                            </td>
                            <td style="width:10%; text-align:right"></td>
                            <td style="width:15%; text-align:right">
                                Place Of Delivery
                            </td>
                            <td style="width:30%">
                                <input type="text" style="width:100%;" id="txtPlaceofDelivery" disabled="disabled" />
                            </td>
                        </tr>
                    </table>
                </fieldset>

                <fieldset>
                    <table border="0" cellspacing="2" cellpadding="2" style="width:100%">
                        <tr>
                            <td style="width:48%; text-align:center">
                                <input type="text" style="width:100%;" id="txtAcceptanceBy" disabled="disabled" />
                            </td>
                            <td style="width:4%"></td>
                            <td style="width:48%; text-align:center">
                                <input type="text" style="width:100%;" id="txtFor" disabled="disabled" />
                            </td>

                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>
    </div>

    <fieldset>
        <legend style="font-weight: bold">Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
            <tr>
                <td style="width:10%;text-align:right;">
                    <a id="btnPrintPI" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print PI</a>

                </td>
                <td style="width:62%; text-align:right"></td>
                <td style="width:18%;text-align:right;">
                    <label id="lblCreateReviseNo">Create New version?</label>  <input id="chkIsCreateReviseNo" type="checkbox" checked="checked" />
                </td>
                <td style="width:5%;text-align:right;">
                    <a id="btnCopy" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true">Copy</a>
                    <a id="btnAcceptReviseExportPI" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save(Revise)</a>
                </td>
                <td style="width:5%;text-align:right;">
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-closed" plain="true" onclick="Close()">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>
<div id="winExPIDetail" style="width:550px;" class="easyui-window" title="Fabric info" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div>
        <fieldset>
            <legend style="font-weight:bold"> Composition Informations : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold">

                <tr>
                    <td style="width:30%;text-align:right">
                        Mkt Ref:
                    </td>

                    <td style="width:20%">
                        <input type="text" id="txtFabricNo_F" disabled="disabled" style="width:100%" />
                    </td>
                    <td style="width:20%;text-align:right">
                        PO No:
                    </td>
                    <td style="width:30%">
                        <input type="text" id="txtFSCNo" disabled="disabled" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:30% ;text-align:right">
                        <label style="width:100%">Composition:</label>
                    </td>
                    <td colspan="3" style="width:70%">
                        <select style="width:100%" id="cboProductFabric"></select>
                    </td>

                </tr>

                <tr>
                    <td style="width:30%;text-align:right">
                        Construction:
                    </td>

                    <td style="width:20%">
                        <input type="text" id="txtConstruction_F" style="width:100%" />
                    </td>
                    <td style="width:20%;text-align:right">
                        Width:
                    </td>
                    <td style="width:30%">
                        <input type="text" id="txtFabricWidthFabric" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:30%;text-align:right">
                        <label style="width:100%">Process Type:</label>
                    </td>
                    <td style="width:20% ;text-align:left">
                        <select style="width:100%" id="cboProcessTypeFabric"></select>
                    </td>

                    <td style="width:20%;text-align:right">
                        <label>Style:</label>
                    </td>
                    <td style="width:30%;text-align:left">
                        <input id="txtStyleNoFabric" type="text" style="width:100%" />
                    </td>

                </tr>

                <tr>
                    <td style="width:30%;text-align:right">
                        <label style="width:100%">Weave:</label>
                    </td>
                    <td style="width:20%;text-align:left">
                        <select style="width:100%" id="cboWeaveFabric"></select>
                    </td>
                    <td style="width:20%;text-align:right">
                        <label>Color:</label>
                    </td>
                    <td style="width:30%">
                        <input id="txtColorFabric" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:30% ;text-align:right">
                        <label style="width:100%">Finish Type:</label>
                    </td>
                    <td style="width:20%">
                        <select style="width:100%" id="cboFinishTypeFabric"></select>
                    </td>
                    <td style="width:20% ;text-align:right">
                        <label style="width:100%">B.Ref :</label>
                    </td>
                    <td style="width:30% ;text-align:left">
                        <input id="txtBRef" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:30% ;text-align:right">
                        <label style="width:100%">Weight:</label>
                    </td>
                    <td style="width:20%">
                        <input id="txtWeight" type="text" style="width:100%" />
                    </td>
                    <td style="width:20% ;text-align:right">
                        <label style="width:100%">Shrinkage :</label>
                    </td>
                    <td style="width:30% ;text-align:left">
                        <input id="txtShrinkage" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:20% ;text-align:right">
                        <label style="width:100%">Quality:</label>
                    </td>
                    <td colspan="3" style="width:60%">
                        <select style="width:100%" id="cboEQuality"></select>
                    </td>
                </tr>
                <tr>
                    <td style="width:20% ;text-align:right">
                        <label>Note:</label>
                    </td>
                    <td colspan="3" style="width:30%">
                        <input id="txtNoteDetail" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr id="trIsDeduct" style="text-align:left;">
                    <td style="width:20% ;text-align:right">
                        <label>Is Deduct?:</label>
                    </td>
                    <td colspan="3" style="width:80%">
                        <table>
                            <tr>
                                <td style="text-align:left;"><input id="chkIsDeductYes" type="checkbox" onclick="if(this.checked){IsDeductYes()}else{IsDeductNo()}" /> Yes</td>
                                <td style="text-align:left;"><input id="chkIsDeductNo" type="checkbox" onclick="if(this.checked){IsDeductNo()}else{IsDeductYes()}" /> No</td>
                            </tr>
                        </table>
                    </td>

                </tr>
            </table>
        </fieldset>
    </div>
    <fieldset>
        <legend style="font-weight:bold"> Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
            <tr>
                <td style="width:100%;text-align:right;">
                    <a id="btnUpdateFSEDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">OK</a>
                    <a id="btnCloseFSEDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>

            </tr>
        </table>
    </fieldset>
</div>
<div id="winDeliveryBill" class="easyui-window winstyle" title="Export PI Bill Informations" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div id="tabDeliveryBill" class="easyui-tabs" style="width: 900px;height:360px;">
        <div title="Bill Info">
            <table id="tblSampleInvoices" title="" class="easyui-datagrid" style="width: 890px; height: 320px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" showfooter="true">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th field="SampleInvoiceNo" width="15%">
                            Bill/Invoice No
                        </th>
                        <th field="SampleInvoiceDateST" width="12%">
                            Issue Date
                        </th>
                        <th field="Amount" width="12%" align="right">
                            Amount($)
                        </th>
                        <th field="ContractorName" width="35%">
                            Contractor Name
                        </th>
                        <th field="ExportPINo" width="15%">
                            P/I No
                        </th>

                    </tr>
                </thead>
            </table>
        </div>
        <div title="Bill Summary">
            <table id="tblDODetails" class="easyui-datagrid" style="width: 890px; height: 290px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false">
                <thead>
                    <tr>
                        <th field="ProductName" width="45%">
                            Product Name
                        </th>
                        <th data-options="field:'Qty'" width="15%" align="right">
                            Qty(<label id="lblMUnitOne2"></label>)
                        </th>
                        <th data-options="field:'UnitPrice'" width="15%" align="right">
                            Unit Price/ Qty(<label id="lblMUnitOneUP2"></label>)
                        </th>
                        <th field="Amount" formatter="formatPrice" width="15%" align="right">
                            Amount
                        </th>

                    </tr>
                </thead>
            </table>
            <div style="text-align:right;float:right; margin-right:10px;">
                <table style="width: 890px; height:25px">
                    <tr>
                        <td width="200"><label id="lblBillDetailSummary"></label>Total</td>

                        <td width="80" align="right"><label id="lblQty_Bill_MUOne"></label></td>
                        <td width="80" align="right"><label id="lblUP_Bill_MUOne"></label></td>
                        <td width="100" align="right"><label id="lblAmount_Bill_MUOne"></label></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <fieldset class="actionfieldsetstyle">
        <legend>Actions : </legend>
        <table border="1" class="tbl">
            <tr>
                <td class="tdAction">
                    <div class="divleft" style="width:80%">
                        <a id="btnGetPIBill" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Show PI Bill</a>
                        <a id="btnNewBillPI" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Gets New Bill</a>
                        <a id="btnRemovePIFromBill" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove PI From Bill</a>
                        <label id="lblTotalBalance" style="font-size:16px;margin-left:100px; font-weight:bold"></label>
                    </div>
                    <div class="divright" style="width:15%">
                        <a id="btnOkDeliveryBill" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">OK</a>
                        <a id="btnCloseDeliveryBill" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </td>
            </tr>
        </table>
    </fieldset>
</div>

<div id="winOrdersheetPicker" style="width:70%; text-align:center;" class="easyui-window winstyle" title="Order Sheet Picker" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <table style="width:100%;">
        <tr>
            <td style="width:50%">
                <div style="width:100%">
                    <table id="tblOrderSheets" title="Order Sheet List" class="easyui-datagrid" style="height:300px; " fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false">
                        <thead>
                            <tr>
                                <th field="PONo" width="100">PO No</th>
                                <th field="OrderSheetStatusInString" width="150">Status</th>
                                <th field="PartyPoNo" width="150">Party PO No</th>
                                <th field="OrderDateInString" width="150">Order Date</th>
                                <th field="Amount" align="right" formatter="formatPrice" width="100">Amount</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </td>
            <td style="width:50%">
                <table id="tblOrderSheetDetail" title="Order Sheet Details" class="easyui-datagrid" style="height:300px; " fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false">
                    <thead>
                        <tr>
                            <th field="ProductName" width="130" align="left">Product</th>
                            <th field="SizeName" width="60" align="left">Size</th>
                            <th field="ColorName" width="80" align="left">Color</th>
                            <th field="UnitSymbol" width="50" align="left">Unit</th>
                            <th field="YetToPIQty" width="70" align="right">Qty</th>
                            <th field="UnitPrice" width="60" align="right">Rate</th>
                            <th field="Amount" width="80" formatter="formatPrice" align="right">Total</th>
                        </tr>
                    </thead>
                </table>
            </td>
        </tr>
    </table>

    <fieldset class="actionfieldsetstyle">
        <legend>Actions : </legend>
        <a id="btnOkOrderSheetPicker" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
        <a id="btnCloseOrderSheetPicker" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
    </fieldset>
</div>
<style type="text/css">
    .tdAction .divleft {
        float: left;
        width: 49%;
        margin-left: 1%;
        text-align: left;
    }

    .tdAction .divright {
        float: right;
        width: 49%;
        text-align: right;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oExportPI=null;
    var _oProducts = [];
    var _oCurrencys = [];
    var _nQty = 0;
    var _nUnitPrice = 0;
    var _nQtyTwo = 0;
    var _nUnitPriceTwo = 0;
    var _sDescription = "";
    var _oExportPIDetails = [];
    var _oExportPITandCClauses = [];
    var _nActivePIPrintSetupID = 0;
    var _oOrderSheets = [];
    var _oOrderSheetDetails = [];
    var _bIsBuyer = true;
    var _oBusinessUnits=[];
    var _oUnitConversion=null;
    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oExportPI =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oExportPIDetails = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.ExportPIDetails));
        var oPIPaymentTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PIPaymentTypes));
        var oBankBranchs = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BankBranchs));
        var oCurrencys = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Currencys));
        var oLCTerms = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.LCTerms));
        var oLIBORRates = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.LIBORRates));
        var oBankFDDs = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BankFDDs));
        var oMktPersons = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MktPersons));
        var oShipmentTerms = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ShipmentTerms));
        var oDepthOfShades = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DepthOfShades));
        _oExportPITandCClauses = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.ExportPITandCClauses));
        _oBusinessUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUs));
        _oUnitConversion = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.UnitConversion));
        var oExportQualitys = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ExportQualitys));
        var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        var oFinishTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FinishTypes));
        var oProcessTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ProcessTypes));
        var oFabricWeaves = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricWeaves));
        var oFabricDesigns = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricDesigns));
        var oFabricPOSetup = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricPOSetup));

        // $(".lblBUSName").html("("+oBU.ShortName+")");
        debugger;
        sessionStorage.setItem("BUID",nBUID);//reset
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent,#btnPrintPI,#btnCopy,#btnPickOrderSheet").hide();
        RefreshPIPrintSetup();
        $('#tabExportPITabs').tabs({ onSelect: function () {TabClick();} });
        $('#txtIssueDate').datebox('setValue',_oExportPI.IssueDateInString);
        $('#txtValidateDate').datebox('setValue',_oExportPI.ValidityDateInString);
        $('#txtLCOpenDate').datebox('setValue',_oExportPI.LCOpenDateInString);
        $('#txtDeliveryDate').datebox('setValue',_oExportPI.DeliveryDateInString);
        $('#tabExportPITabs').tabs({ onSelect: function () {TabClick();} });
        //Combo Load

        $("#cboProcessTypeFabric").icsLoadCombo({  List: oProcessTypes,  OptionValue: "FabricProcessID", DisplayText: "Name"});
        $("#cboWeaveFabric").icsLoadCombo({List: oFabricWeaves, OptionValue: "FabricProcessID", DisplayText: "Name"});
        //$("#cboFabricDesign").icsLoadCombo({ List: oFabricDesigns, OptionValue: "FabricProcessID", DisplayText: "Name"});
        $("#cboFinishTypeFabric").icsLoadCombo({List: oFinishTypes, OptionValue: "FabricProcessID", DisplayText: "Name"});

        $("#cboEQuality").icsLoadCombo({List: oExportQualitys,OptionValue: "ExportQualityID",DisplayText: "Name"});
        debugger;
        $("#cboMktPersons").icsLoadCombo({List: oMktPersons,OptionValue: "MarketingAccountID",DisplayText: "Name"});
        $("#cboPaymentType").icsLoadCombo({List: oPIPaymentTypes,OptionValue: "id",DisplayText: "Value"});
        $("#cboBank").icsLoadCombo({List: oBankBranchs,OptionValue: "BankBranchID",DisplayText: "BankName"});
        $("#cboCurrency").icsLoadCombo({List: oCurrencys,OptionValue: "CurrencyID",DisplayText: "CurrencyName"});
        $("#cboLCTerm").icsLoadCombo({List: oLCTerms,OptionValue: "LCTermID",DisplayText: "NameDaysInString"});
        $("#cboLiborRate").icsLoadCombo({List: oLIBORRates,OptionValue: "id",DisplayText: "Value",InitialValue: "Customize"});
        $("#cboBankFDD").icsLoadCombo({List: oBankFDDs,OptionValue: "id",DisplayText: "Value",InitialValue: "Customize"});
        $("#cboShipmentTermFDD").icsLoadCombo({List: oShipmentTerms,OptionValue: "Value",DisplayText: "Text",InitialValue: "Customize"});
        $("#cboShipmentTermFDD option[value='0']").remove();
        $("#cboDepthOfShade").icsLoadCombo({List: oDepthOfShades,OptionValue: "Value",DisplayText: "Value",InitialValue: "Customize"});
        $("#btnAcceptReviseExportPI").hide();
        $("#chkIsCreateReviseNo").hide();
        $("#lblCreateReviseNo").hide();
        $("#txtNoteTwo").val(_oExportPI.NoteTwo);
        _oExportPI.PINo = _oExportPI.PINo.substring(_oExportPI.PINo.length , 3);
        $("#txtPINo").val(_oExportPI.PINo);
        $("#cboBUType").icsLoadCombo({
            List: _oBusinessUnits,
            OptionValue: "BusinessUnitID",
            DisplayText: "BUTypeSt"
        });
        if(parseInt(_oExportPI.ExportPIID)<=0)
        {
            if(oBankBranchs.length==1)   { _oExportPI.BankBranchID=oBankBranchs[0].BankBranchID}
            _oExportPI.PIType=1;
        }
        $('#cboBUType').val(nBUID);
        //$('#cboPIType').val(1);

        $("#txtFabricNoExportPIDetail").attr("placeholder","Type "+oFabricPOSetup.FabricCode+"");
        $('#lblFabricNo,#lblFabricNo2').html(oFabricPOSetup.FabricCode+"");
        cboBUChange();
        $("#cboBUType").prop('disabled', true);
        //}
        $('#tblOrderSheets').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowData);}});
        $('#divPIInformation').find('input, textarea, button, select').attr('disabled','disabled');
        RefreshControl();
    });
    $("#txtPINo").keypress(function (e) {

        if (e.which != 45 &&e.which != 8 && e.which != 0  && e.which != 46  && (e.which < 48 || e.which > 57)) {
            return false;
        }
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    $('.changePIType').change(function(){
        debugger;
        //DynamicRefreshList([], "tblExportPIDetail");
        RefreshTotalSummery();
        //if(parseInt($('#cboPIType').val())==1)//Order Sheet
        //{
        //    $('#btnPickOrderSheet').show();
        //    $("#btnProductPiker,#txtProductName").hide();

        //}else{
        //    $('#btnPickOrderSheet').hide();
        //    $("#btnRemoveDetail,#btnProductPiker,#txtProductName").show();
        cboBUChange();
        //}
    });


    function cboBUChange()
    {
        debugger;
        var nBUType=0;
        // Dyeing = 1,       Plastic = 2,       Integrated = 3,       Spinning=4,       Weaving=5,       Finishing=6

        $(".lblFabricNo").hide();
        $(".fabricFabricSCDetail").hide();
        $('#btnPickOrderSheet').hide();
        $("#btnProductPiker,#txtProductName").hide();
        for(var i = 0;i<_oBusinessUnits.length;i++)
        {
            if(parseInt($('#cboBUType').val())===_oBusinessUnits[i].BusinessUnitID)
            {
                nBUType=_oBusinessUnits[i].BusinessUnitTypeInInt;
            }
        }
        if(nBUType===5||nBUType==6)
        {
            if(parseInt($('#cboPIType').val())==0)//Open
            {
                $("#lblExportPIDetailLabel").html("");
                $(".fabricItemsExportPI").show();
                $(".productItemsExportPI").show();

            }
            if(parseInt($('#cboPIType').val())==1)//Order Sheet
            {
                $("#lblExportPIDetailLabel").html("PO:");
                $(".fabricItemsExportPI").show();
                $(".fabricFabricSCDetail").show();
                $(".productItemsExportPI").show();
                $(".lblFabricNo").show();

            }

            $("#tblExportPIDetail").datagrid("showColumn", "FabricNo");
            $("#tblExportPIDetail").datagrid("showColumn", "Construction");
            $("#tblExportPIDetail").datagrid("showColumn", "BuyerReference");
            $("#tblExportPIDetail").datagrid("showColumn", "ColorInfo");
            $("#tblExportPIDetail").datagrid("showColumn", "FabricWidth");
            $("#tblExportPIDetail").datagrid("showColumn", "ProductName");
            $("#tblExportPIDetail").datagrid("hideColumn", "ProductCode");
        }
        else
        {
            $("#lblExportPIDetailLabel").html("Product : ");
            $(".fabricItemsExportPI").hide();
            $(".fabricFabricSCDetail").hide();
            $(".productItemsExportPI").show();

            $("#tblExportPIDetail").datagrid("hideColumn", "FabricNo");
            $("#tblExportPIDetail").datagrid("hideColumn", "Construction");
            $("#tblExportPIDetail").datagrid("hideColumn", "BuyerReference");
            $("#tblExportPIDetail").datagrid("hideColumn", "ColorInfo");
            $("#tblExportPIDetail").datagrid("hideColumn", "FabricWidth");
            $("#tblExportPIDetail").datagrid("showColumn", "ProductName");
            //$("#tblExportPIDetail").datagrid("showColumn", "Description");
            $("#tblExportPIDetail").datagrid("showColumn", "ProductCode");
        }
    }

    // Pick Oreder Sheet
    $("#btnPickOrderSheet").click(function () {
        if(parseInt(_oExportPI.ContractorID)<=0)
        {
            alert("Please Pick Contractor.");
            $('#txtContractorName').focus();
            return;
        }
        if(parseInt(_oExportPI.BuyerID)<=0)
        {
            alert("Please Pick Buyer.");
            $('#txtBuyerName').focus();
            return;
        }
        var sBuyerIDs = _oExportPI.ContractorID+","+_oExportPI.BuyerID;
        DynamicRefreshList([], "tblOrderSheets");
        DynamicRefreshList([], "tblOrderSheetDetail");
        $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+"/OrderSheet/GetsORSWithDetails",
                data: {BuyerIDs:sBuyerIDs, BUID:sessionStorage.getItem("BUID")},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oOrderSheet = jQuery.parseJSON(data);
                    if (oOrderSheet.ErrorMessage=="" || oOrderSheet.ErrorMessage==null)
                    {
                        debugger;
                        _oOrderSheets = oOrderSheet.OrderSheetList;
                        _oOrderSheetDetails = oOrderSheet.OrderSheetDetails;
                        DynamicRefreshList(oOrderSheet.OrderSheetList, "tblOrderSheets");
                    }

                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });

        $("#winOrdersheetPicker").icsWindow("open","Order Sheet Picker");
    });
    $("#btnOkOrderSheetPicker").click(function () {
        debugger;
        var oOrderSheet = $('#tblOrderSheets').datagrid("getSelected");
        if(oOrderSheet==null|| parseInt(oOrderSheet.OrderSheetID)<=0)
        {
            alert("Please Select Order Sheet");
            return;
        }
        var oOrderSheetDetails = $('#tblOrderSheetDetail').datagrid("getRows");
        var oExportPIDetails = $('#tblExportPIDetail').datagrid("getRows");
        if(oOrderSheetDetails.length>0)
        {
            var nDLength = oOrderSheetDetails.length;
            for(var i = 0; i< nDLength;i++)
            {
                if(!ICS_IsExistForTwoProperty(oExportPIDetails,"OrderSheetDetailID",oOrderSheetDetails[i].OrderSheetDetailID,"ProductID",oOrderSheetDetails[i].ProductID))
                {
                    var   oExportPIDetail= {
                        ExportPIDetailID : 0,
                        ExportPIID: _oExportPI.ExportPIID,
                        ProductID: oOrderSheetDetails[i].ProductID,
                        OrderSheetDetailID:oOrderSheetDetails[i].OrderSheetDetailID,
                        ColorID: oOrderSheetDetails[i].ColorID,
                        StyleNo :oOrderSheetDetails[i].StyleDescription,
                        Measurement  : oOrderSheetDetails[i].Measurement,
                        Qty :oOrderSheetDetails[i].Qty,
                        UnitPrice:oOrderSheetDetails[i].UnitPrice,
                        AdjQty:0,
                        AdjRate:0,
                        DocCharge:0,
                        AdjValue:0,
                        CRate:0,
                        QtyTwo:0,
                        UnitPriceTwo:0,
                        BuyerReference:oOrderSheetDetails[i].BuyerRef,
                        ColorInfo :'',
                        ModelReferenceID :oOrderSheetDetails[i].ModelReferenceID,
                        MUnitID:oOrderSheetDetails[i].UnitID,
                        MUName:oOrderSheetDetails[i].UnitSymbol,
                        ProductCode:oOrderSheetDetails[i].ProductCode,
                        ProductName :oOrderSheetDetails[i].ProductName,
                        ModelReferenceName : oOrderSheetDetails[i].ModelReferenceName,
                        ColorName :oOrderSheetDetails[i].ColorName,
                        SizeName :oOrderSheetDetails[i].SizeName,
                        Amount:parseFloat(parseFloat(oOrderSheetDetails[i].Qty) * parseFloat(oOrderSheetDetails[i].UnitPrice))
                    };
                    $('#tblExportPIDetail').datagrid('appendRow',oExportPIDetail);
                    RefreshTotalSummery();
                }
            }
        }
        $("#winOrdersheetPicker").icsWindow("close");
    });

    $("#btnCloseOrderSheetPicker").click(function () {
        $("#winOrdersheetPicker").icsWindow("close");
    });

    function RowSelect(oOrderSheet)
    {
        debugger;
        var oOrderSheetDetails = [];
        for(var i = 0;i<_oOrderSheetDetails.length;i++)
        {
            if(parseInt(_oOrderSheetDetails[i].OrderSheetID) == parseInt(oOrderSheet.OrderSheetID) )
            {
                oOrderSheetDetails.push(_oOrderSheetDetails[i]);
            }
        }
        DynamicRefreshList(oOrderSheetDetails, "tblOrderSheetDetail");
    }

    function RefreshControl()
    {
        $("#txtContractorName,#txtBuyerName,#txtDeliveryToName").addClass("fontColorOfPickItem");
        $('#txtIssueDate').datebox('setValue', _oExportPI.IssueDateInString );
        $('#txtValidateDate').datebox('setValue', _oExportPI.ValidityDateInString );
        $('#txtLCOpenDate').datebox('setValue', _oExportPI.LCOpenDateInString );
        $('#txtDeliveryDate').datebox('setValue', _oExportPI.DeliveryDateInString );
        debugger;
        $("#cboMktPersons").val(_oExportPI.MKTEmpID);
        $("#cboCurrency").val(_oExportPI.CurrencyID);
        $("#cboPIType").val(_oExportPI.PIType);
        if(_oExportPI.PaymentTypeInInt>0)
        {
            $("#cboPaymentType").val(_oExportPI.PaymentTypeInInt);
        }
        else
        {
            $("#cboPaymentType").val(1);
        }
        $("#cboBank").val(_oExportPI.BankBranchID);
        LoadBankBranchAccounts(_oExportPI.BankBranchID,_oExportPI.BankAccountID);
        GetContactPerson(_oExportPI.ContractorID,false);
        GetContactPerson(_oExportPI.BuyerID,true);
        $("#cboLCTerm").val(_oExportPI.LCTermID);
        $("#cboShipmentTermFDD").val(_oExportPI.ShipmentTermInInt);
        if( _oExportPI.IsLIBORRate){$('#cboLiborRate').val(1);}else {$('#cboLiborRate').val(0);}
        if( _oExportPI.IsBBankFDD){$('#cboBankFDD').val(1);}else {$('#cboBankFDD').val(0);}
        if(_oExportPI.PIType==1)//Order Sheet
        {
            $('#btnPickOrderSheet').show();
            $("#btnProductPiker,#txtProductName").hide();        }
        if(sessionStorage.getItem("ExportPIHeader") == "View Export PI")
        {
            $("#btnPrintPI,#btnCopy,#btnAddTermsAndConditon,#btnRemoveTermsAndCondition,#btnRemoveTnCALL").hide();
            $("#btnProductPiker,#txtProductName").prop('disabled', true);
        }
        if(sessionStorage.getItem("ExportPIHeader") == "Revise Export PI")
        {
            $("#btnCopy").hide();
            $("#btnAcceptReviseExportPI").show();
            $("#chkIsCreateReviseNo").show();
            $("#lblCreateReviseNo").show();
            $('#txtIssueDate').datebox('setValue',icsdateformat(new Date()));
            var date=new Date();
            $("#txtValidateDate").datebox("setValue", icsdateformat(new Date(date.getFullYear(), date.getMonth(), date.getDate()+7)));
        }
        if(sessionStorage.getItem("ExportPIHeader")=="Copy Export PI")
        {
            $("#btnCopy").show();
            _oExportPI.ExportPIID = 0;//Reset PIID
            var nLength =_oExportPIDetails.length;
            for(var i =0;i<nLength;i++)
            {
                _oExportPIDetails[i].ExportPIID = 0;
                _oExportPIDetails[i].ExportPIDetailID = 0;
            }
            var nLength =_oExportPITandCClauses.length;
            for(var i =0;i<nLength;i++)
            {
                _oExportPITandCClauses[i].ExportPIID = 0;
                _oExportPITandCClauses[i].ExportPITandCClauseID = 0;
            }
        }
        DynamicRefreshList(_oExportPIDetails, "tblExportPIDetail");
        RefreshTotalSummery();
        DynamicRefreshList(_oExportPITandCClauses, "tblPITandCClauses");
    }
    function GetContactPerson(nContractorID, bIsBuyer) {
        debugger;
        var oContractor = {ContractorID:nContractorID};
        $.ajax
           ({
               type: "POST",
               dataType: "json",
               url: _sBaseAddress + "/Contractor/GetContactPersonnels",
               traditional: true,
               data:  JSON.stringify(oContractor),
               contentType: "application/json; charset=utf-8",
               success: function (data) {
                   //debugger;
                   var _oContactPersonnels = jQuery.parseJSON(data);
                   if (_oContactPersonnels != null)
                   {
                       if(bIsBuyer)
                       {
                           $("#cboBuyerContactPerson").icsLoadCombo({List: _oContactPersonnels,OptionValue: "ContactPersonnelID",DisplayText: "Name"});
                           $('#cboBuyerContactPerson').val(_oExportPI.BuyerContactPerson);
                       }else{
                           $("#cboContractorContactPerson").icsLoadCombo({List: _oContactPersonnels,OptionValue: "ContactPersonnelID",DisplayText: "Name"});
                           $('#cboContractorContactPerson').val(_oExportPI.ContractorContactPerson);
                       }

                   }
                   else {
                       if(bIsBuyer)
                       {
                           $("#cboBuyerContactPerson").icsLoadCombo({List: _oContactPersonnels,OptionValue: "ContactPersonnelID",DisplayText: "Name"});
                       }else{
                           $("#cboContractorContactPerson").icsLoadCombo({List: _oContactPersonnels,OptionValue: "ContactPersonnelID",DisplayText: "Name"});
                       }
                   }
               },
               error: function (xhr, status, error) {
                   alert(error);
               }

           });

    }
    function TabClick()
    {
        debugger;
        var tab = $('#tabExportPITabs').tabs('getSelected');
        var index = $('#tabExportPITabs').tabs('getTabIndex', tab);
        if (parseInt(index)==2)
        {
            $('#btnCopy').hide();$('#btnPrintPI').show();
        }else
        {

            if(sessionStorage.getItem("ExportPIHeader") == "Copy Export PI")
            {
                $('#btnCopy').show();
            }
            if(sessionStorage.getItem("ExportPIHeader") == "Revise Export PI")
            {
                $("#btnAcceptReviseExportPI").show();
                $("#chkIsCreateReviseNo").show();
                $("#lblCreateReviseNo").show();
            }
            $('#btnPrintPI').hide();
        }
    }

    $("#btnCopy").click(function (e) {
        debugger;
        endEditing();
        endEditingTC();
        if (!ValidateInputExportPI()) return;


        var oExportPI = RefreshObjectExportPI();
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ExportPI/Save",
            traditional: true,
            data:  JSON.stringify(oExportPI),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oExportPI = jQuery.parseJSON(data);
                $("#btnSave").show();
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (oExportPI.ErrorMessage==null || oExportPI.ErrorMessage=="")
                {
                    alert("Data Saved successfully");
                    var oExportPIs = sessionStorage.getItem("ExportPIs");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oExportPIs != null) {
                        oExportPIs = jQuery.parseJSON(oExportPIs);
                    }
                    else {
                        oExportPIs = [];
                    }
                    if (nIndex != -1) {
                        oExportPIs[nIndex] = oExportPI;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oExportPIs.length);
                        oExportPIs.push(oExportPI);
                    }
                    sessionStorage.setItem("ExportPIs", JSON.stringify(oExportPIs));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oExportPI.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $("#btnRefreshPIDetail").click(function (e) {
        endEditing();
        var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        DynamicRefreshList(oPIDetails, "tblExportPIDetail");
        RefreshTotalSummery();
    });

    $("#txtContractorName").keydown(function (e) {
        if (e.keyCode === 13) // Enter Press
        {
            if($('#txtContractorName').val()==null || $('#txtContractorName').val()=="")
            {
                alert("Please Type Name or part Name and Press Enter.");
                $('#txtContractorName').focus();
                $("#txtContractorName").addClass("errorFieldBorder");
                return;
            }

            PickAccountOfPI();
        }
        else if (e.keyCode === 08) {
            $("#txtContractorName").removeClass("fontColorOfPickItem");
            _oExportPI.ContractorID = 0;
        }
    });
    $("#btnPickAccountOfPI").click(function () {
        PickAccountOfPI();
    });
    $("#btnPickDeliveryToPI").click(function () {
        PickDeliveryToPI();
    });

    $("#btnAddTermsAndConditon").click(function ()
    {
        var oTermsAndCondition = {
            BUID: sessionStorage.getItem("BUID")
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oTermsAndCondition,
            ControllerName: "ExportTermsAndCondition",
            ActionName: "Gets",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ExportTermsAndConditionID > 0) {

                    var tblColums = []; var oColumn = { field: "CaptionName", title: "Caption", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Clause", title: "Terms & Condition Clause", width: 600, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ClauseTypeInString", title: "Clause Type", width: 120, align: "left" }; tblColums.push(oColumn);
                    //oColumn = { field: "DocForInString", title: "Doc For", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winTermsAndCondition',
                        winclass: 'clsTermsAndCondition',
                        winwidth: 800,
                        winheight: 600,
                        tableid: 'tblTermsAndCondition',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Clause',
                        windowTittle: 'Terms And Condition List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Clause Found.");
            }
        });
    });

    $("#btnRefreshTermsAndCondition").click(function (e) {
        endEditingTC();
        var oPITermsConditions = $('#tblPITandCClauses').datagrid('getRows');
        DynamicRefreshList(oPITermsConditions, "tblPITandCClauses");
        CopyTermsAndCondition();
    });

    $("#btnRemoveTermsAndCondition").click(function (e) {
        endEditingTC();
        var oPITermsCondition = $('#tblPITandCClauses').datagrid('getSelected');
        if (oPITermsCondition == null) {
            alert("Please select an item!");
            return;
        }
        var SelectedRowIndex = $('#tblPITandCClauses').datagrid('getRowIndex', oPITermsCondition);
        if (!confirm("Confirm to Delete?")) return;
        $('#tblPITandCClauses').datagrid('deleteRow', SelectedRowIndex);
        CopyTermsAndCondition();
    });

    $("#btnRemoveTnCALL").click(function () {

        var oExportPITandCClause={ExportPIID:_oExportPI.ExportPIID,ExportPITandCClauseID:0}
        //if (oExportPITandCClause.ExportPIID<=0) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to Delete?")) return false;

        if(oExportPITandCClause.ExportPIID<=0)
        {
            DynamicRefreshList([], "tblPITandCClauses");
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oExportPITandCClause,
                         ControllerName: "ExportTermsAndCondition",
                         ActionName: "DeleteALL",
                         TableId: "",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
            DynamicRefreshList([], "tblPITandCClauses");
        }

        editTCIndex = undefined;
    });


    $("#btnProductFormDeliveryBill").click(function () {
        debugger;
        if (!ValidateInputExportPI(true)) return;
        if (_oExportPI.ExportPIID > 0) {
            GetsDeliveryOrderBillByExportPI(_oExportPI,true);
        }
        else {
            if (_oExportPI.ContractorID <= 0) {
                $('#tabExportPITabs').tabs('select', 0);
                alert("Please select Account Of!"); $('#txtContractorName').focus();
                $("#txtContractorName").addClass("errorFieldBorder");
                return false;
            } else {
                $("#txtContractorName").removeClass("errorFieldBorder");
            }

            GetsDeliveryOrderBill(_oExportPI.ContractorID,true);
        }
    });

    //$("#cboPaymentType").change(function () {
    //    if (parseInt($(this).val()) == 1) { //LC
    //        $("#cboBankAccount").prop("disabled", true);
    //    } else {
    //        $("#cboBankAccount").prop("disabled", false);
    //        $("#cboCurrency").val(1);
    //    }
    //});


    function LoadBankBranchAccounts(nBankBranchID, nSetValueInEditMode) {
        var oBankAccount = {
            BankBranchID: parseInt(nBankBranchID)
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oBankAccount,
            ControllerName: "BankAccount",
            ActionName: "GetsByBranchAndAccount",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0)
            {
                $("#cboBankAccount").empty();
                $("#cboBankAccount").icsLoadCombo({
                    List: response.objs,
                    OptionValue: "BankAccountID",
                    DisplayText: "AccountNameandNo"
                    //InitialValue: "Customize"
                });
                $("#cboBankAccount").val(nSetValueInEditMode);
            }
            else {
                $("#cboBankAccount").empty();
            }
        });
    }

    function RefreshPIPrintSetup() {
        var oPIPrintSetup = {
            SetupNo: "",
            BUID:sessionStorage.getItem("BUID")
        };

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oPIPrintSetup,
            ControllerName: "ExportPIPrintSetup",
            ActionName: "GetActivePrintSetup",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.ExportPIPrintSetupID > 0) {
                    oPIPrintSetup = response.obj;
                    $('#txtSetupNote').val(oPIPrintSetup.Note);
                    $('#txtPreface').val(oPIPrintSetup.Preface);
                    $('#txtPartShipment').val(oPIPrintSetup.PartShipment);
                    $('#txtShipmentBy').val(oPIPrintSetup.ShipmentBy);
                    $('#txtPlaceofShipment').val(oPIPrintSetup.PlaceOfShipment);
                    $('#txtPlaceofDelivery').val(oPIPrintSetup.PlaceOfDelivery);
                    $('#txtAcceptanceBy').val(oPIPrintSetup.AcceptanceBy);
                    $('#txtFor').val(oPIPrintSetup.For);
                    _nActivePIPrintSetupID=oPIPrintSetup.ExportPIPrintSetupID;
                }
                else { alert(response.obj.ErrorMessage); _nActivePIPrintSetupID=0;}
            }
            else { alert("No information found."); _nActivePIPrintSetupID=0;}
        });
    }

    function PickAccountOfPI() {
        var oContractor = {
            Params: '3' + '~' + $.trim($("#txtContractorName").val()+'~'+sessionStorage.getItem("BUID"))
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = [];var oColumn = { field: "ContractorID", title: "Code", width: 70, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winAccountOfs',
                        winclass: 'clsAccountOf',
                        winwidth: 500,
                        winheight: 460,
                        tableid: 'tblAccountOfs',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Contactor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Contactor Found.");
            }
        });
    }

    function PickDeliveryToPI()
    {
        var oContractor = {
            Params: '2,3' + '~' + $.trim($("#txtDeliveryToName").val()+'~'+sessionStorage.getItem("BUID"))
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 70, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winDeliveryTos',
                        winclass: 'clsDeliveryTos',
                        winwidth: 500,
                        winheight: 460,
                        tableid: 'tblDeliveryTos',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Delivery To List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Buyer Found.");
            }
        });
    }

    function RefreshObjectExportPI() {
        var bIsLIBORRate =false; if( $('#cboLiborRate').val()==1){ bIsLIBORRate=true;}
        var bIsBBankFDD = false; if ($('#cboBankFDD').val() == 1) { bIsBBankFDD = true; }
        var oExportPI = {
            ExportPIID: (_oExportPI != null) ? _oExportPI.ExportPIID : 0,
            PINo: $("#txtPINo").val(),
            PIStatusInInt: _oExportPI.PIStatusInInt,
            IssueDate: $('#txtIssueDate').datebox('getValue'),
            ValidityDate: $('#txtValidateDate').datebox('getValue'),
            ContractorID: _oExportPI.ContractorID,
            ContractorContactPerson:$('#cboContractorContactPerson').val(),
            BuyerID: _oExportPI.BuyerID,
            BuyerContactPerson:$('#cboBuyerContactPerson').val(),
            DeliveryToID : _oExportPI.DeliveryToID,
            MKTEmpID: parseInt($("#cboMktPersons").val()),
            BankBranchID: $('#cboBank').val(),
            BankAccountID: parseInt($('#cboBankAccount').val()),
            CurrencyID: $('#cboCurrency').val(),
            Qty: _oExportPI.Qty,
            Amount: _oExportPI.Amount,
            IsLIBORRate: bIsLIBORRate,
            IsBBankFDD: bIsBBankFDD,
            LCTermID: $('#cboLCTerm').val(),
            OverdueRate: $('#txtOverDueRate').val(),
            LCOpenDate: $('#txtLCOpenDate').datebox('getValue'),
            DeliveryDate: $('#txtDeliveryDate').datebox('getValue'),
            ApprovedBy: _oExportPI.ApprovedBy,
            ApprovedDate: _oExportPI.ApprovedDate,
            LCID: _oExportPI.LCID,
            ExportPIPrintSetupID: _nActivePIPrintSetupID,
            ShipmentTermInInt: parseInt($("#cboShipmentTermFDD").val()),
            Note: $("#txtNote").val(),
            NoteTwo: $("#txtNoteTwo").val(),
            ColorInfo: $("#txtColorInfo").val(),
            DepthOfShade: $("#cboDepthOfShade").val(),
            YarnCount: $("#txtYarnCount").val(),
            PIType:$('#cboPIType').val(),
            PaymentTypeInInt:$("#cboPaymentType").val(),
            BUID: $('#cboBUType').val(),
            ExportPIDetails:$('#tblExportPIDetail').datagrid('getRows'),
            ExportPITandCClauses: $('#tblPITandCClauses').datagrid('getRows'),
            IsCreateReviseNo:false
        };
        return oExportPI;
    }

    //function CheckLCorNonLC()
    //{
    //    var nType = parseInt($("#cboPaymentType").val());
    //    if (nType == 1) {
    //        return true;
    //    }
    //    return false;
    //}

    function ValidateInputExportPI() {
        if (_nActivePIPrintSetupID<= 0) {
            alert("Please configure a PI print setup!");
            return false;
        }

        //if ($("#cboPaymentType").val() <= 0) {
        //    $('#tabExportPITabs').tabs('select', 0);
        //    alert("Please select Payment Type!"); $('#cboPaymentType').focus();
        //    $("#cboPaymentType").addClass("errorFieldBorder");
        //    return false;
        //} else { $("#cboPaymentType").removeClass("errorFieldBorder"); }

        if ($('#txtIssueDate').datebox('getValue') == null || $('#txtIssueDate').datebox('getValue') == "") {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select Issue Date!"); $('#txtIssueDate').focus();
            $("#txtIssueDate").addClass("errorFieldBorder");
            return false;
        } else { $("#txtIssueDate").removeClass("errorFieldBorder"); }

        if ($('#txtValidateDate').datebox('getValue') == null || $('#txtValidateDate').datebox('getValue') == "") {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select Validate Date!"); $('#txtValidateDate').focus();
            $("#txtValidateDate").addClass("errorFieldBorder");
            return false;
        } else { $("#txtValidateDate").removeClass("errorFieldBorder"); }

        if (_oExportPI.ContractorID <= 0) {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select Account Of!"); $('#txtContractorName').focus();
            $("#txtContractorName").addClass("errorFieldBorder");
            return false;
        } else { $("#txtContractorName").removeClass("errorFieldBorder"); }

        if (_oExportPI.BuyerID <= 0) {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select a Buyer!"); $('#txtBuyerName').focus();
            $("#txtBuyerName").addClass("errorFieldBorder");
            return false;
        } else { $("#txtBuyerName").removeClass("errorFieldBorder"); }

        if (parseInt($("#cboMktPersons").val()) <= 0) {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select a MKT Person!"); $('#cboMktPersons').focus();
            $("#cboMktPersons").addClass("errorFieldBorder");
            return false;
        } else {
            $("#cboMktPersons").removeClass("errorFieldBorder");
            _oExportPI.MKTEmpID = parseInt($("#cboMktPersons").val());
        }

        if ($("#cboBank").val() <= 0) {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select Bank Branch!"); $('#cboBank').focus();
            $("#cboBank").addClass("errorFieldBorder");
            return false;
        } else { $("#cboBank").removeClass("errorFieldBorder"); }

        if ($("#cboCurrency").val() <= 0) {
            $('#tabExportPITabs').tabs('select', 0);
            alert("Please select Currency!"); $('#cboCurrency').focus();
            $("#cboCurrency").addClass("errorFieldBorder");
            return false;
        } else { $("#cboCurrency").removeClass("errorFieldBorder"); }
        if ($("#cboLCTerm").val() <= 0) {
            $('#tabExportPITabs').tabs('select', 1);
            alert("Please select LC Term!"); $('#cboLCTerm').focus();
            $("#cboLCTerm").addClass("errorFieldBorder");
            return false;
        } else { $("#cboLCTerm").removeClass("errorFieldBorder"); }

        var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        if(oPIDetails.length<=0)
        {
            alert("Please add at least one detail.");
            return false;
        }

        var ndLength = oPIDetails.length;
        for(var i =0;i<ndLength;i++)
        {
            if(parseFloat(oPIDetails[i].Qty)<=0)
            {
                alert("Qty Should be Greater than 0");
                return false;
            }
            if(parseFloat(oPIDetails[i].UnitPrice)<=0)
            {
                alert("Unit Price Should be Greater than 0");
                return false;
            }
            oPIDetails[i].Amount =  parseFloat(oPIDetails[i].UnitPrice * oPIDetails[i].Qty);
        }

        var oTermsAndConditions = $('#tblPITandCClauses').datagrid('getRows');
        if(oTermsAndConditions.length<=0)
        {
            alert("Please add at least one Terms and Condition.");
            $('#tabExportPITabs').tabs('select',1);//Terms & Condition
            return false;
        }
        return true;
    }



    var editTCIndex = undefined;
    function endEditingTC() {
        if (editTCIndex == undefined) { return true }
        if ($('#tblPITandCClauses').datagrid('validateRow', editTCIndex)) {

            $('#tblPITandCClauses').datagrid('endEdit', editTCIndex);
            editTCIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }



    //Product Pick
    $("#txtProductName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtProductName').val()==null || $('#txtProductName').val()=="")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtProductName').focus();
                return;
            }
            PickProduct($('#txtProductName').val());
        }
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtProductName").removeClass("fontColorOfPickItem");
            _oProducts= [];
        }
    });
    $("#btnProductPiker").click(function () {
        PickProduct("");
    });
    function PickProduct(sProductName)
    {
        var oProduct = { BUID:sessionStorage.getItem("BUID"),ProductName:sProductName};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "ExportPI",
            ActionName: "GetProducts",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 300, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass: 'clsProductPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }
    //Fabric Pick
    $("#txtFabricNoExportPIDetail").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtFabricNoExportPIDetail').val()==null || $('#txtFabricNoExportPIDetail').val()=="")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtFabricNoExportPIDetail').focus();
                return;
            }
            if(parseInt($('#cboPIType').val())==0)//Open
            {
                _oExportPI.OrderSheetID=0;
            }
            else
            {
                if( _oExportPI.OrderSheetID<=0)
                {
                    alert("Please First Pick PO No.");
                    $('#txtFabricNoExportPIDetail').focus();
                    return;
                }
            }
            var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
            var sFSCDID="";
            if(oPIDetails!=null && oPIDetails.length>0)
            {
                for (var i = 0;i<oPIDetails.length; i++){
                    sFSCDID = oPIDetails[i].OrderSheetDetailID + "," + sFSCDID;
                }
                sFSCDID = sFSCDID.substring(0, sFSCDID.length - 1);
            }

            var oFabricSalesContractDetail = {
                FabricNo: $.trim($("#txtFabricNoExportPIDetail").val()),
                FabricSalesContractID: _oExportPI.OrderSheetID,
                ErrorMessage:sFSCDID,
                ExportPIID:1
            };
            PickFabricInExportPI(oFabricSalesContractDetail);

        }
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtFabricNoExportPIDetail").removeClass("fontColorOfPickItem");
            _oProducts= [];
        }
    });
    $("#btnPickFabricExportPIDetail").click(function () {

        var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        var sFSCDID="";
        if(oPIDetails!=null && oPIDetails.length>0)
        {
            for (var i = 0;i<oPIDetails.length; i++){
                sFSCDID = oPIDetails[i].OrderSheetDetailID + "," + sFSCDID;
            }
            sFSCDID = sFSCDID.substring(0, sFSCDID.length - 1);
        }
        if(parseInt($('#cboPIType').val())==0)//Open
        {
            _oExportPI.OrderSheetID=0;
            if($('#txtFabricNoExportPIDetail').val()==null || $('#txtFabricNoExportPIDetail').val()=="")
            {
                alert("Please Type Ref No and Press Enter.");
                $('#txtFabricNoExportPIDetail').focus();
                return;
            }

        }
        else
        {
            if( _oExportPI.OrderSheetID<=0)
            {
                alert("Please First Pick PO No.");
                $('#txtFabricNoExportPIDetail').focus();
                return;
            }
        }

        var oFabricSalesContractDetail = {
            FabricNo: $.trim($("#txtFabricNoExportPIDetail").val()),
            FabricSalesContractID: _oExportPI.OrderSheetID,
            ErrorMessage:sFSCDID,
            ExportPIID:_oExportPI.ExportPIID
        };
        PickFabricInExportPI(oFabricSalesContractDetail);
    });
    function PickFabricInExportPI(oFabricSalesContractDetail) {

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricSalesContractDetail,
            ControllerName: "FabricSalesContract",
            ActionName: "GetsDetailForPI",
            IsWinClose: false
        };
        endEditing();
        $.icsDataGets(obj, function (response)
        {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FabricID > 0) {

                    var tblColums = [];
                    var oColumn = { field: "FabricNo", title: "Mkt Ref No", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction", width: 150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ConstructionPI", title: "Construction(PI)", width: 150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ColorInfo", title: "ColorInfo", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "StyleNo", title: "StyleNo", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty(Y)", width: 70, align: "left" ,formatter:formatPrice }; tblColums.push(oColumn);
                    oColumn = { field: "Qty_PI", title: "Use Qty another PI(Y)", width: 70, align: "left" ,formatter:formatPrice }; tblColums.push(oColumn);
                    oColumn = { field: "FabricWeaveName", title: "Weave", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "FinishTypeName", title: "FinishType", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "FabricWidth", title: "Width", width: 100, align: "left" }; tblColums.push(oColumn);



                    var oPickerParam = {
                        winid: 'winFabricPicker',
                        winclass: 'clsFabricPicker',
                        winwidth: 900,
                        winheight: 460,
                        tableid: 'tblFabricPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'FabricNo',
                        windowTittle: 'Fabric List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }

    $("#txtFabricSCDetail").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtFabricSCDetail').val()==null || $('#txtFabricSCDetail').val()=="")
            {
                alert("Please Type PO No and Press Enter.");
                $('#txtFabricSCDetail').focus();
                $('#txtFabricSCDetail').addClass("errorFieldBorder")
                return;
            }


            //}
            var oFabricSalesContract = {
                SCNo: $.trim($("#txtFabricSCDetail").val()),
                ContractorName: _oExportPI.ContractorID,
                BuyerName:_oExportPI.BuyerID,
                PINo:'',
                ApproveBy:1,
                OrderType:3
            };
            PickFabricSC(oFabricSalesContract);

        }
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtFabricSCDetail").removeClass("fontColorOfPickItem");
            _oExportPI.OrderSheetID=0;
        }
    });
    $("#btnPickFabricSCDetail").click(function () {

        var oFabricSalesContract = {
            SCNo: $.trim($("#txtFabricSCDetail").val()),
            ContractorName: _oExportPI.ContractorID,
            BuyerName:_oExportPI.BuyerID,
            PINo:'',
            ApproveBy:1,
            OrderType:3
        };
        PickFabricSC(oFabricSalesContract);

    });
    function PickFabricSC(oFabricSalesContract) {

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricSalesContract,
            ControllerName: "FabricSalesContract",
            ActionName: "GetbySCNo",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response)
        {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FabricSalesContractID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "SCNoFull", title: "PO No", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty(Y)", width: 60, align: "left", formatter:formatPrice }; tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Buyer Name", width: 140, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buying House", width: 140, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "OrderTypeSt", title: "Order Type", width: 50, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winPOPicker',
                        winclass: 'clsPOPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblPOPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SCNo',
                        windowTittle: 'PO List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbuttonPI(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }



    function IntializePickerbuttonPI(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssignPI(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssignPI(oPickerobj);
            }
        });
    }

    function Qty_Fabric(nFSCDID)
    {
        var nQty=0;
        var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        for (var i = 0; i < oPIDetails.length; i++)
        {
            if(parseInt(oPIDetails[i].OrderSheetDetailID)==nFSCDID && parseInt(nFSCDID)>0)
            {
                nQty = nQty + parseFloat(oPIDetails[i].Qty);
            }
        }
        return nQty;
    }


    function SetPickerValueAssignPI(oPickerobj) {
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winAccountOfs') {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                var oContractor = oreturnObj;
                $('#txtContractorName').val(oContractor.Name);
                $("#txtContractorName").addClass("fontColorOfPickItem");
                _oExportPI.ContractorID = oContractor.ContractorID;
                GetContactPerson(_oExportPI.ContractorID,false);
                ////$('#txtBuyerName').val(oContractor.Name);
                ////$("#txtBuyerName").addClass("fontColorOfPickItem");
                ////_oExportPI.BuyerID = oContractor.ContractorID;
                ////GetContactPerson(_oExportPI.BuyerID,true);
            }
            else
            {
                alert("Please select a contractor.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winBuyers') {
            if (oreturnObj != null && oreturnObj.ContractorID > 0) {
                var oContractor = oreturnObj;
                $('#txtBuyerName').val(oContractor.Name);
                $("#txtBuyerName").addClass("fontColorOfPickItem");
                _oExportPI.BuyerID = oContractor.ContractorID;
                GetContactPerson(_oExportPI.BuyerID,true);
            }
            else {
                alert("Please select a buyer.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winDeliveryTos') {
            if (oreturnObj != null && oreturnObj.ContractorID > 0) {
                var oContractor = oreturnObj;
                $('#txtDeliveryToName').val(oContractor.Name);
                $("#txtDeliveryToName").addClass("fontColorOfPickItem");
                _oExportPI.DeliveryToID = oContractor.ContractorID;
            }
            else {
                alert("Please select an item from.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winPOPicker')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0)
            {
                var oFabricSalesContract = oreturnObj;

                if( _oExportPI.BuyerID<=0)
                {
                    $('#txtBuyerName').val(oFabricSalesContract.BuyerName);
                    $("#txtBuyerName").addClass("fontColorOfPickItem");
                    _oExportPI.BuyerID = oFabricSalesContract.BuyerID;
                    GetContactPerson(_oExportPI.BuyerID,true);
                }
                if( _oExportPI.ContractorID<=0)
                {
                    $('#txtContractorName').val(oFabricSalesContract.ContractorName);
                    $("#txtContractorName").addClass("fontColorOfPickItem");
                    _oExportPI.ContractorID = oFabricSalesContract.ContractorID;
                    GetContactPerson(_oExportPI.ContractorID,false);
                }
                if( _oExportPI.MKTEmpID<=0)
                {
                    _oExportPI.MKTEmpID= oFabricSalesContract.MktAccountID;
                    $("#cboMktPersons").val(_oExportPI.MKTEmpID);
                }
                $("#cboLCTerm").val(oFabricSalesContract.LCTermID);
                $("#cboCurrency").val(oFabricSalesContract.CurrencyID);

                $('#txtFabricSCDetail').val(oFabricSalesContract.SCNo);
                $("#txtFabricSCDetail").addClass("fontColorOfPickItem");
                _oExportPI.OrderSheetID=oFabricSalesContract.FabricSalesContractID;
                $('#txtFabricNoExportPIDetail').focus();
                $('#txtFabricNoExportPIDetail').addClass('fontColorOfPickItem');
            }
            else {
                alert("Please select an item from.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                $('#txtProductName').val(oreturnObjs.length+" Item Selected.");
                $('#txtProductName').addClass('fontColorOfPickItem');
                _oProducts  = oreturnObjs;
                var nPrdctLength = _oProducts.length;
                var oExportPIDetails = $('#tblExportPIDetail').datagrid('getRows');
                for(var i =0;i<nPrdctLength;i++)
                {
                    //if(!ICS_IsExist(oExportPIDetails,'ProductID',_oProducts[i].ProductID))
                    //{
                    var   oExportPIDetail= {
                        ExportPIDetailID : 0,
                        ExportPIID: _oExportPI.ExportPIID,
                        ProductID: _oProducts[i].ProductID,
                        StyleNo :'',
                        Qty :0,
                        UnitPrice:0,
                        AdjQty:0,
                        AdjRate:0,
                        DocCharge:0,
                        AdjValue:0,
                        CRate:0,
                        QtyTwo:0,
                        UnitPriceTwo:0,
                        BuyerReference:'',
                        ColorInfo :'',
                        MUnitID: _oProducts[i].MeasurementUnitID,
                        MUName:_oProducts[i].MUnit,
                        ProductCode :_oProducts[i].ProductCode,
                        ProductName :_oProducts[i].ProductName,
                        ModelReferenceID:_oProducts[i].ModelReferenceID,
                        ModelReferenceName:_oProducts[i].ModelReferenceName,
                        Amount:0
                    };
                    $('#tblExportPIDetail').datagrid('appendRow',oExportPIDetail);
                    //}
                }
                RefreshTotalSummery();
                ResetDetail();
                $('#txtProductName').focus();
            }
        }
        else if (oPickerobj.winid == 'winFabricPicker')
        {

            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                $('#txtFabricNoExportPIDetail').val(oreturnObjs.length+" Item Selected.");
                $('#txtFabricNoExportPIDetail').addClass('fontColorOfPickItem');
                debugger;
                _oProducts  = oreturnObjs;

                for(var i =0;i<_oProducts.length;i++)
                {
                    if(_oProducts[i].ConstructionPI=="" || _oProducts[i].ConstructionPI==null)
                    {
                        _oProducts[i].Construction=_oProducts[i].Construction;
                    }
                    else{
                        _oProducts[i].Construction=_oProducts[i].ConstructionPI;
                    }
                    //if(!ICS_IsExist(oExportPIDetails,'ProductID',_oProducts[i].ProductID))
                    //{
                    var nQty=Qty_Fabric(_oProducts[i].FabricSalesContractDetailID);
                    var   oExportPIDetail= {
                        ExportPIDetailID : 0,
                        ExportPIID: _oExportPI.ExportPIID,
                        ProductID: _oProducts[i].ProductID,
                        Qty :_oProducts[i].Qty-parseFloat(_oProducts[i].Qty_PI)-parseFloat(nQty),
                        UnitPrice:_oProducts[i].UnitPrice,
                        AdjQty:0,
                        AdjRate:0,
                        DocCharge:0,
                        AdjValue:0,
                        CRate:0,
                        QtyTwo:_oProducts[i].Qty/_oUnitConversion.ConvertedUnitValue,
                        UnitPriceTwo:_oProducts[i].UnitPrice*_oUnitConversion.ConvertedUnitValue,
                        FabricID : _oProducts[i].FabricID,
                        FabricNo: _oProducts[i].FabricNo,
                        MUnitID:_oUnitConversion.MeasurementUnitID, //   _oProducts[i].MUnitID,
                        MUName:_oUnitConversion.MeasurementUnitSymbol,
                        MUNameTwo:'M',
                        ProductCode :_oProducts[i].ProductCode,
                        ProductName :_oProducts[i].ProductName,
                        ModelReferenceID:0,
                        OrderSheetDetailID:_oProducts[i].FabricSalesContractDetailID,
                        Construction:_oProducts[i].Construction,
                        FabricWidth:_oProducts[i].FabricWidth,
                        StyleNo: _oProducts[i].StyleNo,
                        BuyerReference :_oProducts[i].BuyerReference,
                        ColorInfo :_oProducts[i].ColorInfo,
                        ProcessType :_oProducts[i].ProcessType,
                        FinishType :_oProducts[i].FinishType,
                        FabricWeave :_oProducts[i].FabricWeave,
                        Amount:parseFloat(_oProducts[i].Qty*_oProducts[i].UnitPrice),
                        AmountSt:parseFloat(_oProducts[i].Qty*_oProducts[i].UnitPrice),
                        FSCNo:_oProducts[i].SCNoFull
                    };

                    $('#tblExportPIDetail').datagrid('appendRow',oExportPIDetail);
                    //}
                    //}
                }
                RefreshTotalSummery();
                ResetDetail();
                $('#txtFabricNoExportPIDetail').focus();
            }
        }
        else if (oPickerobj.winid == 'winTermsAndCondition') {
            if (oreturnObjs != null && oreturnObjs.length > 0) {
                var oTermsAndConditions = oreturnObjs;
                if (oTermsAndConditions != null && oTermsAndConditions.length > 0) {
                    var oPITermsAndConditions = $('#tblPITandCClauses').datagrid('getRows');
                    if (oPITermsAndConditions.length > 0) {
                        var identify = 0;
                        for (var i = 0; i < oTermsAndConditions.length; i++) {
                            identify = 0;
                            for (var j = 0; j < oPITermsAndConditions.length; j++)
                            {
                                //oTermsAndConditions[i].CaptionName.replace()
                                if (oTermsAndConditions[i].Clause == oPITermsAndConditions[j].TermsAndCondition)
                                {
                                    identify = 0;
                                    break;
                                } else {
                                    identify = 1;
                                }
                            }
                            if (identify == 1) {
                                var oPITAndC = {
                                    ExportPITandCClauseID: 0,

                                    ExportPIID: 0,
                                    DocFor:oTermsAndConditions[i].DocFor,
                                    CaptionName:oTermsAndConditions[i].CaptionName,
                                    ExportTnCCaptionID:oTermsAndConditions[i].ExportTnCCaptionID,
                                    TermsAndCondition: oTermsAndConditions[i].Clause
                                };

                                $('#tblPITandCClauses').datagrid('appendRow', oPITAndC);
                            }
                        }
                    }
                    else {
                        for (var i = 0; i < oTermsAndConditions.length; i++) {
                            var oPITAndC = {
                                ExportPITandCClauseID: 0,
                                ExportPIID: 0,
                                DocFor:oTermsAndConditions[i].DocFor,
                                CaptionName:oTermsAndConditions[i].CaptionName,
                                ExportTnCCaptionID:oTermsAndConditions[i].ExportTnCCaptionID,
                                TermsAndCondition: oTermsAndConditions[i].Clause
                            };

                            $('#tblPITandCClauses').datagrid('appendRow', oPITAndC);
                        }

                    }
                }
            }
            else {
                alert("Please select minimum one Terms And Condition.");
                return false;
            }
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }


    function ValidateInputDetail()
    {
        if(_oProduct==null || $('#txtProductName').val()=="")
        {
            $('#txtProductName').focus();
            $('#txtProductName').addClass("errorFieldBorder");
            alert('Select Product');
            return false;
        }
        return true;
    }

    function ResetDetail(){
        _oProduct = null;
        $('#txtProductName').removeClass("fontColorOfPickItem");
        $('#txtProductName').val("");
        $('#txtProductName').focus();
        $('#txtFabricNoExportPIDetail').val("");
        $('#txtFabricNoExportPIDetail').focus();
    }

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnRemoveDetail").click(function () {
        var oExportPIDetail = $("#tblExportPIDetail").datagrid("getSelected");
        if (oExportPIDetail == null) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to Delete?")) return false;
        var SelectedRowIndex=$('#tblExportPIDetail').datagrid('getRowIndex',oExportPIDetail);
        alert("Data Delete Successfully.");
        $('#tblExportPIDetail').datagrid('deleteRow', SelectedRowIndex);
        RefreshTotalSummery();
        editIndex = undefined;
    });

    function RefreshTotalSummery()
    {
        debugger;
        var nTotalQty = 0;
        var nTotalValue = 0;

        var oPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        for (var i = 0; i < oPIDetails.length; i++)
        {
            if(oPIDetails[i].MUnitID!=1)
            {
                nTotalQty = nTotalQty + parseFloat(oPIDetails[i].Qty);
            }
            if(oPIDetails[i].IsDeduct==true)
            {
                nTotalValue = nTotalValue - parseFloat(oPIDetails[i].UnitPrice * oPIDetails[i].Qty);
            }
            else
            {  nTotalValue = nTotalValue + parseFloat(oPIDetails[i].UnitPrice * oPIDetails[i].Qty);}
        }
        var sCurrency = "";
        var nCurrency = $("#cboCurrency option:selected").val();
        if (nCurrency > 0) {
            sCurrency = $("#cboCurrency option:selected").text();
        }
        document.getElementById("lblTotalQty").innerHTML = PriceFormateInString(nTotalQty,4);
        document.getElementById("lblTotalValue").innerHTML = sCurrency + " " + PriceFormateInString(nTotalValue,4);
    }

    function PriceFormateInString(nVal, nDigitAfterDot) {
        if (nVal == null) {
            nVal = 0.00;
        }
        nVal = parseFloat(nVal);
        var test = nVal.toFixed(nDigitAfterDot);
        var tests = addComma(test);
        return tests;
    }

    var editIndex = undefined;

    _nQty = 0;
    _nUnitPrice = 0;
    _nQtyTwo = 0;
    _nUnitPriceTwo = 0;
    _sDescription = "";


    $("#btnPrintPI").click(function () {
        if (_oExportPI == null || _oExportPI.ExportPIID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        window.open(_sBaseAddress + '/ExportPI/PrintoExportPIPreview?id=' + _oExportPI.ExportPIID + "&bPrintFormat=false&nTitleTypeInImg=1" , "_blank");//Defalult false
    });

    //Contact Person
    function formatPricePrice(val,row){
        //debugger;
        if(val==null)
        {
            val=0.00;
        }
        val=parseFloat(val);
        var test = val.toFixed(4);
        var tests = addComma(test);
        return tests;
    }

    function addComma(nStr)
    {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? '.' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }


    $("#btnAcceptReviseExportPI").click(function (e) {
        debugger;
        endEditing();
        endEditingTC();
        if (!ValidateInputExportPI()) return;
        var oExportPI = RefreshObjectExportPI();
        if ($("#chkIsCreateReviseNo").is(':checked'))
        {
            oExportPI.IsCreateReviseNo=true;
            //alert("Confirm Change this P/I with ReviseNo ")
            if (!confirm("Confirm to Change this P/I with Revise No ?")) return false;
        }else{
            oExportPI.IsCreateReviseNo=false;
            if (!confirm("Confirm to Change this P/I without Revise No ?")) return false;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ExportPI/AcceptExportPIRevise",
            traditional: true,
            data:  JSON.stringify(oExportPI),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oExportPI = jQuery.parseJSON(data);
                if (oExportPI.ErrorMessage==null || oExportPI.ErrorMessage=="")
                {
                    //alert("Data Saved successfully");
                    var oExportPIs = sessionStorage.getItem("ExportPIs");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oExportPIs != null) {
                        oExportPIs = jQuery.parseJSON(oExportPIs);
                    }
                    else {
                        oExportPIs = [];
                    }
                    if (nIndex != -1) {
                        oExportPIs[nIndex] = oExportPI;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oExportPIs.length);
                        oExportPIs.push(oExportPI);
                    }
                    sessionStorage.setItem("ExportPIs", JSON.stringify(oExportPIs));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oExportPI.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });


    $('#txtIssueDate').datebox({
        onSelect: function(date){

            $("#txtValidateDate").datebox("setValue", icsdateformat(new Date(date.getFullYear(), date.getMonth(), date.getDate()+7)));
        }
    });

    ////Change Detail
    $("#btnPickDetail").click(function () {
        debugger;
        //$('#txtWeight,#txtShrinkage').icsCurrencyBox();
        $("#winExPIDetail input").val("");
        var oExportPIDetail = $('#tblExportPIDetail').datagrid('getSelected');
        if (oExportPIDetail ==null ) { alert("Please select an item from list."); return ; }
        PickProductInFabric(oExportPIDetail.ProductID);
        $('#txtFabricNo_F').prop('disabled',true);
        $("#txtFabricNo_F").val(oExportPIDetail.FabricNo);
        $("#txtFSCNo").val(oExportPIDetail.FSCNo);
        $("#cboProductFabric").val(oExportPIDetail.ProductID);
        $("#txtConstruction_F").val(oExportPIDetail.Construction);
        $("#txtFabricWidthFabric").val(oExportPIDetail.FabricWidth);
        $("#cboProcessTypeFabric").val(oExportPIDetail.ProcessType);
        $("#cboFinishTypeFabric").val(oExportPIDetail.FinishType);
        //  $("#cboFabricDesign").val(oExportPIDetail.FabricDesignID);
        $("#cboWeaveFabric").val(oExportPIDetail.FabricWeave);
        $("#cboEQuality").val(oExportPIDetail.ExportQualityID);
        $("#txtStyleNoFabric").val(oExportPIDetail.StyleNo);
        $("#txtColorFabric").val(oExportPIDetail.ColorInfo);
        $("#txtBRef").val(oExportPIDetail.BuyerReference);
        $("#txtNoteDetail").val(oExportPIDetail.ProductDescription);
        $("#txtWeight").val(oExportPIDetail.Weight);
        $("#txtShrinkage").val(oExportPIDetail.Shrinkage);
        $("#chkIsDeductYes").prop("checked", oExportPIDetail.IsDeduct);
        $("#chkIsDeductNo").prop("checked", !oExportPIDetail.IsDeduct);
        if(oExportPIDetail.FabricID>0)
        {
            $("#trIsDeduct").hide();
        }
        else{
            $("#trIsDeduct").show();
        }
        $("#winExPIDetail").icsWindow("open","Change  info");
    });
    $("#btnUpdateFSEDetail").click(function () {
        debugger;
        var oExportPIDetail = $('#tblExportPIDetail').datagrid('getSelected');
        if (oExportPIDetail ==null ) { alert("Please select an item from list."); return ; }
        var nSelectedRowIndex=$('#tblExportPIDetail').datagrid('getRowIndex',oExportPIDetail);

        var ncboProductFabric = document.getElementById("cboProductFabric");
        if(parseInt($("#cboProductFabric").val())<=0)
        {
            alert("Invalid Selection!!! please select a valid Yarn Name!");
            $('#cboProductFabric').focus();
            return ;
        }
        var sText = ncboProductFabric.options[ncboProductFabric.selectedIndex].text;
        oExportPIDetail.ProductID=$("#cboProductFabric").val();
        oExportPIDetail.ProductName=sText;
        oExportPIDetail.Construction=$("#txtConstruction_F").val();
        oExportPIDetail.FinishType=$("#cboFinishTypeFabric").val();
        oExportPIDetail.FabricWeave=$("#cboWeaveFabric").val();
        oExportPIDetail.FabricWidth=$("#txtFabricWidthFabric").val();
        oExportPIDetail.ExportQualityID=$("#cboEQuality").val();
        oExportPIDetail.StyleNo=$("#txtStyleNoFabric").val();
        oExportPIDetail.ColorInfo=$("#txtColorFabric").val();
        oExportPIDetail.ProcessType=$("#cboProcessTypeFabric").val();
        //oExportPIDetail.FabricDesignID=$("#cboFabricDesign").val();
        oExportPIDetail.BuyerReference=$("#txtBRef").val();
        oExportPIDetail.ProductDescription=$("#txtNoteDetail").val();
        oExportPIDetail.Weight=$.trim($("#txtWeight").val());
        oExportPIDetail.Shrinkage=$.trim($("#txtShrinkage").val());
        if(oExportPIDetail.FabricID>0)
        {
            oExportPIDetail.IsDeduct=false;
        }
        else
        {
            oExportPIDetail.IsDeduct=$("#chkIsDeductYes").is(":checked");
            if(oExportPIDetail.IsDeduct==true)
            {
                oExportPIDetail.AmountSt =  "-("+formatPrice(oExportPIDetail.Amount)+")";
            }
            else{ oExportPIDetail.AmountSt =  formatPrice(oExportPIDetail.Amount);}
        }

        $('#tblExportPIDetail').datagrid('updateRow', { index: nSelectedRowIndex, row: oExportPIDetail });

        endEditing();
        editIndex = undefined;

        $("#winExPIDetail").icsWindow("close");
        RefreshTotalSummery();
    });
    $("#btnCloseFSEDetail").click(function () {

        $("#winExPIDetail").icsWindow("close");

    });
    function CopyDetail()
    {
        debugger;
        var oExportPIDetail = $("#tblExportPIDetail").datagrid("getSelected");
        if (oExportPIDetail == null) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to copy?")) return false;
        var SelectedRowIndex=$('#tblExportPIDetail').datagrid('getRowIndex',oExportPIDetail);



        var oExportPIDetailNew={
            ExportPIDetailID:0,
            ExportPIID: (_oExportPI!=null && _oExportPI.ExportPIID>0)? _oExportPI.ExportPIID:0,
            ProductID:oExportPIDetail.ProductID,
            Qty: oExportPIDetail.Qty,
            MUnitID:oExportPIDetail.MUnitID,
            UnitPrice:oExportPIDetail.UnitPrice,
            Amount:oExportPIDetail.Amount,
            ProductCode:oExportPIDetail.ProductCode,
            ProductName:oExportPIDetail.ProductName,
            MUName:oExportPIDetail.MUName,
            Currency:oExportPIDetail.Currency,
            ReferenceCaption:oExportPIDetail.ReferenceCaption,
            ColorInfo:oExportPIDetail.ColorInfo,
            BuyerReference:oExportPIDetail.BuyerReference,
            StyleNo:oExportPIDetail.StyleNo,
            FabricID:oExportPIDetail.FabricID,
            AdjQty:oExportPIDetail.AdjQty,
            AdjRate:oExportPIDetail.AdjRate,
            DocCharge: oExportPIDetail.DocCharge,
            AdjValue: oExportPIDetail.AdjValue,
            CRate:oExportPIDetail.CRate,
            CRateTwo:oExportPIDetail.CRateTwo,
            QtyCom:oExportPIDetail.QtyCom,
            HSCode:oExportPIDetail.HSCode,
            ProductDescription:oExportPIDetail.ProductDescription,
            SizeName:oExportPIDetail.SizeName,
            FabricNo :oExportPIDetail.FabricNo,
            FabricWidth :oExportPIDetail.FabricWidth,
            Construction:oExportPIDetail.Construction,
            ProcessType :oExportPIDetail.ProcessType,
            FabricWeave:oExportPIDetail.FabricWeave,
            FinishType:oExportPIDetail.FinishType,
            ProcessTypeName :oExportPIDetail.ProcessTypeName,
            FabricWeaveName :oExportPIDetail.FabricWeaveName,
            FinishTypeName :oExportPIDetail.FinishTypeName,
            ExportQualityID :oExportPIDetail.ExportQualityID,
            ExportQuality :oExportPIDetail.ExportQuality,
            FSCNo  :oExportPIDetail.FSCNo,
            Shrinkage:oExportPIDetail.Shrinkage,
            Weight :oExportPIDetail.Weight,
            OrderSheetDetailID: oExportPIDetail.OrderSheetDetailID,
            QtyTwo :(oExportPIDetail.Qty / _oUnitConversion.ConvertedUnitValue).toFixed(8),
            UnitPriceTwo : (oExportPIDetail.UnitPrice *_oUnitConversion.ConvertedUnitValue).toFixed(8)
        }

        var oExportPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        var nLength = oExportPIDetails.length;
        $('#tblExportPIDetail').datagrid('appendRow',oExportPIDetailNew);
        $('#tblExportPIDetail').datagrid('selectRow', nLength);
        //endEditing();
        //editIndex = undefined;
    }

    function PickProductInFabric(nProductID) {

        var oProduct = { BUID:sessionStorage.getItem("BUID"),ProductName:""};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "ExportPI",
            ActionName: "GetProducts",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    $("#cboProductFabric").icsLoadCombo({
                        List: response.objs,
                        OptionValue: "ProductID",
                        DisplayText: "ProductName"
                    });
                    $("#cboProductFabric").val(nProductID);

                }
                else {
                    $("#cboProductFabric").empty();
                }
            }
            else {
                $("#cboProductFabric").empty();
            }
        });
    }

    function IsDeductYes() {
        document.getElementById("chkIsDeductYes").checked = true;
        document.getElementById("chkIsDeductNo").checked = false;
    }

    function IsDeductNo() {
        document.getElementById("chkIsDeductYes").checked = false;
        document.getElementById("chkIsDeductNo").checked = true;
    }

    //// Add Dyeing Bill
    $("#btnGetPIBill").click(function () {
        var oExportPI={ExportPIID:_oExportPI.ExportPIID,IsApproved:false,ContractorID: _oExportPI.ContractorID,BuyerID:_oExportPI.BuyerID};
        GetsDeliveryOrderBillByExportPI(oExportPI,false);
    });
    $("#btnNewBillPI").click(function () {
        debugger;
        var oExportPI={ExportPIID:_oExportPI.ExportPIID,IsApproved:true,ContractorID: _oExportPI.ContractorID,BuyerID:_oExportPI.BuyerID};
        GetsDeliveryOrderBillByExportPI(oExportPI,false);
    });
    $("#btnProductFormDeliveryBill").click(function () {

        debugger
        if (_oExportPI.ExportPIID > 0) {
            GetsDeliveryOrderBillByExportPI(_oExportPI,false);
        }
        else
        {
            if (_oExportPI.ContractorID <= 0) {
                $('#tabExportPITabs').tabs('select', 0);
                alert("Please select Account Of!"); $('#txtContractorName').focus();
                $("#txtContractorName").addClass("errorFieldBorder");
                return false;
            } else {
                $("#txtContractorName").removeClass("errorFieldBorder");
            }

            GetsDeliveryOrderBillByExportPI(_oExportPI,true);
        }
    });
    function GetsDeliveryOrderBillByExportPI(oExportPI, IsWinOpen) {
        var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oExportPI,
                ControllerName: "ExportPI",
                ActionName: "GetSampleInvoices",
                IsWinClose: false
            };
        GetDUBillWithDetail(obj, IsWinOpen, true)
    }
    function ResetControllExportPIInfoToDeliveryBill() {
        //$("#btnOkDeliveryBill").hide();
        //$("#btnRemovePIFromBill").hide();
        //_oDUDBillDetails = [];
        DynamicRefreshList([], "tblSampleInvoices");
        DynamicRefreshList([], "tblDODetails");
        RefreshTotal_Bill();
    }
    function GetDUBillWithDetail(obj,IsWinOpen,IsAssociatedPI) {

        ResetControllExportPIInfoToDeliveryBill();
        $.icsDataGets(obj, function (response) {

            $("#winDeliveryBill").icsWindow("open", 'Product From Delivery Bill');
            $("#tabDeliveryBill").tabs("select", 0);

            if (response.status && response.objs.length > 0) {
                var oSampleInvoices = response.objs;
                if (oSampleInvoices != null && oSampleInvoices.length > 0 && oSampleInvoices[0].SampleInvoiceID > 0) {
                    DynamicRefreshList(oSampleInvoices, "tblSampleInvoices");
                    var _oSampleInvoiceDetails = oSampleInvoices[0].SampleInvoiceDetails;
                    if (_oSampleInvoiceDetails != null && _oSampleInvoiceDetails.length > 0) {
                        DynamicRefreshList(_oSampleInvoiceDetails, "tblDODetails");
                        RefreshTotal_Bill();

                        for(var j =0;j<oSampleInvoices.length;j++)
                        {
                            if(oSampleInvoices[j].ExportPIID>0)
                            {
                                $('#tblSampleInvoices').datagrid('checkRow', j);
                            }

                        }
                    }
                }

            }
            else {
                $("#btnRemovePIFromBill").hide();
            }
        });
    }
    $("#btnOkDeliveryBill").click(function () {

        var oSIs = $('#tblSampleInvoices').datagrid("getChecked");
        var bFlage=false;
        if (oSIs.length <= 0) {
            alert("No bill/Invoice info found to add");
            return;
        }
        if(_oExportPI.ExportPIID>0)
        {
            var oSampleInvoice={SampleInvoiceNo: GetSampleInvoiveIDs(),ExportPIID:_oExportPI.ExportPIID}
            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oSampleInvoice,
                ControllerName: "SampleInvoice",
                ActionName: "BillForExportPI",
                TableId: "tblSampleInvoices",
                IsWinClose: false,
                Message: '',
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj.ErrorMessage == "")
                {
                    DynamicRefreshList([], "tblDODetails");

                }

            });
        }


        GetsDOD();
        var oDUDBs = $('#tblDODetails').datagrid("getRows");
        if (oDUDBs.length <= 0) {
            alert("No bill/Invoice info found to add");
            return;
        }

        for(var i =0;i<oDUDBs.length;i++)
        {
            oDUDBs[i].ProductID=oDUDBs[0].ProductID;
        }

        var nPrdctLength = oDUDBs.length;
        var oExportPIDetails = $('#tblExportPIDetail').datagrid('getRows');
        if(oExportPIDetails.length<=0)
        {
            for(var i =0;i<oDUDBs.length;i++)
            {
                if(!ICS_IsExist(oExportPIDetails,'ProductID',oDUDBs[i].ProductID))
                {
                    var oExportPIDetail= {
                        ExportPIDetailID : 0,
                        ExportPIID: _oExportPI.ExportPIID,
                        ProductID: oDUDBs[i].ProductID,
                        StyleNo :'',
                        Qty :oDUDBs[i].Qty,
                        UnitPrice: parseFloat(oDUDBs[i].UnitPrice),
                        AdjQty:0,
                        AdjRate:0,
                        DocCharge:0,
                        AdjValue:0,
                        CRate:0,
                        QtyTwo:parseFloat(oDUDBs[i].Qty)*parseFloat($('#tabExportPITabs').data('MeasurementUnitCon').Value),
                        UnitPriceTwo:parseFloat(oDUDBs[i].UnitPrice/parseFloat($('#tabExportPITabs').data('MeasurementUnitCon').Value)),
                        BuyerReference:'',
                        ColorInfo :'',
                        MUnitID: $('#tabExportPITabs').data('MeasurementUnitCon').ToMUnitID,
                        MUName: $('#tabExportPITabs').data('MeasurementUnitCon').ToMUnit,
                        MUNameTwo: $('#tabExportPITabs').data('MeasurementUnitCon').FromMUnit,
                        ProductCode :oDUDBs[i].ProductCode,
                        ProductName :oDUDBs[i].ProductName,
                        ModelReferenceID:0,
                        ModelReferenceName:'',
                        Amount:oDUDBs[i].Amount
                    };
                    $('#tblExportPIDetail').datagrid('appendRow',oExportPIDetail);
                }
                else
                {
                    for(var j =0;j<oExportPIDetails.length;j++)
                    {
                        if(oDUDBs[i].ProductID==oExportPIDetails[j].ProductID)
                        {
                            oExportPIDetails[j].Qty=oDUDBs[i].Qty;
                            oExportPIDetails[j].QtyTwo=oDUDBs[i].Qty*parseFloat($('#tabExportPITabs').data('MeasurementUnitCon').Value);
                            UnitPriceTwo:parseFloat(oDUDBs[i].UnitPrice/parseFloat($('#tabExportPITabs').data('MeasurementUnitCon').Value)),
                            oExportPIDetails[j].Amount=oDUDBs[i].Amount;
                            var nSelectedRowIndex=$('#tblExportPIDetail').datagrid('getRowIndex',oExportPIDetails[i]);
                            $('#tblExportPIDetail').datagrid('updateRow', { index: nSelectedRowIndex, row:  oExportPIDetails[i] });
                        }
                    }
                }
            }
        }

        $("#winDeliveryBill").icsWindow("close");
        RefreshTotalSummery();
    });
    $("#btnRemovePIFromBill").click(function () {

        //var oDUDBs = $('#tblDeliveryBills').datagrid("getChecked");
        //if (oDUDBs.length <= 0) { oDUDBs = $('#tblDeliveryBills').datagrid("getRows"); }

        if (!confirm("Are you sure to remove bill?")) { return; }
        var oSampleInvoice = $('#tblSampleInvoices').datagrid('getSelected');
        if(oSampleInvoice.ExportPIID>0)
        {
            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oSampleInvoice,
                ControllerName: "SampleInvoice",
                ActionName: "RemoveExportPIFromBill",
                TableId: "tblSampleInvoices",
                IsWinClose: false,
                Message: '',
            };
            $.icsDelete(obj, function (response) {
                if (response.status && response.Message == "deleted")
                {
                    DynamicRefreshList([], "tblDODetails");
                    GetsDOD();
                    //DeliveryOrderBillDetailSummery();
                }
            });
        }
        else{

            var SelectedRowIndex = $('#tblSampleInvoices').datagrid('getRowIndex', oSampleInvoice);
            $('#tblSampleInvoices').datagrid('deleteRow',SelectedRowIndex);
            GetsDOD();
            //  RefreshSummary();
        }

    });
    $("#btnCloseDeliveryBill").click(function () {
        $("#winDeliveryBill").icsWindow("close");
    });
    function GetSampleInvoiveIDs() {
        var sIDs = '';
        var oDUDBs = $('#tblSampleInvoices').datagrid("getChecked");
        //var oDUDBs = $('#tblSampleInvoices').datagrid("getRows");
        if (oDUDBs.length > 0) {
            for (var i = 0; i < oDUDBs.length; i++) {
                sIDs = sIDs + oDUDBs[i].SampleInvoiceID + ','
            }
            sIDs = sIDs.substring(0,sIDs.length-1);
        }
        return sIDs;
    }

    function GetsDOD()
    {
        var oSIs = $('#tblSampleInvoices').datagrid("getChecked");
        if (oSIs.length<=0) {return;}
        //var oSIs = $('#tblSampleInvoices').datagrid("getRows");
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oSIs,
            ControllerName: "ExportPI",
            ActionName: "GetDODetails",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0)
            {
                DynamicRefreshList(response.objs, "tblDODetails");
                RefreshTotal_Bill();
            }
        });
    }
    function RefreshTotal_Bill()
    {
        debugger;
        var nTotalQty = 0;
        var nTotalValue = 0;
        var nTotalUP = 0;

        var oDODetails = $('#tblDODetails').datagrid('getRows');
        for (var i = 0; i < oDODetails.length; i++) {
            nTotalQty = nTotalQty + parseFloat(oDODetails[i].Qty);
            nTotalValue = nTotalValue + parseFloat(oDODetails[i].Amount);

        }
        var sCurrency = "";
        var nCurrency = $("#cboCurrency option:selected").val();
        if (nCurrency > 0) {
            sCurrency = $("#cboCurrency option:selected").text();
        }
        if(nTotalQty>0)
        {
            nTotalUP=nTotalValue/nTotalQty;
        }
        document.getElementById("lblQty_Bill_MUOne").innerHTML = PriceFormateInString(nTotalQty,4);
        document.getElementById("lblUP_Bill_MUOne").innerHTML = sCurrency + " " + PriceFormateInString(nTotalUP,4);
        document.getElementById("lblAmount_Bill_MUOne").innerHTML =  sCurrency + " " +PriceFormateInString(nTotalValue,2);
    }
</script>


