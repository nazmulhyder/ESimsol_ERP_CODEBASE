@{
    ViewBag.Title = "Labdip orders";
}

@model IEnumerable<ESimSol.BusinessObjects.LabDip>

    <head>
        <title>Lab Dip Orders</title>
    </head>

    <body>
        <div class="menuMainCollectionTable">
            <table id="tblLabDip" title="Labdip List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbarLabdip">
                <thead>
                    <tr>
                        <th field="LabdipNo" width="8%"><label id="lblLabdipNo">Labdip No</label></th>
                        <th field="OrderDateStr" width="9%">Issue Date</th>
                        <th field="SeekingDateStr" width="9%">Seeking Date</th>
                        <th field="ContractorName" width="15%">Contractor</th>
                        <th field="DeliveryToName" width="15%">Delivered To</th>
                     
                        <th field="MktPerson" width="12%">Mkt Person</th>
                        <th field="OrderReferenceTypeSt" width="8%">Source</th>
                        <th field="OrderNo" width="7%">Order No</th>
                        <th field="OrderStatusStr" width="14%">Status</th>
                        <th field="PriorityLevelStr" width="8%">Priority</th>
                    </tr>
                </thead>

            </table>>

            <div id="toolbarLabdip">
                <input id="chkDate" type="checkbox" />
                <input id="dtOrderFrom" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input id="dtOrderTo" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input type="text" id="txtLabdipNo" placeholder="Search Labdip" style="width:8%;" />
                <input type="text" id="txtLabdipColorNo" placeholder="Search Color" style="width:8%;" />
                <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv Search</a>
                <a id="btnAddColor" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Color</a>
                <a id="btnOrderStatus" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true"> <label id="lblOrderStatus">Approve</label> </a>
                <a id="btnUndo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true">Undo</a>
                @*<a id="btnCreateChallan" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-add" plain="true">Create Challan</a>*@
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                <a id="btnPrintToExcel" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-excel" plain="true">Excel</a>
                <a id="btnPrintRecipe" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print Recipe</a>
                <a id="btnPrintSubmission" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print Submission</a>
                <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">Detils</a>
            </div>
        </div>
        
        <div id="winAdvanceSearch" class="easyui-window winstyle" title="Adv Search" style="width:450px; height:540px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 100%; font-family: Tahoma;">
                <fieldset>
                    <legend>Searching Criteria</legend>
                    <table class="tbl-AdvSearch">
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Mkt Person :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtMktPerson" class="reset-text pickersearch" placeholder="Search Mkt Person" />
                                <a id="btnPickMktPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetMktPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Issue To :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtIssueTo" class="reset-text pickersearch" placeholder="Search Issue To" />
                                <a id="btnPickIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Delivered To :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtDeliverTo" class="reset-text pickersearch" placeholder="Search Delivery To" />
                                <a id="btnPickDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Order No :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtOrderNo" class="reset-text pickersearch" placeholder="Search Order No" />
                                <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>

                            <td class="td-AdvSearch-Level">
                                Labdip Format :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboLabDipFormat"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Light Source :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboLightSource"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Issue Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsOrderDateAdv" type="checkbox" />
                                <input id="dtOrderDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtOrderDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Requirement Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsSeekingDateAdv" type="checkbox" />
                                <input id="dtSeekingDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtSeekingDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Status Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsStatusDateAdv" type="checkbox" />
                                <input id="dtStatusDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtStatusDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>

                        <tr>
                            <td class="td-AdvSearch-Level" valign="top">
                                Labdip Status :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <table id="tblOrderStatus" class="easyui-datagrid" style="height:180px;" fitcolumn="true" rownumbers="true" pagination="false" multiselect="true" autorowheight="false">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'Selected',checkbox:true"> </th>
                                            <th field="Text" width="80%">Status</th>
                                        </tr>
                                    </thead>

                                </table>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <legend>Action</legend>
                    <div class="align-right">
                        <a id="btnSearchOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        <a id="btnSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>

            </div>
        </div>
    </body>

    <style type="text/css">
        .td-AdvSearch-Level {
            width: 35%;
            text-align: right;
            font-weight: bold;
        }

        .td-AdvSearch-Input {
            width: 64%;
        }

        .td-AdvSearch-Input select {
            width: 99%;
        }

        .td-AdvSearch-Input .textSearch {
            width: 96%;
        }

        .td-AdvSearch-Input .pickersearch {
            width: 73%;
        }
    </style>

    <script type="text/javascript">
        var _sBaseAddress="";
        var _oLabDips=[];
        var _oLightSources=[];
        var _oLabdipFormats=[];
        var _oLabdipOrderStatuss=[];

        var _sMessage='';
        var _nNextStatus=-1;

        
        var _sContractorIDs="";
        var _sDeliveryToIDs="";
        var _sMktPersonIDs="";
        var _sOrderNos='';
        var _nBUID=0;
        $(document).ready(function () {
            _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
            _oLabDips =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));

            _oLightSources=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LightSources));
            _oLabdipFormats=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumLabdipFormats));
            _oLabdipOrderStatuss=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumLabdipOrderStatuss));
            var oLabDipSetup =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LabDipSetup));
            _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
          
            LabdipSetup(oLabDipSetup);
            if(sessionStorage.getItem("Labdips")!=null && sessionStorage.getItem("Labdips").length>0){
                _oLabDips= jQuery.parseJSON(sessionStorage.getItem('Labdips'));
                var nIndex= sessionStorage.getItem('SelectedRowIndex');
                DynamicRefreshList(_oLabDips, 'tblLabDip');
                if(nIndex>-1){
                    $('#tblLabDip').datagrid('selectRow',nIndex);
                }
            }
            else{
                DynamicRefreshList(_oLabDips, 'tblLabDip');
            }
            $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':true});
            $('#dtOrderFrom,#dtOrderTo').datebox('setValue', icsdateformat(new Date()));

            DynamicRefreshList(_oLabdipOrderStatuss, 'tblOrderStatus');
            $("#cboLightSource").icsLoadCombo({
                List: _oLightSources,
                OptionValue: "LightSourceID",
                DisplayText: "Descriptions",
                InitialValue:"Default"
            });

            $("#cboLabDipFormat").icsLoadCombo({
                List: _oLabdipFormats,
                OptionValue: "id",
                DisplayText: "Value",
                InitialValue:""
            });

        });

        $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winLabDipOrder').icsWindow('close'); } });
        function LabdipSetup(oLabDipSetup)
        {
            $('#lblLabdipNo').html(oLabDipSetup.OrderName);
            $("#txtLabdipNo").attr("placeholder", "Type "+oLabDipSetup.OrderName);
            $("#txtLabdipColorNo").attr("placeholder","Type "+oLabDipSetup.ColorNoName);
        }

        $('#tblLabDip').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });
   
        function OperationPerforms(rowIndex, rowData) {
            if (rowData != null && rowData.LabDipID > 0) {

                $('#btnUndo,#btnOrderStatus').hide();
                if (rowData.OrderStatus==4) // InLab = 4,
                {
                    _nNextStatus=5;
                    _sMessage="labdip done.";
                    $('#lblOrderStatus').text('Labdip Done');
                    $('#btnAddColor,#btnUndo,#btnOrderStatus').show();
                }
                else if (rowData.OrderStatus==5) // LabdipDone=5,
                {
                    _nNextStatus=6;
                    _sMessage="send a request receive from lab.";
                    $('#lblOrderStatus').text('Forward to Delivery Dept');
                    $('#btnOrderStatus').show();
                    $('#btnUndo').hide();
                }                
            }
        }


        $('#chkDate').change(function(e){
            debugger;
            if($('#chkDate').is(':checked')){
                $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':false});
            }
            else{
                $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':true});
            }
            $('#dtOrderFrom,#dtOrderTo').datebox('setValue', icsdateformat(new Date()));
        });


        $('#btnPrint').click(function (e)
        {
            var _oLabDip= $('#tblLabDip').datagrid('getSelected');
            if (_oLabDip ==null || _oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/LabDip/PrintLabDip?nId="+_oLabDip.LabDipID+"&nts="+tsv, "_blank");
        });
        $('#btnPrintRecipe').click(function (e)
        {
            var _oLabDip= $('#tblLabDip').datagrid('getSelected');
            if (_oLabDip ==null || _oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/LabDip/PrintLabDipRecipe?nId="+_oLabDip.LabDipID+"&nDetailID=0&nts="+tsv, "_blank");
        });
        $('#btnPrintSubmission').click(function (e)
        {
            var _oLabDip= $('#tblLabDip').datagrid('getSelected');
            if (_oLabDip ==null || _oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/LabDip/PrintLabDipSubmission?nId="+_oLabDip.LabDipID+"&nDetailID=0&nts="+tsv, "_blank");
        });
        $('#btnPrintToExcel').click(function (e)
        {
            var Params=sessionStorage.getItem("AdvSQL");
            var tsv=((new Date()).getTime())/1000;
            window.open(_sBaseAddress+ "/LabDip/PrintLabDipsXL?Params="+(Params==null?"":Params)+"&nts="+tsv, "_blank");
        });
        /*.......... Searching ............. */
        
        $("#txtLabdipNo").keyup(function (e) {
            var oLabDips =[];
            var keyCode = e.keyCode || e.which;
            $('#txtLabdipNo').removeClass("errorFieldBorder");
            if (keyCode == 8) { oLabDips = _oLabDips; }
            else{ oLabDips = $('#tblLabDip').datagrid('getRows'); }
            if (e.keyCode == 13) // Enter Press
            {
                debugger;
                if (!$.trim($("#txtLabdipNo").val()).length) {

                    alert("Please money receipt no no.");
                    $('#txtLabdipNo').focus();
                    $('#txtLabdipNo').val("");
                    return;
                }
                else { $('#txtLabdipNo').removeClass("errorFieldBorder"); }

                var oLabDip = {
                    Params:$.trim($("#txtLabdipNo").val()) +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+'~'+''+'~'+ $.trim($("#txtLabdipColorNo").val())+""+"~"
                };
                GetsLabdip(oLabDip, false) ;
            }
            else {
                var sTempName="";
                var oSearchedData = [];
                for(i=0;i<oLabDips.length;++i)
                {
                    sTempName=oLabDips[i]['LabdipNo'];
                    if(sTempName.toUpperCase().indexOf($('#txtLabdipNo').val().toUpperCase())>-1)
                    {
                        oSearchedData.push(oLabDips[i]);
                    }
                }
                $('#tblLabDip').empty();
                if (oSearchedData.length == 0) { DynamicRefreshList(_oLabDips, "tblLabDip");}
                else { DynamicRefreshList(oSearchedData, "tblLabDip"); }

            }
        });
        $("#txtLabdipColorNo").keyup(function (e) {
            var oLabDips =[];
            var keyCode = e.keyCode || e.which;
            $('#txtLabdipColorNo').removeClass("errorFieldBorder");
            if (keyCode == 8) { oLabDips = _oLabDips; }
            else{ oLabDips = $('#tblLabDip').datagrid('getRows'); }
            if (e.keyCode == 13) // Enter Press
            {
                debugger;
                if (!$.trim($("#txtLabdipColorNo").val()).length) {

                    alert("Please money receipt no no.");
                    $('#txtLabdipColorNo').focus();
                    $('#txtLabdipColorNo').val("");
                    return;
                }
                else { $('#txtLabdipColorNo').removeClass("errorFieldBorder"); }

                var oLabDip = {
                    Params:"" +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+'~'+''+'~'+ $.trim($("#txtLabdipColorNo").val())+""+"~"
                };
                GetsLabdip(oLabDip, false) ;
            }
            else {
                var sTempName="";
                var oSearchedData = [];
              
                $('#tblLabDip').empty();
                if (oSearchedData.length == 0) { DynamicRefreshList(_oLabDips, "tblLabDip");}
                else { DynamicRefreshList(oSearchedData, "tblLabDip"); }

            }
        });

        $('#btnSearch').click(function(e){

            if($.trim($("#txtLabdipColorNo").val())=="" && $.trim($("#txtLabdipNo").val())=="" && !$('#chkDate').is(':checked')){
                alert("No searching criteria found to search."); return false;
            }

            var oLabDip = {
                Params:$.trim($("#txtLabdipNo").val()) +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+'~'+''+'~'+ $.trim($("#txtLabdipColorNo").val())+""+"~"
            };
            GetsLabdip(oLabDip, false) ;
        });

        function GetsLabdip() {
            var oLabDip = {
                Params:$.trim($("#txtLabdipNo").val()) +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+'~'+''+'~'+ $.trim($("#txtLabdipColorNo").val())+""+"~"
            };
            sessionStorage.removeItem("AdvSQL");
            sessionStorage.setItem("AdvSQL",oLabDip.Params);

            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oLabDip,
                ControllerName: "LabDip",
                ActionName: "Gets",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs != null) {
                    if (response.objs.length > 0) {

                        if(response.objs[0].LabDipID>0){
                            _oLabDips=response.objs;
                            DynamicRefreshList(response.objs, "tblLabDip");
                        }
                        else{DynamicRefreshList([], "tblLabDip"); alert(response.objs[0].ErrorMessage);}
                    }
                    else { DynamicRefreshList([], "tblLabDip"); alert("No labdip found."); }
                }
            });
        }
      
        function GetsLabdip(oLabDip, bIsAdvSearch) {

            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oLabDip,
                ControllerName: "LabDip",
                ActionName: "Gets",
                IsWinClose: false
            };
            sessionStorage.removeItem("AdvSQL");
            sessionStorage.setItem("AdvSQL",oLabDip.Params);

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs != null) {
                    if(bIsAdvSearch){
                        ResetAdvSearchPicker();
                        $("#winAdvanceSearch").icsWindow("close");
                    }
                    if (response.objs.length > 0) {
                        if(response.objs[0].LabDipID>0){
                            _oLabDips=response.objs;
                            DynamicRefreshList(response.objs, "tblLabDip");
                        }
                        else{DynamicRefreshList([], "tblLabDip"); alert(response.objs[0].ErrorMessage);}
                    }
                    else { DynamicRefreshList([], "tblLabDip"); alert("No labdip found."); }
                }
            });
        }

        function ResetAdvSearchPicker(){
            _sContractorIDs="";
            _sDeliveryToIDs="";
            _sMktPersonIDs="";
            _sOrderNos="";
            $('#txtMktPerson,#txtIssueTo,#txtDeliverTo').val("");

            $('#cboLabDipFormat').val(0);
            $('#cboLightSource').val(0);

        
            $('#chkIsOrderDateAdv').prop('checked',false);
            $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:true});
            $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox('setValue',icsdateformat(new Date()));

            $('#chkIsSeekingDateAdv').prop('checked',false);
            $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:true});
            $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox('setValue',icsdateformat(new Date()));

            $('#chkIsStatusDateAdv').prop('checked',false);
            $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:true});
            $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox('setValue',icsdateformat(new Date()));

        
            $('#tblOrderStatus').datagrid('uncheckAll');

        }

        $('#chkIsOrderDateAdv').click(function(e){
            if(!$('#chkIsOrderDateAdv').is(':checked')){
                $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:true});
            }
            else{
                $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:false});
            }
            $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox('setValue',icsdateformat(new Date()));
        });

        $('#chkIsSeekingDateAdv').click(function(e){
            if(!$('#chkIsSeekingDateAdv').is(':checked')){
                $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:true});
            }
            else{
                $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:false});
            }
            $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox('setValue',icsdateformat(new Date()));
        });

        $('#chkIsStatusDateAdv').click(function(e){
            if(!$('#chkIsStatusDateAdv').is(':checked')){
                $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:true});
            }
            else{
                $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:false});
            }
            $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox('setValue',icsdateformat(new Date()));
        });
   
        function GetOrderStatus(){

            var sOrderStatus="";

            var oOrderStatus=$('#tblOrderStatus').datagrid('getChecked');

            if(oOrderStatus.length>0){
                for(var i=0;i<oOrderStatus.length;i++){
                    sOrderStatus= sOrderStatus + oOrderStatus[i].Value+","
                }
                sOrderStatus=sOrderStatus.substring(0,sOrderStatus.length-1);
            }
            return sOrderStatus;
        }

        $("#btnAdvSearch").click(function (e) {
            ResetAdvSearchPicker();
            $("#winAdvanceSearch").icsWindow("open", "Adv Search");
        });

        $("#btnSearchOk").click(function (e) {

            var sOrderStatus=GetOrderStatus();

            if(_sOrderNos=="" &&_sContractorIDs =="" && _sDeliveryToIDs=="" && _sMktPersonIDs=="" && $('#cboLabDipFormat').val()<=0 && $('#cboLightSource').val()<=0 && !$('#chkIsOrderDateAdv').is(':checked') && !$('#chkIsSeekingDateAdv').is(':checked') && !$('#chkIsStatusDateAdv').is(':checked') && sOrderStatus=="" ){
                alert("No searching criteria found to search.");
                return false;
            }
        

            var oLabDip={
                Params: ""+'~'+_sContractorIDs +'~'+ _sDeliveryToIDs +'~'+ _sMktPersonIDs +'~'+$('#cboLabDipFormat').val()+'~'+$('#cboLightSource').val() +'~'+$('#dtOrderDateFromAdv').datebox('getValue')+'~'+$('#dtOrderDateToAdv').datebox('getValue') +'~'+ $('#chkIsOrderDateAdv').is(':checked')+'~'+$('#dtSeekingDateFromAdv').datebox('getValue')+'~'+$('#dtSeekingDateToAdv').datebox('getValue')+'~'+ $('#chkIsSeekingDateAdv').is(':checked')+'~'+$('#dtStatusDateFromAdv').datebox('getValue')+'~'+$('#dtStatusDateToAdv').datebox('getValue')+'~'+ $('#chkIsStatusDateAdv').is(':checked')+'~'+sOrderStatus+'~'+''+'~'+_sOrderNos+''
            };

            GetsLabdip(oLabDip,true);
        });

        $("#btnSearchClose").click(function (e) {
            $("#winAdvanceSearch").icsWindow("close");
        });

        ///Pick DO
        $("#btnResetOrderNo").click(function () {

            $("#txtMktPerson").val("");
            _sOrderNos="";
        });

        $("#btnPickOrderNo").click(function () {

            var sName=$.trim($("#txtOrderNo").val());
            var oDyeingOrder = {
                OrderNo:sName,
                ContractorName:_sContractorIDs,
                DeliveryToName:_sDeliveryToIDs,
                MKTPName:_sMktPersonIDs
            };
            GetsDyeingOrder(oDyeingOrder);
        });

        $("#txtOrderNo").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sName=$.trim($("#txtOrderNo").val());
                var oDyeingOrder = {
                    OrderNo:sName,
                    ContractorName:_sContractorIDs,
                    DeliveryToName:_sDeliveryToIDs,
                    MKTPName:_sMktPersonIDs
                };
                GetsDyeingOrder(oDyeingOrder);
            }
            else if(nkeyCode==8){
                $("#txtOrderNo").val("");
                _sOrderNos="";
            }
        });
    
        function GetsDyeingOrder(oDyeingOrder){

        
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oDyeingOrder,
                ControllerName: "LabDip",
                ActionName: "GetsDO",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].DyeingOrderID > 0) {
                        debugger;
                        var tblColums = [];
                        var oColumn = { field: "OrderNoFull", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "OrderDateSt", title: "OrderDate", width: 70, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "ContractorName", title: "Issue To", width: 160, align: "left" };tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winDyeingOrderPicker',
                            winclass:'clsDyeingOrderPicker',
                            winwidth: 460,
                            winheight: 460,
                            tableid: 'tblDyeingOrderPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName:'OrderNoFull',
                            windowTittle: 'Order List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No marketing person found.");
                }
            });


        }
        ////

        $("#btnResetMktPerson").click(function () {

            $("#txtMktPerson").val("");
            _sMktPersonIDs="";
        });

        $("#btnPickMktPerson").click(function () {

            var sName=$.trim($("#txtMktPerson").val());
            GetMktPersons(sName);
        });

        $("#txtMktPerson").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sName=$.trim($("#txtMktPerson").val());
                GetMktPersons(sName);
            }
            else if(nkeyCode==8){
                $("#txtMktPerson").val("");
                _sMktPersonIDs="";
            }
        });

        function GetMktPersons(sName){

            var MarketingAccount_BU = {
                BUID:_nBUID,
                Name:sName
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: MarketingAccount_BU,
                ControllerName: "MarketingAccount",
                ActionName: "MarketingAccountSearchByName",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].MarketingAccountID > 0) {
                        debugger;
                        var tblColums = [];
                        var oColumn = { field: "MarketingAccountID", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "Name", title: "Name", width: 180, align: "left" };tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winMktPersonPicker',
                            winclass:'clsMktPersonPicker',
                            winwidth: 460,
                            winheight: 460,
                            tableid: 'tblMktPersonPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName:'Name',
                            windowTittle: 'MKT Person List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No marketing person found.");
                }
            });


        }
        function IntializePickerbutton(oPickerobj) {
            $("#" + oPickerobj.winid).find("#btnOk").click(function () {
                SetPickerValueAssign(oPickerobj);
            });
            $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
                if (e.which === 13) {
                    SetPickerValueAssign(oPickerobj);
                }
            });
        }

        function SetPickerValueAssign(oPickerobj) {
            var oreturnObj = null, oreturnObjs = [];
            if (oPickerobj.multiplereturn) {
                oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
            } else {
                oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
            }

            if (oPickerobj.winid == 'winDyeingOrderPicker')
            {
                if (oreturnObjs != null && oreturnObjs.length> 0)
                {
                    _sOrderNos=''; var sMessage='';
                    sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Order(s) Selected" : oreturnObjs[0].OrderNoFull;
                 
                    $('#txtOrderNo').val(sMessage);
                    $("#txtOrderNo").addClass("fontColorOfPickItem");

                    for(var i=0;i<oreturnObjs.length;i++){
                        _sOrderNos=_sOrderNos+oreturnObjs[i].DyeingOrderID+',';
                    }
                    _sOrderNos=_sOrderNos.substring(0,_sOrderNos.length-1);
                }
                else
                {
                    alert("Please select a order(s).");
                    return false;
                }
            }

            else if (oPickerobj.winid == 'winMktPersonPicker') {
                if (oreturnObjs != null && oreturnObjs.length> 0)
                {
                    _sMktPersonIDs='';
                    var sMessage='';
                    sMessage=(oreturnObjs.length>1)? oreturnObjs.length +"MKT(s) Selected" : oreturnObjs[0].Name;
                    $('#txtMktPerson').val(sMessage);
                    $("#txtMktPerson").addClass("fontColorOfPickItem");

                    for(var i=0;i<oreturnObjs.length;i++){
                        _sMktPersonIDs=_sMktPersonIDs+oreturnObjs[i].MarketingAccountID+',';
                    }
                    _sMktPersonIDs=_sMktPersonIDs.substring(0,_sMktPersonIDs.length-1);



                }
                else
                {
                    alert("Please select a buyer.");
                    return false;
                }
            }
      
            $("#" + oPickerobj.winid).icsWindow("close");
            $("#" + oPickerobj.winid).remove();
        }

        $("#btnResetIssueTo").click(function () {
            $("#txtIssueTo").val("");
            _sContractorIDs="";
        });

        $("#btnPickIssueTo").click(function () {

            var sContractorName=$.trim($("#txtIssueTo").val());
            GetContractors(sContractorName, true);
        });

        $("#txtIssueTo").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sContractorName=$.trim($("#txtIssueTo").val());
                GetContractors(sContractorName,true);
            }
            else if(nkeyCode==8){
                $("#txtIssueTo").val("");
                _sContractorIDs=0;
            }
        });

        $("#btnResetDeliverTo").click(function () {
            $("#txtDeliverTo").val("");
            _sDeliveryToIDs="";
        });

        $("#btnPickDeliverTo").click(function () {
            var sContractorName=$.trim($("#txtDeliverTo").val());
            GetContractors(sContractorName, false);
        });

        $("#txtDeliverTo").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sContractorName=$.trim($("#txtDeliverTo").val());
                GetContractors(sContractorName,false);
            }
            else if(nkeyCode==8){
                $("#txtDeliverTo").val("");
                _sDeliveryToIDs="";
            
            }
        });


        function GetContractors(sContractorName, bIsIssueTo){

            var oContractor = {
                Params: '2,3' +'~'+sContractorName,
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        debugger;
                        var tblColums = [];
                        var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                        oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                        oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winContractorPicker',
                            winclass:'clsContractorPicker',
                            winwidth: 460,
                            winheight: 460,
                            tableid: 'tblContractorPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName:'Name',
                            windowTittle: 'Contractor List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializeContractorPickerbutton(oPickerParam, bIsIssueTo);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No contractor found.");
                }
            });


        }

        function IntializeContractorPickerbutton(oPickerobj, bIsIssueTo)
        {
            $("#" + oPickerobj.winid).find("#btnOk").click(function () {
                ContractorSelect(oPickerobj, bIsIssueTo);
            });
            $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
                if (e.which == 13)//enter=13
                {
                    ContractorSelect(oPickerobj, bIsIssueTo);
                }
            });
        }

        function ContractorSelect(oPickerobj, bIsIssueTo){
            debugger;
            var oContractors = $('#'+oPickerobj.tableid).datagrid('getChecked');
            if (oPickerobj.winid == 'winContractorPicker')
            {
                if(oContractors.length>0  && oContractors[0].ContractorID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();

                    var sContractorIds='', sMessage=''; 
                    sMessage=(oContractors.length>1)? oContractors.length +" Contractors Selected" : oContractors[0].Name;
                    for(var i=0;i<oContractors.length;i++){
                        sContractorIds=sContractorIds+oContractors[i].ContractorID+',';
                    }
                    sContractorIds=sContractorIds.substring(0,sContractorIds.length-1);

                    if(bIsIssueTo){

                        $('#txtIssueTo').val(sMessage);
                        _sContractorIDs=sContractorIds;
                    
                    }
                    else{
                        $('#txtDeliverTo').val(sMessage);
                        _sDeliveryToIDs= sContractorIds;
                    }
                }
                else{
                    alert("Please select an item.");
                }
            }
        }


        /*------------------------------------*/


        $('#btnAddColor').click(function (e)
        {
            var oLabDip = $('#tblLabDip').datagrid('getSelected');
            if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

            var nIndex=$('#tblLabDip').datagrid('getRowIndex',oLabDip);

            sessionStorage.clear();
            sessionStorage.setItem("Operation", "New");
            sessionStorage.setItem("SelectedRowIndex", nIndex);
            sessionStorage.setItem("LapdipHeader", "View Production");
            sessionStorage.setItem("Labdips", JSON.stringify($('#tblLabDip').datagrid('getRows')));
            sessionStorage.setItem("BackLink", _nBUID);
            sessionStorage.setItem("BackLink", window.location.href);
            var tsv=((new Date()).getTime())/1000;
            window.location.href = _sBaseAddress+ "/LabDip/ViewLabDipInLaboratory?nId="+oLabDip.LabDipID+"&buid="+_nBUID;
        });

        $('#btnView').click(function (e)
        {
            var oLabDip = $('#tblLabDip').datagrid('getSelected');
            if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

            var nIndex=$('#tblLabDip').datagrid('getRowIndex',oLabDip);

            sessionStorage.clear();
            sessionStorage.setItem("Operation", "View");
            sessionStorage.setItem("SelectedRowIndex", nIndex);
            sessionStorage.setItem("LapdipHeader", "View Production");
            sessionStorage.setItem("Labdips", JSON.stringify($('#tblLabDip').datagrid('getRows')));
            sessionStorage.setItem("BackLink", _nBUID);
            sessionStorage.setItem("BackLink", window.location.href);
            var tsv=((new Date()).getTime())/1000;
            window.location.href = _sBaseAddress+ "/LabDip/ViewLabDipInLaboratory?nId="+oLabDip.LabDipID+"&buid="+_nBUID;
        });
        

        /*----------Order Status Change----------------*/

        $("#btnOrderStatus").click(function () {
            ChangeOrderState();
        });
       
        $("#btnUndo").click(function () {
            _nNextStatus=2; // Approved
            _sMessage="undo.";
            ChangeOrderState();
        });

        function ChangeOrderState(){
            var oLabDip = $('#tblLabDip').datagrid('getSelected');
            if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

            if(!confirm("Confirm to "+_sMessage)) return false;
            oLabDip.Params=_nNextStatus;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oLabDip,
                ObjectId: oLabDip.LabDipID,
                ControllerName: "LabDip",
                ActionName: "ChangeOrderStatus",
                TableId: "tblLabDip",
                IsWinClose: false,
                Message: _sMessage.charAt(0).toUpperCase()+_sMessage.slice(1) +" Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    if (response.obj.LabDipID > 0) {
                        OperationPerforms(-1, response.obj);
                    }
                }
            });
        }

        /*----------CREATING CHALLAN----------*/
        $('#btnCreateChallan').click(function(e){

            var oLabDip = $('#tblLabDip').datagrid('getSelected');
            if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

            if(!confirm("Confirm to Create Challan?")) return;
           
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oLabDip,
                ObjectId: oLabDip.LabDipID,
                ControllerName: "LabdipChallan",
                ActionName: "CreateChallan",
                TableId: "tblLabDip",
                IsWinClose: false,
                Message: "Challan Created Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    if (response.obj.LabDipID > 0) {
                        OperationPerforms(-1, response.obj);
                    }
                }
            });
        });
    
    </script>
