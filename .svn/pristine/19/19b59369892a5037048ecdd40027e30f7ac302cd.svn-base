<html>
@{
    ViewBag.Title = "Job";
}
<body>
    @model ESimSol.BusinessObjects.Job
    <div class="menuMainCollectionTable" ng-app="JobApp" ng-controller="JobController as MLCC" id="divJob">
        <div style="font-family:Tahoma;text-align:center;height:90%;" class="regionCI">
            <fieldset>
                <legend>Basic Info :</legend>
                <div class="row col-md-12">

                    <div class="col-md-2 text-right">
                        <label class="control-label">Job No:</label>
                    </div>
                    <div class="col-md-2 text-left">
                        <input ng-model="Job.JobNo" class="form-control" disabled />
                    </div>
                    
                    <div class=" col-md-2 text-right"><label class="control-label">Issue Date:</label></div>
                    <div class="col-md-2 text-left">
                        <div class="input-group date date-container">
                            <input type="text" class="form-control" ng-model="Job.IssueDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                        </div>
                    </div>

                    <div class=" col-md-2 text-right"><label class="control-label">Style No:</label></div>
                    <div class="col-md-2">
                        <div style="width:100%">
                            <input style="width:78%;float:left;" ng-model="Job.StyleNo" placeholder="Type Name & Press Enter" ng-keydown="SearchKeyStyleNo($event)" required />                            
                            <button style="width:20%;float:right;height:23px;" type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PickStyleNo()"><span @*class="glyphicon glyphicon-ok"*@ aria-hidden="true"> ...</span></button>
                        </div>
                        
                        </div>

                </div>

                <div class="row col-md-12">

                    <div class="col-md-2 text-right">
                        <label class="control-label">Buyer:</label>
                    </div>
                    <div class="col-md-2 text-left">
                        <input ng-model="Job.BuyerName" class="form-control" disabled />
                    </div>

                    <div class="col-md-2 text-right">
                        <label class="control-label">Merchandiser:</label>
                    </div>
                    <div class="col-md-2 text-left">
                        <input ng-model="Job.MerchandiserName" class="form-control" disabled />
                    </div>
                    

                    <div class="col-md-2 text-right">
                        <label class="control-label">Session:</label>
                    </div>
                    <div class="col-md-2 text-left">
                        <input ng-model="Job.SessionName" class="form-control" disabled />
                    </div>

                </div>

                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">Remarks:</label></div>
                    <div class="col-md-10 text-left">
                        <input ng-model="Job.Remarks" class="form-control" />
                    </div>
                </div>

            </fieldset>
            <div class="ui-grid-top-panel" style="text-align:left;">
                <label>Order Recap:</label><input ng-model="txtOrderRecap" placeholder="Type Name & Press Enter" ng-keydown="SearchKeyOrderRecap($event)" style="width:150px; height:24px;" required />
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PickOrderRecap()"><span class="glyphicon glyphicon-ok" aria-hidden="true"> Pick</span></button>
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RemoveDetail()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RefreshDetail()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
            </div>
            <div style="width:99.5%; height:365px;" ui-grid="gridOptionsJobDetail" ui-grid-selection ui-grid-cellnav ui-grid-edit></div>
        </div>
        <fieldset style="height:10%">
            <legend>Action</legend>
            <div class="row col-md-12 text-right">
                <button type="button" id="btnApprove" class="btn btn-sm" aria-label="Left Align" ng-show="btnApprove" ng-click="Approve()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"> Approve</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-hide="btnSave" ng-click="Save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Save</span> </button>
                <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
            </div>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    .regionCI .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionCI .form-control {
        height: 26px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionCI .form-controlsm {
        height: 20px;
        padding: 0px 2px;
        text-align: right;
        width: 100%;
        font-size: 12px;
    }

    .regionCI .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 3px;
    }

    .regionCI .col-md-2 {
        width: 16.66%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionCI .col-md-10 {
        width: 83.34%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionCI .btn-sm {
        padding: 3px 10px;
    }

    .regionCI .input-group-addon {
        padding: 4px 8px;
    }
</style>
<script type="text/javascript">
    //debugger;
    var oJob =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oJobDetails= oJob.JobDetails;
    var JobApp = angular.module('JobApp', ['ngAnimate', 'ui.bootstrap','ui.grid', 'ui.grid.selection','ui.grid.edit', 'ms.service']);
    JobApp.controller('JobController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod,msGridControl) {
        debugger;
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });

        if(sessionStorage.getItem("JobHeader")=="Approve Job")
        {
            $scope.btnApprove = true;
            $scope.btnSave  = true;
        }
        $scope.JobDetails=oJobDetails;
        $scope.Job=oJob;

        var oDetailColumns = [];
        var oColumn ={ field: 'OrderRecapNo', name: 'OrderRecap No', width: '20%', cellClass: 'text-left',enableSorting: false ,enableCellEdit:false};oDetailColumns.push(oColumn);
        oColumn ={ field: 'ShipmentDateInString', name: 'Shipment Date', width: '20%',align:'left',cellClass: 'text-center', enableSorting: false ,enableCellEdit:false};oDetailColumns.push(oColumn);
        oColumn ={ field: 'ProductName', name: 'Product Name', width: '20%',cellClass: 'text-left', enableSorting: false ,enableCellEdit:false};oDetailColumns.push(oColumn);
        oColumn ={ field: 'DeptName', name: 'Dept. Name', width: '18%',cellClass: 'text-left', enableSorting: false ,enableCellEdit:false};oDetailColumns.push(oColumn);        
        oColumn ={ field: 'TotalQuantity', name: 'Quantity', width: '15%',cellClass: 'text-right',cellFilter: 'number: 0',enableSorting: false ,enableCellEdit:false};oDetailColumns.push(oColumn);
        ////Commercial invoice LC Detail
        $scope.gridOptionsJobDetail = {
            multiSelect: false,
            enableRowSelection: true,
            enableSelectAll: false,
            columnDefs:oDetailColumns,
            enableFullRowSelection:true,
            data:oJobDetails,
            onRegisterApi: function (gridApi) {
                $scope.gridDetailApi = gridApi;
            
            }
        };

        $scope.RefreshDetail = function ()
        {
            $scope.gridOptionsJobDetail.data =  $scope.gridOptionsJobDetail.data;
        };


        $scope.PickStyleNo=   function ()
        {
            debugger;
            var oStyle = {
                StyleNo: $.trim($scope.Job.StyleNo),
                BUID: $scope.Job.BUID
            };
            $.icsProgressBar(true);
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/TechnicalSheet/GetTechnicalSheetsByStyleNo',$.param(oStyle), config).then(
                        function (response)
                        {
                            $.icsProgressBar(false);
                            var oColumns = [];
                            var oColumn = { field: 'StyleNo', name: 'StyleNo',width: '25%'  };oColumns.push(oColumn);
                            oColumn = { field: 'BuyerName', name: 'Buyer Name',width: '25%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'MerchandiserName', name: 'Merchandiser Name',width: '25%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'SessionName', name: 'Session Name',width: '25%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Style List',
                                searchingbyfieldName:'StyleNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                console.log(result);
                                $scope.Job.StyleNo=result.StyleNo;
                                $scope.Job.BuyerName = result.BuyerName;
                                $scope.Job.MerchandiserName = result.MerchandiserName;
                                $scope.Job.SessionName=result.SessionName;
                                $scope.Job.TechnicalSheetID = result.TechnicalSheetID;
                                $scope.Job.BUID = result.BUID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyStyleNo = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtStyleNo = $scope.Job.StyleNo;
                if(txtStyleNo=="" || txtStyleNo==null)
                {
                    alert("Type Style No and Press Enter");
                    return;
                }
                $scope.PickStyleNo();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.Job.StyleNo='';
                $scope.TechnicalSheetID=0;
            }
        };

        $scope.PickOrderRecap=   function ()
        {
            if($scope.Job.TechnicalSheetID <= 0){
                alert("Please Enter Style No!");
                return;
            }
            var oOrderRecap = {
                OrderRecapNo: $.trim($scope.txtOrderRecap),
                TechnicalSheetID: $scope.Job.TechnicalSheetID
            };
            $.icsProgressBar(true);
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/OrderRecap/GetOrderRecapsByOrderRecapNo',$.param(oOrderRecap), config).then(
                        function (response)
                        {
                            $.icsProgressBar(false);
                            var oColumns = [];
                            var oColumn = { field: 'OrderRecapNo', name: 'Order RecapNo',width: '20%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ShipmentDateInString', name: 'Shipment Date',width: '20%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'TotalQuantity', name: 'Total Quantity',width: '20%', enableSorting: false  };oColumns.push(oColumn);

                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:true,
                                pickertitle:'OrderRecap List',
                                searchingbyfieldName:'OrderRecapNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                var oOrderRecaps= result;
                                debugger;
                                if(oOrderRecaps.length>0)
                                {
                                    var oPriviousDetails =  $scope.gridOptionsJobDetail.data;
                                    for(var i=0;i<oOrderRecaps.length;i++)
                                    {
                                        if(!ICS_IsExist(oPriviousDetails,'OrderRecapID', oOrderRecaps[i].OrderRecapID))
                                        {

                                            var oOJobDetail = {
                                                JobID:$scope.Job.JobID,
                                                JobDetailID:0,
                                                OrderRecapID:oOrderRecaps[i].OrderRecapID,
                                                OrderRecapNo:oOrderRecaps[i].OrderRecapNo,
                                                ShipmentDateInString:oOrderRecaps[i].ShipmentDateInString,      //new Date(oJob.IssueDateInString);
                                                ShipmentDate:oOrderRecaps[i].ShipmentDate,
                                                TotalQuantity:oOrderRecaps[i].TotalQuantity,
                                                ProductName:oOrderRecaps[i].ProductName,
                                                DeptName:oOrderRecaps[i].DeptName
                                            };
                                            $scope.gridOptionsJobDetail.data.push(oOJobDetail);
                                        }
                                    }
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyOrderRecap = function (e) {
            //debugger;
            if($scope.Job.TechnicalSheetID <= 0){
                alert("Please Enter Style No!");
                return;
            }
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtOrderRecap = $.trim($scope.txtOrderRecap);
                if(txtOrderRecap=="" || txtOrderRecap==null)
                {
                    alert("Type Order No and Press Enter");
                    return;
                }
                $scope.PickOrderRecap();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtOrderRecap='';
                $scope.OrderRecapID=0;
            }
        };

        
        $scope.RemoveDetail = function ()
        {
            debugger;
            var oJobetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oJobetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptionsJobDetail.data.indexOf(oJobetail);
            if (!confirm("Confirm to Delete?")) return ;
            $scope.gridOptionsJobDetail.data.splice(SelectedRowIndex,1);
            //$scope.SetTotal();
        };

        $scope.AddDetail =  function()
        {
            if($scope.ProductionSheetID<=0){alert("Please Pick Production Sheet.");return;}
            if($scope.ProductID<=0){alert("Please Pick Product.");return;}
            if($scope.UnitID<=0){alert("Please Select M. Unit.");return;}

            debugger;
            var oRCProcessDetail = {
                JobDetailID :0,
                JobID:$scope.Job.JobID,
                ProductID :$scope.ProductID,
                UnitID :$scope.UnitID,
                Qty :$scope.txtQty,
                ProductCode :$scope.ProductCode,
                ProductName :$scope.ProductName,
                Symbol :  $scope.MeasurementUnits.filter(function(obj){return obj.MeasurementUnitID== parseInt($scope.UnitID);})[0].Symbol

            };

            var oJobDetails = $scope.gridOptionsJobDetail.data;
            if(!icsMethod.ICS_IsExist(oJobDetails,'ProductID', oRCProcessDetail.ProductID))
            {
                $scope.gridOptionsJobDetail.data.push(oRCProcessDetail);
            }
            $scope.txtProductName='';
            $scope.ProductCode = '';
            $scope.ProductName = '';
            $scope.ProductID=0;
            $scope.MeasurementUnits = [];
        };

        $scope.Save = function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oJob= $scope.Job;
            oJob.IssueDate = new Date(oJob.IssueDateInString);
            oJob.JobDetails = $scope.gridOptionsJobDetail.data;
            $.icsProgressBar(true);
            $http.post(sessionStorage.getItem('BaseAddress')+'/Job/Save',oJob).then(
                        function (response)
                        {
                            $.icsProgressBar(false);
                            var oJob= jQuery.parseJSON(response.data);
                            if (oJob.ErrorMessage=="" || oJob.ErrorMessage==null)
                            {
                                alert("Data Save Successfully!!");
                               // userSession.setData("JobList",oJob);
                                var oJobs = sessionStorage.getItem("JobList");
                                var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                                if (oJobs != null) {
                                    oJobs = jQuery.parseJSON(oJobs);
                                }
                                else {
                                    oJobs = [];
                                }
                                if (nIndex != -1) {
                                    oJobs[nIndex] = oJob;
                                }
                                else {
                                    sessionStorage.setItem("SelectedRowIndex", oJobs.length);
                                    oJobs.push(oJob);
                                }
                                sessionStorage.setItem("JobList", JSON.stringify(oJobs));
                                window.location.href = sessionStorage.getItem("BackLink");
                            }
                            else
                            {
                                alert(oJob.ErrorMessage);
                            }

                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);$scope.MeasurementUnits=[];}
                    );

        };

        $scope.ValidateInput =  function ()
        {
            debugger;
            if($scope.Job.TechnicalSheetID==0)
            {
                alert('Please Select Style No');
                return false;
            }
            if($scope.gridOptionsJobDetail.data.length <=0){alert("Please Add Job Details");  return false;}
          
            return true;
        };

        if(sessionStorage.getItem("JobHeader")=="View Job")
        {
            $("#divJob :input").prop('disabled', true);
            $('#btnclose').prop('disabled', false);
        }
      

        $scope.Close=function ()
        {
            window.location.href = sessionStorage.getItem("BackLink");
        };
        $scope.Approve = function ()
        {
            if(!$scope.ValidateInput()) return;
            if (!confirm("Confirm to Approve?")) return ;
            var oJob= $scope.Job;
            $.icsProgressBar(true);
            $http.post(sessionStorage.getItem('BaseAddress')+'/Job/Approve',oJob).then(
                        function (response)
                        {
                            $.icsProgressBar(false);
                            var oJob= jQuery.parseJSON(response.data);
                            if (oJob.ErrorMessage=="" || oJob.ErrorMessage==null)
                            {
                                alert("Successfully Approved!!");
                                var oJobs = sessionStorage.getItem("JobList");
                                var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                                if (oJobs != null) {
                                    oJobs = jQuery.parseJSON(oJobs);
                                }
                                else {
                                    oJobs = [];
                                }
                                if (nIndex != -1) {
                                    oJobs[nIndex] = oJob;
                                }
                                else {
                                    sessionStorage.setItem("SelectedRowIndex", oJobs.length);
                                    oJobs.push(oJob);
                                }
                                sessionStorage.setItem("JobList", JSON.stringify(oJobs));
                                window.location.href = sessionStorage.getItem("BackLink");
                            }
                            else
                            {
                                alert(oJob.ErrorMessage);
                            }

                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);$scope.MeasurementUnits=[];}
                    );
        };
    });

</script>