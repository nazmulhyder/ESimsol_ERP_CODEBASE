@{
    ViewBag.Title = "FabricSizing Plan(s)";
}
@model IEnumerable<ESimSol.BusinessObjects.FNProductionPlan>

    <head>
        <title>Fabric Sizing Plan</title>
    </head>

    <body>
          
        <div class="menuMainCollectionTable">
            <table id="tblFNProductionPlan" title="FN Production Plan List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" data-options="resizable:true,checkOnSelect:false,selectOnCheck:false" toolbar="#toolbarFNProductionPlan">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th field="StartTimeSt" width="12%">Start Date</th>
                        <th field="EndTimeSt" width="12%">Date</th>
                        <th field="FNMachineNameCode" width="12%">Sizing M/C</th>
                        <th field="ContractorName" width="18%">Customer</th>
                        <th field="Construction" width="10%">Construction</th>
                        <th field="ExeNo" width="10%">Dispo No</th>
                        <th field="FabricDesignName" width="10%">Design</th>
                        <th field="PlanStatusSt" data-options="formatter:cellFormatterColor" width="8%" align="left">Plan Status</th>
                        @*<th field="StatusSt" align="left">Status</th>
                        <th field="WarpColor" width="8%">WarpColor</th>
                        <th field="WeftColor" width="8%">WeftColor</th>
                        <th field="ReedNo" width="8%">ReedNo</th>
                        <th field="REEDWidth" formatter="formatPrice" width="10%" align="right">R.Width</th>*@
                        <th field="Qty" formatter="formatPrice" width="10%" align="right">Warp Length</th>
                        @*<th field="SzingBeam" width="10%">Sizing Beam</th>
                        <th field="WarpBeam" width="10%">Warp Beam</th>
                        <th field="BeamName" width="10%" align="right">Beam Name</th>
                        <th field="LF" width="10%" align="right">L/F</th>*@

                    </tr>
                </thead>

            </table>>

            <div id="toolbarFNProductionPlan">
                @*<a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" id="btnReload"></a>*@
                <input type="text" id="txtSearchByDispoNo" placeholder="Search by Dispo No" style="width:100px;text-align:left" />
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnCut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cut" plain="true">Cut</a>
                <a id="btnPast" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-paste" plain="true">Paste</a>
                <a id="btnSwap" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-redo" plain="true">Swap</a>
                &nbsp;<label id="lblIsPending">Is Pending: </label><input type="checkbox" id="chkIsPendingFSP" />
                @*<a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                <a id="btnExcel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">XL</a>*@

                Print Type: <select id="cboPrintType" style="width:100px">
                                <option value="0">None</option>
                                <option value="1">Treatment Wise</option>
                                <option value="2">Machine Wise</option>
                </select>
                <a id="btnPrintPDF" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>

                
                @*<a id="btnPrintChemicalPlan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print Chemical Plan</a>*@
            </div>
        </div>
        <div id="winDUFNProductionPlan" style="width:800px;height:370px" class="easyui-window winstyle" title="Schedule Informations" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="padding-left:0px; padding-right:0px; padding-top:2px;">
                <fieldset>
                    <legend>Order Info:</legend>
                    <div>
                        <table cellpadding="1" cellspacing="1" style="font-size: 12px;width: 100%">
                            <tr>
                                <td style="width:15%;text-align:right;">
                                    Dispo No:
                                </td>
                                <td style="width:35%;text-align:left;">
                                    <input id="txtOrderNo" class="reset-text" placeholder="Search by Dispo No" style="width:70%" />
                                    <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                </td>
                                <td style="width:15%;text-align:right;">
                                    Buyer Name:
                                </td>
                                <td style="padding-left: 2px;width:35%;text-align:left">
                                    <input id="txtBuyerName" type="text" style="width:100%"  disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:15%;text-align:right;">
                                    Construction:
                                </td>
                                <td style="width:35%;text-align:left;">
                                    <input id="txtConstruction" class="reset-text" placeholder="Construction" style="width:100%" disabled="disabled" />
                                </td>
                                <td style="width:15%;text-align:right;">
                                    SC Date:
                                </td>
                                <td style="padding-left: 2px;width:35%;text-align:left">
                                    <input id="txtSCDate" class="reset-text" style="width:100%" disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:15%;text-align:right;">
                                    Design:
                                </td>
                                <td style="width:35%;text-align:left;">
                                    <input id="txtDesign" class="reset-text" style="width:100%" disabled="disabled" />
                                </td>
                                <td style="width:15%;text-align:right;">
                                    Treatment:
                                </td>
                                <td style="padding-left: 2px;width:35%;text-align:left">
                                    <select id="cboTreatment" style="width:100%;height:22px;"></select>
                                </td>
                            </tr>
                        </table>
                    </div>
                </fieldset>
            </div>
            <div>
                <fieldset>
                    <legend>Schedule Info:</legend>
                    <div>
                        <table cellpadding="1" cellspacing="1" style="font-size: 12px;width: 100%">
                            <tr>
                                <td style="width:5%;text-align:right;"></td>
                                <td style="width:10%;text-align:right;">
                                    Machine:
                                </td>
                                <td style="padding-left: 0px;width:30%;text-align:left">
                                    <input id="txtMachine" style="width: 60% ; font-size: 11px;" placeholder="Search Machine" />
                                    <a id="btnPickMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                    <a id="btnResetMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                </td>
                                <td colspan="2" style="padding-right: 2px;width:50%;text-align:right;">
                                    <div style="float: right; width:100%;">

                                        <span>
                                            <input type="button" id="btnScheduleLastTime" value="Default Time" style="font-size: 11px;
                                            height: 23px; width: 80px;" />
                                        </span><span>
                                            <input type="button" id="btnCurrenttime" value="Current Time" style="font-size: 11px;
                                            height: 23px; width: 80px;" />
                                        </span><span>
                                            <input id="tptimeSpinner" class="easyui-timespinner" style="width: 75px; height:20px; font-size: 11px;" required="required"
                                                   data-options="showSeconds:false" />
                                        </span>
                                        <span>
                                            <input type="button" id="btnAddSpinnerTime" value="Add" style="font-size: 11px;
                                            height: 23px; width: 30px;" />
                                        </span>
                                    </div>
                                </td>
                                <td style="width:5%;text-align:right;"></td>
                            </tr>
                            <tr>
                                <td style="width:5%;text-align:right;"></td>
                                <td style="width:10%;text-align:right;">
                                    Start Time:
                                </td>
                                <td style="width:30%;">
                                    @*<input id="txtStartDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                    <input id="txtStartDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                </td>

                                <td style="width:20%;text-align:right;">
                                    End Time:
                                </td>
                                <td style="padding-left: 2px;width:30%;">
                                    @*<input id="txtEndDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                    <input id="txtEndDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                </td>

                                <td style="width:5%;text-align:right;"></td>
                            </tr>

                        </table>

                    </div>
                </fieldset>
                <fieldset>
                    <legend>Production Info:</legend>
                    <div>
                        <table style="font-size: 12px;width: 100%">
                            <tr>
                                <td style="text-align:right;width:10%;">
                                    <label>Qty :</label>
                                </td>
                                <td style="text-align:left;width:40%;">
                                    <input id="txtQty" style="width:90%" type="text" class="number" />(M)
                                </td>
                                <td style="width:10%;text-align:right;">
                                    <label class="control-label">Qty(Y):</label>
                                </td>
                                <td style="text-align:left;width:40%;">
                                    <input id="txtYardQty" type="text" style="width:90%" class="number" disabled />(Y)
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%;text-align:right;">
                                    <label>Remarks:</label>
                                </td>
                                <td colspan="3" style="width:90%;">
                                    <input id="txtNote" class="reset-text" style="width:99%;" placeholder="Remarks.." />
                                </td>
                            </tr>
                            

                        </table>

                    </div>
                </fieldset>
            </div>
           
            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                    <tr>
                        <td style="width:70%;text-align:left;">
                            @*<a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                            <a id="btnSaveRS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;">Dyeing Card</a>
                            <a id="btnCut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cut" plain="true" style=" height:22px;">Cut</a>
                            <a id="btnPaste1" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-paste" plain="true" style=" height:22px;">Paste</a>*@
                            <label id="lblPriority">Priority:</label>
                            <select id="cboPriority" style="width:15%;">
                                <option value="0">--Select One--</option>
                                <option value="5">Top Urgent</option>
                                <option value="4">Urgent</option>
                                <option value="6">Loom Program</option>
                                @*<option value="3">High</option>
                                <option value="2">Medium</option>
                                <option value="1">Low</option>*@
                            </select>
                            <label id="lblPlanStatus">Plan Status:</label>
                            <select style="width:15%" id="cboPlanStatus"></select>
                            @*<label id="lblWaterQty">Water Qty:</label>
                            <input type="number" id="txtWaterQty" class="number" value="0" style="width:60px;" />*@
                            <a id="btnUpdatePlanStatus" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" style=" height:22px;">Update</a>
                        </td>
                        <td style="width:30%;text-align:right;">
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;" onclick="Save(false)">Save</a>
                            <a id="btnClosePS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
        <div id="winAdvSearch" class="easyui-window winClass" style=" width:500px;" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%;">
                <tr>
                    <td>
                        <fieldset style="margin-bottom: 0px;">
                            <legend>Searching Criteria</legend>
                            <table>

                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Plan Date : </label>
                                    </td>
                                    <td colspan="3">
                                        <select id="cboDateAdvS" style="width:30%;height:22px;" onchange="DateActionsDateAdvSearch(); "></select>
                                        <input id="txtFromDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="txtToDateAdvSearch" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Dispo No : </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <input id="txtExeNo" type="text" style="width:93%" />
                                    </td>
                                </tr>                 
                                <tr>
                                    <td style="width:20%;text-align:right;">
                                        <label>Construction : </label>
                                    </td>
                                    <td colspan="3" style=" width:80%;text-align:left;">
                                        <input id="txtConstructions" type="text" style="width:93%" />
                                    </td>
                                </tr>

                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Machine : </label>
                                    </td>
                                    <td colspan="3" style=" width:80%;text-align:left;">
                                        <input id="txtMachineName" style="width:78%;" type="text" placeholder="Type Machine Name & Press Enter" />
                                        <a id="btnMachinePiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnClrMachinePiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                    </td>
                                </tr>

                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Customer : </label>
                                    </td>
                                    <td colspan="3" style=" width:80%;text-align:left;">
                                        <input id="txtCustomerName" style="width:78%;" type="text" placeholder="Type Customer Name & Press Enter" />
                                        <a id="btnCustomerPiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnClrCustomerPiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                    </td>
                                </tr>                    
                                <tr>
                                    <td style="width:20%;text-align:right;">
                                        <label>Plan Status : </label>
                                    </td>
                                    <td colspan="3" style=" width:80%;text-align:left;">
                                        <select id="cboPlanStatusAdv" style="width:93%;height:22px;"></select>
                                    </td>
                                </tr>
                                @*<tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Pending : </label>
                                    </td>
                                    <td colspan="3" style="width:80%;text-align:left;">
                                        <input type="checkbox" id="chkIsPending"  />
                                    </td>
                                </tr>*@
                                <tr>
                                    <td height="5px" colspan="4"></td>
                                </tr>
                                @*<tr>
                                    <td class="btnResetSearch" colspan="4">
                                        <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                                        <a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                                    </td>
                                </tr>*@
                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
                @*<a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>*@
                <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>

        
    </body>


    <script type="text/javascript">
    var _sBaseAddress="";
    var _oFNProductionPlans=[];
    var _oAuthorizationRolesMapping=[];
    var _sMessage='';
    var _nNextStatus=-1;
    var _sMenuID=0;
    var _nContractorIDs="";
    var _sMenuID=0;
    var _nBUID = 0;
    var _sContractorIds = '';
    var _sProductIds = '';
    var _sDeliverToIDs = '';
    var _oIsAdd=false;
    var _oFNProductionPlan={};
    var _nSelectedRowIndex=0;
    var _nTreatmentProcess=0;
    $(document).ready(function () {
        _oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFNProductionPlans =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sMenuID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _nTreatmentProcess = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.TreatmentProcess));
        _oCompareOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        var oFNTreatments = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNTreatments));
        var oPlanStatusList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PlanStatusList));
        debugger;
        //RefreshControlLayout();
        DynamicRefreshList(_oFNProductionPlans, 'tblFNProductionPlan');
        $("#cboPlanStatus").icsLoadCombo({ List: oPlanStatusList, OptionValue: "id", DisplayText: "Value" });
        $("#cboTreatment").icsLoadCombo({List: oFNTreatments, OptionValue: "id", DisplayText: "Value"});
        $("#cboTreatment").val(_nTreatmentProcess);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $(".lblLoadingMessage").hide();
        sessionStorage.setItem("ParamsSO", "");

        //adv search

        $("#cboPlanStatusAdv").icsLoadCombo({ List: oPlanStatusList, OptionValue: "id", DisplayText: "Value" ,InitialValue:"Initialize"  });
        $("#winAdvSearch").data("MachineIDs","");
        $("#winAdvSearch").data("CustomerIDs","");
        $('#btnPast').hide();
        document.getElementById("chkIsPendingFSP").checked = true;
    });

    function cellFormatterColor(value,row,index) {
        //debugger;
        if(row.PlanStatus == 1)
            return "<table style='width:100%;background-color:#0EF622;'><tr><td style='border: 0px'>" + row.PlanStatusSt  + "</td></tr></table>";
        else if(row.PlanStatus == 2)
            return "<table style='width:100%;background-color:#EE7CC8;'><tr><td style='border: 0px'>" + row.PlanStatusSt  + "</td></tr></table>";
        else return row.PlanStatusSt;
    }

    function ConvertIntoYards()
    {
        var nQtyInMeter= $('#txtQty').numberbox('getValue');
        var nQtyInYards= nQtyInMeter*1.09361;
        $('#txtYardQty').numberbox('setValue',nQtyInYards.toFixed(2));
    }

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winFNProductionPlanOrder').icsWindow('close'); } });


    $('#tblFNProductionPlan').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData)
    {
        if (rowData != null && rowData.FNPPID > 0)
        {
            if (rowData.OrderStatus==1 )  //Initialized = 1,
            {

            }
            //$('#btnCancel,#btnUndo,#btnAdd,#btnEdit,#btnDelete').hide();
            ////if (rowData.OrderStatus==1 )  //Initialized = 1,
            ////{
            //$('#btnAdd,#btnEdit,#btnDelete,#btnOrderStatus').show();
            //_nNextStatus=2;
            //_sMessage="send an approval request.";
            //$('#lblOrderStatus').text(' Approve');
        }
    }

    /*------------------------------------*/

    function ResetDiv(){
        $('#tpStartTime').timespinner('setValue', "");
        $('#txtStartDate').datebox('setValue', "");
        $('#tpEndTime').timespinner('setValue', "");
        $('#txtEndDate').datebox('setValue', "");
        $("#txtMachine").val("");
        $('#txtQty').numberbox({onChange:ConvertIntoYards,min:0, precision:2 });
        $('#txtYardQty').numberbox({min:0, precision:2 });
        $('#txtQty').numberbox('setValue',0);
        $('#txtYardQty').numberbox('setValue',0);
        $("#txtNote").val("");
        $("#cboPlanStatus").val(0);

        $("#txtOrderNo").val("");
        $("#txtBuyerName").val("");
        $("#txtConstruction").val("");
        $("#txtSCDate").val("");
        $("#txtDesign").val("");
    }

    $("#btnAdd").click(function(){

        ////  alert("index="+sPSID);
        //if (nObjectID == null || nObjectID <= 0) {
        //    alert("Please select a item from list!");
        //    return;
        //}
        ResetDiv();
        _oIsAdd=true;
        _oFNProductionPlan = { ErrorMessage: "", FNPPID: 0, FNMachineID: 0 };

        //$.ajax({
        //    type: "POST",
        //    url: _sBaseAddress + "/FNProductionPlan/GetPS",
        //    traditional: true,
        //    data: JSON.stringify(_oFNProductionPlan),
        //    contentType: "application/json; charset=utf-8",
        //    success: function (data) {
        //        debugger;
        //        _oFNProductionPlan = { ErrorMessage: "", FNPPID: 0, FNMachineID: 0 };
        //        var oFNProductionPlan = jQuery.parseJSON(data);
        //        DynamicRefreshList([], "tblFSPDetail");
        //        RefreshControl(oFNProductionPlan);

        //        $("#winDUFNProductionPlan").icsWindow("open", "Schedule Entry");
        //        $("#cboPlanStatus").hide();
        //        $("#btnUpdatePlanStatus").hide();
        //        $("#lblPlanStatus").hide();
        //        //$("#lblWaterQty").hide();
        //        //$("#txtWaterQty").hide();
        //    }
        //});
        $("#lblPriority").hide();
        $("#cboPriority").hide();
        $("#cboPlanStatus").hide();
        $("#btnUpdatePlanStatus").hide();
        $("#lblPlanStatus").hide();

        $("#winDUFNProductionPlan").icsWindow("open", "Production Plan Entry");
    });

    $('#btnEdit').click(function (e)
    {
        _oIsAdd=false;
        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }
        var nIndex=$('#tblFNProductionPlan').datagrid('getRowIndex',oFNProductionPlan);
        _nSelectedRowIndex=nIndex;
        $.ajax({
            type: "POST",
            url: _sBaseAddress + "/FNProductionPlan/GetFNP",
            traditional: true,
            data: JSON.stringify(oFNProductionPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                oFNProductionPlan = jQuery.parseJSON(data);
                RefreshControl(oFNProductionPlan);
                $("#lblPriority").hide();
                $("#cboPriority").hide();
                $("#cboPlanStatus").show();
                $("#btnUpdatePlanStatus").show();
                $("#lblPlanStatus").show();
                $("#winDUFNProductionPlan").icsWindow("open", "Production Plan Entry");
            }
        });

    });

  

    function RefreshControl(oFNProductionPlan)
    {
        debugger;
        //_oFNProductionPlan.FSCDID=oFNProductionPlan.FabricSalesContractDetailID;
        _oFNProductionPlan=oFNProductionPlan;
        if(oFNProductionPlan.FNPPID>0)
        {
            $('#tpStartTime').timespinner('setValue', oFNProductionPlan.StartTimeTS);
            $('#txtStartDate').datebox('setValue', oFNProductionPlan.StartTimeSt);
            $('#tpEndTime').timespinner('setValue', oFNProductionPlan.EndTimeTS);
            $('#txtEndDate').datebox('setValue', oFNProductionPlan.EndTimeSt);
            $("#txtMachine").val(oFNProductionPlan.FNMachineNameCode);
            $('#txtQty').numberbox({onChange:ConvertIntoYards,min:0, precision:2 });
            $('#txtYardQty').numberbox({min:0, precision:2 });
            $('#txtQty').numberbox('setValue',oFNProductionPlan.Qty);
            $('#txtYardQty').numberbox('setValue',GetYard(oFNProductionPlan.Qty,2));
            $("#txtNote").val(oFNProductionPlan.Note);
            $("#cboPlanStatus").val(oFNProductionPlan.PlanStatus);
            //$("#cboPriority").val(oFNProductionPlan.Priority);
            $("#cboTreatment").val(oFNProductionPlan.FNTreatment);
        }
        
        $("#txtOrderNo").val(oFNProductionPlan.ExeNo);
        $("#txtBuyerName").val(oFNProductionPlan.ContractorName);
        $("#txtConstruction").val(oFNProductionPlan.Construction);
        $("#txtSCDate").val(oFNProductionPlan.SCDateSt);
        $("#txtDesign").val(oFNProductionPlan.FabricDesignName);
    }

    $("#btnCancel").click(function(){

        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblFNProductionPlan').datagrid('getRowIndex',oFNProductionPlan);
        sessionStorage.setItem("Operation", "Cancel");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("FNProductionPlanHeader", "Cancel Production");
        sessionStorage.setItem("FNProductionPlans", JSON.stringify($('#tblFNProductionPlan').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/FNProductionPlan/ViewFNProductionPlan?nId="+oFNProductionPlan.FNPPID+"&ts="+tsv;

    });
    $('#btnDelete').click(function(e){
        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }
        if (!confirm("Confirm to delete?")) return;
        sessionStorage.clear();
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNProductionPlan,
            ControllerName: "FNProductionPlan",
            ActionName: "Delete",
            TableId: "tblFNProductionPlan",
            IsWinClose: false
        };
        $.icsDelete(obj);

    });
    $("#btnDeleteDetail").click(function () {

        var oFNProductionPlanDetail = $("#tblFSPDetail").datagrid("getSelected");
        if (oFNProductionPlanDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblFSPDetail').datagrid('getRowIndex',oFNProductionPlanDetail);
        if (!confirm("Confirm to Delete?")) return false;

        if(oFNProductionPlanDetail.FSPDID<=0)
        {
            $("#tblFSPDetail").datagrid("deleteRow", nIndex);
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oFNProductionPlanDetail,
                         ControllerName: "FNProductionPlan",
                         ActionName: "DeleteDetail",
                         TableId: "tblFSPDetail",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
        }
        //RefreshSummary();
        editIndex = undefined;
    });
    $('#btnView').click(function (e)
    {
        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblFNProductionPlan').datagrid('getRowIndex',oFNProductionPlan);

        sessionStorage.clear();
        sessionStorage.setItem("Operation", "View");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("DOHeader", "View Order");
        sessionStorage.setItem("FNProductionPlans", JSON.stringify($('#tblFNProductionPlan').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/FNProductionPlan/ViewFNProductionPlan?nId="+oFNProductionPlan.FNPPID+"&ts="+tsv;;
    });

    $('#txtStartDate').datebox({
        onSelect: function(date){
            //alert(date.getFullYear()+":"+(date.getMonth()+1)+":"+date.getDate());
            debugger;
            var oDate = new Date(date);
            oDate.setHours(new Date().getHours());
            oDate.setMinutes(new Date().getMinutes());

            var nHour=oDate.getHours();
            var nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);

            oDate.setMinutes(oDate.getMinutes() + 10);
            $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
            nHour=oDate.getHours();
            nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpEndTime').timespinner('setValue', nHour+":"+nMin);
        }
    });

    $("#btnUpdatePlanStatus").click(function () {
        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select a valid item from list."); return ; }
        var nIndex=$('#tblFNProductionPlan').datagrid('getRowIndex',oFNProductionPlan);
        if(parseInt($("#cboPlanStatus").val()) <= 0) {alert("Please select a status!!"); return;}
        //if(oFNProductionPlan.Status > 1 && parseInt($("#cboPlanStatus").val()) == 2){
        //    alert("Hold is not possible, Because Batch status is "+oFNProductionPlan.StatusSt);
        //    return;
        //}
        oFNProductionPlan.PlanStatus = $("#cboPlanStatus").val();
        oFNProductionPlan.Priority = $("#cboPriority").val();
        //oFNProductionPlan.WaterQty = $("#txtWaterQty").val();

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FNProductionPlan/UpdatePlanStatus",
            traditional: true,
            data: JSON.stringify(oFNProductionPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFNProductionPlan = jQuery.parseJSON(data);
                if(oFNProductionPlan!=null)
                {
                    if(oFNProductionPlan.ErrorMessage=="" || oFNProductionPlan.ErrorMessage == null)
                    {
                        alert("Updated Successful");
                        $('#tblFNProductionPlan').datagrid('updateRow',{ index: nIndex, row: oFNProductionPlan });
                    }
                    else
                    {
                        alert(oFNProductionPlan.ErrorMessage);
                    }
                }
                else
                {
                    alert("Invalid Operation!");
                }

            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    //////////////
    $("#btnPickOrderNo").click(function ()
    {
        var oPSDetail = {
            ExeNo:$('#txtOrderNo').val(),
            //FNMachineID:_oFNProductionPlan.FNMachineID,

        };

        GetOrders(oPSDetail);
    });

    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNo").val());

            var oPSDetail = {
                ExeNo:$('#txtOrderNo').val(),
                //FNMachineID:_oFNProductionPlan.FNMachineID

            };
            GetOrders(oPSDetail);
        }
        else if(nkeyCode==8){
            _oFNProductionPlan.FabricWarpPlanID=0;
        }
    });
    $("#txtOrderNoTwo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNoTwo").val());

            if (sorderNo=="" ||sorderNo==null)
            {

                alert("Please Type Order no.");
                $('#txtOrderNoTwo').focus();
                $('#txtOrderNoTwo').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#txtOrderNoTwo').removeClass("errorFieldBorder");
            }

            var oPSDetail = {
                OrderType:0,
                OrderNo:$('#txtOrderNoTwo').val(),
                LabDipDetailID:0,
                DODID:0
            };
            GetOrdersTwo(oPSDetail);
        }
        else if(nkeyCode==8){

        }
    });

    $("#txtBatchNoTwo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtBatchNoTwo").val());

            if (sRouteSheetNo=="" ||sRouteSheetNo==null)
            {

                alert("Please Type Batch no.");
                $('#txtBatchNoTwo').focus();
                $('#txtBatchNoTwo').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#txtBatchNoTwo').removeClass("errorFieldBorder");
            }

            SearchDO("",sRouteSheetNo);
        }
        else if(nkeyCode==8){

        }
    });


    $("#btnResetOrderNo").click(function ()
    {
        $("#txtOrderNo").val("");
    });

    function GetOrders(oPSDetail)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "FNProductionPlan",
            ActionName: "GetsFNExODetails",
            IsWinClose: false
        };
        debugger;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FabricSalesContractDetailID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "SCNoFull", title: "PO No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ExeNo", title: "Dispo No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FabricNo", title: "Mkt. Ref ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorInfo", title: "Color Info ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 100, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 550,
                        winheight: 460,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ExeNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }
    function GetOrdersTwo(oPSDetail)
    {

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "FNProductionPlan",
            ActionName: "GetsFabricExecutionSpe",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FEOSID > 0) {
                    //debugger;
                    var tblColums = [];

                    var oColumn = { field: "ExeNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Customer", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Composition", title: "Composition ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Weave", title: "Design", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "RequiredWarpLength", title: "Required Warp Length", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPickerTwo',
                        winclass:'clsOrderPicker',
                        winwidth: 1000,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }
    $("#btnResetMachine").click(function () {

        $("#txtMachine").val("");
        _oFNProductionPlan.FNMachineID=0;
    });

    $("#btnPickMachine").click(function () {

        var sMachineName=$.trim($("#txtMachine").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachines(sMachineName);
    });

    $("#txtMachine").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachine").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachines(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachine").val("");
            _oFNProductionPlan.FNMachineID=0;
        }
    });
    function GetMachines(sMachineName){

        var oMachine = {
            //BUID:sessionStorage.getItem('BUID'),
            Name:sMachineName,
            Params:1
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "FNMachine",
            ActionName: "GetFNMachines",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FNMachineID > 0) {
                    //debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FNMachineTypeSt", title: "Type", width: 90, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FreeTime", title: "Free Time", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMachinePicker',
                        winclass:'clsMachinePicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });


    }

    ////
    $("#btnResetBeam").click(function () {

        $("#txtMachine").val("");
        //_oFNProductionPlan.FNMachineID=0;
    });

    $("#btnPickBeam").click(function () {

        var sMachineName=$.trim($("#txtBeam").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetBeams(sMachineName);
    });

    $("#txtBeam").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtBeam").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetBeams(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtBeam").val("");
            //_oFNProductionPlan.FNMachineID=0;
        }
    });
    function GetBeams(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem('BUID'),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "FNProductionPlan",
            ActionName: "GetBeams",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FNMachineID > 0) {
                    //debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "Capacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "SequenceNo", title: "SL No", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winBeamsPicker',
                        winclass:'clsBeamsPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblBeamsPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Beam List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Beam found.");
            }
        });


    }
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {
        //debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid == 'winLabDipPicker')
        {
            if (oreturnObj != null && oreturnObj.LabDipDetailID > 0)
            {
                $('#txtColorNo').val(oreturnObj.ColorNo);
                //$('#txtColorName').val(oreturnObj.ColorName);
                $('#txtLabdipNo').val(oreturnObj.LabdipNo);
                _nLabDipDetailID= oreturnObj.LabDipDetailID;
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winMachinePicker')
        {debugger;
            if(oreturnObj !=null  && oreturnObj.FNMachineID>0){

                $('#txtMachine').val(oreturnObj.Name);
                _oFNProductionPlan.FNMachineID= oreturnObj.FNMachineID;
                SetLastScheduleTime();
            }
            else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winMachinesPicker')
        {
            if(oreturnobjs.length > 0){
                if(oreturnobjs.length == 1){
                    $("#txtMachineName").val(oreturnobjs[0].Name);
                    $("#winAdvSearch").data("MachineIDs",oreturnobjs[0].FNMachineID);
                }else{
                    var ids = "";
                    for(var i=0;i<oreturnobjs.length;i++){
                        ids += oreturnobjs[i].FNMachineID + ",";
                    }
                    if(ids.length > 0) ids = ids.substring(0, ids.length-1);
                    $("#txtMachineName").val("You select " + oreturnobjs.length + " Machines");
                    $("#winAdvSearch").data("MachineIDs",ids);
                }
            }else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winCustomersPicker')
        {
            if(oreturnobjs.length > 0){
                if(oreturnobjs.length == 1){
                    $("#txtCustomerName").val(oreturnobjs[0].Name);
                    $("#winAdvSearch").data("CustomerIDs",oreturnobjs[0].ContractorID);
                }else{
                    var ids = "";
                    for(var i=0;i<oreturnobjs.length;i++){
                        ids += oreturnobjs[i].ContractorID + ",";
                    }
                    if(ids.length > 0) ids = ids.substring(0, ids.length-1);
                    $("#txtCustomerName").val("You select " + oreturnobjs.length + " Customers");
                    $("#winAdvSearch").data("CustomerIDs",ids);
                }
            }else{
                alert("Please select Customer.");
            }
        }
        else if (oPickerobj.winid == 'winBeamsPicker')
        {
            if(oreturnobjs !=null  && oreturnobjs.length>0){
                debugger;
                //endEditing();
                $('#txtBeam').val("");
                //_oFNProductionPlan.LotID= oreturnObj.LotID;
                //var  oDUPSLot={FNPPID:_oFNProductionPlan.FNPPID, FNProductionPlanDetailID:0, BeamName:0,BeamID:0,SizingBeamNo:0 };

                //$('#tblFSPDetail').datagrid('appendRow',oDUPSLot);


                for (i=0; i<oreturnobjs.length;i++)
                {
                    var  oFSPD={FNPPID:_oFNProductionPlan.FNPPID, FSPDID:0, BeamName:oreturnobjs[i].MachineCodeWithName ,BeamID:oreturnobjs[i].FNMachineID,SizingBeamNo:""};
                    var bExists= IsExist(oFSPD)
                    if(!bExists)
                    {
                        $('#tblFSPDetail').datagrid('appendRow', oFSPD);
                    }
                    else
                    {
                        alert("Already Exists");
                        return;
                    }

                }
            }
            else{
                alert("Please select Lot.");
            }
        }
        else if (oPickerobj.winid == 'winOrderPicker')
        {
            //debugger;
            if(oreturnObj !=null  && oreturnObj.FabricSalesContractDetailID>0)
            {
                oreturnObj.FSCDID=oreturnObj.FabricSalesContractDetailID;
                RefreshControl(oreturnObj);
            }

            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winOrderPickerTwo')
        {
            if (oreturnobjs != null && oreturnobjs.length> 0)
            {

                var sDODIDs=''; var sMessage='';
                sMessage=(oreturnobjs.length>1)? oreturnobjs.length +" Order(s) Selected" : oreturnobjs[0].OrderNo;
                $('#txtOrderNoTwo').val(sMessage);
                $("#txtOrderNoTwo").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnobjs.length;i++){
                    sDODIDs=sDODIDs+oreturnobjs[i].FEOSID+',';
                }
                sDODIDs=sDODIDs.substring(0,sDODIDs.length-1);
                SearchDO(sDODIDs,"");
            }
            else
            {
                alert("Please select a Order.");
                return false;
            }

        }
    }
    function IsExist(oFSPD)
    {
        var oDUDCD = $('#tblFSPDetail').datagrid('getRows');
        for (var i = 0; i < oDUDCD.length; i++) {
            if (parseInt(oDUDCD[i].BeamID) == parseInt(oFSPD.BeamID) )
            {
                return true;
            }
        }
        return false;
    }
    $("#btnClosePS").click(function () {
        $("#winDUFNProductionPlan").icsWindow("close");

    });
    $('#btnCurrenttime').click(function(e)
    {
        var oDate=new Date();
        oDate.setMinutes(oDate.getMinutes()+5);
        SetStartTime(oDate);
        AddTime(oDate);
    });

    function SetLastScheduleTime()
    {
        debugger;
        if(parseInt(_oFNProductionPlan.FNMachineID)>0 )
        {
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: _sBaseAddress + "/FNProductionPlan/GetPSByMachine",
                data: { nFMID: _oFNProductionPlan.FNMachineID ,  nts:nts },
                contentType: "application/json; charset=utf-8",
                success: function(data)
                {
                    ////debugger;
                    var sStratTime = jQuery.parseJSON(data);
                    if ($.trim(sStratTime)!='')
                    {
                        SetStartTime(new Date(sStratTime));
                        AddTime(new Date(sStratTime));
                    }
                    else
                    {
                        var oDate=new Date();
                        oDate.setMinutes(oDate.getMinutes()+5);
                        SetStartTime(oDate);
                        AddTime(oDate);
                    }
                },
                error: function(xhr, status, error)
                {
                    alert(error);
                }
            });
        }

    }

    $('#btnScheduleLastTime').click(function(e)
    {

        SetLastScheduleTime();
    });
    function SetStartTime(oDate)
    {
        //debugger;
        $('#txtStartDate').datebox('setValue', icsdateformat(oDate));
        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
        {
            nHour=0;
        }
        if(isNaN(nMin))
        {
            nMin=0;
        }
        $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);

    }

    function AddTimeToEndDate(sDate)
    {
        debugger;
        var oDate=new Date(sDate);
        var nhr = oDate.getHours();
        var nmin = oDate.getMinutes();
        $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        $('#tpEndTime').timespinner('setValue', nhr+":"+nmin);

    }

    function AddTime(sDate)
    {
        //debugger;//Previous Code
        //var nhr=$('#tpStartTime').timespinner('getHours');
        //var nmin=$('#tpStartTime').timespinner('getMinutes');
        //if(isNaN(nhr))
        //{
        //    nhr=0;
        //}
        //if(isNaN(nmin))
        //{
        //    nmin=0;
        //}
        //var oDate=new Date(sDate);
        //oDate.setHours(oDate.getHours()+nhr);
        //oDate.setMinutes(oDate.getMinutes()+nmin);
        //$('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        //var nHour=oDate.getHours();
        //var nMin=oDate.getMinutes();
        //if(isNaN(nHour))
        //{
        //    nHour=0;
        //}
        //if(isNaN(nMin))
        //{
        //    nMin=0;
        //}
        //$('#tpEndTime').timespinner('setValue', nHour+":"+nMin);

        //Add 10 mins from start date
        var oDate = new Date($('#txtStartDate').datebox('getValue'));
        oDate.setHours(new Date().getHours());
        oDate.setMinutes(new Date().getMinutes());

        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);

        oDate.setMinutes(oDate.getMinutes() + 10);
        $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        nHour=oDate.getHours();
        nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpEndTime').timespinner('setValue', nHour+":"+nMin);
    }

    function ValidationOfStartTime()
    {
        if(new Date($('#txtStartDate').datebox('getValue'))> new Date($('#txtEndDate').datebox('getValue'))){
            alert("Start time must be later than End time.");
            return false;
        }
        return true;
    }

    $('#btnAddSpinnerTime').click(function(e)
    {
        debugger;
        var dStartDate =$('#txtStartDate').datebox('getValue');

        var hOur=$('#tpStartTime').timespinner('getHours');
        var mIn=$('#tpStartTime').timespinner('getMinutes');
        var oStartDate=new Date(dStartDate);
        oStartDate.setHours(oStartDate.getHours()+hOur);
        oStartDate.setMinutes(oStartDate.getMinutes()+mIn);
        //oStartDate = icsdatetimeformat(oStartDate);

        var nhr=$('#tptimeSpinner').timespinner('getHours');
        var nmin=$('#tptimeSpinner').timespinner('getMinutes');
        if(isNaN(nhr))
        {
            nhr=0;
        }
        if(isNaN(nmin))
        {
            nmin=0;
        }
        var oDate=new Date(oStartDate);
        oDate.setHours(oDate.getHours()+nhr);
        oDate.setMinutes(oDate.getMinutes()+nmin);
        AddTimeToEndDate(oDate);
        if(!ValidationOfStartTime())return;
    });

    function RefreshObject()
    {
        debugger;
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var dEndtDate =$('#txtEndDate').datebox('getValue');
        var EndtTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndtTime.split(':');
        var hEndtTime= parseFloat(sTime[0]);
        var mEndtTime= parseFloat(sTime[1]);
        dEndtDate = new Date(dEndtDate);
        dEndtDate.setHours(hEndtTime);
        dEndtDate.setMinutes(mEndtTime);


        var oFNProductionPlan = {
            FNPPID     : (_oFNProductionPlan!=null && _oFNProductionPlan.FNPPID>0)? _oFNProductionPlan.FNPPID:0,
            FNMachineID            : _oFNProductionPlan.FNMachineID,
            FSCDID                 : _oFNProductionPlan.FSCDID,
            FNTreatment            : _nTreatmentProcess,
            StartTime	           : dStartDate,
            EndTime                : dEndtDate,
            Note                   : $("#txtNote").val(),
            Qty                    : $('#txtQty').val(),
            PlanStatus             : $('#cboPlanStatus').val()
            //Priority               : $("#cboPriority").val()
        };
        return oFNProductionPlan;
    }
    function Save(isDUPSLot)
    {
        debugger;
        endEditing();
        if(!ValidationOfStartTime())return;
        if(_oFNProductionPlan.FNMachineID==null || _oFNProductionPlan.FNMachineID<=0)
        {
            alert("Please, first select a Machine!!");
            return;
        }
        if(_oFNProductionPlan.FSCDID==null || _oFNProductionPlan.FSCDID<=0)
        {
            alert("Please, first select a Dispo!!");
            return;
        }
        
        var oFNProductionPlan=RefreshObject();
        var nts=(new Date()).getTime()/1000;

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FNProductionPlan/ScheduleInTimePeriod",
            data: JSON.stringify({oFNProductionPlan:oFNProductionPlan, nts: nts}),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            {
                ////debugger;
                var nCount = jQuery.parseJSON(data);
                if (nCount>0)
                {
                    if(confirm("Are you sure to increase time from next all schedules."))
                    {
                        oFNProductionPlan.IsIncreaseTime=true;
                        SaveProductionSchedule(oFNProductionPlan, isDUPSLot);
                        //$("#winDUFNProductionPlan").icsWindow("close");
                        //$('#btnSave').show();
                    }
                }
                else if(nCount==0)
                {
                    oFNProductionPlan.IsIncreaseTime=false;
                    SaveProductionSchedule(oFNProductionPlan, isDUPSLot);
                    //$("#winDUFNProductionPlan").icsWindow("close");
                    //$('#btnSave').show();
                }
            },
            error: function(xhr, status, error)
            {
                alert(error);
                $('#btnSave').show();
            }
        });
    }
    function SaveProductionSchedule(oFNProductionPlan,isDUPSLot)
    {  $('#btnSave').hide();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNProductionPlan/Save",
            traditional: true,
            data:  JSON.stringify(oFNProductionPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUPS = jQuery.parseJSON(data);
                if (oDUPS.ErrorMessage=="")
                {
                    _oFNProductionPlan=oDUPS;
                    alert("Data Saved successfully");

                    //DynamicRefreshList(_oFNProductionPlan.FNProductionPlanDetails, "tblFSPDetail");

                    if(_oIsAdd==true)
                    {
                        var oFNProductionPlans= $('#tblFNProductionPlan').datagrid('getRows');
                        var nIndex=oFNProductionPlans.length;
                        $('#tblFNProductionPlan').datagrid('appendRow', _oFNProductionPlan);
                        $('#tblFNProductionPlan').datagrid('selectRow', nIndex);
                    }
                    else
                    {
                        $('#tblFNProductionPlan').datagrid('updateRow', { index: _nSelectedRowIndex, row: _oFNProductionPlan });
                        $('#tblFNProductionPlan').datagrid('selectRow', _nSelectedRowIndex);
                    }
                    $("#winDUFNProductionPlan").icsWindow("close");
                }
                else {
                    alert(oDUPS.ErrorMessage);
                }
                $('#btnSave').show();
            },
            error: function (xhr, status, error) {
                alert(error);
            }


        });
    }
    _nBagCount=0;
    _nQtyPerBag=0;
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblFSPDetail').datagrid('validateRow', editIndex)) {
            $('#tblFSPDetail').datagrid('endEdit', editIndex);
            $('#tblFSPDetail').datagrid('selectRow', editIndex);
            var oDUPSDetail = $('#tblFSPDetail').datagrid('getSelected');

            if(oDUPSDetail==undefined){editIndex == undefined; return;}
            //debugger;

            if(_nBagCount!=parseFloat(oDUPSDetail.BagCount) || _nQtyPerBag!=parseFloat(oDUPSDetail.QtyPerBag))
            {
                if(parseFloat(oDUPSDetail.BagCount)>0 && parseFloat(oDUPSDetail.QtyPerBag)>0)
                {
                    oDUPSDetail.Qty= oDUPSDetail.BagCount*oDUPSDetail.QtyPerBag;
                }
                _nBagCount=parseFloat(oDUPSDetail.BagCount);
                _nQtyPerBag=parseFloat(oDUPSDetail.QtyPerBag);
            }


            $('#tblFSPDetail').datagrid('updateRow', { index: editIndex, row: oDUPSDetail });

            //RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblFSPDetail').datagrid('selectRow', index).datagrid('beginEdit', index);


                var oDUPSDetail= $('#tblFSPDetail').datagrid('getSelected');
                _nBagCount=parseFloat(oDUPSDetail.BagCount);
                _nQtyPerBag=parseFloat(oDUPSDetail.QtyPerBag);

                editIndex = index;
            }
            else {
                $('#tblFSPDetail').datagrid('selectRow', editIndex);
            }
        }
    }

    //////advance Search

    $("#btnClrMachinePiker").click(function () {

        $("#txtMachineName").val("");
        $("#winAdvSearch").data("MachineIDs","");
    });

    $("#btnMachinePiker").click(function () {

        var sMachineName=$.trim($("#txtMachineName").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachinespp(sMachineName);
    });

    $("#txtMachineName").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachineName").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachinespp(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachineName").val("");
            $("#winAdvSearch").data("MachineIDs","");
        }
    });
    function GetMachinespp(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem('BUID'),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "FNMachine",
            ActionName: "GetFNMachines",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FNMachineID > 0) {
                    //debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "Capacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "SequenceNo", title: "SL No", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMachinesPicker',
                        winclass:'clsMachinesPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinesPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });
    }

    $("#btnClrCustomerPiker").click(function () {
        $("#txtCustomerName").val("");
        $("#winAdvSearch").data("CustomerIDs","");
    });

    $("#btnCustomerPiker").click(function () {
        var sCustomerName=$.trim($("#txtCustomerName").val());
        //if(sCustomerName==""){ alert("Type Customer name to search."); return false; }
        GetCustomers(sCustomerName);
    });

    $("#txtCustomerName").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sCustomerName=$.trim($("#txtCustomerName").val());
            //if(sCustomerName==""){ alert("Type Customer name to search."); return false; }
            GetCustomers(sCustomerName);
        }
        else if(nkeyCode==8){
            $("#txtCustomerName").val("");
            $("#winAdvSearch").data("CustomerIDs","");
        }
    });
    function GetCustomers(sCustomerName){

        var oCustomer = { Params: 2 + '~' + $.trim($('#txtCustomerName').val())+'~'+ _nBUID };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oCustomer,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winCustomersPicker',
                        winclass:'clsCustomersPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblCustomersPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Customer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Customer found.");
            }
        });
    }

    function CheckFromAndToDateValidation(OperationComboId, FromDateId, ToDateId) {
        $("#" + OperationComboId).parent().parent().parent().find("select").removeClass("errorFieldBorder");
        var nCboVal = $("#" + OperationComboId).val();
        if (parseInt(nCboVal) == 5 || parseInt(nCboVal) == 6) {
            var fromDate = $("#" + FromDateId).datebox("getValue");
            var toDate = $("#" + ToDateId).datebox("getValue");
            if (new Date(fromDate) > new Date(toDate)) {
                $("#" + ToDateId).focus();
                $("#" + OperationComboId).addClass("errorFieldBorder");
                $(".lblLoadingMessage").hide();
                return false;
            } else {
                $("#" + OperationComboId).removeClass("errorFieldBorder");
                return true;
            }
        } else {
            return true;
        }
    }

    function ResetAdvSearchWindow() {
        _sContractorIds = '';
        _sDeliverToIDs = "";
        _sCPersonnelIds="";
        $("#winAdvSearch input").not("input[type='button']").val("");
        $("#winAdvSearch input").removeClass("fontColorOfPickItem");
        $("#winAdvSearch select").val(0);
        DateActionsDateAdvSearch();
        $("#txtFromDateAdvSearch,#txtToDateAdvSearch").datebox({ disabled: true });
        $("#txtFromDateAdvSearch,#txtToDateAdvSearch").datebox("setValue", icsdateformat(new Date()));
    }

    function PickContractors_AdvS() {
        var oContractor = {
            Params: '2,3' + '~' + $.trim($("#txtContractorAdvS").val())+"~"+_nBUID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);

        DynamicRefreshList([], "tblAccountsPickerAdvSearch");
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass: 'clsAccountOf',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblAccountOfs',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Contactor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Contactor Found.");
            }
        });
    }

    function PickDeliverTo_AdvS() {
        var oContractor = {
            Params: '2' + '~' + $.trim($("#txtDeliverToAdvS").val()+"~"+_nBUID)
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        DynamicRefreshList([], "tblContractorsPickerAdvSearch");
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winBuyers',
                        winclass: 'clsBuyer',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblBuyers',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Buyer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Contactor Found.");
            }
        });
    }


    function DateActionsDateAdvSearch() {
        DynamicDateActions("cboDateAdvS", "txtFromDateAdvSearch", "txtToDateAdvSearch");
    }

    $("#btnCloseAdvSearch").click(function () {
        $("#winAdvSearch").icsWindow("close");
    });
    $("#btnAdvSearch").click(function () {
        debugger;
        $("#winAdvSearch").icsWindow("open", " Advance Search");

        DynamicResetAdvSearchWindow("winAdvSearch");
        DynamicDateActions("cboDateAdvS", "txtFromDateAdvSearch", "txtToDateAdvSearch");
        ResetAdvSearchWindow();
        $("#cboDateAdvS").icsLoadCombo({
            List: _oCompareOperators,
            OptionValue: "id",
            DisplayText: "Value"
        });
    });
    $('#txtSearchByDispoNo').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var nCboOrderDate = 0;
            var dFromOrderDate = icsdateformat(new Date());
            var dToOrderDate = icsdateformat(new Date());
            var sExeNo = $.trim($("#txtSearchByDispoNo").val());

            debugger;
            var sParams = nCboOrderDate + "~" +
                          dFromOrderDate + "~" +
                          dToOrderDate + "~" +
                          sExeNo+"~"  +
                        ""+"~"+
                        ""+"~"+
                        ""+"~"+
                        0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        false;

            //console.log(sParams);
            sessionStorage.setItem("ParamsSO", sParams);
            var oFNProductionPlan = {
                ErrorMessage : sParams
            };

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FNProductionPlan/Search",
                traditional: true,
                data: JSON.stringify(oFNProductionPlan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFNProductionPlans = data;
                    if (oFNProductionPlans != null )
                    {
                        if (oFNProductionPlans.length > 0 && oFNProductionPlans[0].ErrorMessage=='')
                        {
                            DynamicRefreshList(oFNProductionPlans, "tblFNProductionPlan");
                            $("#winAdvSearch").icsWindow("close");
                        }
                        else
                        {
                            alert("Sorry, No data found. "+(oFNProductionPlans[0]==undefined?'':oFNProductionPlans[0].ErrorMessage));
                            DynamicRefreshList([], "tblFNProductionPlan");
                        }

                    } else {
                        alert("Sorry, No data found. ");
                        DynamicRefreshList([], "tblFNProductionPlan");
                    }
                    $(".lblLoadingMessage").hide();
                }
            });
        }
        else if (code === 8) {
            DynamicRefreshList([], "tblExportBillReports");
        }
    });
    $("#btnSearchAdvSearch").click(function () {
        debugger;
        var checkDate = CheckFromAndToDateValidation("cboOrderDateAdvS", "txtFromOrderDateAdvSearch", "txtToOrderDateAdvSearch");
        if (!checkDate) {
            alert("Start date must be greater than end date.");
            return false;
        }
        //var nContractorID = parseInt(_sContractorIds);
        //var nBuyerID = parseInt(_sDeliverToIDs);
        var nCboOrderDate = parseInt($("#cboDateAdvS").val());
        var dFromOrderDate = $('#txtFromDateAdvSearch').datebox('getValue');
        var dToOrderDate = $('#txtToDateAdvSearch').datebox('getValue');

        var sExeNo = $.trim($("#txtExeNo").val());
        var sConstruction = $.trim($("#txtConstructions").val());
        var sMachineIDs = $("#winAdvSearch").data("MachineIDs");
        var sCustomerIDs = $("#winAdvSearch").data("CustomerIDs");
        var nPlanStatus = parseInt($("#cboPlanStatusAdv").val());
        var bIsPending = false;
        if($('#chkIsPending').attr("checked"))
            bIsPending=true;

        if(nCboOrderDate <= 0 && sExeNo == "" && sConstruction == "" && sMachineIDs == "" && sCustomerIDs == "" && nDesign <= 0 && nPlanStatus <= 0 && sBatchNo == "" && bIsPending==false){
            alert("Please enter atleast one searching criteria!!");
            return;
        }

        debugger;
        var sParams =   nCboOrderDate + "~" +
                        dFromOrderDate + "~" +
                        dToOrderDate + "~" +
                        sExeNo+"~" +
                        sConstruction+"~"+
                        sMachineIDs+"~"+
                        sCustomerIDs+"~"+
                        nPlanStatus+"~"+
                        bIsPending;

        //console.log(sParams);

        sessionStorage.setItem("ParamsSO", sParams);
        var oFNProductionPlan = {
            ErrorMessage : sParams
        };
        $(".lblLoadingMessage").show();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FNProductionPlan/AdvSearch",
            traditional: true,
            data: JSON.stringify(oFNProductionPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFNProductionPlans = jQuery.parseJSON(data);
                debugger;
                if (oFNProductionPlans != null )
                {
                    if (oFNProductionPlans.length > 0 && oFNProductionPlans[0].ErrorMessage=='')
                    {
                        DynamicRefreshList(oFNProductionPlans, "tblFNProductionPlan");
                        $("#winAdvSearch").icsWindow("close");
                    }
                    else
                    {
                        alert("Sorry, No data found. "+(oFNProductionPlans[0]==undefined?'':oFNProductionPlans[0].ErrorMessage));
                        DynamicRefreshList([], "tblFNProductionPlan");
                    }

                } else {
                    alert("Sorry, No data found. ");
                    DynamicRefreshList([], "tblFNProductionPlan");
                }
                $(".lblLoadingMessage").hide();
            }
        });
    });
    $("#btnPrint").click(function () {
        debugger;
        var sParams="";
        var bIsPending = false;
        if($('#chkIsPendingFSP').attr("checked"))
            bIsPending=true;
        if(bIsPending == true){
            sParams = 0 + "~" +
                          icsdateformat(new Date()) + "~" +
                          icsdateformat(new Date()) + "~" +
                          ""+"~"  +
                        ""+"~"+
                        ""+"~"+
                        ""+"~"+
                        0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        true;
        }else{
            sParams=sessionStorage.getItem("ParamsSO");
            if(sParams == null || sParams == ""){
                alert("Please search first!!");
                return;
            }
        }

        window.open(_sBaseAddress + '/FNProductionPlan/PrintFabricWarpingPlan_Machine?sTemp=' + sParams, "_blank");
    });

    $("#btnExcel").click(function () {
        var sParams="";
        var bIsPending = false;
        if($('#chkIsPendingFSP').attr("checked"))
            bIsPending=true;
        if(bIsPending == true){
            sParams = 0 + "~" +
                          icsdateformat(new Date()) + "~" +
                          icsdateformat(new Date()) + "~" +
                          ""+"~"  +
                        ""+"~"+
                        ""+"~"+
                        ""+"~"+
                        0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        true;
        }else{
            sParams=sessionStorage.getItem("ParamsSO");
            if(sParams == null || sParams == ""){
                alert("Please search first!!");
                return;
            }
        }

        window.open(_sBaseAddress + '/FNProductionPlan/ExcelFabricWarpingPlan_Machine?sTemp=' + sParams, "_blank");
    });

    $('#btnPrintChemicalPlan').click(function(){
        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if(oFNProductionPlan==null || parseInt(oFNProductionPlan.FNPPID)<=0)
        {
            alert("Please select an Item from List!!");
            return;
        }
        window.open(_sBaseAddress+ "/FNProductionPlan/PrintChemicalPlan?nFNProductionPlanID="+oFNProductionPlan.FNPPID+"&nBUID="+sessionStorage.getItem('BUID'));
    });

    $('#btnCut').click(function(e){
        debugger;

        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        oFNProductionPlan.StartTime = new Date(oFNProductionPlan.StartTimeSt); //icsdateformat(oFNProductionPlan.StartTimeSt);
        oFNProductionPlan.EndTime = new Date(oFNProductionPlan.EndTimeSt); //icsdateformat(oFNProductionPlan.EndTimeSt);
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }

        _oFNProductionPlan=oFNProductionPlan;

        var SelectedRowIndex = $('#tblFNProductionPlan').datagrid('getRowIndex', oFNProductionPlan);
        $('#tblFNProductionPlan').datagrid('deleteRow',SelectedRowIndex);
        $('#btnPast').show();
        $('#btnCut').hide();

    });
    $('#btnPast').click(function(e)
    {
        if(_oFNProductionPlan==null|| _oFNProductionPlan.FNPPID<=0){alert("Nothing found for paste."); return;}
        //if(_oFNProductionPlan.FNMachineID<=0)
        //{
        //    alert("Select Machine from List.");
        //    return;
        //}
        debugger;

        var oFNProductionPlan = $('#tblFNProductionPlan').datagrid('getSelected');
        if (oFNProductionPlan ==null || oFNProductionPlan.FNPPID <=0 ) { alert("Please select an item from list."); return ; }
        oFNProductionPlan.StartTime = new Date(oFNProductionPlan.StartTimeSt); //icsdateformat(oFNProductionPlan.StartTimeSt);
        oFNProductionPlan.EndTime = new Date(oFNProductionPlan.EndTimeSt); //icsdateformat(oFNProductionPlan.EndTimeSt);


        var nIndex=$('#tblFNProductionPlan').datagrid('getRowIndex',oFNProductionPlan);
        var dStartDate =oFNProductionPlan.EndTimeSt;
        var startTime=oFNProductionPlan.EndTimeSt;


        //if(_oFNProductionPlan.FNPPID<=0)
        //{
        //    var dStartDate =$('#txtStartDate').datebox('getValue');
        //    var startTime= $('#tpStartTime').timespinner('getValue');
        //}
        //else{
        //    var dStartDate =_oFNProductionPlan.EndDateSt;
        //    var startTime=_oFNProductionPlan.EndTimeTS;
        //}

        if(_oFNProductionPlan.FNMachineID<=0){
            alert("Invalid Machine !"); return;
        }
        if(oFNProductionPlan.FNMachineID<=0){
            alert("Invalid Machine !"); return;
        }

        var oFabricSP=
            {
                FNPPID: (oFNProductionPlan!=null &&oFNProductionPlan.FNPPID>0)? oFNProductionPlan.FNPPID:0,
                FNMachineID:oFNProductionPlan.FNMachineID,
                BUID:sessionStorage.getItem('BUID'),
                Params:oFNProductionPlan.FNPPID+'~'+_oFNProductionPlan.FNPPID+'~'+dStartDate+"~"+startTime
            };

        //debugger;

        var nts=(new Date()).getTime()/1000;
        {
            //var sPSIDs=;
            $.ajax({
                type: "Post",
                dataType: "json",
                url: _sBaseAddress + "/FNProductionPlan/PastSchedule",
                traditional: true,
                data:   JSON.stringify(oFabricSP),///{sPSIDs : sPSIDs, nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    var oresults=jQuery.parseJSON(data);
                    if(oresults[0].ErrorMessage=="" || oresults[0].ErrorMessage==null)
                    {
                        debugger;
                        alert("Paste Successfully");
                        var  oFNProductionPlans=$('#tblFNProductionPlan').datagrid('getRows');
                        // Replace with `33`
                        nIndex=nIndex+1;
                        if ( nIndex >= 0 ) {
                            oFNProductionPlans.splice( nIndex, 0, oresults[0] );

                            DynamicRefreshList(oFNProductionPlans, 'tblFNProductionPlan');
                            $('#tblFNProductionPlan').datagrid('selectRow', nIndex);
                        }
                        $('#btnCut').show();
                        $('#btnPast').hide();
                        //function move(array, oldIndex, newIndex) {
                        //    if (newIndex >= array.length) {
                        //        newIndex = array.length - 1;
                        //    }
                        //    array.splice(newIndex, 0, array.splice(oldIndex, 1)[0]);
                        //    return array;
                        //}

                        //var idx = data.indexOf(32);

                        //// Replace with `33`
                        //if ( idx >= 0 ) {
                        //    data.splice( idx, 0, 33 );
                        //}


                    }
                    else {alert(oresults[0].ErrorMessage);}
                    //alert(sMessage);
                    //if(sMessage=="Swap Successfully") { Refresh(); }

                },
                error: function (xhr, status, error) {alert(error);}
            });
        }
    });

    $('#btnSwap').click(function(e)
    {
        var oRows =  $('#tblFNProductionPlan').datagrid('getChecked');
        if(oRows.length != 2){
            alert("Please select only two items!!");
            return;
        }
        for(var i=0;i<oRows.length;i++){
            if(oRows[i].FNMachineID<=0){
                alert("Invalid Machine For Dispo No: "+oRows[i].ExeNo+" !"); return;
            }
            oRows[i].StartTime = new Date(oRows[i].StartTimeSt); //icsdateformat(oFNProductionPlan.StartTimeSt);
            oRows[i].EndTime = new Date(oRows[i].EndTimeSt); //icsdateformat(oFNProductionPlan.EndTimeSt);
        }
        if(!confirm("Are you sure want to swap?"))
            return false;

        var nIndex1=$('#tblFNProductionPlan').datagrid('getRowIndex',oRows[0]);
        var nIndex2=$('#tblFNProductionPlan').datagrid('getRowIndex',oRows[1]);

        var oFabricSP=
            {
                Params: oRows[0].FNPPID+'~'+oRows[1].FNPPID //+'~'+dStartDate+"~"+startTime
            };

        debugger;
        $.ajax({
            type: "Post",
            dataType: "json",
            url: _sBaseAddress + "/FNProductionPlan/SwapTwoSchedule",
            traditional: true,
            data:   JSON.stringify(oFabricSP),///{sPSIDs : sPSIDs, nts:nts}),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oresults=jQuery.parseJSON(data);
                if(oresults[0].ErrorMessage=="" || oresults[0].ErrorMessage==null)
                {
                    debugger;
                    alert("Swap Successfully");
                    //var  oFNProductionPlans=$('#tblFNProductionPlan').datagrid('getRows');

                    $('#tblFNProductionPlan').datagrid('updateRow',{index: nIndex1,row: oresults[1]});
                    $('#tblFNProductionPlan').datagrid('updateRow',{index: nIndex2,row: oresults[0]});

                    //oFNProductionPlans.splice( nIndex1, 0, oresults[1] );
                    //oFNProductionPlans.splice( nIndex2, 0, oresults[0] );

                    //DynamicRefreshList(oFNProductionPlans, 'tblFNProductionPlan');
                    $('#tblFNProductionPlan').datagrid('selectRow', nIndex1);
                }
                else {alert(oresults[0].ErrorMessage);}
            },
            error: function (xhr, status, error) {alert(error);}
        });


    });

    function RefreshControlLayout()
    {
        $('#btnAdd,#btnEdit,#btnDelete,#btnCut,#btnPast,#btnSwap,#btnAddChemicalplan').hide();

        if (PermissionChecker('Add', 'FNProductionPlan',_oAuthorizationRolesMapping)) {$("#btnAdd,#btnAddChemicalplan").show();}
        if (PermissionChecker('Edit', 'FNProductionPlan',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
        if (PermissionChecker('View', 'FNProductionPlan',_oAuthorizationRolesMapping)) {$("#btnView").show();}
        if (PermissionChecker('Delete', 'FNProductionPlan',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
        if (PermissionChecker('Copy', 'FNProductionPlan',_oAuthorizationRolesMapping)) {$('#btnCut,#btnPast,#btnSwap').show();}


    }

    $('#btnPrintPDF').click(function(){
        debugger;
        var oFNProductionPlans = $('#tblFNProductionPlan').datagrid('getRows');
        var oFNProductionPlan = {
            ErrorMessage : ICS_PropertyConcatation(oFNProductionPlans, 'FNPPID'),
            ReportType : parseInt($('#cboPrintType').val()),
            BUID : _nBUID
        };
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+ "/FNProductionPlan/SetSessionSearchCriterias",
            traditional: true,
            data:  JSON.stringify(oFNProductionPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful") {
                    window.open(_sBaseAddress+'/FNProductionPlan/PrintFNProductionPlans');
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });





</script>
