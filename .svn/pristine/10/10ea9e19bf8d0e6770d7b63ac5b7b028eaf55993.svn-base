<html>
@{
    ViewBag.Title = "Vehicle Order Entry";
}
<body>
    @model ESimSol.BusinessObjects.VehicleOrder
    <script src="~/Views/VehicleChassis/VehicleChassiss.js"></script>
    <script src="~/Views/VehicleEngine/VehicleEngine.js"></script>

    <div class="menuMainCollectionTable" ng-app="VehicleOrderApp" ng-controller="VehicleOrderController as MLCC" id="divVehicleOrder">
        <div style="font-family:Tahoma;text-align:center;height:56%; overflow:scroll" class="regionVR">
            <div class="col-md-12">
                <div class="col-md-7 align-left">
                    <fieldset>
                        <legend>Model Info</legend>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">File No:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="col-md-3">
                                    <input ng-model="VehicleOrder.FileNo" class="form-control" disabled />
                                </div>
                                <div class="col-md-3" style="text-align:right;">
                                    <label class="control-label">Issue Date:</label>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group date date-container">
                                        <input type="text" class="form-control" ng-model="VehicleOrder.IssueDateSt"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Code/Ref No:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <input type="text" ng-model="VehicleOrder.RefNo" class="form-control" />
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Model No:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input type="text" ng-model="VehicleOrder.ModelNo" class="form-control" ng-keydown="SearchKeyDownVehicleModel($event)" placeholder="Type Model No & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickVehicleModel()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Chassis No:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.ChassisNo" class="form-control" ng-keydown="SearchKeyDownChassisNo($event)" placeholder="Type Chassis No & Press Enter" />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickNewChassis()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickChassisNo()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Engine No:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.EngineNo" class="form-control" ng-keydown="SearchKeyDownEngineNo($event)" placeholder="Type Engine No & Press Enter" />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickNewEngine()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickEngineNo()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Exterior Color:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.ExteriorColorName" class="form-control" ng-keydown="SearchKeyDownExteriorColor($event)" placeholder="Type Exterior Color Name & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(1)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Interior Color:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.InteriorColorName" class="form-control" ng-keydown="SearchKeyDownInteriorColor($event)" placeholder="Type Interior Color Name & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(2)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Upholstery:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.Upholstery" class="form-control" ng-keydown="SearchKeyDownUpholstery($event)" placeholder="Type Upholstery & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickColorName(3)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Trim:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.Trim" class="form-control" ng-keydown="SearchKeyDownTrim($event)" placeholder="Type Code or Name & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickParts(1)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Wheels:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="input-group">
                                    <input ng-model="VehicleOrder.Wheels" class="form-control" ng-keydown="SearchKeyDownWheels($event)" placeholder="Type Code or Name & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickParts(2)"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">E.T.A:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <div class="col-md-3">
                                    <input type="text" ng-model="VehicleOrder.ETAValue" class="form-control" ng-change="ChangeETAType()" />
                                </div>
                                <div class="col-md-3">
                                    <select ng-model="VehicleOrder.ETATypeInInt" ng-change="ChangeETAType()" class="form-control" ng-options="oItem.id as oItem.Value for oItem in DisplayParts"></select>
                                </div>
                                <div class="col-md-3">
                                    <input ng-model="VehicleOrder.PossibleDateSt" class="form-control" disabled />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Remarks:</label>
                            </div>
                            <div class="col-md-4 text-left">
                                <input type="text" ng-model="VehicleOrder.Remarks" class="form-control" />
                            </div>
                            <div class="col-md-2 text-right">
                                <label class="control-label">Currency:</label>
                            </div>
                            <div class="col-md-2 text-left">
                                <select style="width:180%; margin-left:-15px" ng-model="VehicleOrder.CurrencyID" class="form-control" ng-options="oItem.CurrencyID as oItem.CurrencyName for oItem in CurrencyList">
                                    <option value="">--Select Currency--</option>
                                </select>
                            </div>

                        </div>

                        <div class="col-md-12">
                            <div class="col-md-4 text-right">
                                <label class="control-label">Feature Setup:</label>
                            </div>
                            <div class="col-md-8 text-left">
                                <input type="text" ng-model="VehicleOrder.FeatureSetupName" class="form-control" />
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-5">
                    <fieldset style="height:275px;">
                        <legend>Order Image</legend>
                        <div class="col-md-12">
                            <img id="imgOrderImage" src="@Url.Action("GetLargeImage", "VehicleOrder", new { id = Model.VehicleOrderID })" alt="Photo" style="width:90%; height:250px; vertical-align:middle; text-align:center;" />
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
        <div class="ui-grid-top-panel" style="text-align:left;">
            <label>Feature:</label><input ng-model="txtFeatureName" placeholder="Type Feature & Press Enter" ng-keydown="SearchKeyFeatureNo($event)" style="width:210px; height:24px;" required />
            <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PickFeature()"><span class="glyphicon glyphicon-ok" aria-hidden="true"> Pick</span></button>
            <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RemoveDetail()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
            <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RefreshDetail()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
        </div>
        <div style="width: 100%; height:140px;" ui-grid="gridOptionsVehicleOrderDetail" ui-grid-selection ui-grid-edit ui-grid-row-edit ui-grid-cellnav></div>
        
        <div class="navbar">
            <fieldset style="height:60px;">
                <legend>Action</legend>
                <div class="row col-md-12 text-right">
                    <button type="button" class="btn btn-sm" aria-label="Left Align" ng-hide="btnSave" ng-click="Save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> <label id="lblSave">Save</label></span> </button>
                    <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
                </div>
            </fieldset>
        </div>
    </div>
</body>
</html>
<style type="text/css">
    .regionVR .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionVR .form-control {
        height: 22px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionVR .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 3px;
    }

    .regionVR .col-md-7 {
        width: 60%;
        padding-right: 5px;
        padding-left: 5px;
    }
    .regionVR .col-md-5 {
        width: 40%;
        padding-right: 5px;
        padding-left: 5px;
    }

     .regionVR .col-md-4 {
        width: 30%;
        padding-right: 5px;
        padding-left: 5px;
    }
    
    .regionVR .col-md-8 {
        width: 70%;
        padding-right: 5px;
        padding-left: 5px;
    }
 
     .regionVR .col-md-3 {
        width: 33.33%;
        padding-right:3px;
        padding-left:3px;
    }
     
    .regionVR .btn-sm {
        padding: 2px 8px;
    }

    .regionVR .input-group-addon {
        padding: 2px 5px;
    }
</style>
<script type="text/javascript">
    //debugger;
    var oVehicleOrder =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oDisplayParts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DisplayParts));
    var oCurrencyList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CurrencyList));
    var oVehicleOrderDetails= oVehicleOrder.VehicleOrderDetails;
    var oFuelTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FuelTypes));
    var oSessions = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Sessions));

    var VehicleOrderApp = angular.module('VehicleOrderApp', ['ngAnimate', 'ui.bootstrap','ui.grid', 'ui.grid.selection', 'ui.grid.edit', 'ui.grid.rowEdit','ui.grid.cellNav', 'ms.service','chassis.service','engine.service']);
    VehicleOrderApp.controller('VehicleOrderController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod,msGridControl, chassisservice, engineservice) {
        debugger;
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });
        $scope.VehicleOrder=oVehicleOrder;
        $scope.VehicleOrder.BUID=sessionStorage.getItem('BUID');
        if(sessionStorage.getItem("VehicleOrderHeader")=="Copy Vehicle Order")
        {
            $('#lblSave').html('Paste');
            //Reset IDs
            $scope.VehicleOrder.VehicleOrderID = 0;
            for(var i = 0;i<oVehicleOrderDetails.length;i++)
            {
                oVehicleOrderDetails[i].VehicleOrderDetailID = 0;
                oVehicleOrderDetails[i].VehicleOrderID = 0;
            }
        }
        $scope.VehicleOrderDetails=oVehicleOrderDetails;
        $scope.DisplayParts = oDisplayParts;
        $scope.CurrencyList = oCurrencyList;
        //$scope.VehicleOrder.VehicleOrder
        var oDetailColumns = [];
        var oColumn = { field: 'FeatureCode', name:'Code', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'FeatureName', name:'Feature Description', width:'40%',cellClass: 'text-left',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'Remarks', name: 'Remarks', width: '10%', cellClass: 'text-center',enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);
        //oColumn ={ field: 'CurrencyName', name: 'Currency', width: '10%', cellClass: 'text-center',editType: 'dropdown',editableCellTemplate: 'ui-grid/dropdownEditor',editDropdownOptionsArray: $scope.CurrencyList,editDropdownIdLabel:'CurrencyName',editDropdownValueLabel: 'CurrencyName', enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);
        oColumn ={ field: 'Price', name: 'Price', width: '15%',align:'left',cellClass: 'text-right', cellFilter: 'number: 2', enableSorting: false ,enableCellEdit:true};oDetailColumns.push(oColumn);

        ////Model Feature
        $scope.gridOptionsVehicleOrderDetail = {
            showColumnFooter: false,
            multiSelect: false,
            enableRowSelection: true,
            enableSelectAll: false,
            columnDefs:oDetailColumns,
            data:oVehicleOrderDetails,
            onRegisterApi: function (gridApi) {
                debugger;
                $scope.gridDetailApi = gridApi;
                gridApi.edit.on.afterCellEdit($scope,
                 function (rowEntity, colDef, newValue, oldValue)
                 {
                     debugger;
                     rowEntity.CurrencyID = $scope.CurrencyList.filter(function(obj){return obj.CurrencyName== rowEntity.CurrencyName;})[0].CurrencyID;
                     return rowEntity;
                 });
            }
        };



        $scope.ChangeETAType =  function()
        {
            debugger;
            var dIssueDate = new Date($scope.VehicleOrder.IssueDateSt);
            if($scope.VehicleOrder.ETATypeInInt==1 &&  $scope.VehicleOrder.ETAValue!="" && parseInt($scope.VehicleOrder.ETAValue)>0 )//day
            {

                $scope.VehicleOrder.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.VehicleOrder.ETAValue))));
            }else if($scope.VehicleOrder.ETATypeInInt==2)//week
            {
                $scope.VehicleOrder.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.VehicleOrder.ETAValue * 7))));
            }else if($scope.VehicleOrder.ETATypeInInt==3)//Month
            {
                $scope.VehicleOrder.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.VehicleOrder.ETAValue * 30))));
            }else if($scope.VehicleOrder.ETATypeInInt==4)//Year
            {
                $scope.VehicleOrder.PossibleDateSt = icsdateformat(new Date(dIssueDate.setDate(dIssueDate.getDate() + parseInt($scope.VehicleOrder.ETAValue * 365))));
            }
            else if($scope.VehicleOrder.ETATypeInInt==3)//Month
                {
                    $scope.VehicleOrder.PossibleDateSt = "";
                }

        }

        $scope.GetModelFeatures= function() //GetOptionalFeature //NotUsed
        {
            debugger;
            var oModelFeature = {
                VehicleModelID:$scope.VehicleOrder.VehicleModelID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModelFeatures',$.param(oModelFeature), config).then(
                                function (response) {
                                    $scope.gridOptionsVehicleOrderDetail.data=[];
                                    result=jQuery.parseJSON(response.data);
                                    $scope.gridOptionsVehicleOrderDetail.data=(result);
                                    $scope.VehicleOrderDetails=result;
                                    alert($scope.VehicleIOrder.VehicleModelID);
                                }, function () {
                                    $log.info('GetVehicleOrderDetails Dismissed at: ' + new Date());
                                });
        }
        $scope.PickVehicleModel= function ()
        {
            debugger;
            var oVehicleModel = {
                ModelNo: $.trim($scope.VehicleOrder.ModelNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModels',$.param(oVehicleModel), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'ModelNo', name: 'ModelNo',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'CategoryName', name: 'CategoryName',width: '40%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Model List',
                                searchingbyfieldName:'ModelNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.VehicleOrder.ModelNo=result.ModelNo;
                                $scope.VehicleOrder.VehicleModelID=result.VehicleModelID;
                                GetVehicleModelImage(result.VehicleModelImageID);//Get Model Image
                                //$scope.GetModelFeatures();
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyVehicleModelNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ModelNo = $.trim($scope.VehicleOrder.ModelNo);
                if(ModelNo=="" || ModelNo==null)
                {
                    alert("Type Model No and Press Enter");
                    return;
                }
                $scope.PickVehicleModel();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.ModelNo='';
                $scope.VehicleOrder.VehicleModelID=0;
                GetVehicleModelImage(0);//Get Model Image
            }
        };
        $scope.PickChassisNo= function ()
        {
            var oVehicleChassis = {
                ChassisNo: $.trim($scope.VehicleOrder.ChassisNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleChassis/SearchByChassisNo',$.param(oVehicleChassis), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FileNo', name: 'File No',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ChassisNo', name: 'ChassisNo',width: '60%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Chassis List',
                                searchingbyfieldName:'ChassisNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.VehicleOrder.ChassisNo=result.ChassisNo;
                                $scope.VehicleOrder.ChassisID=result.VehicleChassisID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownChassisNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ChassisNo = $.trim($scope.VehicleOrder.ChassisNo);
                if(ChassisNo=="" || ChassisNo==null)
                {
                    alert("Type Chassis No and Press Enter");
                    return;
                }
                $scope.PickChassisNo();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.ChassisNo='';
                $scope.VehicleOrder.ChassisID=0;
            }
        };
        $scope.PickEngineNo= function ()
        {
            var oVehicleEngine = {
                EngineNo: $.trim($scope.VehicleOrder.EngineNo)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleEngine/SearchByEngineNo',$.param(oVehicleEngine), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FileNo', name: 'File No',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'EngineNo', name: 'EngineNo',width: '60%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Engine List',
                                searchingbyfieldName:'EngineNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.VehicleOrder.EngineNo=result.EngineNo;
                                $scope.VehicleOrder.EngineID=result.VehicleEngineID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownEngineNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var EngineNo = $.trim($scope.VehicleOrder.EngineNo);
                if(EngineNo=="" || EngineNo==null)
                {
                    alert("Type Engine No and Press Enter");
                    return;
                }
                $scope.PickEngineNo();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.EngineNo='';
                $scope.VehicleOrder.EngineID=0;
            }
        };
        //Color get
        $scope.PickColorName= function (nColorType)
        {
            var sColorName ="";
            if(nColorType==1)//Exterior
            {
                sColorName =  $.trim($scope.VehicleOrder.ExteriorColorName);
            }else if(nColorType==2)
            {
                sColorName =  $.trim($scope.VehicleOrder.InteriorColorName);
            }else if(nColorType==3)
            {
                sColorName =  $.trim($scope.VehicleOrder.Upholstery);
            }

            var oVehicleColor = {
                ColorName:sColorName,
                ColorType:nColorType
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleColor/SearchColor',$.param(oVehicleColor), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'ColorCode', name: 'Code',width: '35%'  };oColumns.push(oColumn);
                            oColumn = { field: 'ColorName', name: 'Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Color List',
                                searchingbyfieldName:'ColorName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(nColorType==1)//Exterior
                                {
                                    $scope.VehicleOrder.ExteriorColorName = result.ColorName;
                                    $scope.VehicleOrder.ExteriorColorID = result.VehicleColorID;
                                }else if(nColorType==2)
                                {
                                    $scope.VehicleOrder.InteriorColorName = result.ColorName;
                                    $scope.VehicleOrder.InteriorColorID = result.VehicleColorID;
                                }else if(nColorType==3)
                                {
                                    $scope.VehicleOrder.Upholstery = result.ColorName;
                                    $scope.VehicleOrder.UpholsteryID = result.VehicleColorID;
                                }

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownExteriorColor = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var ExteriorColorName = $.trim($scope.VehicleOrder.ExteriorColorName);
                if(ExteriorColorName=="" || ExteriorColorName==null)
                {
                    alert("Type Color Name and Press Enter");
                    return;
                }
                $scope.PickColorName(1);//Exterior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.ExteriorColorName = '';
                $scope.VehicleOrder.ExteriorColorID = 0;
            }
        }
        $scope.SearchKeyDownInteriorColor = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var InteriorColorName = $.trim($scope.VehicleOrder.InteriorColorName);
                if(InteriorColorName=="" || InteriorColorName==null)
                {
                    alert("Type Color Name and Press Enter");
                    return;
                }
                $scope.PickColorName(2);//Interior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.InteriorColorName = '';
                $scope.VehicleOrder.InteriorColorID = 0;
            }
        }
        $scope.SearchKeyDownUpholstery = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Upholstery = $.trim($scope.VehicleOrder.Upholstery);
                if(Upholstery=="" || Upholstery==null)
                {
                    alert("Type Upholstery and Press Enter");
                    return;
                }
                $scope.PickColorName(3);//Upholstery
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.Upholstery = '';
                $scope.VehicleOrder.UpholsteryID = 0;
            }
        }

        //
        $scope.PickParts= function (nPartsType)
        {
            var sPartsName ="";
            if(nPartsType==1)//Trim
            {
                sPartsName =  $.trim($scope.VehicleOrder.Trim);
            }else
            {
                sPartsName =  $.trim($scope.VehicleOrder.Wheels);
            }

            var oVehicleParts = {
                PartsName:sPartsName,
                PartsType:nPartsType
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleParts/SearchParts',$.param(oVehicleParts), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'PartsCode', name: 'Code',width: '35%'  };oColumns.push(oColumn);
                            oColumn = { field: 'PartsName', name: 'Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'sm',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Parts List',
                                searchingbyfieldName:'PartsName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(nPartsType==1)//Exterior
                                {
                                    $scope.VehicleOrder.Trim = result.PartsName;
                                    $scope.VehicleOrder.TrimID = result.VehiclePartsID;
                                }else
                                {
                                    $scope.VehicleOrder.Wheels = result.PartsName;
                                    $scope.VehicleOrder.WheelsID = result.VehiclePartsID;
                                }

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyDownTrim = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Trim = $.trim($scope.VehicleOrder.Trim);
                if(Trim=="" || Trim==null)
                {
                    alert("Type Trim Name/Code and Press Enter");
                    return;
                }
                $scope.PickParts(1);//Exterior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.Trim = '';
                $scope.VehicleOrder.TrimID = 0;
            }
        }
        $scope.SearchKeyDownWheels = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var Wheels = $.trim($scope.VehicleOrder.Wheels);
                if(Wheels=="" || Wheels==null)
                {
                    alert("Type Wheels Name/Code and Press Enter");
                    return;
                }
                $scope.PickParts(2);//Interior color
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleOrder.Wheels = '';
                $scope.VehicleOrder.WheelsID = 0;
            }
        }

        $scope.RefreshDetail = function ()
        {
            debugger;
            var oList = $scope.gridOptionsVehicleOrderDetail.data;
            $scope.gridOptionsVehicleOrderDetail.data =  oList;
        };
        $scope.PickFeature= function ()
        {
            //var oFeature = {
            //    FeatureName: $.trim($scope.txtFeatureName),
            //    Remarks:'6'//send as Types of Feature : just Optional Feature
            //};

            var oModelFeature = {
                VehicleModelID:$scope.VehicleOrder.VehicleModelID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleModel/GetVehicleModelFeatures',$.param(oModelFeature), config).then(

            //$http.post(sessionStorage.getItem('BaseAddress')+'/VehicleOrder/GetFeatures',$.param(oFeature), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'FeatureCode', name: 'Code',width: '30%'  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureName', name: 'Name',width: '40%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'FeatureTypeST', name: 'Type',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:true,
                                pickertitle:'Feature List',
                                searchingbyfieldName:'FeatureName',
                                columns:oColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                if(result.length>0)
                                {
                                    for(var i=0;i<result.length;i++)
                                    {
                                        var oVehicleOrderDetails = $scope.gridOptionsVehicleOrderDetail.data;
                                        if(!icsMethod.ICS_IsExist(oVehicleOrderDetails,'FeatureID', result[i].FeatureID))
                                        {
                                            var oVehicleOrderDetail = {
                                                VehicleOrderDetailID:0,
                                                VehicleOrderID:$scope.VehicleOrder.VehicleOrderID,
                                                FeatureID :result[i].FeatureID,
                                                Remarks : '',
                                                CurrencyID:0,
                                                CurrencyName:'-Select Currency-',
                                                FeatureCode:result[i].FeatureCode,
                                                FeatureName :result[i].FeatureName,
                                                Price:result[i].Price
                                            };
                                            $scope.gridOptionsVehicleOrderDetail.data.push(oVehicleOrderDetail);
                                        }
                                    }
                                    $scope.RefreshDetail();
                                }
                                $scope.txtFeatureName='';
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };
        $scope.SearchKeyFeatureNo = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtFeatureName = $.trim($scope.txtFeatureName);
                if(txtFeatureName=="" || txtFeatureName==null)
                {
                    alert("Type Sheet No and Press Enter");
                    return;
                }
                $scope.PickFeature();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtFeatureName='';
            }
        };
        $scope.RemoveDetail = function ()
        {
            debugger;
            var oMLCDetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oMLCDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptionsVehicleOrderDetail.data.indexOf(oMLCDetail);
            if (!confirm("Confirm to Delete?")) return ;
            $scope.gridOptionsVehicleOrderDetail.data.splice(SelectedRowIndex,1);
            $scope.RefreshDetail();
        };
        $scope.Save = function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oVehicleOrder= $scope.VehicleOrder;
            oVehicleOrder.IssueDate = new Date($scope.VehicleOrder.IssueDateSt);
            oVehicleOrder.ServiceOrderDate = new Date($scope.VehicleOrder.ServiceOrderDateSt);
            oVehicleOrder.RcvDateTime = new Date($scope.VehicleOrder.RcvDateTimeSt);
            oVehicleOrder.DelDateTime = new Date($scope.VehicleOrder.DelDateTimeSt);

            oVehicleOrder.OrderStatusInInt = 1;//intialize
            oVehicleOrder.VehicleOrderDetails = $scope.gridOptionsVehicleOrderDetail.data;

            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleOrder/Save',oVehicleOrder).then(
                        function (response)
                        {
                            var oVehicleOrder= jQuery.parseJSON(response.data);
                            if (oVehicleOrder.ErrorMessage=="" || oVehicleOrder.ErrorMessage==null)
                            {
                                debugger;
                                alert("Data Save Successfully!!");
                                var oVehicleOrders = sessionStorage.getItem("VehicleOrderList");
                                var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                                if (oVehicleOrders != null) {
                                    oVehicleOrders = jQuery.parseJSON(oVehicleOrders);
                                }
                                else {
                                    oVehicleOrders = [];
                                }
                                if (nIndex != -1) {
                                    oVehicleOrders[nIndex] = oVehicleOrder;
                                }
                                else {
                                    sessionStorage.setItem("SelectedRowIndex", oVehicleOrders.length);
                                    oVehicleOrders.push(oVehicleOrder);
                                }
                                sessionStorage.setItem("VehicleOrders", JSON.stringify(oVehicleOrders));
                                window.location.href = sessionStorage.getItem("BackLink");
                            }
                            else
                            {
                                alert(oVehicleOrder.ErrorMessage);
                            }
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);$scope.MeasurementUnits=[];}
                    );

        };
        $scope.ValidateInput =  function ()
        {
            debugger;
            if($scope.VehicleOrder.ModelNo=="" || $scope.VehicleOrder.VehicleModelID==0)
            {
                alert('Please Pick Model .');
                return false;
            }
            if($scope.VehicleOrder.InteriorColorID==0)
            {
                alert('Please Select Interior Color.');
                return false;
            }
            if($scope.VehicleOrder.ExteriorColorID==0)
            {
                alert('Please Select Exterior Color.');
                return false;
            }
            if($scope.VehicleOrder.RefNo=="")
            {
                alert('Please Type Ref No.');
                return false;
            }

           // if($scope.gridOptionsVehicleOrderDetail.data.length <=0){alert("Please Add Vechicle Order Detail");  return false;}

            return true;
        };


        $scope.PickNewChassis= function()
        {
            debugger;
            var result=null;
            var oVehicleChassis={
                VehicleChassisID: 0
            };

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress + '/VehicleChassis/GetByID', $.param(oVehicleChassis), config).then(
                                function (response) {
                                    debugger;
                                    result=jQuery.parseJSON(response.data);

                                    var modalObj={
                                        modalcontroller:'CCategoryapp',
                                        appcontroller:'VehicleChassisController',
                                        VehicleChassis: result
                                        //BussinessSessions:$scope.BussinessSessions
                                    }
                                    var modalInstance=chassisservice.Instance(modalObj);
                                    modalInstance.result.then(function (result)
                                    {
                                        debugger;
                                        $scope.gridOptions.data = result;
                                        $scope.selectedRowIndex=parseInt(userSession.getData("SelectedRowIndex"));
                                        //$scope.gridOptions.selectRow(selectedRowIndex), true);
                                        //$scope.gridApi.selection.selectRow($scope.gridOptions.data[selectedRowIndex]);
                                        // $scope.gridApi.selection.selectRow($scope.gridOptions.data[$scope.selectedRowIndex]);

                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                }
                            );
        }
        $scope.FuelTypes= oFuelTypes;
        $scope.PickNewEngine= function()
        {
            debugger;
            var result=null;
            var oVehicleEngine={
                VehicleEngineID: 0
            };

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress + '/VehicleEngine/GetByID', $.param(oVehicleEngine), config).then(
                                function (response) {
                                    debugger;
                                    result=jQuery.parseJSON(response.data);

                                    var modalObj={
                                        modalcontroller:'CCategoryapp',
                                        appcontroller:'VehicleEngineController',
                                        VehicleEngine: result,
                                        FuelTypes:  $scope.FuelTypes,
                                        Sessions: oSessions
                                    }
                                    var modalInstance=engineservice.Instance(modalObj);
                                    modalInstance.result.then(function(result)
                                    {
                                        debugger;
                                        $scope.gridOptions.data = result;

                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                }
                            );
        }

        if(sessionStorage.getItem("VehicleOrderHeader")=="View Vehicle Order")
        {
            $("#divVehicleOrder :input").prop('disabled', true);
            $('#btnclose').prop('disabled', false);
        }

        $scope.Close=function ()
        {
            window.location.href = sessionStorage.getItem("BackLink");
        };
        function GetVehicleModelImage(nVehicleModelImageID)
        {
            debugger;
            $.ajax({
                cache:true,
                type: "GET",
                url: "@(Url.Action("GetImageInBase64", "VehicleModel"))",
                data: "id=" + nVehicleModelImageID,
                success: function (data) {
                    $('#imgOrderImage').attr('src', "data:image/jpg;base64," + data.base64imgage );
                }
            });
        }
    });

</script>