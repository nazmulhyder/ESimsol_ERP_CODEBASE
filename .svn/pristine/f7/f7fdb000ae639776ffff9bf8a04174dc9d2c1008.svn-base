@{
    ViewBag.Title = "Delivery Challan List";
}
@model IEnumerable<ESimSol.BusinessObjects.DeliveryChallan>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
<div id="winVehicleDate" class="easyui-window" title="Update Vehicle Date" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma">
        <fieldset style="margin-top:3px">
            <table border="0" style="font-size:12px">
                <tr>
                    <td style="width:150px; text-align:right">Vehicle Date:</td>
                    <td style="width:250px; text-align:left"><input type="text" style="width:100%;" id="txtVehicleDateTime" class="easyui-datetimebox" required="required" data-options="required:true,showSeconds:false" /></td>
                </tr>
            </table>
        </fieldset>

        <fieldset style="margin-bottom:3px">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                <tr>
                    <td style="width:300px; text-align:right"></td>
                    <td style="width:50px">
                        <a id="btnUpdateVichleTime" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Update</a>
                    </td>
                    <td style="width:50px">
                        <a id="btnVehicleTimeClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

    <div id="winDeliveryChallanAdvanceSearch" class="easyui-window winClass" title="Advance Search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="width:760px; float: left;">
            <table border="0" cellpadding="0" cellspacing="0">
                <tr style="height:330px">
                    <td style="width:850px">
                        <table border="0" cellpadding="0" cellspacing="0">
                            <tr style="height:340px">
                                <td style="width:300px; vertical-align:top;height:330px">
                                    <fieldset style="height:98%;">
                                        <legend style="font-weight:bold; font-size:12px"> Searching Criteria : </legend>
                                        <table border="0" cellpadding="0" cellspacing="2">
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    Challan No:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:350px">
                                                    @Html.TextBox("txtChallanNo", "", new { style = "width: 325px", id = "txtChallanNo" })
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    DO No:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:350px">
                                                    @Html.TextBox("txtDONo", "", new { style = "width: 325px", id = "txtDONo" })
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    PI No:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:350px">
                                                    @Html.TextBox("txtPINo", "", new { style = "width: 325px", id = "txtPINo" })
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    Buyer Name:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    @Html.TextBox("txtBuyerName", "", new { style = "width: 260px;font-size:12px;", id = "txtBuyerName", placeholder = " Type Buyer & Press Enter" }) <input type="button" id="btnBuyerPicker" style="width:60px;" value="Pick" />

                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    Lot No:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:350px">
                                                    @Html.TextBox("txtLotNo", "", new { style = "width: 325px", id = "txtLotNo" })
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px;font-size:12px;">
                                                    Challan Date:
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width:300px">
                                                    <table border="0" cellpadding="0" cellspacing="0">
                                                        <tr>
                                                            <td style="width:97px;font-size:12px;">@Html.DropDownList("cboChallanDate", new SelectList(Enum.GetValues(typeof(ESimSol.BusinessObjects.EnumCompareOperator))), new { id = "cboChallanDate", style = "width: 97px;font-size:12px;", @class = "_select_changeA" })</td>
                                                            <td style="width:97px;font-size:12px;"><input type="text" id="dtChallanDateFrom" value="" style="width: 108px;font-size:12px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                            <td style="width:9px;font-size:12px;" id="enddateT">To</td>
                                                            <td style="width:97px;font-size:12px;" id="enddate"><input type="text" id="dtChallanDateTo" value="" style="width: 108px;font-size:12px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" name="chkApproved" id="chkApproved" /><label style="width:140px;font-size:12px;" onclick="IsChecked()">Approved</label>
                                                    <input type="checkbox" name="chkNotApproved" id="chkNotApproved" /><label style="width:150px;font-size:12px;" onclick="IsChecked()">Not Approved</label>
                                                </td>
                                            </tr>
                                            <tr style="height:70px; vertical-align:bottom">
                                                <td style=" text-align:left; width:330px;">
                                                    <table border="0" cellpadding="0" cellspacing="0">
                                                        <tr>
                                                            <td style=" text-align:left;"><input type="button" value="Reset" id="btnReset" onclick="Reset()" style="width:70px; text-align:left;" /></td>
                                                            <td style=" text-align:right; width:260px;"><input type="button" value="Search" id="btnRefresh" style="width:70px; text-align:right;" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                                <td style="width:400px; vertical-align:top">
                                    <div style="margin-left:0px; margin-top:6px; height:315px">
                                        <table id="tblDeliveryChallansList" title="Delivery Challan List" class="easyui-datagrid" style="width:400px;height:335px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false">
                                            <thead>
                                                <tr>
                                                    <th data-options="field:'Selected',checkbox:true"></th>
                                                    <th field="ChallanNo" width="80">Challan No</th>
                                                    <th field="ChallanDateStr" width="80">Challan Date</th>
                                                    <th field="ChallanStatusStr" width="70">Status</th>
                                                    <th field="ContractorName" width="100">Buyer Name</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </td>

                            </tr>
                        </table>
                    </td>
                </tr>
                <tr style="height:50px">
                    <td style="width:850px; text-align:right">
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="OkButtonClick()">Ok</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="Close()">Close</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="menuMainCollectionTable" id="regionDeliveryChallan">
        <table id="tblDeliveryChallans" title="Delivery Challan List" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
            <thead>
                <tr>
                    <th data-options="field:'Selected',checkbox:true"></th>
                    <th field="ChallanNo" width="10%">Challan No</th>
                    <th field="ChallanTypeStr" width="10%">Challan Type</th>
                    <th field="ChallanDateStr" width="10%">Challan Date</th>
                    <th field="ChallanStatusStr" width="10%">Status</th>
                    <th field="DONo" width="10%">DO No</th>
                    <th field="ContractorName" width="16%">Buyer Name</th>
                    <th field="WUName" width="15%">Store</th>
                    <th field="ApproveByName" width="16%">Approved By</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <input type="text" id="txtByChallanNo" placeholder="Search By Challan No" style="width:150px" />
            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
            <a id="btnWaitforApproval" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-waitforapproval" plain="true" onclick="WaitForApproval()"> Wait For App</a>
            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true">Approve</a>
            <a id="btnAttachment" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-attachment" plain="true" onclick="Attchment()">Attchment</a>
            <a id="btnUpdateVehicleTime" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Update Vehicle Time</a>
            <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
            <a id="btnPreviewRU" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview(Reporting Unit)</a>
            <a id="btnPrintList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print List</a>
        </div>
    </div>

    <script type="text/javascript">
    debugger;
    
    
    var _sBaseAddress="";
    
    $(document).ready(function () {
        debugger;
        var oDeliveryChallans =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        var nProductNature = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ProductNature));
        $('#regionDeliveryChallan').data('ByuerIDs','');
        sessionStorage.setItem("BUID",nBUID);
        sessionStorage.setItem("ProductNature",nProductNature);
        var oNewDeliveryChallans =sessionStorage.getItem("DeliveryChallans");
        if(oNewDeliveryChallans!=null)
        {
            oNewDeliveryChallans = jQuery.parseJSON(oNewDeliveryChallans);
        }
        else
        {
            oNewDeliveryChallans=oDeliveryChallans;
        }
        RefreshList(oNewDeliveryChallans);
        $('#regionDeliveryChallan').data('DeliveryChallans',oNewDeliveryChallans);
        RefreshControlLayout(oAuthorizationRolesMapping);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }


    //Search Property
    $("#btnSearch").click(function () {
        $("#winDeliveryChallanAdvanceSearch").icsWindow('open', "Advance Search");
        $("#winDeliveryChallanAdvanceSearch input").not("input[type='button']").val("");
        $("#winDeliveryChallanAdvanceSearch select").val(0);
        SetTodayDate();
        Reset();
    });

    function SetTodayDate()
    {
        $('#dtChallanDateFrom').datebox('setValue', icsdateformat(new Date()));
        $('#dtChallanDateTo').datebox('setValue', icsdateformat(new Date()));
    }

    $('._select_changeA').change(function () {
        //debugger;
        var x = $("#cboChallanDate").val();
        if (x == "EqualTo" || x == "NotEqualTo" || x == "GreaterThen" || x == "SmallerThen") {
            document.getElementById("enddate").style.display = 'none';
            document.getElementById("enddateT").style.display = 'none';
        }
        else {
            document.getElementById("enddate").style.display = '';
            document.getElementById("enddateT").style.display = '';
        }
        if (x == "None")
        {

            $('#dtChallanDateFrom').datebox('setValue', icsdateformat(new Date()));
            $('#dtChallanDateTo').datebox('setValue', icsdateformat(new Date()));
        }
    });


    ///Contractor Pick
    $("#txtBuyerName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var oContractor = { Params: 2 + '~' + $('#txtBuyerName').val()+'~'+ sessionStorage.getItem("BUID") };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            var intervalID = setInterval(updateProgress, 250);
            $.icsDataGets(obj, function (response) {
                debugger;
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        debugger;
                        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winContractors',
                            winclass: 'clsContractor',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblContractors',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'Name',
                            windowTittle: 'Contractor List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else{
                    alert("Data Not Found.");
                }
            });
        }
    });

    $("#btnBuyerPicker").click(function () {
        var oContractor = { Params: "2~"+'~'+sessionStorage.getItem("BUID") };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            debugger;
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winContractors',
                        winclass: 'clsContractor',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblContractors',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Buyer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });

    });

    $('#txtBuyerName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            $("#txtBuyerName").removeClass("fontColorOfPickItem");
            $('#regionDeliveryChallan').data('ByuerIDs','');
        }
    });

    $('#chkApproved').click(function(){
        if (this.checked) {
            document.getElementById("chkNotApproved").checked = false;
        }
    });

    $('#chkNotApproved').click(function(){
        if (this.checked) {
            document.getElementById("chkApproved").checked = false;
        }
    });
    $('#btnRefresh').click(function () {
            debugger;
            var sChallanNo= $("#txtChallanNo").val();
            var sDONo= $("#txtDONo").val();
            var sPINo = $("#txtPINo").val(); 
            var sLotNo = $("#txtLotNo").val(); 
            var cboChallanDate = document.getElementById("cboChallanDate");
            var nOrderCreateDate=cboChallanDate.options[cboChallanDate.selectedIndex].index;
            var dtFrom=$('#dtChallanDateFrom').datebox('getValue');
            var dtTO=$('#dtChallanDateTo').datebox('getValue');

            var nApproved = 0;
            var nNotApproved = 0;
            if(document.getElementById("chkApproved").checked == true)
            {
                nApproved = 1;
            }
            else
            {
                nApproved = 0;
            }
            if(document.getElementById("chkNotApproved").checked == true)
            {
                nNotApproved = 1;
            }
            else
            {
                nNotApproved = 0;
            }

            if(sChallanNo=="" && sDONo ==""&&sPINo=="" && sLotNo=="" && nOrderCreateDate==0 && $('#regionDeliveryChallan').data('ByuerIDs')=="" && nApproved==0 && nNotApproved==0)
            {
                alert('Please Select a Search Criteria');
                return false;
            }
            var sTempString = sessionStorage.getItem("BUID") +'~'+ sChallanNo +'~'+ sDONo +'~'+ nOrderCreateDate +'~'+dtFrom +'~'+ dtTO +'~'+$('#regionDeliveryChallan').data('ByuerIDs')+'~'+nApproved+'~'+nNotApproved+'~'+sessionStorage.getItem("ProductNature")+'~'+sPINo+'~'+sLotNo;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: '@Url.Action("Gets", "DeliveryChallan")',
            data: { Temp: sTempString },
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                oDeliveryChallans = jQuery.parseJSON(data);
                if (oDeliveryChallans != null)
                {
                    if(oDeliveryChallans.length>0)
                    {
                        RefreshListForSearch(oDeliveryChallans);
                    }
                    else
                    {
                        alert("Data not found!!");
                        RefreshListForSearch([]);
                    }
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    function Reset() {
        debugger;
        $("#txtChallanNo,#txtExportPINo,#txtBuyerName,#txtPINo,#txtLotNo").val('');
        document.getElementById("enddate").style.display = '';
        document.getElementById("enddateT").style.display = '';
        document.getElementById("chkNotApproved").checked = false;
        document.getElementById("chkApproved").checked = false;
        $('#cboChallanDate').val('None');
        SetTodayDate();
        data ="";
        data={"total":""+data.length+"","rows":data};
        $('#tblDeliveryChallansList').datagrid('loadData',data);
        $("#txtBuyerName").removeClass("fontColorOfPickItem");
        $('#regionDeliveryChallan').data('ByuerIDs','');
    }

    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            PickerEvents(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                PickerEvents(oPickerobj);
            }
        });
    }
    function PickerEvents(oPickerobj) {
        var oreturnobj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn)
        {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else
        {
            oreturnobj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winclass == 'clsContractor')
        {
            $('#regionDeliveryChallan').data('ByuerIDs','');
            if (oPickerobj.multiplereturn)
            {
                var ncount = 0;
                var sBuyerIDs="";
                for (var i = 0; i <oreturnobjs.length; i++) {
                    var nSupplierID = oreturnobjs[i].ContractorID;
                    sBuyerIDs = sBuyerIDs + nSupplierID + ',';
                    ncount++;
                }
                if (ncount > 1)
                {
                    $('#txtBuyerName').val("Select " + ncount + " Buyer's");
                } else
                {
                    $('#txtBuyerName').val(oreturnobjs[0].Name);
                }
                sBuyerIDs = sBuyerIDs.substring(0, sBuyerIDs.length - 1);
                $('#regionDeliveryChallan').data('ByuerIDs',sBuyerIDs);

            } else
            {
                $('#txtBuyerName').val(oreturnobj.Name);
                $('#regionDeliveryChallan').data('ByuerIDs',oreturnobj.ContractorID);
                $('#txtBuyerName').focus();
            }
            $("#txtBuyerName").addClass("fontColorOfPickItem");
        }
    }
    function RefreshListForSearch(oSameOrders)
    {
        data =oSameOrders;
        data={"total":""+data.length+"","rows":data};
        $('#tblDeliveryChallansList').datagrid('loadData',data);

    }

    function Close()
    {
        $("#winDeliveryChallanAdvanceSearch").icsWindow('close');
    }

    function OkButtonClick() {
        debugger;
        var oDeliveryChallans=[];
        var oDeliveryChallans = $('#tblDeliveryChallansList').datagrid('getChecked');
        if(oDeliveryChallans.length<=0)
        {
            alert("please select at least one item");
            return;
        }
        RefreshList(oDeliveryChallans);
        $("#winDeliveryChallanAdvanceSearch").icsWindow('close');
    }

    $('#txtByChallanNo').keyup(function (e) {
        var c = String.fromCharCode(e.which);
        var txtByChallanNo = document.getElementById('txtByChallanNo').value;
        var oSearchedDeliveryChallans = [];  var sTempName="";
        var oDeliveryChallans = $('#tblDeliveryChallans').datagrid('getRows');
        if (e.which == 8)
        {
            oDeliveryChallans = $('#regionDeliveryChallan').data('DeliveryChallans');
        }
        for(var i=0;i<oDeliveryChallans.length;++i){
            sTempName=oDeliveryChallans[i].ChallanNo;
            n=sTempName.toUpperCase().indexOf(txtByChallanNo.toUpperCase())
            if(n!=-1)
            {
                oSearchedDeliveryChallans.push(oDeliveryChallans[i]);
            }
        }
        RefreshList(oSearchedDeliveryChallans);
    });

    $("#btnAdd").click(function(){
        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
        sessionStorage.setItem("DeliveryChallans", JSON.stringify(oDeliveryChallans));
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("DeliveryChallanHeader", "Add Delivery Challan");
        sessionStorage.setItem('Action','Add')
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/DeliveryChallan/ViewDeliveryChallan?id=0&buid="+sessionStorage.getItem("BUID");
    });

    $("#btnEdit").click(function(){
        var oDeliveryChallan= $('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || oDeliveryChallan.DeliveryChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oDeliveryChallan.ChallanStatus!=0)
        {
            alert("Please select Only Intialize item from list!");
            return;
        }
        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblDeliveryChallans').datagrid('getRowIndex',oDeliveryChallan);
        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
        sessionStorage.setItem("DeliveryChallans", JSON.stringify(oDeliveryChallans));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("DeliveryChallanHeader", "Edit Delivery Challan");
        sessionStorage.setItem('Action','Edit')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/DeliveryChallan/ViewDeliveryChallan?id="+oDeliveryChallan.DeliveryChallanID+"&buid="+sessionStorage.getItem("BUID");
    });

    $("#btnView").click(function(){
        var oDeliveryChallan= $('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || oDeliveryChallan.DeliveryChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var tsv=((new Date()).getTime())/1000;
        var SelectedRowIndex=$('#tblDeliveryChallans').datagrid('getRowIndex',oDeliveryChallan);
        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
        sessionStorage.setItem("DeliveryChallans", JSON.stringify(oDeliveryChallans));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("DeliveryChallanHeader", "View Delivery Challan");
        sessionStorage.setItem('Action','View')
        sessionStorage.setItem("BackLink", window.location.href);
        window.location.href = _sBaseAddress+  "/DeliveryChallan/ViewDeliveryChallan?id="+oDeliveryChallan.DeliveryChallanID+"&buid="+sessionStorage.getItem("BUID");
    });

    $("#btnDelete").click(function(){
        var oDeliveryChallan= $('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || oDeliveryChallan.DeliveryChallanID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if(parseInt(oDeliveryChallan.ChallanStatus)!=0)
        {
            alert("Please select Only Initialize Item");
            return false;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblDeliveryChallans').datagrid('getRowIndex',oDeliveryChallan);
        if (oDeliveryChallan.DeliveryChallanID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/DeliveryChallan/Delete",
                data: JSON.stringify(oDeliveryChallan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage.toLowerCase() == "deleted")
                    {
                        alert("Delete sucessfully");
                        $('#tblDeliveryChallans').datagrid('deleteRow',SelectedRowIndex);
                        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
                        sessionStorage.setItem("DeliveryChallans", JSON.stringify(oDeliveryChallans));
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });

    $('#btnApprove').click(function(e){
        var oDeliveryChallan = $('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || oDeliveryChallan.DeliveryChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(parseInt(oDeliveryChallan.ChallanStatus)!=0 )
        {
            alert("Please select Only Request for Approval Item From List");
            return;
        }
        var SelectedRowIndex=$('#tblDeliveryChallans').datagrid('getRowIndex',oDeliveryChallan);
        var tsv=((new Date()).getTime())/1000;
        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
        sessionStorage.setItem("DeliveryChallans", JSON.stringify(oDeliveryChallans));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("DeliveryChallanHeader", "Approved Delivery Order");
        sessionStorage.setItem('Action','Approve')
        var oBackLink = window.location.href;
        sessionStorage.setItem("BackLink", oBackLink);
        window.location.href =_sBaseAddress+ "/DeliveryChallan/ViewDeliveryChallan?id="+oDeliveryChallan.DeliveryChallanID+"&buid="+sessionStorage.getItem("BUID");
    });


    function WaitForApproval()
    {
        $.ajax
        ({
            type: "GET",
            dataType: "json",
            url : _sBaseAddress+  "/DeliveryChallan/WaitingSearch",
            data: { nStatusExtra:1, OrderType:_nOrderType },
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oDeliveryChallans = jQuery.parseJSON(data);
                if (oDeliveryChallans.length>0)
                {

                    var  data=oDeliveryChallans;
                    data={"total":""+data.length+"","rows":data};
                    $('#tblDeliveryChallans').datagrid('loadData',data);

                }
                else
                {
                    alert("Data Not found");
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function Attchment()
    {
        var oDeliveryChallan = $('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || parseInt(oDeliveryChallan.DeliveryChallanID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        //EnumAttchRefType : 1 Production Order;2 Delivery Order;3 Delivery Challan
        window.open(_sBaseAddress + '/AttachDocument/Attachment?id='+oDeliveryChallan.DeliveryChallanID+'&RefType=3&OperationInfo= Attachment of Delivery Challan No : '+oDeliveryChallan.ChallanNo, '_blank');
    }

    $('#btnPrintList').click(function(){
      
        var oDeliveryChallans= $('#tblDeliveryChallans').datagrid('getRows');
        if(oDeliveryChallans.length<=0)
        {
            alert("Data not found ");
            return;
        }
        var sDeliveryChallanIDs = "";
        for(var i = 0;i<oDeliveryChallans.length;i++)
        {
            sDeliveryChallanIDs+= oDeliveryChallans[i].DeliveryChallanID+",";
        }
        sDeliveryChallanIDs = sDeliveryChallanIDs.substring(0, sDeliveryChallanIDs.length-1);
        var oDeliveryChallan = {Note:sDeliveryChallanIDs};
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DeliveryChallan/SetDeliveryChallanListData",
            traditional: true,
            data:  JSON.stringify(oDeliveryChallan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open (_sBaseAddress+ "/DeliveryChallan/PrintDeliveryChallans");
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });



    $('#btnPreview').click(function(){
        var oDeliveryChallan=$('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || parseInt(oDeliveryChallan.DeliveryChallanID)<=0)
        {
            alert("Please select Delivery Challan ");
            return;
        }
        window.open(_sBaseAddress+ "/DeliveryChallan/DeliveryChallanPrintPreview?id="+oDeliveryChallan.DeliveryChallanID+"&bIsChallanPrint=true&IsReportingUnit=false");
        window.open(_sBaseAddress+ "/DeliveryChallan/DeliveryChallanPrintPreview?id="+oDeliveryChallan.DeliveryChallanID+"&bIsChallanPrint=false&IsReportingUnit=false");
    });
        
    $('#btnPreviewRU').click(function(){
        var oDeliveryChallan=$('#tblDeliveryChallans').datagrid('getSelected');
        if(oDeliveryChallan==null || parseInt(oDeliveryChallan.DeliveryChallanID)<=0)
        {
            alert("Please select Delivery Challan ");
            return;
        }
        window.open(_sBaseAddress+ "/DeliveryChallan/DeliveryChallanPrintPreview?id="+oDeliveryChallan.DeliveryChallanID+"&bIsChallanPrint=true&IsReportingUnit=true");
        window.open(_sBaseAddress+ "/DeliveryChallan/DeliveryChallanPrintPreview?id="+oDeliveryChallan.DeliveryChallanID+"&bIsChallanPrint=false&IsReportingUnit=true");
    });

    function RefreshList(oDeliveryChallans)
    {
        debugger;
        var data=oDeliveryChallans;
        data={"total":""+data.length+"","rows":data};
        $('#tblDeliveryChallans').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        $('#tblDeliveryChallans').datagrid('selectRow',nIndex);
    }

        //Vehicle Time Update STart
    $('#btnUpdateVehicleTime').click(function(){
        var oDeliveryChallans=$('#tblDeliveryChallans').datagrid('getChecked');
        if(oDeliveryChallans==null || parseInt(oDeliveryChallans.length)<=0)
        {
            alert("Please select Delivery Challan ");
            return;
        }
       
        $("#winVehicleDate").icsWindow('open', "Update Vehicle Date Time");
        $("#winVehicleDate input").not("input[type='button']").val("");
    });
    $('#btnUpdateVichleTime').click(function(e)
    {
        var oDeliveryChallans=$('#tblDeliveryChallans').datagrid('getChecked');
        if(oDeliveryChallans==null || parseInt(oDeliveryChallans.length)<=0)
        {
            alert("Please select Delivery Challan ");
            return;
        }
        
        var oDeliveryChallan = {DeliveryChallans:oDeliveryChallans,VehicleDateTime:$('#txtVehicleDateTime').datetimebox('getValue')};

    $.ajax({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+"/DeliveryChallan/UpdateVehicleTime",
        traditional: true,
        data:  JSON.stringify(oDeliveryChallan),
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            var oDeliveryChallan = jQuery.parseJSON(data);
            if(oDeliveryChallan!=null || (oDeliveryChallan.ErrorMessage=="" || oDeliveryChallan.ErrorMessage==null))
            {
                alert("Update Succesfully");
                $("#winVehicleDate").icsWindow('close');
            }           
        },
        error: function (xhr, status, error) {
            alert(error);
        }
    });

    });
    $('#btnVehicleTimeClose').click(function(e){
        $("#winVehicleDate").icsWindow('close');
    });

     //End




    function RefreshControlLayout(oAuthorizationRolesMapping)
    {
        $('#btnAdd,#btnEdit,#btnDelete,#btnView,#btnReqForApprove,#btnUndoReq,#btnWaitforApproval,#btnApprove,#btnUndoApprove,#btnPreview,#btnPrintList').hide();

        if(PermissionChecker('Add','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnAdd').show();}
        if(PermissionChecker('Edit','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnEdit').show(); }
        if(PermissionChecker('Delete','DeliveryChallan',oAuthorizationRolesMapping)){ $('#btnDelete').show(); }
        if(PermissionChecker('View','DeliveryChallan',oAuthorizationRolesMapping)){  $('#btnView').show();}
        if(PermissionChecker('Add','DeliveryChallan',oAuthorizationRolesMapping)){ $('#btnReqForApprove').show();  }
        if(PermissionChecker('UndoRequest','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnUndoReq').show();  }
        if(PermissionChecker('WaitforApproval','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnWaitforApproval').show();  }
        if(PermissionChecker('Approved','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnApprove,#btnUndoApprove').show();  }
        if(PermissionChecker('Preview','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnPreview').show();  }
        if(PermissionChecker('PrintList','DeliveryChallan',oAuthorizationRolesMapping)){$('#btnPrintList').show();  }

    }

  
    </script>
