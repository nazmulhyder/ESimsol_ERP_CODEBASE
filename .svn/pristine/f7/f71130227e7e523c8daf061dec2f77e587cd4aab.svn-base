@model IEnumerable<ESimSol.BusinessObjects.CapitalResource>

    @{
        ViewBag.Title = "Capital Resource";
    }

    <div style="margin-left:0px; width:100%;" class="menuMainCollectionTable">
        <table id="tblCapitalResource" style="width:896px;height:548px" title="Capital Resource List" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="true" toolbar="#toolbar">
            <thead>
                <tr>
                    <th field="ParentName" width="20%">Resource Type</th>
                    <th field="Name" width="20%">Name</th>
                    <th field="Code" width="15%">Code</th>
                    <th field="Note" width="30%">Note</th>
                    <th field="activity" width="10%">Status</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar" style="height:auto">
                <table>
                    <tr>
                        <td>
                            <a id="btnAddResourcesType" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                            <a id="btnEditResourcesType" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true"></a>
                            <a id="btnDeleteResourcesType" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                            <select id="cboResourcesType" style="height:24px" onchange="SearchByType()"></select>
                            <input type="text" id="txtSearchByCode" placeholder="Search by Code" style="width:120px" />
                            <span style="padding-left:8px;"><input type="text" id="txtSearchByName" placeholder="Search by name" style="width:150px" /></span>
                            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New</a>
                            <a id="btnCopyCapitalResource" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true">Copy</a>
                            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
                            <a id="btnActive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Active</a>
                            <a id="btnDeActive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Inactive</a>
                            <a id="btnAddSpareParts" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Spare Parts</a>
                            @*<a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Spare Parts</a>*@
                            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                            <a id="btnPrintList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print List</a>
                        </td>
                    </tr>
                </table>

            </div>
</div>


    @*...............................Layer Selection...............................*@

    <div id="winLayerSelection" class="easyui-window" title="" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false" style="width:25%;height:auto;padding:1px">
        <div style="margin-left:0px; height:auto; width:100%; text-align:center;">
            <fieldset>


            </fieldset>
            <div style="height:25px; width:100%; background-color:#D8D8D8;text-align:center; vertical-align:middle; font-size:13px; ">
                <strong>Last Layer</strong>
            </div>
            <div style="float:left; width:100%; height:auto;  padding-top:10px;">
                <div style="float:left; width:100%; padding-bottom:5px;">
                    <div style=" float:left; width:50%;text-align:center;"> <input type="radio" id="radioBtnLastlayerYes" />  <span style="padding-left:5px;"> Yes </span>  </div>
                    <div style="float:left; width:50%; text-align:center;"> <input type="radio" id="radioBtnLastlayerNo" />  <span style="padding-left:5px;"> No </span>  </div>
                </div>
            </div>

            <div style="float:left; width:100%; height:auto; text-align:right;  padding-top:5px; padding-bottom:5px;">
                <div style="float:right; padding-right:13%; text-align:right;">
                    <a id="btnLayerSelectionOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                    <a id="btnLayerSelectionClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </div>
            </div>
        </div>
    </div>


    @*...............................Window for Not Last Layer...............................*@

    @*<sup style="color:red">*</sup>*@

    <div id="winResourcesType" class="easyui-window" title="Resource Type" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false" style="width:35%;height:auto;padding:1px">
        <div style="margin-left:0px; height:auto; width:100%; text-align:left;">
            <fieldset>
                <legend>Purpose</legend>
                <div style="float:left; width:100%; height:auto;  padding-top:10px;">
                    <div style="float:left; width:100%; padding-bottom:5px;">
                        <div style=" float:left; width:30%;text-align:right;"> <span style="padding-right:5px;"> Code </span> </div>
                        <div style="float:left; width:70%; text-align:left;"> <input type="text" id="txtCodeNLL" style="width:90%" />  </div>
                    </div>
                    <div style="float:left; width:100%; padding-bottom:5px; ">
                        <div style=" float:left; width:30%;text-align:right;"> <span style="padding-right:5px;"> Name </span> </div>
                        <div style="float:left; width:70%; text-align:left;"> <input type="text" id="txtNameNLL" style="width:90%" /> </div>
                    </div>
                    <div style="float:left; width:100%; padding-bottom:5px; ">
                        <div style=" float:left; width:30%;text-align:right;"> <span style="padding-right:5px;"> Description </span> </div>
                        <div style="float:left; width:70%; text-align:left;"> <input type="text" id="txtNoteNLL" style="width:90%" />  </div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Action</legend>
                <div style="float:left; width:100%; height:auto; text-align:right;">
                    <div style="float:right; padding-right:13%; text-align:right;">
                        <a id="btnSaveResourcesType" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnCloseResourcesType" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>

    @*...............................Window Product Searching ...............................*@
    <div id="winProductSearching" class="easyui-window" title="Product Search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false" style="width:770px; height:auto; padding:1px">

        @*<div style="height:25px;background-color:#D8D8D8;text-align:center; vertical-align:middle; font-size:13px; ">
                <strong><label id="lblHeaderwinProductSearching">Product Searching</label></strong>
            </div>*@
        <div id="id1" style="height:420px;min-width:750px;  padding-top:10px; ">
            <div id="id3" style="float:left; padding-left:15px; width:350px;">
                <table border="0" cellpadding="0" cellspacing="0" style=" width:100%">
                    <tr>
                        <td style="width:100%; height: 410px">
                            <div style="height: 410px; width:100%; overflow: auto; text-align:left;">
                                <ul id="treeProductCategory" data-options="checkbox:true"></ul>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="id4" style="float:left; width:380px">
                <table id="tblProduct" title="Product" class="easyui-datagrid" style="width:370px;height:420px;" rownumbers="true" pagination="false" autorowheight="false" autorowwidth="false">
                    <thead>
                        <tr>
                            <th data-options="field:'Selected',checkbox:true">
                            <th field="ProductNameCode" width="170">Product Name</th>
                            <th field="ProductCategoryName" width="160">Category</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div id="regionLot">
                <table id="tblLot" title="Lot List" class="easyui-datagrid" style="width:440px; height:420px;" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" autorowwidth="false">
                    <thead>
                        <tr>
                            <th field="LotNo" width="100">Lot No</th>
                            <th field="MUName" width="50">Unit</th>
                            <th field="Balance" width="70" align="right">Balance</th>
                            <th field="UnitPrice" width="80" align="right">Unit Price</th>
                            <th field="WorkingUnitName" width="120" align="left">Store</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <div style="float:left; width:100%; height:auto; text-align:right;  padding-top:5px; padding-bottom:10px;">
            <div style=" float:left; width:350px;text-align:right;">
                <a id="btnSearchProduct" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
            </div>
            <div style="float:right; padding-right:2%;  text-align:right;">
                <a id="btnOkProduct" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">ok</a>
                <a id="btnClosewinProductSearching" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                <a id="btnBack" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-back" plain="true">Back</a>
            </div>
        </div>
    </div>


   




    <script type="text/javascript">

    var _oCapitalResources=[];
    var _sBaseAddress="";
    var _bIsLastLayer=false;
    var _oSuppliers=[];
    var _oWUs=[];
    var _oCR=null;
    var _oTCR=null;
    var _nParentID=0;
    var _oCRProductMapping=null;
    var _bIsConsume=false;
    var _nCRID=0;
    var _oCurrencys=[];
    var _oResourcesTypes=[];
    var _sProductIDs="";
    var _bMultiItemsReturnProduct=true;
    var _bIsActiveProductPicker=false;
    var _bIsLotView=false;
    var oTempObj = [];
    var _bMultiItemsReturnProductByName=true;
    var _bIsActiveProductPickerByName=false;
    var _nBUID = 0;
    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oCapitalResources=@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oResourcesTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ResourcesType));


        var oTempCapitalResources =sessionStorage.getItem("CapitalResources");
        if(oTempCapitalResources!=null)
        {
            _oCapitalResources = jQuery.parseJSON(oTempCapitalResources);
        }
            RefreshList(_oCapitalResources);
            $("#cboResourcesType").icsLoadCombo({List: _oResourcesTypes,OptionValue: "CRID",DisplayText: "Name"});
            $('#btnActive').hide();
            $('#btnDeActive').hide();
            $('#tblCapitalResource').datagrid({onClickRow: function(row){ RowSelect(row);}});
            $('#radioBtnLastlayerNo').prop("checked", true);
            $('#radioBtnConsumeNo').prop("checked", true);
            $('#btnEditSparePartsProduct').hide();
            $('#btnViewSparePartsProduct').hide();
        });


        $(document).keydown(function(e) {
            if (e.keyCode == 27) {

                if(_bIsActiveProductPickerByName) { ClosewinProductSearchByName();}
                else if( _bIsActiveProductPicker ){ ClosewinProductSearching(); }
                else{
                    CloseWinLayerSelection();
                    CloseWinLastLayer();
                    ClosewinResourcesType();
                    CloseWinSpareParts();
                }

            }
        });

        function RowSelect(row)
        {
            //debugger;
            if (row.activity== 'Active')
            {
                $('#btnActive').hide();
                $('#btnDeActive').show();

            }
            else if (row.activity== 'Inactive')
            {
                $('#btnActive').show();
                $('#btnDeActive').hide();

            }
        }
        //-----------------------Basic Search--------------------------------------//
        function SearchByType()
        {
            var oData = {
                Code:'',
                Name:'',
                ParentID: $('#cboResourcesType').val(),
                BUID:sessionStorage.getItem("BUID")
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oData,
                ControllerName: "CapitalResource",
                ActionName: "GetCRByNameCodeTypeBUID",
                IsWinClose: false
            };
            BasicSearch(obj);
        }
        $('#txtSearchByCode').keypress(function (e) {
            debugger;
            var oData = {
                Code:document.getElementById('txtSearchByCode').value,
                Name:'',
                ParentID: $('#cboResourcesType').val(),
                BUID:sessionStorage.getItem("BUID")
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oData,
                ControllerName: "CapitalResource",
                ActionName: "GetCRByNameCodeTypeBUID",
                IsWinClose: false
            };
            BasicSearch(obj);
        });
        $('#txtSearchByName').keypress(function (e) {
            debugger;
            var oData = {
                Code:'',
                Name:document.getElementById('txtSearchByName').value,
                ParentID: $('#cboResourcesType').val(),
                BUID:sessionStorage.getItem("BUID")
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oData,
                ControllerName: "CapitalResource",
                ActionName: "GetCRByNameCodeTypeBUID",
                IsWinClose: false
            };
            BasicSearch(obj);
            
        });
        function BasicSearch(obj)
        {
            
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            $.icsDataGets(obj, function (response) {
                $("#progressbarParent").hide();
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].CRID > 0) {
                        $('#tblCapitalResource').datagrid('loadData',[]);
                        $("#tblCapitalResource").datagrid("loadData", response.objs);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
                else{
                    alert("No Capital Resource found.");
                }
            });
        }



        function RefreshList(oCapitalResources)
        {
            data=oCapitalResources;
            data={"total":""+data.length+"","rows":data};
            $('#tblCapitalResource').datagrid('loadData',data);

            var nID =parseInt(sessionStorage.getItem("SelectedRowIndex"));
            if(nID!=-1)
            {
                $('#tblCapitalResource').datagrid('selectRow', nID);
            }
        }

        @*...............................Layer Selection...............................*@

    //$('#btnPrint').click(function(e)
    //{
    //    var oCR = $('#tblCapitalResource').datagrid('getSelected');
    //    if(oCR==null || oCR.id<=0)
    //    {
    //        alert("Please select a item from list!");
    //        return;
    //    }
    //    if(!oCR.IsLastLayer) { alert("Please select a last layer item from list!");return; }
    //    var nts = (new Date().getTime()) / 1000;
    //    window.open(_sBaseAddress +"/CapitalResourceProductMapping/PrintSpareParts?nCRID="+oCR.id+"&nts="+nts , "_blank");
    //});

    $('#btnPrint').click(function(e)
    {
        var oCR = $('#tblCapitalResource').datagrid('getSelected');
        if(oCR==null ||oCR.id<=0) { alert("Please select a valid item");return; }
        var nts = (new Date().getTime()) / 1000;
        window.open(_sBaseAddress +"/CapitalResource/PrintMachine?nCRID="+oCR.CRID+"&nts="+nts , "_blank");
    });
    $('#btnPrintList').click(function(e)
    {
        var nts = (new Date().getTime()) / 1000;
        window.open(_sBaseAddress +"/CapitalResource/PrintMachineList?nBuid="+ _nBUID +"&nts="+nts , "_blank");
    });

    //$('#radioBtnLastlayerYes').click(function(e)
    //{
    //    if(document.getElementById('radioBtnLastlayerYes').checked==true)
    //    {
    //        document.getElementById('radioBtnLastlayerNo').checked=false;
    //        _bIsLastLayer=true;
    //    }
    //});

    //$('#radioBtnLastlayerNo').click(function(e)
    //{
    //    if(document.getElementById('radioBtnLastlayerNo').checked==true)
    //    {
    //        document.getElementById('radioBtnLastlayerYes').checked=false;
    //        _bIsLastLayer=false;
    //    }
    //});

    //$('#btnLayerSelectionOk').click(function (e) {
    //    $('#winLayerSelection').window('close');
    //    if(_bIsLastLayer){ LastLayer(); }
    //    else{ NotLastLayer();  }
    //    document.getElementById('radioBtnLastlayerYes').checked=false;
    //    document.getElementById('radioBtnLastlayerNo').checked=true;
    //    _bIsLastLayer=false;
    //});

    //$('#btnLayerSelectionClose').click(function (e) {
    //    CloseWinLayerSelection();
    //});

    //function CloseWinLayerSelection()
    //{
    //    $('#winLayerSelection').window('close');
    //    document.getElementById('radioBtnLastlayerYes').checked=false;
    //    document.getElementById('radioBtnLastlayerNo').checked=true;
    //    _bIsLastLayer=false;
    //}

    //function LastLayer()
    //{
    //    var oCapitalResources= _oCapitalResources;
    //    var sURL=window.location.href;
    //    sessionStorage.setItem("CapitalResourceBackTo", sURL);
    //    sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources));
    //    sessionStorage.setItem("SelectedRowIndex", -1);
    //    sessionStorage.setItem("CapitalResourceHeader", "Add Capital Resource");
    //    sessionStorage.setItem("BUID", _nBUID);
    //    sessionStorage.setItem("ParentID", _oCR.id);
    //    var tsv=((new Date()).getTime())/1000;
    //    window.location.href = _sBaseAddress+ "/CapitalResource/ViewCapitalResource?id=0&BUID="+_nBUID+"&ts="+tsv;
    //}

    //function NotLastLayer()
    //{
    //    _oCR=null;
    //    SetControllEnabledNotLastLayer();
    //    ResetCapitalResourceInformationNotLastLayer();
    //    $('#winResourcesType').window('open');
    //}

    @*...............................Capital Resource...............................*@

    $("#cboWarrantyOn").change(function(e)
    {
        if ($("#txtWarrantyPeriod").val()>0)
        {
            var oStartDate=new Date($('#txtWarrantyStartDate').datebox('getValue'));
            //alert(icsdateformat(oStartDate));
            if($("#cboWarrantyOn").val()=="Year") { oStartDate.setFullYear(oStartDate.getFullYear()+parseInt($("#txtWarrantyPeriod").val())); }
            else{ oStartDate.setMonth(oStartDate.getMonth() +parseInt($("#txtWarrantyPeriod").val())); }
            $('#txtWarrantyEndDate').datebox('setValue', icsdateformat(oStartDate));
        }

    });

    $('#txtWarrantyStartDate').datebox({
        onSelect: function(date){

            if ($("#txtWarrantyPeriod").val()>0)
            {

                var oStartDate=new Date(date);
                if($("#cboWarrantyOn").val()=="Year") { oStartDate.setFullYear(oStartDate.getFullYear()+parseInt($("#txtWarrantyPeriod").val())); }
                else{ oStartDate.setMonth(oStartDate.getMonth() +parseInt($("#txtWarrantyPeriod").val())); }
                $('#txtWarrantyEndDate').datebox('setValue', icsdateformat(oStartDate));
            }
            else
            {
                $('#txtWarrantyStartDate').datebox('setValue', '');
                $('#txtWarrantyEndDate').datebox('setValue', '');
                alert("Please Insert warranty period!!!");
            }

        }
    });

    $('#btnAddResourcesType').click(function (e) {
        debugger;
        $('#winResourcesType').window('open');
    });
    $('#btnEditResourcesType').click(function (e) {
        debugger;
        if($('#cboResourcesType').val()==0)
        {
            alert("Please Select Any Resource Type !!");
            $('#cboResourcesType').focus();
            return;
        }
        var ResourceTypeID = $('#cboResourcesType').val();
        for(var count=0; count<_oResourcesTypes.length; count++)
        {
            if(ResourceTypeID == _oResourcesTypes[count].CRID)
            {
                oTempObj = _oResourcesTypes[count];
            }
        }

        $('#winResourcesType').window('open');
        $('#txtCodeNLL').val(oTempObj.Code);
        $('#txtNameNLL').val(oTempObj.Name);
        $('#txtNoteNLL').val(oTempObj.Note);
    });
    $('#btnDeleteResourcesType').click(function (e) {
        debugger;
        if($('#cboResourcesType').val()==0)
        {
            alert("Please Select Any Resource Type !!");
            $('#cboResourcesType').focus();
            return;
        }
        if (!confirm("Confirm to Delete?")) return;

        var ResourceTypeID = $('#cboResourcesType').val();
        for(var count=0; count<_oResourcesTypes.length; count++)
        {
            if(ResourceTypeID == _oResourcesTypes[count].CRID)
            {
                oTempObj = _oResourcesTypes[count];
            }
        }
        var nts=(new Date()).getTime()/1000;
        if (oTempObj.CRID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/CapitalResource/Delete",
                data: JSON.stringify({ nCRID: oTempObj.CRID, nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var sMessage = jQuery.parseJSON(data);
                    if (sMessage == "Delete Successfully.")
                    {
                        alert(sMessage);
                        $("#cboResourcesType option:selected").remove();
                    }
                    else
                    {
                        alert(sMessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
        else { alert("Please select a valid item from list.");}
    });







    $('#btnAdd').click(function (e) {
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        if($('#cboResourcesType').val()==0)
        {
            alert("Please Select Any Resource Type !!");
            $('#cboResourcesType').focus();
            return;
        }
        var oCapitalResources= $('#tblCapitalResource').datagrid('getRows');
        sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources)); 
        sessionStorage.setItem("SelectedRowIndex", -1);   
        sessionStorage.setItem("CapitalResourceHeader", "Add Capital Resource");
        sessionStorage.setItem("ParentID", $('#cboResourcesType').val());
        sessionStorage.setItem("BackLink", window.location);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/CapitalResource/ViewCapitalResource?id=0&nBUID="+_nBUID+"&bIsCopy=false&ts="+tsv;
    });
    $('#btnCopyCapitalResource').click(function(e){
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        if(oCapitalResource==null || oCapitalResource.CRID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        debugger;
        if(oCapitalResource.Name.slice(-5) == "-copy")
        {
            alert("You Can't Copy From a Copy Item !! Edit And Rename First !!");
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/CapitalResource/Copy",
            traditional: true,
            data:  JSON.stringify(oCapitalResource),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oCR = jQuery.parseJSON(data);
                if (oCR.ErrorMessage=="" || oCR.ErrorMessage==null)
                {
                    debugger;
                    alert("Copied sucessfully");
                    $('#tblCapitalResource').datagrid('appendRow', oCR);
                    var nIndex = $('#tblCapitalResource').datagrid('getRows').length;
                    $('#tblCapitalResource').datagrid('selectRow', nIndex);
                }
                else
                {
                    alert(oCR.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });


    });

    $('#btnEdit').click(function (e) {
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        if(oCapitalResource==null || oCapitalResource.CRID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var oCapitalResources= $('#tblCapitalResource').datagrid('getRows');
        var SelectedRowIndex=$('#tblCapitalResource').datagrid('getRowIndex',oCapitalResource);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);   
        sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources)); 
        sessionStorage.setItem("CapitalResourceHeader", "Edit Capital Resource");
        sessionStorage.setItem("ParentID", oCapitalResource.parentid);
        sessionStorage.setItem("BackLink", window.location);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/CapitalResource/ViewCapitalResource?id="+oCapitalResource.CRID+"&nBUID="+_nBUID+"&bIsCopy=false&ts="+tsv;
    });
    $('#btnDelete').click(function (e) {
        debugger;
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        var SelectedRowIndex=$('#tblCapitalResource').datagrid('getRowIndex',oCapitalResource);
        if(oCapitalResource==null || oCapitalResource.CRID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return;
        var nts=(new Date()).getTime()/1000;
        if (oCapitalResource.CRID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/CapitalResource/Delete",
                data: JSON.stringify({ nCRID: oCapitalResource.CRID, nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var sMessage = jQuery.parseJSON(data);
                    if (sMessage == "Delete Successfully.")
                    {
                        alert(sMessage);
                        $('#tblCapitalResource').datagrid('deleteRow',SelectedRowIndex);
                        var oCapitalResources= $('#tblCapitalResource').datagrid('getRows');
                        sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources)); 
                    }
                    else
                    {
                        alert(sMessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
        else { alert("Please select a valid item from list.");}
    });
    $('#btnView').click(function (e) {
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        if(oCapitalResource==null || oCapitalResource.CRID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var oCapitalResources= $('#tblCapitalResource').datagrid('getRows');
        var SelectedRowIndex=$('#tblCapitalResource').datagrid('getRowIndex',oCapitalResource);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);   
        sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources)); 
        sessionStorage.setItem("CapitalResourceHeader", "View Capital Resource");
        sessionStorage.setItem("ParentID", oCapitalResource.parentid);
        sessionStorage.setItem("BackLink", window.location);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/CapitalResource/ViewCapitalResource?id="+oCapitalResource.CRID+"&nBUID="+_nBUID+"&bIsCopy=false&ts="+tsv;
    });



    $('#btnAddSpareParts').click(function (e) {
        var oCapitalResource= $('#tblCapitalResource').datagrid('getSelected');
        if(oCapitalResource==null || oCapitalResource.CRID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var oCapitalResources= $('#tblCapitalResource').datagrid('getRows');
        var SelectedRowIndex=$('#tblCapitalResource').datagrid('getRowIndex',oCapitalResource);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);   
        sessionStorage.setItem("CapitalResources", JSON.stringify(oCapitalResources)); 
        sessionStorage.setItem("CapitalResourceHeader", "Edit Capital Resource");
        sessionStorage.setItem("ParentID", oCapitalResource.parentid);
        sessionStorage.setItem("BackLink", window.location);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/CRWiseSpareParts/ViewCRWiseSparePartss?nCRID="+oCapitalResource.CRID+"&nBUID="+_nBUID;
    });

    


    $('#btnActive').click(function (e)
    {
        ActivityChange(true);
    });

    $('#btnDeActive').click(function (e)
    {
        ActivityChange(false);
    });

    function ActivityChange(bIsActive)
    {
        var oTCR= $('#tblCapitalResource').datagrid('getSelected');
        if(oTCR==null || oTCR.id<=0){ alert("Please select a valid item from list."); return;}

        if (!confirm("Are you sure to change activity.")) return ;

        var nts=(new Date()).getTime()/1000;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/CapitalResource/ActivityChange",
            traditional: true,
            data:  JSON.stringify({nCRID:oTCR.id,bIsActive:bIsActive,nts:nts}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oCR = jQuery.parseJSON(data);
                if (oCR.CRID>0)
                {
                    if(bIsActive){ alert("Active sucessfully"); }
                    else{  alert("Inactive sucessfully");  }
                    var oTCR=GenerateTreeobject(oCR, oCR.IsLastLayer);
                    $('#tblCapitalResource').datagrid('update',{ id: oTCR.id, row: oTCR });
                }
                else
                {
                    alert(oCR.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }

    @*............................ Not Last Layer ..........................................*@


    $('#btnSaveResourcesType').click(function (e) {
        if (!ValidationNotLastLayer()) { return; }
        var oCR =RefreshObjectResourceType();
        SaveResourceType(oCR,false);
    });

    $('#btnCloseResourcesType').click(function (e) {

        ClosewinResourcesType();

    });
    function ClosewinResourcesType()
    {
        ResetCapitalResourceInformationNotLastLayer();
        $('#winResourcesType').window('close');
    }

    function SetControllEnabledNotLastLayer()
    {
        $('#txtNameNLL').prop('disabled', false);
        $('#txtCodeNLL').prop('disabled', false);
        $('#txtNoteNLL').prop('disabled', false);
        $('#btnSaveResourcesType').show();

    }

    function SetControllDisabledNotLastLayer()
    {

        $('#txtNameNLL').attr('disabled','disabled');
        $('#txtCodeNLL').attr('disabled','disabled');
        $('#txtNoteNLL').attr('disabled','disabled');
        $('#btnSaveResourcesType').hide();

    }

    function SetCapitalResourceInformationNotLastLayer(oCR)
    {
        _oCR = oCR;
        $('#txtNameNLL').val(oCR.Name);
        $('#txtCodeNLL').val(oCR.Code);
        $('#txtNoteNLL').val(oCR.Note);
    }

    function ResetCapitalResourceInformationNotLastLayer()
    {
        _oCR = null;
        $('#txtNameNLL').val("");
        $('#txtCodeNLL').val("");
        $('#txtNoteNLL').val("");
    }

    function ValidationNotLastLayer()
    {
        if ($.trim($('#txtNameNLL').val()) == '') { alert("Please enter name."); $('#txtNameNLL').focus(); return false; }
        else if ($.trim($('#txtCodeNLL').val()) == '') { alert("Please enter code."); $('#txtCodeNLL').focus(); return false; }
        else { return true; }
    }

    function RefreshObjectResourceType()
    {

        var oCR= {
            CRID :  (oTempObj != null) ? oTempObj.CRID : 0,
            CRGID : (_oCR != null) ? _oCR.CRGID : 1,
            Name : $("#txtNameNLL").val(),
            Code: $("#txtCodeNLL").val(),
            ParentID: 1,
            BUID:_nBUID,
            IsLastLayer: false,
            IsActive:true,
            Note : $("#txtNoteNLL").val()
        };
        return oCR;
    }


    @*............................ Save , Get View & Generate Tree obj ..........................................*@

    function SaveResourceType(oCR,bIsLastLayer)
    {
        var bISNew = oCR.CRID>0?false:true;
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/CapitalResource/Save",
            traditional: true,
            data:  JSON.stringify(oCR),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                oCR = jQuery.parseJSON(data);
                if (oCR.CRID>0) {
                    alert("Data Saved sucessfully");
                    if (bISNew)
                    {
                        _oResourcesTypes.push(oCR);
                        $("#cboResourcesType").icsLoadCombo({List: _oResourcesTypes,OptionValue: "CRID",DisplayText: "Name"});
                    }
                    else
                    {
                        for(var i = 0; i< _oResourcesTypes.length; i++)
                        {
                            if(oCR.CRID == _oResourcesTypes[i].CRID)
                            {
                                _oResourcesTypes[i] = oCR;
                                $("#cboResourcesType").icsLoadCombo({List: _oResourcesTypes,OptionValue: "CRID",DisplayText: "Name"});
                            }
                        }
                    }
                    $('#winResourcesType').window('close');
                    oTempObj = null;
                }
                else
                {
                    alert(oCR.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function GenerateTreeobject(oCR, bIsLastLayer)
    {

        var oTCR={
            id : oCR.CRID,
            text : oCR.Name,
            state : '',
            IsLastLayer : (!bIsLastLayer)? false: true,
            parentid : oCR.ParentID,
            code : oCR.Code,
            Note : oCR.Note,
            activity: oCR.ActivityInStr
        };
        return oTCR;
    }

    function GetCapitalResource(nCRID, sMode)
    {
        var nts= (new Date()).getTime()/1000;
        $.ajax
        ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/CapitalResource/Get",
            data: JSON.stringify({ nCRID: nCRID, nts:nts}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oCR = jQuery.parseJSON(data);
                if (oCR.CRID>0)
                {
                    if(sMode=="Edit"){ SetControllEnabledNotLastLayer(); }
                    else if(sMode=="View"){ SetControllDisabledNotLastLayer(); }
                    SetCapitalResourceInformationNotLastLayer(oCR) ;
                    $('#winResourcesType').window('open');

                }
                else
                {
                    alert("No information found.");
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }

        });
    }


    @*............................  Spare part ..........................................*@

    $('#radioBtnConsumeYes').click(function(e)
    {
        if(document.getElementById('radioBtnConsumeYes').checked==true)
        {
            document.getElementById('radioBtnConsumeNo').checked=false;
            _bIsConsume=true; _bIsConsume
        }
    });

    $('#radioBtnConsumeNo').click(function(e)
    {
        if(document.getElementById('radioBtnConsumeNo').checked==true)
        {
            document.getElementById('radioBtnConsumeYes').checked=false;
            _bIsConsume=false;
        }
    });

    function LoadIntoCRProductMappingGrid(oCRProductMappings)
    {
        data=oCRProductMappings;
        data={"total":""+data.length+"","rows":data};
        $('#tblCapitalResourceProductMapping').datagrid('loadData',data);
    }

    $('#btnEditSparePartsProduct').click(function (e) {
        var oCRProductMapping = $('#tblCapitalResourceProductMapping').datagrid('getSelected');
        if (oCRProductMapping != null) {SetControllEnabledSpareParts();  SetInformationSpareParts(oCRProductMapping); }
        else { alert("Please select an item from list."); return; }
    });

    $('#btnViewSparePartsProduct').click(function (e) {
        var oCRProductMapping = $('#tblCapitalResourceProductMapping').datagrid('getSelected');
        if (oCRProductMapping != null) { SetControllDisabledSpareParts();  SetInformationSpareParts(oCRProductMapping); }
        else { alert("Please select an item from list."); return; }
    });


    function CloseWinSpareParts()
    {
        _nCRID=0;
        ResetInformationSpareParts();
        $('#winSpareParts').window('close');
    }

    function SetControllEnabledSpareParts()
    {
        $('#txtProductName').prop('disabled', false);
        $('#cboProduct').prop('disabled', false);

        //$('#btnSaveSparePartsProduct').show();

    }

    function SetControllDisabledSpareParts()
    {

        $('#txtProductName').prop('disabled', 'disabled');
        $('#cboProduct').prop('disabled', 'disabled');

        //$('#btnSaveSparePartsProduct').hide();

    }

    function SetInformationSpareParts(oCRProductMapping)
    {
        _oCRProductMapping = oCRProductMapping;
        //$('#txtProductName').val(oCRProductMapping.ProductName);
    }

    function ResetInformationSpareParts()
    {

        _oCRProductMapping = null;
        $('#txtProductName').val("");
        $('#cboProduct').empty();

        $('#radioBtnConsumeNo').prop("checked", true);
        $('#radioBtnConsumeYes').prop("checked", false);
        _bIsConsume=false;
        _sProductIDs="";
    }

    function ValidationSpareParts()
    {
        if(_nCRID<=0){ alert('Please select a capital resource.');   ResetInformationSpareParts(); $('#winSpareParts').window('close'); return;}
        else if($.trim(_sProductIDs)==""){ alert('No product found. Please pick a product.');   $('#txtProductName').focus(); return false; }
        else { return true; }
    }

    function RefreshObjectSpareParts()
    {

        var oCRProductMapping= {
            CRPMID :  (_oCRProductMapping != null) ? _oCRProductMapping.CRPMID : 0,
            CRID : (_oCRProductMapping != null) ? _oCRProductMapping.CRID : _nCRID,
            ProductID:0,
            Note:'',
            IsConsume: _bIsConsume
        };
        return oCRProductMapping;
    }

    function SaveResourceTypeProduct(oCRProductMapping,nSelectedRowIndex)
    {

        var bISNew=oCRProductMapping.CRPMID>0?false:true;
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/CapitalResourceProductMapping/SaveCRProductMapping",
            traditional: true,
            data:  JSON.stringify({oCRProductMapping:oCRProductMapping, sProductIDs:_sProductIDs}),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oCRProductMappings = jQuery.parseJSON(data);
                if ( oCRProductMappings.length>0 && oCRProductMappings[0].CRPMID>0)
                {
                    alert("Data Saved sucessfully");
                    if (!bISNew)
                    {
                        $('#tblCapitalResourceProductMapping').datagrid('updateRow', { index: nSelectedRowIndex, row: oCRProductMapping });
                    }
                    else
                    {
                        for(var i=0;i<oCRProductMappings.length;i++)
                        {
                            $('#tblCapitalResourceProductMapping').datagrid('appendRow', oCRProductMappings[i]);
                        }
                        var nIndex = $('#tblCapitalResourceProductMapping').datagrid('getRows').length;
                        $('#tblCapitalResourceProductMapping').datagrid('selectRow', nIndex);
                    }
                    ResetInformationSpareParts();
                }
                else
                {
                    alert((oCRProductMappings[0].ErrorMessage==""||oCRProductMappings[0].ErrorMessage==null)?"Unable to save":oCRProductMappings[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }

    </script>
