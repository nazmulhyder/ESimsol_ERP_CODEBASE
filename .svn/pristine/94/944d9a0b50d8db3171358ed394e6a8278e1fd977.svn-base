<html>
<head>
    <link href="@Url.Content("~/Content/CSS/icon.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/easyui.css")" rel="stylesheet" type="text/css" /> 
    <link href="@Url.Content("~/Content/CSS/Pikerstyle.css")" rel="stylesheet" type="text/css" />  

    <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>            
    <script src="@Url.Content("~/Scripts/jquery.ics.customize.js")" type="text/javascript"></script>  
    <script src="@Url.Content("~/Scripts/jquery.easyui.min.js")" type="text/javascript"></script>    

    <script src="@Url.Content("~/Scripts/jquery-ui.min.js")" type="text/javascript"></script> 
    <script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script> 
</head>
<body>
    @model ESimSol.BusinessObjects.PTUTransection
<div style="font-family: Tahoma">
    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold;
        color: #000000;">
        <tr>
            <td style="background-color: #CFB53B; text-align: center; width: 695px; color: White">
                <label id="lblHeaderName" style="font-size: 15px; font-weight: bold; text-decoration: Underline">
                </label>
            </td>
        </tr>
    </table>
    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold;
        color: #000000;">
        <tr>
            <td style="text-align: right;">
                Style No:
            </td>
            <td style="width: 100px;">
                <input id="txtStyleNo" type="text" readonly="readonly" style="width: 125px; margin-left: 10px;
                    margin-top: 5px;" />
            </td>
            <td style="text-align: right;">
                Operation Date:
            </td>
            <td style="width: 100px;">
                <input id="txtKnittingDate" type="text" readonly="readonly" style="width: 125px;
                    margin-left: 10px; margin-top: 5px;" />
            </td>
            <td style="text-align: right;">
                Production Order No:
            </td>
            <td style="width: 100px">
                <input id="txtProductionOrderNo" type="text" readonly="readonly" style="width: 125px;
                    margin-left: 10px; margin-top: 5px;" />
            </td>
        </tr>
    </table>
    <table id="tblPTU" title="Order Details" class="easyui-datagrid" style="width: 695px;
        height: 220px" data-options="
                    singleSelect: true,
                    fitColumns:true,
                    rownumbers:true,
                    pagination:false,
                    autoRowHeight:false,
                    onClickRow: onClickRow
                ">
        <thead style="font-size: 11px; font-weight: bold">
            <tr>
                <th field="ColorName" width="160" align="left">
                    Color Name
                </th>
                <th field="MeasurementUnitName" width="50" align="left">
                    Unit
                </th>
                <th width="80" align="right" data-options="field:'Quantity',editor:{type:'numberbox',options:{precision:2}}">Quantity</th>

                <th field="OperationBy" width="110" align="right">
                    Follow-Up By
                </th>
                <th field="OperationDateTimeInString" width="80" align="right">
                    Operation Time
                </th>
            </tr>
        </thead>
    </table>
    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 13px; font-weight: bold; color: #000000;">
        <tr>
            <td style="width: 330px; text-align: right;">
                Gross Total:
            </td>
            <td style="width: 80px; text-align: right">
                <label id="lblTotalKnittingQty" style="font-size: 12px; font-weight: bold">
                    0
                </label>
            </td>
        </tr>
    </table>
    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold;
        color: #000000;">
        <tr>
            <td style="width: 575px; text-align: right;"><a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save"  id="btnSave" plain="true" onclick="Save()">Save</a></td>
            <td style="width: 80px"><a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true"onclick="Close()">Close</a></td>
        </tr>
    </table>
</div>
</body>
</html>
<script type="text/javascript">
    var _oPTUTransections = [];
    var _oPTUTransaction = null;
    var _sBaseAddress = null;
    $(document).ready(function ()
    {
        debugger;
        _oPTUTransaction = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oPTUTransections =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.PTUTransections));
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress])); 
        RefreshListOrderDetials(_oPTUTransections);
        InputBoxLoad(_oPTUTransections);
        var obj = window.dialogArguments;
        document.getElementById('lblHeaderName').innerHTML=obj.Name;
        if(obj.OperationName =="View")
        {
            document.getElementById('btnSave').style.display = 'none';
        }
    });

    function RefreshListOrderDetials(_oPTUTransections) {
        debugger;
        var data = _oPTUTransections;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblPTU').datagrid('loadData', data);
        RefreshSummary();
    }


    var editIndex = undefined;
    function endEditing(){
        if (editIndex == undefined){return true}
        if ($('#tblPTU').datagrid('validateRow', editIndex)){
            debugger;
            $('#tblPTU').datagrid('endEdit', editIndex);
            $('#tblPTU').datagrid('selectRow',editIndex);
            RefreshSummary();
            editIndex  = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }

    function onClickRow(index){

        if (editIndex != index){
            if (endEditing())
            {
                $('#tblPTU').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                editIndex  = index;
            }
            else
            {
                $('#tblPTU').datagrid('selectRow', editIndex);
            }
        }
    }


    function RefreshSummary()
    {
        debugger;
        var oPTUs = $('#tblPTU').datagrid('getRows');

        var nTodayKnittingQty = 0;
        for (var i = 0; i < oPTUs.length; i++)
        {
            nTodayKnittingQty = nTodayKnittingQty + parseInt(oPTUs[i].Quantity);
        }
        document.getElementById("lblTotalKnittingQty").innerHTML = nTodayKnittingQty;

    }

    function InputBoxLoad(_oPTUTransections) {
        debugger;
        document.getElementById("txtStyleNo").value = _oPTUTransections[0].StyleNo;
        document.getElementById("txtKnittingDate").value = _oPTUTransections[0].OperationDateInString;
        document.getElementById("txtProductionOrderNo").value = _oPTUTransections[0].ProductionOrderNo;
    }
    function Save()
    {
        endEditing();
        var oPTUTransection ={
            PTUTransections:$('#tblPTU').datagrid('getRows')
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionManagement/UpdatePTUTransaction",
            traditional: true,
            data:  JSON.stringify(oPTUTransection),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oPTUTransection= jQuery.parseJSON(data);
                if (oPTUTransection.ErrorMessage=="" || oPTUTransection.ErrorMessage==null)
                {
                    alert("Data Save Successfully!!");
                    RefreshListOrderDetials(oPTUTransection.PTUTransections);
                    var oPTUTransaction = {Quantity :GetTotalQty()};
                    window.returnValue = oPTUTransaction;
                    window.close();
                }
                else
                {
                    alert(oPTUTransection.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });

    }

    function GetTotalQty()
    {
        var nTotalQty = 0;
        var oPTUTransactions = $('#tblPTU').datagrid('getRows');
        for(var i = 0; i<oPTUTransactions.length;i++)
        {
            nTotalQty +=parseFloat( oPTUTransactions[i].Quantity);
        }
        return nTotalQty;
    }

    function Close()
    {
        window.close();
    }




    $(document).keydown(function(e) {
        //debugger;
        if(e.which == 27)//escape=27
        {
            //debugger;
            window.close();
        }
    });

</script>
