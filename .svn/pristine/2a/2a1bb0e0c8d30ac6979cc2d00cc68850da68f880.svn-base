@model IEnumerable<ESimSol.BusinessObjects.EmployeeSettlementClearance>
@{
    ViewBag.Title = "Employee Settlement Clearance";
}
@{var MenuID = HttpContext.Current.Session[SessionInfo.MenuID];}
<div class="menuMainCollectionTable" style="margin-left:0px; height:auto; width:100%">
    @*<fieldset style="width:96%; height:540px;">
    <legend>Employee Settlement</legend>*@
    @Html.Raw(File.ReadAllText(Server.MapPath("~/Views/Employee/EmpPicker.html")))
    @Html.Raw(File.ReadAllText(Server.MapPath("~/Views/Department/DepartmentPicker.html")))
        <table style="width:100%">
            <tr style="width:100%">
                <td colspan="3" style="width:100%">
                    <table id="tblEmployeeSettlements" class="easyui-datagrid" title="Employee Settlement" style="width:100%;height:560px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#ListToolbar"> <!--selectoncheck="false" checkonselect="false" --> 
                        <thead style="width:100%">
                            <tr style="width:100%">
                                @*<th data-options="field:'Selected',checkbox:true">*@
                                <th field="EmployeeCode" width="130" align="left">Code</th>
                                <th field="EmployeeName" width="140" align="left">Name</th>
                                <th field="SettlementTypeInString" width="140" align="left">Sett. Type</th>
                                <th field="SubmissionDateInString" width="120" align="left">Submission Date</th>
                                <th field="EffectDateInString" width="120" align="left">Last Working Day</th>
                                <th field="ApproveByName" width="120" align="left">Approve By</th>
                                <th field="Reason" width="150" align="left">Reason</th>
                            </tr>
                        </thead>
                    </table>
                </td>
            </tr>
        </table>

    <div id="ListToolbar" style="height:auto;">
        <input id="dtStartDate" type="text" style="width:98px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
        To
        <input id="dtEndDate" type="text" style="width:98px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
        <select id="cboSettlementType" style="width:11%;"></select>
       
        <input id="txtBusinessUnit_Collection" type="text" style="width:14%;" placeholder="Pick Business Unit" />
        <a id="btnBusinessUnitPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetBusinessUnitPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtLocation_Colection" style="width:14%;" placeholder="Pick Location" type="text" />
        <a id="btnLocationPicker_Colection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetLocationPicker_Colection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtDepartment_Collection" style="width:14%;" type="text" placeholder="Pick Department" />
        <a id="btnDepartmentPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetDepartmentPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <br />
        <input id="txtDesignation_Collection" type="text" style="width:14%;" placeholder="Pick Designation" />
        <a id="btnDesignationPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnResetDesignationPicker_Collection" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="txtEmployee_Collection" style="width:14%;" type="text" placeholder="Type Code & Enter" />
        <a id="btnEmployee" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-pick"></a>
        <a id="btnCEmployee" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-clear"></a>

        <input id="chkApprove" type="checkbox" /> Approve
        <input id="chkUnApprove" type="checkbox" /> UnApprove
        <select id="cboClearanceStatus_Search" style="width:10%;"></select>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-search" onclick="SearchWithCriteria()"></a>

         <select id="cboPrintType">
        </select>
        <input type="checkbox" id="chkDept" /> <label id="lblDept">By Dept</label>
        <a id="btnXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true"></a>
        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true"></a>
    </div>

    @*<div id="EmployeeSettlementClearanceToolbar" style="height:auto;">
        <a id="btnSendInitially" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-forword">Send</a>
        <a id="btnRefreshEmployeeSettlementClearance" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true"></a>
    </div>

    <div id="EmployeeSettlementClearanceHistoryToolbar" style="height:auto;">
        <select id="cboClearanceStatus" style="width:25%;"></select>
        <input id="txtNote" type="text" style="width:60%" placeholder="Note" />
        <a id="btnSendHistory" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-forword" onclick="EmployeeSettlementClearanceSave()"></a>
    </div>*@
   
    <div id="winLocationPicker" class="easyui-window winstyle" title="Location Picker" style="width:350px; height:400px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <div class="easyui-panel" style="width:335px;height:300px;overflow:auto">
                <ul id="locationtree" data-options="checkbox:true" singleselect="false"></ul>
            </div>

            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:400px; text-align:right"></td>

                        <td style="width:50px">
                            <a id="btnLocationPickerOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="OkButtonClick()">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnLocationPickerClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <div id="winDepartmentPicker_Collection" class="easyui-window winstyle" title="Department Picker" style="width:350px; height:400px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <div class="easyui-panel" style="width:335px;height:300px;overflow:auto">
                <ul id="departmenttree_Collection" data-options="checkbox:true" singleselect="false"></ul>
            </div>
            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:400px; text-align:right"></td>

                        <td style="width:50px">
                            <a id="btnDepartmentPickerOk_Collection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnDepartmentPickerClose_Collection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>

    <div id="winClearanceSetUp" class="easyui-window winstyle" title="Send To" style="width:400px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <table id="tblEmployeeSettlementClearanceSetup" class="easyui-datagrid"  style="width:100%;height:280px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#toolbar">
                <thead style="width:100%">
                    <tr style="width:100%">
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th field="EmployeeCode" width="110" align="left">Code</th>
                        <th field="EmployeeName" width="110" align="left">Name</th>
                        <th field="SectionName" width="110" align="left">Department</th>
                    </tr>
                </thead>
            </table>
            <fieldset>
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:400px; text-align:right"></td>

                        <td style="width:50px">
                            <a id="btnInitiallySendOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-forword" plain="true">Send</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnInitiallySendClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>
<style type="text/css">
    .lblStar {
        color: #ff0000;
        font-weight: bold;
    }

    .tbl-AdvSearch {
        width: 100%;
        font-size: 11px;
        font-weight: bold;
        text-align: left;
        margin-left: 3px;
    }

    .td-AdvSearch-Level {
        text-align: right;
    }

    .td-AdvSearch-Input {
        text-align: left;
    }

    .txtfield-search {
        width: 312px;
        text-align: left;
        font-size: 11px;
    }

    .txtfield-picker {
        width: 265px;
        text-align: left;
        font-size: 11px;
    }

    .selection-search {
        width: 310px;
        text-align: left;
        font-size: 11px;
    }

    .pick-btn {
        width: 20px;
        text-align: center;
        font-size: 11px;
    }
</style>

<script type="text/javascript">
    var _oEmployeeSettlementClearances=[];
    var _nESCSID=0;
    var _sBaseAddress="";
    var _nMenuid=0;

    var _oEmployeeTypes=[];
    var _oShifts=[];
    var _oEmployeeCSs=[];
    var _oEmployeeWSs=[];
    var _oBusinessUnits=[];
    var _oEmployeeCategorys=[];

    var _sBusinessUnitIds = "";
    var _sDepartmentNames = "";
    var _sDepartmentIds = "";
    var _sDesignationNames = "";
    var _sDesignationIds = "";
    var _sAttendanceSchemeID="";
    var _sLocationID = "";
    var _sBlockNames = "";
    var _sBMMIDs = "";

    var _nLastEmployeeID = 0;
    var _bNext = false;
    var _nLoadRecords = 0;
    var _nRowLength = 0;
    var _sEmployeeIDs="";

    var _oEmployeeSettlementClearanceHistorys=[];
    var _bView = false;
    var _oAURolesMapping=[]

    $(document).ready(function ()
    {
        _oEmployeeSettlementClearances =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(MenuID));
        var oEmployeeSettlements = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EmployeeSettlements));
        var EnumSettleMentTypes= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumSettleMentTypes));

        _oEmployeeTypes= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EmployeeTypes));
        _oShifts= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Shifts));
        _oEmployeeCSs= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EmployeeCSs));
        _oEmployeeWSs= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EmployeeWSs));
        _oAURolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oBusinessUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BusinessUnits));
        _oEmployeeCategorys=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EmployeeCategorys));

    $('#btnPrint').hide();
    $('#btnXL').hide();
    
    $('#chkDept').prop('checked', true);
    $('#chkDept').hide();
    $('#lblDept').hide();
        
    if(EnumSettleMentTypes != null)
    {
        $("#cboSettlementType").icsLoadCombo({
            List: EnumSettleMentTypes,
            OptionValue: "Value",
            DisplayText: "Text"
        });
    }

    var oClearanceStatus= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.ClearanceStatus));
        ClearanceStatus(oClearanceStatus);

        $('#dtStartDate').datebox('setValue',icsdateformat(new Date()));
        $('#dtEndDate').datebox('setValue',icsdateformat(new Date()));
        InitializeAdvSearch();

        var oESs =sessionStorage.getItem("EmployeeSettlements");
        var sEmployeeSettlementHeader=sessionStorage.getItem("EmployeeSettlementHeader");
        if(oESs!=null)
        {
            DynamicRefreshList(jQuery.parseJSON(oESs), "tblEmployeeSettlements");
            if(sEmployeeSettlementHeader == "New EmployeeSettlement") {
                var oEmployeeSettlements = $('#tblEmployeeSettlements').datagrid('getRows');
                var nIndex = oEmployeeSettlements.length-1;
                $('#tblEmployeeSettlements').datagrid('selectRow', nIndex);
            }
            else if(sEmployeeSettlementHeader == "Edit EmployeeSettlement") {
                var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                $('#tblEmployeeSettlements').datagrid('selectRow', nIndex);
            }
        }
        else
        {
            DynamicRefreshList(oEmployeeSettlements, "tblEmployeeSettlements");
        }
        sessionStorage.clear();

        PrintTypeObject();

        @*_bView =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(TempData["View"]));*@
        
        if(PermissionChecker('Approved','EmployeeSettlement',_oAURolesMapping)) { _bView=true; }else {_bView=false;}
        if(!_bView)
        {
            $('#btnApprove').hide();
        }
       
        LoadCateGory(_oEmployeeCategorys);
    });

    function LoadCateGory(oEmployeeCategorys)
    {
        $("#cboCategory").icsLoadCombo({
            List: oEmployeeCategorys,
            OptionValue: "Value",
            DisplayText: "Text"
        });
    }

    function ClearanceStatus(oClearanceStatus)
    {
        if(oClearanceStatus != null)
        {
            var oList=[];
            for(var i=0; i<oClearanceStatus.length;i++)
            {
                if(oClearanceStatus[i].Value!=0 && oClearanceStatus[i].Value!=1)
                {
                    oList.push(oClearanceStatus[i]);
                }
            }
            if(oList.length >0)
            {
                $("#cboClearanceStatus").icsLoadCombo({
                    List: oList,
                    OptionValue: "Value",
                    DisplayText: "Text",
                    //InitialValue:""
                });
                $("#cboClearanceStatus_Search").icsLoadCombo({
                    List: oClearanceStatus,
                    OptionValue: "Value",
                    DisplayText: "Text",
                    //InitialValue:""
                });
            }
        }
    }

    /*---------------- emp Search----------------*/

    function InitializeAdvSearch(){
        $('#dtDateFrom').datebox('setValue', icsdateformat(new Date()));
        $('#dtDateTo').datebox('setValue', icsdateformat(new Date()));

        $("#cboEmployeeType").icsLoadCombo({
            List: _oEmployeeTypes,
            OptionValue: "EmployeeTypeID",
            DisplayText: "Name"
        });
        $("#cboShift_EmpSearch").icsLoadCombo({
            List: _oShifts,
            OptionValue: "ShiftID",
            DisplayText: "ShiftWithDuration"
        });
        $("#cboEmployeeCardStatus").icsLoadCombo({
            List: _oEmployeeCSs,
            OptionValue: "Value",
            DisplayText: "Text"
        });
        $("#cboEmployeeWorkigStatus").icsLoadCombo({
            List: _oEmployeeWSs,
            OptionValue: "Value",
            DisplayText: "Text"
        });
        $("#cboBU").icsLoadCombo({
            List: _oBusinessUnits,
            OptionValue: "BusinessUnitID",
            DisplayText: "Name"
        });
        $('#txtFrom,#txtTo').numberbox({min:0, precision:0 });
        $('#txtFrom').numberbox('setValue',1);
        $('#txtTo').numberbox('setValue',50);
        $("#lblRange1").hide();

        var oMonths=[{MonthID:0,Name:'Jan'},{MonthID:1,Name:'Feb'},{MonthID:2,Name:'Mar'},{MonthID:3,Name:'Apr'},
                    {MonthID:4,Name:'May'},{MonthID:5,Name:'Jun'},{MonthID:6,Name:'Jul'},{MonthID:7,Name:'Aug'},
                    {MonthID:8,Name:'Sep'},{MonthID:9,Name:'Oct'},{MonthID:10,Name:'Nov'},{MonthID:11,Name:'Dec'},];

        $("#cboMonthFrom,#cboMonthTo").icsLoadCombo({
            List: oMonths,
            OptionValue: "MonthID",
            DisplayText: "Name",
            InitialValue:''
        });

        LoadDaysInMonth();
    }

    function LoadDaysInMonth(){
        $("#cboMonthFrom,#cboMonthTo").val((new Date()).getMonth());
        var nDaysInMonth=(new Date((new Date()).getFullYear(), parseInt((new Date()).getMonth())+1,0)).getDate();

        var oDays=[];
        for(var i=1;i<=nDaysInMonth;i++){
            oDays.push({DayID:i,Day:i});
        }
        $("#cboDayFrom,#cboDayTo").icsLoadCombo({
            List: oDays,
            OptionValue: "DayID",
            DisplayText: "Day",
            InitialValue:''
        });
    }

    $("#cboDateType").change(function(e){
        if($("#cboDateType").val()==1){
            $("#regionDateTo").hide();
        }
        else{
            $("#regionDateTo").show();
        }
    });

    $("#cboMonthFrom").change(function(e){
        var nDaysInMonth=(new Date((new Date()).getFullYear(), parseInt($("#cboMonthFrom").val())+1,0)).getDate();
        var oDays=[];
        for(var i=1;i<=nDaysInMonth;i++){
            oDays.push({DayID:i,Day:i});
        }
        $("#cboDayFrom").icsLoadCombo({
            List: oDays,
            OptionValue: "DayID",
            DisplayText: "Day",
            InitialValue:''
        });
    });

    $("#cboMonthTo").change(function(e){
        var nDaysInMonth=(new Date((new Date()).getFullYear(), parseInt($("#cboMonthTo").val())+1,0)).getDate();
        var oDays=[];
        for(var i=1;i<=nDaysInMonth;i++){
            oDays.push({DayID:i,Day:i});
        }
        $("#cboDayTo").icsLoadCombo({
            List: oDays,
            OptionValue: "DayID",
            DisplayText: "Day",
            InitialValue:''
        });
    });

    function EmployeePickerReset(){
        _nLastEmployeeID = 0;
        _sEmployeeIDs = "";
        _bNext = false;
        _nLoadRecords = 0;
        _nRowLength = 0;
        _sAttendanceSchemeID="";
        _sLocationID = "";
        _sDepartmentIds = "";
        _sDesignationIds = "";
        $(".txtReset").val("");
        $(".cboReset").val(0);
        $(".chkReset").prop("checked",false);

        $("#cboMonthFrom,#cboMonthTo").val((new Date()).getMonth());
        LoadDaysInMonth();

        DynamicRefreshList([], "tblEmployeesForPicker");
        $("#lblcount").html("");
        $('#txtFrom,#txtTo').numberbox({min:0, precision:0 });
        $('#txtFrom').numberbox('setValue',1);
        $('#txtTo').numberbox('setValue',50);
        $("#lblRange1").hide();
    }

    $("#btnEmployee").click(function () {
        EmployeePickerReset();
        $("#winEmployeePicker").icsWindow("open", " Employee Picker");
    });

    $('#chkRange').click(function()
    {
        if(document.getElementById("chkRange").checked == true)
        {
            $("#lblRange1").show();
        }
        else
        {
            $("#lblRange1").hide();
        }
    });

    $('#btnEmpPickerSearch').click(function () {
        _bNext = false;
        AdvSearch();
    });

    function Next() {
        var oEmployees = [];
        oEmployees = $('#tblEmployeesForPicker').datagrid('getRows');
        if (oEmployees.length <= 0) { alert('Please Select Criteria and click on "Search" to find information.!!'); return; }
        _nRowLength = oEmployees.length;
        _bNext = true;
        AdvSearch();
    }

    function AdvSearch(){
        if (!_bNext) {
            _nRowLength = 0;
            _nLastEmployeeID = 0;
        }
        debugger;
        _nLoadRecords = document.getElementById("txtTo").value;
        if ($("#chkRange").is(':checked')) {
            if($('#txtFrom').numberbox('getValue').length=='' || $('#txtTo').numberbox('getValue').length==''){alert("Please enter valid range.")}
            var nRangeFrom = parseInt($('#txtFrom').numberbox('getValue'));
            var nRangeTo = parseInt( $('#txtTo').numberbox('getValue'));
            if (nRangeFrom > nRangeTo) { alert("Invalid Range !");return; }
            _nRowLength = nRangeFrom - 1;
            _nLoadRecords = nRangeTo - nRangeFrom + 1;
        }
        debugger
        var sName = $.trim($("#txtEmployeeName").val());
        var sCode = $.trim($("#txtEmpCodeForSearch").val());
        var sEnrollNo = $.trim($("#txtEnrollNo").val());
        var bIsnotEnroll = $("#chkNotassignedyet").is(':checked');
        var nEmployeeTypeID=$("#cboEmployeeType").val();
        var nShiftID=$("#cboShift_EmpSearch").val();
        var nCardStatus=$("#cboEmployeeCardStatus").val();
        var nWorkingStatus=$("#cboEmployeeWorkigStatus").val();
        var nDateType=$("#cboDateType").val();
        var sDOBFrom= parseInt($("#cboMonthFrom").val())+1+'-'+$("#cboDayFrom").val();
        var sDOBTo= parseInt($("#cboMonthTo").val())+1+'-'+$("#cboDayTo").val();
        var sGender= $("#cboGender option:selected").text();

        var bIsActive = ($("#chkActive").is(':checked'))? 1 : 0;
        var bIsInactive = ($("#chkInActive").is(':checked'))? 1 : 0;
        var bIsUser = ($("#chkUser").is(':checked'))? 1 : 0;

        var bIsUnOfficial = ($("#chkOfficialNotAssign").is(':checked'))?1:0;
        var bIsOfficial = ($("#chkOfficialAssign").is(':checked'))? 1 : 0;

        var bIsCardNotAsigned = ($("#chkCardNotAssigned").is(':checked'))? 1 : 0;
        var bIsSalarystructureNotAsigned = ($("#chkSalarystructureNotAssigned").is(':checked'))? 1 : 0;

        var bIsJoiningDate = $("#chkJoiningDate").is(':checked');
        var dtDateFrom = $('#dtDateFrom').datebox('getValue');
        var dtDateTo = $('#dtDateTo').datebox('getValue');

        if(bIsJoiningDate)
        {
            if(new Date(dtDateFrom)>new Date(dtDateTo))
            {
                alert("Invalid Joining Date Range!");
                return;
            }
        }

        var nBusinessUnitID = $("#cboBU").val();
        var nCategory=$('#cboCategory').val();
        var sPresentAddress=$('#txtPresentAddress').val();
        var sPermanentAddress=$('#txtPermanentAddress').val();

        if(sName=='' && sCode=="" && sEnrollNo=="" && _sAttendanceSchemeID=="" && _sLocationID=="" && _sDepartmentIds=="" && _sDesignationIds=="" &&
           nEmployeeTypeID==0 && sGender=="None" && nShiftID==0 && bIsActive==0 && bIsUnOfficial==0 && bIsInactive==0 && _sEmployeeIDs=="" && bIsUser==0 &&
           bIsOfficial==0 && nCardStatus==0 && bIsCardNotAsigned==0 && nWorkingStatus==0 && bIsSalarystructureNotAsigned==0 && nDateType==0 
            && !bIsnotEnroll && nCategory<=0 && nBusinessUnitID<=0 && sPresentAddress=="" && sPermanentAddress=="" && _sBMMIDs=="")
        {
            alert("Please enter your selection criteria."); return false;
        }

        var sParam = sName + '~' + sCode + '~' + _sAttendanceSchemeID + '~' + _sLocationID + '~' + _sDepartmentIds + '~' +_sDesignationIds + '~' +
                     sGender + '~' + nEmployeeTypeID + '~' + nShiftID + '~' + bIsActive + '~' + bIsUnOfficial + '~' + bIsInactive + '~' + _sEmployeeIDs + '~' +
                     bIsUser + '~' + bIsOfficial + '~' + nCardStatus + '~' + bIsCardNotAsigned + "~" + nWorkingStatus + "~" + bIsSalarystructureNotAsigned + "~" +
                     sDOBFrom + "~" + sDOBTo + "~" + nDateType + "~" + _nRowLength + "~" + _nLoadRecords+"~"+ bIsJoiningDate + "~" + dtDateFrom + "~" + dtDateTo
                     +"~"+sEnrollNo+"~"+bIsnotEnroll+"~"+nCategory+"~"+nBusinessUnitID+"~"+sPresentAddress+"~"+sPermanentAddress+"~"+_sBMMIDs;

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/Employee/EmployeeSearch",
            traditional: true,
            data: JSON.stringify({ sParam: sParam }),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oEmps = jQuery.parseJSON(data);
                if (oEmps != null) {
                    if (oEmps.length > 0) {
                        if(!_bNext){
                            DynamicRefreshList(oEmps,'tblEmployeesForPicker');
                        }
                        else{
                            var bAppend=false;
                            var oTEmps=$('#tblEmployeesForPicker').datagrid('getRows');
                            if(oTEmps.length>0){
                                for (var i = 0; i < oEmps.length; i++) {
                                    var IsAppend=true;
                                    for (var j = 0; j < oTEmps.length; j++) {

                                        if(oEmps[i].EmployeeID==oTEmps[j].EmployeeID){
                                            IsAppend=false;
                                            break;
                                        }
                                    }
                                    if(IsAppend){
                                        bAppend=true;
                                        $('#tblEmployeesForPicker').datagrid('appendRow', oEmps[i]);
                                    }
                                }
                            }
                            else{
                                for (var j = 0; j < oEmps.length; j++) {
                                    bAppend=true;
                                    $('#tblEmployeesForPicker').datagrid('appendRow', oEmps[j]);
                                }
                            }
                            if(!bAppend){
                                alert("No more data found!");
                            }
                        }

                    }
                    else {
                        alert("No more data found!");
                    }
                    var oEmployees = $('#tblEmployeesForPicker').datagrid('getRows');
                    document.getElementById("lblcount").innerHTML = " | Count =" + oEmployees.length;
                    _bNext = false;
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    $("#btnEmployeePickerOk").click(function () {
        var oEmployees = $('#tblEmployeesForPicker').datagrid('getChecked');
        if (oEmployees.length<=0) { alert("please select atleast one item");return; }
        var sEmpIDs="";
        var sEmpNames="";
        for(var i=0;i<oEmployees.length;i++)
        {
            sEmpIDs=sEmpIDs+oEmployees[i].EmployeeID+",";
            sEmpNames=sEmpNames+oEmployees[i].Name+",";
        }
        _sEmployeeIDs= sEmpIDs.substring(0,sEmpIDs.length-1);
        sEmpNames= sEmpNames.substring(0,sEmpNames.length-1);
        $('#txtEmployeeName').data("EmployeeIDs",_sEmployeeIDs);
        $("#txtEmployee_Collection").val(sEmpNames);
        $("#winEmployeePicker").icsWindow('close');
        Search();
    });

    $("#btnEmployeePickerClose").click(function () {
        $("#winEmployeePicker").icsWindow('close');
    });

    /*-------------Attendance Schema Picker----------------*/
    $("#btnAttScheme").click(function(e){
        var oAttendanceScheme={AttendanceSchemeID:0};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oAttendanceScheme,
            ControllerName: "AttendanceScheme",
            ActionName: "GetsAttendanceSchemeCurrentSession",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].AttendanceSchemeID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Name", title: "Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "EmployeeType", title: "EmployeeType", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "DayOff", title: "DayOff", width: 115, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winAttendanceScheme',
                        winclass:'clsAttendanceScheme',
                        winwidth: 420,
                        winheight: 460,
                        tableid: 'tblAttendanceSchemePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Attendance Scheme List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeAttendancePickerbutton(oPickerParam);//multiplereturn, winclassName

                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    });

    function IntializeAttendancePickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {

            var oAttendanceScheme = $('#'+oPickerobj.tableid).datagrid('getSelected');
            if (oPickerobj.winid == 'winAttendanceScheme')
            {
                if(oAttendanceScheme!=null && oAttendanceScheme.AttendanceSchemeID>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    $('#txtAttendanceScheme').val(oAttendanceScheme.Name);
                    _sAttendanceSchemeID=oAttendanceScheme.AttendanceSchemeID;
                }
                else{
                    alert("Please select a schema.");
                }
            }
        });
    }

    $("#btnResetAttScheme").click(function(e){
        $('#txtAttendanceScheme').val("");
        _sAttendanceSchemeID="";
    });

    /*-------------Start Business Unit Picker----------------*/
    $("#btnBusinessUnitPicker_Collection").click(function(e){
        BusinessUnitPicker();
    });

    $("#txtBusinessUnit_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            BusinessUnitPicker();
        }
    });

    function BusinessUnitPicker()
    {
        var oBusinessUnit={
            BusinessUnitID:0
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oBusinessUnit,
            ControllerName: "BusinessUnit",
            ActionName: "GetsBusinessUnitWithPermission",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].BusinessUnitID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 170, align: "left" };tblColums.push(oColumn);

                    var bmultiplereturn=true;

                    var oPickerParam = {
                        winid: 'winBusinessUnit',
                        winclass:'clsBusinessUnit',
                        winwidth: 320,
                        winheight: 400,
                        tableid: 'tblBusinessUnit',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bmultiplereturn,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Business Unit List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeBusinessUnitPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeBusinessUnitPickerbutton(oPickerobj)
    {
        debugger
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oBusinessUnits=[];
            oBusinessUnits = $('#'+oPickerobj.tableid).datagrid('getChecked');
            if (oPickerobj.winid == 'winBusinessUnit')
            {
                if(oBusinessUnits!=null && oBusinessUnits.length>0)
                {
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();
                    var sBusinessUnitName = "";
                    for(var i=0; i<oBusinessUnits.length; i++)
                    {
                        sBusinessUnitName+=oBusinessUnits[i].Name+",";
                        _sBusinessUnitIds+=oBusinessUnits[i].BusinessUnitID+",";
                    }

                    sBusinessUnitName=sBusinessUnitName.substring(0,sBusinessUnitName.length-1);
                    _sBusinessUnitIds=_sBusinessUnitIds.substring(0,_sBusinessUnitIds.length-1);
                    $("#txtBusinessUnit_Collection").val(sBusinessUnitName);
                }
                else
                {
                    alert("Please select a Business Unit.");
                }
            }
        });
    }

    $("#btnResetBusinessUnitPicker_Collection").click(function(e){
        $('#txtBusinessUnit_Collection').val("");
        _sBusinessUnitIds="";
    });
    /*-------------End Business Unit Picker----------------*/

    /*-------------Location Picker----------------*/
    var btnLocation="";
    $("#btnLocationPicker,#btnLocationPicker_Colection").click(function(e){
        btnLocation = $(this).attr("id");
        var sBusinessUnitIDs ="";
        var nBusinessUnitID=0;
        if(btnLocation=="btnLocationPicker")
        {
            nBusinessUnitID = $("#cboBU").val();
            sBusinessUnitIDs = String(nBusinessUnitID);
        }
        else{sBusinessUnitIDs=_sBusinessUnitIds;}
        $("#winLocationPicker").icsWindow('open');
        var oLocation={LocationID:0,BusinessUnitIDs:sBusinessUnitIDs};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLocation,
            ControllerName: "Location",
            ActionName: "GetsLocationMenuTree",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                if (response.obj.TLocation.id > 0) {
                    $('#locationtree').tree({ data: [response.obj.TLocation] });
                }
            }
        });
    });

    $("#btnLocationPickerOk").click(function(e){
        if(btnLocation=="btnLocationPicker")
        {
            var oLocation = $('#locationtree').tree('getSelected');
            if(oLocation!=null && oLocation.id>0){
                $("#winLocationPicker").icsWindow('close');
                _sLocationID=oLocation.id;
                $('#txtLocation').val(oLocation.text);
            }
            else{
                alert("Please select a location.");
            }
        }
        else
        {
            var oLocations = $('#locationtree').tree('getChecked');
            if(oLocations!=null && oLocations.length>0)
            {
                var LocationName="";
                for(var i=0; i<oLocations.length; i++)
                {
                    if(oLocations[i].id !=1)
                    {
                        LocationName+=oLocations[i].text+",";
                        _sLocationID+=oLocations[i].id+",";
                    }
                }

                LocationName=LocationName.substring(0,LocationName.length-1);
                _sLocationID=_sLocationID.substring(0,_sLocationID.length-1);
                $("#winLocationPicker").icsWindow('close');
                $('#txtLocation_Colection').val(LocationName);
            }
            else
            {
                alert("Please select a location.");
            }
        }
    });

    $('#txtLocation_Colection').keypress(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            //$("#winLocationPicker").icsWindow('open');
            //var oLocation={LocationID:0};
            btnLocation = $(this).attr("id");
            var sBusinessUnitIDs ="";
            var nBusinessUnitID=0;
            if(btnLocation=="btnLocationPicker")
            {
                nBusinessUnitID = $("#cboBU").val();
                sBusinessUnitIDs = String(nBusinessUnitID);
            }
            else{sBusinessUnitIDs=_sBusinessUnitIds;}
            $("#winLocationPicker").icsWindow('open');
            var oLocation={LocationID:0,BusinessUnitIDs:sBusinessUnitIDs};

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oLocation,
                ControllerName: "Location",
                ActionName: "GetsLocationMenuTree",
                IsWinClose: false
            };
            $.icsDataGet(obj, function (response) {

                if (response.status && response.obj!=null) {
                    if (response.obj.TLocation.id > 0) {
                        $('#locationtree').tree({ data: [response.obj.TLocation] });
                    }
                }
            });
        }
    });

    $("#btnLocationPickerClose").click(function(e){
        $("#winLocationPicker").icsWindow('close');
    });

    $("#btnResetLocationPicker,#btnResetLocationPicker_Colection").click(function(e){
        $('#txtLocation').val("");
        $('#txtLocation_Colection').val("");
        _sLocationID="";
    });

    $("#btnLocationPickerClose").click(function(e){
        $("#winLocationPicker").icsWindow('close');
    });

    $("#btnDepartmentPicker").click(function(e){
        $("#winDepartmentPicker").icsWindow('open');
        var oDepartment={DepartmentID:0,BusinessUnitIDs:_sBusinessUnitIds,LocationIDs:_sLocationID};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDepartment,
            ControllerName: "Department",
            ActionName: "GetsDepartments",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                if (response.obj.id > 0) {
                    $('#departmenttree').tree({ data: [response.obj] });
                }
            }
        });
    });

    $("#btnDepartmentPickerOk").click(function(e){
        var oDepartment = $('#departmenttree').tree('getSelected');
        if(oDepartment!=null && oDepartment.id>0){
            $("#winDepartmentPicker").icsWindow('close');
            $('#txtDepartment').val(oDepartment.text);
            _sDepartmentIds= oDepartment.id;
        }
        else{
            alert("Please select a department.");
        }
    });

    $("#btnDepartmentPickerClose,#btnDepartmentPickerClose_Collection").click(function(e){
        $("#winDepartmentPicker").icsWindow('close');
        $("#winDepartmentPicker_Collection").icsWindow('close');
    });

    $("#btnResetDepartmentPicker,#btnResetDepartmentPicker_Collection").click(function(e){
        $('#txtDepartment,#txtDepartment_Collection').val("");
        _sDepartmentIds="";
        _sDepartmentNames="";
    });

    /*-------------Designation Picker----------------*/
    var btnDesignation="";
    $("#btnDesignationPicker,#btnDesignationPicker_Collection").click(function(e){
        btnDesignation = $(this).attr("id");
        DesignationPicker();
    });

    $("#txtDesignation_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            btnDesignation ="btnDesignationPicker_Collection";
            DesignationPicker();
        }
    });

    function DesignationPicker()
    {
        var oDesignation={
            DesignationID:0,
            Params: _sBusinessUnitIds+'~'+_sLocationID+'~'+ _sDepartmentIds
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDesignation,
            ControllerName: "Designation",
            ActionName: "Gets",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DesignationID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 170, align: "left" };tblColums.push(oColumn);

                    var bmultiplereturn=false;
                    if(btnDesignation=="btnDesignationPicker_Collection"){bmultiplereturn=true;}

                    var oPickerParam = {
                        winid: 'winDesignation',
                        winclass:'clsDesignation',
                        winwidth: 320,
                        winheight: 460,
                        tableid: 'tblDesignation',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bmultiplereturn,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Designation List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDesignationPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeDesignationPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oDesignations=[];

            if(btnDesignation=="btnDesignationPicker_Collection")
            {
                oDesignations = $('#'+oPickerobj.tableid).datagrid('getChecked');
            }
            else
            {
                var oDesignation = $('#'+oPickerobj.tableid).datagrid('getSelected');
                oDesignations.push(oDesignation);
            }

            if (oPickerobj.winid == 'winDesignation')
            {
                if(oDesignations!=null && oDesignations.length>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();

                    for(var i=0; i<oDesignations.length; i++)
                    {
                        _sDesignationNames+=oDesignations[i].Name+",";
                        _sDesignationIds+=oDesignations[i].DesignationID+",";
                    }

                    _sDesignationNames=_sDesignationNames.substring(0,_sDesignationNames.length-1);
                    _sDesignationIds=_sDesignationIds.substring(0,_sDesignationIds.length-1);
                    if(btnDesignation=="btnDesignationPicker_Collection")
                    {
                        $("#txtDesignation_Collection").val(_sDesignationNames);
                    }
                    else
                    {
                        $("#txtDesignation").val(_sDesignationNames);
                    }
                }
                else{
                    alert("Please select a designation.");
                }
            }
        });
    }

    $("#btnResetDesignationPicker,#btnResetDesignationPicker_Collection").click(function(e){
        $('#txtDesignation').val("");
        $('#txtDesignation_Collection').val("");
        _sDesignationIds="";
        _sDesignationNames = "";
    });

    /*------------- Start Block Picker----------------*/
   
    $("#btnBlock").click(function(e){
        BlockPicker();
    });

    function BlockPicker()
    {
        var oBlockMachineMapping={
            ProductionProcessInt:0,
            DepartmentID:0,
            BlockName:""
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oBlockMachineMapping,
            ControllerName: "BlockMachineMapping",
            ActionName: "BlockMachineMapping_Search",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
        
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].BMMID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "BlockName", title: "Block Name", width: 230, align: "left" };tblColums.push(oColumn);
                    var bmultiplereturn=true;

                    var oPickerParam = {
                        winid: 'winBlock',
                        winclass:'clsBlock',
                        winwidth: 320,
                        winheight: 460,
                        tableid: 'tblShift',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: bmultiplereturn,
                        searchingbyfieldName:'BlockName',
                        windowTittle: 'Block List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeBlockPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeBlockPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oBlocks=[];
            oBlocks= $('#'+oPickerobj.tableid).datagrid('getChecked');
            if (oPickerobj.winid == 'winBlock')
            {
                if(oBlocks!=null && oBlocks.length>0){
                    $("#"+oPickerobj.winid).icsWindow("close");
                    $("#" + oPickerobj.winid).remove();

                    for(var i=0; i<oBlocks.length; i++)
                    {
                        _sBlockNames += oBlocks[i].BlockName+",";
                        _sBMMIDs += oBlocks[i].BMMID+",";
                    
                    }
                    _sBlockNames=_sBlockNames.substring(0,_sBlockNames.length-1);
                    _sBMMIDs=_sBMMIDs.substring(0,_sBMMIDs.length-1);
                    $("#txtBlock").val(_sBlockNames);
                }
                else
                {
                    alert("Please select a designation.");
                }
            }
        });
    }

    $("#btnResetBlock").click(function(e){
        $('#txtBlock').val("");
        _sBlockNames="";
        _sBMMIDs = "";
    });

    $("#txtBlock").keypress(function(e){
        if (e.which == 13)
        {
            BlockPicker();
        }
    });
    /*------------- End Block Picker----------------*/

    /*----------------------end emp search----------------------*/

    /*---------------- emp Search Start keyprees----------------*/
    $('#txtEmployee_Collection').keypress(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var sCodeName = $.trim($("#txtEmployee_Collection").val());
            if(sCodeName==''){alert("Please enter name or code to search.");$("#txtEmployeeName").focus(); return;}
            SearchEmployeeByText(sCodeName);
        }
    });

    function SearchEmployeeByText(sEmpNameCode){
        var oEmployee = { Params: sEmpNameCode +'~'+ 0};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oEmployee,
            ControllerName: "EmployeeSettlement",
            ActionName: "GetsByEmpCode",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].EmployeeID > 0) {

                    var tblColums = [];var oColumn = { field: "Code", title: "Code", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "DepartmentName", title: "Department", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "DesignationName", title: "Designation", width: 100, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winEmployeePickerTextSearch',
                        winclass:'clsEmployeePickerTextSearch',
                        winwidth: 455,
                        winheight: 460,
                        tableid: 'tblEmployeePickerTextSearch',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Employee list'
                    };

                    $.icsPicker(oPickerParam);
                    IntializeEmployeePickerTextSearch(oPickerParam);//multiplereturn, winclassName

                }
                else { alert(response.objs[0].ErrorMessage); }
            }
        });
    }

    function IntializeEmployeePickerTextSearch(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            var oreturnObj = $('#'+oPickerobj.tableid).datagrid('getSelected');
            if(oreturnObj == null || oreturnObj.EmployeeID<=0){  alert("please select an employee."); return false;}

            $("#"+oPickerobj.winid).icsWindow("close");
            $("#" + oPickerobj.winid).remove();
            if (oPickerobj.winid == 'winEmployeePickerTextSearch')
            {
                if (oreturnObj != null && oreturnObj.EmployeeID > 0)
                {
                    _sEmployeeIDs=oreturnObj.EmployeeID;
                    $("#txtEmployee_Collection").val(oreturnObj.Name);
                    $("#winEmployeePicker").icsWindow('close');
                    Search();
                }
            }
        });

        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                var oreturnObj = $('#'+oPickerobj.tableid).datagrid('getSelected');
                if(oreturnObj == null || oreturnObj.EmployeeID<=0){  alert("please select an employee."); return false;}

                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                if (oPickerobj.winclass == 'clsEmployeePickerTextSearch')
                {
                    if (oreturnObj != null && oreturnObj.EmployeeID > 0)
                    {
                        _sEmployeeIDs=oreturnObj.EmployeeID;
                        $("#txtEmployee_Collection").val(oreturnObj.Name);
                        $("#winEmployeePicker").icsWindow('close');
                        Search();
                    }
                }
            }
        });
    }

    $('#btnCEmployee').click(function (e)
    {
        $("#txtEmployee_Collection")[0].value = "";
        _sEmployeeIDs = "";
    });
    /*---------------- emp Search End keyprees----------------*/

    /*-------------Department Picker start Collection----------------*/
    $("#btnDepartmentPicker_Collection").click(function(e){
        DepartmentPicker();
    });

    $("#txtDepartment_Collection").keypress(function(e){
        if (e.which == 13)//enter=13
        {
            DepartmentPicker();
        }
    });

    function DepartmentPicker()
    {
        $("#winDepartmentPicker_Collection").icsWindow('open');
        var oDepartment={DepartmentID:0,BusinessUnitIDs:_sBusinessUnitIds,LocationIDs:_sLocationID};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDepartment,
            ControllerName: "Department",
            ActionName: "GetsDepartments",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                if (response.obj.id > 0) {
                    $('#departmenttree_Collection').tree({ data: [response.obj] });
                }
            }
        });
    }

    $("#btnDepartmentPickerOk_Collection").click(function(e){
        var oDepartments = $('#departmenttree_Collection').tree('getChecked');
        if(oDepartments!=null && oDepartments.length>0){
            $("#winDepartmentPicker_Collection").icsWindow('close');
            for(var i=0; i<oDepartments.length; i++)
            {
                _sDepartmentNames+=oDepartments[i].text+",";
                _sDepartmentIds+=oDepartments[i].id+",";
            }

            _sDepartmentNames=_sDepartmentNames.substring(0,_sDepartmentNames.length-1);
            _sDepartmentIds=_sDepartmentIds.substring(0,_sDepartmentIds.length-1);
            $("#txtDepartment_Collection").val(_sDepartmentNames);
        }
        else{
            alert("Please select a department.");
        }
    });

    /*-------------Department Picker end Collection----------------*/

    function SearchWithCriteria()
    {
        debugger;
        var dtStartDate=$('#dtStartDate').datebox('getValue');
        var dtEndDate=$('#dtEndDate').datebox('getValue');
        var nSettlementType=$('#cboSettlementType').val();
        var nClearanceStatus=$('#cboClearanceStatus_Search').val();
        var nApproveStatus=0;

        if($('#chkApprove').is(":checked"))
        {
            nApproveStatus=1;
        }
        if($('#chkUnApprove').is(":checked"))
        {
            nApproveStatus=2;
        }

        var tsv = ((new Date()).getTime()) / 1000;

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/Compliance/SearchWithCriteria",
            data: JSON.stringify({dtDateFrom:dtStartDate,dtDateTo:dtEndDate,nSettlementType:nSettlementType,sDepartmentIds: _sDepartmentIds,sDesignationIDs:_sDesignationIds,nClearanceStatus:nClearanceStatus,nApproveStatus:nApproveStatus, ts: tsv}),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            { var oEmployeeSettlements = jQuery.parseJSON(data);
                if (oEmployeeSettlements[0].ErrorMessage=="" && oEmployeeSettlements.length > 0) {
                    DynamicRefreshList(oEmployeeSettlements, "tblEmployeeSettlements");
                } else {
                    alert(oEmployeeSettlements[0].ErrorMessage);
                    DynamicRefreshList([], "tblEmployeeSettlements");
                }
            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function GetsEmployeeSettlementClearanceSetup()
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/Gets_EmployeeSettlementClearanceSetup_ForSendTO",
            traditional: true,
            data: JSON.stringify({nEmployeeSettlementID:nEmployeeSettlementID}),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                var oEmployeeSettlementClearanceSetups = jQuery.parseJSON(data);
                if(oEmployeeSettlementClearanceSetups.length > 0 && oEmployeeSettlementClearanceSetups[0].ErrorMessage=="") {
                    $("#winClearanceSetUp").icsWindow("open", "Send To");
                    DynamicRefreshList(oEmployeeSettlementClearanceSetups, "tblEmployeeSettlementClearanceSetup");
                }
                else
                {
                    alert(oEmployeeSettlementClearanceSetups[0].ErrorMessage);
                    DynamicRefreshList([], "tblEmployeeSettlementClearanceSetup");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }
    var nEmployeeSettlementID=0;
    $("#btnSendInitially").click(function(e){
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("please select a Settlement!");
            return;
        }
        nEmployeeSettlementID=oEmployeeSettlement.EmployeeSettlementID;
        GetsEmployeeSettlementClearanceSetup();
    });

    $("#btnInitiallySendClose").click(function(e){
        $("#winClearanceSetUp").icsWindow('close');
    });

    $("#btnInitiallySendOk").click(function(e){
        var oEmployeeSettlementClearanceSetups = $('#tblEmployeeSettlementClearanceSetup').datagrid('getChecked');
        if (oEmployeeSettlementClearanceSetups == null || oEmployeeSettlementClearanceSetups.length <= 0) {
            alert("please select a Settlement!");
            return;
        }

        var oEmployeeSettlementClearances=[];
        var oEmployeeSettlementClearanceHistorys=[];
        for(var i=0;i<oEmployeeSettlementClearanceSetups.length;i++)
        {
            var oEmployeeSettlementClearance=
            {
                ESCID : 0,
                EmployeeSettlementID :nEmployeeSettlementID,
                ESCSetupID : oEmployeeSettlementClearanceSetups[i].ESCSetupID,
                CurrentStatus : 1
            }
            var oEmployeeSettlementClearanceHistory=
            {
                ESCHID : 0,
                ESCID :0,
                PreviousStatus :0,
                CurrentStatus :1,
                Note : ""
            }
            oEmployeeSettlementClearances.push(oEmployeeSettlementClearance);
            oEmployeeSettlementClearanceHistorys.push(oEmployeeSettlementClearanceHistory);
        }

        var oESC={
            EmployeeSettlementClearances:oEmployeeSettlementClearances,
            EmployeeSettlementClearanceHistorys:oEmployeeSettlementClearanceHistorys
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/EmployeeSettlementClearance_IUD",
            traditional: true,
            data: JSON.stringify({oEmployeeSettlementClearance:oESC}),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                var oEmployeeSettlementClearance = jQuery.parseJSON(data);
                if(oEmployeeSettlementClearance.ErrorMessage=="") {
                    alert("Sent Successfully!");
                    $("#winClearanceSetUp").icsWindow('close');
                    DynamicRefreshList(oEmployeeSettlementClearance.EmployeeSettlementClearances, "tblEmployeeSettlementClearance");
                    DynamicRefreshList(oEmployeeSettlementClearance.EmployeeSettlementClearanceHistorys, "tblEmployeeSettlementClearanceHistory");
                    for(var i=0; i<oEmployeeSettlementClearance.EmployeeSettlementClearanceHistorys.length;i++)
                    {
                        _oEmployeeSettlementClearanceHistorys.push(oEmployeeSettlementClearance.EmployeeSettlementClearanceHistorys[i]);
                    }
                }
                else
                {
                    alert(oEmployeeSettlementClearance.ErrorMessage);
                    DynamicRefreshList([], "tblEmployeeSettlementClearance");
                    DynamicRefreshList([], "tblEmployeeSettlementClearanceHistory");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    });

    $("#btnRefreshEmployeeSettlementClearance").click(function(e){
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("please select a Settlement!");
            return;
        }

        GetsEmployeeSettlementClearance_By_SettlementID( oEmployeeSettlement.EmployeeSettlementID);
    });

    function GetsEmployeeSettlementClearance_By_SettlementID(nEmployeeSettlementID)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/GetsEmployeeSettlementClearance_By_SettlementID",
            traditional: true,
            data: JSON.stringify({nEmployeeSettlementID:nEmployeeSettlementID}),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                var oEmployeeSettlementClearance = jQuery.parseJSON(data);
                if(oEmployeeSettlementClearance.ErrorMessage=="") {
                    DynamicRefreshList(oEmployeeSettlementClearance.EmployeeSettlementClearances, "tblEmployeeSettlementClearance");
                    //DynamicRefreshList(oEmployeeSettlementClearance.EmployeeSettlementClearanceHistorys, "tblEmployeeSettlementClearanceHistory");
                    _oEmployeeSettlementClearanceHistorys=oEmployeeSettlementClearance.EmployeeSettlementClearanceHistorys;
                }
                else
                {
                    DynamicRefreshList([], "tblEmployeeSettlementClearance");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }

    function EmployeeSettlementClearanceSave()
    {
        var oEmployeeSettlementClearance = $('#tblEmployeeSettlementClearance').datagrid('getSelected');
        if (oEmployeeSettlementClearance == null || oEmployeeSettlementClearance.ESCID <= 0) {
            alert("Please Select a Settlement Clearance!");
            return;
        }

        var CurrentStatus=$('#cboClearanceStatus').val();
        var oEmployeeSettlementClearanceHistory =
        {
            ESCHID : 0,
            ESCID :oEmployeeSettlementClearance.ESCID,
            PreviousStatus :0,
            CurrentStatus :CurrentStatus,
            Note : $('#txtNote').val()
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/EmployeeSettlementClearanceHistory_IUD",
            traditional: true,
            data: JSON.stringify({oEmployeeSettlementClearanceHistory:oEmployeeSettlementClearanceHistory}),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                var oEmployeeSettlementClearanceH = jQuery.parseJSON(data);
                if(oEmployeeSettlementClearanceH.ErrorMessage=="") {
                    alert("Saved Successfully!");
                    var oEmployeeSettlementClearanceHs = $('#tblEmployeeSettlementClearanceHistory').datagrid('getRows');
                    var nIndex = oEmployeeSettlementClearanceHs.length;
                    $('#tblEmployeeSettlementClearanceHistory').datagrid('appendRow', oEmployeeSettlementClearanceH);
                    $('#tblEmployeeSettlementClearanceHistory').datagrid('selectRow', nIndex);
                    _oEmployeeSettlementClearanceHistorys.push(oEmployeeSettlementClearanceH);
                }
                else
                {
                    alert(oEmployeeSettlementClearanceH.ErrorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }

    function onClickRow(index)
    {
        var oEmployeeSettlementClearance = $('#tblEmployeeSettlementClearance').datagrid('getSelected');
        var oHistory=[];
        if(_oEmployeeSettlementClearanceHistorys.length>0)
        {
            for(var i=0;i<_oEmployeeSettlementClearanceHistorys.length;i++)
            {
                if(_oEmployeeSettlementClearanceHistorys[i].ESCID==oEmployeeSettlementClearance.ESCID)
                {
                    oHistory.push(_oEmployeeSettlementClearanceHistorys[i]);
                }
            }
        }
        DynamicRefreshList(oHistory, "tblEmployeeSettlementClearanceHistory");
    }

    function AddEmployeeSettlement()
    {
        var oEmployeeSettlements= $('#tblEmployeeSettlements').datagrid('getRows');
        sessionStorage.setItem("EmployeeSettlements", JSON.stringify(oEmployeeSettlements));
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("IsClearance", 1);
        sessionStorage.setItem("EmployeeSettlementHeader", "New EmployeeSettlement");
        window.location.href = _sBaseAddress+ "/EmployeeSettlement/View_EmployeeSettlement?sid=0&sMsg=N/A";
    }

    function EditEmployeeSettlement()
    {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        if (oEmployeeSettlement.ApproveBy > 0) {
            alert("Approved item can not be edited!");
            return;
        }
        var SelectedRowIndex = $('#tblEmployeeSettlements').datagrid('getRowIndex', oEmployeeSettlement);
        var oEmployeeSettlements= $('#tblEmployeeSettlements').datagrid('getRows');
        sessionStorage.setItem("EmployeeSettlements", JSON.stringify(oEmployeeSettlements));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("IsClearance", 1);
        sessionStorage.setItem("EmployeeSettlementHeader", "Edit EmployeeSettlement");
        window.location.href = _sBaseAddress+ "/EmployeeSettlement/View_EmployeeSettlement?sid="+oEmployeeSettlement.EncryptID+"&sMsg=N/A";
    }

    function Delete() {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Invalid Field!!! please select a valid Field!");
            return ;
        }
        if (oEmployeeSettlement.ApproveBy > 0) {
            alert("Approved item can not be deleted!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return;
        var SelectedRowIndex = $('#tblEmployeeSettlements').datagrid('getRowIndex', oEmployeeSettlement);

        if ( oEmployeeSettlement.EmployeeSettlementID > 0) {
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oEmployeeSettlement,
                ControllerName: "EmployeeSettlement",
                ActionName: "ER_Delete",
                TableId: "tblEmployeeSettlements",
                IsWinClose: false
            };
            $.icsDelete(obj);
        }
    }

    $('#btnSalaryProcess').click(function (e) {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        if (oEmployeeSettlement.ApproveBy<=0) {
            alert("This item is not approved!");
            return;
        }
        if(new Date(oEmployeeSettlement.EffectDateInString)>= new Date())
        {
            alert("payment can not be done before last working day!");
            return;
        }
        if(oEmployeeSettlement.IsSalaryHold== false) {
            alert("Process was not hold!");
            return;
        }

        var sAction="";
        if(_sBaseAddress=='mamiya'){sAction="SettlementSalaryProcess";}
        else{sAction="SettlementSalaryProcess_Corporate";}

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/"+sAction,
            traditional: true,
            data: JSON.stringify(oEmployeeSettlement),
            contentType: "application/json; charset=utf-8",

            success: function(data) {
                oEmployeeSettlementSalary = jQuery.parseJSON(data);
                if (oEmployeeSettlementSalary.EmployeeSalaryID > 0) {
                    alert("Processed sucessfully!");
                } else {
                    alert(oEmployeeSettlementSalary.ErrorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    });

    function Search() {
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/SearchResignation",
            traditional: true,
            data: JSON.stringify({sEmployeeIDs:_sEmployeeIDs}),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                var oEmployeeSettlements = jQuery.parseJSON(data);
                if (oEmployeeSettlements[0].ErrorMessage=="" && oEmployeeSettlements.length > 0) {
                    DynamicRefreshList(oEmployeeSettlements, "tblEmployeeSettlements");
                } else {
                    alert(oEmployeeSettlements[0].ErrorMessage);
                    DynamicRefreshList([], "tblEmployeeSettlements");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }

    function PrintTypeObject()
    {
        var oObj= new Object();
        var oItems=[];

        oObj= new Object();
        oObj.id=5;
        oObj.Item="Final Settlement Salary Sheet";
        oItems.push(oObj);
        
        if(PermissionChecker('Final_Settlement_Salary_Sheet_AMG','EmployeeSettlement',_oAURolesMapping))
        {
            oObj= new Object();
            oObj.id=6;
            oObj.Item="Final Settlement Salary Sheet AMG";
            oItems.push(oObj);
        }

        $("#cboPrintType").icsLoadCombo({
            List: oItems,
            OptionValue: "id",
            DisplayText: "Item"
        });
        $('#btnPrint').hide();
        $('#btnXL').hide();
    }

    $('#cboPrintType').change(function (e)
    {
        var nPrintType=$('#cboPrintType').val();
        if(nPrintType == 5)
        {
            $('#btnPrint').show();
            $('#btnXL').show();
            $('#chkDept').show();
            $('#lblDept').show();
        }
        else if(nPrintType==6)
        {
            $('#btnPrint').show();
            $('#btnXL').show();
            $('#chkDept').hide();
            $('#lblDept').hide();
        }
    });

    $('#btnXL').click(function (e)
    {
        var nPrintType=$('#cboPrintType').val();
        if(nPrintType==5)
        {
            EmpSettlementSummary_XL();
        }
        if(nPrintType==6)
        {
            EmpSettlementSummary_XL_AMG();
        }
    });

    function EmpSettlementSummary_XL_AMG()
    {
        var dtStartDate=$('#dtStartDate').datebox('getValue');
        var dtEndDate=$('#dtEndDate').datebox('getValue');
        var nSettlementType=$('#cboSettlementType').val();
        var nClearanceStatus=$('#cboClearanceStatus_Search').val();
        var nApproveStatus=0;
        
        var sLocationIDs = $("#txtLocation_Colection").val();
        var sBusinessUnitIDs = $("#txtBusinessUnit_Collection").val();
        var sDepartmentIDs = $("#txtDepartment_Collection").val();
        var sDesignationIDs = $("#txtDesignation_Collection").val();
        var sEmpIDs = $("#txtEmployee_Collection").val();

        if($('#chkApprove').is(":checked"))
        {
            nApproveStatus=1;
        }
        if($('#chkUnApprove').is(":checked"))
        {
            nApproveStatus=2;
        }
        var sParam=dtStartDate+"~"+dtEndDate+"~"+nSettlementType+"~"+ _sDepartmentIds+"~"+_sDesignationIds+"~"+nClearanceStatus
            +"~"+nApproveStatus

            +"~"+_sBusinessUnitIds
            +"~"+_sLocationID
            +"~"+ _sEmployeeIDs

        window.open(_sBaseAddress+ "/Compliance/EmpSettlementSummary_XL_AMG?sParam="+sParam, "_blank");
    }

     
    function EmpSettlementSummary_XL()
    {
        var dtStartDate=$('#dtStartDate').datebox('getValue');
        var dtEndDate=$('#dtEndDate').datebox('getValue');
        var nSettlementType=$('#cboSettlementType').val();
        var nClearanceStatus=$('#cboClearanceStatus_Search').val();
        var nApproveStatus=0;
        
        var sLocationIDs = $("#txtLocation_Colection").val();
        var sBusinessUnitIDs = $("#txtBusinessUnit_Collection").val();
        var sDepartmentIDs = $("#txtDepartment_Collection").val();
        var sDesignationIDs = $("#txtDesignation_Collection").val();
        var sEmpIDs = $("#txtEmployee_Collection").val();

        if($('#chkApprove').is(":checked"))
        {
            nApproveStatus=1;
        }
        if($('#chkUnApprove').is(":checked"))
        {
            nApproveStatus=2;
        }
        var sParam=dtStartDate+"~"+dtEndDate+"~"+nSettlementType+"~"+ _sDepartmentIds+"~"+_sDesignationIds+"~"+nClearanceStatus
            +"~"+nApproveStatus

            +"~"+_sBusinessUnitIds
            +"~"+_sLocationID
            +"~"+ _sEmployeeIDs

        window.open(_sBaseAddress+ "/Compliance/EmpSettlementSummary_XL?sParam="+sParam, "_blank");
    }
    
    function EmployeeSettlementSalary() {
        var dtStartDate=$('#dtStartDate').datebox('getValue');
        var dtEndDate=$('#dtEndDate').datebox('getValue');
        var nSettlementType=$('#cboSettlementType').val();
        var nClearanceStatus=$('#cboClearanceStatus_Search').val();
        var nApproveStatus=0;
        
        var sLocationIDs = $("#txtLocation_Colection").val();
        var sBusinessUnitIDs = $("#txtBusinessUnit_Collection").val();
        var sDepartmentIDs = $("#txtDepartment_Collection").val();
        var sDesignationIDs = $("#txtDesignation_Collection").val();
        var sEmpIDs = $("#txtEmployee_Collection").val();
        
        var bGroupDept=0;
        if($('#chkDept').is(":checked"))
        {
            bGroupDept = 1;
        }
        if($('#chkApprove').is(":checked"))
        {
            nApproveStatus=1;
        }
        if($('#chkUnApprove').is(":checked"))
        {
            nApproveStatus=2;
        }
        var sParam=dtStartDate+"~"+dtEndDate+"~"+nSettlementType+"~"+ _sDepartmentIds+"~"+_sDesignationIds+"~"+nClearanceStatus
            +"~"+nApproveStatus

            +"~"+_sBusinessUnitIds
            +"~"+_sLocationID
            +"~"+ _sEmployeeIDs
            +"~"+bGroupDept
        window.open(_sBaseAddress+ "/Compliance/FinalSettlementSalaryPDF?sParam="+sParam, "_blank");
    }
    function EmployeeSettlementSalaryAMG() {
        var dtStartDate=$('#dtStartDate').datebox('getValue');
        var dtEndDate=$('#dtEndDate').datebox('getValue');
        var nSettlementType=$('#cboSettlementType').val();
        var nClearanceStatus=$('#cboClearanceStatus_Search').val();
        var nApproveStatus=0;
        
        var sLocationIDs = $("#txtLocation_Colection").val();
        var sBusinessUnitIDs = $("#txtBusinessUnit_Collection").val();
        var sDepartmentIDs = $("#txtDepartment_Collection").val();
        var sDesignationIDs = $("#txtDesignation_Collection").val();
        var sEmpIDs = $("#txtEmployee_Collection").val();

        var bGroupDept=0;
        if($('#chkDept').is(":checked"))
        {
            bGroupDept = 1;
        }
        if($('#chkApprove').is(":checked"))
        {
            nApproveStatus=1;
        }
        if($('#chkUnApprove').is(":checked"))
        {
            nApproveStatus=2;
        }
        var sParam=dtStartDate+"~"+dtEndDate+"~"+nSettlementType+"~"+ _sDepartmentIds+"~"+_sDesignationIds+"~"+nClearanceStatus
            +"~"+nApproveStatus

            +"~"+_sBusinessUnitIds
            +"~"+_sLocationID
            +"~"+ _sEmployeeIDs
            +"~"+bGroupDept
        window.open(_sBaseAddress+ "/Compliance/FinalSettlementSalaryPDFAMG?sParam="+sParam, "_blank");
    }

    function PrintFinalSettlement() {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        //if (oEmployeeSettlement.ApproveBy<=0) {
        //    alert("This item is not approved!");
        //    return;
        //}
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/EmployeeSettlement/PrintFinalSettlement_XL?nEmployeeSettlementID="+oEmployeeSettlement.EmployeeSettlementID+"&ts="+tsv, "_blank");
    }

    function PrintSettlementPaySlip() 
    {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
       
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/EmployeeSettlement/PrintSettlementPaySlip_XL?nEmployeeSettlementID="+oEmployeeSettlement.EmployeeSettlementID, "_blank");
    }

    $('#btnPrint').click(function (e)
    {
        var nPrintType=$('#cboPrintType').val();
        if(nPrintType==2)
        {
            PrintReleaseLetter();
        }
        if(nPrintType==5)
        {
            EmployeeSettlementSalary();
        }
        if(nPrintType==6)
        {
            EmployeeSettlementSalaryAMG();
        }
    });

    function PrintReleaseLetter() {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        //if (oEmployeeSettlement.ApproveBy<=0) {
        //    alert("This item is not approved!");
        //    return;
        //}
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/Compliance/PrintReleaseLetter?nEmployeeSettlementID="+oEmployeeSettlement.EmployeeSettlementID+"&ts="+tsv, "_blank");
    }

    $('#chkApprove').click(function (e)
    {
        if ($('#chkApprove').is(":checked"))
        {
            $('#chkUnApprove').prop('checked', false);
        }
    });

    $('#chkUnApprove').click(function (e)
    {
        if ($('#chkUnApprove').is(":checked"))
        {
            $('#chkApprove').prop('checked', false);
        }
    });

    function Approve() {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        if (oEmployeeSettlement.ApproveBy > 0) {
            alert("Already Approved !");
            return;
        }
        if (!confirm("Confirm to Approve? After Approve you can not undo!")) return;
        var SelectedRowIndex = $('#tblEmployeeSettlements').datagrid('getRowIndex', oEmployeeSettlement);
        oEmployeeSettlement.EffectDate=oEmployeeSettlement.EffectDateInString;
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/EmployeeSettlement_Approve",
            traditional: true,
            data: JSON.stringify(oEmployeeSettlement),
            contentType: "application/json; charset=utf-8",

            success: function(data) {
                debugger;
                oEmployeeSettlement = jQuery.parseJSON(data);
                if (oEmployeeSettlement.EmployeeSettlementID > 0) {
                    alert("Data Saved sucessfully");
                    $('#tblEmployeeSettlements').datagrid('updateRow', { index: SelectedRowIndex, row: oEmployeeSettlement });

                } else {
                    alert(oEmployeeSettlement.ErrorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }

    function UndoApprove() {
        var oEmployeeSettlement = $('#tblEmployeeSettlements').datagrid('getSelected');
        if (oEmployeeSettlement == null || oEmployeeSettlement.EmployeeSettlementID <= 0) {
            alert("Please select an item from list!");
            return;
        }
        if (oEmployeeSettlement.ApproveBy <= 0) {
            alert(" This item is not approved!");
            return;
        }

        //check last working date
        if(new Date() > new Date(oEmployeeSettlement.EffectDateInString)) {
            alert("You can not undo Approve because of Expired Date");
            return;
        }

        var SelectedRowIndex = $('#tblEmployeeSettlements').datagrid('getRowIndex', oEmployeeSettlement);
        if (!confirm("Confirm to Undo Approve!")) return;
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/EmployeeSettlement/EmployeeSettlement_UndoApprove",
            traditional: true,
            data: JSON.stringify(oEmployeeSettlement),
            contentType: "application/json; charset=utf-8",

            success: function(data) {
                debugger;
                oEmployeeSettlement = jQuery.parseJSON(data);
                if (oEmployeeSettlement.EmployeeSettlementID > 0) {
                    alert("Data Saved sucessfully");
                    $('#tblEmployeeSettlements').datagrid('updateRow', { index: SelectedRowIndex, row: oEmployeeSettlement });

                } else {
                    alert(oEmployeeSettlement.ErrorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });
    }
</script>
