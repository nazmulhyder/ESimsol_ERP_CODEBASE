@{
    ViewBag.Title = "Sales Contract";
}
<html>

<body>
    @model ESimSol.BusinessObjects.ExportPI
    <div id="divExportPI" class="menuMainCollectionTable" style="font-family:Tahoma; height:100%; width:100%;overflow:hidden;">
        <div id="tabSalesContract" class="easyui-tabs" style="width:100%;height:100%">
            <div title="Commission Distribute" style="padding:2px">
                <div style="height:83%;width:100%;overflow:hidden;">
                    <div style="width:100%;">
                        <fieldset>
                            <legend style="text-align:left; font-weight:bold;"> Sales Contract Informations : </legend>
                            <table style="width: 100%;" cellspacing="1" cellpadding="1">
                                <tr>
                                    <td style="width:10%; text-align:right">
                                        <label>
                                            PI No
                                        </label>
                                    </td>
                                    <td style="width:20%; text-align:left">
                                        <input type="text" id="txtPINo" style="width:100%;" readonly="readonly" />
                                    </td>

                                    <td style="width:10%; text-align:right">
                                        <label>
                                            PI Date
                                        </label>
                                    </td>
                                    <td style="width:20%; text-align:left">
                                        <input type="text" id="txtIssueDate" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:10%; text-align:right">
                                        <label>
                                            MKT Person
                                        </label>
                                    </td>
                                    <td style="width:30%; text-align:left">
                                        <input type="text" id="txtMKTPerson" style="width:86%;" readonly="readonly" />
                                    </td>

                                </tr>
                                <tr>
                                    <td style="width:10%; text-align:right">
                                        <label>
                                            Account Of
                                        </label>
                                    </td>
                                    <td colspan="2" style="width:30%; text-align:left">
                                        <input type="text" id="txtContractorName" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:20%; text-align:right">
                                        <label>
                                            Buying House
                                        </label>
                                    </td>
                                    <td colspan="2" style="width:40%; text-align:left">
                                        <input type="text" id="txtBuyerName" style="width:90%;" readonly="readonly" />
                                    </td>
                                </tr>

                            </table>
                            <table style="width: 100%;" cellspacing="1" cellpadding="1">
                                <tr>
                                    <td style="width:10%; text-align:right">
                                        <label>       PI Value  </label> <span class="lblCurrency"></span>:
                                    </td>
                                    <td style="width:15%; text-align:left">
                                        <input type="text" id="txtPIValue" style="width:100%;" readonly="readonly" />
                                    </td>

                                    <td style="width:10%; text-align:right">
                                        <label>Adj Value</label><span class="lblCurrency"></span>:
                                    </td>
                                    <td style="width:15%; text-align:left">
                                        <input type="text" id="txtAdjAmount" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:13%; text-align:right">
                                        <label>
                                            Actule Value
                                        </label><span class="lblCurrency"></span>:
                                    </td>
                                    <td style="width:12%; text-align:left">
                                        <input type="text" id="txtActualValue" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:8%; text-align:right">
                                        <label>
                                            L/C No
                                        </label>
                                    </td>
                                    <td style="width:13%; text-align:left">
                                        <input type="text" id="txtLCNo" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:5%; text-align:left"></td>
                                </tr>
                                @*<tr>
                                    <td style="width:10%; text-align:right">
                                        <label>
                                            PI Qty
                                        </label><span class="lblMUnit"></span>:
                                    </td>
                                    <td style="width:15%; text-align:left">
                                        <input type="text" id="txtPIQty" style="width:100%;" readonly="readonly" />
                                    </td>

                                    <td style="width:10%; text-align:right">
                                        <label>
                                            Adj Qty
                                        </label><span class="lblMUnit"></span>:
                                    </td>
                                    <td style="width:15%; text-align:left">
                                        <input type="text" id="txtAdjQty" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:13%; text-align:right">
                                        <label> Net Dyeing  </label><span class="lblMUnit"></span>:
                                    </td>
                                    <td style="width:12%; text-align:left">
                                        <input type="text" id="txtNetDyeing" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:8%; text-align:right">
                                        <label>
                                            L/C Date
                                        </label>
                                    </td>
                                    <td style="width:13%; text-align:left">
                                        <input type="text" id="txtLCDate" style="width:100%;" readonly="readonly" />
                                    </td>
                                    <td style="width:5%; text-align:left"></td>
                                </tr>*@
                            </table>
                        </fieldset>
                    </div>
                    <div style="width:100%;">
                        <fieldset>
                            <legend style="text-align:left; font-weight:bold;">  </legend>
                            <table id="tblExportPIDetail_Com" class="easyui-datagrid" style="width:100%;height:160px;"
                                   data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarExportPIDetail_Com'">
                                <thead>
                                    <tr>
                                        <th field="ProductNameCode" width="20%" align="left"> </th>
                                        <th field="Qty" width="8%" align="right" formatter="formatPrice">Qty</th>
                                        <th field="UnitPrice" width="8%" align="right" formatter="formatPrice">Unit Price</th>
                                        <th field="Amount" width="8%" align="right" formatter="formatPrice">Amount</th>
                                        <th field="QtyCom" width="8%" align="right" formatter="formatPrice">Com. Qty</th>

                                        <th field="CRate" width="6%" align="right" >C. Rate</th>
                                        <th field="CRateTwo" width="6%" align="right">Buyer C.Rate</th>
                                        <th field="AmountCom" width="8%" align="right" formatter="formatPrice">Com. Amount</th>
                                        <th field="AmountComTwo" width="8%" align="right" formatter="formatPrice">Buyer Com.</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="toolbarExportPIDetail_Com">
                                <label id="lblRate">Commission Rate</label>
                                <a id="btnPickDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit Commission Rate</a>
                                <label id="lblTotalCRate" style="padding-left:20%"></label>
                            </div>
                            @*<table border="0" cellpadding="01" cellspacing="1" style="width:100%;">
                                <tr>
                                    <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                    <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblPercentage">0</label> </td>
                                    <td style="width:25%; text-align:center; font-weight:bold;"><label id="lblTotalComAmount"> </label> </td>
                                    <td style="width:30%; text-align:left; font-weight:bold;"><span class="lblBalanceText"></span><label id="lblBalancePI"> </label> </td>
                                </tr>
                            </table>*@
                            </fieldset>
</div>
                        <div style="width:100%;height:200px;">
                            <fieldset>
                                <legend style="text-align:left; font-weight:bold;">  </legend>
                                <table style="width:100% ;height:200px">
                                    <tr>
                                        <td style="width:55% ;height:200px; vertical-align:top">

                                            <table id="tblSalesCommissions" class="easyui-datagrid" style="width:100%;height:140px;"
                                                   data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarExportPIDetail',onClickRow:onClickRow ">
                                                <thead>
                                                    <tr>
                                                        <th field="ContractorName" width="20%" align="left"> </th>
                                                        <th field="CPName" width="30%" align="left"> Name</th>
                                                        <th data-options="field:'Percentage',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="15%">Percentage(%)</th>
                                                        <th data-options="field:'CommissionAmount',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="12%"> Amount($)</th>
                                                        <th field="StatusStr" width="10%" align="left"> Status</th>
                                                        
                                                    </tr>
                                                </thead>
                                            </table>
                                            <div id="toolbarExportPIDetail">
                                                <select style="width:20%;" id="cboContractor"></select>
                                                <label id="lblCPerson">Pay To</label>
                                                <input type="text" id="txtContactPersonnel" placeholder="Type Person Name" style="width:130px;" /><a id="btnCPersonnel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                                                <a id="btnDeleteDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                                                <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Refresh</a>
                                            </div>
                                            <table border="0" cellpadding="01" cellspacing="1" style="width:100%;">
                                                <tr>
                                                    <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                                    <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblPercentage">0</label> </td>
                                                    <td style="width:25%; text-align:center; font-weight:bold;"><label id="lblTotalComAmount"> </label> </td>
                                                    <td style="width:30%; text-align:left; font-weight:bold;"><span class="lblBalanceText"></span><label id="lblBalancePI"> </label> </td>
                                                </tr>
                                            </table>

                                        </td>
                                        <td style="width:45% ;height:200px;vertical-align:top">
                                            <fieldset>
                                                <legend style="font-weight: bold"> </legend>
                                                <table style="width: 100%;" cellspacing="1" cellpadding="1">
                                                    <tr>
                                                        <td style="width:60%; text-align:right">
                                                            <label>
                                                                Commission On:
                                                            </label>
                                                        </td>
                                                        <td style="width:40%; text-align:left">
                                                            <select style="width: 99%;" onchange="cboCommissionOn()" id="cboCommissionOn">
                                                                <option value="0">Rate(On Qty)</option>
                                                                <option value="1">PI Value</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="width:60%; text-align:right">
                                                            <label>
                                                                PI Commission:
                                                            </label>
                                                        </td>
                                                        <td style="width:40%; text-align:left">
                                                            <input type="text" id="txtPICommission" style="width:99%;" />
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="width:60%; text-align:right">
                                                            <label>
                                                                Percentage of PI Value(%):
                                                            </label>
                                                        </td>
                                                        <td style="width:40%; text-align:left">
                                                            <input type="text" id="txtPIComPerTage" style="width:99%;"  />
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="width:60%; text-align:right">
                                                            <label>
                                                                Commission Distribute:
                                                            </label>
                                                        </td>
                                                        <td style="width:40%; text-align:left">
                                                            <input type="text" id="txtCommissionDistrubte" style="width:99%;" disabled="disabled" />
                                                        </td>
                                                    </tr>
                                                </table>
                                            </fieldset>
                                            <fieldset>
                                                <legend style="font-weight: bold"> </legend>
                                                <table style="width: 100%;" cellspacing="1" cellpadding="1">
                                                    <tr>
                                                        <td style="width:60%; text-align:right">
                                                            <label>
                                                                Payable Percentage:
                                                            </label>
                                                        </td>
                                                        <td style="width:40%; text-align:left">
                                                            <input type="text" id="txtPercentage_Maturity" style="width:99%;" />
                                                        </td>
                                                    </tr>

                                                </table>
                                            </fieldset>
                                        </td>

                                    </tr>
                                </table>
                            </fieldset>
                        </div>
                 </div>
                <div style="width:100%; height:10%">
                    <fieldset>
                        <legend style="font-weight: bold">Action : </legend>
                        <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                            <tr>
                                <td style="width: 12%;text-align:right">
                                    <a id="btnPrintPreview1" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview (All)</a>
                                </td>
                                <td style="width: 17%;text-align:right">
                                    <a id="btnPrintPreview2" href="javascript:void(0)" style="font-size:10px" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview (Customer)</a>
                                </td>
                                <td style="width: 15%;text-align:right">
                                    <a id="btnPrintPreview3" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview (Buyer)</a>
                                </td>
                               
                                <td style="width:30%; text-align:right"></td>
                                <td style="width: 20%;text-align:right">
                                    <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                    <a id="btnReqForApprovePI" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-redo" plain="true">Req For App</a>
                                    <a id="btnUndoReqPI" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true">Undo Req</a>
                                </td>
                                <td style="width: 10%;text-align:right">
                                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
            </div>
            <div title="Product Description" style="padding:2px">
                <div style="width:100%;height:270px;">
                    <table id="tblExportPIDetail" title="Export PI Detail" class="easyui-datagrid" style="width:100%;height:250px;"
                           data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false">
                        <thead>
                            <tr>
                                <th rowspan="2" field="ProductNameCode" width="16%" align="left">Product Name</th>
                                @*<th rowspan="2" field="StyleNo" width="8%" align="center">Style</th>
                            <th rowspan="2" field="ColorInfo" width="8%" align="center">Color</th>*@
                                <th colspan="3" width="24%" align="center">PI Info</th>
                                <th colspan="3" width="24%" align="center">Adj Info</th>
                                <th colspan="2" width="16%" align="center">Actual Dyeing Info</th>
                                <th colspan="2" width="16%" align="center">Commission </th>
                            </tr>
                            <tr>
                                <th field="Qty" width="8%" align="right" formatter="formatPrice">Qty</th>
                                <th field="UnitPrice" width="8%" align="right" formatter="formatPrice">Unit Price</th>
                                <th field="Amount" width="10%" align="right" formatter="formatPrice">Amount</th>

                                <th field="AdjQty" width="8%" align="right" formatter="formatPrice">Qty</th>
                                <th field="AdjRate" width="8%" align="right" formatter="formatPrice">Unit Price</th>
                                <th field="AdjValue" width="8%" align="right" formatter="formatPrice">Amount</th>

                                <th field="ActualQty" width="8%" align="right" formatter="formatPrice">Qty</th>
                                <th field="ActualAmount" width="8%" align="right" formatter="formatPrice">Amount</th>
                                
                                <th field="CRate" width="6%" align="right" formatter="formatPrice">C.Rate</th>
                                <th field="AmountCom" width="10%" align="right" formatter="formatPrice">C. Com.</th>
                            </tr>
                        </thead>
                    </table>

                    <div style="float:left; width:100%;">
                        <div style="float:left; width:15%;" class="align-right">
                            <b>Total</b>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <label id="lbl-td-TotalQty">0</label><span class="lblMUnitTwo"></span>
                        </div>
                        <div style="float:left; width:16%;" class="align-right">
                            <span class="lblCurrencyTwo"></span> <label id="lbl-td-TotalAmount">0</label>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <label id="lbl-td-TotalAdjQty">0</label><span class="lblMUnitTwo"></span>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <span class="lblCurrencyTwo"></span><label id="lbl-td-TotalAdjValue">0</label>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <label id="lbl-td-TotalActualQty">0</label><span class="lblMUnitTwo"></span>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <span class="lblCurrencyTwo"></span> <label id="lbl-td-TotalActualAmount">0</label>
                        </div>
                        <div style="float:left; width:15%;" class="align-right">
                            <span class="lblCurrencyTwo"></span> <label id="lbl-td-TotalComAmount">0</label>
                        </div>
                    </div>

                </div>

                <div style="float:left; width:100%">

                </div>

                <fieldset>
                    <legend>Action</legend>
                    <div class="align-right">
                        <a id="btnSaveAdjustment" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnCloseAdjustment" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>
            </div>
            
        </div>

    </div>
    <div id="winExportPIDetailEdit" style="width:600px;" class="easyui-window" title="Edit Detail" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div>
            <fieldset>
                <legend style="font-weight:bold"> Detail info : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:20%;text-align:right">
                            Product:
                        </td>
                        <td style="width:80%;text-align:left">
                            <input type="text" id="txtProduct_Edit" style="width:75%" disabled="disabled" />
                            
                        </td>
                    </tr>


                </table>
                <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size: 11px; font-weight: bold">

                    <tr>
                        <td style="width: 20%; text-align: right">
                            Qty(<span class="lblMUnitOne"></span>):

                        </td>

                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width: 80%; text-align:right" id="txtQtyInOne" disabled="disabled" />
                        </td>
                        <td style="width: 20%; text-align: right">
                            Qty(<span class="lblMUnitTwo"></span>):
                        </td>

                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtQtyInTwo" disabled="disabled" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 20%; text-align: right">
                            Unit Price ($/<span class="lblMUnitOne"></span>):
                        </td>
                        <td style="width:30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtUnitPriceInOne" disabled="disabled" />
                        </td>
                        <td style="width: 20%; text-align: right">
                            Unit Price ($/<span class="lblMUnitTwo"></span>):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtUnitPriceInTwo" disabled="disabled" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 20%; text-align: right">
                            Amount(USD):
                        </td>
                        <td style="width:30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtAmount" disabled="disabled" />
                        </td>
                        <td style="width: 20%; text-align: right">
                            ColorInfo
                        </td>
                        <td style="width: 30%;">
                            <input type="text" style="width: 100%;" id="txtColorEdit" disabled="disabled" />
                        </td>
                    </tr>
                   
                    <tr>
                        <td style="width: 20%; text-align: right">
                           Com. Qty(<span class="lblMUnitOne"></span>):
                        </td>
                        <td style="width: 30%;">
                            <input type="text" style="width:80%; text-align:right" id="txtQtyCom" />
                        </td>
                        <td style="width: 20%; text-align: right">
                            Style No
                        </td>
                        <td style="width: 30%">
                            <input type="text" style="width: 100%;" id="txtStyleNo" disabled="disabled" />
                        </td>
                    </tr>
                    
                   
                    <tr>

                        <td style="width: 20%; text-align: right">
                            Com. Rate($/<span class="lblMUnitOne"></span>):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtCRate" onkeyup="SetComAmount(1)"/>
                        </td>
                        <td style="width: 20%; text-align: right">
                            Com. Amount(USD):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width: 80%; text-align:right" id="txtCAmount" disabled="disabled" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 20%; text-align: right">
                            Buyer Rate($/<span class="lblMUnitOne"></span>):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width:80%; text-align:right" id="txtCRateTwo" onkeyup="SetComAmount(2)" />
                        </td>
                        <td style="width: 20%; text-align: right">
                            Buyer Com.(USD):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width: 80%; text-align:right" id="txtCAmount2" disabled="disabled" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 20%; text-align: right">
                          
                        </td>
                        <td style="width: 30%; text-align: left">
                           
                        </td>
                        <td style="width: 20%; text-align: right">
                            Total Com.(USD):
                        </td>
                        <td style="width: 30%; text-align: left">
                            <input type="text" style="width: 80%; text-align:right" id="txtCAmountTotal" disabled="disabled" />
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
        <fieldset>
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:100%;text-align:right;">
                        <a id="btnUpdateEPIDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">OK</a>
                        <a id="btnCloseEPIDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>

                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    .td-summary-one {
        width: 17%;
    }

    .td-summary-two {
        width: 19%;
    }
</style>
<script type="text/javascript">
    var _oExportPI=null;
    var _sBaseAddress="";
    var _sExportPIHeader="";
    var _nMenuid=0;
    var _sBackLink="";
    var _nTotalAmount=0;
    var _oExportPIDetails=[];
    var _oSalesCommissions=[];
    var _oDOControlObj=[];
    var _oProductionType=[];
    var _nCommissionAmount=0;
    var _nCommissionAmount_PI=0;
    var _nPercentage=0;
    var _nCommissionAmount_Dis=0;
    var _oExportSC=null;
    var _nTotalCom_Customer=0;
    var _nTotalCom_Buyer=0;
    $(document).ready(function () {
        debugger;
        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oExportPI =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oExportPIDetails =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.ExportPIDetails));
        _oSalesCommissions =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.SalesCommissions));
        _oExportSC =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.ExportSC));
        
        _sBackLink=sessionStorage.getItem("BackLink");

        _sExportPIHeader=sessionStorage.getItem("ExportPIHeader");
        // $('#divExportPI').panel({ title:_sExportPIHeader});
        //$('#btnApprove').hide();
        debugger;
        RefreshControl();
        RefreshControlAdjSettle();
      
    });

    function RefreshControl()
    {
        $('#cboContractor').empty();
        var listDates = "<option value='"+_oExportSC.ContractorID+"'>" + "A/C Of:"+_oExportSC.ContractorName + "</option>";
        listDates+= "<option value='"+_oExportSC.BuyerID+"'>" +"B/H:"+_oExportSC.BuyerName + "</option>";
        $("#cboContractor").html(listDates);
        $(".lblCurrency").html("("+_oExportPI.Currency+")");
        $(".lblCurrencyTwo").html(_oExportPI.Currency);
        $('#txtPINo').val(_oExportPI.PINo_Full);
        $('#txtIssueDate').val(_oExportPI.IssueDateInString);
        $('#txtMKTPerson').val(_oExportPI.MKTPName);
        $('#txtContractorName').val(_oExportPI.ContractorName);
        $('#txtBuyerName').val(_oExportPI.BuyerName);

        $('#txtPIValue').val(formatPrice(_oExportPI.Amount,null));
        $('#txtAdjAmount').val(formatPrice(_oExportSC.AmountToBeAdjusted,null));
        $('#txtActualValue').val(formatPrice((_oExportPI.Amount-_oExportSC.AmountToBeAdjusted),null));

      

        $('#txtLCNo').val(_oExportPI.ELCNo);
        $('#btnReqForApprovePI,#btnUndoReqPI').hide();
        if(_oSalesCommissions!=null)
        {
            RefreshSalesCommissions(_oSalesCommissions)
            if(_oSalesCommissions != null &&_oSalesCommissions.length>0)
            {
                $('#txtPercentage_Maturity').val(_oSalesCommissions[0].Percentage_Maturity);
                $('#cboCommissionOn').val(_oSalesCommissions[0].CommissionOn);
                if(_oSalesCommissions[0].Status==1)
                { 
                    $('#btnReqForApprovePI,#btnSave').show();
                    $('#btnUndoReqPI').hide();
                }
                if(_oSalesCommissions[0].Status==2)
                {   $('#toolbarExportPIDetail,#toolbarExportPIDetail_Com,#btnReqForApprovePI,#btnSave').hide();
                    $('#btnUndoReqPI').show();
                    $('input,select').prop('disabled',true);
                }
                if(_oSalesCommissions[0].Status>2)
                {   $('#toolbarExportPIDetail,#toolbarExportPIDetail_Com,#btnReqForApprovePI,#btnSave,#btnUndoReqPI').hide();
                    //$('#cboCommissionOn').hide();
                $('input,select').prop('disabled',true);
                  
                }
            }
            else
            {
                $('#txtPercentage_Maturity').val(50);
            }
        }
        if(_oExportPI.ExportPIDetails!=null && _oExportPI.ExportPIDetails.length>0)
        {
            DynamicRefreshList(_oExportPIDetails, "tblExportPIDetail");
            DynamicRefreshList(_oExportPIDetails, "tblExportPIDetail_Com");

            if(_oExportPI.BuyerID<=0 || _oExportPI.ContractorID==_oExportPI.BuyerID){
                $("#tblExportPIDetail_Com").datagrid('hideColumn','AmountComTwo');
                $("#tblExportPIDetail_Com").datagrid('hideColumn','CRateTwo');
            }

            $(".lblMUnit").html("("+_oExportPI.ExportPIDetails[0].MUName+")");
            $(".lblMUnitTwo").html(" "+_oExportPI.ExportPIDetails[0].MUName);
        }
        
        RefreshSummary();
        cboCommissionOn();
    }

    function RefreshControlAdjSettle(){
        debugger;
       
        var oExportPIDetails= $('#tblExportPIDetail_Com').datagrid('getRows');
        _nCommissionAmount_PI=0;
        _nCommissionAmount=0;

        var nTotal_Customer = 0;
        var nTotal_Buyer = 0;
        
        var nQty=0, nAmount=0, nAdjQty=0, nAdjValue=0, nActualQty=0, nActualAmount=0;
        
        for(var i=0; i<oExportPIDetails.length;i++)
        {
            nQty=parseFloat(nQty)+ parseFloat(oExportPIDetails[i].Qty);
            nAmount=parseFloat(nAmount)+ parseFloat(oExportPIDetails[i].Amount);
            nAdjQty=parseFloat(nAdjQty)+ parseFloat(oExportPIDetails[i].AdjQty);
            nAdjValue=parseFloat(nAdjValue)+ parseFloat(oExportPIDetails[i].AdjValue);
            nActualQty=parseFloat(nActualQty)+ parseFloat(oExportPIDetails[i].ActualQty);
            nActualAmount=parseFloat(nActualAmount)+ parseFloat(oExportPIDetails[i].ActualAmount);
            
            _nCommissionAmount=parseFloat(_nCommissionAmount)+ parseFloat((oExportPIDetails[i].QtyCom)* (parseFloat(oExportPIDetails[i].CRate)+parseFloat(oExportPIDetails[i].CRateTwo)));
            //_nCommissionAmount_PI=parseFloat(_nCommissionAmount_PI)+ parseFloat((oExportPIDetails[i].QtyCom)*oExportPIDetails[i].CRate);
            
            nTotal_Customer+=parseFloat(oExportPIDetails[i].AmountCom);
            nTotal_Buyer+=parseFloat(oExportPIDetails[i].AmountComTwo);
        }
        _nCommissionAmount_PI=parseFloat(_nCommissionAmount_PI)+parseFloat(nTotal_Customer)+parseFloat(nTotal_Buyer);
        if(parseInt($('#cboCommissionOn').val())>0)
        {
            _nCommissionAmount=0;
            for (i = 0; i < _oSalesCommissions.length; ++i)
            {
                _nCommissionAmount=parseFloat(_nCommissionAmount)+ parseFloat(_oSalesCommissions[i].CommissionAmount);
            }
        }

        //console.log("Customer Amount: "+formatPrice(nTotal_Customer,0) +" || Buyer Amount: "+formatPrice(nTotal_Buyer,0));
        _nTotalCom_Buyer=nTotal_Buyer;
        _nTotalCom_Customer=nTotal_Customer;
        document.getElementById('lblTotalCRate').innerHTML =  (nTotal_Customer>0? "Customer Amount: "+formatPrice(nTotal_Customer,0) :"") + (nTotal_Buyer>0? " || Buyer Amount: "+formatPrice(nTotal_Buyer,0) :"");

        $('#lbl-td-TotalQty,#lblPIQty').text(formatPrice(nQty));
        $('#lbl-td-TotalAmount,#lblPIAmount').text(formatPrice(nAmount));
        $('#lbl-td-TotalAdjQty,#lblAdjQty').text(formatPrice(nAdjQty));

        $('#lbl-td-TotalActualQty,#lblActualQty').text(formatPrice(nActualQty));
        $('#lbl-td-TotalActualAmount,#lblActualAmount').text(formatPrice(nActualAmount));
        $('#lbl-td-TotalComAmount').text(formatPrice(_nCommissionAmount));
        $('#txtPICommission').val(formatPrice(parseFloat(nTotal_Customer)+parseFloat(nTotal_Buyer)));

        $('#lbl-td-TotalAdjValue,#lblAdjValue,#lblAdjAmount').text(formatPrice(_oExportSC.AmountToBeAdjusted));

        var nPIComPerTage = (parseFloat(_nCommissionAmount) / parseFloat(_oExportPI.Amount))*100;
        $('#txtPIComPerTage').val(icsFormatPrice(nPIComPerTage, null, 2));

        debugger;
    }

    function RefreshSalesCommissions(oSalesCommissions)
    {
        var data={"total":""+oSalesCommissions.length+"","rows":oSalesCommissions};
        $('#tblSalesCommissions').datagrid('loadData',data);
    }

    $('#btnSave').click(function(e){
        debugger;
        if(parseFloat(_nCommissionAmount)<=0)
        {
            alert("Commission not declare in P/I");
            return;
        }
        endEditing();
        var oSalesCommissions = $('#tblSalesCommissions').datagrid('getRows');
        if(oSalesCommissions.length<=0)
        {
            alert("Please checked at least one item.");
            return;
        }
        var nTotalPercentage=0;
        var nCommissionAmount=0;
        var nSelectedIndex=0;

        var indexLists=[];
        for (i = 0; i < oSalesCommissions.length; ++i)
        {
            nTotalPercentage+=parseFloat(oSalesCommissions[i].Percentage);
            nCommissionAmount+=parseFloat(parseFloat(oSalesCommissions[i].CommissionAmount).toFixed(2));
            oSalesCommissions[i].Percentage_Maturity=parseInt($('#txtPercentage_Maturity').val());
            oSalesCommissions[i].CommissionOn=parseInt($('#cboCommissionOn').val());
          
            nSelectedIndex = $('#tblSalesCommissions').datagrid('getRowIndex', oSalesCommissions[i]);
            indexLists.push(nSelectedIndex);
        }

        if(parseInt($('#cboCommissionOn').val())<=0)
        {
            if(parseFloat(_nCommissionAmount_PI).toFixed(2)!=parseFloat(nCommissionAmount).toFixed(2))
            {
                alert("Commission distribute Amount never exced P/I Commission Amount. PI:"+ parseFloat(_nCommissionAmount_PI).toFixed(2)+", Distribute Commission:"+parseFloat(nCommissionAmount).toFixed(2));
                return;
            }
        }
        else
        {
            if(parseFloat(_nCommissionAmount).toFixed(2)!=parseFloat(nCommissionAmount).toFixed(2))
            {
                alert("Commission distribute Amount never exced P/I CommissionAmount.Total Commission: "+_nCommissionAmount+", Distribute Amount:"+nCommissionAmount);
                return;
            }
        }
        if(parseFloat(nTotalPercentage)!=100)
        {
            alert("100% Commission yet not Declare.");
            return;
        }

        if(parseFloat(nCommissionAmount)<=0)
        {
            alert("Commission Amount is zero.");
            return;
        }
        if(parseFloat(nTotalPercentage)<=0)
        {
            alert("100% Commission yet not Declare.");
            return;
        }

     

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ExportSC/SaveSalesCommossion",
            traditional: true,
            data:  JSON.stringify(oSalesCommissions),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oSalesCommissions =jQuery.parseJSON(data);
                    
                if (oSalesCommissions[0].ErrorMessage == '' || oSalesCommissions[0].ErrorMessage == null)
                {
                    for (i = 0; i < oSalesCommissions.length; ++i)
                    {
                        //oSalesCommissions[i].IsOparate=-1;
                        $('#tblSalesCommissions').datagrid('updateRow', { index:  indexLists[i], row: oSalesCommissions[i] });
                        $('#tblSalesCommissions').datagrid('selectRow', indexLists[i]);
                    }
                    alert("Save  Successfully");
                    //  window.location.href =_sBackLink;
                    $('#btnReqForApprovePI').show();
                }
                else
                {
                    alert(oSalesCommissions[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });
    $('#btnReqForApprovePI').click(function(e){
        debugger;
        endEditing();
        if(parseFloat(_nCommissionAmount)<=0)
        {
            alert("Commission not declare ");
            return;
        }
      
        var oSalesCommissions = $('#tblSalesCommissions').datagrid('getRows');
        if(oSalesCommissions.length<=0)
        {
            alert("Please checked at least one item.");
            return;
        }
        var nTotalPercentage=0;
        var nCommissionAmount=0;
        var nSelectedIndex=0;
        var indexLists=[];
        for (i = 0; i < oSalesCommissions.length; ++i)
        {
            nTotalPercentage+=parseFloat(oSalesCommissions[i].Percentage);
            nCommissionAmount+=parseFloat(oSalesCommissions[i].CommissionAmount);
            oSalesCommissions[i].Percentage_Maturity=parseInt($('#txtPercentage_Maturity').val());
            oSalesCommissions[i].Status = 2;
            oSalesCommissions[i].CommissionOn=parseInt($('#cboCommissionOn').val());
          
            nSelectedIndex = $('#tblSalesCommissions').datagrid('getRowIndex', oSalesCommissions[i]);
            indexLists.push(nSelectedIndex);
        }

        if(parseInt($('#cboCommissionOn').val())<=0)
        {
            if(parseFloat(_nCommissionAmount_PI).toFixed(2)!=parseFloat(nCommissionAmount).toFixed(2))
            {
                alert("Commission distribute Amount never exced P/I Commission Amount.");
                return;
            }
        }
        else
        {
            if(parseFloat(_nCommissionAmount).toFixed(2)!=parseFloat(nCommissionAmount).toFixed(2))
            {
                alert("Commission distribute Amount never exced P/I CommissionAmount.");
                return;
            }
        }
        if(parseFloat(nTotalPercentage)!=100)
        {
            alert("100% Commission yet not Declare.");
            return;
        }

        if(parseFloat(nCommissionAmount)<=0)
        {
            alert("Commission Amount is zero.");
            return;
        }
        if(parseFloat(nTotalPercentage)<=0)
        {
            alert("100% Commission yet not Declare.");
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ExportSC/RequestedSalesCommossion",
            traditional: true,
            data:  JSON.stringify(oSalesCommissions),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oSalesCommissions =jQuery.parseJSON(data);
                    
                if (oSalesCommissions[0].ErrorMessage == '' || oSalesCommissions[0].ErrorMessage == null)
                {
                    for (i = 0; i < oSalesCommissions.length; ++i)
                    {
                        //oSalesCommissions[i].IsOparate=-1;
                        $('#tblSalesCommissions').datagrid('updateRow', { index:  indexLists[i], row: oSalesCommissions[i] });
                        $('#tblSalesCommissions').datagrid('selectRow', indexLists[i]);
                    }
                    alert("Save  Successfully");
                    window.location.href =_sBackLink;
                }
                else
                {
                    alert(oSalesCommissions[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });
    $('#btnUndoReqPI').click(function(e){
        debugger;
        endEditing();
        if(parseFloat(_nCommissionAmount)<=0)
        {
            alert("Commission not declare ");
            return;
        }
      
        var oSalesCommissions = $('#tblSalesCommissions').datagrid('getRows');
        if(oSalesCommissions.length<=0)
        {
            alert("Please checked at least one item.");
            return;
        }
        var nTotalPercentage=0;
        var nCommissionAmount=0;
        var nSelectedIndex=0;
        var indexLists=[];
        for (i = 0; i < oSalesCommissions.length; ++i)
        {
            nTotalPercentage+=parseFloat(oSalesCommissions[i].Percentage);
            nCommissionAmount+=parseFloat(oSalesCommissions[i].CommissionAmount);
            oSalesCommissions[i].Percentage_Maturity=parseInt($('#txtPercentage_Maturity').val());
            oSalesCommissions[i].Status = 1;
            oSalesCommissions[i].CommissionOn=parseInt($('#cboCommissionOn').val());
          
            nSelectedIndex = $('#tblSalesCommissions').datagrid('getRowIndex', oSalesCommissions[i]);
            indexLists.push(nSelectedIndex);
        }


        if(parseFloat(nCommissionAmount)<=0)
        {
            alert("Commission Amount is zero.");
            return;
        }
        if(parseFloat(nTotalPercentage)<=0)
        {
            alert("100% Commission yet not Declare.");
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ExportSC/RequestedSalesCommossion",
            traditional: true,
            data:  JSON.stringify(oSalesCommissions),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oSalesCommissions =jQuery.parseJSON(data);
                    
                if (oSalesCommissions[0].ErrorMessage == '' || oSalesCommissions[0].ErrorMessage == null)
                {
                    for (i = 0; i < oSalesCommissions.length; ++i)
                    {
                        //oSalesCommissions[i].IsOparate=-1;
                        $('#tblSalesCommissions').datagrid('updateRow', { index:  indexLists[i], row: oSalesCommissions[i] });
                        $('#tblSalesCommissions').datagrid('selectRow', indexLists[i]);
                    }
                    alert("Save  Successfully");
                    $('#btnUndoReqPI').hide();
                    $('#toolbarExportPIDetail,#toolbarExportPIDetail_Com,#btnReqForApprovePI,#btnSave').show();
                    $('#cboCommissionOn,#txtPercentage_Maturity,#txtContactPersonnel,#txtPIComPerTage').prop('disabled',false);
                    cboCommissionOn();
                    //RefreshControl();
                    //_oSalesCommissions= $('#tblSalesCommissions').datagrid('getRows');
                    //window.location.href =_sBackLink;
                }
                else
                {
                    alert(oSalesCommissions[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });
  
    $("#btnClose,#btnCloseAdjustment,#btnCloseTerms").click(function(){
        window.location.href =_sBackLink;// _sBaseAddress+ "/ExportSC/ViewExportSCs?menuid="+_nMenuid;
    });

    /////////////End /////////////////////

    /////End

    //////////// Detail ////////
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblSalesCommissions').datagrid('validateRow', editIndex)) {
            $('#tblSalesCommissions').datagrid('endEdit', editIndex);
            $('#tblSalesCommissions').datagrid('selectRow', editIndex);
            var oSalesCommission = $('#tblSalesCommissions').datagrid('getSelected');
            debugger;
            if (parseFloat(oSalesCommission.Percentage) != parseFloat(_nPercentage).toFixed(2))
            {
                oSalesCommission.CommissionAmount=parseFloat((oSalesCommission.Percentage* _nCommissionAmount)/100);
            }
            //else if (parseFloat(oSalesCommission.CommissionAmount) != parseFloat(_nCommissionAmount_Dis).toFixed(2))
            //{
            //   oSalesCommission.Percentage=parseFloat((oSalesCommission.CommissionAmount* 100)/_nCommissionAmount).toFixed(2);
            //}


            $('#tblSalesCommissions').datagrid('updateRow', { index: editIndex, row: oSalesCommission });

            RefreshSummary();
            _nPercentage = 0;
            _nCommissionAmount_Dis = 0;
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblSalesCommissions').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oSalesCommission= $('#tblSalesCommissions').datagrid('getSelected');
                _nPercentage = parseFloat(oSalesCommission.Percentage).toFixed(2);
                _nCommissionAmount_Dis = parseFloat(oSalesCommission.CommissionAmount).toFixed(2);
                editIndex = index;
            }
            else {
                $('#tblSalesCommissions').datagrid('selectRow', editIndex);
            }
        }
    }

    //Product Part
    $("#txtContactPersonnel").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);

        if (code == 13) // Enter Press
        {
            if(parseFloat(_nCommissionAmount)<=0)
            {
                alert("Commission not declare ");
                return;
            }
            
            GetsCPersonnel();
        }
        if (code == 8) //backspace=8
        {
            var txtContactPersonnel = document.getElementById("txtContactPersonnel");
            txtContactPersonnel.value = '';
            txtContactPersonnel.style.color = "black";
            txtContactPersonnel.style.fontWeight = "normal";

        }
    });
    //Load for button click
    $("#btnCPersonnel").click(function () {
        GetsCPersonnel();
    });

    function GetsCPersonnel()
    {
      
        if(parseInt($("#cboContractor").val())<=0)
        {
            alert("Select Factory or Buyer Name");
            $('#cboContractor').focus();
            return;
        }
        if(parseFloat(_nCommissionAmount)<=0)
        {
            alert("Commission not declare in P/I");
            return;
        }
        var sContractorID='';
        sContractorID= $("#cboContractor").val();
            
        var oContactPersonnel = { ContractorName:sContractorID,Name:""};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContactPersonnel,
            ControllerName: "ContractorPersonal",
            ActionName: "GetsByContractors",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0)
            {
                if (response.objs[0].ContactPersonnelID > 0) {
                    var tblColums = [];var oColumn ={};
                    oColumn= { field: "ContactPersonnelID", title: "Code", width: 60, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 180, align: "left" }; tblColums.push(oColumn);
                    //oColumn = { field: "ContractorName", title: "ContractorName", width: 150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winCPersonPicker',
                        winclass: 'clsCPersinPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblCPersonPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Person List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiple return
                }
                else {
                    alert("Data Not Found");
                    return;
                }

            }
            else{
                alert("Data Not Found");
                return;
            }
        });
    }


    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winCPersonPicker')
        {
            debugger;

            if (oreturnobjs!=null && oreturnobjs.length > 0) {
                $("#txtContactPersonnel").val(oreturnobjs.length+' item(s) selected');
                $("#txtContactPersonnel").addClass('fontColorOfPickItem');
                CPersonMapping(oreturnobjs);
            }
        }
      
    }

    function CPersonMapping(oContactPersonnel)
    {
        debugger;
        var bExists=false;
        var oSalesCommission=null;
        if(parseInt($("#cboContractor").val())<=0)
        {
            alert("Select Factory or Buyer Name");
            $('#cboContractor').focus();
            return;
        }
        for (i=0; i<oContactPersonnel.length;i++)
        {
            oSalesCommission={ 
                SalesCommissionID: 0,
                ContactPersonnelID:oContactPersonnel[i].ContactPersonnelID,
                CPName :oContactPersonnel[i].Name,
                ContractorName:oContactPersonnel[i].ContractorName,
                ContractorID:parseInt($("#cboContractor").val()),
                ExportPIID :_oExportPI.ExportPIID,
                Currency :_oExportPI.Currency,
                Percentage:0,
                CommissionAmount:0,
              Percentage_Maturity:0
            };

            var bExists= IsExist(oContactPersonnel[i].ContactPersonnelID)
            if(!bExists)
            {
              $('#tblSalesCommissions').datagrid('appendRow',oSalesCommission);
            }
        }
        RefreshSummary();
        //SetSalesComAmount();
    }
    function IsExist(nContactPersonnelID)
    {
        var oPRDetails = $('#tblSalesCommissions').datagrid('getRows');

        for (var i = 0; i < oPRDetails.length; i++) {
            if (parseInt(oPRDetails[i].ContactPersonnelID) == parseInt(nContactPersonnelID))
            {
                return true;
            }
        }

        return false;
    }

    function RefreshSummary()
    {
        debugger;
        var oSalesCommissions = $('#tblSalesCommissions').datagrid('getRows');
        var nTotalPercentage = 0;
        var nBalance = 0;
        var nCommissionAmount=0;
        for(var i = 0; i<oSalesCommissions.length;i++)
        {
            nTotalPercentage+=parseFloat(oSalesCommissions[i].Percentage);
            nCommissionAmount+=parseFloat(parseFloat(oSalesCommissions[i].CommissionAmount).toFixed(2));
        }
        nBalance=(_nCommissionAmount-nCommissionAmount);
        if(nBalance>0)
        {
            $(".lblBalanceText").html("Yet To Convert: ");
        }
        else{
            nBalance=(-1)*nBalance;
            $(".lblBalanceText").html(" Over Converted: ");
        }
        document.getElementById('lblPercentage').innerHTML = formatPrice(nTotalPercentage,0)+" %";
        document.getElementById('lblTotalComAmount').innerHTML = _oExportPI.Currency+''+formatPrice(nCommissionAmount,0);
        //document.getElementById('lblBalancePI').innerHTML = _oExportPI.Currency+''+formatPrice( nBalance,0);
        $('#txtCommissionDistrubte').val(formatPrice(nCommissionAmount));
    }

    function SetSalesComAmount(){
        debugger;
        var oSalesCommissions_Result=[];
        var oSalesCommissions= $('#tblSalesCommissions').datagrid('getRows');
        var oSalesCommissions_Buyer=GetCPByID(_oExportPI.BuyerID);
        var oSalesCommissions_Customer=GetCPByID(_oExportPI.ContractorID);
        for (i=0; i<oSalesCommissions_Customer.length;i++)
        {
            oSalesCommissions_Customer[i].CommissionAmount=(_nTotalCom_Customer/oSalesCommissions_Customer.length);
            oSalesCommissions_Customer[i].Percentage= (_nTotalCom_Customer/oSalesCommissions_Customer.length)*100/(parseFloat(_nTotalCom_Buyer) + parseFloat(_nTotalCom_Customer)) ;
            oSalesCommissions_Result.push(oSalesCommissions_Customer[i]);
        }
        for (i=0; i<oSalesCommissions_Buyer.length;i++)
        {
            oSalesCommissions_Buyer[i].CommissionAmount=(_nTotalCom_Buyer/oSalesCommissions_Buyer.length);
            oSalesCommissions_Buyer[i].Percentage= (_nTotalCom_Buyer/oSalesCommissions_Buyer.length)*100/(parseFloat(_nTotalCom_Buyer) + parseFloat(_nTotalCom_Customer)) ;
            oSalesCommissions_Result.push(oSalesCommissions_Buyer[i]);
        }
        debugger;
        $('#tblSalesCommissions').datagrid('loadData',[]);
        var data={"total":""+oSalesCommissions_Result.length+"","rows":oSalesCommissions_Result};
        $('#tblSalesCommissions').datagrid('loadData',data);
     
        RefreshSummary();
    }
    function GetCPByID(nID)
    {
        var oResults=[];

        var oPRDetails = $('#tblSalesCommissions').datagrid('getRows');

        for (var i = 0; i < oPRDetails.length; i++) {
            if (parseInt(oPRDetails[i].ContractorID) == parseInt(nID))
            {
                oResults.push(oPRDetails[i]);
            }
        }
        return oResults;
    }
    $("#btnDeleteDetail").click(function () {
        var oSalesCommission = $('#tblSalesCommissions').datagrid('getSelected');
        if (oSalesCommission == null) {
            alert("Invalid Selection!!! please select a valid Item!");
            return false;
        }
        if (!confirm("Confirm to Remove?")) return;
        if(oSalesCommission.SalesCommissionID>0)
        {
            var obj =
               {
                   BaseAddress: _sBaseAddress,
                   Object: oSalesCommission,
                   ObjectId: oSalesCommission.SalesCommissionID,
                   ControllerName: "ExportSC",
                   ActionName: "DeleteSalesCommossion",
                   TableId: "tblSalesCommissions",
                   IsWinClose: true
               };
            $.icsDelete(obj);
          
            endEditing();
            RefreshSummary();
        }
        else{

            var SelectedRowIndex = $('#tblSalesCommissions').datagrid('getRowIndex', oSalesCommission);
            $('#tblSalesCommissions').datagrid('deleteRow',SelectedRowIndex);
        }
        RefreshSummary();
        editIndex = undefined;
    });
    $("#btnRefresh").click(function () {

        endEditing();
    });
  
    $("#btnPrintPreview1").click(function() {

        if(_oExportPI==null || _oExportPI.ExportPIID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress + '/SalesCommissionLC/PrintCommissionMemoReportByPI?nId=' + parseInt(_oExportPI.ExportPIID)+"&nType="+1+"&nts="+nts, "_blank");
    });
    $("#btnPrintPreview2").click(function() {

        if(_oExportPI==null || _oExportPI.ExportPIID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress + '/SalesCommissionLC/PrintCommissionMemoReportByPI?nId=' + parseInt(_oExportPI.ExportPIID)+"&nType="+2+"&nts="+nts, "_blank");
    });
    $("#btnPrintPreview3").click(function() {

        if(_oExportPI==null || _oExportPI.ExportPIID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress + '/SalesCommissionLC/PrintCommissionMemoReportByPI?nId=' + parseInt(_oExportPI.ExportPIID)+"&nType="+3+"&nts="+nts, "_blank");
    });
    ////Edit
    function SetComAmount(nID)
    {
        debugger;
        var oExportPIDetail = $('#tblExportPIDetail_Com').datagrid('getSelected');

        var nTotalRate=parseFloat($('#txtCRate').val())+parseFloat($('#txtCRateTwo').val());
        if(oExportPIDetail.UnitPrice<=nTotalRate){
            alert("Sorry, Com. Rate Can Not Be Greater Than Unit Price!"); return;
        }
        if(nID==1)
        {
            $('#txtCAmount').val("$"+parseFloat(oExportPIDetail.QtyCom* parseFloat($('#txtCRate').val()).toFixed(4)).toFixed(2));
        }
        else if(nID==2)
        {
            $('#txtCAmount2').val("$"+parseFloat(oExportPIDetail.QtyCom* parseFloat($('#txtCRateTwo').val()).toFixed(4) ).toFixed(2));
        }
            

        $('#txtCAmountTotal').val(parseFloat(oExportPIDetail.QtyCom * (parseFloat($('#txtCRateTwo').val())+parseFloat($('#txtCRate').val()) )).toFixed(2));
    }
    $("#btnPickDetail").click(function () {
        debugger;
        $("#winExportPIDetailEdit input").val("");
        var oExportPIDetail = $('#tblExportPIDetail_Com').datagrid('getSelected');
        if (oExportPIDetail ==null ) { alert("Please select an item from list."); return ; }
        //$('#txtProduct_Edit').prop('disabled',true);
        $('#txtProduct_Edit').val(oExportPIDetail.ProductName);

        $('#txtStyleNo').val(oExportPIDetail.StyleNo);
        $('#txtColorEdit').val(oExportPIDetail.ColorInfo);
      
        var CAmount2=parseFloat(oExportPIDetail.QtyCom*oExportPIDetail.CRateTwo).toFixed(2);
        $('#txtCRateTwo').val(parseFloat(oExportPIDetail.CRateTwo).toFixed(4));
        $('#txtCAmount2').val("$"+CAmount2);

        var CAmount=parseFloat(oExportPIDetail.QtyCom*oExportPIDetail.CRate).toFixed(2);
        $('#txtCRate').val(parseFloat(oExportPIDetail.CRate).toFixed(4));
        $('#txtAmount').val("$"+oExportPIDetail.AmountSt);
        $('#txtCAmount').val("$"+parseFloat(oExportPIDetail.QtyCom*oExportPIDetail.CRate).toFixed(2));
        $('#txtQtyInOne').val(parseFloat(oExportPIDetail.Qty).toFixed(4));
        $('#txtUnitPriceInOne').val(parseFloat(oExportPIDetail.UnitPrice).toFixed(4));
        $('#txtQtyCom').val(parseFloat(oExportPIDetail.QtyCom).toFixed(4));
        
        var nTotalAmount=parseFloat(CAmount)+parseFloat(CAmount2);
        $('#txtCAmountTotal').val("$"+parseFloat(nTotalAmount).toFixed(2));
        $("#winExportPIDetailEdit").icsWindow("open","Edit");
    });
    $("#btnUpdateEPIDetail").click(function () {
        debugger;
        var oExportPIDetail = $('#tblExportPIDetail_Com').datagrid('getSelected');
        if (oExportPIDetail ==null ) { alert("Please select an item from list."); return ; }
        var nSelectedRowIndex=$('#tblExportPIDetail_Com').datagrid('getRowIndex',oExportPIDetail);
       
        //oExportPIDetail.AdjQty=parseFloat($('#txtAdjQty').val()).toFixed(4);
        //oExportPIDetail.AdjRate=parseFloat($('#txtAdjRate').val()).toFixed(4);
        //oExportPIDetail.DocCharge=parseFloat($('#txtDocCharge').val()).toFixed(4);
        oExportPIDetail.CRate=parseFloat($('#txtCRate').val()).toFixed(4);
        oExportPIDetail.CRateTwo=parseFloat($('#txtCRateTwo').val()).toFixed(4);
        oExportPIDetail.QtyCom=parseFloat($('#txtQtyCom').val()).toFixed(4);
        oExportPIDetail.AmountCom= parseFloat(oExportPIDetail.QtyCom*oExportPIDetail.CRate).toFixed(2);
        oExportPIDetail.AmountComTwo= parseFloat(oExportPIDetail.QtyCom*oExportPIDetail.CRateTwo).toFixed(2);
       
        var nTotalRate=parseFloat(oExportPIDetail.CRate)+parseFloat(oExportPIDetail.CRateTwo);
        if(oExportPIDetail.UnitPrice<=nTotalRate){
            alert("Sorry, Com. Rate Can Not Be Greater Than Unit Price!"); return;
        }

        if(oExportPIDetail.ExportPIDetailID>0)
        {
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oExportPIDetail,
                ObjectId: oExportPIDetail.ExportPIDetailID,
                ControllerName: "SalesCommissionLC",
                ActionName: "UpdateCRRate",
                TableId: "tblExportPIDetail_Com",
                IsWinClose: true
            };

            $.icsSave(obj, function (response)
            {
                if (response.status && response.obj != null)
                {
                    if (response.obj.ErrorMessage=="")
                    {
                        $("#tblExportPIDetail_Com").datagrid("selectRow", nSelectedRowIndex);
                        SetSalesComAmount();
                    }
                    else {
                        alert(response.obj.ErrorMessage);
                    }
                }
                else {
                    alert("No information found.");
                }
            });

        }
        //$('#tblExportPIDetail_Com').datagrid('updateRow', { index: nSelectedRowIndex, row: oExportPIDetail });
        RefreshControlAdjSettle();
        $("#winExportPIDetailEdit").icsWindow("close");
        
    });
    $("#btnCloseEPIDetail").click(function () {
        debugger;
        $("#winExportPIDetailEdit").icsWindow("close");

    });
    function cboCommissionOn()
    {
        if(parseInt($('#cboCommissionOn').val())<=0)
        {
            $('#txtPICommission').prop("disabled", true);
            $('#txtPIComPerTage').prop("disabled", true); 
        }
        else{
            $('#txtPICommission').prop("disabled", false);
            $('#txtPIComPerTage').prop("disabled", false); 
        }
        RefreshControlAdjSettle();
    }
    $('#txtPIComPerTage').keyup(function(e){
        var nPIComPerTage = icsRemoveComma($('#txtPIComPerTage').val());
        var nAmount = (parseFloat(_oExportPI.Amount) * parseFloat(nPIComPerTage))/100;
        $('#txtPICommission').val(icsFormatPrice(nAmount, null, 2));
        _nCommissionAmount=nAmount;
        RefreshCommission();
    });

    $('#txtPICommission').keyup(function(e){
        var nAmount = icsRemoveComma($('#txtPICommission').val());
        var nPIComPerTage = (parseFloat(nAmount) / parseFloat(_oExportPI.Amount))*100;
        $('#txtPIComPerTage').val(icsFormatPrice(nPIComPerTage, null, 2));
        _nCommissionAmount=nAmount;
        RefreshCommission();
    });

    function RefreshCommission()
    {
        var oSalesCommissions = $('#tblSalesCommissions').datagrid('getRows');
        for (i = 0; i < oSalesCommissions.length; ++i)
        {
            if(parseFloat(oSalesCommissions[i].Percentage)>0)
            {
                oSalesCommissions[i].CommissionAmount=parseFloat((oSalesCommissions[i].Percentage* _nCommissionAmount)/100).toFixed(2);
            }
        }
        DynamicRefreshList(oSalesCommissions, "tblSalesCommissions");
        RefreshSummary();
    }

</script>