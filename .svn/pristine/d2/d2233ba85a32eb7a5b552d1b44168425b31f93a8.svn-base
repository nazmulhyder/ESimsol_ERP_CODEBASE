@model IEnumerable<ESimSol.BusinessObjects.PurchaseInvoice>
@{
    ViewBag.Title = "Purchase Invoice";
}

<body>
    <div id="progbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div id="winChangePaymentMode" class="easyui-window" title="Change Payment Mode" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <fieldset style="margin-top:2px">
            <table border="0" cellpadding="2" cellspacing="2">
                <tr id="trBehavior">
                    <td style="width:120px; text-align:right">Payment Mode: </td>
                    <td style="width:300px">
                        <select id="cboPaymentMode" style="width:120px;"></select>
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset style="text-align:right">
            <legend>Actions : </legend>
            <a id="btnSavePaymentMode" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
            <a id="btnClosePaymentMode" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>


    <div class="menuMainCollectionTable" style="margin-left: 0px; height:100%; width:100%">
        <table id="tblPurchaseInvoices" title="Purchase Invoice" class="easyui-datagrid" fit="true" fitcolumns="false"
               rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
            <thead>
                <tr>
                    <th field="InvoiceTypeInSt" width="100" align="left">Invoice Type</th>
                    <th field="PurchaseInvoiceNo" width="120" align="left">Invoice No</th>
                    <th field="InvoiceStatusSt" width="100" align="left">Status</th>
                    <th field="ApprovalStatus" width="150">App Status</th>   
                    <th field="DateofInvoiceSt" width="100" align="left">Invoice Date</th>
                    <th field="ContractorName" width="200" align="left">Supplier Name</th>
                    <th field="RefTypeSt" width="80" align="left">Ref Type</th>
                    <th field="PONo" width="80" align="left">Ref No</th>
                    <th field="BillNo" width="80" align="left">Bill No</th>
                    <th field="AmountSt" width="100" align="right">Amount</th>
                    <th field="ApprovedUserName" width="80" align="left">Approved By</th>
                    <th field="PrepareUserName" width="80" align="left">Prepare By</th>
                    <th field="IsWillVoucherEffectSt" width="80" align="left">Voucher Effect</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a id="btnWaitForApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true"></a>
            <input type="text" id="txtSearchByInvoiceNo" placeholder="Search By Invoice No" style="width: 150px;"/>
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>            
            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New</a>
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
            <a id="btnSendTo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-forword" plain="true">Send</a>   
            <a id="btnApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true">Approve</a>
            <a id="btnUndoApproved" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true">Undo Approve</a>
            <a id="btnChangePaymentMode" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Change Payment Mode</a>
            <a id="btnChangeVoucherEffect" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Voucher Effect</a>
            <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
            <a id="btnPrintList" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print List</a>
        </div>
    </div>

    @*send to picker*@
    <div id="winSendTo" class="easyui-window winClass" title="Send To" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="width:360px;height:170px; float: left;align-content:center;">
            <div style="margin-left: 10%; margin-top:6%;">
                <table border="0" cellpadding="2" cellspacing="0" style="width:100%;">
                    <tr>
                        <td>
                            <fieldset style="margin-left:-10%;">
                                <table>
                                    <tr>
                                        <td width="30%">Send To </td>
                                        <td width="80%">
                                            <input id="txtSendTo" type="text" required="required" style="width:200px;" disabled />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td width="30%">Person </td>
                                        <td width="80%">
                                            <select id="cboPersonList" style="width:200px;"></select>
                                        </td>
                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 100%; text-align: right;" colspan="2">
                            <fieldset style="margin-left:-10%;">
                                <legend style="font-weight: bold; text-align:left;">Actions : </legend>
                                <a href="javascript:void(0)" id="btnOkSendTo" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                                <a href="javascript:void(0)" id="btnCloseSendTo" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </fieldset>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div id="winAdvanceSearch" class="easyui-window" title="Advance Search" style="width:540px;height:410px;padding:2px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div>
            <fieldset>
                <legend style="font-weight:bold"> Searching Criteria : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:170px; text-align:right">
                            Invoice No :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="1" cellspacing="1">
                                <tr>
                                    <td style="width:150px">
                                        <input type="text" style="width: 100%;" id="txtInvoiceNo" />
                                    </td>
                                    <td style="width:70px; text-align:right">
                                        Bill No :
                                    </td>
                                    <td style="width:150px">
                                        <input type="text" style="width: 100%" id="txtBillNo" />
                                    </td>
                                </tr>
                            </table>                            
                        </td>
                    </tr>                    
                    <tr>
                        <td style="width:170px; text-align:right">
                            Invoice Type :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="1" cellspacing="1">
                                <tr>
                                    <td style="width:150px">
                                        <select id="cboInvoiceType" style="width:104%"><option value="0">--Select Invoice Type--</option><option value="1">Standard</option><option value="2">Advance</option></select>
                                    </td>
                                    <td style="width:70px; text-align:right">
                                        Ref Type :
                                    </td>
                                    <td style="width:150px">
                                        <select id="cboRefType" style="width:104%"></select>
                                    </td>
                                </tr>
                            </table>                            
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            PO No :
                        </td>
                        <td style="width:370px">
                            <input type="text" style="width: 370px;" id="txtPONo" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Invoice Date :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="0" cellspacing="0" style="font-size: 12px">
                                <tr>
                                    <td style="width: 120px; font-size: 12px; text-align: left">
                                        <select id="cboInvoiceDate" style="width:120px"></select>
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtInvoiceStartDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                    <td style="width: 10px; font-size: 12px">
                                        To
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtInvoiceEndDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Bill Date :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="0" cellspacing="0" style="font-size: 12px">
                                <tr>
                                    <td style="width: 120px; font-size: 12px; text-align: left">
                                        <select id="cboBillDate" style="width:120px"></select>
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtBillStartDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                    <td style="width: 10px; font-size: 12px">
                                        To
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtBillEndDate" type="text" style="width: 120px;" class="easyui-datebox" disabled="disabled" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>                    
                    <tr>
                        <td style="width:170px; text-align:right">
                            Invoice Amount :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="0" cellspacing="0" style="font-size: 12px">
                                <tr>
                                    <td style="width: 120px; font-size: 12px; text-align: left">
                                        <select id="cboInvoiceAmount" style="width:120px"></select>
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtInvoiceAmountStart" style="width:114px" />
                                    </td>
                                    <td style="width: 10px; font-size: 12px">
                                        To
                                    </td>
                                    <td style="width: 120px; font-size: 12px">
                                        <input id="txtInvoiceAmountEnd" style="width:114px" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Approved By :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="width:40%"><select id="cboApprovedBy" style="width:100%"></select></td>
                                    <td style="width:30%; text-align:right;">Payment Mode :</td>
                                    <td style="width:30%"><select id="cboInvoicePaymentMode" style="width:100%"></select></td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Supplier(s) :
                        </td>
                        <td style="width:370px">
                            <input type="text" style="width: 282px;" id="txtSupplierName" placeholder="Press enter with supplier name/code" />
                            <input type="button" style="width: 30px;" id="btnSupplierClear" value="C" />
                            <input type="button" style="width: 50px;" id="btnSupplierPicker" value="Pick" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Product(s) :
                        </td>
                        <td style="width:370px">
                            <input type="text" style="width: 282px;" id="txtProductName" placeholder="Press enter with product name/code" />
                            <input type="button" style="width: 30px;" id="btnProductClear" value="C" />
                            <input type="button" style="width: 50px;" id="btnProductPicker" value="Pick" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:170px; text-align:right">
                            Import LC :
                        </td>
                        <td style="width:370px">
                            <table border="0" cellpadding="1" cellspacing="1">
                                <tr>
                                    <td style="width:150px">
                                        <input type="text" style="width: 100%;" id="txtImportLC" />
                                    </td>
                                    <td style="width:70px; text-align:right">
                                        Import Inv :
                                    </td>
                                    <td style="width:150px">
                                        <input type="text" style="width: 100%" id="txtImportInvoice" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
        <fieldset style="width:498px; vertical-align:top;">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:100px;text-align:right">
                        <a id="btnAdvSearchReset" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true"> Reset</a>
                    </td>
                    <td style="width:408px;text-align:right;">
                        <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                        <a id="btnAdvSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</body>

<script type="text/javascript">
    $(document).ready(function ()
    {
        var nPIT = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PIT));
        var oPurchaseInvoices =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        var oRefTyps=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.RefTyps));
        var oApprovalUsers=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ApprovalUsers));
        var oDateCompareOperatorObjs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DateCompareOperatorObjs));
        var oAmountCompareOperatorObjs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.AmountCompareOperatorObjs));
        var oInvoicePaymentModes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.InvoicePaymentModes));
        $('#cboPaymentMode').data('InvoicePaymentModes', oInvoicePaymentModes);

        var oTempPurchaseInvoices =sessionStorage.getItem("PurchaseInvoices");
        if(oTempPurchaseInvoices!=null)
        {
            oPurchaseInvoices = jQuery.parseJSON(oTempPurchaseInvoices);
        }

        $('#winSendTo').data("IsApprovalHead",false);
        RefreshList(oPurchaseInvoices);
        RefreshControlLayout(oAuthorizationRolesMapping);
        $("#progbar").progressbar({ value: 0 });
        $("#progbarParent").hide();
        $('#txtSupplierName').data('Suppliers', []);
        $('#txtProductName').data('Products', []);
        $('#tblPurchaseInvoices').data('PTI', nPIT);
        $('#cboRefType').data('RefTyps', oRefTyps);
        $('#cboApprovedBy').data('ApprovalUsers', oApprovalUsers);
        $('#cboInvoiceDate').data('DateCompareOperatorObjs', oDateCompareOperatorObjs);
        $('#cboBillDate').data('DateCompareOperatorObjs', oDateCompareOperatorObjs);
        $('#cboInvoiceAmount').data('AmountCompareOperatorObj', oAmountCompareOperatorObjs);
        $('#tblPurchaseInvoices').data('PurchaseInvoices', oPurchaseInvoices);
        $('#txtInvoiceAmountStart,#txtInvoiceAmountEnd').icsCurrencyBox();


        $('#tblPurchaseInvoices').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowData);}});

    });

    function RowSelect(oPIs)
    {
        debugger;
        ////Commercial Invoice Status:
        //document.getElementById("btnIC").style.display = 'none';
        //document.getElementById("btnSendToBuyer").style.display = 'none';
        //document.getElementById("btnBuyerAccepted").style.display = 'none';
        //document.getElementById("btnEncashment").style.display = 'none';
        //document.getElementById("btnBillClosed").style.display = 'none';
        //document.getElementById("btnUndoStatus").style.display = 'none';

        if(parseInt(oPIs.ApprovedBy)!=0)
        {
            document.getElementById("btnApproved").style.display = 'none';
        }
        if(parseInt(oPIs.ApprovedBy)==0)
        {
            document.getElementById("btnApproved").style.display = '';
        }

    }

    $("#btnChangePaymentMode").click(function(){
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }

        $("#winChangePaymentMode").icsWindow('open', "Payment Mode");
        var oInvoicePaymentModes = $('#cboPaymentMode').data('InvoicePaymentModes');
        $("#cboPaymentMode").icsLoadCombo({ List: oInvoicePaymentModes, OptionValue: "id", DisplayText: "Value" });
        $("#cboPaymentMode").val(oPurchaseInvoice.InvoicePaymentModeInt);
    });

    $("#btnChangeVoucherEffect").click(function(){
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }

        if(oPurchaseInvoice.IsWillVoucherEffect==false)
        {
            if (!confirm("Confirm to Effect?")) return;
            oPurchaseInvoice.IsWillVoucherEffect=true;
        }else
        {
            if (!confirm("Confirm to Not Effect?")) return;
            oPurchaseInvoice.IsWillVoucherEffect=false;
        }
        var SelectedRowIndex = $('#tblPurchaseInvoices').datagrid('getRowIndex', oPurchaseInvoice);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+"/PurchaseInvoice/UpdateVoucherEffect",
            traditional: true,
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oPurchaseInvoice = jQuery.parseJSON(data);
                if (parseInt(oPurchaseInvoice.PurchaseInvoiceID)>0)
                {
                    alert("Data Saved sucessfully");
                    debugger;
                    $('#tblPurchaseInvoices').datagrid('updateRow',{index: SelectedRowIndex,row: oPurchaseInvoice});
                }
                else {
                    alert(oPurchaseInvoice.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });



    $('#btnSavePaymentMode').click(function(e){
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }

        if(parseInt($("#cboPaymentMode").val())<=0)
        {
            alert("Please Select Payment Mode");
            return;
        }
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);

        var oPurchaseInvoice = {
            PurchaseInvoiceID :parseInt(oPurchaseInvoice.PurchaseInvoiceID),
            InvoicePaymentModeInt:parseInt($('#cboPaymentMode').val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+"/PurchaseInvoice/UpdatePaymentMode",
            traditional: true,
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oPurchaseInvoice = jQuery.parseJSON(data);
                if (parseInt(oPurchaseInvoice.PurchaseInvoiceID)>0)
                {
                    alert("Data Saved sucessfully");
                    $("#winChangePaymentMode").icsWindow('close');
                    debugger;

                    $('#tblPurchaseInvoices').treegrid('updateRow',{index: SelectedRowIndex,row: oPurchaseInvoice});
                }
                else {
                    alert(oPurchaseInvoice.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    $('#btnClosePaymentMode').click(function(e){
        $("#winChangePaymentMode").icsWindow('close');
    });


    $("#btnAdd").click(function(){
        var nPIT = $('#tblPurchaseInvoices').data('PTI');
        var oPurchaseInvoices= $('#tblPurchaseInvoices').datagrid('getRows');
        sessionStorage.setItem("PurchaseInvoices", JSON.stringify(oPurchaseInvoices));
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("PurchaseInvoiceHeader", "Add PurchaseInvoice");
        sessionStorage.setItem("InvoiceBackTo", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        if(nPIT===1)
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+ "/PurchaseInvoice/ViewPurchaseInvoice?nid=0&ts="+tsv;
        }
        else
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+ "/PurchaseInvoice/ViewLandingCost?nid=0&nbuid="+parseInt(sessionStorage.getItem('BUID'))+"&ts="+tsv;
        }
    });

    $("#btnEdit").click(function(){
        var nPIT = $('#tblPurchaseInvoices').data('PTI');
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(parseInt(oPurchaseInvoice.ApprovedBy)!=0)
        {
            alert("Your Selected Invoice Already Approved!");
            return;
        }
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);
        var oPurchaseInvoices= $('#tblPurchaseInvoices').datagrid('getRows');
        sessionStorage.setItem("PurchaseInvoices", JSON.stringify(oPurchaseInvoices));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("PurchaseInvoiceHeader", "Edit PurchaseInvoice");
        sessionStorage.setItem("InvoiceBackTo", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        if(nPIT===1)
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/ViewPurchaseInvoice?nid="+parseInt(oPurchaseInvoice.PurchaseInvoiceID)+"&ts="+tsv;
        }
        else
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/ViewLandingCost?nid="+parseInt(oPurchaseInvoice.PurchaseInvoiceID)+"&nbuid="+parseInt(sessionStorage.getItem('BUID'))+"&ts="+tsv;
        }
    });

    $("#btnView").click(function(){
        var nPIT = $('#tblPurchaseInvoices').data('PTI');
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);
        var oPurchaseInvoices= $('#tblPurchaseInvoices').datagrid('getRows');
        sessionStorage.setItem("PurchaseInvoices", JSON.stringify(oPurchaseInvoices));
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
        sessionStorage.setItem("PurchaseInvoiceHeader", "View PurchaseInvoice");
        sessionStorage.setItem("InvoiceBackTo", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        if(nPIT===1)
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/ViewPurchaseInvoice?nid="+parseInt(oPurchaseInvoice.PurchaseInvoiceID)+"&ts="+tsv;
        }
        else
        {
            window.location.href = sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/ViewLandingCost?nid="+parseInt(oPurchaseInvoice.PurchaseInvoiceID)+"&nbuid="+parseInt(sessionStorage.getItem('BUID'))+"&ts="+tsv;
        }
    });

    $("#btnDelete").click(function () {
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || oPurchaseInvoice.PurchaseInvoiceID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(parseInt(oPurchaseInvoice.ApprovedBy)!=0)
        {
            alert("Your Selected Invoice Already Approved!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return;
        var SelectedRowIndex = $('#tblPurchaseInvoices').datagrid('getRowIndex', oPurchaseInvoice);
        if (parseInt(oPurchaseInvoice.PurchaseInvoiceID)> 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/Delete",
                traditional: true,
                data:  JSON.stringify(oPurchaseInvoice),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        $('#tblPurchaseInvoices').datagrid('deleteRow',SelectedRowIndex);

                        var oPurchaseInvoices= $('#tblPurchaseInvoices').datagrid('getRows');
                        sessionStorage.setItem("PurchaseInvoices", JSON.stringify(oPurchaseInvoices));

                        alert("Delete sucessfully");
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
    });

    $('#btnWaitForApproved').click(function (e) {
        var nPIT = $('#tblPurchaseInvoices').data('PTI');
        var oPurchaseInvoice = {
            PurchaseInvoiceID : 0,
            BUID : parseInt(sessionStorage.getItem("BUID")),
            PIT : parseInt($('#tblPurchaseInvoices').data('PTI'))
        };

        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/WaitForApproval",
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oPurchaseInvoices = jQuery.parseJSON(data);
                if (oPurchaseInvoices != null) {
                    if(oPurchaseInvoices.length>0)
                    {
                        if(oPurchaseInvoices[0].ErrorMessage=="")
                        {
                            RefreshList(oPurchaseInvoices);
                            $('#tblPurchaseInvoices').data('PurchaseInvoices', oPurchaseInvoices);
                        }
                        else
                        {
                            alert(oPurchaseInvoices[0].ErrorMessage);
                        }
                    }
                    else
                    {
                        alert("Data not found!!");
                    }
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnApproved').click(function (e) {
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Invalid PurchaseInvoice!!! please select a valid Field!");
            return false;
        }
        if(parseInt(oPurchaseInvoice.ApprovedBy)!=0)
        {
            alert("Please selected PurchaseInvoice already approved!");
            return;
        }

        if($('#winSendTo').data("IsApprovalHead") && oPurchaseInvoice.LastApprovalSequence!=oPurchaseInvoice.ApprovalSequence)
        {
            alert("Invalid Approval State!!"); return false;
        }


        if (!confirm("Confirm to Approved?")) return ;
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress")+ "/PurchaseInvoice/Approved",
            traditional: true,
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                oPurchaseInvoice = jQuery.parseJSON(data);
                if (parseInt(oPurchaseInvoice.PurchaseInvoiceID)>0) {
                    alert("Approved Successfully");
                    $('#tblPurchaseInvoices').datagrid('updateRow',{index: SelectedRowIndex,	row: oPurchaseInvoice});
                }
                else {
                    alert(oPurchaseInvoice.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    
    $('#btnUndoApproved').click(function (e) {
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Invalid PurchaseInvoice!!! please select a valid Field!");
            return false;
        }
        if(parseInt(oPurchaseInvoice.ApprovedBy)==0)
        {
            alert("Please selected  Only approved Item.");
            return;
        }

        if (!confirm("Confirm to Undo Approved?")) return ;
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem("BaseAddress")+ "/PurchaseInvoice/UndoApproved",
            traditional: true,
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                oPurchaseInvoice = jQuery.parseJSON(data);
                if (parseInt(oPurchaseInvoice.PurchaseInvoiceID)>0) 
                {
                    alert("Approved Successfully");
                    $('#tblPurchaseInvoices').datagrid('updateRow',{index: SelectedRowIndex,	row: oPurchaseInvoice});
                }
                else {
                    alert(oPurchaseInvoice.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    var nApprovalHeadID =  0;
    $("#btnSendTo").click(function () {
        debugger;

        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');

        if(oPurchaseInvoice==null || oPurchaseInvoice.PurchaseInvoiceID<=0)
        {
            alert("Please select a item from list!");
            return false;
        }

        if(oPurchaseInvoice.ApprovedBy!=0)
        {
            alert("Selected item is already Approved!");
            return false;
        }

        var oApprovalHead = {
            ModuleID:33,
            BUID:oPurchaseInvoice.BUID,
            Sequence:oPurchaseInvoice.ApprovalSequence + 1
        };
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ApprovalHead/GetHeadAndPerson",
            traditional: true,
            data:  JSON.stringify(oApprovalHead),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oAHs = jQuery.parseJSON(data);
                debugger;
                if (oAHs.length > 0)
                {
                    nApprovalHeadID = oAHs[0].ApprovalHeadID;
                    $("#txtSendTo").val(oAHs[0].Name);
                    $("#cboPersonList").icsLoadCombo({List: oAHs[0].ApprovalHeadPersons,OptionValue:"UserID",DisplayText: "UserName"});

                    $("#winSendTo").icsWindow('open', "Send To " + oAHs[0].Name);
                }
                else {
                    alert('Invalid Request');
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

        $('#btnCloseSendTo').click(function () {
            $("#winSendTo").icsWindow('close');
        });
    });
    $("#btnOkSendTo").click(function () {
        if( $("#cboPersonList").val() == 0) {
            alert('Select Person to send');
            return false;
        }debugger;
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        var SelectedRowIndex=$('#tblPurchaseInvoices').datagrid('getRowIndex',oPurchaseInvoice);
        oApprovalHistory = {
            ApprovalHistoryID : 0,
            ObjectRefID : oPurchaseInvoice.PurchaseInvoiceID,
            ApprovalHeadID: nApprovalHeadID,
            SendToPersonID : $("#cboPersonList").val(),
            Note : 'N/A'
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/PurchaseInvoice/SaveApprovalHistory",
            traditional: true,
            data:  JSON.stringify(oApprovalHistory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oPR = jQuery.parseJSON(data);
                debugger;
                if (oPR.PurchaseInvoiceID > 0)
                {
                    alert('Send Successfully.');
                    $('#tblPurchaseInvoices').datagrid('updateRow',{
                        index: SelectedRowIndex,
                        row:oPR
                    });

                    $("#winSendTo").icsWindow('close');
                }
                else {
                    alert(oPR.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });


    function RefreshList(oPurchaseInvoices) {
        data = oPurchaseInvoices;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblPurchaseInvoices').datagrid('loadData', data);
        var nRowIndex =parseInt(sessionStorage.getItem("SelectedRowIndex"));
        if(nRowIndex!=-1)
        {
            $('#tblPurchaseInvoices').datagrid('selectRow', nRowIndex);
        }
    }

    $("#btnPreview").click(function() {
        var oPurchaseInvoice= $('#tblPurchaseInvoices').datagrid('getSelected');
        if(oPurchaseInvoice==null || parseInt(oPurchaseInvoice.PurchaseInvoiceID)<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        window.open(sessionStorage.getItem("BaseAddress")+ '/PurchaseInvoice/PrintPurchaseInvoice?id=' + parseInt(oPurchaseInvoice.PurchaseInvoiceID), "_blank");
    });

    $('#btnPrintList').click(function (e) {
        var oPurchaseInvoices= $('#tblPurchaseInvoices').datagrid('getRows');
        var ids ="";
        if(oPurchaseInvoices.length >0)
        {
            for(var i =0;i<oPurchaseInvoices.length;i++)
            {
                ids =ids+oPurchaseInvoices[i].PurchaseInvoiceID+",";
            }
            ids= ids.substring(0, ids.length - 1);
        }
        else{
            return;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + '/PurchaseInvoice/PrintPurchaseInvoices?ids='+ids+"&ts="+tsv, "_blank");
    });

    //Start Search
    function RefreshComboBoxControls()
    {
        var oRefTyps = $('#cboRefType').data('RefTyps');
        var oApprovalUsers = $('#cboApprovedBy').data('ApprovalUsers');
        var oInvoiceDateCompareOperatorObjs = $('#cboInvoiceDate').data('DateCompareOperatorObjs');
        var oBillDateCompareOperatorObjs = $('#cboBillDate').data('DateCompareOperatorObjs');
        var oAmountCompareOperatorObjs = $('#cboInvoiceAmount').data('AmountCompareOperatorObj');
        var oInvoicePaymentModes = $('#cboPaymentMode').data('InvoicePaymentModes');

        $("#cboRefType").icsLoadCombo({ List: oRefTyps, OptionValue: "id", DisplayText: "Value" });
        $("#cboApprovedBy").icsLoadCombo({ List: oApprovalUsers, OptionValue: "UserID", DisplayText: "UserName" });
        $("#cboInvoicePaymentMode").icsLoadCombo({ List: oInvoicePaymentModes, OptionValue: "id", DisplayText: "Value" });
        $("#cboInvoiceDate").icsLoadCombo({ List: oInvoiceDateCompareOperatorObjs, OptionValue: "id", DisplayText: "Value"});
        $("#cboBillDate").icsLoadCombo({ List: oBillDateCompareOperatorObjs, OptionValue: "id", DisplayText: "Value"});
        $("#cboInvoiceAmount").icsLoadCombo({ List: oAmountCompareOperatorObjs, OptionValue: "id", DisplayText: "Value" });
    }

    function ValidateSearch()
    {
        var sInvoiceNo =$.trim($('#txtInvoiceNo').val());
        var sBillNo =$.trim($('#txtBillNo').val());
        var sImportLC =$.trim($('#txtImportLC').val());
        var sImportInvoice =$.trim($('#txtImportInvoice').val());

        var nInvoiceType = parseInt($('#cboInvoiceType').val());
        var nRefType = parseInt($('#cboRefType').val());
        var sPONo =$.trim($('#txtPONo').val());

        var nInvoiceDate = parseInt($('#cboInvoiceDate').val());
        if(nInvoiceDate===1 || nInvoiceDate===2 || nInvoiceDate===3 || nInvoiceDate===4)
        {
            var sInvoiceStartDate   = $('#txtInvoiceStartDate').datebox('getValue');
            if(sInvoiceStartDate===null || sInvoiceStartDate==="")
            {
                alert("Please select Invoice start date!");
                $('#txtInvoiceStartDate').focus();
                return false;
            }
        }
        if(nInvoiceDate===5 || nInvoiceDate===6)
        {
            var sInvoiceStartDate   = $('#txtInvoiceStartDate').datebox('getValue');
            var sInvoiceEndDate   = $('#txtInvoiceEndDate').datebox('getValue');
            if(sInvoiceStartDate===null || sInvoiceStartDate==="")
            {
                alert("Please select Invoice start date!");
                $('#txtInvoiceStartDate').focus();
                return false;
            }
            if(sInvoiceEndDate===null || sInvoiceEndDate==="")
            {
                alert("Please select Invoice end date!");
                $('#txtInvoiceEndDate').focus();
                return false;
            }
            if(new Date(sInvoiceStartDate) > new Date(sInvoiceEndDate))
            {
                alert("Start date must be smallar than or equal end date!");
                $('#txtInvoiceStartDate').focus();
                return false;
            }
        }

        var nBillDate = parseInt($('#cboBillDate').val());
        if(nBillDate===1 || nBillDate===2 || nBillDate===3 || nBillDate===4)
        {
            var sBillStartDate   = $('#txtBillStartDate').datebox('getValue');
            if(sBillStartDate===null || sBillStartDate==="")
            {
                alert("Please select Bill start date!");
                $('#txtBillStartDate').focus();
                return false;
            }
        }
        if(nBillDate===5 || nBillDate===6)
        {
            var sBillStartDate   = $('#txtBillStartDate').datebox('getValue');
            var sBillEndDate   = $('#txtBillEndDate').datebox('getValue');
            if(sBillStartDate===null || sBillStartDate==="")
            {
                alert("Please select Bill start date!");
                $('#txtBillStartDate').focus();
                return false;
            }
            if(sBillEndDate===null || sBillEndDate==="")
            {
                alert("Please select Bill end date!");
                $('#txtBillEndDate').focus();
                return false;
            }
            if(new Date(sBillStartDate) > new Date(sBillEndDate))
            {
                alert("Start date must be smallar than or equal end date!");
                $('#txtBillStartDate').focus();
                return false;
            }
        }

        var nInvoiceAmount = parseInt($('#cboInvoiceAmount').val());
        if(nInvoiceAmount===1 || nInvoiceAmount===2 || nInvoiceAmount===3 || nInvoiceAmount===4)
        {
            var sInvoiceAmountStart   = $.trim($('#txtInvoiceAmountStart').val());
            if(sInvoiceAmountStart===null || sInvoiceAmountStart==="")
            {
                alert("Please enter Invoice start Amount!");
                $('#txtInvoiceAmountStart').focus();
                return false;
            }
            if(icsRemoveComma(sInvoiceAmountStart)<=0)
            {
                alert("Please enter Invoice start Amount!");
                $('#txtInvoiceAmountStart').focus();
                return false;
            }
        }
        if(nInvoiceAmount===5 || nInvoiceAmount===6)
        {
            var sInvoiceAmountStart = $.trim($('#txtInvoiceAmountStart').val());
            if(sInvoiceAmountStart===null || sInvoiceAmountStart==="")
            {
                alert("Please enter Invoice start Amount!");
                $('#txtInvoiceAmountStart').focus();
                return false;
            }
            if(icsRemoveComma(sInvoiceAmountStart)<=0)
            {
                alert("Please enter Invoice start Amount!");
                $('#txtInvoiceAmountStart').focus();
                return false;
            }

            var sInvoiceAmountEnd = $.trim($('#txtInvoiceAmountEnd').val());
            if(sInvoiceAmountEnd===null || sInvoiceAmountEnd==="")
            {
                alert("Please enter Invoice end Amount!");
                $('#txtInvoiceAmountEnd').focus();
                return false;
            }
            if(icsRemoveComma(sInvoiceAmountEnd)<=0)
            {
                alert("Please enter Invoice end Amount!");
                $('#txtInvoiceAmountEnd').focus();
                return false;
            }
            if(icsRemoveComma(sInvoiceAmountStart) >= icsRemoveComma(sInvoiceAmountEnd))
            {
                alert("Start amount must be smallar than end amount!");
                $('#txtInvoiceAmountStart').focus();
                return false;
            }
        }

        var nApprovedBy = parseInt($('#cboApprovedBy').val());
        var nInvoicePaymentMode = parseInt($('#cboInvoicePaymentMode').val());
        var oSuppliers = $('#txtSupplierName').data('Suppliers');
        var oProducts = $('#txtProductName').data('Products');

        if(sInvoiceNo==="" && sBillNo==="" && sImportLC ==="" && sImportInvoice === "" && nInvoiceType===0 && parseInt(nInvoicePaymentMode)==0 && nRefType===0 && sPONo==="" && nInvoiceDate===0 && nBillDate===0 && nInvoiceAmount===0 && nApprovedBy===0 && oSuppliers.length<=0 && oProducts.length<=0)
        {
            alert("Please select atleast one searching criteriea!");
            return false;
        }
        return true;
    }

    $('#btnAdvSearch').click(function(e){
        $("#winAdvanceSearch").icsWindow('open', "Advance Search");
        $("#winAdvanceSearch input").not("input[type='button']").val("");
        $('#txtInvoiceStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtInvoiceEndDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtBillStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtBillEndDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtInvoiceAmountStart').val('0.00');
        $('#txtInvoiceAmountEnd').val('0.00');
        $('#txtInvoiceAmountStart').prop("disabled", true);
        $('#txtInvoiceAmountEnd').prop("disabled", true);
        $('#txtSupplierName').data('Suppliers', []);
        $('#txtProductName').data('Products', []);
        $('#cboInvoiceType').val(0);
        $('#cboRefType').val(0);
        RefreshComboBoxControls();
    });

    $('#btnAdvSearchClose').click(function(e){
        $("#winAdvanceSearch").icsWindow('close');
    });

    $('#cboInvoiceDate').change(function(e){
        //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
        var nCompareOperator =   parseInt($('#cboInvoiceDate').val());
        if(nCompareOperator===0)
        {
            $('#txtInvoiceStartDate').datebox({ disabled : true });
            $('#txtInvoiceEndDate').datebox({ disabled : true });
        }
        else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
        {
            $('#txtInvoiceStartDate').datebox({ disabled : false });
            $('#txtInvoiceEndDate').datebox({ disabled : true });
        }
        else
        {
            $('#txtInvoiceStartDate').datebox({ disabled : false });
            $('#txtInvoiceEndDate').datebox({ disabled : false });
        }
        $('#txtInvoiceStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtInvoiceEndDate').datebox('setValue', icsdateformat(new Date()));
    });

    $('#cboBillDate').change(function(e){
        //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
        var nCompareOperator =   parseInt($('#cboBillDate').val());
        if(nCompareOperator===0)
        {
            $('#txtBillStartDate').datebox({ disabled : true });
            $('#txtBillEndDate').datebox({ disabled : true });
        }
        else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
        {
            $('#txtBillStartDate').datebox({ disabled : false });
            $('#txtBillEndDate').datebox({ disabled : true });
        }
        else
        {
            $('#txtBillStartDate').datebox({ disabled : false });
            $('#txtBillEndDate').datebox({ disabled : false });
        }
        $('#txtBillStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtBillEndDate').datebox('setValue', icsdateformat(new Date()));
    });

    $('#cboInvoiceAmount').change(function(e){
        //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
        var nCompareOperator =   parseInt($('#cboInvoiceAmount').val());
        if(nCompareOperator===0)
        {
            $('#txtInvoiceAmountStart').prop("disabled", true);
            $('#txtInvoiceAmountEnd').prop("disabled", true);
        }
        else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
        {
            $('#txtInvoiceAmountStart').prop("disabled", false);
            $('#txtInvoiceAmountEnd').prop("disabled", true);
        }
        else
        {
            $('#txtInvoiceAmountStart').prop("disabled", false);
            $('#txtInvoiceAmountEnd').prop("disabled", false);
        }
        $('#txtInvoiceAmountStart').val('0.00');
        $('#txtInvoiceAmountEnd').val('0.00');
    });

    $('#btnAdvSearchReset').click(function(e){
        $("#winAdvanceSearch input").not("input[type='button']").val("");
        $('#cboInvoiceType').val(0);
        $('#cboRefType').val(0);

        $('#cboInvoiceDate').val(0);
        $('#txtInvoiceStartDate').datebox({ disabled : true });
        $('#txtInvoiceEndDate').datebox({ disabled : true });

        $('#cboBillDate').val(0);
        $('#txtBillStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtBillEndDate').datebox('setValue', icsdateformat(new Date()));

        $('#cboInvoiceAmount').val(0);
        $('#txtInvoiceAmountStart').prop("disabled", true);
        $('#txtInvoiceAmountEnd').prop("disabled", true);
        $('#txtInvoiceAmountStart').val('0.00');
        $('#txtInvoiceAmountEnd').val('0.00');

        $('#cboApprovedBy,#cboInvoicePaymentMode').val(0);
        $('#txtSupplierName').data('Suppliers', []);
        $("#txtSupplierName").removeClass("fontColorOfPickItem");
        $('#txtProductName').data('Products', []);
        $("#txtProductName").removeClass("fontColorOfPickItem");
    });

    $('#btnSearch').click(function(e){
        if(!ValidateSearch()) return;

        var sInvoiceNo =$.trim($('#txtInvoiceNo').val());
        var sBillNo =$.trim($('#txtBillNo').val());
        var sImportLC =$.trim($('#txtImportLC').val());
        var sImportInvoice =$.trim($('#txtImportInvoice').val());

        var nInvoiceType = parseInt($('#cboInvoiceType').val());
        var nRefType = parseInt($('#cboRefType').val());
        var sPONo =$.trim($('#txtPONo').val());

        var nInvoiceDate = parseInt($('#cboInvoiceDate').val());
        var sInvoiceStartDate   = $('#txtInvoiceStartDate').datebox('getValue');
        var sInvoiceEndDate   = $('#txtInvoiceEndDate').datebox('getValue');

        var nBillDate = parseInt($('#cboBillDate').val());
        var sBillStartDate   = $('#txtBillStartDate').datebox('getValue');
        var sBillEndDate   = $('#txtBillEndDate').datebox('getValue');

        var nInvoiceAmount = parseInt($('#cboInvoiceAmount').val());
        var sInvoiceAmountStart = icsRemoveComma($.trim($('#txtInvoiceAmountStart').val()));
        var sInvoiceAmountEnd = icsRemoveComma($.trim($('#txtInvoiceAmountEnd').val()));

        var nApprovedBy = parseInt($('#cboApprovedBy').val());
        var nInvoicePaymentMode = parseInt($('#cboInvoicePaymentMode').val());
        var oSuppliers = $('#txtSupplierName').data('Suppliers');
        var oProducts = $('#txtProductName').data('Products');

        if(oSuppliers===null) {oSuppliers = []; }
        if(oProducts===null) {oProducts = []; }
        var sSupplierIDs =""; var sProductIDs ="";

        for(var i=0; i<oSuppliers.length; i++)
        {
            sSupplierIDs  = sSupplierIDs + oSuppliers[i].ContractorID+ ",";
        }
        if(sSupplierIDs.length>0)
        {
            sSupplierIDs=sSupplierIDs.substring(0, sSupplierIDs.length-1);
        }
        for(var i=0; i<oProducts.length; i++)
        {
            sProductIDs  = sProductIDs + oProducts[i].ProductID+ ",";
        }
        if(sProductIDs.length>0)
        {
            sProductIDs=sProductIDs.substring(0, sProductIDs.length-1);
        }
        var nPIT = $('#tblPurchaseInvoices').data('PTI');

        var sSearchingData  =  sInvoiceNo+'~';
        sSearchingData = sSearchingData + sBillNo+'~';
        sSearchingData = sSearchingData + nInvoiceType+'~';
        sSearchingData = sSearchingData + nRefType+'~';
        sSearchingData = sSearchingData + sPONo+'~';
        sSearchingData = sSearchingData + nInvoiceDate+'~';
        sSearchingData = sSearchingData + sInvoiceStartDate+'~';
        sSearchingData = sSearchingData + sInvoiceEndDate+'~';
        sSearchingData = sSearchingData + nBillDate+'~';
        sSearchingData = sSearchingData + sBillStartDate+'~';
        sSearchingData = sSearchingData + sBillEndDate+'~';
        sSearchingData = sSearchingData + nInvoiceAmount+'~';
        sSearchingData = sSearchingData + sInvoiceAmountStart+'~';
        sSearchingData = sSearchingData + sInvoiceAmountEnd+'~';
        sSearchingData = sSearchingData + nApprovedBy+'~';
        sSearchingData = sSearchingData + sSupplierIDs +'~';
        sSearchingData = sSearchingData + sProductIDs+'~';
        sSearchingData = sSearchingData + nPIT+'~';
        sSearchingData = sSearchingData + nInvoicePaymentMode+'~';
        sSearchingData = sSearchingData + sImportLC+'~';
        sSearchingData = sSearchingData + sImportInvoice;

        var oPurchaseInvoice = {
            Note : sSearchingData,
            BUID : parseInt(sessionStorage.getItem("BUID"))
        };

        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/AdvanceSearch",
            data:  JSON.stringify(oPurchaseInvoice),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oPurchaseInvoices = jQuery.parseJSON(data);
                if (oPurchaseInvoices != null) {
                    if(oPurchaseInvoices.length>0)
                    {
                        if(oPurchaseInvoices[0].ErrorMessage=="")
                        {
                            RefreshList(oPurchaseInvoices);
                            $('#tblPurchaseInvoices').data('PurchaseInvoices', oPurchaseInvoices);
                            $("#winAdvanceSearch").icsWindow('close');
                        }
                        else
                        {
                            alert(oPurchaseInvoices[0].ErrorMessage);
                        }
                    }
                    else
                    {
                        alert("Data not found!!");
                    }
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#txtSearchByInvoiceNo').keyup(function (e) {
        var c = String.fromCharCode(e.which);
        var txtSearchByName = document.getElementById('txtSearchByInvoiceNo').value;

        var oSearchedPurchaseInvoices = [];  var sTempName="";
        var oPurchaseInvoiceList = $('#tblPurchaseInvoices').datagrid('getRows');
        if (e.which == 8)
        {
            oPurchaseInvoiceList = $('#tblPurchaseInvoices').data('PurchaseInvoices');
        }
        else if(e.which == 13){
            for(i=0;i<oPurchaseInvoiceList.length;++i){
                sTempName=oPurchaseInvoiceList[i].PurchaseInvoiceNo;
                n=sTempName.toUpperCase().indexOf(txtSearchByName.toUpperCase())
                if(n!=-1)
                {
                    oSearchedPurchaseInvoices.push(oPurchaseInvoiceList[i]);
                }
            }
            //RefreshList(oSearchedPurchaseInvoices);
            if(oSearchedPurchaseInvoices.length > 0)
            {
                RefreshList(oSearchedPurchaseInvoices);
            }
            else
            {
                SearchByInvoiceNo(txtSearchByName);
            }
        }
    });

    function SearchByInvoiceNo(txtSearchByName)
    {
        debugger;
        var oPurchaseInv = {
            BUID : parseInt(sessionStorage.getItem("BUID")),
            PurchaseInvoiceNo: txtSearchByName
        };

        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: sessionStorage.getItem("BaseAddress")+  "/PurchaseInvoice/SearchByInvoiceNo",
            data:  JSON.stringify(oPurchaseInv),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var  oPIs = jQuery.parseJSON(data);
                if (oPIs != null) {
                    if(oPIs.length>0)
                    {
                        if(oPIs[0].ErrorMessage=="")
                        {
                            RefreshList(oPIs);
                        }
                        else
                        {
                            alert(oPIs[0].ErrorMessage);
                        }
                    }
                    else
                    {
                        alert("Data not found!!");
                    }
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    };

    ///Supplier Pick
    $("#txtSupplierName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var nBUID = parseInt(sessionStorage.getItem("BUID"));
            var oContractor = { Params: 1 + '~' + $.trim($('#txtSupplierName').val())+'~'+ nBUID };//here 1 is Supplier
            var obj = {
                BaseAddress: sessionStorage.getItem("BaseAddress"),
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            $("#progbar").progressbar({ value: 0 });
            $("#progbarParent").show();
            var intervalID = setInterval(updateProgress, 250);
            $.icsDataGets(obj, function (response) {
                clearInterval(intervalID);
                $("#progbarParent").hide();
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winSuppliers',
                            winclass: 'clsSupplier',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblSuppliers',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName: 'Name',
                            windowTittle: 'Supplier List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else{
                    alert("Data Not Found.");
                    return;
                }
            });
        }
    });
    $("#btnSupplierPicker").click(function () {
        var nBUID = parseInt(sessionStorage.getItem("BUID"));
        var oContractor = { Params: "1~~"+nBUID };//here 1 Is Supplier
        var obj = {
            BaseAddress: sessionStorage.getItem("BaseAddress"),
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progbar").progressbar({ value: 0 });
        $("#progbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winSuppliers',
                        winclass: 'clsSupplier',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblSuppliers',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Supplier List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });

    });
    $('#txtSupplierName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            $("#txtSupplierName").removeClass("fontColorOfPickItem");
            $('#txtSupplierName').data('SupplierID', 0);
        }
    });
    $('#btnSupplierClear').click(function(e){
        $("#txtSupplierName").val("");
        $('#txtSupplierName').data('Suppliers', []);
        $("#txtSupplierName").removeClass("fontColorOfPickItem");
    });
    //End Supplier Picker

    //Product Pick
    $("#txtProductName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtProductName').val()==null || $('#txtProductName').val()=="")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtProductName').focus();
                return;
            }
            var nBUID = parseInt(sessionStorage.getItem("BUID"));
            var oProduct = { BUID: nBUID, ProductName: $.trim($('#txtProductName').val())};
            var obj = {
                BaseAddress: sessionStorage.getItem("BaseAddress"),
                Object: oProduct,
                ControllerName: "Product",
                ActionName: "SearchByProductBUWise",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {
                debugger;
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ProductID > 0) {
                        var tblColums = [];
                        var oColumn = { field: "ProductCode", title: "Product Code", width: 80, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ProductName", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ProductCategoryName", title: "Category", width: 100, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winProductPicker',
                            winclass: 'clsProductPicker',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblProductPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName: 'NameCode',
                            windowTittle: 'Product List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }

                }else{
                    alert("Data Not Found.");
                }
            });
        }
    });
    $("#btnProductPicker").click(function () {
        var nBUID = parseInt(sessionStorage.getItem("BUID"));
        var oProduct = { BUID: nBUID};
        var obj = {
            BaseAddress: sessionStorage.getItem("BaseAddress"),
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Product Code", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductCategoryName", title: "Category", width: 100, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass: 'clsProductPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });

    });
    $('#txtProductName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            $("#txtProductName").removeClass("fontColorOfPickItem");
            $('#txtProductName').data('Product', null);
        }
    });
    $('#btnProductClear').click(function(e){
        $("#txtProductName").val("");
        $('#txtProductName').data('Products', []);
        $("#txtProductName").removeClass("fontColorOfPickItem");
    });
    //End Product

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid === 'winSuppliers')
        {
            if (oreturnobjs != null && oreturnobjs.length > 0) {
                $('#txtSupplierName').val(oreturnobjs.length+"'s suppliers seleted");
                $('#txtSupplierName').addClass('fontColorOfPickItem');
                $('#txtSupplierName').data('Suppliers', oreturnobjs);
                $('#txtSupplierName').focus();
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnobjs != null && oreturnobjs.length > 0)
            {
                $('#txtProductName').val(oreturnobjs.length+"'s products seleted");
                $('#txtProductName').addClass('fontColorOfPickItem');
                $('#txtProductName').data('Products', oreturnobjs);
            }
        }
    }

    function updateProgress() {
        var value =$('#progbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progbar').progressbar('setValue', value);
        }
    }

    function hideShow(miliseconds) {
        $("#progbarParent").hide();
    }

    $(document).keydown(function (e) {
        if (e.which == 27)//escape=27
        {
            $("#winAdvanceSearch").icsWindow('close');
        }
    });

    function RefreshControlLayout(oAURolesMapping)
    {
        $("#btnAdvSearch").hide();
        $("#btnAdd").hide();
        $("#btnEdit").hide();
        $("#btnView").hide();
        $("#btnDelete").hide();
        $("#btnWaitForApproved").hide();
        $("#btnApproved").hide();
        $("#btnPreview").hide();
        $("#btnPrintList").hide();
        $('#btnSendTo').hide();
        if(PermissionChecker('AdvSearch','PurchaseInvoice',oAURolesMapping)){$("#btnAdvSearch").show();}
        if(PermissionChecker('Add','PurchaseInvoice',oAURolesMapping)){$("#btnAdd").show();}
        if(PermissionChecker('Edit','PurchaseInvoice',oAURolesMapping)){$("#btnEdit").show();}
        if(PermissionChecker('View','PurchaseInvoice',oAURolesMapping)){$("#btnView").show();}
        if(PermissionChecker('Delete','PurchaseInvoice', oAURolesMapping)){$("#btnDelete").show();}
        if(PermissionChecker('Approved','PurchaseInvoice',oAURolesMapping)){$("#btnApproved").show();}
        if(PermissionChecker('Approved','PurchaseInvoice',oAURolesMapping)){$("#btnWaitForApproved").show();}
        if(PermissionChecker('Preview','PurchaseInvoice',oAURolesMapping)){$("#btnPreview").show();}
        if(PermissionChecker('PrintList','PurchaseInvoice',oAURolesMapping)){$("#btnPrintList").show();}

        if(PermissionChecker('FollowUp','PurchaseInvoice',oAURolesMapping))
        {
            $("#btnSendTo").show();    $('#winSendTo').data("IsApprovalHead",true);
        }
        else $('#tblPurchaseInvoices').datagrid('hideColumn', 'ApprovalStatus');
    }

</script>


