@{
    ViewBag.Title = "Current Stock(Details)";
}
@model IEnumerable<ESimSol.BusinessObjects.Lot>

<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>
<div class="menuMainCollectionTable">
    <div style="margin-left:0px; height:100%; width:100%">
        <table id="tblLots" title="Product List" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">

        </table>
        <div id="toolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="Refresh()"></a>
            <select id="cboProductCategory" class="easyui-combotree" style="width:180px;"></select>
            <input type="button" id="btnCleanPC" value="C" />
            <input id="txtWorkingUnit" style="width:120px%;" type="text" placeholder="Type store & Press Enter" />
            <a id="btnPickWorkingUnit" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
            <select id="cboReportLayOut" style="width:140px"></select>
            <input type="text" id="txtSearchByName" placeholder="Search by Product Name/Code/HSCode" style="width:225px" />
            <input type="text" id="txtSearchByLotNo" placeholder="Search by Lot No" style="width:80px" />
            <input type="text" id="txtSearchByColorName" placeholder="Search Color" style="width:80px" />
            <input type="text" id="txtSearchBySizeName" placeholder="Search by Size Name" style="width:125px" />
            <input type="text" id="txtSupplierName" placeholder="Search Supplier" style="width:95px" />
            <input type="text" id="txtStyleNo" placeholder="Search Style" style="width:80px" />
            <input type="text" id="txtBuyerName" placeholder="Search Buyer" style="width:80px" />
            <input type="text" id="txtDiaOrGSM" placeholder="Search Dia MC+Finish+GSM" style="width:170px" />
            <input type="checkbox" id="chkIsZeroShow"/><label for="chkIsZeroShow">Only Zero Balance</label> 
            <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
            <input type="text" id="txtSearchByCode" placeholder="Search by Code" style="width:100px" />            
            <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
            <a id="btnPrintXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">XL</a>            
            <a id="btnViewLedger" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">Product Ledger</a>
            <a id="btnViewPiInfo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">PI Info</a>
            <a id="btnPrintCategoryWise" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Category Wise</a>
            <a id="btnPrintGroupWise" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Group Wise</a>
            <a id="btnPrintCategoryWiseXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Category Wise XL</a>
            <a id="btnPrintGroupWiseXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true">Group Wise XL</a>
        </div>
    </div>
    
    <div id="winProductTransaction" class="easyui-window" title="Salesman Log" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <fieldset>
            <table id="tblProductTransaction" style="text-align:center; margin-right:10px; ">
                <tr>
                    <td class="td-col-5 align-right">
                        <label>Start Date:</label>
                    </td>
                    <td class="td-col-15">
                        <input id="dtTransactionFrom" type="text" style="width:90%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>
                <tr>
                    <td class="td-col-5 align-right">
                        <label>End Date:</label>
                    </td>
                    <td class="td-col-15">
                        <input id="dtTransactionTo" type="text" style="width:90%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <div style="text-align:right;">
                <a id="btnPrintLedger" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                <a id="btnCloseLedger" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </div>

        </fieldset>
    </div>

</div>
<style type="text/css">

    #tblProductTransaction {
        width: 300px;
    }

    .td-col-5 label {
        width: 100%;
    }

    .td-col-15 select {
        width: 97%;
    }

    .td-col-15 input, textarea {
        width: 97%;
    }

    .td-col-5 input {
        width: 85%;
    }

    .td-col-15 .txt-styler-picker {
        width: 79%;
    }
</style>

<script type="text/javascript">
    var _sBaseAddress="";
    var _bViewRate=false;
    var _nBusinessUnitType=0;
    $(document).ready(function () {
        var oLots =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var nBUID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.SelectedBUID));
         _nBusinessUnitType =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BusinessUnitType));
        var oWorkingUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WorkingUnits));
        var oClientOperationSetting = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ClientOperationSetting));
        var oReportLayOuts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ReportLayOuts));

        var oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        RefreshControlLayout(oAuthorizationRolesMapping);
        $('#txtWorkingUnit').data("WorkingUnitIDs", "");
        $("#cboReportLayOut").icsLoadCombo({ List: oReportLayOuts, OptionValue: "id", DisplayText: "Value" });
        $('#tblLots').data("BUID", nBUID);

        $('#btnPrintGroupWise,#btnPrintCategoryWise,#btnPrintGroupWiseXL,#btnPrintCategoryWiseXL').hide();
        $('#tblLots').data("ClientOperationSetting", oClientOperationSetting);
        $('#txtSupplierName').data("ContractorIDs","");
        $('#tblLots').data("StyleIDs","");
        $('#tblLots').data("Lots", oLots);
        RefreshProductCategory(0);
        DefineDataGridColumn(1)
        RefreshList(oLots);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $('#btnViewPiInfo,#txtStyleNo').hide();


        //$('#btnPrintXL').hide();
    });

    $("#btnCleanPC").click(function(){
        debugger;
        $('#cboProductCategory').combotree('loadData', []);
        RefreshProductCategory(0);
    });

    $("#txtWorkingUnit").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var txtWorkingUnit=$.trim($("#txtWorkingUnit").val());
            if(txtWorkingUnit==""){ alert("Type product name to search."); return false; }
            GetWorkingUnits(txtWorkingUnit);
        }
        else if(nkeyCode==8){
            $('#txtWorkingUnit').data("WorkingUnitIDs","");
            //$("#txtWorkingUnit").val("");
        }
    });
    $("#btnPickWorkingUnit").click(function () {
        var txtWorkingUnit=$.trim($("#txtWorkingUnit").val());
        GetWorkingUnits(txtWorkingUnit);
    });
    function GetWorkingUnits(txtWorkingUnit){
        var oWorkingUnit = {
            BUID:parseInt($('#tblLots').data("BUID")),
            LocationName:txtWorkingUnit,
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oWorkingUnit,
            ControllerName: "WorkingUnit",
            ActionName: "GetsBUWiseWorkingUnit",
            IsWinClose: false
        };

        if(parseInt($('#tblLots').data("BUID"))<=0)
        {
            oWorkingUnit = { LOUNameCode : txtWorkingUnit };
            obj = {
                BaseAddress: _sBaseAddress,
                Object: oWorkingUnit,
                ControllerName: "WorkingUnit",
                ActionName: "GetsWorkingUnit",
                IsWinClose: false
            };
        }



        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].WorkingUnitID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "WorkingUnitCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "WorkingUnitName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winWorkingUnitPicker',
                        winclass:'clsWorkingUnitPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblWorkingUnit',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'WorkingUnitName',
                        windowTittle: 'Store List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Store found.");
            }
        });

    }


    $('#cboReportLayOut').change(function(){
        if(parseInt($('#cboReportLayOut').val())==4)
        {
            $('#btnViewPiInfo,#txtStyleNo').show();
        }else{
            $('#tblLots').data("StyleIDs","");
            $('#btnViewPiInfo,#txtStyleNo').hide();
        }
        if(parseInt($('#cboReportLayOut').val())==1)//Product wise
        {
            $('#btnPrintGroupWise,#btnPrintCategoryWise,#btnPrintGroupWiseXL,#btnPrintCategoryWiseXL').show();
        }
    })
    $('#btnViewPiInfo').click(function (e) {
        var oLot = $('#tblLots').datagrid('getSelected');
        if(oLot==null || parseInt(oLot.LotID)<=0)
        {
            alert("Please Select a Item.");
            return;
        }
        var oPTUUnit2Distribution = {LotID:parseInt(oLot.LotID)};
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductStock/GetPIInfo",
            traditional: true,
            data:  JSON.stringify(oLot),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oPTUUnit2Distributions= jQuery.parseJSON(data);
                if(oPTUUnit2Distributions.length>0)
                {
                    if (oPTUUnit2Distributions[0].ErrorMessage=="")
                    {
                        if(oPTUUnit2Distributions.length>0)
                        {
                            var tblColums = [];
                            var oColumn = { field: "PINo", title: "PI No", width:150, align: "left" };tblColums.push(oColumn);
                            oColumn = { field: "BuyerName", title: "Buyer", width:120, align: "center" };tblColums.push(oColumn);
                            oColumn = { field: "QtySt", title: "Quantity", width:100, align:"right"};tblColums.push(oColumn);

                            var oPickerParam = {
                                winid: 'winHistoryPicker',
                                winclass:'clsHistoryPicker',
                                winwidth: 460,
                                winheight: 460,
                                tableid: 'tblHistoryPicker',
                                tablecolumns: tblColums,
                                datalist: oPTUUnit2Distributions,
                                multiplereturn: false,
                                searchingbyfieldName:'OperationDateInString',
                                windowTittle: 'History List'
                            };
                            $.icsPicker(oPickerParam);
                            $("#btnOk").hide();
                        }
                    }
                    else
                    {
                        alert(oPTUUnit2Distributions[0].ErrorMessage);
                    }
                } else
                {
                    alert("Data Not Found.");
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });

    });
    $('#btnPrint').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/PrintProductDetailsStock?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&ts="+tsv, "_blank");
    });

    $('#btnPrintXL').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/ExcelExport?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&ts="+tsv, "_blank");
    });


    $('#btnPrintCategoryWise').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/PrintGroupOrCategoryWise?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&IsCategoryWise=true&ts="+tsv, "_blank");
    });
    
    $('#btnPrintCategoryWiseXL').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/GroupOrCategoryWiseXL?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&IsCategoryWise=true&ts="+tsv, "_blank");
    });

    $('#btnPrintGroupWise').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/PrintGroupOrCategoryWise?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&IsCategoryWise=false&ts="+tsv, "_blank");
    });
    $('#btnPrintGroupWiseXL').click(function (e) {
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nLayout =parseInt($("#cboReportLayOut").val());
        var sProductName  = $.trim($('#txtSearchByName').val());
        var sLotNo = $.trim($('#txtSearchByLotNo').val());
        var sSizeName = $.trim($('#txtSearchBySizeName').val());
        var sColorName=$.trim($('#txtSearchByColorName').val());
        var sBuyerName=$.trim($('#txtBuyerName').val());
        var sDiaOrGSM = $.trim($('#txtDiaOrGSM').val());
        var sSupplierIDs = $.trim($('#txtSupplierName').data("ContractorIDs"));
        var sStyleIDs = $.trim($('#tblLots').data("StyleIDs"));
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + "/ProductStock/GroupOrCategoryWiseXL?pcid="+nPCID+"&WorkingUnitIDs="+$('#txtWorkingUnit').data("WorkingUnitIDs")+"&layout="+nLayout+"&buid="+nBUID+"&productname="+sProductName+"&LotNo="+sLotNo+"&SizeName="+sSizeName+"&SupplierIDs="+sSupplierIDs+"&StyleIDs="+sStyleIDs+"&ColorName="+sColorName+"&BuyerName="+sBuyerName+"&sDiaOrGSM="+sDiaOrGSM+"&IsCategoryWise=false&ts="+tsv, "_blank");
    });

    $('#tblLots').datagrid({
        onSortColumn: function(sort,order){
            var oLots = $('#tblLots').datagrid('getRows');
            var oTempProducts=[];
            if(order=="asc")
            {
                oTempProducts= oLots.sort(dynamicSort(sort));
            }
            else
            {
                oTempProducts= oLots.sort(dynamicSort("-"+sort));
            }
            RefreshList(oTempProducts);
        }
    });

    function dynamicSort(property) {
        var sortOrder = 1;
        if(property[0] === "-") {
            sortOrder = -1;
            property = property.substr(1);
        }
        return function (a,b) {
            var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
            return result * sortOrder;
        }
    }

    $('#btnSearch').click(function (e) {
        var nPCID=0;
        var nCategoryID = $('#cboProductCategory').combotree('getValue');
        if(nCategoryID !=null)
        {
            nPCID=nCategoryID;
        }
        var oLot = {
            PCID:parseInt(nPCID),
            LocationName:$('#txtWorkingUnit').data("WorkingUnitIDs"),
            Layout:parseInt($("#cboReportLayOut").val()),
            BUID:parseInt($('#tblLots').data("BUID")),
            ProductName:$.trim($('#txtSearchByName').val()),
            StyleNo:$('#tblLots').data("StyleIDs"),
            LotNo:$.trim($('#txtSearchByLotNo').val()),
            ColorName:$.trim($('#txtSearchByColorName').val()),
            SizeName:$.trim($('#txtSearchBySizeName').val()),
            BuyerName:$.trim($('#txtBuyerName').val()),
            MCDia:$.trim($('#txtDiaOrGSM').val()),
            SupplierName:$('#txtSupplierName').data("ContractorIDs"),
            ErrorMessage:$('#chkIsZeroShow').prop('checked')
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/ProductStock/GetsProductStocks",
            traditional: true,
            data:  JSON.stringify(oLot),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                var oLots = data;
                if(oLots != null && oLots.length > 0)
                {
                    if(oLots[0].ErrorMessage === "")
                    {
                        $('#tblLots').data("Lots", oLots);
                        DefineDataGridColumn(parseInt($("#cboReportLayOut").val()))
                        RefreshList(oLots);
                    }
                    else
                    {
                        alert(oLots[0].ErrorMessage);
                    }
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#txtSearchByCode').keyup(function (e) {
        var c = String.fromCharCode(e.which);
        var txtSearchByCode = document.getElementById('txtSearchByCode').value;

        var oSearchedProducts = [];  var sTempCode="";
        var oLotList = $('#tblLots').datagrid('getRows');
        if (e.which == 8)
        {
            oLotList = $('#tblLots').data("Lots");
        }
        for(i=0;i<oLotList.length;++i){
            sTempCode=oLotList[i].ProductCode;
            n=sTempCode.toUpperCase().indexOf(txtSearchByCode.toUpperCase())
            if(n!=-1)
            {
                oSearchedProducts.push(oLotList[i]);
            }
        }
        RefreshList(oSearchedProducts);
    });

    function RefreshProductCategory(nPCID)
    {
        var oProductCategory ={  ProductCategoryID: 0 };
        $.ajax
        ({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem("BaseAddress")+  "/ProductCategory/GetsProductCategoryForCombo",
            data:  JSON.stringify(oProductCategory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oProductCategorys = jQuery.parseJSON(data);
                if(oProductCategorys!=null)
                {
                    $('#cboProductCategory').combotree('loadData', oProductCategorys);
                    $('#cboProductCategory').combotree('setValue', nPCID);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }
    function Refresh()
    {
        var oLots = $('#tblLots').datagrid('getRows');
        data=oLots;
        data={"total":""+data.length+"","rows":data};
        $('#tblLots').datagrid('loadData',data);
    }

    function RefreshList(oLots)
    {
        data=oLots;
        data={"total":""+data.length+"","rows":data};
        $('#tblLots').datagrid('loadData',data);
    }

    function DefineDataGridColumn(nReportLayOut)
    {
        var tblColums=[];
        var oColumn=null;
        var oClientOperationSetting= $('#tblLots').data("ClientOperationSetting");
        //Report Layout : ProductWise = 1, ProductAndColorWise = 2, ProductAndStoreWise = 3, ProductAndLotWise =4
        oColumn= { field :"ProductCode", title:"Code", width:"80"};  tblColums.push(oColumn);
        oColumn= { field :"ProductName", title:"Product Name", width:"200"};  tblColums.push(oColumn);
        oColumn= { field :"RackNo", title:"Rack No", width:"100"};  tblColums.push(oColumn);
        if(nReportLayOut!=1)
        {
            if(_nBusinessUnitType!=1 )/// 1=Dyeing
            {
                oColumn= { field :"ColorName", title:"Color Name", width:"100"};  tblColums.push(oColumn);
            }
        }
        if(nReportLayOut===3 || nReportLayOut==4)
        {
            oColumn= { field :"WorkingUnitName", title:"Store Name", width:"200"};  tblColums.push(oColumn);
        }
        if(nReportLayOut==4)
        {
            if(_nBusinessUnitType!=1 )/// 1=Dyeing
            {
                oColumn= { field :"SizeName", title:"Size Name", width:"100"};  tblColums.push(oColumn);
            }
            oColumn= { field :"LotNo", title:"Lot No", width:"150"};  tblColums.push(oColumn);

            if(_nBusinessUnitType!=1 )/// 1=Dyeing
            {
                oColumn= { field :"WeightPerCartoon", title:"Weight/Carton", width:"100",align: "right"};  tblColums.push(oColumn);
                oColumn= { field :"ConePerCartoon", title:"Cone/Carton", width:"100",align: "right"};  tblColums.push(oColumn);
            }
            if(oClientOperationSetting!=null && oClientOperationSetting.ValueInString=="Yes")//isProcurement with style No
            {
                oColumn= { field :"StyleNo", title:"Style No", width:"150"};  tblColums.push(oColumn);
                oColumn= { field :"MCDia", title:"MC Dia", width:"100"};  tblColums.push(oColumn);
                oColumn= { field :"FinishDia", title:"Finish Dia", width:"100"};  tblColums.push(oColumn);
                oColumn= { field :"GSM", title:"GSM", width:"80"};  tblColums.push(oColumn);
            }
            oColumn= { field :"SupplierName", title:"Supplier", width:"150"};  tblColums.push(oColumn);
           
            if(_nBusinessUnitType!=1 )/// 1=Dyeing
            {  oColumn= { field :"BuyerName", title:"Buyer", width:"100"};  tblColums.push(oColumn);
                oColumn= { field :"Shade", title:"Shade", width:"50"};  tblColums.push(oColumn);
                oColumn= { field :"Stretch_Length", title:"S.Length", width:"50"};  tblColums.push(oColumn);
            }
        }

        oColumn= { field :"BalanceSt", title:"Stock Qty", width:"100", align: "right"};  tblColums.push(oColumn);
        if(_bViewRate)
        {
            oColumn= { field :"UnitPriceSt", title:"Unit Price", width:"100", align: "right"};  tblColums.push(oColumn);
            oColumn= { field :"FCUnitPriceSt", title:"FC U. Price", width:"100", align: "right"};  tblColums.push(oColumn);
            oColumn= { field :"FCSymbol", title:"FC Symbol", width:"60", align: "left"};  tblColums.push(oColumn);
            oColumn= { field :"StockValueSt", title:"Stock Value", width:"100",  align: "right"}; tblColums.push(oColumn);
        }
        oColumn= { field :"ReportingBalanceSt", title:"Qty(Report)", width:"100",  align: "right"}; tblColums.push(oColumn);
        $('#tblLots').datagrid({ columns:[tblColums]});
    }

    /*------------------- Product Ledger --------------------------*/
    $('#btnViewLedger').click(function (e) {
        var oLot = $('#tblLots').datagrid('getSelected');
        if(oLot==null || oLot.ProductID<=0){
            alert("Please select an item from list.");
            return false;
        }
        $('#dtTransactionFrom, #dtTransactionTo').datebox('setValue', icsdateformat(new Date()));
        $("#winProductTransaction").icsWindow('open', 'Product Name: '+ oLot.ProductName);
    });
    $("#btnPrintLedger").click(function () {

        var oLot = $('#tblLots').datagrid('getSelected');
        if($.trim($('#dtTransactionFrom').datebox('getValue'))=="")
        {
            alert('Invalid date fromat in start date');
            $('#dtTransactionFrom').select().focus();
            return false;
        }
        if($.trim($('#dtTransactionTo').datebox('getValue'))==""){
            alert('Invalid date fromat in end date');
            $('#dtTransactionTo').select().focus();
            return false;
        }

        if(new Date($('#dtTransactionFrom').datebox('getValue'))>new Date($('#dtTransactionTo').datebox('getValue'))){
            alert("End date must be later than start date.");
            return false;
        }
        $('#winProductTransaction').icsWindow('close');
        var nBUID = parseInt($('#tblLots').data("BUID"));
        var nProductID=0;
        var nLotID = 0;
        var nWUID = 0;
        var nColorID = 0;

        if($("#cboReportLayOut").val()==1) //ProductWise = 1
        {
            nProductID = oLot.ProductID;

        }
        if($("#cboReportLayOut").val()==2) //ProductAndColorWise = 2
        {
            nProductID = oLot.ProductID;
            nColorID=oLot.ColorID;
        }
        if($("#cboReportLayOut").val()==3) //ProductAndStoreWise =3
        {
            nProductID = oLot.ProductID;
            nWUID=oLot.WorkingUnitID;
        }
        if($("#cboReportLayOut").val()==4) //ProductAndLotWise =4
        {
            nProductID = oLot.ProductID;
            nLotID= oLot.LotID;
        }

        var tsv = ((new Date()).getTime())/1000;
        window.open(sessionStorage.getItem("BaseAddress") + '/ProductStock/PrintProductLedger?productId='+oLot.ProductID+'&dtFrom='+$('#dtTransactionFrom').datebox('getValue')+'&dtTo='+$('#dtTransactionTo').datebox('getValue')+"&lotId="+nLotID+"&wuId="+nWUID+"&colorId="+nColorID+ "&buId="+nBUID+"&ts="+tsv, "_blank");

    });

    $("#btnCloseLedger").click(function () {
        $('#winProductTransaction').icsWindow('close');
    });
    $("#txtSearchByName,#txtSearchByLotNo,#txtSearchBySizeName,#txtSearchByColorName,#txtDiaOrGSM,#txtBuyerName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {

            alert("Please Click Search Button for report");
            return;

        }else if (code == 8) //backspace=8
        {
            $("#txtSupplierName").removeClass("fontColorOfPickItem");
            $('#txtSupplierName').data("ContractorIDs","");
        }
    });
    //txtSupplierName
    $("#txtSupplierName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {

            var oContractor = { Params: 1 + '~' + $.trim($('#txtSupplierName').val())+'~'+sessionStorage.getItem("BUID") };
            var obj = {
                BaseAddress: sessionStorage.getItem('BaseAddress'),
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            var $This=$(this);
            $.icsProgressBar(true);
            $.icsDataGets(obj, function (response) {
                $.icsProgressBar(false);
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ContractorTypeInString", title: "Type", width: 80, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 50, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winContractor',
                            winclass:'clsContractor',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblContractors',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName:'Name',
                            windowTittle: 'Contractor List',
                            TextBox:$This
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }
            });

        }else if (code == 8) //backspace=8
        {
            $("#txtSupplierName").removeClass("fontColorOfPickItem");
            $('#txtSupplierName').data("ContractorIDs","");
        }
    });
    //start style picker
    $("#txtStyleNo").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var sStyleNumber = $.trim($('#txtStyleNo').val());
            if(sStyleNumber=== null || sStyleNumber === "")
            {
                alert("Press Enter With Style Number!");
                $('#txtStyleNo').focus();
                return;
            }
            var oTechnicalSheet = { StyleNo: sStyleNumber, BUID:parseInt($('#tblLots').data("BUID"))};
            var obj = {
                BaseAddress: sessionStorage.getItem('BaseAddress'),
                Object: oTechnicalSheet,
                ControllerName: "TechnicalSheet",
                ActionName: "StyleSearch",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].TechnicalSheetID > 0) {
                        var tblColums = []; var oColumn = { field: "StyleNo", title: "Style No", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "BuyerName", title: "Buyer Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "SessionName", title: "Business Session", width: 100, align: "left" }; tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winStylePicker',
                            winclass: 'clsStylePicker',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblStylePicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName: 'StyleNo',
                            windowTittle: 'Style List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }

                }else{
                    alert("Data Not Found.");
                }
            });
        }else  if (code == 8) //backspace=8
        {
            $("#txtStyleNo").removeClass("fontColorOfPickItem");
            $('#tblLots').data("StyleIDs","");
        }
    });

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn)
        {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winContractor')//Contractor region
        {
            if (oreturnobjs != null && oreturnobjs.length> 0)
            {
                if(oreturnobjs.length>1)
                {
                    $('#txtSupplierName').val(oreturnobjs.length+"'s Item Selected");
                }else{
                    $('#txtSupplierName').val(oreturnobjs[0].Name);
                }

                $('#txtSupplierName').addClass('fontColorOfPickItem');
                $('#txtSupplierName').data("ContractorIDs",ICS_PropertyConcatation(oreturnobjs,'ContractorID'));
                $('#txtSupplierName').focus();
            }
        }else   if (oPickerobj.winid === 'winStylePicker')
        {
            if (oreturnobjs != null && oreturnobjs.length > 0) {
                $('#txtStyleNo').val(oreturnobjs.length+"'s Styles seleted");
                $('#txtStyleNo').addClass('fontColorOfPickItem');
                $('#tblLots').data("StyleIDs",ICS_PropertyConcatation(oreturnobjs,'TechnicalSheetID'));
                $('#txtStyleNo').focus();
            }
        }else if (oPickerobj.winid == 'winWorkingUnitPicker')
        {
            debugger;
            if (oreturnobjs != null && oreturnobjs.length> 0)
            {
                var sMessage='';
                sMessage=(oreturnobjs.length>1)? oreturnobjs.length +" store Selected" : oreturnobjs[0].WorkingUnitName;
                $('#txtWorkingUnit').val(sMessage);
                $("#txtWorkingUnit").addClass("fontColorOfPickItem");
                $('#txtWorkingUnit').data("WorkingUnitIDs",ICS_PropertyConcatation(oreturnobjs,'WorkingUnitID'));
            }

        }
    }

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }

    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    function RefreshControlLayout(oAuthorizationRolesMapping)
    {
        _bViewRate=false;
        if(oAuthorizationRolesMapping.length>0)
        {
            if (PermissionChecker('RateView', 'Lot',oAuthorizationRolesMapping))
            {
                _bViewRate=true;
            }
        }
    }
</script>
