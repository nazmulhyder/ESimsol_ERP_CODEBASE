@{
    ViewBag.Title = "Business Sessions";
}
@model IEnumerable<ESimSol.BusinessObjects.BusinessSession>

                      <div class="menuMainCollectionTable">
                          <table id="tblBusinessSessions" title="Business Sessions List" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" , autorowheight="false" toolbar="#toolbar">
                              <thead>
                                  <tr>
                                      <th field="SessionName" width="350">Season Name</th>
                                      <th field="IsActiveInString" width="100">Active / In-Active</th>
                                      <th field="Note" width="250">Note</th>
                                  </tr>
                              </thead>
                          </table>
                          <div id="toolbar">
                              <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="Refresh()">Refresh</a>
                              <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="Add()">Add</a>
                              <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="Edit()">Edit</a>
                              <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="Details()">View</a>
                              <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="Delete()">Delete</a>
                              <a id="btnActiveInActive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="ActiveInActive()">Active/In-Active</a>
                          </div>
                      </div>

<script type="text/javascript">
var _sBaseAddress="";
$(document).ready(function () {
    //debugger;
    var oTempBusinessSessions =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model)); 
    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));  
    var oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));  
    var oBusinessSessions =sessionStorage.getItem("BusinessSessions");
    if(oBusinessSessions!=null)
    {
        oBusinessSessions = jQuery.parseJSON(oBusinessSessions);
    }
    else
    {
        oBusinessSessions=oTempBusinessSessions;
    }
    RefreshList(oBusinessSessions);
    RefreshControlLayout(oAuthorizationRolesMapping);
});

function Refresh()
{    
    var oBusinessSessions = $('#tblBusinessSessions').datagrid('getRows'); 
    data=oBusinessSessions;
    data={"total":""+data.length+"","rows":data};
    $('#tblBusinessSessions').datagrid('loadData',data);    
    var nID =parseInt(sessionStorage.getItem("SelectedRowIndex"));
    if(nID!=-1)
    {
        $('#tblBusinessSessions').datagrid('selectRow', nID);
    }
}   

function Add()
{
    //debugger;
    var oBusinessSessions= $('#tblBusinessSessions').datagrid('getRows');
    sessionStorage.setItem("BusinessSessions", JSON.stringify(oBusinessSessions));
    sessionStorage.setItem("SelectedRowIndex", -1);
    sessionStorage.setItem("BusinessSessionHeader", "Add Business Session");
    sessionStorage.setItem("BackLink", window.location.href);
    window.location.href = _sBaseAddress+ "/BusinessSession/ViewBusinessSession?id=0";

} 



function Edit()
{
    //debugger;
    var oBusinessSession= $('#tblBusinessSessions').datagrid('getSelected'); 
    if(oBusinessSession==null || oBusinessSession.BusinessSessionID<=0)
    {
        alert("Please select a item from list!");
        return;
    }
    var SelectedRowIndex=$('#tblBusinessSessions').datagrid('getRowIndex',oBusinessSession);
    var oBusinessSessions= $('#tblBusinessSessions').datagrid('getRows');
    sessionStorage.setItem("BusinessSessions", JSON.stringify(oBusinessSessions));
    sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
    sessionStorage.setItem("BusinessSessionHeader", "Edit Business Session");
    sessionStorage.setItem("BackLink", window.location.href);
    window.location.href = _sBaseAddress+ "/BusinessSession/ViewBusinessSession?id="+oBusinessSession.BusinessSessionID;

} 


function Details()
{
//debugger;
    var oBusinessSession= $('#tblBusinessSessions').datagrid('getSelected'); 
    if(oBusinessSession==null || oBusinessSession.BusinessSessionID<=0)
    {
        alert("Please select a item from list!");
        return;
    }

    var oBusinessSessions= $('#tblBusinessSessions').datagrid('getRows');
    sessionStorage.setItem("BusinessSessions", JSON.stringify(oBusinessSessions));
    sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
    sessionStorage.setItem("BusinessSessionHeader", "View Business Session");
    sessionStorage.setItem("BackLink", window.location.href);
    window.location.href = _sBaseAddress+ "/BusinessSession/ViewBusinessSession?id="+oBusinessSession.BusinessSessionID;          
} 

function Delete()
{
    //debugger;  
    var oBusinessSession= $('#tblBusinessSessions').datagrid('getSelected');
    if(oBusinessSession==null || oBusinessSession.BusinessSessionID<=0)
    {
        alert("Please select a item from list!");
        return;
    }
    if (!confirm("Confirm to Delete?")) return ;       
       
    var SelectedRowIndex=$('#tblBusinessSessions').datagrid('getRowIndex',oBusinessSession);

    if (oBusinessSession.BusinessSessionID > 0) 
    {
        var tsv=((new Date()).getTime())/1000;
        $.ajax
        ({
            type: "GET",
            dataType: "json",                
            url : _sBaseAddress+  "/BusinessSession/Delete",
            data: { id: oBusinessSession.BusinessSessionID, ts:tsv},
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                feedbackmessage = jQuery.parseJSON(data);
                if (feedbackmessage == "Data delete successfully") 
                {
                    alert("Delete sucessfully");                        
                    $('#tblBusinessSessions').datagrid('deleteRow',SelectedRowIndex);
                          
                }
                else
                {
                    alert(feedbackmessage);
                }
            },
            error: function (xhr, status, error) 
            {
                alert(error);
            }
                      
        });
    }
}


function ActiveInActive()
{
    //debugger;  
    var oBusinessSession= $('#tblBusinessSessions').datagrid('getSelected');
    if(oBusinessSession==null || oBusinessSession.BusinessSessionID<=0)
    {
        alert("Please select a item from list!");
        return;
    }
    if(oBusinessSession.IsActive==true)
    {
        if (!confirm("Confirm to In-Active?")) return ;
        oBusinessSession.IsActive=false;
    }
    else
    {
        if (!confirm("Confirm to Active?")) return ;
        oBusinessSession.IsActive=true;
    }
    var SelectedRowIndex=$('#tblBusinessSessions').datagrid('getRowIndex',oBusinessSession);
    if (oBusinessSession.BusinessSessionID > 0) 
    {
            $.ajax({
            type: "POST",
            dataType: "json",            
            url : _sBaseAddress+  "/BusinessSession/Save",
            traditional: true,
            data:  JSON.stringify(oBusinessSession),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oBusinessSession = jQuery.parseJSON(data);
                if (oBusinessSession.BusinessSessionID>0) {                    
                    alert("Update sucessfully");
                    $('#tblBusinessSessions').datagrid('updateRow',{index: SelectedRowIndex,	row: oBusinessSession});
                }
                else {
                    alert(oBusinessSession.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
}

    
function RefreshList(oBusinessSessions)
{    
    data=oBusinessSessions;
    data={"total":""+data.length+"","rows":data};
    $('#tblBusinessSessions').datagrid('loadData',data);
    var nID =parseInt(sessionStorage.getItem("SelectedRowIndex"));
    if(nID!=-1)
    {
        $('#tblBusinessSessions').datagrid('selectRow', nID);
    }
}





function RefreshControlLayout()
{
    document.getElementById('btnAdd').style.display = 'none'; 
    document.getElementById('btnEdit').style.display = 'none'; 
    document.getElementById('btnView').style.display = 'none'; 
    document.getElementById('btnDelete').style.display = 'none'; 
    document.getElementById('btnActiveInActive').style.display = 'none'; 

    if(HavePermission('Add','BusinessSession')){document.getElementById('btnAdd').style.display = '';}
    if(HavePermission('Edit','BusinessSession')){document.getElementById('btnEdit').style.display = '';}
    if(HavePermission('View','BusinessSession')){document.getElementById('btnView').style.display = '';}
    if(HavePermission('Delete','BusinessSession')){document.getElementById('btnDelete').style.display = '';}
    if(HavePermission('ActiveInActive','BusinessSession')){document.getElementById('btnActiveInActive').style.display = '';}
}

function HavePermission(sOperationType, sDbObject)
{
    var nSessionID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.currentUserID]));
    if(nSessionID == -9) //check SuperUser 
    {
        return true;
    }else
    {
        
        for(var i =0;i<_oAuthorizationRolesMapping.length;i++)
        {
            if(_oAuthorizationRolesMapping[i].OperationTypeInString == sOperationType && _oAuthorizationRolesMapping[i].DBObjectName == sDbObject)
            return  true;
        }
        return false;
     }
}
</script>