@{
    ViewBag.Title = "RouteSheet Dye Chemical Out";
}

@model IEnumerable<ESimSol.BusinessObjects.RouteSheet>

    <head>
        <title>Route Sheet</title>
    </head>

    <body>
        <div class="menuMainCollectionTable">
            <table id="tblRouteSheet" title="Route Sheet List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbarRouteSheet">
                <thead>
                    <tr>
                        <th field="RSSateDateStr" width="10%">Yarn Out Date</th>
                        <th field="RouteSheetNo" width="10%">RouteSheet No</th>
                        <th field="RSStateStr" width="10%">Status</th>
                        <th field="MachineName" width="12%">Machine</th>
                        <th field="ProductName" width="15%">Product Name</th>
                        <th field="Qty" width="10%" formatter="formatPrice" align="right">Qty</th>
                        <th field="PrepareByName" width="14%">Prepared By</th>
                        <th field="ApproveByName" width="14%">Approved</th>
                    </tr>
                </thead>

            </table>

            <div id="toolbarRouteSheet">
                <input type="text" id="txtRouteSheetNo" placeholder="Search By Batch No " style="width:12%;" />
                <input id="chkDate" type="checkbox" />
                <input id="dtFrom" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input id="dtTo" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnAddTwo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">All at one</a>

            </div>
        </div>

        <div id="winRouteSheetDetail" class="easyui-window winstyle" title="Dyeing Solution" style="width:900px; height:600px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 98%; font-family: Tahoma;">

                <table class="tbl-Win">
                    <tr>
                        <td>
                            <table id="tblTreeGridProcess" class="easyui-treegrid" style="width:100%; height:500px;"
                                   data-options="idField:'RouteSheetDetailID',treeField:'ProcessName', rownumbers:'true', toolbar:'#toolbarTemplet'">
                                <thead>
                                    <tr>    
                                        <th data-options="field:'ProcessName',width:220">Name</th>
                                        <th data-options="field:'GL',width:100, align:'center'">GL</th>
                                        <th data-options="field:'Percentage',width:80, align:'center'">(%)</th>
                                        <th data-options="field:'TempTime',width:100, align:'center'">Temp & Time</th>
                                        <th data-options="field:'TotalQtyStr',width:120, align:'center'">Qty (Kg)</th>
                                        <th data-options="field:'TotalQtyLotNo',width:70, align:'center'">Lot No</th>
                                        <th data-options="field:'AddOneQtyStr',width:120, align:'center'">Add. One Qty (Kg)</th>
                                        <th data-options="field:'AddOneLotNo',width:120, align:'center'">Add. One Lot</th>
                                        <th data-options="field:'AddTwoQtyStr',width:120, align:'center'">Add. Two (Kg)</th>
                                        <th data-options="field:'AddTwoLotNo',width:120, align:'center'">Add. Two Lot</th>
                                        <th data-options="field:'AddThreeQtyStr',width:120, align:'center'">Add. Three Qty (Kg)</th>
                                        <th data-options="field:'AddThreeLotNo',width:120, align:'center'">Add. Three Lot</th>
                                        <th data-options="field:'ReturnQtyStr',width:120, align:'center'">Return Qty (Kg)</th>
                                        <th data-options="field:'ReturnLotNo',width:120, align:'center'">Return Lot</th>
                                        <th data-options="field:'GTotalInString',width:120, align:'center'">G. Total Qty (Kg)</th>
                                      
                                        
                                     </tr>
                                </thead>
                            </table>
                            <div id="toolbarTemplet">
                                <select id="cboStore" style="width:30%;"></select>
                                <input type="text" id="txtLot" placeholder="Search Lot" style="width:20%" />
                                <a id="btnPickLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                <a id="btnAdditional" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"><label id="lblAdditional">Add. One</label></a>
                                <a id="btnReturn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Return</a>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right; padding-top:10px; padding-bottom:10px;">
                            <a id="btnCloseRouteSheetDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div id="winRouteSheetDetail_DCOut" class="easyui-window winstyle" title="Dyeing Solution" style="width:950px; height:580px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div >
                <fieldset>
                    <table style="width:99%;height:430px;" id="tblRouteSheetDetail" class="easyui-datagrid" toolbar="#toolbarLot">
                        <thead>
                            <tr>
                                <th data-options="field:'ProcessName',width:150">Name</th>
                                <th data-options="field:'GL',width:80, align:'center'">GL</th>
                                <th data-options="field:'Percentage',width:70, align:'center'">(%)</th>
                                <th data-options="field:'TotalQtyStr',width:120, align:'center'">Qty (Kg)</th>
                                <th field="TotalQtyLotNo" width="130" align="left" styler="cellStylerTLot">Lot No</th>  
                                <th field="Balance" width="100" align="left" styler="cellStyleBal">C.Balance</th>  
                                <th data-options="field:'AddOneQtyStr',width:120, align:'center'">Add. One Qty (Kg)</th>
                                <th field="AddOneLotNo" width="40" align="left" styler="cellStylerLot1">Add. One Lot</th>  
                                <th data-options="field:'AddTwoQtyStr',width:120, align:'center'">Add. Two (Kg)</th>
                                <th field="AddTwoLotNo" width="80" align="left" styler="cellStylerLot2">Add. Two Lot</th>  
                                <th data-options="field:'AddThreeQtyStr',width:120, align:'center'">Add. Three Qty (Kg)</th>
                                <th field="AddThreeLotNo" width="80" align="left" styler="cellStylerLot3">Add. Three Lot</th>  
                                <th data-options="field:'ReturnQtyStr',width:120, align:'center'">Return Qty (Kg)</th>
                                <th data-options="field:'ReturnLotNo',width:120, align:'center'">Return Lot</th>
                                <th data-options="field:'GTotalInString',width:120, align:'center'">G. Total Qty (Kg)</th>
                                <th data-options="field:'Sequence',width:60, align:'center'">SL</th>

                            </tr>
                        </thead>
                    </table>
                </fieldset>
               
            </div>
             
            <div>
                <fieldset>
                    <legend style="font-weight: bold">Action : </legend>
                    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                        <tr>
                            <td style="width:40%; text-align:right"></td>
                            <td style="width: 60%; text-align:right">
                                <select style="width:100px;" id="cboOutState">
                                    <option value="0">-General-</option>
                                    <option value="1">First(Addition)</option>
                                    <option value="2">Second(Addition)</option>
                                    <option value="3">Third(Addition)</option>
                                    <option value="4">Return</option>
                                </select>
                                <a id="btnCommit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"><label id="lblCommit">Dyes & Chemical Out</label></a>
                                <a id="btnClose_Detail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
        </div>

    </body>

    <style type="text/css">
        .tbl-Win {
            width: 100%;
        }

        .td-styler input, select {
            padding-left: 5px;
        }

        .txt-styler {
            width: 95%;
        }

        .txt-styler-picker {
            width: 65%;
        }

        .cbo-styler {
            width: 98%;
        }

        .txt-styler-Note {
            width: 97.5%;
        }
    </style>



    <script type="text/javascript">
    var _sBaseAddress = "";
    var _oRouteSheets = [];
    var _oRouteSheet = null;
    var _nLotID=0;

    $(document).ready(function () {
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheets =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oWorkingUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        var oEmployees =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Employees));
        $('.number').icsCurrencyBox();
        DynamicRefreshList(_oRouteSheets, 'tblRouteSheet');

        $('#dtFrom,#dtTo').datebox({'disabled':true});
        $('#dtFrom,#dtTo').datebox('setValue', icsdateformat(new Date()));


        $("#cboStore").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:""
        });

        $("#cboBatchman").icsLoadCombo({
            List: oEmployees,
            OptionValue: "EmployeeID",
            DisplayText: "Name",
            InitialValue:""
        });
    });

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


        
    $('#tblRouteSheet').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData) {
        if (rowData != null && rowData.RouteSheetID > 0 && rowData.RSState>=18) {
            $("#btnAdd").hide();
        }
        else{
            $("#btnAdd").show();
        }
    }



    $('#chkDate').change(function(e){
        debugger;
        if($('#chkDate').is(':checked')){
            $('#dtFrom,#dtTo').datebox({'disabled':false});
        }
        else{
            $('#dtFrom,#dtTo').datebox({'disabled':true});
        }
        $('#dtFrom,#dtTo').datebox('setValue', icsdateformat(new Date()));
    });


    /*.......... Searching ............. */


    $("#txtRouteSheetNo").keyup(function (e) {
        var oRouteSheets =[];
        var keyCode = e.keyCode || e.which;
        $('#txtRouteSheetNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if (!$.trim($("#txtRouteSheetNo").val()).length) {

                alert("Please enter routesheet no to search.");
                $('#txtRouteSheetNo').focus();
                $('#txtRouteSheetNo').val("");
                return;
            }
            else { $('#txtRouteSheetNo').removeClass("errorFieldBorder"); }

            var oRouteSheet={
                Params:   $.trim($("#txtRouteSheetNo").val())+'~'+ $('#chkDate').is(':checked')+ '~'+ $('#dtFrom').datebox('getValue')+'~'+ $('#dtTo').datebox('getValue')
            };
            GetsRouteSheet(oRouteSheet,false);
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oRouteSheets.length;++i)
            {
                sTempName=oRouteSheets[i]['RouteSheetNo'];
                if(sTempName.toUpperCase().indexOf($('#txtRouteSheetNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oRouteSheets[i]);
                }
            }
            $('#tblRouteSheet').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oRouteSheets, "tblRouteSheet");}
            else { DynamicRefreshList(oSearchedData, "tblRouteSheet"); }

        }
    });

    $('#btnSearch').click(function(e){

        if($.trim($("#txtRouteSheetNo").val())=="" && !$('#chkDate').is(':checked')){
            alert("No searching criteria found to search."); return false;
        }
        var oRouteSheet={
            Params:   $.trim($("#txtRouteSheetNo").val())+'~'+ $('#chkDate').is(':checked')+ '~'+ $('#dtFrom').datebox('getValue')+'~'+ $('#dtTo').datebox('getValue')+'~'+ '' +'~'+ '' + '~'+ '' +'~'+ ''

        };
        GetsRouteSheet(oRouteSheet, false) ;
    });

    function GetsRouteSheet(oRouteSheet, bIsAdvSearch) {

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsDyeChemicalOut",
            IsWinClose: bIsAdvSearch
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs != null) {
                if (response.objs.length > 0) {
                    if(response.objs[0].RouteSheetID>0){
                        _oRouteSheets=response.objs;
                        DynamicRefreshList(response.objs, "tblRouteSheet");
                    }
                    else{DynamicRefreshList([], "tblRouteSheet"); alert(response.objs[0].ErrorMessage);}
                }
                else { DynamicRefreshList([], "tblRouteSheet"); alert("No RouteSheet found."); }
            }
        });
    }


    /*-------------Dyes Chemical Out Window---------*/
    $('#tblTreeGridProcess').treegrid({ onSelect: function (rowData) { OperationPerformTreeGrid(rowData); } });

    function OperationPerformTreeGrid(rowData) {
        debugger;
        ResetDyeChemicalOut();
        if (rowData != null && rowData.RouteSheetDetailID > 0 && rowData.IsDyesChemical) {
            $("#btnAdditional").show();
            if(rowData.WUID>0)
            {  $("#cboStore").val(rowData.WUID);}

            if(rowData.TotalQtyLotID<=0)
                $('#lblAdditional').text("Initial Out");
            else if(rowData.AddOneLotID<=0 && rowData.AddOneQty>0)
                $('#lblAdditional').text("Add. One Out");
            else if(rowData.AddTwoLotID<=0 && rowData.AddTwoQty>0)
                $('#lblAdditional').text("Add. Two Out");
            else if(rowData.AddThreeLotID<=0 && rowData.AddThreeQty>0)
                $('#lblAdditional').text("Add. Three Out");
            else 
                $("#btnAdditional").hide();

            if(rowData.TotalQtyLotID>0 && rowData.ReturnQty>0 && rowData.ReturnLotID<=0)
                $("#btnReturn").show();
            else
                $("#btnReturn").hide();
        }
        else{
            $("#btnAdditional,#btnReturn").hide();
        }
    }

        

    function LoadTreeGrid(oTree){
        var data= oTree;
        data={"total":""+data.length+"","rows":data};
        $('#tblTreeGridProcess').treegrid('loadData',data);
    }
   
    function ResetDyeChemicalOut(){
        $('#cboStore').val(0);
        $('#txtLot').val("");
        $('#cboStore,#txtLot').removeClass("errorFieldBorder");
        _nLotID=0;
    }

    $("#btnAdd").click(function (e) {
        ResetDyeChemicalOut();
        LoadTreeGrid([]);
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetRSDetailTree",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj !=null && response.obj.RouteSheetID>0) {
                $("#winRouteSheetDetail").icsWindow("open", "Dyes Chemical Out For: "+oRouteSheet.RouteSheetNo);
                LoadTreeGrid([response.obj]);
            }
            else{
                alert((response.obj.ErrorMessage!=null && response.obj.ErrorMessage!="")? response.obj.ErrorMessage : "No dyeing solution found for this routesheet.");
            }
        });

        
    });

    $("#btnAddTwo").click(function (e) {
       
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetRouteSheetDetails",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
           
                $("#winRouteSheetDetail_DCOut").icsWindow("open", "Dyes Chemical Out For: "+oRouteSheet.RouteSheetNo);
                DynamicRefreshList(response.objs, 'tblRouteSheetDetail');
            }
            else{
                alert("No dyeing solution found for this routesheet.");
            }
        });

        
    });
 
        
    $("#btnCloseRouteSheetDetail").click(function (e) {
        $("#winRouteSheetDetail").icsWindow("close");
    });
    $("#btnClose_Detail").click(function (e) {
        $("#winRouteSheetDetail_DCOut").icsWindow("close");
    });

    



    /*----------Lot Pick & Dyes Chemical Out----------------*/

    function ValidationLotPick(){
        var oRouteSheetDetail= $('#tblTreeGridProcess').datagrid('getSelected');
        if (oRouteSheetDetail == null || oRouteSheetDetail.RouteSheetDetailID <= 0) { alert("Please select an item from list."); return false; }
        if (!oRouteSheetDetail.IsDyesChemical) { alert("Please select Dyes or chemical."); return false; }
        
        if($('#cboStore').val()<=0){
            $('#cboStore').focus();
            $('#cboStore').addClass("errorFieldBorder");
            alert('Select Store.');
            return false;
        }
        else{
            $('#cboStore').removeClass("errorFieldBorder");
        }
        return true;
    }

    $("#btnResetLot").click(function () {
        _nLotID=0;
        $('#txtLot').val("");
    });

    $("#btnPickLot").click(function () {
        if(!ValidationLotPick()) return;
        var sLotNo=$.trim($("#txtLot").val());
        //if(sLotNo==""){ alert("Type lot no to search."); return false; }
        GetLots(sLotNo);
    });

    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(!ValidationLotPick()) return;
            var sLotNo=$.trim($("#txtLot").val());
            //if(sLotNo==""){ alert("Type lot no to search."); return false; }
            GetLots(sLotNo);
        }
        else if(nkeyCode==8){
            _nLotID=0;
            $('#txtLot').val("");
        }
    });

    function GetLots(sLotNo){

        //var oLot = {
        //    ProductID:$('#tblTreeGridProcess').datagrid('getSelected').ProcessID,
        //    LotNo:sLotNo,
        //    WorkingUnitID: $('#cboStore').val()
        //};
        //var obj = {
        //    BaseAddress: _sBaseAddress,
        //    Object: oLot,
        //    ControllerName: "Lot",
        //    ActionName: "GetsLot",
        //    IsWinClose: false
        //};
        debugger;
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
      
        var sParam="";
        sParam=0+"~"+0+'~'+4;
        var oRouteSheet = {
            RouteSheetID: (oRouteSheet!=null && oRouteSheet.RouteSheetID>0)? oRouteSheet.RouteSheetID:0,
            ProductID_Raw:$('#tblTreeGridProcess').datagrid('getSelected').ProcessID,
            LotNo:sLotNo,
            Params:sParam,
            WorkingUnitID: $('#cboStore').val()
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "GetsLotForRSDC",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "Lot No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Balance", title: "Qty", width: 80, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Origin", title: "Origin", width:100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 70, align: "left"};tblColums.push(oColumn);
                    oColumn = { field: "LotStatusSt", title: "Running", width:30, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "WorkingUnitName", title: "Store", width: 180, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 180, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeLotPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No lot found.");
            }
        });


    }

    function IntializeLotPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            LotSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                LotSelect(oPickerobj);
            }
        });
    }

    function LotSelect(oPickerobj){
        var oLot = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winLotPicker')
        {
            if(oLot !=null  && oLot.LotID>0){

                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtLot').val(oLot.LotNo);
                _nLotID=oLot.LotID;

            }
            else{
                alert("Please select lot.");
            }
        }
    }

    function AdditionReturn(bIsReturn){
        
        if(_nLotID<=0)
        {
            $('#txtLot').focus();
            $('#txtLot').addClass("errorFieldBorder");
            alert('Lot required.');
            return false;
        }
        else{
            $('#txtLot').removeClass("errorFieldBorder");
        }
        debugger;
        var oRSDetail=$('#tblTreeGridProcess').datagrid('getSelected');
        var oRSD={
            RouteSheetDetailID : oRSDetail.RouteSheetDetailID, 
            RouteSheetID : oRSDetail.RouteSheetID, 
            ProcessID : oRSDetail.ProcessID,
            TotalQtyLotID : oRSDetail.TotalQtyLotID,
            AddOneLotID : oRSDetail.AddOneLotID,
            AddTwoLotID : oRSDetail.AddTwoLotID,
            AddThreeLotID : oRSDetail.AddThreeLotID,
            ReturnLotID : oRSDetail.ReturnLotID,
            children: oRSDetail.children,
        };

        if(bIsReturn){
            if(oRSD.TotalQtyLotID<=0){
                alert("Initial dyes chemical quantity yet not out.");
                return false;
            }
            oRSD.ReturnLotID=_nLotID;
        }
        else{
            if(oRSD.TotalQtyLotID<=0){
                oRSD.TotalQtyLotID=_nLotID;
            }
            else if(oRSD.AddOneLotID<=0){
                oRSD.AddOneLotID=_nLotID;
            }
            else if(oRSD.AddTwoLotID<=0){
                oRSD.AddTwoLotID=_nLotID;
            }
            else if(oRSD.AddThreeLotID<=0){
                oRSD.AddThreeLotID=_nLotID;
            }
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSD,
            ObjectId: 0,
            ControllerName: "RouteSheet",
            ActionName: "RouteSheetDyeChemicalOut",
            TableId: "",
            IsWinClose: false,
            Message: (bIsReturn)?"Return successfully.":"Out sucessfully."
        };
        $.icsSave(obj, function (response) {
            debugger;
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetDetailID > 0) {
                    if(oRSD.RouteSheetDetailID>0){
                        response.obj.children=oRSD.children;
                        $('#tblTreeGridProcess').treegrid('update',{ id: oRSD.RouteSheetDetailID, row: response.obj });
                        OperationPerformTreeGrid(response.obj);
                    }
                }
            }
        });
    }

    $('#btnAdditional').click(function(e){

        AdditionReturn(false);
    });
        
    $('#btnReturn').click(function(e){
       
        AdditionReturn(true);
    });
    
    function cellStyleBal(value,row,index)
    {
        if (row.TotalQtyLotID<=0 && row.AddOneLotID<=0 && row.TotalQty>0)
        {
            if (row.Balance<row.TotalQty)
            {
                return 'background-color:#FFFF00;color:#FC0D0D;';
            }
        }

        if (row.TotalQtyLotID>0 && row.AddOneLotID<=0 && row.AddOneQty>0)
        {
            if (row.Balance<row.AddOneQty)
            {
                return 'background-color:#FFFF00;color:#FC0D0D;';
            }
        }
        if (row.TotalQtyLotID>0 && row.AddOneLotID>0&& row.AddTwoLotID<=0  && row.AddTwoQty>0 && row.SuggestLotNo !="")
        {
            if (row.Balance<row.AddTwoQty)
            {
                return 'background-color:#FFFF00;color:#FC0D0D;';
            }
        }
        if (row.TotalQtyLotID>0 && row.AddOneLotID>0 && row.AddTwoLotID>0 && row.AddThreeLotID<=0 && row.AddThreeQty>0 && row.SuggestLotNo !="")
        {
            if (row.Balance<row.AddThreeQty)
            {
                return 'background-color:#FFFF00;color:#FC0D0D;';
            }
        }
    }
    function cellStylerLot1(value,row,index)
    {
       
        if (row.TotalQtyLotID>0 && row.AddOneLotID<=0 && row.AddOneQty>0 && row.SuggestLotNo !="")
        {
            return 'background-color:#FFFF00;color:#FC0D0D;';
        }
    }
    function cellStylerLot2(value,row,index)
    {
        if (row.TotalQtyLotID>0 && row.AddOneLotID>0&& row.AddTwoLotID<=0  && row.AddTwoQty>0 && row.SuggestLotNo !="")
        {
            return 'background-color:#FFFF00;';
        }
    }
    function cellStylerLot3(value,row,index)
    {
        if (row.TotalQtyLotID>0 && row.AddOneLotID>0 && row.AddTwoLotID>0 && row.AddThreeLotID<=0 && row.AddThreeQty>0 && row.SuggestLotNo !="")
        {
            return 'background-color:#FFFF00;';
        }
    }
    function cellStylerTLot(value,row,index)
    {
        if (row.TotalQtyLotID<=0 && row.SuggestLotNo !="")
        {
            return 'background-color:#FFFF00;color:#FC0D0D;';
        }
    }

    $('#btnCommit').click(function(e){
        debugger;
        var oRSDetails = $('#tblRouteSheetDetail').datagrid('getRows');
        var oRSDetails_Temp=[];
        if(oRSDetails.length<=0)
        {
            alert("Please checked at least one item.");
            return;
        }
        if (!confirm("Confirm to Out?")) return false;
    
        var nSelectedIndex=0;
        var indexLists=[];
        for (i = 0; i < oRSDetails.length; ++i)
        {
            oRSDetails[i].OutState=parseInt($("#cboOutState").val());

            if( oRSDetails[i].SuggestLotID>0)
            {
                if(oRSDetails[i].TotalQtyLotID<=0)
                {
                    oRSDetails[i].TotalQtyLotID=oRSDetails[i].SuggestLotID;
                }
                else if(oRSDetails[i].AddOneLotID<=0){

                    oRSDetails[i].AddOneLotID=oRSDetails[i].SuggestLotID;
                }
                else if(oRSDetails[i].AddTwoLotID<=0){
                    oRSDetails[i].AddTwoLotID=oRSDetails[i].SuggestLotID;
                }
                else if(oRSDetails[i].AddThreeLotID<=0){
                    oRSDetails[i].AddThreeLotID=oRSDetails[i].SuggestLotID;
                }
                nSelectedIndex = $('#tblRouteSheetDetail').datagrid('getRowIndex', oRSDetails[i]);
                indexLists.push(nSelectedIndex);
                oRSDetails_Temp.push(oRSDetails[i]);
            }
        }
        if(oRSDetails_Temp.length<=0)
        {
            alert("Lot Not Found")
            return;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/RouteSheet/RouteSheetDyeChemicalOutAll",
            traditional: true,
            data:  JSON.stringify(oRSDetails_Temp),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oRSDetails =jQuery.parseJSON(data);
                    
                if (oRSDetails[0].ErrorMessage == '' || oRSDetails[0].ErrorMessage == null)
                {
                    for (i = 0; i < oRSDetails.length; ++i)
                    {
                        $('#tblRouteSheetDetail').datagrid('updateRow', { index:  indexLists[i], row: oRSDetails[i] });
                        $('#tblRouteSheetDetail').datagrid('selectRow', indexLists[i]);
                    }
                    alert("Data save Successfully");
                  
                }
                else
                {
                    alert(oRSDetails[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });

    </script>
