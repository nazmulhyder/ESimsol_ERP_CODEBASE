@{
    ViewBag.Title = "FN Batch";
}
@{var MenuID = HttpContext.Current.Session[SessionInfo.MenuID];}
@model ESimSol.BusinessObjects.FNBatch
<html>
<body>
    <div class="menuMainCollectionTable">
        <div class="easyui-panel" title="Fabric Batch" style="font-family:Tahoma;text-align:center; width:100%;height:100%;">
            <fieldset>
                <legend>FN Batch Info</legend>
                <table border="0" cellpadding="1" cellspacing="1">
                    @*<tr>
                        <td style="width:190px; text-align:right;"></td>
                        <td style="width:250px;text-align:left;"></td>
                        <td style="width:20px"></td>
                        <td style="width:190px; text-align:right;">Batch No:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.BatchNo, new { style = "width:250px;", id = "txtBatchNo", disabled = "disabled" })
                        </td>
                    </tr>*@
                    <tr>
                        <td style="width:190px; text-align:right;">Dispo No :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.FNExONo, new { style = "width:85%;", id = "txtFNExONo", placeholder = "Type Dispo No & Enter" })
                            <a id="btnSearchOrderNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                        </td> 
                        <td style="width:20px"></td>

                        @*<td style="width:190px; text-align:right;">GSM:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.GSM, new { style = "width:80px;", id = "txtGSM", placeholder = "", disabled = "disabled", @class="reset-fnexe"})
                           <span style="padding-right:15px">GLM: </span>
                            @Html.TextBoxFor(model => model.GLM, new { style = "width:114px;", id = "txtGLM", placeholder = "", @class = "number reset-text" })
                          </td>*@
                        <td style="width:190px; text-align:right;">Batch No:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.BatchNo, new { style = "width:250px;", id = "txtBatchNo", disabled = "disabled" })
                        </td>
                    </tr>

                    <tr>
                        <td style="width:190px; text-align:right;">Dispo Qty:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.ExeQty, new { style = "width:90px;  text-align:right", id = "txtExecutionOrderQtyYard", disabled = "disabled", @class = "reset-fnexe" })&nbsp;<label>(Y)</label>
                            &nbsp;&nbsp;<input type="text" id="txtExecutionOrderQtyInMeter" style="width:90px;  text-align:right" class="reset-fnexe" disabled />&nbsp;(M)
                        </td> 
                        <td style="width:20px"></td>

                        <td style="width:190px; text-align:right;">Fabric Weave:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.FabricWeaveName, new { style = "width:250px;", id = "txtFabricWeaveName", placeholder = "", disabled = "disabled", @class = "reset-fnexe" })
                        </td>

                    </tr> 
                    <tr>
                        <td style="width:190px; text-align:right;">Batch Qty :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.Qty, new { style = "width:90px;", id = "txtQtyYard", @class = "number reset-text" })&nbsp;<label>(Y)</label>
                            &nbsp;&nbsp;<input type="text" id="txtQtyMeter" style="width:90px;" class="number reset-text" />&nbsp;(M)
                        </td>
                        <td style="width:20px"></td>
                        <td style="width:190px; text-align:right;">Count:</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.CountName, new { style = "width:250px;", id = "txtCountName", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                    </tr>

                    <tr>
                        <td style="width:190px; text-align:right;">Customer :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.BuyerName, new { style = "width:250px;", id = "txtBuyerName", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                        <td style="width:20px"></td>
                        <td style="width:190px; text-align:right;">EPI*PPI :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.Construction, new { style = "width:250px;", id = "txtConstruction", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                    </tr>

                    <tr>
                        <td style="width:190px; text-align:right;">Issue Date :</td>
                        <td style="width:250px;text-align:left;">
                            <input id="dtIssue" style="width:100%" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:20px"></td>
                        @*<td style="width:190px; text-align:right;">Grey Width :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.GreyWidth, new { style = "width:250px;", id = "txtGreyWidth", disabled = "disabled", @class = "reset-fnexe" })
                        </td>*@
                        <td style="width:190px; text-align:right;">Finish Width :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.FinishWidth, new { style = "width:250px;", id = "txtFinishWidth", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                    </tr>
                    @*<tr>
                        <td style="width:190px; text-align:right;">Exp. Delivery :</td>
                        <td style="width:250px;text-align:left;">
                            <input id="dtDelivery" style="width:100%" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                        <td style="width:20px"></td>
                        <td style="width:190px; text-align:right;">Finish Width :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.FinishWidth, new { style = "width:250px;", id = "txtFinishWidth", disabled = "disabled", @class = "reset-fnexe" })
                        </td>*
                    </tr>*@

                    <tr>
                        <td style="width:190px; text-align:right;">Finish Type :</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.FinishTypeName, new { style = "width:245px;", id = "txtFinishTypeName", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                        <td style="width:20px"></td>
                        @*<td style="width:190px; text-align:right;">Grey GSM</td>
                        <td style="width:250px;text-align:left;">
                            @Html.TextBoxFor(model => model.GreyGSM, new { style = "width:250px;",  id = "txtGreyGSM", @class = "number reset-text" })
                        </td>*@
                        <td style="width:190px; text-align:right;"></td>
        <td style="width:250px;text-align:left;">
            
        </td>
                    </tr>
                </table>
            </fieldset>
            <hr />
            <div>
                <div style="width:50%; float:left;">
                    <fieldset>
                        <table id="tblFNBatch" title="Related FN Batch By FN Execution" class="easyui-datagrid" style="width:490px;height:170px"
                               data-options="singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false,toolbar: '#toolbar'">
                            <thead>
                                <tr>
                                    <th field="BatchNo" width="15%">BatchNo</th>
                                    <th field="IssueDateStr" width="20%">Issue Date</th>
                                    <th field="ExpectedDeliveryDateStr" width="20%">Delivery Date</th>
                                    <th field="Qty" width="15%" align="right" formatter="formatPrice">Issue Qty</th>
                                    <th field="OutQty" width="15%" align="right" formatter="formatPrice">Out Qty</th>
                                </tr>
                            </thead>
                        </table>
                        <div style="width:100%">
                            <div style="float:left; width:57%; text-align:right;">
                                <label>Total</label>
                            </div>
                            <div style="float:left; width:14%; text-align:right;">
                                <label id="lblTotalBatchQty"></label>
                            </div>
                            <div style="float:left; width:26%; text-align:left;">
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div style="width:50%; float:left;">
                    <fieldset>
                        <table id="tblFNBatchRecive" title="Receive By FN Execution" class="easyui-datagrid" style="width:490px;height:170px"
                               data-options="singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false,toolbar: '#toolbar'">
                            <thead>
                                <tr>
                                    <th field="ProductNameCode" width="47%">Product</th>
                                    <th field="LotNo" width="15%">Lot No</th>
                                    <th field="Qty" width="15%" align="right" formatter="formatPrice">Qty(Y)</th>
                                    <th field="QtyInMeter" width="15%" align="right" formatter="formatPrice">Qty(M)</th>
                                    @*<th field="MUName" width="12%" align="left">Unit</th>*@                                    
                                </tr>
                            </thead>
                        </table>
                        <div style="width:100%">
                            <div style="float:left; width:62%; text-align:right;">
                                <label>Total</label>
                            </div>
                            <div style="float:left; width:15%; text-align:right;">
                                <label id="lblTotalReciveQtyYard"></label>
                            </div>
                            <div style="float:left; width:15%; text-align:right;">
                                <label id="lblTotalReciveQtyMtr"></label>
                            </div>
                            <div style="float:left; width:24%; text-align:left;">
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                

            </div>

            <fieldset>
                <legend style="font-weight:bold">Actions</legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:85%; text-align:right"></td>
                        <td style="width:10%;">
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="Save()">Save</a>
                        </td>
                        <td style="width:5%;">
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="Close()">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</body>
</html>


<script type="text/javascript">
    var _oFNBatch=null;
    var _sBaseAddress="";
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFNBatch =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oFNBatchs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNBatchs));
        //var oFNEOFRs=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNEOFRs));
        var oFNEOFRs=[];
        if(_oFNBatch.FNExOID<=0)
            ResetFNExe();

        if(sessionStorage.getItem("Operation") == 'View'){
            $('.reset-fnexe, .reset-text ').prop('disabled',true);
            $('#dtIssue').datebox({disabled:true});
            $('#btnSearchOrderNo,#btnSave').hide();
            $('#txtFNExONo').css({'width':'250px'})
        }

        $('.number').icsCurrencyBox();
        $('#dtIssue').datebox('setValue',_oFNBatch.IssueDateStr);
        //$('#dtDelivery').datebox('setValue',_oFNBatch.ExpectedDeliveryDateStr);
        $('#txtFNExONo').data('FNExOID',_oFNBatch.FNExOID);
        $('#txtGLM').data('GLM',_oFNBatch.GLM);
        $("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(_oFNBatch.ExeQty,2)));
        $('#txtQtyMeter').val(formatPrice(GetMeter(_oFNBatch.Qty,2)));
        //RelatedInfo(oFNBatchs, oFNEOFRs, true)
        

    });


    $("#txtQtyYard").keyup(function (e) {
        var nVal = icsRemoveComma($(this).val());
        $('#txtQtyMeter').val(GetMeter(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    $("#txtQtyMeter").keyup(function (e) {
        var nVal = icsRemoveComma($(this).val());
        $('#txtQtyYard').val(GetYard(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });


    function ResetFNExe(){
        $('.reset-fnexe').val("");
        $('#txtGLM').val($('#txtGLM').data('GLM'));
        $('#txtFNExONo').data('FNExOID',0);
        $('#txtQtyYard').data('YetToOutQty',0);
        $('#txtQtyYard,#txtQtyMeter').val('');
        DynamicRefreshList([],'tblFNBatch');
        DynamicRefreshList([],'tblFNBatchRecive');
        
        
    }


    $("#btnSearchOrderNo").click(function () {
        GetFNExeNo();
    });

    $('#txtFNExONo').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) {

            GetFNExeNo();

        }
        else if(code==27 || code==08){
            ResetFNExe();
        }
    });


    function GetFNExeNo(){

        if ($.trim($("#txtFNExONo").val()).length == 0) {
            alert("Type Dispo no to search.");
            $("#txtFNExONo").val().focus();
            return false;
        }

        var oFNEO = {
            ExeNo: $.trim($("#txtFNExONo").val())
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNEO,
            ControllerName: "FNBatch",
            ActionName: "GetsByFNExONo",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FabricSalesContractDetailID > 0) {
                    var tblColums = [];var oColumn = { field: "ExeNo", title: "Dispo No", width: 130, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Buyer", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FabricNo", title: "P No", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 100, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buying House", width: 150, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winFNExecutionOrder',
                        winclass:'clsFNExecutionOrder',
                        winwidth: 600,
                        winheight: 450,
                        tableid: 'tblFNExecutionOrders',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Production  Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found");
            }
        });
    }

    function IntializePickerbutton(oPickerobj)
    {

        $("#" + oPickerobj.winid).find("#btnOk").click(function () {

            ButtonEvents(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ButtonEvents(oPickerobj);
            }
        });
    }

    function ButtonEvents(oPickerobj)
    {
        var oreturnobj = $('#'+oPickerobj.tableid).datagrid('getSelected');
        $("#"+oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winclass == 'clsFNExecutionOrder')
        {
            if (oreturnobj != null && oreturnobj.FabricSalesContractDetailID > 0) {

                $('#txtQtyYard').val(formatPrice(oreturnobj.Qty-oreturnobj.Qty_PRO));
                $('#txtQtyMeter').val(formatPrice(GetMeter(oreturnobj.Qty-oreturnobj.Qty_PRO)));

                $('#txtQtyYard').data('YetToOutQty',oreturnobj.Qty-oreturnobj.Qty_PRO);
                $("#txtFNExONo").data('FNExOID',oreturnobj.FabricSalesContractDetailID);
                $("#txtFNExONo").val(oreturnobj.ExeNo);
                $("#txtFNExONo").addClass("fontColorOfPickItem");

                //$('#txtGSM').val(oreturnobj.ReqFinishedGSM);

                $("#txtExecutionOrderQtyYard").val(formatPrice(oreturnobj.Qty));
                $("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(oreturnobj.Qty,2)));

              

                $("#txtCountName").val(oreturnobj.ProductName);
                $('#txtBuyerName').val(oreturnobj.BuyerName);
                $('#txtConstruction').val(oreturnobj.Construction);
                //$('#txtGreyWidth').val(oreturnobj.GreyQty);
                $('#txtFinishWidth').val(oreturnobj.FinishWidth);
                $('#txtFinishTypeName').val(oreturnobj.FinishTypeName);
                //$('#dtDelivery').datebox('setValue',oreturnobj.ExpectedDeliveryDateInStr);
                //$('#txtGreyGSM').val(oreturnobj.GSM);
                $('#txtFabricWeaveName').val(oreturnobj.FabricWeaveName);
                

                /*---------- Get Existing FN Btch ----------------*/
                var oFNBatch = {
                    FNExOID: oreturnobj.FabricSalesContractDetailID
                }
                var obj = {
                    BaseAddress: _sBaseAddress,
                    Object: oFNBatch,
                    ControllerName: "FNBatch",
                    ActionName: "GetRelatedInfoByFNBatch",
                    IsWinClose: false
                };
                $.icsDataGet(obj, function (response) {
                    if (response.status && response.obj!=null) {
                        RelatedInfo(response.obj.FNBatchs, response.obj.FNEOFRs, false);
                    }
                });

            }
        }
    }


    function RelatedInfo(oFNBatchs, oFNEOFRs, bIsEdit){
        var nBatchQty=0, nReceiveQtyYard=0, nReceiveQtyMtr=0;
        debugger;
        for(var i=0;i<oFNBatchs.length;i++){
            nBatchQty+=parseFloat(oFNBatchs[i].Qty);
        }
        for(var i=0;i<oFNEOFRs.length;i++){
            nReceiveQtyYard+=parseFloat(oFNEOFRs[i].Qty);
            nReceiveQtyMtr+=parseFloat(oFNEOFRs[i].QtyInMeter);
        }
        $('#lblTotalBatchQty').text(formatPrice(nBatchQty));
        $('#lblTotalReciveQtyYard').text(formatPrice(nReceiveQtyYard));
        $('#lblTotalReciveQtyMtr').text(formatPrice(nReceiveQtyMtr));

        var nYetToOutQty= parseFloat(nReceiveQtyYard) - parseFloat(nBatchQty);

        $('#txtQtyYard').data('YetToOutQty',nYetToOutQty.toFixed(2));
        if(!bIsEdit){
            $('#txtQtyYard').val(formatPrice(nYetToOutQty));
            $('#txtQtyMeter').val(formatPrice(GetMeter(nYetToOutQty,2)));
        }
        DynamicRefreshList(oFNBatchs,'tblFNBatch');
        DynamicRefreshList(oFNEOFRs,'tblFNBatchRecive');
    }



    function ValidateInput()
    {
        if(parseInt($('#txtFNExONo').data('FNExOID'))<=0)
        {
            alert("Dispo No order required.!");
            $('#txtFNExONo').focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtQtyYard').val()))<=0)
        {
            alert("Issue qty required!");
            $('#txtQtyYard').focus();
            return false;
        }
        //if(parseFloat(icsRemoveComma($('#txtQtyYard').val()))>parseFloat($('#txtQtyYard').data('YetToOutQty')))
        //{
        //    alert("Batch qty must be less than "+ formatPrice(parseFloat($('#txtQtyYard').data('YetToOutQty'))));
        //    $('#txtQtyYard').focus();
        //    return false;
        //}

        
        //if(new Date($('#dtDelivery').datebox('getValue'))< new Date($('#dtIssue').datebox('getValue'))){
        //    alert("Expected delivey date must be later than issue date.");
        //    return false;
        //}


        return true;
    }


    function RefreshObject()
    {

        var oFNBatch= {
            FNBatchID : _oFNBatch.FNBatchID,
            FNExOID : parseInt($("#txtFNExONo").data('FNExOID')),
            Qty: icsRemoveComma($('#txtQtyYard').val()),
            FNBatchStatus : _oFNBatch.FNBatchStatus,
            GLM : 0,// icsRemoveComma($('#txtGLM').val()),
            FNPPID :_oFNBatch.FNPPID ,
            IssueDate : $('#dtIssue').datebox('getValue'),
            ExpectedDeliveryDate:$('#dtIssue').datebox('getValue')// $('#dtDelivery').datebox('getValue'),
            //GreyGSM : icsRemoveComma($('#txtGreyGSM').val())
        };
        return oFNBatch;
    }

    function Save()
    {
        debugger;
        if(!ValidateInput()) return;
        var oFNBatch=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNBatch/Save",
            traditional: true,
            data:  JSON.stringify(oFNBatch),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oResult = jQuery.parseJSON(data);
                if (oResult.FNBatchID>0 || oResult.ErrorMessage=="") {
                    alert("Data Saved sucessfully");
                    var oFNBatchs = sessionStorage.getItem("FNBatchs");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oFNBatchs != null) {
                        oFNBatchs = jQuery.parseJSON(oFNBatchs);
                    }
                    else {
                        oFNBatchs = [];
                    }
                    if (nIndex != -1) {
                        oFNBatchs[nIndex] = oResult;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oFNBatchs.length);
                        oFNBatchs.push(oResult);
                    }
                    sessionStorage.setItem("FNBatchs", JSON.stringify(oFNBatchs));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function Close()
    {
        window.location.href = sessionStorage.getItem("BackLink");
    }

    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });

</script>