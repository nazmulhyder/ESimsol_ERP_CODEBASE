<html>
    <head>
     <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
        <link href="@Url.Content("~/Content/CSS/icon.css")" rel="stylesheet" type="text/css" />
        <link href="@Url.Content("~/Content/CSS/easyui.css")" rel="stylesheet" type="text/css" />
        <link href="@Url.Content("~/Content/CSS/Pikerstyle.css")" rel="stylesheet" type="text/css" />

        <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
        <script src="@Url.Content("~/Scripts/jquery.ics.customize.js")" type="text/javascript"></script>
        <script src="@Url.Content("~/Scripts/jquery.easyui.min.js")" type="text/javascript"></script>

        <script src="@Url.Content("~/Scripts/jquery-ui.min.js")" type="text/javascript"></script>
        <script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script>
    </head>   
    @model IEnumerable<ESimSol.BusinessObjects.VoucherBill>
    <body>
     <div  style="font-family: Tahoma">
       <table border="0"  cellspacing="2" cellpadding="2">
        <tr>
            <td style="background-color: #CFB53B; width:600px; text-align: center; color: White">
                <label id="lblHeaderName" style="font-size: 15px; font-weight: bold; text-decoration: Underline;">Bill wise </label>
            </td>
        </tr>
    </table>    
    <fieldset>
       <legend>Bill Detail:</legend>
                <table border="0" >
                    <tr>
                        <td style="width: 100px; text-align: right; font-size:12px;"> Bill No </td>
                        <td style ="width: 120px; text-align:left;">
                            <input type="text"  id="txtName" style="width:100px"/>                           
                        </td>
                        <td style="width: 100px; text-align: right; font-size:12px;"> Date</td>
                        <td style ="width: 120px; text-align:left;">
                            <input id="txtBillDate" type="text" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" style="width: 100px;" />
                        </td>
                    </tr>
                       <tr>
                        <td style="width: 100px; text-align: right; font-size:12px;"> Credit Days </td>
                        <td style ="width: 120px; text-align:left;">
                            <input type="text" id="txtCreditDays"  class="easyui-numberbox"  data-options="min:0,precision:0"/>                          
                        </td>
                        <td style="width: 100px; text-align: right; font-size:12px;"> Due Date</td>
                        <td style ="width: 120px; text-align:left;">
                            <input id="txtDueDate" type="text" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" style="width: 100px;" />
                        </td>
                    </tr>
                           
            </table>
              <table border="0" >
                    <tr>
                     <td style ="width: 220px; text-align:left;">
                                                   
                        </td>
                        <td style ="width: 220px; text-align:left;">
                            <input type="button"  id="btnAddBill" value="Add" onclick="AddBill()" style="width:60px"/>     
                            <input type="button"  id="btnRemoveBill" name="Remove" value="Remove" style="width:60px"/>                           
                        </td>
                    </tr>
            </table>
                       
        </fieldset> 

        <div style="margin-left:0px; height:200px">    
             <select id="CboTRType" style="width: 130px; font-size: 12px;" />        
           <input type="text"  id="txtSearchByName" value="Search by No" style="width:110px"/>
            
               <table id="tblVoucherBill" title=""  class="easyui-datagrid" style="width:600px;height:200px"
                data-options="                       
                     singleSelect: true, 
                    fitColumns:false, 
                    rownumbers:true,
                    pagination:false,
                    autoRowHeight:false,                                        
                    showFooter: false,
                    onClickRow: onClickRow  
                ">  
                 
                <thead>  
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"> </th>
                        <th field="BillNo" width="100">Bill No</th>  
                          <th data-options="field:'Amount',width:150,align:'right',editor:{type:'numberbox',options:{precision:2}}"  align="right">Amount</th>
                       @* <th field="Amount" width="230 align="right" formatter="formatPrice" ">Amount</th>*@

                    </tr>  
                </thead> 
            </table>​  
            <table border="0" cellpadding="1" cellspacing="1">
                <tr>
                    <td style="width:280px"></td>
                    <td style="width:50px; text-align:center"><a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="OkButtonClick()">Ok</a></td>
                    <td style="width:50px; text-align:center"><a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" onclick="Close()">Close</a> </td>
                </tr>
            </table>                                        
        </div>
       </div>
    </body>
</html>

<script type="text/javascript">
var _oVoucherBills=[];
var _oVoucherDetail=null;
var _sBaseAddress="";
$(document).ready(function () {
    debugger;
    var obj = window.dialogArguments;
    _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));           
    _oVoucherBills = @Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));     
    RefreshList(_oVoucherBills);    
    _oVoucherDetail=obj.VoucherDetail;
    RefreshControl();
   
});

  function RefreshControl()
{
debugger;
     
     $('#txtBillDate').datebox('setValue', icsdateformat(new Date()));
     $('#txtDueDate').datebox('setValue', icsdateformat(new Date()));
      
     $('#CboTRType').empty();
     var listDates= "<option value='"+1+"'>" +"New Ref" + "</option>";
         listDates+= "<option value='"+2+"'>" + "Agst. Ref" + "</option>";
         listDates+= "<option value='"+3+"'>" + "Advance" + "</option>";
         listDates+= "<option value='"+4+"'>" + "On Account" + "</option>";
      $("#CboTRType").html(listDates);
   }

$('#txtSearchByName').keyup(function (e) {
    ////debugger;
    var c = String.fromCharCode(e.which);
    var txtSearchByName = document.getElementById('txtSearchByName').value;

    var oSearchedVoucherBill = [];  var sTempName="";
    var oCurrentList = $('#tblVoucherBill').datagrid('getRows'); 
    if (e.which == 8)
    {
        oCurrentList = _oVoucherBills;
    }     
    for(i=0;i<oCurrentList.length;++i){
        sTempName=oCurrentList[i].AccountHeadName;        
        n=sTempName.toUpperCase().indexOf(txtSearchByName.toUpperCase())
        if(n!=-1)
        {
            oSearchedVoucherBill.push(oCurrentList[i]); 
        }       
    }
    RefreshList(oSearchedVoucherBill);
});

$(document).keydown(function(e) {    
    //debugger;
    //alert('hello world');
    var oVoucherBill= $('#tblVoucherBill').datagrid('getSelected'); 
    var nIndex=$('#tblVoucherBill').datagrid('getRowIndex', oVoucherBill); 
    if(e.which == 38)//up arrow=38
    {
        if(nIndex<=0)
        {
            $('#tblVoucherBill').datagrid('selectRow', 0); 
        }
        else
        {
            $('#tblVoucherBill').datagrid('selectRow', nIndex-1); 
        }
        $('#txtSearchByName').blur();
    }
    if(e.which == 40)//down arrow=40
    {
        var oCurrentList = $('#tblVoucherBill').datagrid('getRows'); 
        if(nIndex>=oCurrentList.length-1)
        {
            $('#tblVoucherBill').datagrid('selectRow', oCurrentList.length-1); 
        }
        else
        {
            $('#tblVoucherBill').datagrid('selectRow', nIndex+1); 
        }
        $('#txtSearchByName').blur();
    }
    if(e.which == 13)//enter=13
    {
//        //debugger;
//        var oSelectedVoucherBill= $('#tblVoucherBill').datagrid('getSelected'); 
//        if(oSelectedVoucherBill ==null || parseInt(oSelectedVoucherBill.AccountHeadID)<=0)
//        {
//            alert("Please select an account head!");
//            return;
//        }
//        window.returnValue = oSelectedVoucherBill;
//        window.close();
         OkButtonClick();
    }
    if(e.which == 27)//escape=27
    {
        //debugger;        
        window.returnValue = null;
        window.close();
    }
});


function OkButtonClick()
{
  endEditing();
    debugger;
    var oVBTs =[];
    var oVBT=null;
    var oVoucherBills= $('#tblVoucherBill').datagrid('getChecked'); 
    if(oVoucherBills ==null ||oVoucherBills.length <=0)
    {
        alert("Please checked at least one bill!");
        return;
    }
   var sCboTRType = document.getElementById("CboTRType");  
   var  nTRType=sCboTRType.options[sCboTRType.selectedIndex].value;
   if(nTRType ==null ||nTRType <=0)
   {
       alert("Please Select NewRef/AdvanceRef/---");
       return;
   }
   var nTotalAmount=0;
     for(var i=0;i<oVoucherBills.length;i++)
     {
    
            oVBT={
                                VoucherBillTransactionID:0,
                                VoucherBillID:oVoucherBills[i].VoucherBillID,
                                VoucherDetailID :_oVoucherDetail.VoucherDetailID,
                                Amount :oVoucherBills[i].Amount,
                                TrType : nTRType,
                                IsDr: _oVoucherDetail.IsDr

            };
            nTotalAmount=nTotalAmount+oVoucherBills[i].Amount;
       oVBTs.push(oVBT);

    }

     _oVoucherDetail.VoucherBillTrs=oVBTs;
     _oVoucherDetail.Amount=nTotalAmount;
     if( _oVoucherDetail.IsDr==true)
     {
         _oVoucherDetail.DebitAmount=nTotalAmount;
         _oVoucherDetail.CreditAmount=0; 
     }
     else
     {
         _oVoucherDetail.CreditAmount=nTotalAmount; 
         _oVoucherDetail.DebitAmount=0;
     }
    window.returnValue = _oVoucherDetail;
    window.close();
}

function Close()
{
    window.close();
}

function RefreshList(oVoucherBills)
{   
    $('#tblVoucherBill').empty(); 
    data=oVoucherBills;
    data={"total":""+data.length+"","rows":data};
    $('#tblVoucherBill').datagrid('loadData',data);  
    $('#tblVoucherBill').datagrid({selectOnCheck:false, checkOnSelect:false})
   

}


function RefreshObject()
{    
    debugger;  

    var oVoucherBill= {    
                            VoucherBillID : 0,
                            AccountHeadID :_oVoucherDetail.AccountHeadID,
                            BillNo:$("#txtName").val(),
                            DueDate : $('#txtBillDate').datebox('getValue'),
                            BillDate : $('#txtDueDate').datebox('getValue'),
                            CreditDays:  $('#txtCreditDays').numberbox('getValue')
                          
                          
                         };
    return oVoucherBill;
} 


function ValidateInput()
{
    
    //debugger;;
    if ($('#txtName').val() == null ||$('#txtName').val() == '' ) {
        alert("Please enter Bill Name/No!");
         $('#txtName').focus();
        return false;
    }

  
    return true;
 }



function AddBill()
{
    //debugger;   
//    if(!ValidateInput()) return;
     var oVoucherBill=RefreshObject(); 

    $.ajax({
        type: "POST",
        dataType: "json",            
        url : _sBaseAddress+"/VoucherBill/Save",
        traditional: true,
        data:  JSON.stringify(oVoucherBill),
        contentType: "application/json; charset=utf-8",
        success: function (data) {
        debugger;
        var oVoucherBill= jQuery.parseJSON(data);
        if (oVoucherBill.ErrorMessage=="" || oVoucherBill.ErrorMessage==null) 
        {                    
                  if(oVoucherBill.VoucherBillID>0)
                    {
                        var oVoucherBills = $('#tblVoucherBill').datagrid('getRows');               
                        var nIndex=oVoucherBills.length;
                       
                        $('#tblVoucherBill').datagrid('appendRow',oVoucherBill); 
                        $('#tblVoucherBill').datagrid('selectRow', nIndex);   
           
                    }
        }
        else 
        {
            alert(oVoucherBill.ErrorMessage);
        }
        },
        error: function (xhr, status, error) 
        {
            alert(error);
        }
    });       
}

 


     function onClickRow(index){  
   
            if (editIndex != index){  
                if (endEditing()){  
                    $('#tblVoucherBill').datagrid('selectRow', index)  
                            .datagrid('beginEdit', index);  
                    editIndex = index;  
                } else {  
                    $('#tblVoucherBill').datagrid('selectRow', editIndex);  
                }  
            }  
    }  
   var editIndex = undefined;  
   function endEditing(){  
            if (editIndex == undefined){return true}  
            if ($('#tblVoucherBill').datagrid('validateRow', editIndex)){ 
                $('#tblVoucherBill').datagrid('endEdit', editIndex);  
                $('#tblVoucherBill').datagrid('selectRow',editIndex);
                var oVoucherBill=$('#tblVoucherBill').datagrid('getSelected');     
                $('#tblVoucherBill').datagrid('updateRow',{index: editIndex,	row: oVoucherBill});
                editIndex = undefined;  
                return true;  
            } else {  
                return false;  
       }  
    }  

</script>