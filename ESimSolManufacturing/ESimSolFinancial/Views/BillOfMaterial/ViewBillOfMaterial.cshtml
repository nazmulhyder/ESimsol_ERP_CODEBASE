<html>
@{
    ViewBag.Title = "Bill Of Material(s)";
}
<body>
    @model ESimSol.BusinessObjects.BillOfMaterial
    <div id="winColorSequence" class="easyui-window" title="Pick Color" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <fieldset style="margin-top:3px">
                <table border="0" style="font-size:12px">
                    <tr>
                        <td style="width:310px; text-align:right">
                            <table id="tblColorBank" title="Color Bank" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#ColorBankToolbar">
                                <thead>
                                    <tr>
                                        <th field="ColorName" width="320" align="left">Color Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="ColorBankToolbar">
                                <input type="text" id="txtSearchColorSequence" style="width:310px" placeholder="search By color name" />
                            </div>
                        </td>
                        <td style="width:50px; text-align:center; vertical-align:middle">
                            <input type="button" value="Add" id="btnAddTSColor" style="width:40px" />
                        </td>
                        <td style="width:310px; text-align:right">
                            <table id="tblTechnicalSheetColor" title="Color Sequence" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#ColorSequenceToolbar">
                                <thead>
                                    <tr>
                                        <th field="ColorName" width="320" align="left">Color Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="ColorSequenceToolbar">
                                <a id="btnColorSequenceUp" style=" width:50px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-up" plain="true">Up</a>
                                <a id="btnColorSequenceDown" style=" width:60px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-down" plain="true">Down</a>
                                <a id="btnColorSequenceRemove" style=" width:80px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </fieldset>

            <fieldset style="margin-bottom:3px">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:650px">
                    <tr>
                        <td style="width:550px; text-align:left">
                            <a id="btnNewColorCategory" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add New Color</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnColorSequenceOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnColorSequenceClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <div id="winNewColor" class="easyui-window" title="Add Color" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <fieldset style="margin-top:3px">
                <table border="0" style="font-size:12px">
                    <tr>
                        <td style="width:150px; text-align:right">Color Name:</td>
                        <td style="width:250px; text-align:left">
                            <input type="text" id="txtNewColorName" style="width:220px" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:150px; text-align:right">Note :</td>
                        <td style="width:250px; text-align:left">
                            <input type="text" id="txtNewColorNote" style="width:220px" />
                        </td>
                    </tr>
                </table>
            </fieldset>

            <fieldset style="margin-bottom:3px">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                    <tr>
                        <td style="width:300px; text-align:right"></td>
                        <td style="width:50px">
                            <a id="btnNewColorSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnNewColorClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <div id="winSizeSequence" class="easyui-window" title="Pick Color" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <fieldset style="margin-top:3px">
                <table border="0" style="font-size:12px">
                    <tr>
                        <td style="width:310px; text-align:right">
                            <table id="tblSizeBank" title="Color Bank" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#SizeBankToolbar">
                                <thead>
                                    <tr>
                                        <th field="SizeCategoryName" width="320" align="left">Size Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="SizeBankToolbar">
                                <input type="text" id="txtSearchSizeSequence" style="width:310px" placeholder="search By size name" />
                            </div>
                        </td>
                        <td style="width:50px; text-align:center; vertical-align:middle">
                            <input type="button" value="Add" id="btnAddTSSize" style="width:40px" />
                        </td>
                        <td style="width:310px; text-align:right">
                            <table id="tblTechnicalSheetSize" title="Size Sequence" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#SizeSequenceToolbar">
                                <thead>
                                    <tr>
                                        <th field="SizeCategoryName" width="320" align="left">Size Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="SizeSequenceToolbar">
                                <a id="btnSizeSequenceUp" style=" width:50px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-up" plain="true">Up</a>
                                <a id="btnSizeSequenceDown" style=" width:60px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-down" plain="true">Down</a>
                                <a id="btnSizeSequenceRemove" style=" width:80px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </fieldset>

            <fieldset style="margin-bottom:3px">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:650px">
                    <tr>
                        <td style="width:550px; text-align:left">
                            <a id="btnNewSizeCategory" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add New Size</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnSizeSequenceOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnSizeSequenceClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <div id="winNewSize" class="easyui-window" title="Add Size" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <fieldset style="margin-top:3px">
                <table border="0" style="font-size:12px">
                    <tr>
                        <td style="width:150px; text-align:right">Size Name:</td>
                        <td style="width:250px; text-align:left">
                            <input type="text" id="txtNewSizeName" style="width:220px" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:150px; text-align:right">Note :</td>
                        <td style="width:250px; text-align:left">
                            <input type="text" id="txtNewSizeNote" style="width:220px" />
                        </td>
                    </tr>
                </table>
            </fieldset>

            <fieldset style="margin-bottom:3px">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                    <tr>
                        <td style="width:300px; text-align:right"></td>
                        <td style="width:50px">
                            <a id="btnNewSizeSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnNewSizeClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <div id="winProductSequence" class="easyui-window" title="Pick Product" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            <fieldset style="margin-top:3px">
                <table border="0" style="font-size:12px">
                    <tr>
                        <td style="width:310px; text-align:right">
                            <table id="tblProductBank" title="Product Bank" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#ProductBankToolbar">
                                <thead>
                                    <tr>
                                        <th field="ProductName" width="320" align="left">Product Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="ProductBankToolbar">
                                <input type="text" id="txtSearchProductSequence" style="width:310px" placeholder="search By Product name" />
                            </div>
                        </td>
                        <td style="width:50px; text-align:center; vertical-align:middle">
                            <input type="button" value="Add" id="btnAddTSProduct" style="width:40px" />
                        </td>
                        <td style="width:310px; text-align:right">
                            <table id="tblTechnicalSheetProduct" title="Product Sequence" class="easyui-datagrid" style="width: 310px; height: 300px" fit="true" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#ProductSequenceToolbar">
                                <thead>
                                    <tr>
                                        <th field="ProductName" width="320" align="left">Product Name</th>
                                    </tr>
                                </thead>
                            </table>
                            <div id="ProductSequenceToolbar">
                                <a id="btnProductSequenceUp" style=" width:50px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-up" plain="true">Up</a>
                                <a id="btnProductSequenceDown" style=" width:60px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-down" plain="true">Down</a>
                                <a id="btnProductSequenceRemove" style=" width:80px; text-align:left;" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </fieldset>

            <fieldset style="margin-bottom:3px">
                <legend style="font-weight:bold"> Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:650px">
                    <tr>
                        <td style="width:550px; text-align:left"></td>
                        <td style="width:50px">
                            <a id="btnProductSequenceOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        </td>
                        <td style="width:50px">
                            <a id="btnProductSequenceClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <div class="menuMainCollectionTable" style="font-family:Tahoma">       
            @Html.HiddenFor(model => model.TechnicalSheetID, new { id = "txtTechnicalSheetID" })
            @Html.HiddenFor(model => model.ProductID, new { id = "txtProductID" })
            @Html.HiddenFor(model => model.ColorID, new { id = "txtColorID" })
            @Html.HiddenFor(model => model.SizeID, new { id = "txtSizeID" })
            @Html.HiddenFor(model => model.MUnitID, new { id = "txtMUnitID" })
        <div style="width:100%; height:90%" class="easyui-panel">
            <div style="margin-left:0px; margin-top:1px;width:1200px; height:490px" id="divatt">
                <table id="tblBillOfMaterial" title="Bill Of Mategial" class="easyui-datagrid" style="width:1200px;height:490px" toolbar="#toolbar" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" data-options="onClickRow: onClickRow">
                    <thead>
                        <tr>
                            <th field="ProductCode" width="60" align="left"> Code</th>
                            <th field="ProductName" width="210" align="left"> Material Name</th>
                            <th field="ColorName" width="80" align="left">Color</th>
                            <th field="SizeName" width="90" align="left">Size</th>
                            <th width="120" align="left" data-options="field:'ItemDescription',editor:{type:'textbox'}">Item Description</th>
                            <th width="120" align="left" data-options="field:'Reference',editor:{type:'textbox'}">Reference</th>
                            <th width="120" align="left" data-options="field:'Construction',editor:{type:'textbox'}">Construction</th>
                            <th width="120" align="left" data-options="field:'POCode',editor:{type:'textbox'}">PO Code</th>
                            <th field="Sequence" width="70" align="center">Sequence</th>
                            <th field="Symbol" width="70" align="left">M Unit</th>
                            <th width="90" align="right" data-options="field:'ReqQty',editor:{type:'numberbox',options:{precision:2}}">Req Qty</th>
                            <th width="90" align="right" data-options="field:'OrderQty',editor:{type:'numberbox',options:{precision:2}}">Order Qty</th>
                            <th width="120" align="right" data-options="field:'BookingConsumption',editor:{type:'numberbox',options:{precision:2}}">Booking Con.</th>
                            <th width="140" align="right" data-options="field:'BookingConsumptionInPercent',editor:{type:'numberbox',options:{precision:2}}">Booking Con.(%)</th>
                            <th width="110" align="right" data-options="field:'BookingQty',editor:{type:'numberbox',options:{precision:2}}">Booking Qty</th>
                            <th width="100" align="right" data-options="field:'CuttingQty',editor:{type:'numberbox',options:{precision:2}}">Cutting Qty</th>
                            <th width="90" align="right" data-options="field:'ConsumptionQty',editor:{type:'numberbox',options:{precision:2}}">Consumption Qty</th>
                            <th width="120" align="left" data-options="field:'Remarks',editor:{type:'textbox'}">Remarks</th>
                            <th field="AttachFileInString" formatter="FormatDownload" width="90" align="center">Attach File</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbar" style="font-family:Tahoma; margin-left:0px; width:100%">
                    <table border="0" cellpadding="1" cellspacing="1" style="width:100%;">
                        <tr>
                            <td style="width:45%" colspan="2"><input type="text" placeholder="Press Enter With Product Name" id="txtProductName" style="width:78%" /><input type="button" style="width:19%;" id="btnProductPiker" value="Pick" /></td>
                            <td style="width:20%"><input type="text" placeholder="Press Enter With Color Name" id="txtColorName" style="width:78%" /><input type="button" style="width:19%;" id="btnColorPiker" value="Pick" /></td>
                            <td style="width:20%"><input type="text" placeholder="Press Enter With Size Name" id="txtSizeName" style="width:78%" /><input type="button" style="width:19%;" id="btnSizePiker" value="Pick" /></td>
                            <td style="width:15%; text-align:left"> <input disabled="disabled" value="Req Qty :" style="width:40%; text-align:right" /> @Html.TextBoxFor(model => model.ReqQty, new { style = "width:40%;text-align:right", id = "txtReqQty", placeholder = "Requird Qty" })</td>
                        </tr>
                        <tr>
                            <td style="width:30%"><input disabled="disabled" value="Cutting :" style="width:20%; text-align:right" /> @Html.TextBoxFor(model => model.CuttingQty, new { style = "width:20%;text-align:right", id = "txtCuttingQty" })<input disabled="disabled" value="Consumption :" style="width:28%; text-align:right" /> @Html.TextBoxFor(model => model.ConsumptionQty, new { style = "width:20%;text-align:right", id = "txtConsumptionQty"})</td>
                            <td style="width:15%">@Html.TextBoxFor(model => model.Reference, new { style = "width: 97%;", id = "txtReference", placeholder = "Reference" })</td>
                            <td style="width:20%">@Html.TextBoxFor(model => model.ItemDescription, new { style = "width: 97%;", id = "txtItemDescription", placeholder = "Item Description" })</td>
                            <td style="width:20%;text-align:left;">@Html.TextBoxFor(model => model.Construction, new { style = "width: 97%;", id = "txtConstruction", placeholder = "Construction" })</td>
                            <td style="width:15%;text-align:left;">
                                <input id="btnAdd" type="button" value="Add" style="width:40%; font-weight:bold" />
                                <input id="btnDelete" type="button" value="Remove" style="width:40%; font-weight:bold" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="width:60%">
                                <table style="width:100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td style="width:20%">
                                            <a id="btnAddBOMImage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Image</a>
                                        </td>
                                        <td style="width:80%">
                                            <input id="fileInput" type="file" name="file" style="width:100%;" accept="image/x-png,image/gif,image/jpeg" />
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td colspan="3" style="width:40%; text-align:right">
                                <a href="javascript:void(0)" id="btnUp" class="easyui-linkbutton" iconcls="icon-up" plain="true">Up</a>
                                <a href="javascript:void(0)" id="btnDown" class="easyui-linkbutton" iconcls="icon-down" plain="true">Down</a>
                                <a href="javascript:void(0)" id="btnResetSequence" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset Sequence</a>
                                <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <fieldset style="height:10%">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:12px; font-weight:bold" width="100%">
                <tr>
                    <td style="width:52%; text-align:left;color:red;">
                        <label id="lblError"></label>
                    </td>
                    <td style="width:40%; text-align:right">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                    </td>
                    <td style="width:8%">
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>

<script type="text/javascript">
    $(document).ready(function () {
        var oBillOfMaterials=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.BillOfMaterials));
        var sHeaderTitle = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.HeaderTitle));
        $('#tblBillOfMaterial').datagrid({title : sHeaderTitle});
        $('#txtReqQty,#txtCuttingQty,#txtConsumptionQty').icsCurrencyBox();
        RefreshList(oBillOfMaterials);
        $('#txtProductName').data('Products', []);
        $('#txtColorName').data('TechnicalSheetColors', []);
        $('#txtSizeName').data('TechnicalSheetSizes', []);
        $("#cboUnit").data('MUnits', []);
    });

    function RefreshList(oBillOfMaterials)
    {
        data=oBillOfMaterials;
        data={"total":""+data.length+"","rows":data};
        $('#tblBillOfMaterial').datagrid('loadData',data);
    }

    function ValidateAdd()
    {
        var oProducts = $('#txtProductName').data('Products');
        if(oProducts.length<=0)
        {
            $('#txtProductName').focus();
            $('#txtProductName').addClass("errorFieldBorder");
            alert('Please select product!');
            return false;
        }

        if(oProducts.length<=0)
        { 
            for(var i = 0;i<oProducts.length;i++ )
            {
                if(Boolean(oProducts[i].IsApplyColor))
                {
                    var oColorCategorys = $('#txtColorName').data('TechnicalSheetColors');
                    if(oColorCategorys===null || oColorCategorys.length<=0)
                    {
                        $('#txtColorName').focus();
                        $('#txtColorName').addClass("errorFieldBorder");
                        alert('Please select color!');
                        return false;
                    }
                }
            }
            if(Boolean(oProducts[i].IsApplySize))
            {
                var oSizeCategorys = $('#txtSizeName').data('TechnicalSheetSizes');
                if(oSizeCategorys===null || oSizeCategorys.length<=0)
                {
                    $('#txtSizeName').focus();
                    $('#txtSizeName').addClass("errorFieldBorder");
                    alert('Please select Size!');
                    return false;
                }
            }
        }

        var nCuttingQty=parseFloat(icsRemoveComma($('#txtCuttingQty').val()));
        var nConsumptionQty=parseFloat(icsRemoveComma($('#txtConsumptionQty').val()));
        if(nConsumptionQty<nCuttingQty)
        {
            $('#txtConsumptionQty').focus();
            $('#txtConsumptionQty').addClass("errorFieldBorder");
            alert('Consumption Qty Should be Greater than Cutting Qty');
            return false;
        }
        return true;
    }

    function ValidateInput()
    {
        var oBillOfMaterials = $('#tblBillOfMaterial').datagrid('getRows');
        if(oBillOfMaterials===null || oBillOfMaterials.length<=0)
        {
            alert("Please enter at least one Product!");
            return false;
        }

        for(var i=0; i<oBillOfMaterials.length; i++)
        {
            var sTempName = "Proudct : "+ oBillOfMaterials[i].ProductName+ "["+oBillOfMaterials[i].ProductCode+"]";
            if( parseInt(oBillOfMaterials[i].ColorID)>0)
            {
                sTempName = sTempName + ", Color : "+ oBillOfMaterials[i].ColorName;
            }
            if( parseInt(oBillOfMaterials[i].SizeID)>0)
            {
                sTempName = sTempName + ", Size : "+ oBillOfMaterials[i].SizeName;
            }

            if(parseInt(oBillOfMaterials[i].TechnicalSheetID) <=0)
            {
                alert('Invalid Style for '+ sTempName);
                return false;
            }

            if(parseFloat(oBillOfMaterials[i].ReqQty) <=0)
            {
                alert('Please enter req Qty for '+ sTempName);
                return false;
            }

            var nCuttingQty=parseFloat(oBillOfMaterials[i].CuttingQty);
            var nConsumptionQty=parseFloat(oBillOfMaterials[i].ConsumptionQty);
            if(nConsumptionQty<nCuttingQty)
            {
                alert('Consumption Qty Should be Greater than Cutting Qty for '+ sTempName);
                return false;
            }
        }

        return true;
    }

    $('#btnAdd').click(function(){
        if(!ValidateAdd()) return false;
        debugger;
        var oBillOfMaterials = [];
        var oProducts = $('#txtProductName').data('Products');
        var oColorCategorys = $('#txtColorName').data('TechnicalSheetColors');
        var oSizeCategorys = $('#txtSizeName').data('TechnicalSheetSizes');

        if(oColorCategorys.length<=0 && oSizeCategorys.length<=0)
        {
            for(var i =0;i<oProducts.length;i++)
            {
                var oBillOfMaterial = MakeObject(oProducts[i], null, null);
                oBillOfMaterials.push(oBillOfMaterial);
            }
        }
        else if(oColorCategorys.length>0 && oSizeCategorys.length<=0)
        {
            for(var i =0;i<oProducts.length;i++)
            {
                for(var j=0;  j < oColorCategorys.length; j++)
                {
                    var oBillOfMaterial = MakeObject(oProducts[i], oColorCategorys[j], null);
                    oBillOfMaterials.push(oBillOfMaterial);
                }
            }
        }
        else if(oColorCategorys.length<=0 && oSizeCategorys.length>0)
        {
            for(var i =0;i<oProducts.length;i++)
            {
                for(var j=0;  j < oSizeCategorys.length; j++)
                {
                    var oBillOfMaterial = MakeObject(oProducts[i], null, oSizeCategorys[j]);
                    oBillOfMaterials.push(oBillOfMaterial);
                }
            }
        }
        else if(oColorCategorys.length>0 && oSizeCategorys.length>0)
        {
            for(var i =0;i<oProducts.length;i++)
            {
                for(var j=0;  j < oColorCategorys.length; j++)
                {
                    for(var k=0;  k < oSizeCategorys.length; k++)
                    {
                        var oBillOfMaterial = MakeObject(oProducts[i], oColorCategorys[j], oSizeCategorys[k]);
                        oBillOfMaterials.push(oBillOfMaterial);
                    }
                }
            }
        }

        for(var i=0; i<oBillOfMaterials.length; i++)
        {
            oBillOfMaterials[i].Sequence = ($('#tblBillOfMaterial').datagrid('getRows').length + 1);
            $('#tblBillOfMaterial').datagrid('appendRow', oBillOfMaterials[i]);
        }

        $('#txtProductName').data('Products', []);
        $('#txtColorName').data('TechnicalSheetColors', []);
        $('#txtSizeName').data('TechnicalSheetSizes', []);
        $("#txtProductName").removeClass("fontColorOfPickItem");
        $("#txtColorName").removeClass("fontColorOfPickItem");
        $("#txtSizeName").removeClass("fontColorOfPickItem");

        $("#txtProductName,#txtColorName,#txtSizeName,#txtReference,#txtItemDescription,#txtConstruction").val("");
        $("#txtReqQty,#txtCuttingQty,#txtConsumptionQty").val("0.00");
    });
    $('#btnSave').click(function(){
        endEditing();
        if(!ValidateInput()) return false;

        var oBillOfMaterial = {
            BillOfMaterials :  $('#tblBillOfMaterial').datagrid('getRows')
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/BillOfMaterial/SaveBOM",
            traditional: true,
            data:  JSON.stringify(oBillOfMaterial),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oBillOfMaterial = jQuery.parseJSON(data);
                if (oBillOfMaterial.ErrorMessage === "")
                {
                    alert("Data Saved sucessfully");
                    RefreshList(oBillOfMaterial.BillOfMaterials)
                    window.location.href =  sessionStorage.getItem("BackLink");
                }
                else
                {
                    alert(oBillOfMaterial.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    function MakeObject(oProduct, oColorCategory, oSizeCategory)
    {
        var nColorID = oColorCategory ==null ? 0 : parseInt(oColorCategory.ColorCategoryID);
        var sColorName = oColorCategory ==null ? "" : oColorCategory.ColorName;
        var nSizeID = oSizeCategory ==null ? 0 : parseInt(oSizeCategory.SizeCategoryID);
        var sSizeCategoryName = oSizeCategory ==null ? "" : oSizeCategory.SizeCategoryName;


        var oBillOfMaterial = {
            BillOfMaterialID : 0,
            TechnicalSheetID : parseInt($('#txtTechnicalSheetID').val()),
            ProductID : parseInt(oProduct.ProductID),
            ColorID : parseInt(nColorID),
            SizeID : parseInt(nSizeID),
            ItemDescription : $.trim($('#txtItemDescription').val()),
            Reference : $.trim($('#txtReference').val()),
            Construction : $.trim($('#txtConstruction').val()),
            POCode:'',
            Remarks:'',
            Sequence : 0,
            MUnitID : parseInt(oProduct.MeasurementUnitID),
            ReqQty : parseInt(icsRemoveComma($('#txtReqQty').val())),
            CuttingQty :  parseFloat(icsRemoveComma($('#txtCuttingQty').val())),
            ConsumptionQty : parseFloat(icsRemoveComma($('#txtConsumptionQty').val())),
            OrderQty :0,
            BookingQty :0,
            BookingConsumption  :0,
            BookingConsumptionInPercent :0,
            ProductCode : oProduct.ProductCode,
            ProductName : oProduct.ProductName,
            ColorName : sColorName,
            SizeName : sSizeCategoryName,
            Symbol : oProduct.MUnit,
            UnitName : oProduct.MUnitName
        };

        return oBillOfMaterial;
    }


    $('#btnDelete').click(function (e) {
        var oBillOfMaterial= $('#tblBillOfMaterial').datagrid('getSelected');
        if(oBillOfMaterial==null ||  parseInt(oBillOfMaterial.TechnicalSheetID)<=0)
        {
            alert("Invalid BillOfMaterial!!! please select a valid BillOfMaterial!");
            return false;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblBillOfMaterial').datagrid('getRowIndex',oBillOfMaterial);
        alert("Delete sucessfully");
        $('#tblBillOfMaterial').datagrid('deleteRow',SelectedRowIndex);

    });
    $('#btnUp').click(function(){
        var oBillOfMaterial = $('#tblBillOfMaterial').datagrid('getSelected');
        if (oBillOfMaterial == null) {
            alert("Please select Item");
            return;
        }
        var oTempBillOfMaterials = $('#tblBillOfMaterial').datagrid('getRows');
        var SelectedRowIndex = $('#tblBillOfMaterial').datagrid('getRowIndex', oBillOfMaterial);
        if (SelectedRowIndex == 0) return;
        var oBillOfMaterials = [];
        oBillOfMaterials = oTempBillOfMaterials;
        oTempBillOfMaterials = [];
        for (var i = 0; i < oBillOfMaterials.length; i++) {
            if (i == (SelectedRowIndex - 1)) {
                oTempBillOfMaterials[i] = oBillOfMaterials[i + 1];
            }
            else if (i == SelectedRowIndex) {
                oTempBillOfMaterials[i] = oBillOfMaterials[i - 1];
            }
            else {
                oTempBillOfMaterials[i] = oBillOfMaterials[i];
            }
            oTempBillOfMaterials[i].Sequence = i + 1;
        }
        data = oTempBillOfMaterials;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblBillOfMaterial').datagrid('loadData', data);
        var newSelectedRowIndex = SelectedRowIndex - 1;
        $('#tblBillOfMaterial').datagrid('selectRow', newSelectedRowIndex);
    });
    $('#btnDown').click(function(){
        var oBillOfMaterial = $('#tblBillOfMaterial').datagrid('getSelected');
        if (oBillOfMaterial == null) {
            alert("Please select a item from list!");
            return;
        }
        var oTempBillOfMaterials = $('#tblBillOfMaterial').datagrid('getRows');
        var SelectedRowIndex = $('#tblBillOfMaterial').datagrid('getRowIndex', oBillOfMaterial);
        if (SelectedRowIndex == (oTempBillOfMaterials.length - 1)) return;
        var oBillOfMaterials = [];
        oBillOfMaterials = oTempBillOfMaterials;
        oTempBillOfMaterials = [];
        for (var i = 0; i < oBillOfMaterials.length; i++) {
            if (i == (SelectedRowIndex + 1)) {
                oTempBillOfMaterials[i] = oBillOfMaterials[i - 1];
            }
            else if (i == SelectedRowIndex) {
                oTempBillOfMaterials[i] = oBillOfMaterials[i + 1];
            }
            else {
                oTempBillOfMaterials[i] = oBillOfMaterials[i];
            }
            oTempBillOfMaterials[i].Sequence = i + 1;
        }
        data = oTempBillOfMaterials;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblBillOfMaterial').datagrid('loadData', data);

        var newSelectedRowIndex = SelectedRowIndex + 1;
        $('#tblBillOfMaterial').datagrid('selectRow', newSelectedRowIndex);
    });
    $('#btnResetSequence').click(function(){
        var oBillOfMaterials = $('#tblBillOfMaterial').datagrid('getRows');
        var oBillOfMaterial = { BillOfMaterials: oBillOfMaterials };
        $.ajax({
            type: "POST",
            dataType: "json",
            url: sessionStorage.getItem('BaseAddress') + "/BillOfMaterial/ResetSequence",
            traditional: true,
            data: JSON.stringify(oBillOfMaterial),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oTempBillOfMaterials = jQuery.parseJSON(data);
                if (oTempBillOfMaterials[0].ErrorMessage == "") {
                    alert("Reset Successfully");
                    RefreshList(oTempBillOfMaterials);
                }
                else {
                    alert(oTempBillOfMaterials[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    $('#btnPreview').click(function(){
        var nTechnicalSheetID = parseInt($('#txtTechnicalSheetID').val());
        if(nTechnicalSheetID<=0)
        {
            alert("Invalid TechnicalSheet!");
            return;
        }
        window.open(sessionStorage.getItem('BaseAddress') + '/TechnicalSheet/PrintTechnicalSheet?id='+nTechnicalSheetID);
    });
    $('#btnClose').click(function(){
        window.location.href =  sessionStorage.getItem("BackLink");
    });

    //start product picker
    $("#txtProductName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var sProductName = $.trim($('#txtProductName').val());
            if(sProductName === null || sProductName === "")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtProductName').focus();
                return;
            }
            var oProduct = { BUID: sessionStorage.getItem("BUID"), ProductName: sProductName };
            var obj = {
                BaseAddress: sessionStorage.getItem('BaseAddress'),
                Object: oProduct,
                ControllerName: "Product",
                ActionName: "SearchByProductBUWise",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {

                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ProductID > 0) {
                        var tblColums = []; var oColumn = { field: "NameCode", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winProductPicker',
                            winclass: 'clsProductPicker',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblProductPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: true,
                            searchingbyfieldName: 'NameCode',
                            windowTittle: 'Product List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }

                }else{
                    alert("Data Not Found.");
                }
            });

        }else if (code == 8) //backspace=8
        {
            $("#txtProductName").removeClass("fontColorOfPickItem");
            $('#txtProductName').data('Products', []);
        }
    });
    $("#btnProductPiker").click(function () {
        DynamicRefreshList([], 'tblProductBank');
        var oProducts = $('#txtProductName').data('Products');
        DynamicRefreshList(oProducts, 'tblTechnicalSheetProduct');
        $("#winProductSequence").icsWindow('open', "Pick Product");
    });
 
    function GetTSProductNames(oTechnicalSheetProductList) {
        var sProductName = "";
        for (var i = 0; i < oTechnicalSheetProductList.length; i++) {
            sProductName = sProductName + oTechnicalSheetProductList[i].ProductName + "; "
        }
        return sProductName;
    }
    $('#txtSearchProductSequence').keydown(function(e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var oProduct = { BUID:sessionStorage.getItem("BUID"), ProductName:$.trim($('#txtSearchProductSequence').val())};
            var obj = {
                BaseAddress: sessionStorage.getItem('BaseAddress'),
                Object: oProduct,
                ControllerName: "Product",
                ActionName: "SearchByProductBUWise",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ProductID > 0) 
                    {
                        DynamicRefreshList(response.objs, 'tblProductBank');
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }

                }else{
                    alert("Data Not Found.");
                }
            });
            
        }
    });
    $('#btnProductSequenceClose').click(function(e){
        $("#winProductSequence").icsWindow('close');
    });
    $('#tblProductBank').datagrid({
        onDblClickRow: function(index,row){
            AddToProductList(row);
        }
    });
    $('#btnAddTSProduct').click(function(e){
        var oProduct = $('#tblProductBank').datagrid('getSelected');
        if(oProduct===null || parseInt(oProduct.ProductID)<=0)
        {
            alert("Please select an Product category!");
            return;
        }
        AddToProductList(oProduct);
    });
    $('#btnProductSequenceRemove').click(function(e){
        var oTechnicalSheetProduct = $('#tblTechnicalSheetProduct').datagrid('getSelected');
        if(oTechnicalSheetProduct===null || parseInt(oTechnicalSheetProduct.ProductID)<=0)
        {
            alert("Please select an Product category!");
            return;
        }

        var nRowIndex = $('#tblTechnicalSheetProduct').datagrid('getRowIndex', oTechnicalSheetProduct);
        $('#tblTechnicalSheetProduct').datagrid('deleteRow', nRowIndex);

    });
    $('#btnProductSequenceUp').click(function(e){
        var oTechnicalSheetProduct = $('#tblTechnicalSheetProduct').datagrid('getSelected');
        if(oTechnicalSheetProduct==null || parseInt(oTechnicalSheetProduct.ProductID)<=0)
        {
            alert("Please select Product");
            return;
        }

        var SelectedRowIndex=$('#tblTechnicalSheetProduct').datagrid('getRowIndex',oTechnicalSheetProduct);
        var oTempTechnicalSheetProducts = $('#tblTechnicalSheetProduct').datagrid('getRows');
        if(SelectedRowIndex==0)return;
        var oTechnicalSheetProducts=[];
        oTechnicalSheetProducts=oTempTechnicalSheetProducts;
        oTempTechnicalSheetProducts=[];
        for(var i=0; i<oTechnicalSheetProducts.length; i++)
        {
            if(i==(SelectedRowIndex-1))
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i+1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i-1];
            }
            else
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i];
            }
            oTempTechnicalSheetProducts[i].Sequence=i+1;
        }

        data = oTempTechnicalSheetProducts;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetProduct').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex-1;
        $('#tblTechnicalSheetProduct').datagrid('selectRow',newSelectedRowIndex);
    });
    $('#btnProductSequenceDown').click(function(e){
        var oTechnicalSheetProduct = $('#tblTechnicalSheetProduct').datagrid('getSelected');
        if(oTechnicalSheetProduct==null || parseInt(oTechnicalSheetProduct.ProductID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblTechnicalSheetProduct').datagrid('getRowIndex',oTechnicalSheetProduct);
        var oTempTechnicalSheetProducts = $('#tblTechnicalSheetProduct').datagrid('getRows');
        if(SelectedRowIndex==(oTempTechnicalSheetProducts.length-1))return;
        var oTechnicalSheetProducts=[];
        oTechnicalSheetProducts=oTempTechnicalSheetProducts;
        oTempTechnicalSheetProducts=[];
        for(var i=0; i<oTechnicalSheetProducts.length; i++)
        {
            if(i==(SelectedRowIndex+1))
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i-1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i+1];
            }
            else
            {
                oTempTechnicalSheetProducts[i]=oTechnicalSheetProducts[i];
            }
            oTempTechnicalSheetProducts[i].Sequence=i+1;
        }
        data = oTempTechnicalSheetProducts;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetProduct').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex+1;
        $('#tblTechnicalSheetProduct').datagrid('selectRow',newSelectedRowIndex);
    });
    $('#btnProductSequenceOk').click(function(e){
        var oTechnicalSheetProductList = [];
        var nMaxProductSequence = 0;
        var oTechnicalSheetProduct = $('#tblTechnicalSheetProduct').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetProduct.length; i++) {
            nMaxProductSequence++;
            var oTSProduct = {
                TechnicalSheetProductID: 0,
                TechnicalSheetID: 0,
                ProductID: oTechnicalSheetProduct[i].ProductID,
                ProductName: oTechnicalSheetProduct[i].ProductName,
                ProductCode:oTechnicalSheetProduct[i].ProductCode,
                Sequence: nMaxProductSequence
            };
            oTechnicalSheetProductList.push(oTSProduct);
        }
        $('#txtProductName').data('Products',oTechnicalSheetProductList);
        $("#winProductSequence").icsWindow('close');
        $('#txtProductName').val(GetTSProductNames(oTechnicalSheetProductList));
        $('#txtProductName').addClass('fontColorOfPickItem');
        $('#txtColorName').focus();
    });
    function AddToProductList(oProduct)
    {
        var oTechnicalSheetProducts = $('#tblTechnicalSheetProduct').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetProducts.length; i++) {
            if (parseInt(oTechnicalSheetProducts[i].ProductID) === parseInt(oProduct.ProductID)) {
                alert("Your Selected Product Already Exists!");
                return;
            }
        }
        var oTechnicalSheetProduct = {
            TechnicalSheetProductID: 0,
            TechnicalSheetID: 0,
            ProductID: oProduct.ProductID,
            ProductName: oProduct.ProductName,
            ProductCode:oProduct.ProductCode,
            Sequence: ($('#tblTechnicalSheetProduct').datagrid('getRows').length+1)
        };
        $('#tblTechnicalSheetProduct').datagrid('appendRow',oTechnicalSheetProduct);
    }
    //end product picker

    //start color picker
    $("#txtColorName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var sColorName = $.trim($('#txtColorName').val());
            if(sColorName===null || sColorName==="")
            {
                alert("Press Enter With Color Name!");
                $('#txtColorName').focus();
                return;
            }
            PickColor(sColorName);
        }
    });
    $('#txtColorName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            $("#txtColorName").removeClass("fontColorOfPickItem");
            $('#txtColorName').data('TechnicalSheetColors', []);
        }
    });
    function PickColor(sColorName)
    {
        var oColorCategory = {Param:sColorName};
        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oColorCategory,
            ControllerName:"ColorCategory",
            ActionName: "SearchColor",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ColorCategoryID > 0) {

                    var tblColums = []; var oColumn = { field: "ColorName", title: "Color Name", width: 250, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Note", title: "Note", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winColorCategory',
                        winclass: 'clsColorCategory',
                        winwidth: 500,
                        winheight: 400,
                        tableid: 'tblColorCategory',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ColorName',
                        windowTittle: 'Color List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });
    }
    //end color picker

    //start size picker
    $("#txtSizeName").keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var sSizeName = $.trim($('#txtSizeName').val());
            if(sSizeName===null || sSizeName==="")
            {
                alert("Press Enter With Size Name!");
                $('#txtSizeName').focus();
                return;
            }
            PickSize(sSizeName);
        }
    });
    $('#txtSizeName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            $("#txtSizeName").removeClass("fontColorOfPickItem");
            $('#txtSizeName').data('TechnicalSheetSizes', []);
        }
    });
    function PickSize(sSizeName)
    {
        var oSizeCategory = {Param:sSizeName};
        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oSizeCategory,
            ControllerName:"SizeCategory",
            ActionName: "SearchSize",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].SizeCategoryID > 0) {

                    var tblColums = []; var oColumn = { field: "SizeCategoryName", title: "Size Name", width: 250, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Note", title: "Note", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winSizeCategory',
                        winclass: 'clsSizeCategory',
                        winwidth: 500,
                        winheight: 400,
                        tableid: 'tblSizeCategory',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SizeCategoryName',
                        windowTittle: 'Size List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });
    }
    //end size picker

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj)
    {
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnobjs.length>0)
            {
                $('#txtProductName').val(oreturnobjs.length+" Product's Selected");
                $('#txtProductName').addClass('fontColorOfPickItem');
                $('#txtProductName').data('Products', oreturnobjs);
                
                //if(Boolean(oreturnObj.IsApplyColor))
                //{
                //    $('#txtColorName').val('');
                //    $('#txtColorName').data('TechnicalSheetColors', []);
                //    $('#txtColorName,#btnColorPick').prop('disabled', false);
                //}
                //else
                //{
                //    $('#txtColorName').val('');
                //    $('#txtColorName').data('TechnicalSheetColors', []);
                //    $('#txtColorName,#btnColorPick').prop('disabled', true);
                //}

                //if(Boolean(oreturnObj.IsApplySize))
                //{
                //    $('#txtSizeName').val('');
                //    $('#txtSizeName').data('TechnicalSheetSizes', []);
                //    $('#txtSizeName,#btnSizePiker').prop('disabled', false);
                //}
                //else
                //{
                //    $('#txtSizeName').val('');
                //    $('#txtSizeName').data('TechnicalSheetSizes', []);
                //    $('#txtSizeName,#btnSizePiker').prop('disabled', true);
                //}
                
            }
        }
        else if (oPickerobj.winid=='winColorCategory')
        {
            if (oreturnObj != null && oreturnObj.ColorCategoryID > 0)
            {
                var oTSColor = {
                    TechnicalSheetColorID: 0,
                    TechnicalSheetID: 0,
                    ColorCategoryID: oreturnObj.ColorCategoryID,
                    ColorName: oreturnObj.ColorName,
                    Sequence: 0
                };

                $('#txtColorName').val(oTSColor.ColorName);
                $('#txtColorName').addClass('fontColorOfPickItem');
                $('#txtColorName').data('TechnicalSheetColors', [oTSColor]);
                var oProducts = $('#txtProductName').data('Products');
                if(oProducts.length>0)
                {
                    for(var i = 0;i<oProducts.length;i++)
                    {
                        if(Boolean(oProducts[i].IsApplySize))
                        {
                            $('#txtSizeName').focus();
                            return;
                        }
                        else
                        {
                            $('#txtReqQty').focus();
                        }
                    }
                }
            }
        }
        else if (oPickerobj.winid=='winSizeCategory')
        {
            if (oreturnObj != null && oreturnObj.SizeCategoryID > 0)
            {
                var oTSSize = {
                    TechnicalSheetSizeID: 0,
                    TechnicalSheetID: 0,
                    SizeCategoryID: oreturnObj.SizeCategoryID,
                    SizeCategoryName: oreturnObj.SizeCategoryName,
                    Sequence: 0
                };

                $('#txtSizeName').val(oTSSize.SizeCategoryName);
                $('#txtSizeName').addClass('fontColorOfPickItem');
                $('#txtSizeName').data('TechnicalSheetSizes', [oTSSize]);
                $('#txtReqQty').focus();
            }
        }
    }


    //Start Size & Color
    function GetTSColorNames(oTechnicalSheetColorList) {
        var sColorName = "";
        for (var i = 0; i < oTechnicalSheetColorList.length; i++) {
            sColorName = sColorName + oTechnicalSheetColorList[i].ColorName + "; "
        }
        return sColorName;
    }
    $('#txtSearchColorSequence').keyup(function(e){
        var oColorCategorys = $('#tblColorBank').data('ColorCategorys');
        $('#txtSearchColorSequence').icsSearchByText({
            Event: e,
            SearchProperty: "ColorName",
            GlobalObjectList: oColorCategorys,
            TableId: "tblColorBank"
        });
    });
    $('#btnColorSequenceClose').click(function(e){
        $("#winColorSequence").icsWindow('close');
    });
    $('#tblColorBank').datagrid({
        onDblClickRow: function(index,row){
            AddToColorList(row);
        }
    });
    $('#btnAddTSColor').click(function(e){
        var oColorCategory = $('#tblColorBank').datagrid('getSelected');
        if(oColorCategory===null || parseInt(oColorCategory.ColorCategoryID)<=0)
        {
            alert("Please select an color category!");
            return;
        }
        AddToColorList(oColorCategory);
    });
    $('#btnColorSequenceRemove').click(function(e){
        var oTechnicalSheetColor = $('#tblTechnicalSheetColor').datagrid('getSelected');
        if(oTechnicalSheetColor===null || parseInt(oTechnicalSheetColor.ColorCategoryID)<=0)
        {
            alert("Please select an color category!");
            return;
        }

        var nRowIndex = $('#tblTechnicalSheetColor').datagrid('getRowIndex', oTechnicalSheetColor);
        $('#tblTechnicalSheetColor').datagrid('deleteRow', nRowIndex);

    });
    $('#btnColorSequenceUp').click(function(e){
        var oTechnicalSheetColor = $('#tblTechnicalSheetColor').datagrid('getSelected');
        if(oTechnicalSheetColor==null || parseInt(oTechnicalSheetColor.ColorCategoryID)<=0)
        {
            alert("Please select color");
            return;
        }

        var SelectedRowIndex=$('#tblTechnicalSheetColor').datagrid('getRowIndex',oTechnicalSheetColor);
        var oTempTechnicalSheetColors = $('#tblTechnicalSheetColor').datagrid('getRows');
        if(SelectedRowIndex==0)return;
        var oTechnicalSheetColors=[];
        oTechnicalSheetColors=oTempTechnicalSheetColors;
        oTempTechnicalSheetColors=[];
        for(var i=0; i<oTechnicalSheetColors.length; i++)
        {
            if(i==(SelectedRowIndex-1))
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i+1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i-1];
            }
            else
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i];
            }
            oTempTechnicalSheetColors[i].Sequence=i+1;
        }

        data = oTempTechnicalSheetColors;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetColor').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex-1;
        $('#tblTechnicalSheetColor').datagrid('selectRow',newSelectedRowIndex);
    });
    $('#btnColorSequenceDown').click(function(e){
        var oTechnicalSheetColor = $('#tblTechnicalSheetColor').datagrid('getSelected');
        if(oTechnicalSheetColor==null || parseInt(oTechnicalSheetColor.ColorCategoryID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblTechnicalSheetColor').datagrid('getRowIndex',oTechnicalSheetColor);
        var oTempTechnicalSheetColors = $('#tblTechnicalSheetColor').datagrid('getRows');
        if(SelectedRowIndex==(oTempTechnicalSheetColors.length-1))return;
        var oTechnicalSheetColors=[];
        oTechnicalSheetColors=oTempTechnicalSheetColors;
        oTempTechnicalSheetColors=[];
        for(var i=0; i<oTechnicalSheetColors.length; i++)
        {
            if(i==(SelectedRowIndex+1))
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i-1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i+1];
            }
            else
            {
                oTempTechnicalSheetColors[i]=oTechnicalSheetColors[i];
            }
            oTempTechnicalSheetColors[i].Sequence=i+1;
        }
        data = oTempTechnicalSheetColors;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetColor').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex+1;
        $('#tblTechnicalSheetColor').datagrid('selectRow',newSelectedRowIndex);
    });
    $('#btnColorSequenceOk').click(function(e){
        var oTechnicalSheetColorList = [];
        var nMaxColorSequence = 0;
        var oTechnicalSheetColor = $('#tblTechnicalSheetColor').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetColor.length; i++) {
            nMaxColorSequence++;
            var oTSColor = {
                TechnicalSheetColorID: 0,
                TechnicalSheetID: 0,
                ColorCategoryID: oTechnicalSheetColor[i].ColorCategoryID,
                ColorName: oTechnicalSheetColor[i].ColorName,
                Sequence: nMaxColorSequence
            };
            oTechnicalSheetColorList.push(oTSColor);
        }
        $("#winColorSequence").icsWindow('close');
        $('#txtColorName').val(GetTSColorNames(oTechnicalSheetColorList));
        $('#txtColorName').addClass('fontColorOfPickItem');
        $('#txtSizeName').focus();
    });
    function AddToColorList(oColorCategory)
    {
        var oTechnicalSheetColors = $('#tblTechnicalSheetColor').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetColors.length; i++) {
            if (parseInt(oTechnicalSheetColors[i].ColorCategoryID) === parseInt(oColorCategory.ColorCategoryID)) {
                alert("Your Selected Color Already Exists!");
                return;
            }
        }
        var oTechnicalSheetColor = {
            TechnicalSheetColorID: 0,
            TechnicalSheetID: 0,
            ColorCategoryID: oColorCategory.ColorCategoryID,
            ColorName: oColorCategory.ColorName,
            Sequence: ($('#tblTechnicalSheetColor').datagrid('getRows').length+1)
        };
        $('#tblTechnicalSheetColor').datagrid('appendRow',oTechnicalSheetColor);
    }
    $('#btnColorPiker').click(function(e){
        var oColorCategory={ Param : '' };
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +  "/ColorCategory/SearchColor",
            traditional: true,
            data:  JSON.stringify(oColorCategory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oColorCategorys = jQuery.parseJSON(data);
                $('#tblColorBank').data('ColorCategorys', oColorCategorys);
                $("#winColorSequence").icsWindow('open', "Pick Color");
                DynamicRefreshList(oColorCategorys, 'tblColorBank');
                var oTechnicalSheetColors = $('#txtColorName').data('TechnicalSheetColors');
                DynamicRefreshList(oTechnicalSheetColors, 'tblTechnicalSheetColor');
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    $('#btnNewColorCategory').click(function(e){
        $("#winNewColor").icsWindow('open', "Add Color");
        $("#winNewColor input").not("input[type='button']").val("");
    });

    $('#btnNewColorSave').click(function(e){
        if($.trim($('#txtNewColorName').val())===null || $.trim($('#txtNewColorName').val())==="")
        {
            alert("Please Enter Color Name!");
            return;
        }
        var oColorCategory= {
            ColorCategoryID : 0,
            ColorName : $.trim($("#txtNewColorName").val()),
            Note : $.trim($("#txtNewColorNote").val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/ColorCategory/Save",
            traditional: true,
            data:  JSON.stringify(oColorCategory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oColorCategory = jQuery.parseJSON(data);
                if (oColorCategory.ErrorMessage == null || oColorCategory.ErrorMessage == "") {
                    alert("Data Saved sucessfully");
                    $("#winNewColor").icsWindow('close');
                    var nRowIndex = $('#tblColorBank').datagrid('getRows').length;
                    $('#tblColorBank').datagrid('appendRow',oColorCategory);
                    $('#tblColorBank').datagrid('selectRow',nRowIndex);
                }
                else {
                    alert(oColorCategory.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnNewColorClose').click(function(e){
        $("#winNewColor").icsWindow('close');
    });

    function GetTSSizeNames(oTechnicalSheetSizeList) {
        var sSizeName = "";
        for (var i = 0; i < oTechnicalSheetSizeList.length; i++) {
            sSizeName = sSizeName + oTechnicalSheetSizeList[i].SizeCategoryName + "; "
        }
        return sSizeName;
    }

    $('#txtSearchSizeSequence').keyup(function(e){
        var oSizeCategorys = $('#tblSizeBank').data('SizeCategorys');
        $('#txtSearchSizeSequence').icsSearchByText({
            Event: e,
            SearchProperty: "SizeName",
            GlobalObjectList: oSizeCategorys,
            TableId: "tblSizeBank"
        });
    });

    $('#btnSizeSequenceClose').click(function(e){
        $("#winSizeSequence").icsWindow('close');
    });

    $('#tblSizeBank').datagrid({
        onDblClickRow: function(index,row){
            AddToSizeList(row);
        }
    });

    $('#btnAddTSSize').click(function(e){
        var oSizeCategory = $('#tblSizeBank').datagrid('getSelected');
        if(oSizeCategory===null || parseInt(oSizeCategory.SizeCategoryID)<=0)
        {
            alert("Please select an Size category!");
            return;
        }
        AddToSizeList(oSizeCategory);
    });

    $('#btnSizeSequenceRemove').click(function(e){
        var oTechnicalSheetSize = $('#tblTechnicalSheetSize').datagrid('getSelected');
        if(oTechnicalSheetSize===null || parseInt(oTechnicalSheetSize.SizeCategoryID)<=0)
        {
            alert("Please select an Size category!");
            return;
        }

        var nRowIndex = $('#tblTechnicalSheetSize').datagrid('getRowIndex', oTechnicalSheetSize);
        $('#tblTechnicalSheetSize').datagrid('deleteRow', nRowIndex);

    });

    $('#btnSizeSequenceUp').click(function(e){
        var oTechnicalSheetSize = $('#tblTechnicalSheetSize').datagrid('getSelected');
        if(oTechnicalSheetSize==null || parseInt(oTechnicalSheetSize.SizeCategoryID)<=0)
        {
            alert("Please select Size");
            return;
        }

        var SelectedRowIndex=$('#tblTechnicalSheetSize').datagrid('getRowIndex',oTechnicalSheetSize);
        var oTempTechnicalSheetSizes = $('#tblTechnicalSheetSize').datagrid('getRows');
        if(SelectedRowIndex==0)return;
        var oTechnicalSheetSizes=[];
        oTechnicalSheetSizes=oTempTechnicalSheetSizes;
        oTempTechnicalSheetSizes=[];
        for(var i=0; i<oTechnicalSheetSizes.length; i++)
        {
            if(i==(SelectedRowIndex-1))
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i+1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i-1];
            }
            else
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i];
            }
            oTempTechnicalSheetSizes[i].Sequence=i+1;
        }

        data = oTempTechnicalSheetSizes;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetSize').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex-1;
        $('#tblTechnicalSheetSize').datagrid('selectRow',newSelectedRowIndex);
    });

    $('#btnSizeSequenceDown').click(function(e){
        var oTechnicalSheetSize = $('#tblTechnicalSheetSize').datagrid('getSelected');
        if(oTechnicalSheetSize==null || parseInt(oTechnicalSheetSize.SizeCategoryID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblTechnicalSheetSize').datagrid('getRowIndex',oTechnicalSheetSize);
        var oTempTechnicalSheetSizes = $('#tblTechnicalSheetSize').datagrid('getRows');
        if(SelectedRowIndex==(oTempTechnicalSheetSizes.length-1))return;
        var oTechnicalSheetSizes=[];
        oTechnicalSheetSizes=oTempTechnicalSheetSizes;
        oTempTechnicalSheetSizes=[];
        for(var i=0; i<oTechnicalSheetSizes.length; i++)
        {
            if(i==(SelectedRowIndex+1))
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i-1];
            }
            else if(i==SelectedRowIndex)
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i+1];
            }
            else
            {
                oTempTechnicalSheetSizes[i]=oTechnicalSheetSizes[i];
            }
            oTempTechnicalSheetSizes[i].Sequence=i+1;
        }
        data = oTempTechnicalSheetSizes;
        data={"total":""+data.length+"","rows":data};
        $('#tblTechnicalSheetSize').datagrid('loadData',data);
        var newSelectedRowIndex=SelectedRowIndex+1;
        $('#tblTechnicalSheetSize').datagrid('selectRow',newSelectedRowIndex);
    });

    $('#btnSizeSequenceOk').click(function(e){
        var oTechnicalSheetSizeList = [];
        var nMaxSizeSequence = 0;
        var oTechnicalSheetSize = $('#tblTechnicalSheetSize').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetSize.length; i++) {
            nMaxSizeSequence++;
            var oTSSize = {
                TechnicalSheetSizeID: 0,
                TechnicalSheetID: 0,
                SizeCategoryID: oTechnicalSheetSize[i].SizeCategoryID,
                SizeCategoryName: oTechnicalSheetSize[i].SizeCategoryName,
                Sequence: nMaxSizeSequence
            };
            oTechnicalSheetSizeList.push(oTSSize);
        }
        $("#winSizeSequence").icsWindow('close');
        $('#txtSizeName').val(GetTSSizeNames(oTechnicalSheetSizeList));
        $('#txtSizeName').addClass('fontColorOfPickItem');
        $('#txtReqQty').focus();
    });

    function AddToSizeList(oSizeCategory)
    {
        var oTechnicalSheetSizes = $('#tblTechnicalSheetSize').datagrid('getRows');
        for (var i = 0; i < oTechnicalSheetSizes.length; i++) {
            if (parseInt(oTechnicalSheetSizes[i].SizeCategoryID) === parseInt(oSizeCategory.SizeCategoryID)) {
                alert("Your Selected Size Already Exists!");
                return;
            }
        }
        var oTechnicalSheetSize = {
            TechnicalSheetSizeID: 0,
            TechnicalSheetID: 0,
            SizeCategoryID: oSizeCategory.SizeCategoryID,
            SizeCategoryName: oSizeCategory.SizeCategoryName,
            Sequence: ($('#tblTechnicalSheetSize').datagrid('getRows').length+1)
        };
        $('#tblTechnicalSheetSize').datagrid('appendRow',oTechnicalSheetSize);
    }

    $('#btnSizePiker').click(function(e){
        var oSizeCategory={ Param : '' };
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/SizeCategory/SearchSize",
            traditional: true,
            data:  JSON.stringify(oSizeCategory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oSizeCategorys = jQuery.parseJSON(data);
                $('#tblSizeBank').data('SizeCategorys', oSizeCategorys);
                $("#winSizeSequence").icsWindow('open', "Pick Size");
                DynamicRefreshList(oSizeCategorys, 'tblSizeBank');
                var oTechnicalSheetSizes = $('#txtSizeName').data('TechnicalSheetSizes');
                DynamicRefreshList(oTechnicalSheetSizes, 'tblTechnicalSheetSize');
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnNewSizeCategory').click(function(e){
        $("#winNewSize").icsWindow('open', "Add Size");
        $("#winNewSize input").not("input[type='button']").val("");
    });

    $('#btnNewSizeSave').click(function(e){
        if($.trim($('#txtNewSizeName').val())===null || $.trim($('#txtNewSizeName').val())==="")
        {
            alert("Please Enter Size Name!");
            return;
        }
        var oSizeCategory= {
            SizeCategoryID : 0,
            SizeCategoryName : $.trim($("#txtNewSizeName").val()),
            Note : $.trim($("#txtNewSizeNote").val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/SizeCategory/Save",
            traditional: true,
            data:  JSON.stringify(oSizeCategory),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oSizeCategory = jQuery.parseJSON(data);
                if (oSizeCategory.ErrorMessage == null || oSizeCategory.ErrorMessage == "") {
                    alert("Data Saved sucessfully");
                    $("#winNewSize").icsWindow('close');
                    var nRowIndex = $('#tblSizeBank').datagrid('getRows').length;
                    $('#tblSizeBank').datagrid('appendRow',oSizeCategory);
                    $('#tblSizeBank').datagrid('selectRow',nRowIndex);
                }
                else {
                    alert(oSizeCategory.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnNewSizeClose').click(function(e){
        $("#winNewSize").icsWindow('close');
    });

    var editIndex = undefined;
    function endEditing(){
        if (editIndex == undefined){return true}
        if ($('#tblBillOfMaterial').datagrid('validateRow', editIndex)){
            $('#tblBillOfMaterial').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRow(index){
        if (editIndex != index){
            if (endEditing())
            {
                $('#tblBillOfMaterial').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else
            {
                $('#tblBillOfMaterial').datagrid('selectRow', editIndex);
            }
        }
    }

    $("#btnAddBOMImage").click(function (e) {
        debugger;
        var oBillOfMaterial = $('#tblBillOfMaterial').datagrid('getSelected');
        if(oBillOfMaterial==null || parseInt(oBillOfMaterial.BillOfMaterialID)<=0)
        {
            alert("Please Select a BIll Of Material from List.");
            return;
        }

        var _formdata = new FormData();
        var fileInput = document.getElementById("fileInput");
        if (fileInput.files[0] != null)
        {
            _formdata.append(fileInput.files[0].name, fileInput.files[0]);
        }else{
            alert("Please Browse Image.");
            return;
        }
        var SelectedRowIndex=$('#tblBillOfMaterial').datagrid('getRowIndex',oBillOfMaterial);
        var tsv = ((new Date()).getTime()) / 1000;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', sessionStorage.getItem('BaseAddress') + '/BillOfMaterial/UpdateBOMImage?ts=' + tsv);
        xhr.setRequestHeader('BillOfMaterialID', oBillOfMaterial.BillOfMaterialID);
        xhr.send(_formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                debugger;
                alert("Data Save Successfully");
                var oBillOfMaterial = MakeBOMObject(xhr.responseText);
                $('#tblBillOfMaterial').datagrid('updateRow',{index:SelectedRowIndex,row:oBillOfMaterial});
                $("#fileInput")[0].value = null;
            }
        }
    });

    function MakeBOMObject(sText) {
        debugger;
        var sSeparetedText = sText.split('~');

        var oBillOfMaterial = {
            BillOfMaterialID : sSeparetedText[1],
            TechnicalSheetID : sSeparetedText[2],
            ProductID : sSeparetedText[3],
            ColorID : sSeparetedText[4],
            SizeID : sSeparetedText[5],
            ItemDescription : sSeparetedText[6],
            Reference : sSeparetedText[7],
            Construction : sSeparetedText[8],
            Sequence : sSeparetedText[9],
            MUnitID : sSeparetedText[10],
            ReqQty : sSeparetedText[11],
            CuttingQty : sSeparetedText[12],
            ConsumptionQty : sSeparetedText[13],
            ProductCode : sSeparetedText[14],
            ProductName : sSeparetedText[15],
            ColorName : sSeparetedText[16],
            SizeName : sSeparetedText[17],
            Symbol : sSeparetedText[18],
            UnitName : sSeparetedText[19],
            IsAttachmentExist : sSeparetedText[20]
        };
        return oBillOfMaterial;
    }

    function FormatDownload(value)
    {
        debugger;
        var nBOMID =parseInt(value);
        var s = '';
        if(nBOMID>0)
        {
            s = '<input type="image" src="@Url.Content("~/Content/CSS/icons/down.png")"   onclick="DownLoadAttachment('+nBOMID+')", value="" id="btnDownload"'+nBOMID+'/>';
            s += '<input type="image" src="@Url.Content("~/Content/CSS/icons/edit_remove.png")"   onclick="DeleteAttachment('+nBOMID+')", value="" id="btnDelete"'+nBOMID+'/> ';
        }
        return s;
    }

    function DownLoadAttachment(nBOMID)
    {
        debugger;
        if(nBOMID==null || parseInt(nBOMID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        var oParameter = new Object();
        var tsv= ((new Date()).getTime())/1000;
        var url =_sBaseAddress+  "/BillOfMaterial/DownloadBOMAttachment?id="+ nBOMID+"&ts="+tsv;
        window.open(url, '_blank');
    }
    function DeleteAttachment(nBOMID)
    {
        debugger;
        if(nBOMID==null || parseInt(nBOMID)<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var oBillOfMaterial = $('#tblBillOfMaterial').datagrid('getSelected');
        var SelectedRowIndex = $('#tblBillOfMaterial').datagrid('getRowIndex', oBillOfMaterial);
        var tsv= ((new Date()).getTime())/1000;
        $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/BillOfMaterial/DeleteBOMAttachment",
                data: { id: nBOMID,ts:tsv},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    debugger;
                    oBillOfMaterial = jQuery.parseJSON(data);
                    if (oBillOfMaterial.ErrorMessage=="")
                    {
                        alert("Sucessfully Image Deleted");
                        $('#tblBillOfMaterial').datagrid('updateRow',{index: SelectedRowIndex,row: oBillOfMaterial});
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });

        //window.open(url, '_blank');
    }

</script>