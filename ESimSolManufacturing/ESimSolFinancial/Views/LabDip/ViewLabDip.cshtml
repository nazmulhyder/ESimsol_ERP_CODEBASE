<html>
<head>
    <title>Labdip Order</title>
</head>
<body>
    @model ESimSol.BusinessObjects.LabDip
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <fieldset>
            <legend style="font-weight:bold"> LabDip entry: </legend>
            <table style="width:100%">
                <tr>
                    <td class="td-col-2 align-right">
                        <label id="lblLabdipOrderNo">LabDip No</label>
                    </td>
                    <td class="td-styler td-col-2">
                        <input type="text" id="txtLabdipNo" class="reset-text" disabled />
                    </td>
                    <td class="td-col-1 align-right">
                        <label>Date</label>
                    </td>
                    <td class="td-styler td-col-2">
                        <input  id="dtOrderDate" type="text" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </td>
                    <td class="td-col-2 align-right">
                        <input id="chkIsTwisted" type="checkbox" />
                        
                        <label>Is Twisted</label>
                    </td>
                    <td class="td-styler td-col-3">
                        <select id="cboFormat" ></select>
                    </td>
                    <td class="td-col-2 align-right">
                        <label>Concern Person</label>
                    </td>
                    <td class="td-styler td-col-6">
                        <input type="text" id="txtMktAccount" class="reset-text" placeholder="Search Mkt Person" />
                        <a id="btnPickMktAccount" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetMktPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                </tr>

                <tr>
                    <td class="td-col-2 align-right">
                        <label>Issue To</label>
                    </td>
                    <td colspan="5" class="td-styler td-col-13">
                        <input type="text" id="txtIssueTo" class="reset-text" placeholder="Search Issue To" />
                        <a id="btnPickIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                    <td class="td-styler td-col-2 align-right">
                        <label>Concer Person</label>
                    </td>
                    <td class="td-styler td-col-3">
                        <select style="width: 73%;" id="cboCPIssueTo"></select>
                        <a id="btnAddContractorContactPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" onclick="AddContactPerson(false)" iconcls="icon-add" plain="true"></a>
                    </td>
                </tr>
                <tr>
                    <td class="td-col-2 align-right">
                        <label>Deliver To</label>
                    </td>
                    <td colspan="5" class="td-styler td-col-13">
                        <input type="text" id="txtDeliverTo" class="reset-text" placeholder="Search Delivery To" />
                        <a id="btnPickDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                        
                    </td>
                    <td class="td-col-2 align-right">
                        <label>Concern Person</label>
                    </td>
                    <td class="td-styler td-col-3">
                        <select style="width: 73%;" id="cboCPDeliverTo"></select>
                        <a id="btnAddBuyerContactPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" onclick="AddContactPerson(true)" iconcls="icon-add" plain="true"></a>
                    </td>
                </tr>

                <tr class="send-to">
                    <td class="td-col-2 align-right">
                        <label>Delivery Note.</label>
                    </td>
                    <td colspan="5" class="td-styler td-col-13">
                        <input type="text" id="txtDeliveryZone" class="reset-text" placeholder="Place, Contract No etc." style="width:60%" />
                        <a id="btnPickDeliveryZone" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnReseDeliveryZone" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>

                    </td>
                    <td class="td-col-2 align-right">
                        <label>Requirement</label> 
                    </td>
                    <td class="td-styler td-col-3">
                        <div style="float:left; width:100%">
                            <div style="float:left; width:33%">
                                <input id="dtSeekingDate" type="text" class="easyui-datebox" style="width: 110px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </div>
                            <div style="float:left; width:28%; text-align:right; padding-right:1px;">Priority</div>
                            <div style="float:left; width:25%"><select id="cboPriorityLevel"></select></div>
                        </div>
                    </td>
                </tr>

                <tr class="hp-ph">
                   

                    <td class="td-col-2 align-right">
                        <label>Light Source</label>
                    </td>
                    <td colspan="2" class="td-styler td-col-8">
                        <select id="cboLightSource"></select>
                    </td>
                    <td class="td-col-2 align-right">
                        <label>Buyer Ref</label>
                    </td>
                    <td colspan="2" class="td-styler td-col-3">
                        <input id="txtBuyerRef" type="text" class="reset-text" placeholder="Type Buyer Reference" />
                    </td>
                    <td class="td-col-2 align-right">
                        <label>Master Buyer</label>
                    </td>
                    <td  class="td-styler td-col-3">
                        <input id="txtPH" class="reset-text" type="text" placeholder="" />
                    </td>
                </tr>
                <tr class="hp-ph">
                    <td class="td-col-2 align-right">
                        <label>Note</label>
                    </td>
                    <td colspan="7" class="td-styler td-col-18 td-Note">
                        <input type="text" id="txtNote" class="reset-text" placeholder="Type Note" />
                    </td>
                </tr>

            </table>
        </fieldset>

        <fieldset>
            <legend>LabDip Detail</legend>

            <table style="width:100%">
                <tr>
                    <td style=" float:left; width:8%;">
                        <label>Product</label>
                    </td>
                    <td style="float:left; width:27%;">
                        <input id="txtProduct" style="float:left; width:75%;" type="text" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                    <td style=" float:left; width:10%;">
                        <label>Knit/Ply/Yarn</label>
                    </td>
                    <td style="float:left; width:15%;">
                        <select id="cboKnitPly"></select>
                    </td>

                    <td style=" float:right; width:40%;">
                        <div style="width:100%;">
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>Color Set</label>
                            </div>
                            <div style=" float:left; width:10%;" class="align-right">
                                <input id="txtColorSet" type="number" min="0" pattern="^[0-9]" step="1" class="only-number combo-number" />
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>Shade</label>
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <input id="txtShadeCount" type="number" min="0" pattern="^[0-9]" step="1" class="only-number combo-number" />
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>No. Ply</label>
                            </div>
                            <div style=" float:left; width:16%; " class="align-right">
                                <input id="txtCombo" type="number" min="0" pattern="^[0-9]" step="1" class="only-number combo-number" />
                            </div>
                        </div>
                    </td>

                </tr>
                <tr>
                    <td style=" float:left; width:8%;">
                        <label>Color Name </label>
                    </td>
                    <td style=" float:left; width:27%;">
                        <input type="text" id="txtLDCode" class="reset-text" style="width:18%;" placeholder="Code search" />
                        <a id="btnPickLDCode" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true"></a>
                        <input type="text" id="txtColorName" class="reset-text" style="width:60%;" placeholder="Type Color Name" />
                    </td>
                    <td style=" float:left; width:10%;">
                        <label>Panton No</label>

                    </td>
                    <td style=" float:left; width:15%;">
                        <input type="text" id="txtPantonNo" class="reset-text" placeholder="" />
                    </td>

                    <td style=" float:right; width:40%;">
                        <div style="width:100%;">
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>Gauge No</label>
                            </div>
                            <div style=" float:left; width:10%;" class="align-right">
                                <input  id="txtGauge" type="number" min="0" pattern="^[0-9]" step="1" class="only-number combo-number" />
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>Knit Style</label>
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <input type="text" id="txtRGB" class="reset-text custom-styler" placeholder="Type Style" />
                            </div>
                            <div style=" float:left; width:16%;" class="align-right">
                                <label>Remarks</label>
                            </div>
                            <div style=" float:left; width:16%; " class="align-right">
                                <input type="text" id="txtReftNo" class="reset-text custom-styler" placeholder="" />
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        
        </fieldset>
        <div style="padding-left:2px; padding-right:2px;">
            <table id="tblLabDipDetail" class="easyui-datagrid" style="height: 210px; width:100%;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar" data-options="onLoadSuccess: onLoadSuccess">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"> </th>
                        <th field="ProductNameCode" width="20%" align="left">Product Name</th>
                        <th field="TwistedGroup" width="6%" align="center" formatter="formatTwisted">Twisted</th>
                        <th field="ColorCode" width="6%" align="center">Code</th>
                        <th field="ColorNo" width="10%" align="center"><label id="lblColorNoName">Color No</label></th>
                        <th field="LDNo" width="10%" align="center"><label id="lblColorNoNameTwo">Color No</label></th>
                        <th field="ColorName" width="8%" align="center">Color Name</th>
                        <th field="PantonNo" width="9%" align="center">Panton No</th>
                        <th field="RGB" width="6%" align="center">Kint Style</th>
                        <th field="ColorSet" width="6%" align="center">Color Set</th>
                        <th field="ShadeCount" width="6%" align="center">Shade</th>
                        <th field="Gauge" width="6%" align="center">Gauge</th>
                        <th field="KnitPlyYarnInString" width="8%" align="center">Knit Ply</th>
                        <th field="RefNo" width="9%" align="center">Remarks</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar">
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true"><label id="lblEditUpdate">Edit</label></a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnMakeTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Create Twisted</a>
                <a id="btnRemoveTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Remove Twisted</a>
                
            </div>
        </div>
        <fieldset>
            <legend>Action</legend>
            <table border="0" cellpadding="0" cellspacing="0" style="float:right; width:100%;">
                <tr>
                    <td style=" float:left;  width:20%; ">
                        <a id="btnNew" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New</a>
                        @*<a id="btnColorNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Change Color No</a>*@
                    </td>
                    <td style="float:left;  width:10%; ">
                        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                    </td>
                    <td style="width:70%;float:right; text-align:right">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>        
           
        </fieldset>
    </div>
    <div id="winContactPersonnel" class="easyui-window" title="Add Contact Personeel" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div>
            <fieldset>
                <legend style="font-weight:bold"> Contact Personnel Informations : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold">
                    <tr>
                        <td style="width:125px; text-align:right">
                            Name :
                        </td>

                        <td style="width:200px">
                            <input type="text" style="width: 200px;" id="txtName" />
                        </td>
                        <td style="width:50px"> </td>
                        <td style="width:125px; text-align:right">
                            Address :
                        </td>
                        <td style="width:300px">
                            <input type="text" style="width: 300px;" id="txtAddress" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:125px; text-align:right">
                            Phone :
                        </td>

                        <td style="width:200px">
                            <input type="text" style="width: 200px;" id="txtPhone" />
                        </td>
                        <td style="width:50px"> </td>
                        <td style="width:125px; text-align:right">
                            Email :
                        </td>
                        <td style="width:300px">
                            <input type="text" style="width: 300px;" id="txtEmail" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:125px; text-align:right">
                            Note :
                        </td>
                        <td colspan="4">
                            <input type="text" style="width: 690px;" id="txtNote" />
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
        <fieldset style="width:97%;height:8%; vertical-align:top;">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:7%;text-align:right;">
                        <a id="btnAddContactPersonnel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="AddContactPersonnel()">Save</a>
                        <a id="btnCloseContactPersonnel" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="CloseContactPersonnel()">Close</a>
                    </td>

                </tr>
            </table>
        </fieldset>
    </div>
    <div id="winDeliveryZone" style="width:500px;" class="easyui-window" title="Order" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div>
            <fieldset>
                <legend style="font-weight:bold"> Delivery Place/Zone: </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold">

                    <tr>
                        <td style="width:30%;text-align:right">
                            Zone/Place/Address/Con. No:
                        </td>

                        <td style="width:70%">
                            <input id="txtDeliveryZoneNew" type="text" style="width:100%" />
                        </td>

                    </tr>


                </table>
            </fieldset>
        </div>
        <fieldset>
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:100%;text-align:right;">
                        <a id="btnSaveDeliveryZone" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnCloseDeliveryZone" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>

                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>

<style type="text/css">
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }

    .td-col-3 input {
        width: 92%;
    }

    .td-col-6 input {
        width: 70%;
    }

    .td-col-13 input {
        width: 86%;
    }

    .send-to .td-col-13 input {
        width: 85.7%;
    }


    .hp-ph .td-col-8 input {
        width: 66%;
    }

    .hp-ph .td-col-8 select {
        width: 96%;
    }

    .td-Note input {
        width: 97.5%;
    }

    .td-col-13 select {
        width: 15%;
    }

    .td-product input {
        width: 66%;
    }

    .td-KnitPly select {
        width: 95%;
    }
    .combo-number{
        width:85%;
    }

    .td-ColorName input{
        width: 90%;
    }

    .td-PantonNo-Ref input {
        width: 34.5%;
    }
    .custom-styler{
        width:85%;
    }
</style>

<script type="text/javascript">

    var _sBaseAddress = "";
    var _oLabDip=null;
    var _oLabDipDetail=null;
    var _nMktPersonID=0;
    var _nContractorID=0;
    var _nDeliveryToID=0;
    var _nDeliveryZoneID=0;
    var _nProductID=0;
    var _nLabdipColorID=0;
    var _oCPIssueTos=[];
    var _oCPDeliveryTos=[];
    var _oCellRowSpans=[];
    var _oLabDipSetup=null;
    $(document).ready(function () {

        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oLabDip =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oCPIssueTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPIssueTos));
        _oCPDeliveryTos =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CPDeliveryTos));
        var oLightSources=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LightSources));
        var oLabdipFormats =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumLabdipFormats));
        var oPriorityLevels =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumPriorityLevels));
        var oKnitPlyYarns =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumKnitPlyYarns));
        _oLabDipSetup =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LabDipSetup));
        debugger;
        LabdipSetup();
        //$('.number').icsCurrencyBox();
        //parseFloat(icsRemoveComma($('#txtBillAmount').val()))
        $("#cboLightSource").icsLoadCombo({
            List: oLightSources,
            OptionValue: "LightSourceID",
            DisplayText: "Descriptions",
        });

        $("#cboFormat").icsLoadCombo({
            List: oLabdipFormats,
            OptionValue: "id",
            DisplayText: "Value",

        });

        $("#cboPriorityLevel").icsLoadCombo({
            List: oPriorityLevels,
            OptionValue: "id",
            DisplayText: "Value",
        });

        $("#cboKnitPly").icsLoadCombo({
            List: oKnitPlyYarns,
            OptionValue: "id",
            DisplayText: "Value",
        });
        Initialization(oLabDip,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'));
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();


    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winLabDipOrder').icsWindow('close'); } });

    function LabdipSetup()
    {
        if(_oLabDipSetup.IsApplyCode)
        {
            $('#txtLDCode').show();
            $('#btnPickLDCode').show();
            $("#tblLabDipDetail").datagrid("showColumn", "ColorCode");
            $("#tblLabDipDetail").datagrid("showColumn", "LDNo");
        }
        else{
            $('#txtLDCode').hide();
            $('#btnPickLDCode').hide();
            $("#tblLabDipDetail").datagrid("hideColumn", "ColorCode");
            $("#tblLabDipDetail").datagrid("hideColumn", "LDNo");
        }
        $('#lblColorNoName').html(_oLabDipSetup.ColorNoName);
        $('#lblLabdipOrderNo').html(_oLabDipSetup.OrderName);
    }

    $('#tblLabDipDetail').datagrid({selectOnCheck:false, checkOnSelect:false});

    function Initialization(oLabDip, sOperation){
        ResetControll();
        if(oLabDip.LabDipID>0){
            RefreshControl(oLabDip);
        }
        else{
            $('#cboPriorityLevel').val(oLabDip.PriorityLevel);
        }
        if(sOperation=="View")
        {
            $('#toolbar,#btnSave,.ics-pick').hide();
            $('input,select').not('#txtLabdipNo').prop('disabled',true);
            $('.td-col-6 input').css('width','92%');
        }
        else{
            $('#toolbar,#btnSave,.ics-pick').show();
            $('input,select').not('#txtLabdipNo').prop('disabled',false);
            $('.td-col-6 input').css('width','70%');
        }
    }


    function LoadIssueContactPersonnel(oCPs){
        $("#cboCPIssueTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }

    function LoadDeliveredContactPersonnel(oCPs){
        $("#cboCPDeliverTo").icsLoadCombo({
            List: oCPs,
            OptionValue: "ContactPersonnelID",
            DisplayText: "Name",
            InitialValue:""
        });
    }


    function ResetControll(){
        _oLabDip=null;
        _nMktPersonID=0;
        _nContractorID=0;
        _nDeliveryToID=0;
        _nDeliveryZoneID=0;
        $('.reset-text').val("");
        $('#chkIsTwisted').prop('checked',false);
        $('#dtOrderDate,#dtSeekingDate').datebox('setValue', icsdateformat(new Date()));
        LoadIssueContactPersonnel(_oCPIssueTos);
        LoadDeliveredContactPersonnel(_oCPDeliveryTos);
        $('.number').val("0.00");
        ResetDetail(true);
        _oCellRowSpans=[];
        LabdipFormat();
        DynamicRefreshList([], 'tblLabDipDetail');
    }

    function RefreshControl(oLabDip){
        _oLabDip=oLabDip;
        _nMktPersonID=oLabDip.MktPersonID;
        _nContractorID=oLabDip.ContractorID;
        _nDeliveryToID=oLabDip.DeliveryToID;
       
        $('#txtLabdipNo').val(oLabDip.LabdipNo);
        $('#dtOrderDate').datebox('setValue',oLabDip.OrderDateStr);

        $('#chkIsTwisted').prop('checked',oLabDip.ISTwisted);
        $('#cboFormat').val(oLabDip.LabDipFormat);
        $('#txtMktAccount').val(oLabDip.MktPerson);


        $('#txtIssueTo').val(oLabDip.ContractorName);
        $('#txtDeliverTo').val(oLabDip.DeliveryToName);
        $('#txtDeliveryZone').val(oLabDip.DeliveryNote);


        $('#cboCPIssueTo').val(oLabDip.ContactPersonnelID);
        $('#cboCPDeliverTo').val(oLabDip.DeliveryToContactPersonnelID);

        $('#dtSeekingDate').datebox('setValue',oLabDip.SeekingDateStr);
        $('#cboPriorityLevel').val(oLabDip.PriorityLevel);

        $('#txtPH').val(oLabDip.PH);
        $('#cboLightSource').val(oLabDip.LightSourceID);
        $('#txtBuyerRef').val(oLabDip.BuyerRefNo);
        $('#txtNote').val(oLabDip.Note);

        if(oLabDip.LabDipDetails.length>0 && oLabDip.LabDipDetails[0].LabDipDetailID>0 && oLabDip.ISTwisted){
            _oCellRowSpans=oLabDip.LabDipDetails[0].CellRowSpans;
        }
        else{
            _oCellRowSpans=[];
        }
        DynamicRefreshList(oLabDip.LabDipDetails, 'tblLabDipDetail');
        LabdipFormat();
    }



    function Validation(){

        if($('#cboFormat').val()<=0){
            $('#cboFormat').focus();
            $('#cboFormat').addClass("errorFieldBorder");
            alert('Select labdip format.');
            return false;
        }
        else{
            $('#cboFormat').removeClass("errorFieldBorder");
        }

        if(_nMktPersonID<=0){
            $('#txtMktAccount').focus();
            $('#txtMktAccount').addClass("errorFieldBorder");
            alert('Mkt person required.');
            return false;
        }
        else{
            $('#txtMktAccount').removeClass("errorFieldBorder");
        }

        if(_nContractorID<=0){
            $('#txtIssueTo').focus();
            $('#txtIssueTo').addClass("errorFieldBorder");
            alert('Labdip issue to required.');
            return false;
        }
        else{
            $('#txtIssueTo').removeClass("errorFieldBorder");
        }

        if(_nDeliveryToID<=0){
            $('#txtDeliverTo').focus();
            $('#txtDeliverTo').addClass("errorFieldBorder");
            alert('Labdip delivery to required.');
            return false;
        }
        else{
            $('#txtDeliverTo').removeClass("errorFieldBorder");
        }

        if( new Date($('#dtOrderDate').datebox('getValue')) > new Date($('#dtSeekingDate').datebox('getValue'))){

            alert('Requirement date must be greater than order date.');
            return false;
        }

        if($('#cboPriorityLevel').val()<=0){
            $('#cboPriorityLevel').focus();
            $('#cboPriorityLevel').addClass("errorFieldBorder");
            alert('Select priority level.');
            return false;
        }
        else{
            $('#cboPriorityLevel').removeClass("errorFieldBorder");
        }
        return true;
    }

    function RefreshObject()
    {
        var oLabDip={
            LabDipID: (_oLabDip!=null && _oLabDip.LabDipID>0)? _oLabDip.LabDipID:0,
            MktPersonID:_nMktPersonID,
            ContractorID: _nContractorID,
            ContactPersonnelID: $('#cboCPIssueTo').val(),
            DeliveryToID:_nDeliveryToID,
            DeliveryToContactPersonnelID:$('#cboCPDeliverTo').val(),
            DeliveryZoneID:_nDeliveryZoneID,
            RelabOn:(_oLabDip!=null && _oLabDip.LabDipID>0)? _oLabDip.RelabOn:0,
            PH: $.trim($('#txtPH').val()),
            LightSourceID:$('#cboLightSource').val(),
            BuyerRefNo:$.trim($('#txtBuyerRef').val()),
            PriorityLevel:$('#cboPriorityLevel').val(),
            Note:$.trim($('#txtNote').val()),
            LabDipFormat:$('#cboFormat').val(),
            SeekingDate:$('#dtSeekingDate').datebox('getValue'),
            OrderDate:$('#dtOrderDate').datebox('getValue'),
            ISTwisted:$('#chkIsTwisted').is(':checked'),
            DeliveryNote: $.trim($('#txtDeliveryZone').val()), 
            IsInHouse:false,
            FabricID:(_oLabDip!=null && _oLabDip.FabricID>0)? _oLabDip.FabricID:0  //, _oLabDip.FabricID

        };
        return oLabDip;
    }

    $("#btnSave").click(function (){
        if(!Validation()) return false;

        var oLabDip=RefreshObject();
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDip,
            ObjectId: oLabDip.LabDipID,
            ControllerName: "LabDip",
            ActionName: "Save",
            TableId: "",
            IsWinClose: false,
            Message: (oLabDip.LabDipID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.LabDipID > 0) {
                    var oLabDipDetails=$('#tblLabDipDetail').datagrid('getRows');
                    if(!response.obj.ISTwisted && oLabDipDetails.length>0){
                        for(var i=0;i<oLabDipDetails.length;i++){
                            oLabDipDetails[i].TwistedGroup=0;
                        }
                    }
                    response.obj.LabDipDetails=oLabDipDetails;
                    RefreshControl(response.obj);
                    SetIntoSessionStorage();
                }
            }
        });
    });


    function ResetDetail(bIsProductReset){
        _oLabDipDetail=null;
        if(bIsProductReset){
            _nProductID=0;
            _nLabdipColorID=0;
            $('#txtProduct').val("");
            $('#txtLDCode').val("");
        }

        //$('#cboKnitPly').val(0);
        $('#txtColorSet,#txtShadeCount').val(3);
        $('#txtCombo,#txtGauge').val(1);
        $('#txtColorName,#txtRGB,#txtPantonNo,#txtReftNo').val("");
        $('#lblEditUpdate').text('Edit');
    }

    function ValidationDetail(){

        if(_nProductID<=0){
            $('#txtProduct').focus();
            $('#txtProduct').addClass("errorFieldBorder");
            alert('No product found.');
            return false;
        }
        else{
            $('#txtProduct').removeClass("errorFieldBorder");
        }
        if($.trim($('#txtColorName').val())==""){
            $('#txtColorName').focus();
            $('#txtColorName').addClass("errorFieldBorder");
            alert('Color name required.');
            return false;
        }
        else{
            $('#txtColorName').removeClass("errorFieldBorder");
        }

        //if(_oLabDipSetup.IsApplyCode==true && _nLabdipColorID<=0){
        //    $('#txtLDCode').focus();
        //    $('#txtLDCode').addClass("errorFieldBorder");
        //    alert('No Color Code found.');
        //    return false;
        //}
        //else{
        //    $('#txtLDCode').removeClass("errorFieldBorder");
        //}


        //if($.trim($('#txtRGB').val())==""){
        //    $('#txtRGB').focus();
        //    $('#txtRGB').addClass("errorFieldBorder");
        //    alert('RGB required.');
        //    return false;
        //}
        //else{
        //    $('#txtRGB').removeClass("errorFieldBorder");
        //}

        if($.trim($('#txtPantonNo').val())==""){
            $('#txtPantonNo').focus();
            $('#txtPantonNo').addClass("errorFieldBorder");
            alert('Panton no required.');
            return false;
        }
        else{
            $('#txtPantonNo').removeClass("errorFieldBorder");
        }

        return true;
    }

    function RefreshObjectDetail(){


        var oLabDipDetail={
            LabDipDetailID:(_oLabDipDetail!=null && _oLabDipDetail.LabDipDetailID>0)? _oLabDipDetail.LabDipDetailID:0,
            LabDipID: (_oLabDip!=null && _oLabDip.LabDipID>0)? _oLabDip.LabDipID:0,
            ProductID:_nProductID,
            LabdipColorID:_nLabdipColorID,
            ColorSet:$('#txtColorSet').val(),
            ShadeCount:$('#txtShadeCount').val(),
            KnitPlyYarn:$('#cboKnitPly').val(),
            ColorNo:$.trim($('#txtLDCode').val()),
            ColorName:$.trim($('#txtColorName').val()),
            RefNo:$.trim($('#txtReftNo').val()),
            PantonNo:$.trim($('#txtPantonNo').val()),
            RGB:$.trim($('#txtRGB').val()),
            Combo:$('#txtCombo').val(),
            Gauge:$('#txtGauge').val(),
            LabDip:(_oLabDip==null || _oLabDip.LabDipID<=0)? RefreshObject() : null
        }
        return oLabDipDetail;
    }

    function SaveLabDipDetail(bIsUpdate){
        debugger;

        if(!Validation()) return false;
        if (!ValidationDetail()) return false;
        var oLabDipDetail = RefreshObjectDetail();
        oLabDipDetail.LabDipDetailID= (bIsUpdate)? oLabDipDetail.LabDipDetailID: 0;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDipDetail,
            ObjectId: oLabDipDetail.LabDipDetailID,
            ControllerName: "LabDip",
            ActionName: "SaveDetail",
            TableId: ((oLabDipDetail.LabDip==null)?"tblLabDipDetail":""),
            IsWinClose: false,
            Message: ""// (oLabDipDetail.LabDipDetailID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.LabDipDetailID > 0) {
                    if(response.obj.LabDip.LabDipID>0)
                    {
                        var oLabDip=response.obj.LabDip;
                        response.obj.LabDip=null;
                        $('#tblLabDipDetail').datagrid('appendRow',response.obj);
                        oLabDip.LabDipDetails=$('#tblLabDipDetail').datagrid('getRows');
                        RefreshControl(oLabDip);
                        SetIntoSessionStorage();
                    }
                    else if(response.obj.TwistedGroup>0){
                        DynamicRefreshList($('#tblLabDipDetail').datagrid('getRows'), 'tblLabDipDetail');
                    }
                    ResetDetail(false);
                    //$('#txtLDCode').val(response.obj.ColorCode);
                    $('#txtColorName').focus();
                }
            }
        });
    }

    $("#btnAddDetail").click(function () {
        SaveLabDipDetail(false);
    });

    $('#btnEditDetail').click(function(e){

        if($('#lblEditUpdate').text()=='Edit'){
            var oLabDipDetail = $("#tblLabDipDetail").datagrid("getSelected");
            if (oLabDipDetail == null || oLabDipDetail.LabDipDetailID <= 0) { alert("Please select an item from list!"); return false; }
            ResetDetail(true);
            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oLabDipDetail,
                ControllerName: "LabDip",
                ActionName: "GetLabDipDetail",
                IsWinClose: false
            };

            $.icsDataGet(obj, function (response) {

                if (response.status && response.obj != null) {
                    if (response.obj.LabDipDetailID > 0) {
                        _oLabDipDetail=response.obj;
                        _nProductID=response.obj.ProductID;
                        $('#txtProduct').val(response.obj.ProductNameCode);
                        $('#txtColorSet').val(response.obj.ColorSet);
                        $('#txtShadeCount').val(response.obj.ShadeCount);
                        $('#cboKnitPly').val(response.obj.KnitPlyYarn);
                        $('#txtColorName').val(response.obj.ColorName);
                        $('#txtLDCode').val(response.obj.ColorCode);
                        $('#txtReftNo').val(response.obj.RefNo);
                        $('#txtPantonNo').val(response.obj.PantonNo);
                        $('#txtRGB').val(response.obj.RGB);
                        $('#txtCombo').val(response.obj.Combo);
                        $('#txtGauge').val(response.obj.Gauge);
                        $('#lblEditUpdate').text('Update');
                    }
                    else { alert(response.obj.ErrorMessage); }
                }
            });
        }
        else{
            SaveLabDipDetail(true);
        }

    });

    $("#btnRemoveDetail").click(function () {

        var oLabDipDetail = $("#tblLabDipDetail").datagrid("getSelected");
        if (oLabDipDetail == null || oLabDipDetail.LabDipDetailID <= 0) { alert("Please select an item from list!"); return false; }

        if (!confirm("Confirm to Delete?")) return false;
        var nIndex = $("#tblLabDipDetail").datagrid("getRowIndex", oLabDipDetail);
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oLabDipDetail,
            ControllerName: "LabDip",
            ActionName: "DeleteDetail",
            TableId: "tblLabDipDetail",
            IsWinClose: false,
            Message:''
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message == 'deleted') {

                for(var i=0;i<_oCellRowSpans.length;i++){
                    var oMCell=[_oCellRowSpans[i].mergerCell];
                    debugger;
                    if(nIndex>=oMCell[0][0] && nIndex<=(oMCell[0][0]+oMCell[0][1])){
                        oMCell[0][0]= oMCell[0][0];
                        oMCell[0][1]= oMCell[0][1]-1;
                        [_oCellRowSpans[i].mergerCell]=oMCell;
                    }
                }
                var oLabdipdetails=$('#tblLabDipDetail').datagrid('getRows');
                var nTwistedCount=0;
                for(var i=0;i<oLabdipdetails.length;i++){
                    if(oLabDipDetail.TwistedGroup==oLabdipdetails[i].TwistedGroup){
                        ++nTwistedCount;
                    }
                }

                if(nTwistedCount==1){
                    for(var i=0;i<oLabdipdetails.length;i++){
                        if(oLabDipDetail.TwistedGroup==oLabdipdetails[i].TwistedGroup){
                            oLabdipdetails[i].TwistedGroup=0;
                            break;
                        }
                    }
                }
                DynamicRefreshList(oLabdipdetails, 'tblLabDipDetail');
            }
        });



    });



    $("#btnResetMktPerson").click(function () {

        $("#txtMktAccount").val("");
        _nMktPersonID=0;
    });

    $("#btnPickMktAccount").click(function () {

        var sName=$.trim($("#txtMktAccount").val());
        GetMktPersons(sName);
    });

    $("#txtMktAccount").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sName=$.trim($("#txtMktAccount").val());
            GetMktPersons(sName);
        }
        else if(nkeyCode==8){
            
            _nMktPersonID=0;
        }
    });

    function GetMktPersons(sName){

        debugger;
        var oMarketingAccount_BU = {
            Name:sName,
            Params:'',
            BUID:sessionStorage.getItem("BUID")
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMarketingAccount_BU,
            ControllerName: "MarketingAccount",
            ActionName: "MarketingAccountSearchByName",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].MarketingAccountID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "MarketingAccountID", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 250, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 100, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMktPersonPicker',
                        winclass:'clsMktPersonPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblMktPersonPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'MKT Person List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeMktPersonPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No marketing person found.");
            }
        });


    }

    function IntializeMktPersonPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            MktPersonSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                MktPersonSelect(oPickerobj);
            }
        });
    }

    function MktPersonSelect(oPickerobj){
        var oEmployee = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winMktPersonPicker')
        {
            if(oEmployee !=null  && oEmployee.MarketingAccountID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtMktAccount').val(oEmployee.Name);
                _nMktPersonID= oEmployee.MarketingAccountID;
                $('#txtMktAccount').focus();
            }
            else{
                alert("Please select Mkt Person.");
            }
        }
    }




    $("#btnResetIssueTo").click(function () {
        $("#txtIssueTo").val("");
        _nContractorID=0;
        _oCPIssueTos=[];
        LoadIssueContactPersonnel(_oCPIssueTos);
    });

    $("#btnPickIssueTo").click(function () {

        var sContractorName=$.trim($("#txtIssueTo").val());
        GetContractors(sContractorName, true);
    });

    $("#txtIssueTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtIssueTo").val());
            GetContractors(sContractorName,true);
        }
        else if(nkeyCode==8){
           
            _nContractorID=0;
            _oCPIssueTos=[];
            LoadIssueContactPersonnel(_oCPIssueTos);
        }
    });



    $("#btnResetDeliverTo").click(function () {
        $("#txtDeliverTo").val("");
        _nDeliveryToID=0;
        _oCPDeliveryTos=[];
        LoadDeliveredContactPersonnel(_oCPDeliveryTos);
    });

    $("#btnPickDeliverTo").click(function () {
        var sContractorName=$.trim($("#txtDeliverTo").val());
        GetContractors(sContractorName, false);
    });

    $("#txtDeliverTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtDeliverTo").val());
            GetContractors(sContractorName,false);
        }
        else if(nkeyCode==8){
           
            _nDeliveryToID=0;
            _oCPDeliveryTos=[];
            LoadDeliveredContactPersonnel(_oCPDeliveryTos);
        }
    });


    function GetContractors(sContractorName, bIsIssueTo){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName+'~'+1,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeContractorPickerbutton(oPickerParam, bIsIssueTo);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }

    function IntializeContractorPickerbutton(oPickerobj, bIsIssueTo)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            ContractorSelect(oPickerobj, bIsIssueTo);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ContractorSelect(oPickerobj, bIsIssueTo);
            }
        });
    }

    function ContractorSelect(oPickerobj, bIsIssueTo){
        var oContractor = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winContractorPicker')
        {
            if(oContractor !=null  && oContractor.ContractorID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                if(bIsIssueTo){
                    $('#txtIssueTo').val(oContractor.Name);
                    _nContractorID= oContractor.ContractorID;
                    if(_nDeliveryToID<=0){
                        $('#txtDeliverTo').val(oContractor.Name);
                        _nDeliveryToID= oContractor.ContractorID;
                    }
                }
                else{
                    $('#txtDeliverTo').val(oContractor.Name);
                    _nDeliveryToID= oContractor.ContractorID;
                }

                GetContactPersonel(oContractor.ContractorID, bIsIssueTo);

            }
            else{
                alert("Please select an item.");
            }
        }
    }

    function GetContactPersonel(nContractorID,bIsIssueTo){

        var oContractor = {
            ContractorID: nContractorID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "GetContactPersonnels",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContactPersonnelID > 0) {
                    debugger;
                    if(bIsIssueTo){
                        LoadIssueContactPersonnel(response.objs);
                        $('#cboCPIssueTo').focus().select();
                        if(_nDeliveryToID==_nContractorID){
                            LoadDeliveredContactPersonnel(response.objs);
                            $('#cboCPDeliverTo').focus().select();
                        }
                    }
                    else{
                        LoadDeliveredContactPersonnel(response.objs);
                        $('#cboCPDeliverTo').focus().select();
                    }

                }
                else{
                    if(bIsIssueTo){
                        LoadIssueContactPersonnel([]);
                        $('#cboCPIssueTo').focus().select();
                        if(_nDeliveryToID==_nContractorID){
                            LoadDeliveredContactPersonnel([]);
                        }
                    }
                    else{
                        LoadDeliveredContactPersonnel([]);
                        $('#cboCPDeliverTo').focus().select();
                    }
                }
            }
        });
    }




    /////
    $("#btnReseDeliveryZone").click(function () {

        $("#txtDeliveryZone").val("");
       
    });

    $("#btnPickDeliveryZone").click(function () {
        debugger;
        var sName=$.trim($("#txtDeliveryZone").val());
        var sConIDs="";
        if(_oDyeingOrder.ContractorID>0)
        {
            sConIDs=_oDyeingOrder.ContractorID;
        }
        if(_oDyeingOrder.DeliveryToID>0)
        {
            sConIDs=sConIDs+","+_oDyeingOrder.DeliveryToID;
        }

        var oDyeingOrder = {
            DeliveryNote:sName,
            ErrorMessage:''
        };
        GetDeliveryZone(oDeliveryZone);
    });
    $("#txtDeliveryZone").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sName=$.trim($("#txtDeliveryZone").val());
            if(sName=="" || sName==null)
            {
                alert("Type Name or Part of Name!");
                return;
            }

            var oDyeingOrder = {
                DeliveryNote:sName,
                ErrorMessage:''
            };
            GetDeliveryZone(oDyeingOrder);
        }
        else if(nkeyCode==8){
           
            
        }
    });
    function GetDeliveryZone(oDyeingOrder){


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDyeingOrder,
            ControllerName: "LabDip",
            ActionName: "GetsDistingDeliveryNote",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DeliveryNote!=null) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "DeliveryNote", title: "Delivery Note(s)", width: 250, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winDeliveryZonePicker',
                        winclass:'clsDeliveryZonePicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblDeliveryZonePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'DeliveryZoneName'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDeliveryZonePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Delivery Zone found.");
            }
        });


    }

  

    function IntializeDeliveryZonePickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            DeliveryZoneSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                DeliveryZoneSelect(oPickerobj);
            }
        });
    }

    function DeliveryZoneSelect(oPickerobj){
        var oDeliveryZone = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winDeliveryZonePicker')
        {
            if(oDeliveryZone !=null  && oDeliveryZone.DeliveryNote !=null ){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtDeliveryZone').val(oDeliveryZone.DeliveryNote);
                $('#cboPriorityLevel').focus().select();

            }
            else{
                alert("Please select delivery zone.");
            }
        }
    }




    $("#btnResetProduct").click(function () {

        $("#txtProduct").val("");
        _nProductID=0;
    });

    $("#btnPickProduct").click(function () {

        var sProductName=$.trim($("#txtProduct").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        GetProducts(sProductName);
    });

    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName);
        }
        else if(nkeyCode==8){
         
            _nProductID=0;
        }
    });

    function GetProducts(sProductName){
        var oProduct = { BUID:sessionStorage.getItem("BUID"),ProductName:sProductName};
        //var oProduct = {
        //    BUID:1,
        //    ProductName:sProductName,
        //};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeProductPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    ///Color Code
    $("#btnPickLDCode").click(function () {

        var sLDCode=$.trim($("#txtLDCode").val());
        if(sLDCode==""){ alert("Type Code to search."); return false; }
        GetLDColorCodes(sLDCode);
    });

    $("#txtLDCode").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLDCode=$.trim($("#txtLDCode").val());
            if(sLDCode==""){ alert("Type Code to search."); return false; }
            GetLDColorCodes(sLDCode);
        }
        else if(nkeyCode==8){
         
            _nLabdipColorID=0;
         
        }
    });

    function GetLDColorCodes(sLDCode){
        var oLabdipColor = { Code:sLDCode};

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabdipColor,
            ControllerName: "LabDip",
            ActionName: "GetLabDipLolors",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LabdipColorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "CodeNo", title: "Name", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Unit", width: 100, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winLDColorPicker',
                        winclass:'clsLDColorPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblLDColorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Code',
                        windowTittle: 'Code List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeProductPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Code found.");
            }
        });


    }

    function IntializeProductPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            ProductSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ProductSelect(oPickerobj);
            }
        });
    }

    function ProductSelect(oPickerobj){
        var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winProductPicker')
        {
            if(oProduct !=null  && oProduct.ProductID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtProduct').val(oProduct.ProductNameCode);
                _nProductID= oProduct.ProductID;
                $('#cboKnitPly').focus().select();
            }
            else{
                alert("Please select product.");
            }
        }
        if (oPickerobj.winid == 'winLDColorPicker')
        {
            if(oProduct !=null  && oProduct.LabdipColorID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtLDCode').val(oProduct.Code+""+oProduct.CodeNo);
                _nLabdipColorID= oProduct.LabdipColorID;
                $('#txtColorName').focus().select();
            }
            else{
                alert("Please select product.");
            }
        }

    }


    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });


    function SetIntoSessionStorage(){

        debugger;
        var sBackLink=sessionStorage.getItem('BackLink');
        var nIndex=sessionStorage.getItem('SelectedRowIndex');
        var oLabDips= (sessionStorage.getItem('Labdips').length>0)? jQuery.parseJSON(sessionStorage.getItem('Labdips')):[] ;
        if(_oLabDip!=null && _oLabDip.LabDipID>0){

            if(nIndex>=0){
                oLabDips[nIndex]=_oLabDip;
            }
            else{
                oLabDips.push(_oLabDip);
                nIndex=oLabDips.length-1;
            }
        }
     
        sessionStorage.setItem("BackLink", sBackLink);
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("Labdips", JSON.stringify(oLabDips));
    }

    $('#btnNew').click(function(e){
        sessionStorage.setItem("Operation", "New");
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("LapdipHeader", "Add Labdip");
        var oLabDips= (sessionStorage.getItem('Labdips').length>0)? jQuery.parseJSON(sessionStorage.getItem('Labdips')):[] ;
        sessionStorage.setItem("Labdips", JSON.stringify(oLabDips));
        sessionStorage.setItem("BackLink", sessionStorage.getItem('BackLink'));
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/LabDip/ViewLabDip?nId=0&ts="+tsv;
    });

   $('.only-number').keydown(function (e) {

        if ((e.which >= 48 && e.which <= 57) || (e.which >= 96 && e.which <= 105)|| e.which==9 || e.which==38 || e.which==40 || e.which==8 || e.which==37 || e.which==39 || e.which==46) {
            return true;
        }
        else {
            return false
        }
    });


    $('#btnPrint').click(function (e)
    {

        if (_oLabDip ==null || _oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/LabDip/PrintLabDip?nId="+_oLabDip.LabDipID+"&nts="+tsv, "_blank");
    });

    function onLoadSuccess(data)
    {
        debugger;
        var nIndex=0;
        var nSpan=0;
        for(var i=0;i<_oCellRowSpans.length;i++){
            var oMCell=[_oCellRowSpans[i].mergerCell];
            nIndex=oMCell[0][0];
            nSpan= oMCell[0][1];
            if(_oCellRowSpans[i].FieldName=="TwistedGroup"){
                $(this).datagrid('mergeCells',{index: nIndex, field: 'TwistedGroup', rowspan: nSpan});
            }
        }
    }


    $('#btnMakeTwisted').click(function(e){

        var oLabDipDetails= $('#tblLabDipDetail').datagrid('getChecked');

        if(oLabDipDetails.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sLabDipDetailIDs="";
        for(var i=0; i<oLabDipDetails.length; i++){
            sLabDipDetailIDs = sLabDipDetailIDs + oLabDipDetails[i].LabDipDetailID +",";
        }
        sLabDipDetailIDs=sLabDipDetailIDs.substring(0,sLabDipDetailIDs.length-1);

        var oLabDipDetail={
            LabDipID: oLabDipDetails[0].LabDipID,
            TwistedGroup: 0,
            Params: sLabDipDetailIDs
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDipDetail,
            ObjectId: oLabDipDetail.LabDipDetailID,
            ControllerName: "LabDip",
            ActionName: "MakeTwistedGroup",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oLabDipDetail.LabDipDetailID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.LabDipDetails.length > 0 && response.obj.LabDipDetails[0].LabDipDetailID>0) {
                    _oLabDip.ISTwisted=$('#chkIsTwisted').is(':checked');
                    _oCellRowSpans=response.obj.LabDipDetails[0].CellRowSpans;
                    DynamicRefreshList(response.obj.LabDipDetails, 'tblLabDipDetail');

                }
                else if(response.obj.LabDipDetails.length > 0 && response.obj.LabDipDetails[0].LabDipDetailID<=0){
                    alert(response.obj.LabDipDetails[0].ErrorMessage);
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    $('#btnRemoveTwisted').click(function(e){

        var oLabDipDetails= $('#tblLabDipDetail').datagrid('getChecked');

        if(oLabDipDetails.length<=0){
            alert("No items found to be twisted."); return false;
        }

        var sLabDipDetailIDs="";
        for(var i=0; i<oLabDipDetails.length; i++){
            sLabDipDetailIDs = sLabDipDetailIDs + oLabDipDetails[i].LabDipDetailID +",";
        }
        sLabDipDetailIDs=sLabDipDetailIDs.substring(0,sLabDipDetailIDs.length-1);

        var oLabDipDetail={
            LabDipID: oLabDipDetails[0].LabDipID,
            TwistedGroup: 0,
            Params: sLabDipDetailIDs
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDipDetail,
            ObjectId: oLabDipDetail.LabDipDetailID,
            ControllerName: "LabDip",
            ActionName: "RemoveTwistedGroup",
            TableId: "",
            IsWinClose: false,
            Message: ""// (oLabDipDetail.LabDipDetailID>0)?"Update Successfully." : "Save Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                debugger;
                if (response.obj.LabDipDetails.length > 0 && response.obj.LabDipDetails[0].LabDipDetailID>0) {
                    _oCellRowSpans=response.obj.LabDipDetails[0].CellRowSpans;
                    DynamicRefreshList(response.obj.LabDipDetails, 'tblLabDipDetail');
                }
                else{
                    alert(response.obj.ErrorMessage);
                }
            }
        });
    });

    function formatTwisted(value){

        if(value>0){
            return "Twisted";
        }
        else{
            return "";
        }
    }


    $('#chkIsTwisted').change(function(e){

        LabdipFormat();
    });

    function LabdipFormat()
    {
        if($('#chkIsTwisted').is(':checked')){
            $('#tblLabDipDetail').datagrid('showColumn','Selected');
            $('#tblLabDipDetail').datagrid('showColumn','TwistedGroup');
        }
        else{
            $('#tblLabDipDetail').datagrid('hideColumn','Selected');
            $('#tblLabDipDetail').datagrid('hideColumn','TwistedGroup');
        }
        var oLabDipDetails=$('#tblLabDipDetail').datagrid('getRows');
        DynamicRefreshList(oLabDipDetails, 'tblLabDipDetail');
    }

    function AddContactPerson(bIsBuyer) {
        _bIsBuyer = bIsBuyer;
        if(!bIsBuyer)
        {
            if (parseInt(_nContractorID) <= 0)
            {
                alert("Please select Issue To!");
                $('#txtIssueTo').focus();
                return;
            }
        }else{
            if (parseInt(_nDeliveryToID) <= 0)
            {
                alert("Please select Delivery To!");
                $('#txtDeliverTo').focus();
                return;
            }
        }
        $("#winContactPersonnel").icsWindow('open', "Add Contact Person");
        $("#winContactPersonnel input").not("input[type='button']").val("");
    }

    function ValidateInputContactPersonnel()
    {
        if(document.getElementById("txtName").value==null || document.getElementById("txtName").value=="")
        {
            alert("Please enter name!");
            $('#txtName').focus();
            return false;
        }

        if(document.getElementById("txtPhone").value==null || document.getElementById("txtPhone").value=="")
        {
            alert("Please enter phone number!");
            $('#txtPhone').focus();
            return false;
        }
        return true;
    }

    function RefreshObjectCP()
    {
        debugger;
        var oContactPersonnel= {
            ContactPersonnelID : 0,
            ContractorID : (_bIsBuyer==true)? _nDeliveryToID:_nContractorID,
            Name : $("#txtName").val(),
            Address : $("#txtAddress").val(),
            Phone :$("#txtPhone").val(),
            Email : $("#txtEmail").val(),
            Note : $("#txtNote").val()
        };
        return oContactPersonnel;
    }

    function AddContactPersonnel()
    {
        debugger;
        if(!ValidateInputContactPersonnel()) return;
        var oContactPersonnel=RefreshObjectCP();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/Contractor/SaveContactPersonnel",
            traditional: true,
            data:  JSON.stringify(oContactPersonnel),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                _oContactPersonnel = jQuery.parseJSON(data);
                if(parseInt(_oContactPersonnel.ContactPersonnelID)>0)
                {
                    alert("Data Saved sucessfully");
                    document.getElementById("txtName").value="";
                    document.getElementById("txtAddress").value="";
                    document.getElementById("txtPhone").value="";
                    document.getElementById("txtEmail").value="";
                    document.getElementById("txtNote").value="";
                    $("#winContactPersonnel").icsWindow('close');
                    if(_bIsBuyer)
                    {
                        GetContactPerson(_nDeliveryToID,true);//load Buyer Contact peron
                    }else
                    {
                        GetContactPerson(_nContractorID,false);//load Accounts of contactperson
                    }
                }
                else {
                    alert(_oContactPersonnel.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function CloseContactPersonnel()
    {
        $("#winContactPersonnel").icsWindow('close');
    }


    $('#btnEditDeliveryZone').click(function(e){
        debugger;
        if(_nDeliveryZoneID<=0)
        {
            alert("First, Select a Delivery Place");
            $("#txtDeliveryZoneNew").focus();
            return;
        }
        var oDeliveryZone = {
            DeliveryZoneID  : _nDeliveryZoneID,
            DeliveryZoneName :""
        };
        AddDeliveryZone(oDeliveryZone);

    });
    $('#btnNewDeliveryZone').click(function(e){
        debugger;
      
       
        $("#winDeliveryZone input").val("");
        var oDeliveryZone = {
            DeliveryZoneID  : 0,
            DeliveryZoneName :""
        };
        AddDeliveryZone(oDeliveryZone);
    });
    function AddDeliveryZone(oDeliveryZone)
    {
        $("#winDeliveryZone input").val("");
        var obj =
           {
               BaseAddress: _sBaseAddress,
               Object: oDeliveryZone,
               ControllerName: "DeliveryZone",
               ActionName: "Get",
               IsWinClose: false
           };
        $.icsDataGet(obj, function (response) {
        
            if (response.status && response.obj != null) 
            {
                $("#txtDeliveryZoneNew").val(response.obj.DeliveryZoneName);
                _nDeliveryZoneID=response.obj.DeliveryZoneID;
                $("#winDeliveryZone").icsWindow("open","Delivery Zone");
                //else { alert(response.obj.ErrorMessage); }
            }
           
        });
        
    }


    $('#btnSaveDeliveryZone').click(function(e){
      
        //if(_oDyeingOrder.DyeingOrderID<=0)
        //{
        //    alert("First, Save Order");
        //    $("#txtDeliveryZoneNew").focus();
        //    return;
        //}

        var oDeliveryZone = {
            DeliveryZoneID  : _nDeliveryZoneID,
            DeliveryZoneName : $.trim($("#txtDeliveryZoneNew").val())
        };
        if (!confirm("Confirm to Save new Delivery Zone?")) return;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDeliveryZone,
            ObjectId: oDeliveryZone.DeliveryZoneID,
            ControllerName: "DeliveryZone",
            ActionName: "SaveDeliveryZone",
            TableId: "",
            IsWinClose: true,
            Message:""
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.DeliveryZoneID > 0) {
                    _nDeliveryZoneID=response.obj.DeliveryZoneID;
                    $("#txtDeliveryZone").val(response.obj.DeliveryZoneName);
                    $("#winDeliveryZone").icsWindow("close");
                }
            }
        });
    });
    $("#btnCloseDeliveryZone").click(function () {
        debugger;
        $("#winDeliveryZone").icsWindow("close");

    });
</script>