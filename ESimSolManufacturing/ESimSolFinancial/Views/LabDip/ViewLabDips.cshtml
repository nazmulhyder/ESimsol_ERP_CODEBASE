@{
    ViewBag.Title = "Labdip orders";
}

@model IEnumerable<ESimSol.BusinessObjects.LabDip>
    
    <head>
        <title>Lab Dip Orders</title>      
    </head>

    <body>
        <div class="menuMainCollectionTable" >
            <table id="tblLabDip" title="Labdip List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbarLabdip" >
                <thead>
                    <tr>
                        <th field="LabdipNo" width="8%"><label id="lblLabdipNo">Labdip No</label></th>
                        <th field="OrderDateStr" width="9%">Issue Date</th>
                        <th field="SeekingDateStr" width="9%">Seeking Date</th>
                        <th field="ContractorName" width="15%">Contractor</th>
                        @*<th field="DeliveryToName" width="15%">Delivered To</th>*@
                        <th field="OrderStatusStr" width="14%">Status</th>
                        <th field="ContractorCPName" width="12%">Buyer Concern Person</th>
                        <th field="NoOfColor" width="6%" align="center">NoOfColor</th>
                        <th field="PriorityLevelStr" width="8%">Priority</th>
                        <th field="OrderReferenceTypeSt" width="8%">Source</th>
                        <th field="TwistedStr" width="8%">Twisted</th>
                    </tr>
                </thead>

            </table>

            <div id="toolbarLabdip">
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv.</a>
                <input id="chkDate" type="checkbox" />
                <input id="dtOrderFrom" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input id="dtOrderTo" type="text" style="width: 110px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <input type="text" id="txtLabdipNo" placeholder="Search Labdip" style="width:8%;" />
                <input type="text" id="txtLabdipColorNo" placeholder="Search Color" style="width:8%;" />
                <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-edit" plain="true">Edit</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-details" plain="true">View</a>
                <a id="btnRelab" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-ok" plain="true">Relab</a>
                <a id="btnOrderStatus" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-approved" plain="true"> <label id="lblOrderStatus">Approve</label> </a>
                <a id="btnUndo" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-undo" plain="true">Undo</a>
                <a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-cancel" plain="true">Cancel</a>
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                @*<a id="btnPrintLabdipChallan" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Challan</a>*@
                <a id="btnPrintLabdipTestCard" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Test Card</a>
                <a id="btnPrintFormat" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-setting" plain="true">Print Format</a>
              </div>
        </div>
        
        <div id="winAdvanceSearch" class="easyui-window winstyle" title="Adv Search" style="width:450px; height:540px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width: 100%; font-family: Tahoma;">
                <fieldset>
                    <legend>Searching Criteria</legend>
                    <table class="tbl-AdvSearch">
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Mkt Person :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtMktPerson" class="reset-text pickersearch" placeholder="Search Mkt Person" />
                                <a id="btnPickMktPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetMktPerson" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Issue To :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtIssueTo" class="reset-text pickersearch" placeholder="Search Issue To" />
                                <a id="btnPickIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetIssueTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Delivered To :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtDeliverTo" class="reset-text pickersearch" placeholder="Search Delivery To" />
                                <a id="btnPickDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetDeliverTo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Order No :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="txtOrderNo" class="reset-text pickersearch" placeholder="Search Order No" />
                                <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Labdip Format :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboLabDipFormat"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Light Source :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <select id="cboLightSource"></select>
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Issue Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsOrderDateAdv" type="checkbox" />
                                <input id="dtOrderDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtOrderDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Requirement Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsSeekingDateAdv" type="checkbox" />
                                <input id="dtSeekingDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtSeekingDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td class="td-AdvSearch-Level">
                                Status Date :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <input id="chkIsStatusDateAdv" type="checkbox" />
                                <input id="dtStatusDateFromAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /> To
                                <input id="dtStatusDateToAdv" type="text" style="width: 100px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>

                        <tr>
                            <td class="td-AdvSearch-Level" valign="top">
                                Labdip Status :
                            </td>
                            <td class="td-AdvSearch-Input">
                                <table id="tblOrderStatus" class="easyui-datagrid" style="height:180px;" fitcolumn="true" rownumbers="true" pagination="false" multiselect="true" autorowheight="false">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'Selected',checkbox:true"> </th>
                                            <th field="Text" width="80%">Status</th>
                                        </tr>
                                    </thead>

                                </table>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset>
                    <legend>Action</legend>
                    <div class="align-right">
                        <a id="btnSearchOk" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                        <a id="btnSearchClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>
                
            </div>
        </div>
        <div id="winPrintFormat2" style="width:550px;" class="easyui-window winstyle" title="Adv. Search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <fieldset>
                <legend>Print Setup</legend>
                <table style="width:100%;">
                    <tr>
                        <td style="text-align:right;">
                            Qty Fromat :
                        </td>
                        <td>
                            <input id="chkInKg" type="checkbox" onclick="if(this.checked){IsLBSFormat(false)}else{IsLBSFormat(true)}" /> In KG
                        </td>
                        <td>
                            <input id="chkInLBS" type="checkbox" checked onclick="if(this.checked){IsLBSFormat(true)}else{IsLBSFormat(false)}" /> In LBS
                        </td>
                        <td style="width:30%;">
                            &nbsp;&nbsp;&nbsp;
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right;">
                            Print Title :
                        </td>
                        <td>
                            <input id="chkPrintTitleInNormalFormat" type="checkbox" checked onclick="if(this.checked){PrintTitleFormat(1)}" /> Normal Format
                        </td>
                        <td>
                            <input id="chkPrintTitlePadFormat" type="checkbox" onclick="if(this.checked){PrintTitleFormat(2)}" /> Pad Format
                        </td>
                        <td>
                            <input id="chkPrintTitleImageFormat" type="checkbox" onclick="if(this.checked){PrintTitleFormat(3)}" /> Image Format
                        </td>

                    </tr>
                </table>
            </fieldset>
            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <a id="btnOkPrintFormat2" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                <a id="btnClosePrintFormat2" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>
    </body>

    <style type="text/css">
        .td-AdvSearch-Level {
            width: 35%;
            text-align: right;
            font-weight: bold;
        }

        .td-AdvSearch-Input {
            width: 64%;
        }

        .td-AdvSearch-Input select {
            width: 99%;
        }

        .td-AdvSearch-Input .textSearch {
            width: 96%;
        }

        .td-AdvSearch-Input .pickersearch {
            width: 73%;
        }

    </style>


    
    <script type="text/javascript">
    var _sBaseAddress="";
    var _oLabDips=[];
    var _oLightSources=[];
    var _oLabdipFormats=[];
    var _oLabdipOrderStatuss=[];

    var _sMessage='';
    var _nNextStatus=-1;

    var _sContractorIDs="";
    var _sDeliveryToIDs="";
    var _sMktPersonIDs="";
    var _sOrderNos="";

    $(document).ready(function () {
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oLabDips =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oLightSources=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LightSources));
        _oLabdipFormats=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumLabdipFormats));
        _oLabdipOrderStatuss=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumLabdipOrderStatuss));
        var oLabDipSetup =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.LabDipSetup));
        sessionStorage.setItem("QtyFormat",true);//default set
        sessionStorage.setItem("ImageFormat",2);//default set
        LabdipSetup(oLabDipSetup);
        $('.initial-state').hide();
        if(sessionStorage.getItem("Labdips")!=null && sessionStorage.getItem("Labdips").length>0){
            _oLabDips= jQuery.parseJSON(sessionStorage.getItem('Labdips'));
            var nIndex= sessionStorage.getItem('SelectedRowIndex');
            DynamicRefreshList(_oLabDips, 'tblLabDip');
            if(nIndex>-1){
                $('#tblLabDip').datagrid('selectRow',nIndex);
                OperationPerforms(nIndex, _oLabDips[nIndex]);
            }
        }
        else{
            DynamicRefreshList(_oLabDips, 'tblLabDip');
        }
        $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':true});
        $('#dtOrderFrom,#dtOrderTo').datebox('setValue', icsdateformat(new Date()));

        DynamicRefreshList(_oLabdipOrderStatuss, 'tblOrderStatus');
        $("#cboLightSource").icsLoadCombo({
            List: _oLightSources,
            OptionValue: "LightSourceID",
            DisplayText: "Descriptions",
            InitialValue:"Default"
        });

        $("#cboLabDipFormat").icsLoadCombo({
            List: _oLabdipFormats,
            OptionValue: "id",
            DisplayText: "Value",
            InitialValue:""
        });
       
    });

        function LabdipSetup(oLabDipSetup)
        {
            $('#lblLabdipNo').html(oLabDipSetup.OrderName);
            $("#txtLabdipNo").attr("placeholder", "Type "+oLabDipSetup.OrderName);
            $("#txtLabdipColorNo").attr("placeholder","Type "+oLabDipSetup.ColorNoName);
        }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


    $('#tblLabDip').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData) {
        if (rowData != null && rowData.LabDipID > 0) {
            debugger;
            $('#btnPrintLabdipChallan').show();
            $('#btnCancel,#btnUndo,#btnEdit,#btnDelete,#btnRelab').hide();
            $('#btnView,#btnPrint,#btnPrintLabdipTestCard').show();
            if (rowData.OrderStatus==1)  //Initialized = 1,
            {
                $('#btnEdit,#btnDelete,#btnOrderStatus').show();
                _nNextStatus=2;
                _sMessage="send an approval request.";
                $('#lblOrderStatus').text('Send For Approve');
            }
            else{
                $('#btnOrderStatus').show();
                if (rowData.OrderStatus==2)  //WaitForApprove = 2,
                {
                    _nNextStatus=3;
                    _sMessage="approve.";
                    $('#lblOrderStatus').text('Approve');
                    $('#btnUndo').show();
                }
                else if (rowData.OrderStatus==3) // Approve = 3,
                {
                    _nNextStatus=4;
                    _sMessage="send in lab.";
                    $('#lblOrderStatus').text('Send To Lab');
                    $('#btnCancel').show();
                }
                    //else if (rowData.OrderStatus==4) // InLab = 4,
                    //{
                    //    _nNextStatus=5;
                    //    _sMessage="labdip done.";
                    //    $('#lblOrderStatus').text('Labdip Done');
                    //}
                    //else if (rowData.OrderStatus==5) // LabdipDone=5,
                    //{
                    //    _nNextStatus=6;
                    //    _sMessage="send a request receive from lab.";
                    //    $('#lblOrderStatus').text('Req. Receive From Lab');
                    //}
                else if (rowData.OrderStatus==6) //WaitingForReceiveFromLab=6,
                {
                    _nNextStatus=7;
                    _sMessage="receive from lab.";
                    $('#lblOrderStatus').text('Receive From Lab');
                }

                else if (rowData.OrderStatus==7) // LabdipAtSales=7,
                {
                    _nNextStatus=8;
                    _sMessage="send request for buyer approval.";
                    $('#lblOrderStatus').text('Forward to Buyer');
                }

                else if (rowData.OrderStatus==8) // WaitForBuyerApprove=8,
                {
                    _nNextStatus=9;
                    _sMessage="send to buyer.";
                    $('#lblOrderStatus').text('Approve by Buyer');
                }
                else if (rowData.OrderStatus==9) // WaitForBuyerApprove=8,
                {
                    _nNextStatus=-1;
                    _sMessage=""
                    $('#lblOrderStatus').text('Approve by Buyer');
                    $('#btnOrderStatus').hide();
                }
                else{
                    _nNextStatus=-1;
                    _sMessage="";
                    $('#btnOrderStatus').hide();
                }

                if(rowData.OrderStatus>=5){
                    $('#btnRelab').show();
                }
                //if(rowData.OrderStatus>=5){
                //    $('#btnPrintLabdipChallan').show();
                //}
            }

        }
    }



    $('#chkDate').change(function(e){
        debugger;
        if($('#chkDate').is(':checked')){
            $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':false});
        }
        else{
            $('#dtOrderFrom,#dtOrderTo').datebox({'disabled':true});
        }
        $('#dtOrderFrom,#dtOrderTo').datebox('setValue', icsdateformat(new Date()));
    });

    /*.......... Searching ............. */

    $("#txtLabdipNo").keyup(function (e) {
        var oLabDips =[];
        var keyCode = e.keyCode || e.which;
        $('#txtLabdipNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oLabDips = _oLabDips; }
        else{ oLabDips = $('#tblLabDip').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if (!$.trim($("#txtLabdipNo").val()).length ) {

                alert("Please labdip no.");
                $('#txtLabdipNo').focus();
                $('#txtLabdipNo').val("");
                return;
            }
            else { $('#txtLabdipNo').removeClass("errorFieldBorder"); }
            if ($.trim($("#txtLabdipNo").val()).length<4 ) {

                alert("Please enter at least 4 character to search.");
                $('#txtLabdipNo').focus();
                $('#txtLabdipNo').val("");
                return;
            }
            else { $('#txtLabdipNo').removeClass("errorFieldBorder"); }
            

            var oLabDip={
                Params: $.trim($("#txtLabdipNo").val()) +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+ '~'+ ""+'~'+''+'~'+''
            };
            GetsLabdip(oLabDip, false) ;
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oLabDips.length;++i)
            {
                sTempName=oLabDips[i]['LabdipNo'];
                if(sTempName.toUpperCase().indexOf($('#txtLabdipNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oLabDips[i]);
                }
            }
            $('#tblLabDip').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oLabDips, "tblLabDip");}
            else { DynamicRefreshList(oSearchedData, "tblLabDip"); }

        }
    });

    $('#btnSearch').click(function(e){

        if($.trim($("#txtLabdipColorNo").val())=="" && $.trim($("#txtLabdipNo").val())=="" && !$('#chkDate').is(':checked')){
            alert("No searching criteria found to search."); return false;
        }
        var oLabDip={
            Params: $.trim($("#txtLabdipNo").val()) +'~'+ "" +'~'+ "" + '~'+ "" +'~'+ 0 +'~'+ 0 +'~'+ $('#dtOrderFrom').datebox('getValue') +'~'+ $('#dtOrderTo').datebox('getValue')+'~'+ $('#chkDate').is(':checked') +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false +"~"+ icsdateformat(new Date()) +'~'+ icsdateformat(new Date())+ '~'+ false+'~'+''+'~'+ $.trim($("#txtLabdipColorNo").val())+""+"~"
        };
        GetsLabdip(oLabDip, false) ;
    });

    function GetsLabdip(oLabDip, bIsAdvSearch) {

       
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oLabDip,
            ControllerName: "LabDip",
            ActionName: "Gets",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs != null) {
                if(bIsAdvSearch){
                    ResetAdvSearchPicker();
                    $("#winAdvanceSearch").icsWindow("close");
                }
                if (response.objs.length > 0) {
                    if(response.objs[0].LabDipID>0){
                        _oLabDips=response.objs;
                        DynamicRefreshList(response.objs, "tblLabDip");
                    }
                    else{DynamicRefreshList([], "tblLabDip"); alert(response.objs[0].ErrorMessage);}
                }
                else { DynamicRefreshList([], "tblLabDip"); alert("No labdip found."); }
            }
        });
    }


    function ResetAdvSearchPicker(){
        _sContractorIDs="";
        _sDeliveryToIDs="";
        _sMktPersonIDs="";
        _sOrderNos="";
        $('#txtMktPerson,#txtIssueTo,#txtDeliverTo').val("");

        $('#cboLabDipFormat').val(0);
        $('#cboLightSource').val(0);

        
        $('#chkIsOrderDateAdv').prop('checked',false);
        $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:true});
        $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox('setValue',icsdateformat(new Date()));

        $('#chkIsSeekingDateAdv').prop('checked',false);
        $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:true});
        $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox('setValue',icsdateformat(new Date()));

        $('#chkIsStatusDateAdv').prop('checked',false);
        $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:true});
        $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox('setValue',icsdateformat(new Date()));

        
        $('#tblOrderStatus').datagrid('uncheckAll');

    }

    $('#chkIsOrderDateAdv').click(function(e){
        if(!$('#chkIsOrderDateAdv').is(':checked')){
            $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:true});
        }
        else{
            $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox({disabled:false});
        }
        $('#dtOrderDateFromAdv,#dtOrderDateToAdv').datebox('setValue',icsdateformat(new Date()));
    });

    $('#chkIsSeekingDateAdv').click(function(e){
        if(!$('#chkIsSeekingDateAdv').is(':checked')){
            $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:true});
        }
        else{
            $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox({disabled:false});
        }
        $('#dtSeekingDateFromAdv,#dtSeekingDateToAdv').datebox('setValue',icsdateformat(new Date()));
    });

    $('#chkIsStatusDateAdv').click(function(e){
        if(!$('#chkIsStatusDateAdv').is(':checked')){
            $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:true});
        }
        else{
            $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox({disabled:false});
        }
        $('#dtStatusDateFromAdv,#dtStatusDateToAdv').datebox('setValue',icsdateformat(new Date()));
    });
   
    function GetOrderStatus(){

        var sOrderStatus="";

        var oOrderStatus=$('#tblOrderStatus').datagrid('getChecked');

        if(oOrderStatus.length>0){
            for(var i=0;i<oOrderStatus.length;i++){
                sOrderStatus= sOrderStatus + oOrderStatus[i].Value+","
            }
            sOrderStatus=sOrderStatus.substring(0,sOrderStatus.length-1);
        }
        return sOrderStatus;
    }

    $("#btnAdvSearch").click(function (e) {
        ResetAdvSearchPicker();
        $("#winAdvanceSearch").icsWindow("open", "Adv Search");
    });

    $("#btnSearchOk").click(function (e) {

        var sOrderStatus=GetOrderStatus();

        if(_sOrderNos=="" &&_sContractorIDs =="" && _sDeliveryToIDs=="" && _sMktPersonIDs=="" && $('#cboLabDipFormat').val()<=0 && $('#cboLightSource').val()<=0 && !$('#chkIsOrderDateAdv').is(':checked') && !$('#chkIsSeekingDateAdv').is(':checked') && !$('#chkIsStatusDateAdv').is(':checked') && sOrderStatus=="" ){
            alert("No searching criteria found to search.");
            return false;
        }
        

        var oLabDip={
            Params: ""+'~'+_sContractorIDs +'~'+ _sDeliveryToIDs +'~'+ _sMktPersonIDs +'~'+$('#cboLabDipFormat').val()+'~'+$('#cboLightSource').val() +'~'+$('#dtOrderDateFromAdv').datebox('getValue')+'~'+$('#dtOrderDateToAdv').datebox('getValue') +'~'+ $('#chkIsOrderDateAdv').is(':checked')+'~'+$('#dtSeekingDateFromAdv').datebox('getValue')+'~'+$('#dtSeekingDateToAdv').datebox('getValue')+'~'+ $('#chkIsSeekingDateAdv').is(':checked')+'~'+$('#dtStatusDateFromAdv').datebox('getValue')+'~'+$('#dtStatusDateToAdv').datebox('getValue')+'~'+ $('#chkIsStatusDateAdv').is(':checked')+'~'+sOrderStatus+'~'+''+'~'+_sOrderNos+''
        };
        GetsLabdip(oLabDip,true);
    });

    $("#btnSearchClose").click(function (e) {
        $("#winAdvanceSearch").icsWindow("close");
    });
        ///Pick DO
    $("#btnResetOrderNo").click(function () {

        $("#txtOrderNo").val("");
        _sOrderNos="";
    });

    $("#btnPickOrderNo").click(function () {

        var sName=$.trim($("#txtOrderNo").val());
        var oDyeingOrder = {
            OrderNo:sName,
            ContractorName:_sContractorIDs,
            DeliveryToName:_sDeliveryToIDs,
            MKTPName:_sMktPersonIDs
        };
        GetsDyeingOrder(oDyeingOrder);
    });

    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sName=$.trim($("#txtOrderNo").val());
            var oDyeingOrder = {
                OrderNo:sName,
                ContractorName:_sContractorIDs,
                DeliveryToName:_sDeliveryToIDs,
                MKTPName:_sMktPersonIDs
            };
            GetsDyeingOrder(oDyeingOrder);
        }
        else if(nkeyCode==8){
            $("#txtOrderNo").val("");
            _sOrderNos="";
        }
    });
    
    function GetsDyeingOrder(oDyeingOrder){

        
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDyeingOrder,
            ControllerName: "LabDip",
            ActionName: "GetsDO",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DyeingOrderID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "OrderNoFull", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderDateSt", title: "OrderDate", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Issue To", width: 160, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winDyeingOrderPicker',
                        winclass:'clsDyeingOrderPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblDyeingOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNoFull',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No marketing person found.");
            }
        });


    }
        ////
    $("#btnResetMktPerson").click(function () {

        $("#txtMktPerson").val("");
        _sMktPersonIDs="";
    });

    $("#btnPickMktPerson").click(function () {

        var sName=$.trim($("#txtMktPerson").val());
        GetMktPersons(sName);
    });

    $("#txtMktPerson").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sName=$.trim($("#txtMktPerson").val());
            GetMktPersons(sName);
        }
        else if(nkeyCode==8){
            $("#txtMktPerson").val("");
            _sMktPersonIDs="";
        }
    });

    function GetMktPersons(sName){

        var MarketingAccount_BU = {
            BUID:1,
            Name:sName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: MarketingAccount_BU,
            ControllerName: "MarketingAccount",
            ActionName: "MarketingAccountSearchByName",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].MarketingAccountID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "MarketingAccountID", title: "Code", width: 50, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 180, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMktPersonPicker',
                        winclass:'clsMktPersonPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblMktPersonPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'MKT Person List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No marketing person found.");
            }
        });


    }
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winDyeingOrderPicker')
        {
            if (oreturnObjs != null && oreturnObjs.length> 0)
            {
                _sOrderNos=''; var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Order(s) Selected" : oreturnObjs[0].OrderNoFull;
                $('#txtOrderNo').val(sMessage);
                $("#txtOrderNo").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sOrderNos=_sOrderNos+oreturnObjs[i].DyeingOrderID+',';
                }
                _sOrderNos=_sOrderNos.substring(0,_sOrderNos.length-1);
            }
            else
            {
                alert("Please select a order(s).");
                return false;
            }
        }

        else if (oPickerobj.winid == 'winMktPersonPicker') {
            if (oreturnObjs != null && oreturnObjs.length> 0)
            {
                _sMktPersonIDs='';
                var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +"MKT(s) Selected" : oreturnObjs[0].Name;
                $('#txtMktPerson').val(sMessage);
                $("#txtMktPerson").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sMktPersonIDs=_sMktPersonIDs+oreturnObjs[i].MarketingAccountID+',';
                }
                _sMktPersonIDs=_sMktPersonIDs.substring(0,_sMktPersonIDs.length-1);



            }
            else
            {
                alert("Please select a buyer.");
                return false;
            }
        }
      
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }
 




    $("#btnResetIssueTo").click(function () {
        $("#txtIssueTo").val("");
        _sContractorIDs="";
    });

    $("#btnPickIssueTo").click(function () {

        var sContractorName=$.trim($("#txtIssueTo").val());
        GetContractors(sContractorName, true);
    });

    $("#txtIssueTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtIssueTo").val());
            GetContractors(sContractorName,true);
        }
        else if(nkeyCode==8){
            $("#txtIssueTo").val("");
            _sContractorIDs=0;
        }
    });



    $("#btnResetDeliverTo").click(function () {
        $("#txtDeliverTo").val("");
        _sDeliveryToIDs="";
    });

    $("#btnPickDeliverTo").click(function () {
        var sContractorName=$.trim($("#txtDeliverTo").val());
        GetContractors(sContractorName, false);
    });

    $("#txtDeliverTo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtDeliverTo").val());
            GetContractors(sContractorName,false);
        }
        else if(nkeyCode==8){
            $("#txtDeliverTo").val("");
            _sDeliveryToIDs="";
            
        }
    });


    function GetContractors(sContractorName, bIsIssueTo){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeContractorPickerbutton(oPickerParam, bIsIssueTo);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }

    function IntializeContractorPickerbutton(oPickerobj, bIsIssueTo)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            ContractorSelect(oPickerobj, bIsIssueTo);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ContractorSelect(oPickerobj, bIsIssueTo);
            }
        });
    }

    function ContractorSelect(oPickerobj, bIsIssueTo){
        debugger;
        var oContractors = $('#'+oPickerobj.tableid).datagrid('getChecked');
        if (oPickerobj.winid == 'winContractorPicker')
        {
            if(oContractors.length>0  && oContractors[0].ContractorID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                var sContractorIds='', sMessage=''; 
                sMessage=(oContractors.length>1)? oContractors.length +" Contractors Selected" : oContractors[0].Name;
                for(var i=0;i<oContractors.length;i++){
                    sContractorIds=sContractorIds+oContractors[i].ContractorID+',';
                }
                sContractorIds=sContractorIds.substring(0,sContractorIds.length-1);

                if(bIsIssueTo){

                    $('#txtIssueTo').val(sMessage);
                    _sContractorIDs=sContractorIds;
                    
                }
                else{
                    $('#txtDeliverTo').val(sMessage);
                    _sDeliveryToIDs= sContractorIds;
                }
            }
            else{
                alert("Please select an item.");
            }
        }
    }


    /*------------------------------------*/

    $("#btnAdd").click(function(){
        debugger;
        sessionStorage.setItem("Operation", "New");
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("LapdipHeader", "Add Labdip");
        sessionStorage.setItem("Labdips", JSON.stringify($('#tblLabDip').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/LabDip/ViewLabDip?nId=0&ts="+tsv;
    });

    $('#btnEdit').click(function (e)
    {

        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }


        var nIndex=$('#tblLabDip').datagrid('getRowIndex',oLabDip);

       
        sessionStorage.setItem("Operation", "Edit");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("LapdipHeader", "Edit Production");
        sessionStorage.setItem("Labdips", JSON.stringify($('#tblLabDip').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/LabDip/ViewLabDip?nId="+oLabDip.LabDipID+"&ts="+tsv;
    });

    $('#btnDelete').click(function(e){
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
        if (!confirm("Confirm to delete?")) return;
       
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oLabDip,
            ControllerName: "LabDip",
            ActionName: "Delete",
            TableId: "tblLabDip",
            IsWinClose: false
        };
        $.icsDelete(obj);

    });

    $('#btnView').click(function (e)
    {
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblLabDip').datagrid('getRowIndex',oLabDip);

      
        sessionStorage.setItem("Operation", "View");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("LapdipHeader", "View Production");
        sessionStorage.setItem("Labdips", JSON.stringify($('#tblLabDip').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        window.location.href = _sBaseAddress+ "/LabDip/ViewLabDip?nId="+oLabDip.LabDipID+"&ts="+tsv;;
    });

    $('#btnPrint').click(function (e)
    {
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/LabDip/PrintLabDip?nId="+oLabDip.LabDipID+"&nts="+tsv, "_blank");
    });
    $('#btnPrintLabdipChallan').click(function (e)
    {
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
      
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/LabDip/PrintLabDipDeliveryChallan?nId="+oLabDip.LabDipID+"&nts="+tsv+ "&bPrintFormat="+sessionStorage.getItem("QtyFormat") + "&nTitleType="+sessionStorage.getItem("ImageFormat"), "_blank");
    });

    $('#btnPrintLabdipTestCard').click(function (e)
    {
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/LabDip/PrintLabdipTestCard?nId="+oLabDip.LabDipID+"&nts="+tsv, "_blank");
    });


    /*----------Relab---------------*/

    $("#btnRelab").click(function () {
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

        if(!confirm("Confirm to Relab Labdip")) return false;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDip,
            ObjectId: oLabDip.LabDipID,
            ControllerName: "LabDip",
            ActionName: "Relab",
            TableId: "",
            IsWinClose: false,
            Message: " Relab Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.LabDipID > 0) {
                    $('#tblLabDip').datagrid('appendRow',response.obj);
                    $('#tblLabDip').datagrid('selectRow',$('#tblLabDip').datagrid('getRows').length-1);
                    OperationPerforms(-1, response.obj);
                }
            }
        });
    });

    /*----------Order Status Change----------------*/

    $("#btnOrderStatus").click(function () {
        ChangeOrderState();
    });

    $("#btnUndo").click(function () {
        _nNextStatus=1;
        _sMessage="undo.";
        ChangeOrderState();
    });

    $("#btnCancel").click(function () {
        _nNextStatus=10;
        _sMessage="cancel.";
        ChangeOrderState();
    });

    function ChangeOrderState(){
        var oLabDip = $('#tblLabDip').datagrid('getSelected');
        if (oLabDip ==null || oLabDip.LabDipID <=0 ) { alert("Please select an item from list."); return ; }

        if(!confirm("Confirm to "+_sMessage)) return false;
        oLabDip.Params=_nNextStatus;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDip,
            ObjectId: oLabDip.LabDipID,
            ControllerName: "LabDip",
            ActionName: "ChangeOrderStatus",
            TableId: "tblLabDip",
            IsWinClose: false,
            Message: _sMessage.charAt(0).toUpperCase()+_sMessage.slice(1) +" Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.LabDipID > 0) {
                    OperationPerforms(-1, response.obj);
                }
            }
        });
    }



    $("#btnPrintFormat").click(function () {
        debugger;
        if(sessionStorage.getItem("QtyFormat")=="true")
        {
            $("#chkInKg").prop( "checked", false );
            $("#chkInLBS").prop( "checked", true );
        }else{
            $("#chkInLBS").prop( "checked", false );
            $("#chkInKg").prop( "checked", true );
        }
        if(parseInt(sessionStorage.getItem("ImageFormat"))==1)
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked",true);
            $("#chkPrintTitlePadFormat").prop( "checked", false );
            $("#chkPrintTitleImageFormat").prop( "checked", false );
        }else if(parseInt(sessionStorage.getItem("ImageFormat"))==2)
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked",false);
            $("#chkPrintTitlePadFormat").prop( "checked", true );
            $("#chkPrintTitleImageFormat").prop( "checked", false );
        }else
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked",false);
            $("#chkPrintTitlePadFormat").prop( "checked", false );
            $("#chkPrintTitleImageFormat").prop( "checked", true );
        }
        $("#winPrintFormat2").icsWindow("open"," Print Format Setup");
    });

    $("#btnClosePrintFormat2").click(function () {
        $("#winPrintFormat2").icsWindow("close");
    });

    $("#btnOkPrintFormat2").click(function () {
        debugger;
        $("#winPrintFormat2").icsWindow("close");

        if ($("#chkInLBS").is(':checked'))
        {
            sessionStorage.setItem("QtyFormat",true);
        }else{
            sessionStorage.setItem("QtyFormat",false);
        }

        if ($("#chkPrintTitleInNormalFormat").is(':checked'))
        {
            sessionStorage.setItem("ImageFormat",1);//normal
        }else if ($("#chkPrintTitlePadFormat").is(':checked'))
        {
            sessionStorage.setItem("ImageFormat",2);//pad
        }else if ($("#chkPrintTitleImageFormat").is(':checked'))
        {
            sessionStorage.setItem("ImageFormat",3);//with Image
        }
    });

    function PrintTitleFormat(nPrintTitleFormat)
    {
        if(parseInt(nPrintTitleFormat)==1)//normal
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked", true );
            $("#chkPrintTitlePadFormat").prop( "checked", false );
            $("#chkPrintTitleImageFormat").prop( "checked", false );
        }else  if(parseInt(nPrintTitleFormat)==2)//pad
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked", false );
            $("#chkPrintTitlePadFormat").prop( "checked", true );
            $("#chkPrintTitleImageFormat").prop( "checked", false );
        }else
        {
            $("#chkPrintTitleInNormalFormat").prop( "checked", false );
            $("#chkPrintTitlePadFormat").prop( "checked", false );
            $("#chkPrintTitleImageFormat").prop( "checked", true );
        }
    }
</script>
