@{
    ViewBag.Title = "Requisition";
}
@model ESimSol.BusinessObjects.DUProGuideLine

<div ng-app="DUProGuideLineAPP" class="form-horizontal regionDUProGuideLine menuMainCollectionTable">
    <div ng-controller="DUProGuideLineCtrl" style="height:100%">
        @*Requisition INFO*@
        <div style=" height:30%">
        <fieldset style="height:100%">
            <legend>Invoice Info: </legend>
            <div class="row col-md-12">
                <div class="col-md-2 text-right"><label class="control-label">Order Type :</label></div>
                <div class="col-md-3 text-left">
                    <select id="cboOrderType" ng-model="DUProGuideLine.OrderType" ng-options="obj.OrderType as obj.ShortName for obj in OrderTypes" ng-disabled="orderDisabled" class="form-control">
                        <option value="">--Select Type--</option>
                    </select>
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Order No :</label></div>
                <div class="col-md-3 text-left">
                    <div class="input-group">
                        <input type="text" class="form-control" ng-model="DUProGuideLine.DyeingOrderNo" placeholder="Type Order & Press Enter" ng-disabled="orderDisabled" ng-keydown="SearchKeyDownOrder($event,1)" style="width:80%" />
                        <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickOrder(1)" ng-disabled="orderDisabled" style="width:20%"><span aria-hidden="true"> Pick </span></button>
                    </div>
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Ref No :</label></div>
                <div class="col-md-3 text-left">
                    <div class="input-group">
                        <input type="text" class="form-control" ng-model="DUProGuideLine.RefNo" placeholder="Type Ref No & Press Enter" ng-disabled="orderDisabled" ng-keydown="SearchKeyDownOrder($event,2)" style="width:80%" />
                        <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickOrder(2)" ng-disabled="orderDisabled" style="width:20%"><span aria-hidden="true"> Pick </span></button>
                    </div>
                </div>
            </div>
            <div class="row col-md-12">
                <div class="col-md-2 text-right">
                    <select id="cboContractorType" style="text-align:right; font-weight:bold; padding-left:25%; width:97%" ng-model="DUProGuideLine.ContractorType" ng-options="obj.id as obj.Value for obj in ContractorTypes" ng-disabled="disabled" class="form-control"></select>
                </div>
                <div class="col-md-3 text-left">
                    <div class="input-group">
                        <input type="text" class="form-control" ng-model="DUProGuideLine.ContractorName" placeholder="Type Name & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownBuyer($event)" style="width:80%" />
                        <button type="button" class="btn btn-primary btn-sm" aria-label="center Align" ng-click="PickBuyer()" style="width:20%" ng-disabled="disabled"><span aria-hidden="true">Pick</span></button>
                    </div>
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Challan No:</label></div>
                <div class="col-md-3 text-left">
                    <input type="text" ng-model="DUProGuideLine.ChallanNo" class="form-control" ng-disabled="disabled" />
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Date :</label></div>
                <div class="col-md-3 text-left">
                    <div class="input-group date date-container">
                        <input type="text" class="form-control" ng-disabled="disabled" ng-model="DUProGuideLine.IssueDateST">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                    </div>
                </div>
            </div>
            <div class="row col-md-12">
                <div class="col-md-2 text-right"><label class="control-label"> Product Type</label></div>
                <div class="col-md-3 text-left">
                    <select id="cboProductType" ng-model="DUProGuideLine.ProductTypeInt" ng-options="obj.id as obj.Value for obj in ProductNatures" ng-disabled="disabled" class="form-control">
                        <option value="">--Select Type--</option>
                    </select>
                </div>
                <div class="col-md-2 text-right"><label class="control-label" ng-model="lblReceiveStore">Receive Store</label></div>
                <div class="col-md-3 text-left">
                    <select id="cboReceiveStore" ng-model="DUProGuideLine.WorkingUnitID" ng-change="cboStoreChange(1)" ng-options="obj.WorkingUnitID as obj.OperationUnitName for obj in ReceiveStores" ng-disabled="disabled" class="form-control">
                        <option value="">--Select Type--</option>
                    </select>
                </div>
                <div class="col-md-2 text-right"><label class="control-label"> SL No:</label></div>
                <div class="col-md-3 text-left">
                    <input type="text" ng-model="DUProGuideLine.SLNo" class="form-control" disabled />
                </div>
            </div>
            <div class="row col-md-12">
                <div class="col-md-2 text-right"><label class="control-label"> Gate In No:</label></div>
                <div class="col-md-3 text-left">
                    <input type="text" ng-model="DUProGuideLine.GateInNo" class="form-control" />
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Vehicle No:</label></div>
                <div class="col-md-3 text-left">
                    <input type="text" ng-model="DUProGuideLine.VehicleNo" class="form-control" />
                </div>
                <div class="col-md-2 text-right"><label class="control-label">Receive From:</label></div>
                <div class="col-md-3 text-left">
                    <input type="text" ng-model="DUProGuideLine.ReceivedByName" class="form-control" ng-disabled="disabled" />
                </div>
            </div>
            <div class="row col-md-12">
                <div class="col-md-2 text-right"><label class="control-label">Note:</label></div>
                <div class="col-md-10 text-left">
                    <input type="text" ng-model="DUProGuideLine.Note" ng-disabled="disabled" class="form-control" />
                </div>
            </div>
        </fieldset>
    </div>
        @*DETAILS TABLE*@ 
        <div style="height:58%; width:100%">
            <fieldset style="height:100%">
                <legend>Details : </legend>
                <div class="row ui-grid-panel" >
                    <div class="container col-md-12">
                        <div class="form-inline">
                            <button type="button" style="margin-left:5px" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="GetOrderDetails()" ng-disabled="disabled"><span aria-hidden="true"> Get Order Details </span></button>
                            <input type="text" class="form-control" ng-model="DUProGuideLine.txtProductName" placeholder="Type Product Name & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownProduct($event)" style="width:210px; height:24px;" required />
                            <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickProduct()" ng-disabled="disabled"><span aria-hidden="true"> Pick </span></button>
                            <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="CopyDetail()" ng-disabled="disabled"><span aria-hidden="true"> Copy </span></button>
                            <button type="button" class="btn btn-info btn-sm" aria-label="right Align" ng-click="OpenAdjustLotModal()" ng-hide="DUProGuideLine.ReceiveByID==0 || DUProGuideLine.InOutType==102"><span aria-hidden="true"> Transfer </span></button>
                            <button type="button" class="btn btn-danger btn-sm" aria-label="right Align" style="float:right; margin-right:5%" ng-click="RemoveProduct()" ng-disabled="disabled"><span aria-hidden="true"> Remove </span></button>
                        </div>
                    </div>
                </div>
                <div class="row col-md-12">
                    <div style="height:275px" ui-grid="gridOptionsDUProGuideLineDetail" ui-grid-selection ui-grid-resize-columns ui-grid-edit class="grid"></div>
                </div> 
            </fieldset>
        </div>
        <div style="height:8%">
        <fieldset>
            <legend>Action</legend>
            <div class="row col-md-12 text-right">
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Update()" ng-show="hide_Update"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Update</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Save()" ng-show="hide_Save" > <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Save</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Receive()" ng-show="hide_Receive"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Receive</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Issue()" ng-show="hide_Issue"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Issue</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Approve()" ng-show="hide_Approve"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Approve</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="UndoApprove()" ng-show="hide_UndoApprove"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">UndoApprove</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
            </div>
        </fieldset>
        </div>
    </div>

    <script type="text/ng-template" id="DUProGuideLine.html">
        <div class="modal-header">
            <h4 class="modal-title" id="modal-title">Lot No :</h4>
        </div>
        <div class="modal-body form-horizontal regionExportUP ms-custom-control" id="modal-body">
            <div class="row">
                <div class="col-md-12 ">
                    <div class="col-md-3 text-right"><label class="control-label">Order Product:</label></div>
                    <div class="col-md-7 text-left">
                        <input ng-model="DUProGuideLineDetail.OrderProduct" class="form-control" disabled>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 ">
                    <div class="col-md-3 text-right"><label class="control-label">Store:</label></div>
                    <div class="col-md-7 text-left">
                        <input type="text" class="form-control" ng-model="DUProGuideLineDetail.StoreName" disabled>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 ">
                    <div class="col-md-3 text-right"><label class="control-label">Product:</label></div>
                    <div class="col-md-7 text-left">
                        <div class="form-inline">
                            <input class="form-control" ng-model="txtProductName" placeholder="Type Name & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownProduct($event)" style="width:80%;" required />
                            <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PickProduct()" ng-disabled="disabled"><span aria-hidden="true"> Pick </span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 ">
                    <div class="col-md-3 text-right"><label class="control-label">LotNo:</label></div>
                    <div class="col-md-7 text-left">
                        <div class="form-inline">
                            <input class="form-control" ng-model="txtLotNo" placeholder="Order No" ng-disabled="disabled" ng-keydown="SearchKeyDownLot($event)" style="width:80%;" disabled />
                            <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="GetLot_Others()" ng-disabled="disabled"><span aria-hidden="true"> Pick Order</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-success btn-sm" aria-label="Left Align" ng-click="UpdateLot()" ng-disabled="disabled" ng-hide="hide"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> OK</button>
            <button type="button" class="btn-danger btn-sm" aria-label="Left Align" ng-click="cancel()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel</button>
        </div>
    </script>

    <script type="text/ng-template" id="Adjust_DUProGuideLine.html">
        <div class="modal-header">
            <h4 class="modal-title" id="modal-title">Transfer Lot: {{DUProGuideLineDetail.LotNo}} || Rcv. Qty : {{DUProGuideLineDetail.Qty}} {{DUProGuideLineDetail.MUnit}} </h4>
        </div>
        <div class="modal-body form-horizontal regionExportUP ms-custom-control" id="modal-body">
           <div class="row">
               <fieldset> <legend> Order Info: </legend>
                     <div class="row col-md-12">
                         <div class="col-md-2 text-right"><label class="control-label">Order No :</label></div>
                         <div class="col-md-4 text-left">
                             <input ng-model="DUProGuideLineDetail.DyeingOrderNo" class="form-control" disabled>
                             @* <div class="input-group">
                            <input class="form-control" ng-model="DUProGuideLine.DyeingOrderNo" placeholder="Type Order & Press Enter" ng-disabled="orderDisabled" ng-keydown="SearchKeyDownOrder($event,1)" style="width:80%" />
                            <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickOrder(1)" ng-disabled="orderDisabled" style="width:20%"><span aria-hidden="true"> Pick </span></button>
                        </div>*@
                         </div>
                         <div class="col-md-2 text-right"><label class="control-label">Product :</label></div>
                         <div class="col-md-4 text-left">
                             <input ng-model="DUProGuideLineDetail.ProductName" class="form-control" disabled>
                             @*<div class="input-group">
                            <input class="form-control" ng-model="DUProGuideLine.ProductName" placeholder="Type Ref No & Press Enter" ng-disabled="orderDisabled" ng-keydown="SearchKeyDownOrder($event,2)" style="width:80%" />
                            <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickOrder(2)" ng-disabled="orderDisabled" style="width:20%"><span aria-hidden="true"> Pick </span></button>
                        </div>*@
                         </div>
                     </div>
                     <div class="row col-md-12 ">
                         <div class="col-md-2 text-right"><label class="control-label">Customer:</label></div>
                         <div class="col-md-4 text-left">
                             <input ng-model="DUProGuideLineDetail.ContractorName" class="form-control" disabled>
                         </div>
                         <div class="col-md-2 text-right"><label class="control-label">Store:</label></div>
                         <div class="col-md-4 text-left">
                             <input type="text" class="form-control" ng-model="DUProGuideLineDetail.StoreName" disabled>
                         </div>
                     </div>
                 </fieldset>
            
               <fieldset style="height:100%">
                   <legend>Lots : </legend>
                   <div class="col-md-12">
                       <div class="row">
                           <div class="col-md-12 form-inline">
                               @*<div class="col-md-3 text-right"><label class="control-label">LotNo:</label></div>
                               <div class="col-md-7 text-left">
                                   <div class="form-inline">
                                       <input class="form-control" ng-model="txtLotNo" placeholder="Type Lot No & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownLot($event)" style="width:80%;" required />
                                       <button type="button" class="btn btn-primary btn-sm" aria-label="right Align" ng-click="PickLot()" ng-disabled="disabled"><span aria-hidden="true"> Pick </span></button>
                                   </div>
                               </div>*@
                               <input class="form-control" ng-model="DUProGuideLineDetail.txtOrderNo" placeholder="Type Order No & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownOrder($event)" style="width:210px; height:24px; margin-left:20px" required />
                               <button type="button" class="btn btn-primary btn-xs" aria-label="right Align" ng-click="PickOrderDetails()" ng-disabled="disabled"><span aria-hidden="true" class="glyphicon glyphicon-ok"> Pick </span></button>
                               <input class="form-control number" ng-model="DUProGuideLineDetail.txtLotQty_Out" placeholder="Type Qty & Press Enter" ng-disabled="disabled" ng-keydown="SearchKeyDownLotQty_Out($event)" style="width:110px; height:24px; margin-left:20px" required />
                               <button type="button" class="btn btn-success btn-xs" aria-label="right Align" ng-click="AddLot_Out()" ng-disabled="disabled"><span aria-hidden="true" class="glyphicon glyphicon-plus"> Add </span></button>
                               <button type="button" class="btn btn-danger btn-xs" aria-label="right Align" ng-click="Return_Lot()" ng-disabled="disabled"><span aria-hidden="true" class="glyphicon glyphicon-minus"> Return </span></button>
                           </div>
                       </div>

                       <div style="height:225px; width:100%" ui-grid="gridOptions_LotOthers" ui-grid-selection ui-grid-resize-columns ui-grid-edit class="grid"></div>
                   </div>
                   @*<div class="col-md-1" style="padding-top:10%">
                        <button type="button" class="btn btn-info btn-sm" aria-label="right Align" style="float:left; margin-left:1%" ng-click="SetSelectedOrder()" ng-disabled="disabled"><span aria-hidden="true"> >> </span></button>
                    </div>
                    <div class="row col-md-4">
                        <fieldset>
                            <legend> Transfer Info: </legend>
                             <div class="col-md-12" style="padding-top:10%">
                                     <label class="control-label">Lot No:</label>
                             </div>
                            <div class="col-md-12">
                                 <input class="form-control" ng-model="DUProGuideLineDetail.LotNo" placeholder="Type Lot No & Press Enter" disabled ng-keydown="SearchKeyDownLot($event)" style="width:100%;" required />
                            </div>
                            <div class="col-md-12">
                               <label class="control-label">Qty:</label>
                            </div>
                            <div class="col-md-12" style="padding-bottom:25%">
                                <input class="form-control number" ng-model="DUProGuideLineDetail.Qty" placeholder="Type Lot No & Press Enter" ng-disabled="disabled" style="width:100%;" required />
                            </div>
                       </fieldset>
                    </div>*@
               </fieldset>
               
           </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-success btn-sm" aria-label="Left Align" ng-click="AdjustLot()" ng-disabled="disabled" ng-hide="hide"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Ok</button>
            <button type="button" class="btn-danger btn-sm" aria-label="Left Align" ng-click="cancel()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel</button>
        </div>
    </script>
</div>

<style type="text/css">

    .grid{
        width:100%; 
        height:290px;
    }
     /*.ui-grid-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
        height:35px;
    }*/
    .regionDUProGuideLine .form-horizontal .control-label{
        padding-top:3px;
    }
    .regionDUProGuideLine .form-control{
        height:22px;
        padding:0px 5px;
        font-size:12px;
    }
    .regionDUProGuideLine .col-md-12{
        width:100%;
        padding-right:5px;
        padding-left:5px;
        margin-bottom:5px;
    }
    .regionDUProGuideLine .col-md-2{
        width:12%;
        padding-right:5px;
        padding-left:5px;
    }
    .regionDUProGuideLine .col-md-3{
        width:21%;
        padding-right:5px;
        padding-left:5px;
    }

    .regionDUProGuideLine .col-md-4{
        width:28%;
        padding-right:5px;
        padding-left:5px;
    }

    .regionDUProGuideLine .col-md-5{
        width:40%;
        padding-right:5px;
        padding-left:0px;
    }
     .regionDUProGuideLine .col-md-6{
        width:54.5%;
        padding-right:5px;
        padding-left:5px;
    }
     .regionDUProGuideLine .col-md-10{
        width:88%;
        padding-right:5px;
        padding-left:5px;
    }
    .regionDUProGuideLine .col-md-7{
        width:54.6%;
        padding-right:5px;
        padding-left:5px;
    }
    .regionDUProGuideLine .col-md-8{
        width:69%;
        padding-right:0px;
        padding-left:0px;
    }
    .regionDUProGuideLine .btn-sm{
         padding:1px 10px;
     }
     .regionDUProGuideLine .input-group-addon{
         padding:2px 6px;
     }
</style>

<script type="text/javascript">
    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    var oDUProGuideLine =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oProductNatures =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ProductNatures));
    var oReceiveStores =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ReceivedStores));
    var oOrderTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DUOrderSetups));
    var oContractorTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ContractorTypes));

    $('.date-container').datepicker({
        format: "dd M yyyy",
        calendarWeeks: true,
        autoclose: true,
        todayHighlight: true
    });

    var DUProGuideLineModule = angular.module('DUProGuideLineAPP', ['ngAnimate', 'ui.bootstrap', 'ui.grid', 'ui.grid.selection', 'ui.grid.edit','ui.grid.resizeColumns','ui.grid.cellNav','ms.service']);
    DUProGuideLineModule.controller('DUProGuideLineCtrl', function ($scope, $http, $uibModal, $log, uiGridConstants, msModal,icsMethod, userSession,msGridControl) {
        debugger;
        sessionStorage.setItem('BaseAddress',_sBaseAddress)
        var viewType = sessionStorage.getItem("Operation");

        //$scope.DUProGuideLine.IssueDateST = new Date($scope.DUProGuideLine.IssueDateST);
        //if (viewType == 'View') //Default
        $scope.disabled= false;
        $scope.orderDisabled= false;
        $scope.hide=false;
        $scope.hide_Receive=false;
        $scope.hide_Issue=false;
        $scope.hide_Approve=false;
        $scope.hide_UndoApprove=false;
        $scope.hide_Save=false;
        $scope.hide_Update=false;

        $scope.viewType=viewType;
        if (viewType == 'Approve')
        {
            $scope.disabled= true;
            $scope.orderDisabled= true;
            $scope.hide=true;
            $scope.hide_Receive=false;
            $scope.hide_Issue=false;
            $scope.hide_Approve=true;
            $scope.hide_UndoApprove=false;
            $scope.hide_Save=false;
            $scope.hide_Update=false;
        }
        if(viewType == 'UndoApprove')
        {
            $scope.disabled= true;
            $scope.orderDisabled= true;
            $scope.hide=true;
            $scope.hide_Receive=false;
            $scope.hide_Issue=false;
            $scope.hide_UndoApprove=true;
            $scope.hide_Approve=false;
            $scope.hide_Save=false;
        }
        else  if (viewType == 'Receive')
        {
            $scope.disabled= true;
            $scope.orderDisabled= true;
            $scope.hide=true;
            $scope.hide_Receive=true;
            $scope.hide_Issue=false;
            $scope.hide_Approve=false;
            $scope.hide_UndoApprove=false;
            $scope.hide_Save=false;
            $scope.hide_Update=true;
        }
        else if (viewType == 'Edit' || viewType == 'New')
        {
            $scope.disabled= false;
            $scope.orderDisabled= false;
            $scope.hide=false;
            $scope.hide_Request=false;
            $scope.hide_UndoApprove=false;
            $scope.hide_Approve=false;
            $scope.hide_Save=true;
        }
        else if (viewType == 'View')
        {
            $scope.disabled= true;
            $scope.orderDisabled= true;
            $scope.hide=true;
            $scope.hide_Request=false;
            $scope.hide_UndoApprove=false;
            $scope.hide_Approve=false;
            $scope.hide_Save=false;
        }
        else if (viewType == 'Update')
        {
            $scope.disabled= true;
            $scope.orderDisabled= false;
            $scope.hide=true;
            $scope.hide_Request=false;
            $scope.hide_UndoApprove=false;
            $scope.hide_Approve=false;
            $scope.hide_Update=true;
            $scope.hide_Save=false;
        }

        $scope.ContractorTypes=oContractorTypes;
        $scope.ReceiveStores=oReceiveStores;
        $scope.ProductNatures=oProductNatures;
        $scope.DUProGuideLine=oDUProGuideLine;
        $scope.OrderTypes =oOrderTypes;

        $scope.cboStoreChange= function(nSet)
        {
            for(var i=0; i< $scope.ReceiveStores.length; i++)
            {
                if($scope.ReceiveStores[i].WorkingUnitID==$scope.DUProGuideLine.WorkingUnitID)
                {
                    $scope.ReceiveStoreName=$scope.ReceiveStores[i].OperationUnitName;
                    break;
                }
            }

            var oDUProGuideLineDetailsTemp=[];
            if(nSet==1)
            {
                //var oDUProGuideLineDetails =  $scope.gridOptionsDUProGuideLineDetail.data;
                //for(var i=0; i<oDUProGuideLineDetails.length; i++)
                //{
                //    oDUProGuideLineDetails[i].LotID=0;
                //    oDUProGuideLineDetails[i].LotNo="";
                //    oDUProGuideLineDetailsTemp.push(oDUProGuideLineDetails[i]);
                //}
                //$scope.gridOptionsDUProGuideLineDetail.data=oDUProGuideLineDetailsTemp;
            }
        }
        $scope.cboStoreChange(2);

        $scope.Validation = function()
        {
            //if($scope.DUProGuideLine.OrderType<=0 && viewType == 'Approve')
            //{
            //    alert("Please Select Order Type And Try Again.");
            //    angular.element('#cboOrderType').trigger('focus');
            //    return false;
            //}
            //if($scope.DUProGuideLine.DyeingOrderID<=0 && viewType == 'Approve')
            //{
            //    alert("Please Select Order And Try Again.");
            //    angular.element('#cboOrderType').trigger('focus');
            //    return false;
            //}
            if($scope.DUProGuideLine.ProductTypeInt<=0)
            {
                alert("Please Select Product Type And Try Again.");
                angular.element('#cboOrderType').trigger('focus');
                return false;
            }

            if($scope.DUProGuideLine.WorkingUnitID<=0)
            {
                alert("Please Select Receive Store And Try Again.");
                angular.element('#cboReceiveStore').trigger('focus');
                return false;
            }
            if($scope.DUProGuideLine.ContractorID<=0)
            {
                alert("Please Select Buyer!!");
                return;
            }
            $scope.DUProGuideLine.DUProGuideLineDetails=$scope.gridOptionsDUProGuideLineDetail.data;
            if($scope.DUProGuideLine.DUProGuideLineDetails.length<=0)
            {
                alert("Please Select Details And Try Again.");
                return false;
            }

            var oDUProGuideLineDetails =  $scope.gridOptionsDUProGuideLineDetail.data;
            for(var i=0; i<oDUProGuideLineDetails.length; i++)
            {
                if(oDUProGuideLineDetails[i].Qty<=0)
                {
                    alert("Please Set Qty(valid) For "+oDUProGuideLineDetails[i].ProductName+" And Try Again.");
                    return false;
                }
            }

            //if (viewType == 'Receive')
            //{
            //    var oDUProGuideLineDetails =  $scope.gridOptionsDUProGuideLineDetail.data;
            //    for(var i=0; i<oDUProGuideLineDetails.length; i++)
            //    {
            //        if(oDUProGuideLineDetails[i].LotID==0)
            //        {
            //            alert("Please Pick Lot For "+oDUProGuideLineDetails[i].ProductName+" And Try Again.");
            //            return false;
            //        }
            //    }
            //}
            return true;
        }
        $scope.Save = function ()
        {
            if(!$scope.Validation()) return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            //alert(oDUProGuideLine.ProductTypeInt);
            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/Save',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    console.log(result);
                    if(result.DUProGuideLineID>0 && result.ErrorMessage=="")
                    {
                        debugger;
                        alert("Data Saved Successfully!!");
                        $scope.DUProGuideLine=result;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);
                        userSession.previousPage();
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        $scope.Update = function ()
        {
            if(!$scope.Validation()) return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            //alert(oDUProGuideLine.ProductTypeInt);
            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/Save',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    console.log(result);
                    if(result.DUProGuideLineID>0 && result.ErrorMessage=="")
                    {
                        debugger;
                        alert("Data Saved Successfully!!");
                        $scope.DUProGuideLine=result;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);
                        userSession.previousPage();
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        $scope.Approve = function ()
        {
            if(!$scope.Validation())
                return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            oDUProGuideLine.ReqDate = new Date($scope.DUProGuideLine.ReqDateST);
            oDUProGuideLine.ImportLCDate = new Date($scope.DUProGuideLine.ImportLCDateST);

            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/ApproveDUProGuideLine',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    if(result.DUProGuideLineID>0)
                    {
                        debugger;
                        $scope.DUProGuideLine=result;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);
                        userSession.previousPage();
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        $scope.UndoApprove = function () {
            if(!$scope.Validation())
                return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            oDUProGuideLine.ReqDate = new Date($scope.DUProGuideLine.ReqDateST);
            oDUProGuideLine.ImportLCDate = new Date($scope.DUProGuideLine.ImportLCDateST);

            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/UndoApproveDUProGuideLine',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    if(result.DUProGuideLineID>0)
                    {
                        debugger;
                        $scope.DUProGuideLine=result;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);
                        userSession.previousPage();
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        $scope.Receive = function ()
        {
            if(!$scope.Validation())
                return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            oDUProGuideLine.ReqDate = new Date($scope.DUProGuideLine.ReqDateST);
            oDUProGuideLine.ImportLCDate = new Date($scope.DUProGuideLine.ImportLCDateST);

            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/RecivedDUProGuideLine',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    if(result.DUProGuideLineID>0)
                    {
                        debugger;
                        $scope.DUProGuideLine=result;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);
                        //sessionStorage.setItem('DUProGuideLine',$scope.DUProGuideLine);
                        userSession.previousPage();
                        // msModal.Message({headerTitle : '', bodyText:'Save Successfully.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).Message);}
        );
        };

        $scope.GetOrderDetails= function ()
        {
            debugger;
            var oDUProGuideLine= {
                DyeingOrderID:$scope.DUProGuideLine.DyeingOrderID
            };
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetsDyeingOrderDetails',$.param(oDUProGuideLine), config).then(
                        function (response)
                        {
                            debugger;

                            //var result=response.data;
                            var result=jQuery.parseJSON(response.data);
                         
                           
                            debugger;
                            if(result.length>0)
                            {
                                $scope.DUProGuideLine.DUProGuideLineDetails=result;
                                $scope.MakeDUProGuideLineDetail();
                            }else {alert("No Data Found!!");}
                        },
                            function (response) { alert(jQuery.parseJSON(response.data)[0].Message);}
                    );
        };
        $scope.PickBuyer= function ()
        {
            var oContractor= {
                Params: $scope.DUProGuideLine.ContractorType+'~'+(($scope.DUProGuideLine.ContractorName==undefined)? '':$scope.DUProGuideLine.ContractorName)
            };
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(oContractor), config).then(
                        function (response)
                        {
                            var oDetailColumns = [];
                            var oColumn = { field: 'ContractorID', name:'Code', width:'8%',cellClass: 'text-right', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'Name', name:'Name', width:'92%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            var results=response.data;
                            if(results[0].ContractorID==0)
                            {
                                alert("No Order Found!!"); return;
                            }

                            var modalObj={
                                size:'md',
                                url:_sBaseAddress+'/Home/Modal',
                                modalcontroller:'',
                                appcontroller:'DUProGuideLineCtrl',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Buyer List',
                                searchingbyfieldName:'Name',
                                columns:oDetailColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            //var oDUProGuideLineDetails =  $scope.gridOptionsDUProGuideLineDetail.data;
                            modalInstance.result.then(function (result)
                            {
                                if(result.ContractorID>0)
                                {
                                    $scope.DUProGuideLine.ContractorName=result.Name;
                                    $scope.DUProGuideLine.ContractorID=result.ContractorID;
                                }else
                                {
                                    alert("No Data Selected!!");
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { debugger;  alert(response.statusText);}
                    );
        };
        $scope.SearchKeyDownBuyer = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);

            if (code == 13)
            {
                var txtOrder = $.trim($scope.DUProGuideLine.ContractorName);
                if(txtOrder=="" || txtOrder==null)
                {
                    alert("Type Buyer Name and Press Enter");
                    return;
                }

                $scope.PickBuyer();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.DUProGuideLine.DyeingOrderNo='';
                $scope.DUProGuideLine.DyeingOrderID=0;
                $scope.DUProGuideLine.ContractorID=0;
            }
        };

        $scope.PickOrder= function (nBtn)
        {
            //if($scope.DUProGuideLine.OrderType<=0)
            //{
            //    alert("Please Select Order Type!!");
            //    return;
            //}
            var sOrderRefNo=(nBtn==2?$scope.DUProGuideLine.RefNo:$scope.DUProGuideLine.DyeingOrderNo);

            var oDyeingOrder= {
                OrderNo:(sOrderRefNo == undefined ? "" : sOrderRefNo),
                ContractorID:($scope.DUProGuideLine.ContractorID == undefined ? 0 :  $scope.DUProGuideLine.ContractorID),
                DyeingOrderType:($scope.DUProGuideLine.OrderType == undefined ? 0 :  $scope.DUProGuideLine.OrderType),
            };
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetsDyeingOrder',$.param(oDyeingOrder), config).then(
                        function (response)
                        {
                            debugger;
                            var oDetailColumns = [];
                            var oColumn = { field: 'OrderNoFull', name:'Order No', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'ContractorName', name:'Buyer', width:'40%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'RefNo', name:'Ref No', width:'15%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'StyleNo', name:'Style No', width:'12%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'Qty', name:'Qty', width:'12%',cellClass: 'text-left', cellFilter:'number:2',enableCellEdit:false };oDetailColumns.push(oColumn);
                            //oColumn = { field: 'MUnit', name:'Unit', width:'12%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            //oColumn ={ field: 'Qty_Preq', name:'Already Used', width:'14%',cellClass: 'text-left',enableCellEdit:false };oDetailColumns.push(oColumn);
                            var results=response.data;

                            if(results.length<=0)
                            {
                                alert("No Order Found!!"); return;
                            }

                            var modalObj={
                                size:'lg',
                                modalcontroller:'',
                                url:_sBaseAddress+'/Home/Modal',
                                appcontroller:'DUProGuideLineCtrl',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Order List',
                                searchingbyfieldName:'DestinationLotNo',
                                columns:oDetailColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            var oDUProGuideLineDetails =  $scope.gridOptionsDUProGuideLineDetail.data;

                            modalInstance.result.then(function (result)
                            {
                                $scope.DUProGuideLine.DyeingOrderID=result.DyeingOrderID;
                                $scope.DUProGuideLine.DyeingOrderNo=result.OrderNo;
                                $scope.DUProGuideLine.RefNo=result.RefNo;
                                $scope.DUProGuideLine.ContractorName=result.ContractorName;
                                $scope.DUProGuideLine.ContractorID=result.ContractorID;
                                $scope.DUProGuideLine.OrderType=result.DyeingOrderType;
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) {debugger; alert(response.statusText);}
                    );
        };
        $scope.SearchKeyDownOrder = function (e, nKey){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var sOrderRefNo=(nKey==2?$scope.DUProGuideLine.RefNo:$scope.DUProGuideLine.DyeingOrderNo);

                var txtOrder = $.trim(sOrderRefNo);
                if(txtOrder=="" || txtOrder==null)
                {
                    alert("Type Order/Ref No and Press Enter");
                    return;
                }

                $scope.PickOrder(nKey);
            }else if (code == 8) //backspace=8
            {
                //debugger;
                //$scope.DUProGuideLine.DyeingOrderNo='';
            }
        };

        $scope.PickProduct= function ()
        {

           
            $scope.txtLotNo="";
            var oPorduct= {
                ProductName:($scope.DUProGuideLine.txtProductName == undefined ? "" : $scope.DUProGuideLine.txtProductName),
                BUID:$scope.DUProGuideLine.BUID,
                ProductUsagesInInt:0
            };
            
            if($scope.DUProGuideLine.ProductTypeInt==3)///Yarn
            {
                oPorduct.ProductUsagesInInt=1;
            }
            else if($scope.DUProGuideLine.ProductTypeInt==4)///DC
            {
                oPorduct.ProductUsagesInInt=9;
            }
            else{
                oPorduct.ProductUsagesInInt=1;
            }


            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetProducts',$.param(oPorduct), config).then(
                        function (response)
                        {
                            debugger;
                            var oDetailColumns = [];
                            var   oColumn = { field: 'ProductCode', name:'Code', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'ProductName', name:'Porduct', width:'65%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'MUnit', name:'MUnit', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            var results=JSON.parse(response.data);
                            var modalObj={
                                size:'lg',
                                url:_sBaseAddress+'/Home/Modal',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Porduct List',
                                searchingbyfieldName:'DestinationLotNo',
                                columns:oDetailColumns
                            }
                            debugger;

                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                if(result.ProductID>0)
                                {
                                    $scope.DUProGuideLine.txtProductName="";
                                    var oProduct=
                                        {
                                            ProductID:result.ProductID,
                                            ProductName:result.ProductName,
                                            MUnit:result.MUnit,
                                            MUnitID:result.MeasurementUnitID,
                                            Qty:0,
                                            Qty_Order:0,
                                            Remarks:""
                                        }
                                    $scope.gridOptionsDUProGuideLineDetail.data.push(oProduct);
                                }
                                else
                                {
                                    $scope.DUProGuideLine.ProductID=0;
                                    $scope.DUProGuideLine.ProductName="";
                                    $scope.DUProGuideLine.MUnit="";
                                    $scope.txtProductName="";
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(response.statusText);}
                    );
        };
        $scope.SearchKeyDownProduct = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtPorduct = $.trim($scope.DUProGuideLine.txtProductName);
                if(txtPorduct=="" || txtPorduct==null)
                {
                    alert("Type Product Name and Press Enter");
                    return;
                }

                $scope.PickProduct();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };
        $scope.RemoveProduct= function ()
        {
            var oDetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            //var data=$scope.gridApi.selection.getSelectedRows();
            if(oDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptionsDUProGuideLineDetail.data.indexOf(oDetail);
            if (!confirm("Confirm to Remove?")) return ;
            $scope.gridOptionsDUProGuideLineDetail.data.splice(SelectedRowIndex,1);
        }

        $scope.Modal = function (objSQ, operation) {
            debugger;
            var modalInstance = $uibModal.open({
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                size: 'md',
                templateUrl: 'DUProGuideLine.html',
                controller: 'ModalInstanceCtrl',
                controllerAs: 'DUProGuideLineCtrl',
                resolve: {
                    obj: function () {
                        return { DUProGuideLineDetail:objSQ, Operation: operation  };
                    }
                }
            });

            modalInstance.result.then(function (result) {
                debugger;
                if(result.ProductID>0)
                {
                    debugger;
                    var index=sessionStorage.getItem('SelectedOrderIndex');
                    $scope.gridOptionsDUProGuideLineDetail.data[index]=result;
                    $scope.gridApi.selection.selectRow($scope.gridOptionsDUProGuideLineDetail.data[index]);
                    $scope.RowSelect(oDUProGuideLines[userSession.getRowIndex()]);
                }
            }, function () {
                $log.info('Modal dismissed at: ' + new Date());
            });
        };
        //$scope.OrderQty=0.0;
        $scope.OpenLotModal = function(id)
        {
            var oDUProGuideLine = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oDUProGuideLine==undefined)
            {
                return;
            }
            debugger;
            if($scope.DUProGuideLine.ContractorID<=0)
            {
                alert("Select Buyer!!");
                return;
            }
            if($scope.DUProGuideLine.WorkingUnitID<=0)
            {
                alert("Select Store!!");
                return;
            }
            angular.forEach($scope.gridOptionsDUProGuideLineDetail.data,function(value,index){
                if(value.ProductID==oDUProGuideLine.ProductID)
                {
                    sessionStorage.setItem("SelectedOrderIndex", index);
                }
            },$scope.gridOptionsDUProGuideLineDetail.data);

            oDUProGuideLine.BUID=$scope.DUProGuideLine.BUID;
            oDUProGuideLine.ReceiveStoreName=$scope.ReceiveStoreName;
            oDUProGuideLine.WorkingUnitID=$scope.DUProGuideLine.WorkingUnitID;
            oDUProGuideLine.ContractorID=$scope.DUProGuideLine.ContractorID;
            $scope.Modal( oDUProGuideLine, 'Edit');
        }

        $scope.Save_DUPGL_ForAdjust = function(oDUGLDetail)
        {
            if(!$scope.Validation()) return;
            var oDUProGuideLine= $scope.DUProGuideLine;
            oDUProGuideLine.IssueDate = new Date($scope.DUProGuideLine.IssueDateST);
            //alert(oDUProGuideLine.ProductTypeInt);
            debugger;
            $http.post(_sBaseAddress+'/DUProGuideLine/Save',JSON.stringify(oDUProGuideLine)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    console.log(result);
                    if(result.DUProGuideLineID>0 && result.ErrorMessage=="")
                    {
                        debugger;
                        alert("Data Saved Successfully!!");
                        $scope.DUProGuideLine=result;
                        $scope.gridOptionsDUProGuideLineDetail.data=result.DUProGuideLineDetails;
                        userSession.setData('DUProGuideLines',$scope.DUProGuideLine);

                        oDUGLDetail.BUID=$scope.DUProGuideLine.BUID;
                        oDUGLDetail.ReceiveStoreName=$scope.ReceiveStoreName;
                        oDUGLDetail.WorkingUnitID=$scope.DUProGuideLine.WorkingUnitID;
                        oDUGLDetail.ContractorID=$scope.DUProGuideLine.ContractorID;
                        oDUGLDetail.DyeingOrderID=$scope.DUProGuideLine.DyeingOrderID;
                        oDUGLDetail.DyeingOrderNo=$scope.DUProGuideLine.DyeingOrderNo;
                        oDUGLDetail.ContractorName=$scope.DUProGuideLine.ContractorName;
                        $scope.Modal_Adjust(oDUGLDetail, 'Edit');
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);});
        }
        $scope.Modal_Adjust = function (oDUPGLD, operation) {
            debugger;

            oDUPGLD =  $.extend(true,{},oDUPGLD);// Object.assign({}, oDUPGLD);

            var modalInstance = $uibModal.open({
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                size: 'lg',
                templateUrl: 'Adjust_DUProGuideLine.html',
                controller: 'ModalInstanceCtrl_Adjust',
                controllerAs: 'DUProGuideLineCtrl',
                resolve: {
                    obj: function () {
                        return { DUProGuideLineDetail:oDUPGLD, Operation: operation  };
                    }
                }
            });

            modalInstance.result.then(function (result) {
                debugger;
                if(result.LotParentID>0)
                {
                    debugger;
                    var index=sessionStorage.getItem('SelectedOrderIndex');
                    $scope.gridOptionsDUProGuideLineDetail.data[index].LotID=result.LotID;
                    $scope.gridOptionsDUProGuideLineDetail.data[index].LotNo=result.LotNo;
                    $scope.gridOptionsDUProGuideLineDetail.data[index].Qty=result.Qty;
                    $scope.gridOptionsDUProGuideLineDetail.data[index].Balance= parseFloat($scope.gridOptionsDUProGuideLineDetail.data[index].Qty_Order) - parseFloat(result.Qty);
                    $scope.gridApi.selection.selectRow($scope.gridOptionsDUProGuideLineDetail.data[index]);
                    $scope.RowSelect(oDUProGuideLines[userSession.getRowIndex()]);
                }
            }, function () {
                $log.info('Modal dismissed at: ' + new Date());
            });
        };
        //$scope.OrderQty=0.0;
        $scope.OpenAdjustLotModal = function(id)
        {
            var oDUProGuideLine = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oDUProGuideLine==undefined)
            {
                return;
            }
            debugger;

            if($scope.DUProGuideLine.ContractorID<=0)
            {
                alert("Select Buyer!!");
                return;
            }
            if($scope.DUProGuideLine.WorkingUnitID<=0)
            {
                alert("Select Store!!");
                return;
            }
            if($scope.DUProGuideLine.DyeingOrderID<=0)
            {
                alert("Dyeing Order Not Found!!");
                return;
            }
            angular.forEach($scope.gridOptionsDUProGuideLineDetail.data,function(value,index){
                if(value.ProductID==oDUProGuideLine.ProductID)
                {
                    sessionStorage.setItem("SelectedOrderIndex", index);
                }
            },$scope.gridOptionsDUProGuideLineDetail.data);

            
            if(oDUProGuideLine.DUProGuideLineDetailID<=0)
            {
                if(confirm("You have to save first. Confirm to save?")) //            if (!confirm("Confirm to Remove?")) return ;
                    $scope.Save(); //$scope.Save_DUPGL_ForAdjust(oDUProGuideLine);
                else return;
            }else
            {
                oDUProGuideLine.BUID=$scope.DUProGuideLine.BUID;
                oDUProGuideLine.ReceiveStoreName=$scope.ReceiveStoreName;
                oDUProGuideLine.WorkingUnitID=$scope.DUProGuideLine.WorkingUnitID;
                oDUProGuideLine.ContractorID=$scope.DUProGuideLine.ContractorID;
                oDUProGuideLine.DyeingOrderID=$scope.DUProGuideLine.DyeingOrderID;
                oDUProGuideLine.DyeingOrderNo=$scope.DUProGuideLine.DyeingOrderNo;
                oDUProGuideLine.ContractorName=$scope.DUProGuideLine.ContractorName;
                $scope.Modal_Adjust(oDUProGuideLine, 'Edit');
            }

           
        }

        $scope.MakeDUProGuideLineDetail= function()
        {
            debugger;
            var oDetailColumns = [];
            var oColumn =  {name: 'SL No',width:'6%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
            oColumn = { field: 'ProductName', name:'Commodity', width:'17%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn = { field: 'Qty_Order', name:'Order Qty', width:'12%',cellClass: 'text-right', cellFilter:'number:2', enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn = { field: 'LotNo', name:'Lot No', width:'20%',cellClass: 'text-right', enableCellEdit:true, };oDetailColumns.push(oColumn);
                //cellTemplate:'<div>' +'<span> {{row.entity.LotNo}} </span><button style="align:right" ng-click="grid.appScope.OpenLotModal()">Pick</button>' +'</div>'};oDetailColumns.push(oColumn);
            oColumn ={ field: 'Qty_LotParent', name:'Balance', visible:false, width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Qty', name:'Rcv Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:true };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Balance', name:'Due Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
           oColumn ={ field: 'MUnit', name:'Unit', width:'8%',cellClass: 'text-left',enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Brand', name:'Brand', width:'10%',cellClass: 'text-left',enableCellEdit:true };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Note', name:'Remarks', width:'10%',cellClass: 'text-left',enableCellEdit:true };oDetailColumns.push(oColumn);

            $scope.gridOptionsDUProGuideLineDetail = {
                enableRowSelection: true,
                enableRowHeaderSelection: false,
                multiSelect: false,
                enableColumnResizing: true,
                showColumnFooter: false,
                cellEditableCondition: function($scope)
                {
                    debugger;
                    if (viewType == 'Edit' || viewType == 'New' ||viewType == 'Receive')
                    {
                        if($scope.row.entity.Qty<0 ||$scope.row.entity.Qty==undefined)
                            return false;
                        else
                        {
                            if($scope.row.entity.OrderQty==undefined)
                                $scope.row.entity.OrderQty=$scope.row.entity.Qty;
                           
                            return true;
                        }
                    }else
                        return false;
                },
                columnDefs:oDetailColumns,
                data:  $scope.DUProGuideLine.DUProGuideLineDetails,
                onRegisterApi: function (gridApi)
                {
                    $scope.gridDetailApi = gridApi;
                    gridApi.edit.on.afterCellEdit($scope,
                     function (rowEntity, colDef, newValue, oldValue)
                     {
                         debugger;
                         if(rowEntity.Qty_Order>0 )
                         {
                             //if( rowEntity.Qty > ( parseFloat(rowEntity.Qty_Order) + (rowEntity.Qty_Order*1)) )
                             //{
                             //    rowEntity.Qty=rowEntity.Qty_Order;
                             //    alert("Requ. Qty Can Not Be Greater Than Order Qty!!");
                             //}
                             if(rowEntity.Qty<=0 )
                             {
                                 rowEntity.Qty=rowEntity.Qty_Order;
                                 alert("Requ. Qty Can Not Be Equal Or Less Then Zero!!");
                             }
                         }
                         return rowEntity;
                     });
                }
            };

            //var oDUProGuideLineDetails=$scope.DUProGuideLine.DUProGuideLineDetails;
            // $scope.gridOptionsDUProGuideLineDetail.data=[];
            // $scope.gridOptionsDUProGuideLineDetail.data= $scope.DUProGuideLine.DUProGuideLineDetails;
        }
        $scope.MakeDUProGuideLineDetail();
        
        if($scope.DUProGuideLine.InOutType==102)
        {
            $scope.disabled= true;
            $scope.orderDisabled= true;
            
            $scope.gridOptionsDUProGuideLineDetail.columnDefs[4].visible= true;
            $scope.gridOptionsDUProGuideLineDetail.columnDefs[5].name= "Return Qty";
            $scope.gridOptionsDUProGuideLineDetail.columnDefs[6].visible= false;
        }


        $scope.CopyDetail=function()
        {
            var oDetail=$scope.gridDetailApi.selection.getSelectedRows()[0];
            var oProduct=
                        {
                            DUProGuideLineDetailID:0,
                            ProductID:oDetail.ProductID,
                            ProductName:oDetail.ProductName,
                            MUnit:oDetail.MUnit,
                            MUnitID:oDetail.MUnitID,
                            Qty:0,
                            Qty_Order:oDetail.Qty_Order,
                            Remarks:""
                        }
            $scope.gridOptionsDUProGuideLineDetail.data.push(oProduct);
        }

        $scope.Close = function () {
            userSession.previousPage();
        };
    });

    DUProGuideLineModule.controller('ModalInstanceCtrl', function ($scope, $http, $uibModalInstance, uiGridConstants, msModal, obj) {
        debugger;
        var viewType = sessionStorage.getItem("Operation");
        $scope.disabled= true;
        if (viewType == 'Edit' || viewType == 'New' || viewType == 'Receive')
        {
            $scope.disabled= false;
        }

        $scope.Operation=obj.Operation;
        $scope.DUProGuideLineDetail=obj.DUProGuideLineDetail;
        if(obj.DUProGuideLineDetail.ProductID==null || obj.DUProGuideLineDetail.ProductID<=0)
        {
            $scope.DUProGuideLineDetail={
                DUProGuideLineID : 0,
                BUID:sessionStorage.getItem('BUID'),
                Name : "",
                Activity : true
            }
        }
        else
        {
            $scope.DUProGuideLineDetail = obj.DUProGuideLineDetail;
            $scope.DUProGuideLineDetail.OrderProduct=obj.DUProGuideLineDetail.ProductName;
            $scope.DUProGuideLineDetail.StoreName=obj.DUProGuideLineDetail.ReceiveStoreName;
            $scope.txtProductName=obj.DUProGuideLineDetail.ProductName;

            if(obj.DUProGuideLineDetail.LotNo!="" && obj.DUProGuideLineDetail.LotNo!=undefined)
                $scope.txtLotNo=obj.DUProGuideLineDetail.LotNo+" [BL"+obj.DUProGuideLineDetail.LotQty+"]";
            $scope.DUProGuideLineDetail.LotProductID=obj.DUProGuideLineDetail.ProductID;
            $scope.DUProGuideLineDetail.ContractorID=obj.DUProGuideLineDetail.ContractorID;
            if(obj.DUProGuideLineDetail.LotID>0)
            {
                $scope.txtProductName=obj.DUProGuideLineDetail.LotProductName;
            }
            //$scope.DUProGuideLineDetail.LotNo="";
            //$scope.DUProGuideLineDetail.LotID=0;
        }

        $scope.PickLot= function ()
        {
            $scope.DUProGuideLineDetail.LotID=0;
            $scope.DUProGuideLineDetail.LotNo="";

            if($scope.DUProGuideLineDetail.LotProductID<=0)
            {
                alert("Please Pick a Product And Try Again"); return;
            }

            var oDyeingPorduct= {
                ContractorID:$scope.DUProGuideLineDetail.ContractorID,
                ProductID:$scope.DUProGuideLineDetail.LotProductID,
                BUID:$scope.DUProGuideLineDetail.BUID,
                LotNo:($scope.txtLotNo == undefined ? "" : $scope.txtLotNo),
                WorkingUnitID:$scope.DUProGuideLineDetail.WorkingUnitID
            };
            $scope.txtLotNo ="";
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetsLot',$.param(oDyeingPorduct), config).then(
                        function (response)
                        {
                            debugger;
                            var oDetailColumns = [];
                            var oColumn = { field: 'LotNo', name:'Lot No', width:'10%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'Balance', name:'Qty', width:'20%',cellClass: 'text-left', cellFilter:'number:2', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'ReportUnitSymbol', name:'Unit', width:'20%',cellClass: 'text-left',enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'LocationName', name:'Location', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'OperationUnitName', name:'Operation Unit', width:'20%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);

                            var results=jQuery.parseJSON(response.data);
                            if(results.length<=0)
                            {
                                alert("No Data Found!!"); return;
                            }

                            var modalObj={
                                size:'lg',
                                url:_sBaseAddress+'/Home/Modal',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Porduct List',
                                searchingbyfieldName:'DestinationLotNo',
                                columns:oDetailColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                if(result.LotID>0)
                                {
                                    $scope.DUProGuideLineDetail.LotID=result.LotID;
                                    $scope.DUProGuideLineDetail.LotNo=result.LotNo;
                                    $scope.txtLotNo=result.LotNo+" [BL-"+result.Balance+"]";
                                }
                                else
                                {
                                    $scope.DUProGuideLineDetail.LotID=0;
                                    $scope.DUProGuideLineDetail.LotNo="";
                                    $scope.txtLotNo="";
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.SearchKeyDownLot = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtLotNo = $.trim($scope.txtLotNo);
                if(txtLotNo=="" || txtLotNo==null)
                {
                    alert("Type Lot No and Press Enter");
                    return;
                }
                $scope.PickLot();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };
        $scope.PickProduct= function ()
        {
            alert("yy")
            debugger;
            $scope.DUProGuideLineDetail.LotProductID="";
            $scope.DUProGuideLineDetail.LotProductName="";
            $scope.DUProGuideLineDetail.LotID=0;
            $scope.DUProGuideLineDetail.LotNo="";
            $scope.txtLotNo="";
            var oPorduct= {
                ProductName:($scope.txtProductName == undefined ? "" : $scope.txtProductName),
                BUID:$scope.DUProGuideLineDetail.BUID
            };
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetProducts',$.param(oPorduct), config).then(
                        function (response)
                        {
                            var oDetailColumns = [];
                            var   oColumn = { field: 'ProductCode', name:'Code', width:'30%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'ProductName', name:'Porduct', width:'30%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'ProductCategoryName', name:'Category', width:'30%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                url:_sBaseAddress+'/Home/Modal',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Porduct List',
                                searchingbyfieldName:'DestinationLotNo',
                                columns:oDetailColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                if(result.ProductID>0)
                                {
                                    $scope.DUProGuideLineDetail.LotProductID=result.ProductID;
                                    $scope.DUProGuideLineDetail.LotProductName=result.ProductName;
                                    $scope.txtProductName=result.ProductName;
                                }
                                else
                                {
                                    $scope.DUProGuideLineDetail.ProductID=0;
                                    $scope.DUProGuideLineDetail.ProductName="";
                                    $scope.DUProGuideLineDetail.MUnit="";
                                    $scope.txtProductName="";
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.SearchKeyDownProduct = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtPorduct = $.trim($scope.txtProductName);
                if(txtPorduct=="" || txtPorduct==null)
                {
                    alert("Type Product Name and Press Enter");
                    return;
                }

                $scope.PickProduct();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };

        $scope.Validation=function()
        {
            if($scope.DUProGuideLineDetail.Name == "" || $scope.DUProGuideLineDetail.Name == undefined){
                msModal.Message({headerTitle : '', bodyText:'Enter DyeingType Name.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }

            return  true;
        };

        $scope.UpdateLot= function ()
        {
            debugger;
            var oDUProGuideLineDetail= $scope.DUProGuideLineDetail;
            $uibModalInstance.close(jQuery.parseJSON(oDUProGuideLineDetail));
        };

        $scope.cancel= function () {
            debugger;
            $uibModalInstance.close();
        };

    });
    
    DUProGuideLineModule.controller('ModalInstanceCtrl_Adjust', function ($scope, $http, $uibModalInstance, uiGridConstants, msModal, obj) {
        debugger;
        var viewType = sessionStorage.getItem("Operation");
        $scope.disabled= false;
        if (viewType == 'Edit' || viewType == 'New' || viewType == 'Receive')
        {
            $scope.disabled= true;
        }
       
        $scope.Operation=obj.Operation;
        $scope.DUProGuideLineDetail=  $.extend(true,{},obj.DUProGuideLineDetail); //Object.assign({}, obj.DUProGuideLineDetail); // obj.DUProGuideLineDetail;
        if(obj.DUProGuideLineDetail.ProductID==null || obj.DUProGuideLineDetail.ProductID<=0)
        {
            $scope.DUProGuideLineDetail={
                DUProGuideLineID : 0,
                BUID:sessionStorage.getItem('BUID'),
                Name : "",
                Activity : true,
                LotParent_Others:[],
                LotParent_This:[]
            }
        }
        else
        {
            $scope.DUProGuideLineDetail = obj.DUProGuideLineDetail;
            $scope.DUProGuideLineDetail.OrderProduct=obj.DUProGuideLineDetail.ProductName;
            $scope.DUProGuideLineDetail.StoreName=obj.DUProGuideLineDetail.ReceiveStoreName;
            $scope.txtProductName=obj.DUProGuideLineDetail.ProductName;
            
            $scope.DUProGuideLineDetail.LotParent_Others=[];
            $scope.DUProGuideLineDetail.LotParent_This=[];

            if(obj.DUProGuideLineDetail.LotNo!="" && obj.DUProGuideLineDetail.LotNo!=undefined)
                $scope.txtLotNo=obj.DUProGuideLineDetail.LotNo+" [BL"+obj.DUProGuideLineDetail.LotQty+"]";
            $scope.DUProGuideLineDetail.LotProductID=obj.DUProGuideLineDetail.ProductID;
            $scope.DUProGuideLineDetail.ContractorID=obj.DUProGuideLineDetail.ContractorID;
            if(obj.DUProGuideLineDetail.LotID>0)
            {
                $scope.txtProductName=obj.DUProGuideLineDetail.LotProductName;
            }
            //$scope.GetLot_Others();
            //$scope.DUProGuideLineDetail.LotNo="";
            //$scope.DUProGuideLineDetail.LotID=0;
        }
        
        
        $scope.MakeLot_Others= function()
        {
            debugger;
            var oDetailColumns = [];
            var oColumn =  {name: '#',width:'6%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
            oColumn = { field: 'DyeingOrderNo', name:'OrderNo', width:'25%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn = { field: 'LotNo', name:'Lot No', width:'30%',cellClass: 'text-right', enableCellEdit:true, };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Qty', name:'Qty', width:'18%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:true };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Balance', name:'Balance', width:'18%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
           
            $scope.gridOptions_LotOthers = {
                enableRowSelection: true,
                enableRowHeaderSelection: false,
                multiSelect: false,
                enableColumnResizing: true,
                showColumnFooter: false,
                cellEditableCondition: function($scope)
                {
                    return false;
                },
                columnDefs:oDetailColumns,
                data:  $scope.DUProGuideLineDetail.LotParent_Others,
                onRegisterApi: function (gridApi)
                {
                    $scope.gridApi_Others = gridApi;
                    //$scope.gridApi_Others.selection.on.rowSelectionChanged($scope, function (row) {
                    //    $scope.SetSelectedOrder(row.entity ); });
                }
            };
        }
        $scope.MakeLot_Others();

        $scope.PickLot= function ()
        {
            $scope.DUProGuideLineDetail.LotID=0;
            $scope.DUProGuideLineDetail.LotNo="";

            if($scope.DUProGuideLineDetail.LotProductID<=0)
            {
                alert("Please Pick a Product And Try Again"); return;
            }

            var oDyeingPorduct= {
                ContractorID:$scope.DUProGuideLineDetail.ContractorID,
                //ProductID:$scope.DUProGuideLineDetail.LotProductID,
                DyeingOrderID:$scope.DUProGuideLineDetail.DyeingOrderID,
                LotNo:($scope.txtLotNo == undefined ? "" : $scope.txtLotNo),
                WorkingUnitID:$scope.DUProGuideLineDetail.WorkingUnitID
            };
            $scope.txtLotNo ="";
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetsLot_Others',$.param(oDyeingPorduct), config).then(
                        function (response)
                        {
                            debugger;
                            var oDetailColumns = [];
                            var oColumn =  {name: 'SL No',width:'6%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
                            oColumn = { field: 'DyeingOrderNo', name:'OrderNo', width:'17%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn = { field: 'LotNo', name:'Lot No', width:'20%',cellClass: 'text-right', enableCellEdit:true, };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'Qty', name:'Rcv Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:true };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'Balance', name:'Due Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
                            oColumn ={ field: 'ProductName', name:'ProductName', width:'20%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
           
                            var results=jQuery.parseJSON(response.data);
                            if(results.length<=0)
                            {
                                alert("No Data Found!!"); return;
                            }

                            var modalObj={
                                size:'lg',
                                url:_sBaseAddress+'/Home/Modal',
                                modalcontroller:'',
                                appcontroller:'',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Porduct List',
                                searchingbyfieldName:'DestinationLotNo',
                                columns:oDetailColumns
                            }
                            var modalInstance=msModal.Instance(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                if(result.LotID>0)
                                {
                                    $scope.gridOptions_LotOthers.data.push(result);
                                }
                                else
                                {
                                    $scope.DUProGuideLineDetail.LotID=0;
                                    $scope.DUProGuideLineDetail.LotNo="";
                                    $scope.txtLotNo="";
                                }
                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.SearchKeyDownLot = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtLotNo = $.trim($scope.txtLotNo);
                if(txtLotNo=="" || txtLotNo==null)
                {
                    alert("Type Lot No and Press Enter");
                    return;
                }
                $scope.PickLot();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };
        
        $scope.MakeLot_This= function()
        {
            debugger;
            var oDetailColumns = [];
            var oColumn =  {name: 'SL No',width:'6%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
            oColumn = { field: 'DyeingOrderNo', name:'OrderNo', width:'17%',cellClass: 'text-left', enableCellEdit:false };oDetailColumns.push(oColumn);
            oColumn = { field: 'LotNo', name:'Lot No', width:'20%',cellClass: 'text-right', enableCellEdit:true, };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Qty', name:'Rcv Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:true };oDetailColumns.push(oColumn);
            oColumn ={ field: 'Balance', name:'Due Qty', width:'10%',cellClass: 'text-right',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right',enableCellEdit:false };oDetailColumns.push(oColumn);
           
            $scope.gridOptions_LotThis= {
                enableRowSelection: true,
                enableRowHeaderSelection: false,
                multiSelect: false,
                enableColumnResizing: true,
                showColumnFooter: false,
                cellEditableCondition: function($scope)
                {
                    return false;
                },
                columnDefs:oDetailColumns,
                data:  $scope.DUProGuideLineDetail.LotParent_This,
                onRegisterApi: function (gridApi)
                {
                    $scope.gridApi_This = gridApi;
                }
            };
        }
        $scope.MakeLot_This();

        $scope.SetSelectedOrder = function(oDetail)
        {
            debugger;
            if(oDetail==null || oDetail.LotID<=0)
            {
                alert("Invalid Lot!");return;
            }
            if(oDetail.Qty<=0)
            {
                alert("Lot Quantity is not sufficient!");return;
            }
            $scope.DUProGuideLineDetail.LotID=oDetail.LotID;
            $scope.txtLotNo=oDetail.LotNo;
            $scope.DUProGuideLineDetail.LotNo=oDetail.LotNo;
            $scope.DUProGuideLineDetail.Qty=oDetail.Qty;
            $scope.DUProGuideLineDetail.UnitPrice=oDetail.UnitPrice;
            $scope.DUProGuideLineDetail.DUProGuideLineDetailID_Out=oDetail.DUPGLDetailID;
        }

        $scope.AdjustLot = function()
        {
            debugger;
            if($scope.DUProGuideLineDetail.DUProGuideLineDetailID_Out <= 0 || $scope.DUProGuideLineDetail.DUProGuideLineDetailID_Out==undefined)
            {
                alert("Please Select a Lot!");return;
            }
            if($scope.DUProGuideLineDetail.Qty < 0)
            {
                alert("Lot Quantity is not sufficient!");return;
            } 
            var oDUProGuideLineDetail= $scope.DUProGuideLineDetail;
            $scope.Save_AdjustLot();
        }

        $scope.GetLot_Others= function ()
        {
            if($scope.DUProGuideLineDetail.LotProductID <= 0)
            {
                alert("Please Pick a Product And Try Again"); return;
            }

            var oDyeingPorduct= 
            {
                ContractorID:$scope.DUProGuideLineDetail.ContractorID,
                ProductID:$scope.DUProGuideLineDetail.LotProductID,
                LotID:$scope.DUProGuideLineDetail.LotID,
                DyeingOrderID:$scope.DUProGuideLineDetail.DyeingOrderID,
                //LotNo:($scope.txtLotNo == undefined ? "" : $scope.txtLotNo),
                WorkingUnitID:$scope.DUProGuideLineDetail.WorkingUnitID
            };
            $scope.txtLotNo ="";
            debugger;
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/GetsLot_Others',$.param(oDyeingPorduct), config).then(
                        function (response)
                        {
                            var results=jQuery.parseJSON(response.data);
                            //if(results.length<=0)
                            //{
                            //    alert("No Data Found!!"); return;
                            //}
                            $scope.DUProGuideLineDetail.LotParent_Others=results;
                            $scope.gridOptions_LotOthers.data=results;
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };
        $scope.GetLot_Others();

        //=========== FOR IN OUT SIDE =================
        $scope.SearchKeyDownOrder = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var sOrderRefNo=$scope.DUProGuideLineDetail.txtOrderNo;
                var txtOrder = $.trim(sOrderRefNo);
                if(txtOrder=="" || txtOrder==null)
                {
                    alert("Type Order No and Press Enter");
                    return;
                }
                $scope.PickOrderDetails(txtOrder);
            }
        };
        $scope.PickOrderDetails= function (txtOrder)
        {
            debugger;
            txtOrder= (txtOrder==undefined? "" : txtOrder);
            var oLotParent= {
                LotID:$scope.DUProGuideLineDetail.LotID,
                ContractorID:$scope.DUProGuideLineDetail.ContractorID,
                DyeingOrderID:$scope.DUProGuideLineDetail.DyeingOrderID,
                ProductID:$scope.DUProGuideLineDetail.ProductID,
                IsInHouse:false,
                BUID:sessionStorage.getItem('BUID'),
                OrderNo: txtOrder,
            };
            debugger;
          
            $http.post(_sBaseAddress + '/DUProGuideLine/Gets_DUDetailProducts',JSON.stringify(oLotParent)).then(
                        function (response)
                        {
                            debugger;
                            var results=(response.data);
                            debugger;
                            if(results.length>0 && results[0].ErrorMessage=="")
                            {
                                var oDetailColumns = [];
                                var oColumn = { name: '#', width:'3%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false,pinnedLeft:true};oDetailColumns.push(oColumn);
                                oColumn=  { field:'OrderNo', name: 'OrderNo', width:'10%',  cellClass: 'text-left',pinnedLeft:true };oDetailColumns.push(oColumn);
                                oColumn = { field: 'BuyerName', name: 'BuyerName', width: '30%' ,  cellClass: 'text-left',pinnedLeft:true };oDetailColumns.push(oColumn);
                                oColumn = { field: 'ProductName', name: 'Count', width: '25%' ,  cellClass: 'text-left',pinnedLeft:true };oDetailColumns.push(oColumn);
                                oColumn = { field: 'Qty', name: 'Total Qty', width: '10%' ,  cellClass: 'text-right', cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right'  };oDetailColumns.push(oColumn);
        
                                var modalObj={
                                    size:'lg',
                                    modalcontroller:'',
                                    url:_sBaseAddress+'/Home/Modal',
                                    appcontroller:'DUProGuideLineCtrl',
                                    objs:results,
                                    multiSelect:false,
                                    pickertitle:'Order List',
                                    searchingbyfieldName:'OrderNo',
                                    columns:oDetailColumns
                                }
                                var modalInstance=msModal.Instance(modalObj);
                                   
                                modalInstance.result.then(function (result)
                                {
                                    debugger;
                                    var oLotParents =  $scope.gridOptions_LotOthers.data;

                                    //for(var i=0; i<oLotParents.length; i++)
                                    //{
                                    //    if(oLotParents[i].DyeingOrderID==result.DyeingOrderID)
                                    //    {
                                    //        alert("Duplicate Entry Not Possible!"); return;
                                    //    }
                                    //}
                                    //SAVE LOT PARENT
                                    $scope.DUProGuideLineDetail.txtOrderNo= result.OrderNo;
                                    $scope.DUProGuideLineDetail.txtLotQty_Out= result.Qty;
                                    $scope.DUProGuideLineDetail.SelectedOrder= result;

                                }, function () {
                                    $log.info('Modal dismissed at: ' + new Date());
                                });

                            }else {alert("No Data Found!!");}
                        },
                            function (response) { alert(response.statusText);}
                    );
        };
        
        $scope.SearchKeyDownLotQty_Out = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                $scope.AddLot_Out();
            }
        };
        $scope.AddLot_Out = function ()
        {
            if(!parseFloat($scope.DUProGuideLineDetail.SelectedOrder.DyeingOrderID)>0)
            {
                alert("Please pick a order and try again!!"); return;
            }
            if(!parseFloat($scope.DUProGuideLineDetail.txtLotQty_Out)>0)
            {
                alert("Lot Qty Should be greater than zero!!"); return;
            }
            if($scope.DUProGuideLineDetail.LotParentID <= 0)
            {
                alert("Your selected lot parent is invalid!!"); return;
            }
            //if(parseFloat($scope.DUProGuideLineDetail.txtLotQty_Out) > $scope.DUProGuideLineDetail.SelectedOrder.Qty)
            //{
            //    alert("Order Qty Is Greater Than Order Qty!!"); return;
            //}
            //if(parseFloat($scope.DUProGuideLineDetail.txtLotQty_Out) > $scope.DUProGuideLineDetail.Qty_LotParent)
            //{
            //    alert("Order Qty Is Greater Than Balance!"); return;
            //}
            $scope.DUProGuideLineDetail.SelectedOrder.Qty=parseFloat($scope.DUProGuideLineDetail.txtLotQty_Out);

            $scope.Transfer_Lot($scope.DUProGuideLineDetail.SelectedOrder);
        }
        $scope.Transfer_Lot = function (result) 
        {
            var oLotParent= 
                {
                    LotID: $scope.DUProGuideLineDetail.LotID,
                    ContractorID: $scope.DUProGuideLineDetail.ContractorID,
                    DyeingOrderID:  result.DyeingOrderID,
                    DyeingOrderID_Out:  $scope.DUProGuideLineDetail.DyeingOrderID,
                    ParentType: result.ParentType,
                    ParentID: result.ParentID,
                    LotParentID: $scope.DUProGuideLineDetail.LotParentID,
                    ProductID: $scope.DUProGuideLineDetail.ProductID,
                    UnitPrice: result.UnitPrice,
                    CurrencyID: result.CurrencyID,
                    Note: "Assigned Dyeing Lot (outside)",
                    Qty: result.Qty,
                    Balance: result.Qty
                };
            console.log(result);
            $http.post(_sBaseAddress+'/DyeingOrder/Transfer_Lot',JSON.stringify(oLotParent)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    console.log(result);
                    if(result.LotParentID>0 && result.ErrorMessage=="")
                    {
                        debugger;
                        alert("Lot Transfered Successfully!!");
                            
                        var isExist=false;

                        for(var i=0; i<$scope.gridOptions_LotOthers.data.length; i++)
                        {
                            if($scope.gridOptions_LotOthers.data[i].LotParentID==result.LotParentID)
                            {
                                isExist=true;  $scope.gridOptions_LotOthers.data[i]=result;
                            }
                        }

                        if(!isExist)
                            $scope.gridOptions_LotOthers.data.push(result);

                        $scope.DUProGuideLineDetail.txtOrderNo= "";
                        $scope.DUProGuideLineDetail.txtLotQty_Out= "";
                        $scope.DUProGuideLineDetail.Qty_LotParent= $scope.DUProGuideLineDetail.Qty_LotParent - result.Qty;
                        $scope.DUProGuideLineDetail.SelectedOrder= {};
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        //================== OUT END ==================

        //======== RETURN LOT TO PREVIOUS ORDER ======//
        $scope.Return_Lot = function (result) 
        {
            debugger;
            var oLotParent = $scope.gridApi_Others.selection.getSelectedRows()[0];
            if(oLotParent==undefined)
            {
                return;
            }

            if(oLotParent.LotParentID<=0)
            {
                alert("Select a lot to return!!");
                return;
            }
            if(oLotParent.DyeingOrderID<=0)
            {
                alert("Dyeing Order Not Found!!");
                return;
            }
            if(oLotParent.DyeingOrderID_Out<=0)
            {
                alert("Destination Order Not Found!!");
                return;
            }

            if (!confirm("Your selected item will be removed. Confirm to Return?")) return ;
            $http.post(_sBaseAddress+'/DyeingOrder/Return_Lot',JSON.stringify(oLotParent)).then(
                function (response) {
                    var result=jQuery.parseJSON(response.data);
                    console.log(result);
                    if(result.ErrorMessage == null || result.ErrorMessage=="")
                    {
                        debugger;
                        alert("Lot Returned Successfully!!");
                            
                        var SelectedRowIndex=$scope.gridOptions_LotOthers.data.indexOf(oLotParent);
                        $scope.gridOptions_LotOthers.data.splice(SelectedRowIndex,1);
                    }
                    else
                    {
                        alert(result.ErrorMessage);
                    }
                },
                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
        );
        };
        
        //======== ENDS :: RETURN LOT TO PREVIOUS ORDER ======//

        $scope.SearchKeyDownLot = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtLotNo = $.trim($scope.txtLotNo);
                if(txtLotNo=="" || txtLotNo==null)
                {
                    alert("Type Lot No and Press Enter");
                    return;
                }
                $scope.PickLot();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };

        $scope.Save_AdjustLot= function ()
        {
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DUProGuideLine/Lot_Adjustment',$.param($scope.DUProGuideLineDetail), config).then(
                        function (response)
                        {
                            result=JSON.parse(response.data); debugger;
                            if(result.LotParentID>0)
                            {
                                alert("Adjustment is successfull.");
                                $uibModalInstance.close(result);
                            }else
                            {
                                alert(result.ErrorMessage);
                            }
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );
        };

        $scope.SearchKeyDownProduct = function (e){
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var txtPorduct = $.trim($scope.txtProductName);
                if(txtPorduct=="" || txtPorduct==null)
                {
                    alert("Type Product Name and Press Enter");
                    return;
                }

                $scope.PickProduct();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.txtPorductNo='';
            }
        };

        $scope.Validation=function()
        {
            if($scope.DUProGuideLineDetail.Name == "" || $scope.DUProGuideLineDetail.Name == undefined){
                msModal.Message({headerTitle : '', bodyText:'Enter DyeingType Name.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }

            return  true;
        };

        $scope.cancel= function () {
            debugger;
            $uibModalInstance.close({});
        };
    });

</script>


