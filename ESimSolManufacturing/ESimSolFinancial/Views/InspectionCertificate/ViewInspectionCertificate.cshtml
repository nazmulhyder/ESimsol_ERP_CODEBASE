
@model ESimSol.BusinessObjects.InspectionCertificate

<div class="menuMainCollectionTable" ng-app="InspectionCertificateApp" ng-controller="InspectionCertificateController as ICCC" id="divCI">
    <div style="font-family:Tahoma;text-align:center;height:90%;" class="regionIC">
        <fieldset>
            <legend>Inspection Certificate Info :</legend>
            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Ref. No:</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.RefNo" class="form-control" disabled />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">IC Date:</label></div>
                <div class="col-md-3 text-left">
                    <div class="input-group date date-container">
                        <input type="text" class="form-control" ng-model="InspectionCertificate.ICDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                    </div>
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Shipper:</label>
                </div>
                <div class="col-md-3 text-left">
                    <div class="input-group">
                        <input ng-model="InspectionCertificate.ShipperName" class="form-control" ng-keydown="SearchKeyDownShipper($event)" placeholder="Type Applicant & Press Enter" required />
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="FactoryPicker()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                        </span>
                    </div>
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Invoice No:</label></div>
                <div class="col-md-3 text-left">
                        <input type="text" class="form-control" ng-model="InspectionCertificate.InvoiceNo"disabled />
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Manufacturer:</label>
                </div>
                <div class="col-md-3 text-left">
                        <input ng-model="InspectionCertificate.MenufacturerName" class="form-control" disabled />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Invoice Date:</label></div>
                <div class="col-md-3 text-left">
                   <input type="text" class="form-control" ng-model="InspectionCertificate.InvoiceDateInString" disabled />
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Invoice value:</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.InvoiceValue" class="form-control" disabled />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Master LC No:</label></div>
                <div class="col-md-3 text-left">               
                       <input type="text" class="form-control" ng-model="InspectionCertificate.MasterLCNo" disabled />
                  </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">LC Date :</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.MasterLCDateInString" class="form-control" disabled />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Bill Of Lading No:</label></div>
                <div class="col-md-3 text-left">
                 <input type="text" class="form-control" ng-model="InspectionCertificate.BillOfLadingNo" />
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Vessel :</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.Vessel" class="form-control" />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Lading Date:</label></div>
                <div class="col-md-3 text-left">
                    <div class="input-group date date-container">
                        <input type="text" class="form-control" ng-model="InspectionCertificate.BillOfLadingDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                    </div>
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Port Of Loading :</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.PortOfLoading" class="form-control" />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Final Destination:</label></div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.FinalDestination" class="form-control" />
                </div>
            </div>

            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Shipment Mode :</label>
                </div>
                <div class="col-md-3 text-left">
                    <input ng-model="InspectionCertificate.ShipmentModeInString" class="form-control" />
                </div>
                <div class="col-md-3 text-right"><label class="control-label">Authorize Company:</label></div>
                <div class="col-md-3 text-left">
                    <select class="form-control" ng-model="InspectionCertificate.AuthorizeCompany" ng-options="item.CompanyID as item.Name for item in Companies"></select>
                </div>
            </div>
            <div class="row col-md-12">
                <div class="col-md-3 text-right">
                    <label class="control-label">Remark :</label>
                </div>
                <div class="col-md-9 text-left">
                    <input ng-model="InspectionCertificate.Remarks" class="form-control" />
                </div>
            </div>
        </fieldset>

        <div style="width: 100%; height:200px;" ui-grid="gridOptionsCIDetail" ui-grid-selection ui-grid-cellnav ui-grid-edit></div>
    </div>
    <fieldset>
        <legend>Action</legend>
        <div class="row col-md-12 text-right">
            <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save()" ng-show="commit"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Commit</span> </button>
            <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="printpreview()" ng-show="print"><span class="glyphicon glyphicon-print" aria-hidden="true"> Print</span> </button>
            <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="close()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
        </div>
    </fieldset>
</div>


<style type="text/css">
    .regionIC .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionIC .form-control {
        height: 26px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionIC .form-controlsm {
        height: 20px;
        padding: 0px 2px;
        text-align: right;
        width: 100%;
        font-size: 12px;
    }

    .regionIC .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 5px;
    }

    .regionIC .col-md-3 {
        width: 25%;
        padding-right: 5px;
        padding-left: 5px;
    }

  
    .regionIC .col-md-9 {
        width:75%;
        padding-right: 5px;
        padding-left: 0px;
    }

    .regionIC .btn-sm {
        padding: 3px 10px;
    }

    .regionIC .input-group-addon {
        padding: 4px 8px;
    }
</style>

<script type="text/javascript"> 

     var oInspectionCertificate =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model)); 
     var oCompanies = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.Companies)); 

    var InspectionCertificateApp = angular.module('InspectionCertificateApp', ['ngAnimate', 'ui.bootstrap','ui.grid', 'ui.grid.selection','ui.grid.edit', 'ms.service']);
    InspectionCertificateApp.controller('InspectionCertificateController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod,msGridControl) {
        debugger;
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });

        if(sessionStorage.getItem("IsForPrint")==true)
        {
            debugger;
            $scope.commit =false;
            $scope.print = true;
        
        }else{   
            $scope.print = false;
            $scope.commit =true;
        }

        $scope.InspectionCertificate = oInspectionCertificate;
        $scope.Companies = oCompanies;
        var oDetailColumns = [];
        var oColumn = { field: 'StyleNoOrderNo', name:'StyleNo. /OrderNo.', width:'35%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'OrderQty', name:'Order Quantity(Pcs)', width:'20%',enableCellEdit:false,aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true,footerCellClass: 'text-right',footerCellFilter: 'number:0' };oDetailColumns.push(oColumn);
        oColumn ={ field: 'ShipedQty', name: 'Shipped Quantity(Pcs)',cellClass: 'text-right',enableCellEdit:true, width: '20%',align:'left',cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true,footerCellClass: 'text-right',footerCellFilter: 'number:0' };oDetailColumns.push(oColumn);
        oColumn ={ field: 'CartonQty', name: 'Carton Quantity', cellClass: 'text-right',width: '20%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        $scope.gridOptionsCIDetail = {
            showColumnFooter: true,
            multiSelect: false,
            enableRowSelection: true,  
            enableSelectAll: false,
            columnDefs:oDetailColumns,
            data:oInspectionCertificate.InspectionCertificateDetails,
            onRegisterApi: function (gridApi) {
                $scope.gridDetailApi = gridApi;
            }
        };

        
        $scope.SearchKeyDownShippper=function (e)
        {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var FactoryName = $.trim($scope.InspectionCertificate.Shippper);
                if(FactoryName==""||FactoryName==null)
                {
                    alert("Type Factory Name and Press Enter");
                    return;
                }
                $scope.FactoryPicker();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.InspectionCertificate.ShipperName='';
                $scope.InspectionCertificate.ShipperID=0;
            }
        };
        $scope.FactoryPicker= function () {
            // debugger;
            var oContractor = {
                Params: '3' + '~' + $.trim($scope.InspectionCertificate.Shipper)+'~'+sessionStorage.getItem('BUID')
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/Contractor/ContractorSearchByNameType',$.param(oContractor), config).then(
                                function (response)
                                {
                                    var oColumns = [];
                                    var oColumn = { field: 'ContractorID', name: 'Code',width: '20%'  };oColumns.push(oColumn);
                                    oColumn = { field: 'Name', name: 'Factory Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                                    oColumn = { field: 'Address', name: 'Address',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                                    var results=response.data;
                                    var modalObj={
                                        size:'md',
                                        modalcontroller:'ModalCommonListCtrl',
                                        appcontroller:'InspectionCertificateController',
                                        objs:results,
                                        multiSelect:false,
                                        pickertitle:'Shippper List',
                                        searchingbyfieldName:'Name',
                                        columns:oColumns
                                    }
                                    var modalInstance=msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result)
                                    {
                                        debugger;
                                        $scope.InspectionCertificate.ShipperName=result.Name;
                                        $scope.InspectionCertificate.ShipperID=result.ContractorID;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message);}
                            );
        };
      
        $scope.save= function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oInspectionCertificate= $scope.InspectionCertificate;
            oInspectionCertificate.ICDate = $scope.InspectionCertificate.ICDateInString,
            oInspectionCertificate.BillOfLadingDate = $scope.InspectionCertificate.BillOfLadingDateInString,
            oInspectionCertificate.InspectionCertificateDetails= $scope.gridOptionsCIDetail.data;

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/InspectionCertificate/Save',$.param(oInspectionCertificate), config).then(
            function (response)
            {
                debugger;
                var oInspectionCertificate = jQuery.parseJSON(response.data);
                alert("Data Save Succefully");  
                if(oInspectionCertificate.CommercialInvoice!=null)
                {
                    debugger;
                    var oInvoices = jQuery.parseJSON(sessionStorage.getItem("CommercialInvoices"))
                    var nSelectedRowIndex = sessionStorage.getItem("SelectedRowIndex");
                    oInvoices[nSelectedRowIndex] = oInspectionCertificate.CommercialInvoice;
                    sessionStorage.setItem("CommercialInvoices",JSON.stringify(oInvoices));
                }
                window.location.href = sessionStorage.getItem("BackLink");
            },
                    function (response) { alert(jQuery.parseJSON(response.data).Message);}
            );       
        }

        $scope.ValidateInput = function ()
        {
            debugger;
            if($scope.InspectionCertificate.BillOfLadingNo ==null || $scope.InspectionCertificate.BillOfLadingNo =="" ) { alert("Please write Bill Of Lading No!"); return false; }
            if($scope.InspectionCertificate.Vessel==null || $scope.InspectionCertificate.Vessel=="" ) { alert("Please write Vessel "); return false; }
            if($scope.InspectionCertificate.PortOfLoading==null || $scope.InspectionCertificate.PortOfLoading=="" ) { alert("Please write Port Of Loading!");  return false; }
            if($scope.InspectionCertificate.FinalDestination==null || $scope.InspectionCertificate.FinalDestination=="" ) { alert("Please write Final Destination!"); return false; }
            if($("#cboAuthorizeCompany").val()==0) { alert("Please select Company");  return false; }

            if($scope.InspectionCertificate.InvoiceDate > new Date($scope.InspectionCertificate.ICDate))
            {
                alert("Invoice Date should be less than Inspection Certificate Date");
                return false;
            }

            var oICDetails =  $scope.gridOptionsCIDetail.data;
            if(oICDetails.length <=0){alert("Please Add  Inspection Certificate Details");  return false;}
            for(var i = 0;i<oICDetails.length;i++)
            {
                if(Math.round(parseFloat(oICDetails[i].CartonQty))> Math.round(parseFloat(oICDetails[i].ShipedQty)))
                {
                    alert(" Carton Quantity Should be Less than  or equal Shipped Qty for '"+oICDetails[i].StyleNoOrderNo+"'");
                    return false;
                }
            }


            return true;
        }
        
        $('#btnClose').click(function (e) {
            window.location.href = sessionStorage.getItem("BackLink");
        });

        $scope.printpreview= function ()
        {
    
            if($scope.InspectionCertificate==null || parseInt($scope.InspectionCertificate.InspectionCertificateID)<=0)
            {
                alert("Without Inspection Certificate Can't Print !");
                return;
            }
            window.open(sessionStorage.getItem('BaseAddress')+ '/InspectionCertificate/ICPreview?id='+ parseInt($scope.InspectionCertificate.InspectionCertificateID)); 
            window.location.href = sessionStorage.getItem("BackLink");
        }
    });


 //function FactoryPicker()
 //{
   
 //   var oParameter = new Object();        
 //   oParameter.Name = "Factory list";
 //   oParameter.MultipleItemReturn =false;
 //   oParameter.ContractorType ="3";
 //   var url =_sBaseAddress+  "/Contractor/ContractorSearch";
 //   var oReturnObj = window.showModalDialog(url, oParameter, 'dialogHeight:430px;dialogWidth:450px;dialogLeft:350;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');

 //   document.getElementById("txtShipperName").value = oReturnObj.Name;
 //   _oInspectionCertificate.ShipperID = oReturnObj.ContractorID;

 //}




//function ICRefreshObject()
//{  
//      //debugger;
//     var cboAuthorizeCompany = document.getElementById("cboAuthorizeCompany");
//     var oInspectionCertificate= {   
//            InspectionCertificateID :_oInspectionCertificate.InspectionCertificateID,
//            RefNo :_oInspectionCertificate.RefNo,
//            ICDate :$('#txtICDate').datebox('getValue'),
//            CommercialInvoiceID:_oInspectionCertificate.CommercialInvoiceID,
//            ShipperID :_oInspectionCertificate.ShipperID,
//            ManufacturerID :_oInspectionCertificate.ManufacturerID,
//            InvoiceNo  :_oInspectionCertificate.InvoiceNo,
//            InvoiceDate :_oInspectionCertificate.InvoiceDate,
//            InvoiceValue :_oInspectionCertificate.InvoiceValue,
//            MasterLCNo  :_oInspectionCertificate.MasterLCNo,
//            MasterLCDate :_oInspectionCertificate.MasterLCDate,
//            BillOfLadingNo  :document.getElementById("txtBillOfLadingNo").value,
//            BillOfLadingDate :$('#txtLadingDate').datebox('getValue'),
//            Vessel  :document.getElementById("txtVessel").value,
//            PortOfLoading  :document.getElementById("txtPortOfLoading").value,
//            FinalDestination  :document.getElementById("txtFinalDestination").value,
//            Remarks  :document.getElementById("txtRemarks").value,
//            AuthorizeCompany :parseInt(cboAuthorizeCompany.options[cboAuthorizeCompany.selectedIndex].value),
//            InspectionCertificateDetails: $('#tblInspectionCertificateDetail').datagrid('getRows')
//           };
//   return oInspectionCertificate;
//} 


    

</script>