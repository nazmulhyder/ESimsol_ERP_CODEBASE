@{
    ViewBag.Title = "Order Summary List";
}
@model IEnumerable<ESimSol.BusinessObjects.DyeingOrderReport>
<head>
    
</head>
<body>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div style="height:85%;width:100%;overflow:hidden;">
            <table style="width:100%;height:100%;" id="tblPTUs" title="Order info " class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarPTU">
                <thead>
                    <tr>
                        <th field="OrderNoFull" width="10%">Order No</th>
                        <th field="ContractorName" width="15%">Party</th>
                        <th field="ProductName" width="10%">Product Name</th>
                        <th field="ColorName" width="15%">Color</th>
                        <th field="Qty" formatter="formatPrice" width="8%" align="right">Order Qty</th>
                        <th field="Qty_DO" formatter="formatPrice" width="8%" align="right">DO Qty</th>
                        <th field="Qty_DC" formatter="formatPrice" width="8%" align="right">Delivery Qty</th>
                        <th field="ShadeSt" width="6%">Shade</th>
                        <th field="ColorNo" width="15%">Color No</th>
                        <th field="StateSt" width="12%">Status</th>
                        <th field="BuyerName" width="15%">Buying </th>
                        <th field="PINo" width="15%">P/I No </th>

                    </tr>
                </thead>
            </table>
            <div id="toolbarPTU">
                <table>
                    <tr>
                        <td>
                            
                            <input type="text" id="txtSearchByOrderNo" placeholder="Search by order No" style="width:150px" />
                         
                        </td>
                        <td>
                            <a id="btnViewStock" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">Lot Transfer</a>
                        </td>

                    </tr>
                </table>
            </div>
        </div>
        <div style="height:10%;width:100%;overflow:hidden;">
            <fieldset>
                <legend>Action</legend>
                <div class="align-right">
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </div>
            </fieldset>
        </div>

    </div>
    <div id="winDULotDistribution" class="easyui-window winClass" style="width:900px;height:500px; " title="Lot Transfer" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="float: left;align-content:center;">
            <div>
                <table style="width:100% ;">
                    <tr>
                        <td style="width:62% ;">
                            <fieldset>
                                <legend style="text-align:left; font-weight:bold;"> Gets Source Order : </legend>
                                <table style="width:100%;height:250px" id="tblPTUDistribution_Source" class="easyui-datagrid" singleselect="true" autorowheight="false" toolbar="#toolbarPTU_Sourch">
                                    <thead>
                                        <tr>

                                            <th field="LotNo" width="20%" align="left">Lot No</th>
                                            <th field="OrderNo" width="20%" align="left">OrderNo</th>
                                            <th field="ProductName" width="20%" align="left">Yarn Type</th>
                                            <th field="ColorName" width="15%" align="left">ColorName</th>
                                            <th field="Qty" width="15%" align="right" formatter="formatPrice">Qty</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarPTU_Sourch">
                                    <table>
                                        <tr>
                                            <td style="text-align:left;"><input id="chkIsRawYes" type="checkbox" disabled="disabled" onclick="if(this.checked){IsRawYes()}else{IsRawNo()}" /> Is Raw?</td>
                                            <td>
                                                <select id="cboOrderType" style="width:112px;"></select>
                                                <input type="text" id="txtOrderNo" placeholder="Type Order No and Press enter" style="width:180px;" /><a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                                                <input type="text" id="txtProduct" placeholder="Type Product Name and Press enter" style="width:180px;" /><a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                                                <select id="cboWorkingUnits" style="width:112px;"></select>
                                                <input type="text" id="txtLotNo_PTUD" placeholder="Type Lot No and Press enter" style="width:180px;" /><a id="btnPickLot_PTUD" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <table border="0" cellpadding="01" cellspacing="1" style="width:100%;">
                                    <tr>
                                        <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                        <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblTotalQty_Source">0</label><span class="lblMUnit"></span> </td>

                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                        <td style="width:35% ;">
                            <fieldset>
                                <legend style="text-align:left; font-weight:bold;"> Current  Stock In Hand : </legend>
                                <table style="width:100%;height:250px" id="tblPTUDistribution" class="easyui-datagrid" singleselect="true" autorowheight="false" toolbar="#toolbarLot">
                                    <thead>
                                        <tr>
                                            <th field="LotNo" width="40%" align="left">Lot/Batch No</th>
                                            <th field="Qty" width="25%" align="right" formatter="formatPrice">Qty</th>
                                            <th field="OperationUnitName" width="30%" align="left">Store</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarLot">
                                    <table>
                                        <tr>
                                            <td></td>

                                        </tr>
                                    </table>
                                </div>
                                <table border="0" cellpadding="1" cellspacing="1" style="width:100%;">
                                    <tr>
                                        <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                        <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label><span class="lblMUnit"></span> </td>

                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:62%; text-align:left">
                            <label id="lbTransfer">
                                Transfer Qty
                            </label>
                            <input type="text" id="txtTransferQty" style="width:10%;" />
                            <a id="btncommit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Commit</a>
                        </td>
                        <td style="width:35%; text-align:left">
                            <label id="lbTransfer">
                                Reduce  Qty
                            </label>
                            <input type="text" id="txtQtyReduce" style="width:10%;" />
                            <a id="btncommitReduce" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Commit</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div style="height:10%;width:100%;overflow:hidden;">
                <fieldset>
                    <legend>Action</legend>
                    <div class="align-right">
                        <a id="btnCloseLOTDist" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>
            </div>
        </div>

    </div>
</body>

<script type="text/javascript">
    var _oDULotDistribution = null;
    var _oDULotDistributions = [];
    var _sBaseAddress = "";
    var _oAuthorizationRolesMapping = [];
    var _oDyeingOrderReports=[];
    var _sMenuID=0;
    var _sProductIDs="";
    var _nBUID=0;
    var _oWorkingUnits=[];
    var _oDyeingOrderDetail=null;
    var _nProductID=0;
    $(document).ready(function() {
        debugger;

        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _sMenuID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _oDyeingOrderReports = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        var oDUOrderSetups = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DUOrderSetups));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oWorkingUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        _nID =parseInt(sessionStorage.getItem("SelectedRowIndex"));
        var oDyeingOrderReport =sessionStorage.getItem("PTUs");

        if(oDyeingOrderReport!=null)
        {
            oDyeingOrderReport = jQuery.parseJSON(oDyeingOrderReport);
        }
        else
        {
            oDyeingOrderReport=_oDyeingOrderReports;
        }

        DynamicRefreshList(oDyeingOrderReport, 'tblPTUs');
        if(_nID!=-1)
        {
            $('#tblPTUs').datagrid('selectRow', _nID);
        }

        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $(".lblLoadingMessage").hide();
      //  $("#cboOrderType").icsLoadCombo({List: oDUOrderSetups,OptionValue: "OrderType",DisplayText: "ShortName"});

    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }





    $(document).keydown(function (e) {
        //debugger;
        if (e.which == 27)//escape=27
        {
            //debugger;
            $("#winPRAdvanceSearch").icsWindow('close');
        }
    });



    //Search By No


    $("#txtSearchByOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){

            var sPINo = "";
            var sOrderNo =  $.trim($("#txtSearchByOrderNo").val());
            var sSampleOrderNo = "";

            var oDyeingOrder= {
                OrderNo :sOrderNo,
                ExportPINo:'',
                ExportLCNo:'',
                DyeingOrderType: parseInt($("#cboOrderType").val())
            };
            GetsOrders(oDyeingOrder);
        }
        else if(nkeyCode==8){
            $("#txtSearchByOrderNo").val("");

        }
    });

  

    function GetsOrders(oDyeingOrder)
    {
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.ajax
          ({
              type: "POST",
              dataType: "json",
              url : _sBaseAddress+"/DULotDistribution/GetbyNo",
              data:  JSON.stringify(oDyeingOrder),
              contentType: "application/json; charset=utf-8",
              success: function (data) {
                  //debugger;
                  var oDyeingOrderReports = jQuery.parseJSON(data);
                  if (oDyeingOrderReports.length>0)
                  {
                      DynamicRefreshList(oDyeingOrderReports, 'tblPTUs');
                  }
                  else
                  {
                      alert("Data Not found");
                      DynamicRefreshList([], 'tblPTUs');
                  }
                  clearInterval(intervalID);
                  $("#progressbarParent").hide();
              },
              error: function (xhr, status, error)
              {
                  alert(error);
              }
          });
    }
    /// end Search By No
    $("#btnWaitingForDO").click(function() {
        window.location.href = _sBaseAddress+ '/PTU/ViewPTUs?'+"&menuid="+_sMenuID; ;
    });
    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnViewStock").click(function () {
        debugger;
        $('#chkIsRawYes').prop('checked', true);
        IsRawYes();
        $("#winDULotDistribution input").val("");

        var oDOD= $('#tblPTUs').datagrid('getSelected');
        if(oDOD==null || oDOD.DyeingOrderDetailID<=0)
        {
            alert("Please select a item from list!");
            return false;
        }
        _oDyeingOrderDetail=oDOD;
        var SelectedRowIndex=$('#tblPTUs').datagrid('getRowIndex',oDOD);
        var oDULotDistribution= {BUID:_nBUID,DODID: oDOD.DyeingOrderDetailID}
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDULotDistribution,
            ControllerName: "DULotDistribution",
            ActionName: "GetsDUDULotDistribution",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0)
            {
                _oDULotDistributions=response.objs;
                DynamicRefreshList(_oDULotDistributions, 'tblPTUDistribution');
            }
        });

        RefreshControl(oDOD);

        $("#winDULotDistribution").icsWindow("open","Edit");
    });

    function RefreshControl(oDOD)
    {
        $("#cboWorkingUnits").icsLoadCombo({
            List: _oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName"
        });

        debugger;
        $(".lblMUnit").html("("+oDOD.MUName+")");
       
        $('#txtProductName').val(oDOD.ProductName);
        $('#txtColor').val(oDOD.ColorName+""+oDOD.ShadeSt);
        $('#txtColorNo').val(oDOD.ColorNo);
        $('#txtLabDipNo').val(oDOD.LabdipNo);

        //$('#txtProductionPipeLineQty').val(formatPrice(_oPTU.ProductionPipeLineQty,null));
        //$('#txtActualDeliveryQty').val(formatPrice(_oPTU.ActualDeliveryQty,null));
      //  RefreshOrderQty();
        RefreshSummary();
    }

    function RefreshSummary()
    {
        debugger;
        var oPTUDistributions = $('#tblPTUDistribution').datagrid('getRows');
        var nTotalQty = 0;
        for(var i = 0; i<oPTUDistributions.length;i++)
        {
            nTotalQty+=parseFloat(oPTUDistributions[i].Qty);
        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0);

        nTotalQty = 0;
        var oPTUDistributions_Source = $('#tblPTUDistribution_Source').datagrid('getRows');
        for(var i = 0; i<oPTUDistributions_Source.length;i++)
        {
            nTotalQty+=parseFloat(oPTUDistributions_Source[i].Qty);
            $(".lblMUnit").html("("+oPTUDistributions_Source[i].MUName+")");
        }
        document.getElementById('lblTotalQty_Source').innerHTML = formatPrice(nTotalQty,0);
       
    }


    $("#btnUpdateEPIDetail").click(function () {
        debugger;
        var oExportPIDetail = $('#tblExportPIDetail').datagrid('getSelected');
        if (oExportPIDetail ==null ) { alert("Please select an item from list."); return ; }
        var nSelectedRowIndex=$('#tblExportPIDetail').datagrid('getRowIndex',oExportPIDetail);
        oExportPIDetail.ExportQualityID=$("#cboEQuality").val();

        var ncboQty = document.getElementById("cboEQuality");
        var selectedText = ncboQty.options[ncboQty.selectedIndex].text;
        oExportPIDetail.ExportQualityID=$("#cboEQuality").val();
        oExportPIDetail.ExportQuality=selectedText;
        oExportPIDetail.ProductID=_oProduct.ProductID;
        oExportPIDetail.ProductName=$.trim($('#txtProduct_Edit').val());
        oExportPIDetail.ProductCode=_oProduct.ProductCode;
        oExportPIDetail.Qty=parseFloat($('#txtQtyInOne').val()).toFixed(4);
        oExportPIDetail.UnitPrice=parseFloat($('#txtUnitPriceInOne').val()).toFixed(4);

        oExportPIDetail.AdjQty=parseFloat($('#txtAdjQty').val()).toFixed(4);
        oExportPIDetail.AdjRate=parseFloat($('#txtAdjRate').val()).toFixed(4);
        oExportPIDetail.DocCharge=parseFloat($('#txtDocCharge').val()).toFixed(4);
        oExportPIDetail.CRate=parseFloat($('#txtCRate').val()).toFixed(4);

        oExportPIDetail.BuyerReference=$.trim($('#txtBuyerReference').val());
        oExportPIDetail.StyleNo=$.trim($('#txtStyleNo').val());
        oExportPIDetail.ColorInfo=$.trim($('#txtColorEdit').val());
        oExportPIDetail.DyeingType=$("#cboDyeingType").val();
        oExportPIDetail.ShadeType=$("#cboShadeType").val();

        oExportPIDetail.PackingType=$("#cboPacking").val();
        oExportPIDetail.SaleType=$("#cboSaleType").val();


        //if(oExportPIDetail.ExportPIDetailID>0)
        //{
        //    var obj = {
        //        BaseAddress: _sBaseAddress,
        //        Object: oExportPIDetail,
        //        ObjectId: oExportPIDetail.ExportPIDetailID,
        //        ControllerName: "ExportDocSetup",
        //        ActionName: "UpdateQuality",
        //        TableId: "tblExportPIDetail",
        //        IsWinClose: false
        //    };
        //    $.icsSave(obj);
        //}
        $('#tblExportPIDetail').datagrid('updateRow', { index: nSelectedRowIndex, row: oExportPIDetail });
        endEditing();
        $("#winExportPIDetailEdit").icsWindow("close");
        editIndex = undefined;
    });
    $("#btnCloseLOTDist").click(function () {
        debugger;
        $("#winDULotDistribution").icsWindow("close");

    });

    $('#tblPTUDistribution_Source').datagrid({ onSelect: function (rowIndex, rowData) { PTUDistribution_SourceSelection(rowIndex, rowData); } });

    function PTUDistribution_SourceSelection(rowIndex, rowData){
        debugger;
        $('#txtTransferQty').val("");
        _oDULotDistribution=null;
        var oDULotDistributions_Source = $('#tblPTUDistribution_Source').datagrid('getRows');
        if(rowData!=null && rowData.DULotDistributionID>0)
        {
            for(var i=0; i<oDULotDistributions_Source.length;i++){
                if(oDULotDistributions_Source[i].DULotDistributionID==rowData.DULotDistributionID){
                    document.getElementById('lbTransfer').innerHTML = "Transfer From Lot:"+oDULotDistributions_Source[i].LotNo+", Qty("+oDULotDistributions_Source[i].MUName+")";
                    $('#txtTransferQty').val(oDULotDistributions_Source[i].Qty);
                    _oDULotDistribution=oDULotDistributions_Source[i];
                    _nSelectedIndex=rowIndex;

                }
            }

        }
        else if(rowData!=null && rowData.LotID>0 && rowData.IsRaw==true)
        {

            for(var i=0; i<oDULotDistributions_Source.length;i++){
                if(oDULotDistributions_Source[i].LotID==rowData.LotID){
                    document.getElementById('lbTransfer').innerHTML = "Transfer From Lot:"+oDULotDistributions_Source[i].LotNo+", Qty("+oDULotDistributions_Source[i].MUName+")";
                    $('#txtTransferQty').val(oDULotDistributions_Source[i].Qty);
                    _oDULotDistribution=oDULotDistributions_Source[i];
                    _nSelectedIndex=rowIndex;

                }
            }

        }

    }


    $('#btncommit').click(function () {

        //if (_oDULotDistribution ==null || _oDULotDistribution.DULotDistributionID <=0 )
        //{ alert("Please select an item from list."); return ; }

        if (_oDyeingOrderDetail ==null ||_oDyeingOrderDetail.LotID <=0 )
        { alert("Please select an valid Order."); return ; }

        var nQty_PTUD_Source= _oDULotDistribution.Qty;
        if(parseFloat($("#txtTransferQty").val())<=0)
        {
            alert("Your entry Qty is in valid.");
            $("#txtTransferQty").focus();
            $('#txtTransferQty').addClass("errorFieldBorder");
            return ;
        }
        if(parseFloat($("#txtTransferQty").val())>parseFloat(nQty_PTUD_Source))
        {
            alert("You can't  exced Source lot Qty.");
            $("#txtTransferQty").focus();
            $('#txtTransferQty').addClass("errorFieldBorder");
            return ;
        }
        
        _oDULotDistribution.IsRaw=$("#chkIsRawYes").is(":checked");
        _oDULotDistribution.DODID_Dest=_oDyeingOrderDetail.DyeingOrderDetailID;
        _oDULotDistribution.Qty=$("#txtTransferQty").val();
        var conf = confirm("Are you sure you want to Transfer Lot ?");
        if(conf==false)return;

        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/DULotDistribution/Save_Transfer",
            traditional: true,
            data:  JSON.stringify(_oDULotDistribution),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDULotDistribution = jQuery.parseJSON(data);
                if ( oDULotDistribution.ErrorMessage=="" || oDULotDistribution.ErrorMessage==null )
                {
                    _oDULotDistribution.Qty= parseFloat(nQty_PTUD_Source)-parseFloat($("#txtTransferQty").val());
                    $('#tblPTUDistribution_Source').datagrid('updateRow', { index: _nSelectedIndex, row: _oDULotDistribution });
                    _oDULotDistribution=null;
                    _nSelectedIndex=-1;
                    AppendPTUD_Destanation(oDULotDistribution);
                    alert("Lot transfer done successfully");

                }
                else
                {
                    alert(oDULotDistribution.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $('#btncommitReduce').click(function () {

        debugger;
        var oDULotDistribution = $('#tblPTUDistribution').datagrid('getSelected');
        if (oDULotDistribution ==null || oDULotDistribution.DULotDistributionID <=0 ) { alert("Please select an item from list."); return ; }
        var nIndex=$('#tblPTUDistribution').datagrid('getRowIndex',oDULotDistribution);

        if(parseFloat($("#txtQtyReduce").val())<=0)
        {
            alert("Your entry Qty is in valid.");
            $("#txtQtyReduce").focus();
            $('#txtQtyReduce').addClass("errorFieldBorder");
            return ;
        }
        //if(parseFloat($("#txtQtyReduce").val())>parseFloat(oDULotDistribution.Qty))
        //{
        //    alert("You can't  exced  lot Qty.");
        //    $("#txtQtyReduce").focus();
        //    $('#txtQtyReduce').addClass("errorFieldBorder");
        //    return ;
        //}
     //   _oDULotDistribution.IsRaw=$("#chkIsRawYes").is(":checked");
        oDULotDistribution.IsRaw=true;
       
        oDULotDistribution.Qty=$("#txtQtyReduce").val();
        var conf = confirm("Are you sure you want to Change this Qty ?");
        if(conf==false)return;

        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/DULotDistribution/Save_Reduce",
            traditional: true,
            data:  JSON.stringify(oDULotDistribution),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDULotDistribution = jQuery.parseJSON(data);
                if ( oDULotDistribution.ErrorMessage=="" || oDULotDistribution.ErrorMessage==null )
                {
                  
                    $('#tblPTUDistribution').datagrid('updateRow', { index: nIndex, row: oDULotDistribution });
                    _oDULotDistribution=null;
                    index=-1;
                    alert("Qty Changed successfully");
                }
                else
                {
                    alert(oDULotDistribution.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    function AppendPTUD_Destanation(oTempDULotDistribution)
    {
        var oDULotDistributions = $("#tblPTUDistribution").datagrid("getRows");
        var nFlag = 0;
        for (var i = 0; i < oDULotDistributions.length; i++) {

            if (oDULotDistributions[i].LotID == oTempDULotDistribution.LotID) {
                $('#tblPTUDistribution').datagrid('updateRow', { index: i, row: oTempDULotDistribution });
                nFlag = 1;
                break;
            }
        }
        if (nFlag == 0) {
            var nIndex = oDULotDistributions.length;
            $("#tblPTUDistribution").datagrid("appendRow", oTempDULotDistribution);
            $("#tblPTUDistribution").datagrid("selectRow", nIndex);
        }
    }


    function IsRawYes() {
        _nDODID_Source=0;
        $("#cboWorkingUnits").val(0);
        $('#cboOrderType').val();
        $('#txtOrderNo').val("");
        $('#cboOrderType,#txtOrderNo,#btnPickOrderNo').hide();
        $('#txtProduct,#btnPickProduct').show();
    }

    function IsRawNo() {
        $("#cboWorkingUnits").val(0);
        $('#cboOrderType').val();
        $('#txtOrderNo').val("");
        $('#cboOrderType,#txtOrderNo,#btnPickOrderNo').show();
        $('#txtProduct,#btnPickProduct').hide();
    }


    $("#btnResetProduct").click(function () {

        $("#txtProduct").val("");
        _nProductID=0;
    });

    $("#btnPickProduct").click(function () {

        var sProductName=$.trim($("#txtProduct").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        GetProducts(sProductName);
    });

    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName);
        }
        else if(nkeyCode==8){
            $("#txtProduct").val("");
            _nProductID=0;
        }
    });

    function GetProducts(sProductName){
        var oProduct = { BUID:_nBUID,ProductName:sProductName};
        //var oProduct = {
        //    ProductName:sProductName,
        //    ProductCode:sProductName
        //};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 300, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 560,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                $("#progressbarParent").hide();
                alert("No product found.");
            }
        });


    }
    
    $("#btnPickLot_PTUD").click(function ()
    {
        var sLotNo=$.trim($("#txtLotNo_PTUD").val());
        //if(sLotNo=="" || sLotNo==null)
        //{
        //    alert("Please Type No or part of No");
        //    $('#txtOrderNo').focus();
        //    $('#txtOrderNo').removeClass("errorFieldBorder");
        //    return;
        //}
        if(parseInt($("#cboWorkingUnits").val())<=0)
        {
            alert("Please Select Store");
            $('#cboWorkingUnits').focus();
            $('#cboWorkingUnits').removeClass("errorFieldBorder");
            return;
        }
        var bIsRaw= $("#chkIsRawYes").is(":checked");
      
        var oDULotDistribution={WorkingUnitID: parseInt($("#cboWorkingUnits").val()), DODID_Dest:_oDyeingOrderDetail.DyeingOrderDetailID,DODID:_nDODID_Source ,LotNo:sLotNo,IsRaw:bIsRaw,ProductID:_nProductID};
        GetsPTUDIS(oDULotDistribution)
    });
    $("#txtLotNo_PTUD").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLotNo=$.trim($("#txtLotNo_PTUD").val());
            if(sLotNo=="" || sLotNo==null)
            {
                alert("Please Type No or part of No");
                $('#txtLotNo_PTUD').focus();
                $('#txtLotNo_PTUD').removeClass("errorFieldBorder");
                return;
            }
            if(parseInt($("#cboWorkingUnits").val())<=0)
            {
                alert("Please Select Store");
                $('#cboWorkingUnits').focus();
                $('#cboWorkingUnits').removeClass("errorFieldBorder");
                return;
            }
            var bIsRaw= $("#chkIsRawYes").is(":checked");
            var oDULotDistribution={WorkingUnitID: parseInt($("#cboWorkingUnits").val()), DODID_Dest:_oDyeingOrderDetail.DyeingOrderDetailID ,DODID:_nDODID_Source, LotNo:sLotNo,IsRaw:bIsRaw,ProductID:_nProductID};
            GetsPTUDIS(oDULotDistribution)
        }
        else if(nkeyCode==8){
            $("#txtLotNo_PTUD").val("");

        }
    });
 

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();


        if (oPickerobj.winid == 'winOrderPicker')
        {
            if (oreturnObj != null && oreturnObj.DyeingOrderDetailID > 0)
            {
                $('#txtOrderNo').val(oreturnObj.ProductName+","+oreturnObj.ColorNameShade);
                _nDODID_Source=oreturnObj.DyeingOrderDetailID;
                var oPTUDistribution={DODID:_nDODID_Source ,LotNo:''};
                // LoadLots(oPTUDistribution);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winDOD_Dest_Picker')
        {
            if (oreturnObj != null && oreturnObj.LotID > 0)
            {
                $('#txtLotNo_PTUD').val(oreturnObj.LotNo);
                
                LoadLots(oreturnObj);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winProductPicker') {
            if (oreturnObj != null && oreturnObj.ProductID > 0)
            {
                $('#txtProduct').val(oreturnObj.ProductName);
                _nProductID= oreturnObj.ProductID;
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }

    }


    function LoadLots(oDULotDistribution)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDULotDistribution,
            ControllerName: "DULotDistribution",
            ActionName: "GetsLot",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0)
            {
                var oPTUDistributions= response.objs;
                DynamicRefreshList(oPTUDistributions, 'tblPTUDistribution_Source');
                RefreshSummary();
            }
        });
    }

    function GetsPTUDIS(oDULotDistribution)
    {

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDULotDistribution,
            ControllerName: "DULotDistribution",
            ActionName: "GetsLot",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductName", title: "Name", width: 220, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LotNo", title: "LotNo/Batch No", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 60, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "OrderNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 150, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winDOD_Dest_Picker',
                        winclass:'clsPTUDesPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblPTUPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
</script>