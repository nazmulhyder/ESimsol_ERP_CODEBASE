@{
    ViewBag.Title = "Knit Dyeing Program";
}

@model ESimSol.BusinessObjects.KnitDyeingProgram
<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>
<div id="winKnitDyeingProgramDetail" class="easyui-window" title="Knit Dyeing Program" style="width:950px;height:590px;padding:2px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="overflow:hidden;display:block;height:88%">
        <fieldset style="height:45%">
            <legend style="font-weight: bold">Knitting Dyeing Program Info</legend>

            <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                <tr>
                    <td style="width:10%; text-align:right">JOB/PAM/PO:</td>
                    <td style="width:25%">
                        <select id="cboRecapOrPam" style="width:100%"></select>
                        <input id="txtRefProgramNo" type="text" style="width:100%" />
                    </td>
                    <td style="width: 10%; text-align: right">Color:</td>
                    <td style="width:25%">
                        @*<select id="cboColor" style="width:100%;height:22px;"></select>*@
                        <table border="0" cellpadding="0" cellspacing="0"> 
                            <tr>
                                <td style="width:90%"><input id="txtColorName" type="text" placeholder="Type Color & Press Enter" style="width:100%" /></td>
                                <td style="width:10%"><input type="button" value="P"id="btnColor" onclick="PickColor()" /> </td>
                            </tr>
                        </table>
                        
                    </td>
                    <td style="width: 10%; text-align: right">Pantone No:</td>
                    <td style="width:20%">
                        <input id="txtPantoneNo" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">Shade Recipe:</td>
                    <td style="width:25%">
                        <input id="txtShadeReceipe" type="text" style="width:100%" />
                    </td>
                    <td style="width: 10%; text-align: right">Composition :</td>
                    <td colspan="3" style="width:55%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:80%">
                                    <input type="text" id="txtComposition" style="width:100%;" placeholder="Search With Product Name" />
                                </td>
                                <td style="width:6%">
                                    <input style="width:100%;" type="button" value="P" id="btnCompositionPicker"/>
                                </td>
                                <td style="width:8%">
                                    <input style="width:100%" type="button" value="R.Y" id="btnYarnRequisitionCompositionPicker" onclick="YarnCompositionPicker()" />
                                </td>
                                <td style="width:6%">
                                    <input style="width:100%;" type="button" value="C" id="btnCompositionClear" />
                                </td>
                            </tr>
                        </table>
                    </td>                    
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">Fabric Type:</td>
                    <td style="width:25%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:78%">
                                    <input id="txtFabricType" type="text" style="float:left;width:100%" />
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="P" id="btnPickFabricType" style=" width:100%" />
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="+" style="width:100%" id="btnAddFabricType" />
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 10%; text-align: right">GSM:</td>
                    <td style="width:25%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:78%">
                                    <input id="txtGSMDetail" type="text" style="float:left;width:100%" />
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="P" id="btnPickGSMDetail" style="width:100%" />                                    
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="+" id="btnAddGSMDetail" style="width:100%" />
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 10%; text-align: right">Finish Dia:</td>
                    <td style="width:20%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:78%">
                                    <input id="txtFinishDia" type="text" style="float:left;width:100%" />
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="P" id="btnPickFinishDia" style="width:100%" />
                                </td>
                                <td style="width:10%">
                                    <input type="button" value="+" id="btnAddFinishDia" style="width:100%" />
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">Garments Qty:</td>
                    <td style="width:25%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:50%">
                                    <input type="text" style="width:100%" id="txtGarmentsQty" />
                                </td>
                                <td style="width:50%">
                                    <select id="cboGarmentsUnit" style="width:100%;height:22px;"></select>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 10%; text-align: right">Consm Qty:</td>
                    <td style="width:25%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:42%"><input type="text" style="width:100%" id="txtConsumptionQty" /></td>
                                <td style="width:30%"><select id="cboConsumptionUnit" style="width:100%;height:22px;"></select></td>
                                <td style="width:28%"><input type="button" style="width:100%;text-align:center;font-weight:bold;" value="/ DZN" /></td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 10%; text-align: right"> Req Fabric Qty:</td>
                    <td style="width:20%">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width:60%">
                                    <input type="text" style="width:100%" id="txtFabricQty" />
                                </td>
                                <td style="width:40%">
                                    <input style="width:100%;" type="button" id="btnFabricUnitName" value="KG" disabled="disabled" />
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td style="width:10%; text-align:right">Remarks:</td>
                    <td colspan="5" style="width:90%">
                        <input id="txtRemarksDetail" type="text" style="float:left;width:100%" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <table id="tblYarnConsumption" title="Yarn Consumption" class="easyui-datagrid" style="height:52%; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" showfooter="true" toolbar="#toolbarYarnConsumption" data-options="onClickRow:onClickRow">
            <thead>
                <tr>
                    <th field="YarnName" width="40%" align="left">Yarn Requisition</th>
                    <th width="10%" align="right" formatter="formatPrice" data-options="field:'UsagesParcent',editor:{type:'numberbox',options:{precision:2}}">Ratio(%)</th>
                    <th width="10%" align="right" formatter="formatPrice" data-options="field:'FinishReqQty',editor:{type:'numberbox',options:{precision:2}}">Required Qty</th>
                    <th field="MUnitSymbol" width="10%" align="left">M. Unit</th>
                    <th field="FabricTypeName" width="10%" align="left">Fabric Type</th>
                    <th field="Remarks" width="10%" align="left" editor="text">Remarks</th>
                </tr>
            </thead>
        </table>
            <div id="toolbarYarnConsumption">
                <input type="text" style="width: 220px;" id="txtRequisitionYarnName" placeholder="Press enter with Yarn Composition Name" />
                <input type="button" style="width: 30px;" id="txtRequisitionYarnClear" value="C" />
                <input type="button" style="width: 30px;" id="txtRequisitionYarnPicker" value="P" />
                Ratio:<input type="text" style="width: 100px;" id="txtRatio" />
                Req.Qty:<input type="text" style="width: 100px;" id="txtRequisitionQuantity" />
                <input type="text" style="width: 100px;" id="txtRequisitionRemarks" placeholder="Remarks" />
                <a id="btnAddYarnConsumption" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnRemoveYarnConsumption" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnRefreshYarnConsumption" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
            </div>
    </div>
    <fieldset style="width:100%; vertical-align:top;">
        <legend style="font-weight:bold"> Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; font-weight:bold;width:100%;">
            <tr>
                <td style="width:80%;text-align:right;"></td>
                 <td style="width:20%;text-align:right;">
                    <a id="btnSaveDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                    <a id="btnCloseDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>


<div class="menuMainCollectionTable">
    <div id="divKnitDyeingProgram" class="easyui-panel" title="Knit Dyeing Program" style="font-family:Tahoma;height:90%;width:100%">
        <div class="easyui-tabs" style="width:100%; " id="yarnTab">
            <div title="Program Info">
                <fieldset style="height:440px">
                    <table style="width:100%;" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="width:17%;text-align:right">Ref. No</td>
                            <td style="width:21%">
                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                                    <tr>
                                        <td style="width:30%;"><input type="text" style="width: 100%;" id="txtKnitDyeingProgramRefNo" disabled="disabled" /></td>
                                        <td style="width:20%;text-align:right;">Type</td>
                                        <td style="width:50%;"><select id="cboRefType" style="width:100%"></select></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width:10%;text-align:right">Issue Date</td>
                            <td style="width:21%">
                                <input type="text" style="width:200px;" id="txtIssueDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                            <td style="width:10%;text-align:right">Buyer Name</td>
                            <td style="width:21%">
                                <input type="text" style="width:100%;" id="txtBuyerName" disabled="disabled" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Style</td>
                            <td style="width:21%">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:80%"><input type="text" style="width:100%;" id="txtStyleNo" /></td>
                                        <td style="width:10%"><input type="button" id="btnStyleNoCancel" value="C" style="width:100%" /></td>
                                        <td style="width:10%"><input type="button" id="btnStyleNoPick" value="P" style="width:100%" /></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width:10%;text-align:right">Dyed Type</td>
                            <td style="width:21%">
                                <select id="cboDyedType" style="width:100%"></select>
                            </td>
                            <td style="width:10%;text-align:right">Order Qty</td>
                            <td style="width:21%">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:70%"><input type="text" style="width:100%;" id="txtOrderQty" /></td>
                                        <td style="width:30%"><input type="text" style="width:100%;" id="txtMunit" disabled="disabled" /></td>                                        
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Fabric Detail</td>
                            <td style="width:54%;" colspan="3">
                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                    <tr>
                                        <td style="width:90%"><input type="text" style="width:100%" id="txtFabric" placeholder="Search By Fabric Name" /></td>
                                        <td style="width:5%"><input type="button" id="btnFabricCancel" style="width:100%" value="C" /> </td>
                                        <td style="width:5%"><input type="button" id="btnFabricPick" style="width:100%" value="P" /></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width:10%;text-align:right">Marchandiser</td>
                            <td style="width:21%;">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:80%"><input type="text" style="width:100%;" id="txtMarchandiser" /></td>
                                        <td style="width:10%"><input type="button" id="btnMarchandiserCancel" value="C" style="width:100%" /></td>
                                        <td style="width:10%"><input type="button" id="btnMarchandiserPick" value="P" style="width:100%" /></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Shipping Tollarance</td>
                            <td style="width:21%"><input type="text" style="width: 100%;" id="txtShippingTollarance" /></td>
                            <td style="width:10%;text-align:right">GSM</td>
                            <td style="width:21%">
                                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="width:80%"><input type="text" style="width:100%;" id="txtGSM" /></td>
                                        <td style="width:10%"><input type="button" id="btnGSMCancel" value="C" style="width:100%" /></td>
                                        <td style="width:10%"><input type="button" id="btnGSMPick" value="P" style="width:100%"/></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width:10%;text-align:right">Shipment Date</td>
                            <td style="width:21%">
                                <input type="text" style="width:200px;" id="txtShipmentDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Remarks</td>
                            <td style="width:85%" colspan="5">
                                <input type="text" style="width:100%" id="txtRemarks" placeholder="Enter Remarks" />
                            </td>                            
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Terms & Condition</td>
                            <td style="width:85%" colspan="5">
                                <input type="text" style="width:100%" id="txtTermsAndCondition" placeholder="Enter Terms And Condition" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Time Of Arrival Yarn</td>
                            <td style="width:21%"><input type="text" style="width:200px;" id="txtTimeOfArrivalYarn" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /> </td>
                            <td style="width:63%" colspan="4"><input type="text" style="width:100%" id="txtTimeOfArrivalYarnNote" placeholder="Expected Time Of Arrival Of Yarn" /></td>
                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Time Of Completion Knitting</td>
                            <td style="width:21%"><input type="text" style="width:200px;" id="txtTimeOfCompletionKnitting" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /> </td>
                            <td style="width:63%" colspan="4"><input type="text" style="width:100%" id="txtTimeOfCompletionKnittingNote" placeholder="Expected Time Of Arrival Of Knitting" /></td>

                        </tr>
                        <tr>
                            <td style="width:17%;text-align:right">Time Of Arrival Dyeing</td>
                            <td style="width:21%"><input type="text" style="width:200px;" id="txtTimeOfCompletionDying" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /> </td>
                            <td style="width:63%" colspan="4"><input type="text" style="width:100%" id="txtTimeOfCompletionDyingNote" placeholder="Expected Time Of Arrival Of Dyeing" /></td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            <div id="divDyeingProgramDetail" title="Knit Dyeing Info" style="padding:2px; height:100%; width:100%">
                <table id="tblKnitDyeingProgramDetail" class="easyui-datagrid" style="height:443px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" showfooter="true" toolbar="#toolbarKnitDyeingProgramDetail">
                    <thead>
                        <tr>
                            <th field="JOBPAMPONo" width="10%" align="left">JOB/PAM/PO</th>
                            <th field="ColorName" width="10%" align="left">Color</th>
                            <th field="GarmentsQty" width="10%" align="right" formatter="formatPrice">Garments Qty</th>
                            <th field="FabricTypeName" width="10%" align="left">Fabric Type</th>
                            <th field="GSMName" width="5%" align="left">GSM No</th>
                            <th field="CompositionName" width="15%" align="left">Composition</th>
                            <th field="ConsumptionPerDzn" width="10%" align="right" formatter="formatPrice">Consumption/Dz</th>
                            <th field="FinishDiaName" width="7%" align="left">Finish Dia</th>                            
                            <th field="ShadeRecipe" width="10%" align="left">Shade Recipe</th>
                            <th field="ReqFinishFabricQty" width="10%" align="right" formatter="formatPrice">Req Fabric Qty</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbarKnitDyeingProgramDetail">
                    <a id="btnAddDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                    <a id="btnEditDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                    <a id="btnCopyDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-copy" plain="true">Copy</a>
                    <a id="btnRemoveDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                    <a id="btnViewDyeingProgramDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>

                </div>
            </div>
            <div id="divYarnRequisition" title="Yarn Requisition" style="padding:2px; height:100%; width:100%">
                <table id="tblYarnRequisition" class="easyui-datagrid" style="height:443px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" showfooter="true" toolbar="#toolbarYarnRequisition">
                    <thead>
                        <tr>
                            <th field="YarnName" width="40%" align="left">Yarn Requisition</th>
                            <th width="10%" align="right" formatter="formatPrice" data-options="field:'UsagesParcent',editor:{type:'numberbox',options:{precision:2}}">Ratio(%)</th>
                            <th width="10%" align="right" formatter="formatPrice" data-options="field:'FinishRequiredQty',editor:{type:'numberbox',options:{precision:2}}">Required Qty</th>
                            <th field="UnitSymbol" width="10%" align="left">M. Unit</th>
                            <th field="FabricTypeName" width="10%" align="left">Fabric Type</th>
                            <th field="Remarks" width="25%" align="left" editor="text">Remarks</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbarYarnRequisition">
                    <a id="btnRefreshYarnRequisition" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                </div>
            </div>
        </div>
    </div>
    <fieldset style="height:10%">
        <legend style="font-weight: bold">Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
            <tr>
                <td style="width:60%; text-align:right"></td>
                <td style="width:40%;text-align:right;">
                    <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Approve</a>
                    <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true"><label id="lblSave">Save</label></a>
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>
<style type="text/css">
    td, th {
        padding: 2px;
    }
</style>
<script type="text/javascript">
    $(document).ready(function () {

        var  oKnitDyeingProgram =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oDyedTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DyedTypes));
        var oMUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MUnits));
        var oMWeightUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MWeightUnits));
        var oRefTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.RefTypes));
        $('#txtGarmentsQty,#txtConsumptionQty,#txtFabricQty,#txtOrderQty,#txtRatio,#txtRequisitionQuantity').icsCurrencyBox(null, null, 2);
        $("#cboDyedType").icsLoadCombo({ List: oDyedTypes, OptionValue: "id", DisplayText: "Value" });
        $("#cboRefType").icsLoadCombo({ List: oRefTypes, OptionValue: "id", DisplayText: "Value", InitialValue:"Open" });
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();

        $('#divKnitDyeingProgram').data('KnitDyeingProgram',oKnitDyeingProgram);
        $('#divKnitDyeingProgram').data('MUnits',oMUnits);
        $('#divKnitDyeingProgram').data('MWeightUnits',oMWeightUnits);
        $('#divKnitDyeingProgram').data('RecapOrPAMs',[]);
        $('#divKnitDyeingProgram').data('OrderRecapDetails',[]);
        $('#divKnitDyeingProgram').data('Color',null);
        RefreshControl(oKnitDyeingProgram);
    });

    function RefreshControl(oKnitDyeingProgram)
    {
        
        $('#btnApprove').hide();
        $('#cboGarmentsUnit').attr('disabled',true);
        if(sessionStorage.getItem("KnitDyeingProgramHeader")!="Add KnitDyeingProgram")
        {
            $("#txtStyleNo,#txtFabric,#txtGSM").addClass("fontColorOfPickItem");
        }
        if(sessionStorage.getItem("KnitDyeingProgramHeader")=="Revise KnitDyeingProgram")
        {
            $('#lblSave').text('Commit');
        }
        if(sessionStorage.getItem("KnitDyeingProgramHeader")=="View KnitDyeingProgram")
        {
            $("#divKnitDyeingProgram :input").attr("disabled", true);
            $('#btnAddDyeingProgramDetail,#btnEditDyeingProgramDetail,#btnRemoveDyeingProgramDetail,#btnApprove,#btnSave').hide();
        }
        else if(sessionStorage.getItem("KnitDyeingProgramHeader")=="Approved KnitDyeingProgram")
        {
            $('#btnSave').hide();
            $('#btnApprove').show();
        }

        $("#txtKnitDyeingProgramRefNo").val(oKnitDyeingProgram.RefNo);
        $("#txtBuyerName").val(oKnitDyeingProgram.BuyerName);
        $('#txtIssueDate').datebox('setValue', oKnitDyeingProgram.IssueDateInString);
        $("#txtStyleNo").val(oKnitDyeingProgram.StyleNo);
        $("#cboDyedType").val(parseInt(oKnitDyeingProgram.DyedType));
        $("#cboRefType").val(parseInt(oKnitDyeingProgram.RefTypeInt));
        $("#txtOrderQty").val(icsFormatPrice(oKnitDyeingProgram.OrderQty, null,2));
        $('#txtMunit').val(oKnitDyeingProgram.MUSymbol);
        $("#txtFabric").val(oKnitDyeingProgram.FabricName);
        $("#txtShippingTollarance").val(oKnitDyeingProgram.SrinkageTollarance);
        $("#txtGSM").val(oKnitDyeingProgram.GSMName);
        $('#txtMarchandiser').val(oKnitDyeingProgram.MerchandiserName);
        $('#txtRemarks').val(oKnitDyeingProgram.Remarks);
        $('#txtShipmentDate').datebox('setValue', oKnitDyeingProgram.ShipmentDateInString);
        $('#txtTermsAndCondition').val(oKnitDyeingProgram.TermsAndCondition);
        $('#txtTimeOfArrivalYarn').datebox('setValue', oKnitDyeingProgram.TimeOfArrivalYarnInString);
        $('#txtTimeOfArrivalYarnNote').val(oKnitDyeingProgram.TimeOfArrivalYarnNote);
        $('#txtTimeOfCompletionKnitting').datebox('setValue', oKnitDyeingProgram.TimeOfCompletionKnittingInString);
        $('#txtTimeOfCompletionKnittingNote').val(oKnitDyeingProgram.TimeOfCompletionKnittingNote);
        $('#txtTimeOfCompletionDying').datebox('setValue', oKnitDyeingProgram.TimeOfCompletionDyingInString);
        $('#txtTimeOfCompletionDyingNote').val(oKnitDyeingProgram.TimeOfCompletionDyingNote);

        DynamicRefreshList(oKnitDyeingProgram.KnitDyeingYarnRequisitions, 'tblYarnRequisition');
        DynamicRefreshList(oKnitDyeingProgram.KnitDyeingProgramDetails, 'tblKnitDyeingProgramDetail');
        RefreshYarnRequsitionTotal();
        RefreshKnitDyeingProgramTotal();
        RefreshTotalAmountConsumption();
        RefreshYarnRequisition();
    }

    function RefreshObject()
    {
        var oTempKnitDyeingProgram = $('#divKnitDyeingProgram').data('KnitDyeingProgram');
        var oKnitDyeingProgram= {
            KnitDyeingProgramID : parseInt(oTempKnitDyeingProgram.KnitDyeingProgramID),
            BUID : parseInt(sessionStorage.getItem('BUID')),
            ProgramTypeInt:sessionStorage.getItem("ProgramType"),
            RefNo : $.trim($("#txtKnitDyeingProgramRefNo").val()),
            IssueDate : $('#txtIssueDate').datebox('getValue'),
            TechnicalSheetID : parseInt(oTempKnitDyeingProgram.TechnicalSheetID),
            FabricID : parseInt(oTempKnitDyeingProgram.FabricID),
            OrderQty : parseFloat(icsRemoveComma($("#txtOrderQty").val())),
            MUnitID : parseInt(oTempKnitDyeingProgram.MUnitID),
            MerchandiserID : parseInt(oTempKnitDyeingProgram.MerchandiserID),
            DyedType : parseInt($("#cboDyedType").val()),
            RefTypeInt:parseInt($("#cboRefType").val()), 
            ShipmentDate : $('#txtShipmentDate').datebox('getValue'),
            GSMID : parseInt(oTempKnitDyeingProgram.GSMID),
            SrinkageTollarance : $.trim($("#txtShippingTollarance").val()),
            Remarks : $.trim($("#txtRemarks").val()),
            TermsAndCondition : $.trim($("#txtTermsAndCondition").val()),
            TimeOfArrivalYarn : $('#txtTimeOfArrivalYarn').datebox('getValue'),
            TimeOfArrivalYarnNote : $.trim($("#txtTimeOfArrivalYarnNote").val()),
            TimeOfCompletionKnitting : $('#txtTimeOfCompletionKnitting').datebox('getValue'),
            TimeOfCompletionKnittingNote : $.trim($("#txtTimeOfCompletionKnittingNote").val()),
            TimeOfCompletionDying : $('#txtTimeOfCompletionDying').datebox('getValue'),
            TimeOfCompletionDyingNote : $.trim($("#txtTimeOfCompletionDyingNote").val()),
            KnitDyeingYarnRequisitions : $('#tblYarnRequisition').datagrid('getRows'),
            KnitDyeingProgramDetails : $('#tblKnitDyeingProgramDetail').datagrid('getRows'),
        };
        return oKnitDyeingProgram;
    }
    $('#cboRefType').change(function(){
        //Set Program Type
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').RefTypeInt = $('#cboRefType').val();
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').RefType= $('#cboRefType').val();
        DynamicRefreshList([], 'tblKnitDyeingProgramDetail');//Empty Details

    });
    function ValidateInput(sAction){
        var oKnitDyeingProgram = $('#divKnitDyeingProgram').data('KnitDyeingProgram');
        if(parseInt(oKnitDyeingProgram.TechnicalSheetID)<=0)
        {
            alert("Please Pick a Style");
            $('#txtStyleNo').focus();
            return false;
        }

        if(parseInt(oKnitDyeingProgram.FabricID)<=0)
        {
            alert("Please Pick a Fabric");
            $('#txtFabric').focus();
            return false;
        }

        if(parseInt(oKnitDyeingProgram.GSMID)<=0)
        {
            alert("Please Pick a GSM");
            $('#txtGSM').focus();
            return false;
        }

        if(parseInt(oKnitDyeingProgram.MerchandiserID)<=0)
        {
            alert("Please Pick a MerchandiserID");
            $('#txtMarchandiser').focus();
            return false;
        }

        if(parseInt($('#cboDyedType').val())<=0)
        {
            alert("Please Select a DyedType");
            $('#cboDyedType').focus();
            return false;
        }

        var sIssuDate = $('#txtIssueDate').datebox('getValue');
        if(sIssuDate == null||sIssuDate==""){
            alert("Please Select IssueDate");
            $('#txtIssueDate').focus();
            return false;
        }
        if(sAction=='Approve')//Must be ensure Requistion and Program Detail exists
        {
            var oKnitDyeingYarnRequisitions = $('#tblYarnRequisition').datagrid('getRows');
            var oKnitDyeingProgramDetails = $('#tblKnitDyeingProgramDetail').datagrid('getRows');
            if (oKnitDyeingYarnRequisitions == null || oKnitDyeingYarnRequisitions.length<= 0)
            {
                alert("Please enter at least one Year Requisition(s)!");
                return false;
            }
            if (oKnitDyeingProgramDetails == null || oKnitDyeingProgramDetails.length<= 0)
            {
                alert("Please enter at least one Program Details(s)!");
                return false;
            }
        }
        return true;
    }
    $("#txtRatio").keyup(function (e) {
        debugger;
        var nFabricQty = parseFloat(icsRemoveComma($('#txtFabricQty').val())).toFixed(2);    
        var nQtyRatio = parseFloat(icsRemoveComma($('#txtRatio').val())).toFixed(2);  
        var nFinishReqQty = parseFloat((nQtyRatio/100))*nFabricQty;
        $('#txtRequisitionQuantity').val(icsFormatPrice(parseFloat(nFinishReqQty), null, 2));
    });
    $("#txtFabricQty").keyup(function (e) {
        debugger;
        RefreshYarnConsumptionGrid();
        
    });
    function RefreshYarnConsumptionGrid()
    {
    
        var nFabricQty = parseFloat(icsRemoveComma($('#txtFabricQty').val())).toFixed(2);
        var oYarnConsumptions =$('#tblYarnConsumption').datagrid('getRows');
        var tempYarnConsumptions=[];
        for(var i=0;i<oYarnConsumptions.length;i++)
        {
            var nQtyRatio = parseFloat(oYarnConsumptions[i].UsagesParcent);  
            var nFinishReqQty = parseFloat((nQtyRatio/100))*nFabricQty;
            var oYarnConsumption={
                KnitDyeingYarnConsumptionID:parseInt(oYarnConsumptions[i].KnitDyeingYarnConsumptionID),
                KnitDyeingProgramDetailID:parseInt(oYarnConsumptions[i].KnitDyeingProgramDetailID),
                YarnID:parseInt(oYarnConsumptions[i].YarnID),
                YarnName:oYarnConsumptions[i].YarnName,
                MUnitID:parseInt(oYarnConsumptions[i].MUnitID),
                MUnitSymbol:oYarnConsumptions[i].MUnitSymbol,
                UsagesParcent:parseFloat(nQtyRatio),
                FinishReqQty:parseFloat(nFinishReqQty),
                Remarks:oYarnConsumptions[i].Remarks,
                FabricTypeID : parseInt(oYarnConsumptions[i].FabricTypeID),
                FabricTypeName : oYarnConsumptions[i].FabricTypeName
            }
            tempYarnConsumptions.push(oYarnConsumption);
         
        }
        DynamicRefreshList(tempYarnConsumptions, 'tblYarnConsumption');
        RefreshTotalAmountConsumption();
    }
    $("#txtRequisitionQuantity").keyup(function (e) {
        debugger;
        var nFabricQty = parseFloat(icsRemoveComma($('#txtFabricQty').val())).toFixed(2);   
        var nFinishReqQty=parseFloat(icsRemoveComma($('#txtRequisitionQuantity').val())).toFixed(2);
        var nQtyRatio=parseFloat((nFinishReqQty/nFabricQty))*100;
        $('#txtRatio').val(icsFormatPrice(parseFloat(nQtyRatio), null, 2));
    });

    $('#btnSave').click(function(){
        if(!ValidateInput('Save')) return;
        var oKnitDyeingProgram=RefreshObject();
        var sActionName = "Save";
        if(sessionStorage.getItem("KnitDyeingProgramHeader")=="Revise KnitDyeingProgram")
        {
            sActionName = "AcceptRevise";
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +  "/KnitDyeingProgram/"+sActionName,
            traditional: true,
            data:  JSON.stringify(oKnitDyeingProgram),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                oKnitDyeingProgram = jQuery.parseJSON(data);
                if (oKnitDyeingProgram.ErrorMessage=="" || oKnitDyeingProgram.ErrorMessage==null)
                {
                    debugger;
                    alert("Data Saved sucessfully");
                    DynamicRefreshList(oKnitDyeingProgram.KnitDyeingProgramDetails, 'tblKnitDyeingProgramDetail'); 
                        var oKnitDyeingPrograms = sessionStorage.getItem("KnitDyeingPrograms");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oKnitDyeingPrograms != null)
                        {
                            oKnitDyeingPrograms = jQuery.parseJSON(oKnitDyeingPrograms);
                        }
                        else
                        {
                            oKnitDyeingPrograms = [];
                        }

                        if (nIndex != -1)
                        {
                            oKnitDyeingPrograms[nIndex] = oKnitDyeingProgram;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oKnitDyeingPrograms.length);
                            oKnitDyeingPrograms.push(oKnitDyeingProgram);
                        }
                        sessionStorage.setItem("KnitDyeingPrograms", JSON.stringify(oKnitDyeingPrograms));
                   if(sessionStorage.getItem("KnitDyeingProgramHeader")=="Revise KnitDyeingProgram")
                   {
                        window.location.href = sessionStorage.getItem("BackLink");
                    }else
                    {
                        $('#divKnitDyeingProgram').data('KnitDyeingProgram',oKnitDyeingProgram);
                    }
                }
                else
                {
                    alert(oKnitDyeingProgram.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $('#btnApprove').click(function(){

        if(!ValidateInput('Approve')) return;
        var oKnitDyeingProgram=$('#divKnitDyeingProgram').data('KnitDyeingProgram');
        if(!confirm("Confirm to Approve?"))return;
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/KnitDyeingProgram/Approved",
            traditional: true,
            data:  JSON.stringify(oKnitDyeingProgram),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {

                oKnitDyeingProgram = jQuery.parseJSON(data);
                if (oKnitDyeingProgram.ErrorMessage=="" || oKnitDyeingProgram.ErrorMessage==null)
                {
                    alert("Sucessfully Approved.");
                    var oKnitDyeingPrograms = sessionStorage.getItem("KnitDyeingPrograms");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oKnitDyeingPrograms != null)
                    {
                        oKnitDyeingPrograms = jQuery.parseJSON(oKnitDyeingPrograms);
                    }
                    else {
                        oKnitDyeingPrograms = [];
                    }
                    if (nIndex != -1)
                    {
                        oKnitDyeingPrograms[nIndex] = oKnitDyeingProgram;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oKnitDyeingPrograms.length);
                        oKnitDyeingPrograms.push(oKnitDyeingProgram);
                    }
                    sessionStorage.setItem("KnitDyeingPrograms", JSON.stringify(oKnitDyeingPrograms));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else
                {
                    alert(oKnitDyeingProgram.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $('#btnClose').click(function(){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    //Start Knit Dyeing Program Detail
    function InitializeKnitDyeingProgramDetail()
    {
        var oKnitDyeingProgramDetail = {
            KnitDyeingProgramDetailID : 0,
            KnitDyeingProgramID : 0,
            RefObjectID : 0,
            RefObjectNo : '',
            ColorID : 0,
            ColorName : '',
            GarmentsQty : 0,
            GarmentsMUnitID : 0,
            ConsumPtionMUnitID : 0,
            FabricTypeID : 0,
            FabricTypeName : '',
            GSMID : 0,
            GSMName : '',
            CompositionID : 0,
            CompositionName : '',
            ConsumptionPerDzn : 0,
            FinishDiaID  : 0,
            FinishDiaName : '',
            PantoneNo : '',
            ApprovedShade  : 0,
            ShadeRecipe : '',
            ShadeRemarks : '',
            ReqFinishFabricQty : 0,
            MUnitID : 0,
            Remarks : '',
            StyleID : 0,
            YetReqFabricQty : 0
        };
        return oKnitDyeingProgramDetail;
    }

    function RefreshKnitDyeingProgramDetailControl(oKnitDyeingProgramDetail)
    {
        $('#txtPantoneNo').val(oKnitDyeingProgramDetail.PantoneNo);
        $("#txtRefProgramNo").val(parseInt($('#cboRefType').val())==0?oKnitDyeingProgramDetail.RefProgramNo:"");
        $('#txtShadeReceipe').val(oKnitDyeingProgramDetail.ShadeRecipe);
        $('#txtComposition').val(oKnitDyeingProgramDetail.CompositionName);
        $('#txtFabricType').val(oKnitDyeingProgramDetail.FabricTypeName);
        $('#txtGSMDetail').val(oKnitDyeingProgramDetail.GSMName);
        $('#txtFinishDia').val(oKnitDyeingProgramDetail.FinishDiaName);
        $('#divKnitDyeingProgram').data('Color',oKnitDyeingProgramDetail);
        $("#txtColorName").val(oKnitDyeingProgramDetail.ColorName);
        $("#txtColorName").addClass("fontColorOfPickItem");
        $('#txtGarmentsQty').val(icsFormatPrice(oKnitDyeingProgramDetail.GarmentsQty, null,2));
        $('#txtConsumptionQty').val(icsFormatPrice(oKnitDyeingProgramDetail.ConsumptionPerDzn, null,2));
        $('#txtFabricQty').val(icsFormatPrice(oKnitDyeingProgramDetail.ReqFinishFabricQty, null,2));
        $('#txtRemarksDetail').val(oKnitDyeingProgramDetail.Remarks);
        $("#cboGarmentsUnit").val(oKnitDyeingProgramDetail.GarmentsMUnitID);
        $("#cboConsumptionUnit").val(oKnitDyeingProgramDetail.ConsumPtionMUnitID);
    }

    $('#btnAddDyeingProgramDetail').click(function(e){
        var oKnitDyeingProgram =  $('#divKnitDyeingProgram').data('KnitDyeingProgram');
        if(oKnitDyeingProgram == null || parseInt(oKnitDyeingProgram.TechnicalSheetID) <=0){
            alert("Please select Style first");
            $('#txtStyleNo').focus();
            return;
        }
        $('#btnSaveDyeingProgramDetail').show();
        var oKnitDyeingProgramDetail = InitializeKnitDyeingProgramDetail();
        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail', oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('SelectedIndex', -1);
        if(parseInt($('#cboRefType').val())!=0){GetOrderRecaps(oKnitDyeingProgram, 0);}else{$('#cboGarmentsUnit').attr('disabled',false);}
        $("#cboGarmentsUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        $("#cboConsumptionUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MWeightUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        $("#winKnitDyeingProgramDetail input").not("input[type='button']").val("");
        if(parseInt($('#cboRefType').val())==0){$('#cboRecapOrPam').hide();$('#txtRefProgramNo').show();}else{$('#cboRecapOrPam').show();$('#txtRefProgramNo').hide();}
        $("#winKnitDyeingProgramDetail").icsWindow('open', "Add Knit Dyeing Program Detail");
        DynamicRefreshList([], 'tblYarnConsumption'); 
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
        $("#txtRatio").val(0);
        $("#txtRequisitionQuantity").val(0);
        $("#txtRequisitionRemarks").val("");
        $('#btnAddYarnConsumption').show();
        $('#btnRemoveYarnConsumption').show();
        RefreshTotalAmountConsumption();
      
    });

    $('#btnEditDyeingProgramDetail').click(function(e){
        debugger;
        var oKnitDyeingProgramDetail = $('#tblKnitDyeingProgramDetail').datagrid('getSelected');
        if(oKnitDyeingProgramDetail == null || (parseInt(oKnitDyeingProgramDetail.RefObjectID) <=0 && oKnitDyeingProgramDetail.RefProgramNo ==""))
        {
            alert("Please Select an Item from List!");
            return;
        }
        if(parseInt($('#cboRefType').val())==0){$('#cboRecapOrPam').hide();$('#txtRefProgramNo').show();}else{$('#cboRecapOrPam').show();$('#txtRefProgramNo').hide();}
        var nSelectedIndex = $("#tblKnitDyeingProgramDetail").datagrid("getRowIndex", oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail', oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('SelectedIndex', nSelectedIndex);
        
        $('#btnSaveDyeingProgramDetail').show();
        if(parseInt($('#cboRefType').val())!=0)
        {
            var oKnitDyeingProgram =  $('#divKnitDyeingProgram').data('KnitDyeingProgram');
            GetOrderRecaps(oKnitDyeingProgram, parseInt(oKnitDyeingProgramDetail.RefObjectID));
        }
        else
        {
            $('#cboGarmentsUnit').attr('disabled',false);
        }
        $("#cboGarmentsUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        $("#cboConsumptionUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MWeightUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        RefreshKnitDyeingProgramDetailControl(oKnitDyeingProgramDetail);
        DynamicRefreshList([], 'tblYarnConsumption'); 
        DynamicRefreshList(oKnitDyeingProgramDetail.KnitDyeingYarnConsumptions, 'tblYarnConsumption'); 
        $("#txtFabricType,#txtGSMDetail,#txtFinishDia,#txtComposition").addClass("fontColorOfPickItem");
        $("#winKnitDyeingProgramDetail").icsWindow('open', "Edit Knit Dyeing Program Detail");
        $('#btnAddYarnConsumption').show();
        $('#btnRemoveYarnConsumption').show();
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
        $("#txtRatio").val(0);
        $("#txtRequisitionQuantity").val(0);
        $("#txtRequisitionRemarks").val("");
        RefreshTotalAmountConsumption();
    });

    $('#btnCopyDyeingProgramDetail').click(function(e){
        var oTempKnitDyeingProgramDetail = $('#tblKnitDyeingProgramDetail').datagrid('getSelected');
        if(oTempKnitDyeingProgramDetail == null || (parseInt(oTempKnitDyeingProgramDetail.RefObjectID) <=0 && oTempKnitDyeingProgramDetail.RefProgramNo ==""))
        {
            alert("Please Select an Item from List!");
            return;
        }
        if(parseInt($('#cboRefType').val())==0){$('#cboRecapOrPam').hide();$('#txtRefProgramNo').show();}else{$('#cboRecapOrPam').show();$('#txtRefProgramNo').hide();}
        
        var sJOBPAMPONo = "";
        if(oTempKnitDyeingProgramDetail.RefObjectNo == "")
        {
            sJOBPAMPONo = oTempKnitDyeingProgramDetail.RefObjectNo;
        }
        else
        {
            sJOBPAMPONo = oTempKnitDyeingProgramDetail.RefProgramNo;
        }

        var oKnitDyeingProgramDetail = {
            KnitDyeingProgramDetailID : 0,
            KnitDyeingProgramID : parseInt(oTempKnitDyeingProgramDetail.KnitDyeingProgramID),
            RefObjectID : parseInt(oTempKnitDyeingProgramDetail.RefObjectID),
            RefObjectNo : oTempKnitDyeingProgramDetail.RefObjectNo,
            RefProgramNo : oTempKnitDyeingProgramDetail.RefProgramNo,
            ColorID : parseInt(oTempKnitDyeingProgramDetail.ColorID),
            ColorName : oTempKnitDyeingProgramDetail.ColorName,
            GarmentsQty : parseFloat(oTempKnitDyeingProgramDetail.GarmentsQty),
            GarmentsMUnitID : parseInt(oTempKnitDyeingProgramDetail.GarmentsMUnitID),
            ConsumPtionMUnitID : parseInt(oTempKnitDyeingProgramDetail.ConsumPtionMUnitID),
            FabricTypeID : parseInt(oTempKnitDyeingProgramDetail.FabricTypeID),
            FabricTypeName : oTempKnitDyeingProgramDetail.FabricTypeName,
            GSMID : parseInt(oTempKnitDyeingProgramDetail.GSMID),
            GSMName : oTempKnitDyeingProgramDetail.GSMName,
            CompositionID : parseInt(oTempKnitDyeingProgramDetail.CompositionID),
            CompositionName : oTempKnitDyeingProgramDetail.CompositionName,
            ConsumptionPerDzn : parseFloat(oTempKnitDyeingProgramDetail.ConsumptionPerDzn),
            FinishDiaID  : parseInt(oTempKnitDyeingProgramDetail.FinishDiaID),
            FinishDiaName : oTempKnitDyeingProgramDetail.FinishDiaName,
            PantoneNo : oTempKnitDyeingProgramDetail.PantoneNo,
            ApprovedShade  : oTempKnitDyeingProgramDetail.ApprovedShade,
            ShadeRecipe : oTempKnitDyeingProgramDetail.ShadeRecipe,
            ShadeRemarks : oTempKnitDyeingProgramDetail.ShadeRemarks,
            ReqFinishFabricQty : parseFloat(oTempKnitDyeingProgramDetail.ReqFinishFabricQty),
            MUnitID : parseInt(oTempKnitDyeingProgramDetail.MUnitID),
            Remarks : oTempKnitDyeingProgramDetail.Remarks,
            JOBPAMPONo : sJOBPAMPONo
        };

        var oKnitDyeingYarnConsumptions = [];
        for(var i = 0; i<oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions.length; i++)
        {
            var oKnitDyeingYarnConsumption = {
                KnitDyeingYarnConsumptionID : 0,
                KnitDyeingProgramDetailID : 0,
                YarnID : parseInt(oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].YarnID),
                UsagesParcent :parseFloat(oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].UsagesParcent),
                FinishReqQty :parseFloat(oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].FinishReqQty),
                MUnitID :parseInt(oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].MUnitID),
                Remarks :oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].Remarks,
                YarnName:oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].YarnName,
                FabricTypeID:parseInt(oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].FabricTypeID),
                FabricTypeName :oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].FabricTypeName,
                MUnitSymbol :oTempKnitDyeingProgramDetail.KnitDyeingYarnConsumptions[i].MUnitSymbol,
        };
        oKnitDyeingYarnConsumptions.push(oKnitDyeingYarnConsumption);
        }


        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail', oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('SelectedIndex', -1);
        $('#btnSaveDyeingProgramDetail').show();
        $('#btnAddYarnConsumption').show();
        $('#btnRemoveYarnConsumption').show();
        if(parseInt($('#cboRefType').val())!=0){
            var oKnitDyeingProgram =  $('#divKnitDyeingProgram').data('KnitDyeingProgram');
            GetOrderRecaps(oKnitDyeingProgram, parseInt(oKnitDyeingProgramDetail.RefObjectID));
        }else{$('#cboGarmentsUnit').attr('disabled',false);}

        $("#cboGarmentsUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        $("#cboConsumptionUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MWeightUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        RefreshKnitDyeingProgramDetailControl(oKnitDyeingProgramDetail);
        DynamicRefreshList(oKnitDyeingYarnConsumptions, 'tblYarnConsumption'); 
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
        $("#txtRatio").val(0);
        $("#txtRequisitionQuantity").val(0);
        $("#txtRequisitionRemarks").val("");
        $("#txtFabricType,#txtGSMDetail,#txtFinishDia,#txtComposition").addClass("fontColorOfPickItem");
        $("#winKnitDyeingProgramDetail").icsWindow('open', "Add Knit Dyeing Program Detail");
        RefreshTotalAmountConsumption();
    });

    $('#btnViewDyeingProgramDetail').click(function(e){

        var oKnitDyeingProgramDetail = $('#tblKnitDyeingProgramDetail').datagrid('getSelected');
        if(oKnitDyeingProgramDetail == null || (parseInt(oKnitDyeingProgramDetail.RefObjectID) <=0 && oKnitDyeingProgramDetail.RefProgramNo ==""))
        {
            alert("Please Select an Item from List!");
            return;
        }
        if(parseInt($('#cboRefType').val())==0){$('#cboRecapOrPam').hide();$('#txtRefProgramNo').show();}else{$('#cboRecapOrPam').show();$('#txtRefProgramNo').hide();}
        var nSelectedIndex = $("#tblKnitDyeingProgramDetail").datagrid("getRowIndex", oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail', oKnitDyeingProgramDetail);
        $("#winKnitDyeingProgramDetail").data('SelectedIndex', nSelectedIndex);
        if(parseInt($('#cboRefType').val())!=0)
        {
            var oKnitDyeingProgram =  $('#divKnitDyeingProgram').data('KnitDyeingProgram');
            GetOrderRecaps(oKnitDyeingProgram, parseInt(oKnitDyeingProgramDetail.RefObjectID));
        }else{$('#cboGarmentsUnit').attr('disabled',false);}
        
        $("#cboGarmentsUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        $("#cboConsumptionUnit").icsLoadCombo({ List:$('#divKnitDyeingProgram').data('MWeightUnits'), OptionValue: "MeasurementUnitID", DisplayText: "Symbol" });
        RefreshKnitDyeingProgramDetailControl(oKnitDyeingProgramDetail);
        DynamicRefreshList(oKnitDyeingProgramDetail.KnitDyeingYarnConsumptions, 'tblYarnConsumption'); 
        $("#txtFabricType,#txtGSMDetail,#txtFinishDia,#txtComposition").addClass("fontColorOfPickItem");
        $('#btnSaveDyeingProgramDetail').hide();
        $('#btnAddYarnConsumption').hide();
        $('#btnRemoveYarnConsumption').hide();
        $("#divKnitDyeingProgram :input").attr("disabled", true);
        $("#winKnitDyeingProgramDetail").icsWindow('open', "View Knit Dyeing Program Detail");
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
        $("#txtRatio").val(0);
        $("#txtRequisitionQuantity").val(0);
        $("#txtRequisitionRemarks").val("");
        RefreshTotalAmountConsumption();
    });

    $("#btnRemoveDyeingProgramDetail").click(function (){
        var oKnitDyeingProgramDetail = $('#tblKnitDyeingProgramDetail').datagrid('getSelected');
        if(oKnitDyeingProgramDetail == null || (parseInt(oKnitDyeingProgramDetail.RefObjectID) <=0 && oKnitDyeingProgramDetail.RefProgramNo ==""))
        {
            alert("Please Select an Item from List!");
            return;
        }
        var nSelectedIndex = $("#tblKnitDyeingProgramDetail").datagrid("getRowIndex", oKnitDyeingProgramDetail);
        if (!confirm("Confirm to delete?")) return;
        $('#tblKnitDyeingProgramDetail').datagrid('deleteRow', nSelectedIndex);
        RefreshKnitDyeingProgramTotal();
        RefreshYarnRequisition();
    });

    $('#btnCloseDyeingProgramDetail').click(function(e){
        $("#winKnitDyeingProgramDetail").icsWindow('close');
    });

    function ValidateInputConsumption()
    {
        var oYarnConsumptions =$('#tblYarnConsumption').datagrid('getRows');
        var oProduct=$('#divYarnRequisition').data('RequisitionYarn');
        if(($('#divYarnRequisition').data('RequisitionYarn'))==null)
        {
            alert("Please Select Yarn Consumption");
            return false;
        }
        for (var i=0;i<oYarnConsumptions.length;i++)
        {
            if(parseInt(oYarnConsumptions[i].YarnID)==parseInt(oProduct.ProductID))
            {
                alert("Your Selected Yarn Consumption Already Exists");
                return false;
            }
        }
     
        var nFundAmount=parseFloat(icsRemoveComma($('#txtRequisitionQuantity').val()));
        if(parseFloat(nFundAmount)<=0.00)
        {
            alert("Please Give Amount");
            return false;
        }
        var nAmount=parseFloat(icsRemoveComma($('#txtFabricQty').val())).toFixed(2);
        var TotalFundAmount=parseFloat($("#txtRequisitionQuantity").data("TotalYarnConsumption")).toFixed(2);
        var nTotalCAmount=parseFloat(TotalFundAmount+nFundAmount).toFixed(2);
        if(parseFloat(nTotalCAmount)>parseFloat(nAmount))
        {
            alert("Sorry Total Consumption Amount Can not be greater than TotalAmount");
            return false;
        }
        var nFundAmountInPercent=parseFloat($("#txtRatio").data("TotalYarnConsumptionPercent")).toFixed(2);
        var nAmountRatio=parseFloat(icsRemoveComma($('#txtRatio').val())).toFixed(2);
        if((parseFloat(nFundAmountInPercent+nAmountRatio).toFixed(2))>100.00 )
        {
            alert("Sorry Total Consumption Amount in Percent can not be greater than 100");
            return false;
        }
        return true;
    }
    $('#btnRemoveYarnConsumption').click(function(e){
        endEditing();
        var rowValue= $('#tblYarnConsumption').datagrid('getSelected');
        var rowIndex = $("#tblYarnConsumption").datagrid("getRowIndex", rowValue);
        if(rowIndex<0){
            alert("please Select an Item");
            return;
        }
        $('#tblYarnConsumption').datagrid('deleteRow',rowIndex);
        RefreshTotalAmountConsumption();
       
    });
    $('#btnRefreshYarnConsumption').click(function(e){
            endEditing();
            var oYarnConsumptions =$('#tblYarnConsumption').datagrid('getRows');
            $('#tblYarnConsumption').datagrid('loadData',[]);
            DynamicRefreshList(oYarnConsumptions, 'tblYarnConsumption'); 
            RefreshTotalAmountConsumption();
          
    });
    $('#btnAddYarnConsumption').click(function(e){
        debugger;
        if(!ValidateInputConsumption()) return;
        var oTempKnitDyeingProgramDetail = $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail');
        var oProduct=$('#divYarnRequisition').data('RequisitionYarn');
        var oYarnConsumption={
            KnitDyeingYarnConsumptionID : 0,
            KnitDyeingProgramDetailID : parseInt(oTempKnitDyeingProgramDetail.KnitDyeingProgramDetailID),
            YarnID : parseInt(oProduct.ProductID),
            YarnName : oProduct.ProductName,
            MUnitID : parseInt(oProduct.MeasurementUnitID),
            MUnitSymbol : oProduct.MUnit,
            UsagesParcent : parseFloat(icsRemoveComma($("#txtRatio").val())).toFixed(2),
            FinishReqQty : parseFloat(icsRemoveComma($("#txtRequisitionQuantity").val())).toFixed(2),
            Remarks : $.trim($("#txtRequisitionRemarks").val()),
            FabricTypeID : parseInt(oTempKnitDyeingProgramDetail.FabricTypeID),
            FabricTypeName : $('#txtFabricType').val()
        }
        $('#tblYarnConsumption').datagrid('appendRow',oYarnConsumption);
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
        RefreshTotalAmountConsumption();
    });

    function RefreshTotalAmountConsumption()
    {
        
        var oYarnConsumptions = $('#tblYarnConsumption').datagrid('getRows');
        var nTotalAmount = 0,nTotalAmountInPercent=0;
        if(oYarnConsumptions.length >0)
        {
            for(var i =0;i<oYarnConsumptions.length;i++)
            {
                nTotalAmount  = nTotalAmount + parseFloat((oYarnConsumptions[i].FinishReqQty));
                nTotalAmountInPercent  = nTotalAmountInPercent + parseFloat((oYarnConsumptions[i].UsagesParcent));
            }
        }        
        $("#txtRatio").data("TotalYarnConsumptionPercent",nTotalAmountInPercent);
        $("#txtRequisitionQuantity").data("TotalYarnConsumption",nTotalAmount);

        var FooterField=[];
        var obj=new Object();
        obj['YarnName'] = "Grand Total:";
        obj['UsagesParcent'] =   icsFormatPrice(parseFloat(nTotalAmountInPercent), null, 2);
        obj['FinishReqQty'] = parseFloat(nTotalAmount);
        FooterField.push(obj);
        $('#tblYarnConsumption').datagrid('reloadFooter',FooterField);
    }
    function ValidationForDetail()
    {
      
        if(parseInt($('#cboRefType').val())==0)//Open
        {
            if($.trim($('#txtRefProgramNo').val())==null || $.trim($('#txtRefProgramNo').val())=="")
            {
                alert("Please Type Recap/PAM  No");$("#txtRefProgramNo").focus();return false;
            }
        }
        else
        {
            if(parseInt($("#cboRecapOrPam").val())<=0)
            {
                alert("Please Select Recap/PAM ");$("#cboRecapOrPam").focus();return false;
            }
        }
        var oSelectedColor = $('#divKnitDyeingProgram').data('Color');
        if(oSelectedColor==null || parseInt(oSelectedColor.ColorID)<=0)
        {
            alert("Please Select a Color");$("#txtColorName").focus();return false;
        }

        var oKnitDyeingProgramDetail = $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail');
        if(oKnitDyeingProgramDetail == null || parseInt(oKnitDyeingProgramDetail.CompositionID) <= 0){
            alert("Please select a  Yarn Composition!");
            $("#txtComposition").focus();
            return false;
        }

        if(oKnitDyeingProgramDetail == null || parseInt(oKnitDyeingProgramDetail.FabricTypeID) <= 0){
            alert("Please select a  Fabric Type!");
            $("#txtFabricType").focus();
            return false;
        }

        if(oKnitDyeingProgramDetail == null || parseInt(oKnitDyeingProgramDetail.GSMID) <= 0){
            alert("Please select a GSM!");
            $("#txtGSMDetail").focus();
            return false;
        }

        if(oKnitDyeingProgramDetail == null || parseInt(oKnitDyeingProgramDetail.FinishDiaID) <= 0){
            alert("Please select a Finish Dia!");
            $("#txtFinishDia").focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtGarmentsQty").val())) <= 0){
            alert("Please Enter Garments Qty!");
            $("#txtGarmentsQty").focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtConsumptionQty").val())) <= 0){
            alert("Please Enter  Consumption Qty / Dzn!");
            $("#txtConsumptionQty").focus();
            return false;
        }

        if(parseInt($("#cboConsumptionUnit").val())<=0)
        {
            alert("Please Select Consumption Measurement Unit!");
            $("#cboConsumptionUnit").focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtFabricQty").val())) <= 0){
            alert("Please Enter  Req. Fabric Qty!");
            $("#txtFabricQty").focus();
            return false;
        }

        var nDiffQty = (parseFloat(parseFloat($("#txtRequisitionQuantity").data("TotalYarnConsumption")).toFixed(2)) - parseFloat(parseFloat(icsRemoveComma($("#txtFabricQty").val())).toFixed(2)));
        if(nDiffQty < 0)
        {
            nDiffQty = (nDiffQty * (-1));
        }

        if(nDiffQty > 0.02)
        {
            alert("Total Yarn Consumption Quantity should be equal to Total Req. Fabric Qty")
            {
                return false;
            }
        }
        return true;
    }

    $('#btnSaveDyeingProgramDetail').click(function(e){
        debugger;
        endEditing();
        if(!ValidationForDetail()) return;
        var oTempKnitDyeingProgramDetail = $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail');
        var oKnitDyeingProgramDetail = {
            KnitDyeingProgramDetailID : parseInt(oTempKnitDyeingProgramDetail.KnitDyeingProgramDetailID),
            KnitDyeingProgramID : parseInt(oTempKnitDyeingProgramDetail.KnitDyeingProgramID),
            RefObjectID :parseInt($('#cboRefType').val())==0?0:parseInt($("#cboRecapOrPam").val()),
            RefObjectNo :parseInt($('#cboRefType').val())==0?$("#txtRefProgramNo").val():$('#cboRecapOrPam option:selected').text(),
            JOBPAMPONo : parseInt($('#cboRefType').val())==0?$("#txtRefProgramNo").val():$('#cboRecapOrPam option:selected').text(),
            RefProgramNo:$("#txtRefProgramNo").val(),
            ColorID : parseInt($('#divKnitDyeingProgram').data('Color').ColorID),
            ColorName : $('#divKnitDyeingProgram').data('Color').ColorName,
            GarmentsQty : parseFloat(icsRemoveComma($("#txtGarmentsQty").val())),
            GarmentsMUnitID : parseInt($("#cboGarmentsUnit").val()),
            ConsumPtionMUnitID : parseInt($("#cboConsumptionUnit").val()),
            FabricTypeID : parseInt(oTempKnitDyeingProgramDetail.FabricTypeID),
            FabricTypeName : $('#txtFabricType').val(),
            GSMID : parseInt(oTempKnitDyeingProgramDetail.GSMID),
            GSMName : $('#txtGSMDetail').val(),
            CompositionID : parseInt(oTempKnitDyeingProgramDetail.CompositionID),
            CompositionName : $('#txtComposition').val(),
            ConsumptionPerDzn : parseFloat(icsRemoveComma($("#txtConsumptionQty").val())),
            FinishDiaID : parseInt(oTempKnitDyeingProgramDetail.FinishDiaID),
            FinishDiaName : $('#txtFinishDia').val(),
            PantoneNo : $('#txtPantoneNo').val(),
            ApprovedShade : 0,
            ShadeRecipe : $('#txtShadeReceipe').val(),
            ShadeRemarks : "",
            ReqFinishFabricQty : parseFloat(icsRemoveComma($("#txtFabricQty").val())),
            MUnitID : $('#cboConsumptionUnit').val(),
            Remarks : $('#txtRemarksDetail').val(),
            KnitDyeingYarnConsumptions:$('#tblYarnConsumption').datagrid('getRows')
        };

        if(parseInt($("#winKnitDyeingProgramDetail").data('SelectedIndex')) == -1)
        {
            $('#tblKnitDyeingProgramDetail').datagrid('appendRow', oKnitDyeingProgramDetail);
        }
        else
        {
            $('#tblKnitDyeingProgramDetail').datagrid('updateRow',{ index: parseInt($("#winKnitDyeingProgramDetail").data('SelectedIndex')), row: oKnitDyeingProgramDetail });
        }
        $("#winKnitDyeingProgramDetail").icsWindow('close');
        RefreshKnitDyeingProgramTotal();
        RefreshYarnRequisition();
    });

    function GetKnitDyeingYarnRequisitionID(nYarnCountID, nFabricTypeID)
    {
        var oKnitDyeingYarnRequisitions =  $('#tblYarnRequisition').datagrid('getRows');
        for(var i=0; i<oKnitDyeingYarnRequisitions.length; i++)
        {
            if(parseInt(oKnitDyeingYarnRequisitions[i].YarnCountID) == parseInt(nYarnCountID) &&  parseInt(oKnitDyeingYarnRequisitions[i].FabricTypeID) == parseInt(nFabricTypeID))
            {
                return parseInt(oKnitDyeingYarnRequisitions[i].KnitDyeingYarnRequisitionID);
            }
        }
        return 0;
    }

    function AlreadyExists(oKnitDyeingYarnRequisitions, nYarnCountID, nFabricTypeID)
    {
        for(var i=0; i<oKnitDyeingYarnRequisitions.length; i++)
        {
            if(parseInt(oKnitDyeingYarnRequisitions[i].YarnCountID) == parseInt(nYarnCountID) &&  parseInt(oKnitDyeingYarnRequisitions[i].FabricTypeID) == parseInt(nFabricTypeID))
            {
                return true;
            }
        }
        return false;
    }

    function GetYarnAndFabricTypeWiseFinishRequiredQty(oTempKnitDyeingYarnConsumptions, nYarnCountID, nFabricTypeID)
    {
        var nFinishRequiredQty = 0;
        for(var i=0; i<oTempKnitDyeingYarnConsumptions.length; i++)
        {
            if(parseInt(oTempKnitDyeingYarnConsumptions[i].YarnID) == parseInt(nYarnCountID) &&  parseInt(oTempKnitDyeingYarnConsumptions[i].FabricTypeID) == parseInt(nFabricTypeID))
            {
                nFinishRequiredQty = nFinishRequiredQty + parseFloat(oTempKnitDyeingYarnConsumptions[i].FinishReqQty);
            }
        }
        return nFinishRequiredQty;
    }

    function RefreshYarnRequisition()
    {   
        debugger;
        var oTempKnitDyeingYarnConsumptions = [];
        var oKnitDyeingProgramDetails = $('#tblKnitDyeingProgramDetail').datagrid('getRows');
        for(var i=0;i<oKnitDyeingProgramDetails.length;i++)
        {
            for(var j=0;j<oKnitDyeingProgramDetails[i].KnitDyeingYarnConsumptions.length;j++)
            {
                oTempKnitDyeingYarnConsumptions.push(oKnitDyeingProgramDetails[i].KnitDyeingYarnConsumptions[j]);
            }
        }
        
        var nTotalFinishReqQty = 0;
        var oKnitDyeingYarnRequisitions = [];
        for(var i =0; i< oTempKnitDyeingYarnConsumptions.length; i++)
        {
            if(!AlreadyExists(oKnitDyeingYarnRequisitions, oTempKnitDyeingYarnConsumptions[i].YarnID, oTempKnitDyeingYarnConsumptions[i].FabricTypeID))
            {
                var oKnitDyeingYarnRequisition = {
                    KnitDyeingYarnRequisitionID : GetKnitDyeingYarnRequisitionID(oTempKnitDyeingYarnConsumptions[i].YarnID, oTempKnitDyeingYarnConsumptions[i].FabricTypeID),
                    KnitDyeingProgramID : 0,
                    KnitDyeingYarnRequisitionLogID : 0,
                    KnitDyeingProgramLogID : 0,
                    YarnCountID : parseInt(oTempKnitDyeingYarnConsumptions[i].YarnID),
                    UsagesParcent : 0,
                    FabricTypeID : parseInt(oTempKnitDyeingYarnConsumptions[i].FabricTypeID),
                    FinishRequiredQty : GetYarnAndFabricTypeWiseFinishRequiredQty(oTempKnitDyeingYarnConsumptions, oTempKnitDyeingYarnConsumptions[i].YarnID, oTempKnitDyeingYarnConsumptions[i].FabricTypeID),
                    MUnitID : parseInt(oTempKnitDyeingYarnConsumptions[i].MUnitID),
                    UnitSymbol : oTempKnitDyeingYarnConsumptions[i].MUnitSymbol,
                    Remarks : "",
                    YarnName : oTempKnitDyeingYarnConsumptions[i].YarnName,
                    FabricTypeName : oTempKnitDyeingYarnConsumptions[i].FabricTypeName
                };
                oKnitDyeingYarnRequisitions.push(oKnitDyeingYarnRequisition);
            }
            nTotalFinishReqQty = nTotalFinishReqQty + parseFloat(oTempKnitDyeingYarnConsumptions[i].FinishReqQty);
        }

        for(var i =0; i< oKnitDyeingYarnRequisitions.length; i++)
        {
            oKnitDyeingYarnRequisitions[i].UsagesParcent = ((100 / nTotalFinishReqQty) * parseFloat(oKnitDyeingYarnRequisitions[i].FinishRequiredQty));
        }        
        DynamicRefreshList(oKnitDyeingYarnRequisitions, 'tblYarnRequisition'); 
        RefreshYarnRequsitionTotal();
    }



    function RefreshKnitDyeingProgramTotal()
    {
        debugger;
        var oTempKnitDyeingProgramDetails = [];
        var oKnitDyeingProgramDetails = $('#tblKnitDyeingProgramDetail').datagrid('getRows');
        var nTotalGarmentsQty = 0, nTotalReqFinishFabricQty = 0;
        if(oKnitDyeingProgramDetails.length >0)
        {
            for(var i =0; i < oKnitDyeingProgramDetails.length; i++)
            {
                if(!IsAlreadyCounted(oKnitDyeingProgramDetails[i].RefObjectID, oKnitDyeingProgramDetails[i].ColorID, oTempKnitDyeingProgramDetails))
                {
                    nTotalGarmentsQty = nTotalGarmentsQty + GetOrderRecapAndColorWiseGarmentsQty(oKnitDyeingProgramDetails[i].RefObjectID, oKnitDyeingProgramDetails[i].ColorID, oKnitDyeingProgramDetails);
                    oTempKnitDyeingProgramDetails.push(oKnitDyeingProgramDetails[i]);
                }
                nTotalReqFinishFabricQty  = nTotalReqFinishFabricQty + parseFloat(oKnitDyeingProgramDetails[i].ReqFinishFabricQty);
            }
        }

        var FooterField=[];
        var obj=new Object();
        obj['RefObjectNo'] = "Total:";
        obj['GarmentsQty'] = parseFloat(nTotalGarmentsQty);
        obj['ReqFinishFabricQty'] = parseFloat(nTotalReqFinishFabricQty);
        FooterField.push(obj);
        $('#tblKnitDyeingProgramDetail').datagrid('reloadFooter',FooterField);
    }

    function GetOrderRecapAndColorWiseGarmentsQty(nRefObjectID, nColorID, oKnitDyeingProgramDetails)
    {
        for(var i =0; i < oKnitDyeingProgramDetails.length; i++)
        {
            if(parseInt(oKnitDyeingProgramDetails[i].RefObjectID) == parseInt(nRefObjectID) &&  parseInt(oKnitDyeingProgramDetails[i].ColorID) == parseInt(nColorID))
            {
                return parseFloat(oKnitDyeingProgramDetails[i].GarmentsQty);
            }
        }
        return 0.00;
    }

    function IsAlreadyCounted(nRefObjectID, nColorID, oKnitDyeingProgramDetails)
    {
        for(var i =0; i < oKnitDyeingProgramDetails.length; i++)
        {
            if(parseInt(oKnitDyeingProgramDetails[i].RefObjectID) == parseInt(nRefObjectID) &&  parseInt(oKnitDyeingProgramDetails[i].ColorID) == parseInt(nColorID))
            {
                return true;
            }
        }
        return false;
    }

    function GetOrderRecaps(oKnitDyeingProgram, nRefObjectID)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +"/KnitDyeingProgram/GetRecapOrPAMs",
            traditional: true,
            data:  JSON.stringify(oKnitDyeingProgram),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                oRecapOrPAMs = jQuery.parseJSON(data);
                if (oRecapOrPAMs.length> 0 && (oRecapOrPAMs[0].ErrorMessage=="" || oRecapOrPAMs[0].ErrorMessage==null))
                {
                    debugger;
                    $('#divKnitDyeingProgram').data('RecapOrPAMs', oRecapOrPAMs);//Load get data
                    if(oKnitDyeingProgram.RefTypeInt==1)//Order Recap
                    {
                        $("#cboRecapOrPam").icsLoadCombo({ List: oRecapOrPAMs, OptionValue: "OrderRecapID", DisplayText: "OrderRecapNo" });
                    }else{  //PAM
                        $("#cboRecapOrPam").icsLoadCombo({ List: oRecapOrPAMs, OptionValue: "PAMID", DisplayText: "PAMNo" });
                    }
                    if(parseInt(nRefObjectID)>0)
                    {
                        $('#cboRecapOrPam').val(nRefObjectID);
                    }
                }
                else
                {
                    alert(oRecapOrPAMs[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }



    $("#cboRecapOrPam").change(function () {
        var oSelectedRecapOrPAM = null;
        if(parseInt($('#cboRefType').val()) == 1)
        {
            oSelectedRecapOrPAM    = ICS_FindObject($('#divKnitDyeingProgram').data('RecapOrPAMs'),"OrderRecapID", parseInt($("#cboRecapOrPam").val()));
        }
        else if(parseInt($('#cboRefType').val()) == 2)
        {
            oSelectedRecapOrPAM    = ICS_FindObject($('#divKnitDyeingProgram').data('RecapOrPAMs'),"PAMID", parseInt($("#cboRecapOrPam").val()));
        }
        if(oSelectedRecapOrPAM != null)
        {
            $("#cboGarmentsUnit").val(oSelectedRecapOrPAM.MeasurementUnitID);
        }
        $('#divKnitDyeingProgram').data('Color',null);
        $("#txtColorName").val('');
        $("#txtColorName").removeClass("fontColorOfPickItem");
        $("#txtGarmentsQty").val(0);
        CalculateFabricQty();
    });

    $('#txtColorName').keydown(function(e){
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtColorName').val())==null || $.trim($('#txtColorName').val())=="")
            {
                alert("Type color Name.");
                return;
            }
            PickColor();
        }
        else if (code == 8) //backspace=8
        {
            $('#divKnitDyeingProgram').data('Color',null);
            $("#txtColorName").removeClass("fontColorOfPickItem");
        }
    });
    function PickColor()
    {
        var oKnitDyeingProgramDetail = {
            RefTypeInt:parseInt($('#cboRefType').val()),
            RefObjectID:parseInt($('#cboRefType').val())==0?0:parseInt($("#cboRecapOrPam").val()),
            ColorName:$.trim($('#txtColorName').val())
        };
        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: (oKnitDyeingProgramDetail) ,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GetColors",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ColorID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ColorName", title: "ColorName", width:300, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winColor',
                        winclass: 'clsColor',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblColor',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ColorName',
                        windowTittle: 'Color List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });

     
    }

    
    $("#cboConsumptionUnit").change(function () {
        $("#btnFabricUnitName").val($('#cboConsumptionUnit option:selected').text());
    });

    $('#txtGarmentsQty,#txtConsumptionQty').keyup(function(){
        CalculateFabricQty();
    });

    $('#txtGarmentsQty,#txtConsumptionQty').change(function(){
        CalculateFabricQty();
    });

    function CalculateFabricQty()
    {        
        var nGArQtyInDzn = parseFloat(icsRemoveComma($("#txtGarmentsQty").val()))/12;
        var nConsumQty = parseFloat(icsRemoveComma($("#txtConsumptionQty").val()));
        $('#txtFabricQty').val(icsFormatPrice(parseFloat(nGArQtyInDzn*nConsumQty), null,2));     
        RefreshYarnConsumptionGrid();
    }
    //End Knit Dyeing Program Detail



    //Yarn Requisition

    $('#btnRefreshYarnRequisition').click(function(e){
        var oYarnRequisitions = $('#tblYarnRequisition').datagrid('getRows');
        DynamicRefreshList(oYarnRequisitions, 'tblYarnRequisition');
        RefreshYarnRequsitionTotal()();
    });




    function YarnRequisitionValidateInput()
    {
        var oRequisitionYarn = $('#divYarnRequisition').data('RequisitionYarn');
        if(oRequisitionYarn == null || parseInt(oRequisitionYarn.ProductID) <=0 ){
            alert("Please select a Yarn Composition");
            $("#txtRequisitionYarnName").focus();
            return false;
        }

        if(oRequisitionYarn == null || parseInt(oRequisitionYarn.MeasurementUnitID) <=0 ){
            alert("Invalid Measurement Unit!");
            $("#txtRequisitionMUnit").focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtRatio").val())) <=0){
            alert("Please Enter Usages Ration");
            $("#txtRatio").focus();
            return false;
        }

        if(parseFloat(icsRemoveComma($("#txtRequisitionQuantity").val())) <=0){
            alert("Please Enter Requisition Quantity");
            $("#txtRequisitionQuantity").focus();
            return false;
        }

        //var oYarnRequisitions = $('#tblYarnRequisition').datagrid('getRows');
        //if(oYarnRequisitions != null)
        //{
        //    var nSelectedIndex = $("#winYarnRequsition").data("YarnRequisitionSelectedIndex");
        //    for(var i=0; i<oYarnRequisitions.length; i++)
        //    {
        //        if(parseInt(oRequisitionYarn.ProductID) == parseInt(oYarnRequisitions[i].YarnCountID) &&  i != parseInt(nSelectedIndex))
        //        {
        //            alert("Your Selected Yarn Already Exists!");
        //            return false;
        //        }
        //    }
        //}

        return true;
    }

    $('#btnSaveYarnRequisition').click(function(e){
        if(!YarnRequisitionValidateInput()) return;
        var oRequisitionYarn = $('#divYarnRequisition').data('RequisitionYarn');
        var oTempKnitDyeingYarnRequisition = $("#winYarnRequsition").data("KnitDyeingYarnRequisition");

        var oKnitDyeingYarnRequisition ={
            KnitDyeingYarnRequisitionID : parseInt(oTempKnitDyeingYarnRequisition.KnitDyeingYarnRequisitionID),
            KnitDyeingProgramID : parseInt(oTempKnitDyeingYarnRequisition.KnitDyeingProgramID),
            YarnCountID : parseInt(oRequisitionYarn.ProductID),
            UsagesParcent : parseFloat(icsRemoveComma($("#txtRatio").val())),
            YarnTypeID : 0,
            FinishRequiredQty :parseFloat(icsRemoveComma($("#txtRequisitionQuantity").val())),
            MUnitID : parseInt(oRequisitionYarn.MeasurementUnitID),
            Remarks : $("#txtRequisitionRemarks").val(),
            YarnName : oRequisitionYarn.ProductName,
            UnitSymbol : oRequisitionYarn.MUnit
        };
        var sYarnRequsitionOperation = $("#winYarnRequsition").data("YarnRequsitionOperation");
        if(sYarnRequsitionOperation == 'Add')
        {
            $('#tblYarnRequisition').datagrid('appendRow', oKnitDyeingYarnRequisition);
        }
        else
        {
            var nSelectedIndex = parseInt($("#winYarnRequsition").data("YarnRequisitionSelectedIndex"));
            $('#tblYarnRequisition').datagrid('updateRow',{ index: nSelectedIndex, row: oKnitDyeingYarnRequisition });
        }
        $("#winYarnRequsition").icsWindow('close');
        RefreshYarnRequsitionTotal();
    });

    $('#btnCloseYarnRequisition').click(function(e){
        $("#winYarnRequsition").icsWindow('close');
    });

    function RefreshYarnRequsitionTotal()
    {
        debugger;
        var oYarnRequisitions = $('#tblYarnRequisition').datagrid('getRows');
        var nTotalFinishRequiredQty = 0, nTotalUsagesParcent=0;
        if(oYarnRequisitions.length >0)
        {
            for(var i =0;i<oYarnRequisitions.length;i++)
            {
                nTotalFinishRequiredQty  = nTotalFinishRequiredQty + parseFloat(oYarnRequisitions[i].FinishRequiredQty);
                nTotalUsagesParcent  = nTotalUsagesParcent + parseFloat(oYarnRequisitions[i].UsagesParcent);
            }
        }

        var FooterField=[];
        var obj=new Object();
        obj['YarnName'] = "Grand Total:";
        obj['FinishRequiredQty'] = parseFloat(nTotalFinishRequiredQty);
        obj['UsagesParcent'] = parseFloat(nTotalUsagesParcent);
        FooterField.push(obj);
        $('#tblYarnRequisition').datagrid('reloadFooter',FooterField);
    }

    //end Yarn Requisition



    //Start Pickers
    $('#txtStyleNo').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtStyleNo').val())==null || $.trim($('#txtStyleNo').val())=="")
            {
                alert("Type Style No.");
                return;
            }
            StylePiker();
        }
        else if (code == 8) //backspace=8
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').TechnicalSheetID = 0;
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = 0;
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = 0;
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').MUnitID = 0;
            $("#txtBuyerName,#txtFabric,#txtMarchandiser,#txtMunit").val("");
            $("#txtOrderQty").val(icsFormatPrice(0.00, null,2));
            $("#txtStyleNo,#txtBuyerName,#txtFabric,#txtMarchandiser,#txtMunit").removeClass("fontColorOfPickItem");
            DynamicRefreshList([], 'tblKnitDyeingProgramDetail');
        }
    });

    $('#btnStyleNoCancel').click(function (e) {
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').TechnicalSheetID = 0;
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = 0;
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = 0;
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').MUnitID = 0;
        $("#txtStyleNo,#txtBuyerName,#txtFabric,#txtMarchandiser,#txtMunit").val("");
        $("#txtOrderQty").val(icsFormatPrice(0.00, null,2));
        $("#txtStyleNo,#txtBuyerName,#txtFabric,#txtMarchandiser,#txtMunit").removeClass("fontColorOfPickItem");
        DynamicRefreshList([], 'tblKnitDyeingProgramDetail');
    });

    $('#btnStyleNoPick').click(function (e) {
        if($.trim($('#txtStyleNo').val())==null || $.trim($('#txtStyleNo').val())=="")
        {
            alert("Type Style No.");
            return;
        }
        StylePiker();
    });

    function StylePiker()
    {

        var oTechnicalSheet =   {
                                    BUID : 0,
                                    StyleNo : $.trim($('#txtStyleNo').val())
                                };
        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oTechnicalSheet,
            ControllerName: "OrderRecap",
            ActionName: "StyleSearch",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].TechnicalSheetID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "StyleNo", title: "Style No", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buyer", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ApproxQty", title: "Approx Qty", width:150, align: "right" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winStyle',
                        winclass: 'clsStyle',
                        winwidth: 620,
                        winheight: 460,
                        tableid: 'tblStyle',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'StyleNo',
                        windowTittle: 'Style List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }



    $('#txtFabric').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtFabric').val())==null || $.trim($('#txtFabric').val())=="")
            {
                alert("Type Fabric No.");
                return;
            }
            FabricPicker();
        }
        else if (code == 8) //backspace=8
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = 0;
            $("#txtFabric").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnFabricCancel').click(function (e) {
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = 0;
        $("#txtFabric").val("");
        $("#txtFabric").removeClass("fontColorOfPickItem");
    });

    $('#btnFabricPick').click(function (e) {
        if($.trim($('#txtFabric').val())==null || $.trim($('#txtFabric').val())=="")
        {
            alert("Type Fabric Name.");
            return;
        }
        FabricPicker();
    });

    function FabricPicker()
    {

        var  oProductSearch = {
            BUID: sessionStorage.getItem('BUID'),
            ProductName:$.trim($("#txtFabric").val()),
        };


        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: (oProductSearch) ,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GetProducts",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Product Code", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width:150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winFabric',
                        winclass: 'clsProduct',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProduct',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ProductName',
                        windowTittle: 'Fabric List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }


    $('#txtMarchandiser').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtMarchandiser').val())==null || $.trim($('#txtMarchandiser').val())=="")
            {
                alert("Type Marchandiser No.");
                return;
            }
            MarchandiserPiker();
        }
        else if (code == 8) //backspace=8
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = 0;
            $("#txtMarchandiser").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnMarchandiserCancel').click(function (e) {
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = 0;
        $("#txtMarchandiser").val("");
        $("#txtMarchandiser").removeClass("fontColorOfPickItem");
    });

    $('#btnMarchandiserPick').click(function (e) {
        MarchandiserPiker();
    });

    function MarchandiserPiker()
    {

        var  oMarchandiserSearch = {
            EmployeeTypeID:23,
            Name:$.trim($("#txtMarchandiser").val()),
        };


        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: (oMarchandiserSearch) ,
            ControllerName: "Employee",
            ActionName: "EmployeeSearchByName",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].EmployeeID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Marchandiser Name", width:150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winMarchandiser',
                        winclass: 'clsMarchandiser',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblMarchandiser',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Marchandiser List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }



    $('#txtGSM').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtGSM').val())==null || $.trim($('#txtGSM').val())=="")
            {
                alert("Type GSM No.");
                return;
            }
            GsmPiker();
        }
        else if (code == 8) //backspace=8
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').GSMID = 0;
            $("#txtGSM").removeClass("fontColorOfPickItem");

        }
    });

    $('#btnGSMCancel').click(function (e) {
        $('#divKnitDyeingProgram').data('KnitDyeingProgram').GSMID = 0;
        $("#txtGSM").val("");
        $("#txtGSM").removeClass("fontColorOfPickItem");
    });

    $('#btnGSMPick').click(function (e) {
        GsmPiker();
    });

    function GsmPiker()
    {

        var oGSMSearch = {
            SourcingConfigHeadName:$.trim($('#txtGSM').val()),
            SourcingConfigHeadType:2
        };
        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oGSMSearch,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GSMSearch",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].SourcingConfigHeadID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "SourcingConfigHeadName", title: "GSM", width:200, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winGSM',
                        winclass: 'clsGSM',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblGSM',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SourcingConfigHeadName',
                        windowTittle: 'GSM List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }


    $('#txtRequisitionYarnName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtRequisitionYarnName').val())===null || $.trim($('#txtRequisitionYarnName').val())==="")
            {
                alert("Press enter with Product name");
                return;
            }
            PickRequisitionYarn();
        }
        if (code == 8) //backspace=8
        {
            $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
            $('#divYarnRequisition').data('RequisitionYarn', null);
            $('#txtRequisitionMUnit').val("");
        }
    });

    $('#txtRequisitionYarnClear').click(function (e) {
        $("#txtRequisitionYarnName").removeClass("fontColorOfPickItem");
        $("#txtRequisitionYarnName").val("");
        $('#txtRequisitionMUnit').val("");
        $('#divYarnRequisition').data('RequisitionYarn', null);
    });

    $('#txtRequisitionYarnPicker').click(function (e) {
        if($.trim($('#txtRequisitionYarnName').val())===null || $.trim($('#txtRequisitionYarnName').val())==="")
        {
            alert("Press enter with Product name");
            return;
        }
        PickRequisitionYarn();
    });

    function PickRequisitionYarn()
    {
        var  oProductSearch = {
            BUID:  sessionStorage.getItem('BUID'),
            ProductName:$.trim($("#txtRequisitionYarnName").val()),
        };


        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: (oProductSearch) ,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GetProducts",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Product Code", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width:150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winYarnRequisitionProduct',
                        winclass: 'clsProductYarn',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProductYarn',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }


    $('#txtComposition').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtComposition').val())===null || $.trim($('#txtComposition').val())==="")
            {
                alert("Press enter with Product name");
                $('#txtComposition').focus();
                return;
            }
            CompositionPicker();
        }
        if (code == 8) //backspace=8
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').CompositionID = 0;
            $("#txtComposition").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnCompositionClear').click(function (e) {
        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').CompositionID = 0;
        $("#txtComposition").val("");
        $("#txtComposition").removeClass("fontColorOfPickItem");

    });

    $('#btnCompositionPicker').click(function (e) {
        if($.trim($('#txtComposition').val())===null || $.trim($('#txtComposition').val())==="")
        {
            alert("Press enter with Product name");
            $('#txtComposition').focus();
            return;
        }
        CompositionPicker();
    });

    function CompositionPicker()
    {
        var  oProductSearch = {
            BUID: sessionStorage.getItem('BUID'),
            ProductName:$.trim($("#txtComposition").val()),
        };

        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: (oProductSearch) ,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GetProducts",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Product Code", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width:150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winComposition',
                        winclass: 'clsComposition',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblComposition',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }



    $('#txtFabricType').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtFabricType').val())==null || $.trim($('#txtFabricType').val())=="")
            {
                alert("Search With Fabric Type");
                return;
            }
            PickFabricType();
        }
        else if (code == 8) //backspace=8
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FabricTypeID = 0;
            $("#txtFabricType").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnAddFabricType').click(function (e) {
        if($.trim($('#txtFabricType').val())==null || $.trim($('#txtFabricType').val())=="")
        {
            alert("Search With Fabric Type");
            return;
        }
        AddSourcingConfig(6, $.trim($('#txtFabricType').val()));
    });

    $('#btnPickFabricType').click(function (e) {
        PickFabricType();
    });

    function PickFabricType()
    {
        var oFabricType = {
            SourcingConfigHeadName : $.trim($('#txtFabricType').val()),
            SourcingConfigHeadType : 6 //FabricType = 6
        };

        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oFabricType,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GSMSearch",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].SourcingConfigHeadID > 0) {
                    var tblColums = [];

                    var oColumn = { field: "SourcingConfigHeadID", title: "Code", width:100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "SourcingConfigHeadName", title: "Fabric Type", width:200, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winFabricType',
                        winclass: 'clsFabricType',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblFabricType',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SourcingConfigHeadName',
                        windowTittle: 'Fabric Type List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }


    $('#txtGSMDetail').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtGSMDetail').val())==null || $.trim($('#txtGSMDetail').val())=="")
            {
                alert("Search With GSM!");
                return;
            }
            PickGSMDetail();
        }
        else if (code == 8) //backspace=8
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').GSMID = 0;
            $("#txtGSMDetail").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnAddGSMDetail').click(function (e) {
        if($.trim($('#txtGSMDetail').val())==null || $.trim($('#txtGSMDetail').val())=="")
        {
            alert("Search With GSM!");
            return;
        }
        AddSourcingConfig(2, $.trim($('#txtGSMDetail').val()));
    });

    $('#btnPickGSMDetail').click(function (e) {
        PickGSMDetail();
    });

    function PickGSMDetail()
    {
        var oGSMSearch = {
            SourcingConfigHeadName : $.trim($('#txtGSMDetail').val()),
            SourcingConfigHeadType : 2 //GSM
        };

        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oGSMSearch,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GSMSearch",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].SourcingConfigHeadID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "SourcingConfigHeadID", title: "Code", width:100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "SourcingConfigHeadName", title: "GSM", width:200, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winGSMDetail',
                        winclass: 'clsGSMDetail',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblGSMDetail',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SourcingConfigHeadName',
                        windowTittle: 'GSMDetail List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }


    $('#txtFinishDia').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code==13)//enter
        {
            if($.trim($('#txtFinishDia').val())==null || $.trim($('#txtFinishDia').val())=="")
            {
                alert("Type FinishDia.");
                return;
            }
            PickFinishDia();
        }
        else if (code == 8) //backspace=8
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FinishDiaID = 0;
            $("#txtFinishDia").removeClass("fontColorOfPickItem");
        }
    });

    $('#btnAddFinishDia').click(function (e) {
        if($.trim($('#txtFinishDia').val())==null || $.trim($('#txtFinishDia').val())=="")
        {
            alert("Search Finish Dia!");
            return;
        }
        AddSourcingConfig(3, $.trim($('#txtFinishDia').val()));
    });

    $('#btnPickFinishDia').click(function (e) {
        PickFinishDia();
    });

    function PickFinishDia()
    {
        var oFinishDia = {
            SourcingConfigHeadName : $.trim($('#txtFinishDia').val()),
            SourcingConfigHeadType : 3 //Finish Dia
        };

        var obj = {
            BaseAddress: sessionStorage.getItem('BaseAddress'),
            Object: oFinishDia,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GSMSearch",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].SourcingConfigHeadID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "SourcingConfigHeadID", title: "Code", width:100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "SourcingConfigHeadName", title: "Finish Dia", width:200, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winFinishDia',
                        winclass: 'clsFinishDia',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblFinishDia',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'SourcingConfigHeadName',
                        windowTittle: 'FinishDia List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }

    function AddSourcingConfig(nSourcingType, sSourcingHeadName)
    {
        //EnumSourcingConfigHeadType { None = 0, Wash = 1, GSM = 2, FinishDIA = 3, MachineDIA = 4, YarnType = 5, FabricType = 6, GrayDIA = 7}
        if(sSourcingHeadName==null||sSourcingHeadName==""){
            if(parseInt(nSourcingType) == 6)
            {
                alert("Please enter Fabric Type");
            }
            else if(parseInt(nSourcingType) == 2)
            {
                alert("Please enter GSM");
            }
            else
            {
                alert("Please enter Finish Dia");
            }
            return;
        }
        var oSourcingConfigHead = {
            SourcingConfigHeadID : 0,
            SourcingConfigHeadName : sSourcingHeadName,
            SourcingConfigHeadType : parseInt(nSourcingType),
            Remarks: "N/A"
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/SourcingConfigHead/Save",
            traditional: true,
            data:  JSON.stringify(oSourcingConfigHead),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                oSourcingConfigHead = jQuery.parseJSON(data);
                if (oSourcingConfigHead.ErrorMessage=="" || oSourcingConfigHead.ErrorMessage==null)
                {
                    if(parseInt(nSourcingType) == 6)
                    {
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FabricTypeID = parseInt(oSourcingConfigHead.SourcingConfigHeadID);
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FabricTypeName = oSourcingConfigHead.SourcingConfigHeadName;
                        $("#txtFabricType").val(oSourcingConfigHead.SourcingConfigHeadName);
                        $("#txtFabricType").addClass("fontColorOfPickItem");
                        $("#txtGSMDetail").focus();
                    }
                    else if(parseInt(nSourcingType) == 2)
                    {
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').GSMID = parseInt(oSourcingConfigHead.SourcingConfigHeadID);
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').GSMName = oSourcingConfigHead.SourcingConfigHeadName;
                        $("#txtGSMDetail").val(oSourcingConfigHead.SourcingConfigHeadName);
                        $("#txtGSMDetail").addClass("fontColorOfPickItem");
                        $("#txtFinishDia").focus();
                    }
                    else
                    {
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FinishDiaID = parseInt(oSourcingConfigHead.SourcingConfigHeadID);
                        $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FinishDiaName = oSourcingConfigHead.SourcingConfigHeadName;
                        $("#txtFinishDia").val(oSourcingConfigHead.SourcingConfigHeadName);
                        $("#txtFinishDia").addClass("fontColorOfPickItem");
                        $("#txtConsumptionQty").select();
                    }
                }
                else
                {
                    alert(oSourcingConfigHead.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }


    function IntializePickerbutton(oPickerobj) {

        $("#" + oPickerobj.winid).find("#btnOk").click(function () {

            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn)
        {
            oreturnobjs = $('#'+oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if(oPickerobj.winid == 'winStyle')
        {
            if (oreturnObj != null && oreturnObj.TechnicalSheetID> 0)
            {
                $("#txtStyleNo").val(oreturnObj.StyleNo);
                $('#divKnitDyeingProgram').data('KnitDyeingProgram').TechnicalSheetID = parseInt(oreturnObj.TechnicalSheetID);
                $("#txtBuyerName").val(oreturnObj.BuyerName);
                $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = parseInt(oreturnObj.YarnCategoryID);
                $("#txtFabric").val(oreturnObj.FabricDescription);
                $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = parseInt(oreturnObj.MerchandiserID);
                $("#txtMarchandiser").val( oreturnObj.MerchandiserName);
                $('#divKnitDyeingProgram').data('KnitDyeingProgram').MUnitID = parseInt(oreturnObj.MeasurementUnitID);
                $("#txtGSM").val(oreturnObj.GSMName);
                $('#divKnitDyeingProgram').data('KnitDyeingProgram').GSMID = oreturnObj.GSMID;
                $("#txtMunit").val(oreturnObj.MUnitSymbol);
                $("#txtOrderQty").val(icsFormatPrice(oreturnObj.ApproxQty, null,2));
                DynamicRefreshList([], 'tblKnitDyeingProgramDetail');
                $("#txtStyleNo,#txtBuyerName,#txtFabric,#txtMarchandiser,#txtMunit,#txtGSM").addClass("fontColorOfPickItem");
                $('#txtShippingTollarance').focus();
            }
        }
        else if(oPickerobj.winid == 'winFabric')
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').FabricID = parseInt(oreturnObj.ProductID);
            $('#txtFabric').val(oreturnObj.ProductName);
            $("#txtFabric").addClass("fontColorOfPickItem");
            $('#txtShippingTollarance').focus();
        }
        else if(oPickerobj.winid == 'winGSM')
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').GSMID = parseInt(oreturnObj.SourcingConfigHeadID);
            $('#txtGSM').val(oreturnObj.SourcingConfigHeadName);
            $("#txtGSM").addClass("fontColorOfPickItem");
            $('#txtRemarks').focus();
        }
        else if(oPickerobj.winid == 'winMarchandiser')
        {
            $('#divKnitDyeingProgram').data('KnitDyeingProgram').MerchandiserID = parseInt(oreturnObj.EmployeeID);
            $('#txtMarchandiser').val(oreturnObj.Name);
            $("#txtMarchandiser").addClass("fontColorOfPickItem");
            $('#txtShippingTollarance').focus();
        }
        else if(oPickerobj.winid == 'winYarnRequisitionProduct')
        {
            $('#txtRequisitionYarnName').val(oreturnObj.ProductName);
            $('#txtRequisitionMUnit').val(oreturnObj.MUnit);
            $('#divYarnRequisition').data('RequisitionYarn', oreturnObj);
            $("#txtRequisitionYarnName").addClass("fontColorOfPickItem");
            $('#txtRatio').select();
        }
        else if(oPickerobj.winid == 'winComposition')
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').CompositionID = parseInt(oreturnObj.ProductID);
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').CompositionName = oreturnObj.ProductName;
            $('#txtComposition').val(oreturnObj.ProductName);
            $("#txtComposition").addClass("fontColorOfPickItem");
            $('#txtFabricType').focus();
        }
        else if(oPickerobj.winid == 'winFabricType')
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FabricTypeID = parseInt(oreturnObj.SourcingConfigHeadID);
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FabricTypeName = oreturnObj.SourcingConfigHeadName;
            $("#txtFabricType").val(oreturnObj.SourcingConfigHeadName);
            $("#txtFabricType").addClass("fontColorOfPickItem");
            var oKnitDyeingYarnConsumptions = $('#tblYarnConsumption').datagrid('getRows');
            if(oKnitDyeingYarnConsumptions != null && oKnitDyeingYarnConsumptions.length>0)
            {
                for(var i=0; i<oKnitDyeingYarnConsumptions.length; i++)
                {
                    oKnitDyeingYarnConsumptions[i].FabricTypeID = parseInt(oreturnObj.SourcingConfigHeadID);
                    oKnitDyeingYarnConsumptions[i].FabricTypeName = oreturnObj.SourcingConfigHeadName;
                }
                DynamicRefreshList(oKnitDyeingYarnConsumptions, 'tblYarnRequisition');
            }
            $("#txtGSMDetail").focus();
        }
        else if(oPickerobj.winid == 'winGSMDetail')
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').GSMID = parseInt(oreturnObj.SourcingConfigHeadID);
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').GSMName = oreturnObj.SourcingConfigHeadName;
            $("#txtGSMDetail").val(oreturnObj.SourcingConfigHeadName);
            $("#txtGSMDetail").addClass("fontColorOfPickItem");
            $("#txtFinishDia").focus();
        }
        else if(oPickerobj.winid == 'winFinishDia')
        {
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FinishDiaID = parseInt(oreturnObj.SourcingConfigHeadID);
            $("#winKnitDyeingProgramDetail").data('KnitDyeingProgramDetail').FinishDiaName = oreturnObj.SourcingConfigHeadName;
            $("#txtFinishDia").val(oreturnObj.SourcingConfigHeadName);
            $("#txtFinishDia").addClass("fontColorOfPickItem");
            $("#txtConsumptionQty").select();
        } 
        else if(oPickerobj.winid == 'winColor')
       {
            $('#divKnitDyeingProgram').data('Color',oreturnObj);  
            $('#txtColorName').val(oreturnObj.ColorName);
            $('#txtGarmentsQty').val(parseInt($('#cboRefType').val())==0?0:icsFormatPrice(oreturnObj.GarmentsQty, null,2));
            $("#txtColorName").addClass("fontColorOfPickItem");
            $('#txtColorName').focus();
            CalculateFabricQty();
       }
    }

    function YarnCompositionPicker()
    {

        var  oProductSearch = {
            BUID: BUID,
        };


        var obj = {
            BaseAddress: _sBaseAddress,
            Object: (oProductSearch) ,
            ControllerName: "KnitDyeingProgram",
            ActionName: "GetYarnProducts",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Product Code", width:200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width:150, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winComposition',
                        winclass: 'clsComposition',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblComposition',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            } else{
                alert("Data Not Found.");
                return;
            }
        });
    }

    var editIndex = undefined;    
    var _nProfitInPercentage=0;
    var _nProfitAmount=0;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblYarnConsumption').datagrid('validateRow', editIndex)) {
            $('#tblYarnConsumption').datagrid('endEdit', editIndex);
            $('#tblYarnConsumption').datagrid('selectRow', editIndex);
            var oYarnConsumption = $('#tblYarnConsumption').datagrid('getSelected');            
            if(_nProfitInPercentage != oYarnConsumption.UsagesParcent)
            {
                var nFabricQty = parseFloat(icsRemoveComma($('#txtFabricQty').val()));    
                var nQtyRatio = parseFloat(oYarnConsumption.UsagesParcent);  
                var nFinishReqQty = parseFloat((nQtyRatio/100))*parseFloat(nFabricQty);
                oYarnConsumption.FinishReqQty=nFinishReqQty;
            }
            else if(_nProfitAmount!=oYarnConsumption.FinishReqQty){
                var nFabricQty = parseFloat(icsRemoveComma($('#txtFabricQty').val()));   
                var nFinishReqQty=parseFloat(oYarnConsumption.FinishReqQty);
                var nQtyRatio=parseFloat((nFinishReqQty/nFabricQty))*100;
                oYarnConsumption.UsagesParcent=nQtyRatio;
            }
            $('#tblYarnConsumption').datagrid('updateRow', { index: editIndex, row: oYarnConsumption });

            RefreshTotalAmountConsumption();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblYarnConsumption').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oYarnConsumption= $('#tblYarnConsumption').datagrid('getSelected');
                debugger;
                _nProfitInPercentage=parseFloat(oYarnConsumption.UsagesParcent);
                _nProfitAmount=parseFloat(oYarnConsumption.FinishReqQty);
                editIndex = index;
            }
            else {
                $('#tblYarnConsumption').datagrid('selectRow', editIndex);
            }
        }
    }
</script>