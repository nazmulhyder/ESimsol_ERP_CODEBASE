<html>
@{
    ViewBag.Title = "Vehicle ReturnChallan Entry";
}
<body>
    @model ESimSol.BusinessObjects.VehicleReturnChallan
    <div class="menuMainCollectionTable" ng-app="VehicleReturnChallanApp" ng-controller="VehicleReturnChallanController as SODC" style="height:100%; width:100%; overflow:hidden" id="divVehicleReturnChallan">
        <div style="height:4%; overflow:hidden;" class="ui-grid-top-panel">
            <label style="">Vehicle ReturnChallan Entry</label>
        </div>
        <div style="font-family:Tahoma;text-align:center;height:84%;overflow:scroll" class="regionVR">
            <div class="col-md-12" style="height:28%">
                <fieldset style="height:120px;">
                    <legend>Sale Invoice Info:</legend>
                    <div class="col-md-12" style="padding-top:10px">
                        <div class="col-md-1 text-right">
                            <label class="control-label">Invoice No:</label>
                        </div>
                        <div class="col-md-2 text-left">
                            <input ng-model="VehicleReturnChallan.InvoiceNo" class="form-control" ng-keydown="SearchKeyDownInvoice($event)" placeholder="Type Inv.No & press Enter" ng-disabled="disabled" />
                        </div>
                        <div class="col-md-1" style="text-align:right;">
                            <label class="control-label">Invoice Date:</label>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group date date-container">
                                <input type="text" class="form-control" ng-model="VehicleReturnChallan.InvoiceDateST" disabled><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                            </div>
                        </div>
                        <div class="col-md-1 text-right">
                            <label class="control-label">SQ No:</label>
                        </div>
                        <div class="col-md-2">
                            <input ng-model="VehicleReturnChallan.SQNo" class="form-control" disabled />
                        </div>
                        <div class="col-md-1 text-right">
                            <label class="control-label">Model No:</label>
                        </div>
                        <div class="col-md-2">
                            <input ng-model="VehicleReturnChallan.ModelNo" class="form-control" disabled />
                        </div>

                    </div>
                  
                    <div class="col-md-12">
                        <div class="col-md-1 text-right">
                            <label class="control-label">Product:</label>
                        </div>
                        <div class="col-md-5 text-left">
                            <input ng-model="VehicleReturnChallan.ProductName" class="form-control input-group-sm"  disabled />
                        </div>
                        <div class="col-md-1 text-right">
                            <label class="control-label">Customer:</label>
                        </div>
                        <div class="col-md-5 text-left">
                            <input ng-model="VehicleReturnChallan.CustomerName" class="form-control" ng-keydown="SearchKeyDownCustomer($event)" placeholder="Type Name & Press Enter" ng-disabled="disabled" />
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="col-md-1 text-right">
                            <label class="control-label"> VIN:</label>
                        </div>
                        <div class="col-md-5 text-left">
                            <input ng-model="VehicleReturnChallan.ChassisNo" class="form-control input-group-sm" disabled />
                        </div>
                        <div class="col-md-1 text-right">
                            <label class="control-label">Engine No:</label>
                        </div>
                        <div class="col-md-5 text-left">
                            <input ng-model="VehicleReturnChallan.EngineNo" class="form-control input-group-sm" disabled />
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="col-md-12" style="height:38%">
                <fieldset>
                    <legend class="text-left">Financial Information :</legend>
                    <div class="col-md-12">
                        <div class="col-md-2 text-right" style="margin-left:-8%">
                            <label class="control-label">Currency :</label>
                        </div>
                        <div class="input-group col-md-4 text-left">
                            <input ng-model="VehicleReturnChallan.CurrencyName" class="form-control input-group-sm" style="height:25px; width:40%" disabled />
                           
                            <input ng-model="VehicleReturnChallan.CRate" class="form-control input-sm text-right number" style="height:25px; width:60%" placeholder="Convertion Rate" disabled />
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-2 text-right" style="margin-left:-8%">
                            <label class="control-label">OTR Amount:</label>
                        </div>
                        <div class="col-md-4 text-left">
                            <input ng-model="VehicleReturnChallan.OTRAmount | number:2" class="form-control input-sm text-right number" disabled style="height:25px" />
                        </div>
                        <div class="col-md-6 text-left">
                            <input ng-model="VehicleReturnChallan.OTRAmountInWord" class="form-control input-sm text-left" style="height:25px; width:124%" disabled />
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-2 text-right" style="margin-left:-8%">
                            <label class="control-label">Discount :</label>
                        </div>
                        <div class="col-md-4 text-left">
                            <input ng-model="VehicleReturnChallan.DiscountAmount" class="form-control input-sm text-right number" disabled style="height:25px" />
                        </div>
                        <div class="col-md-6 text-left">
                            <input ng-model="VehicleReturnChallan.DiscountAmountInWord" class="form-control input-sm text-left" style="height:25px; width:124%" disabled />
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-2 text-right" style="margin-left:-8%">
                            <label class="control-label">Sale Amount:</label>
                        </div>
                        <div class="col-md-4 text-left">
                            <input ng-model="VehicleReturnChallan.NetAmount | number:2" class="form-control input-sm text-right number" disabled style="height:25px" />
                        </div>
                        <div class="col-md-6 text-left">
                            <input ng-model="VehicleReturnChallan.NetAmountInWord" class="form-control input-sm text-left" style="height:25px; width:124%" disabled />
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-2 text-right" style="margin-left:-8%">
                            <label class="control-label">Advance :</label>
                        </div>
                        <div class="col-md-4 text-left">
                            <input ng-model="VehicleReturnChallan.AdvanceAmount | number:2" class="form-control input-sm text-right number" disabled style="height:25px" />
                        </div>
                        <div class="col-md-6 text-left">
                            <input ng-model="VehicleReturnChallan.AdvanceAmountInWord" class="form-control input-sm text-left" style="height:25px; width:124%" disabled />
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="col-md-12" style="height:10%">
                <fieldset>
                    <legend class="text-left">Return Challan Information :</legend>
                    <div class="col-md-12">
                        
                    </div>
                    <div class="col-md-12" style="padding-top:20px">
                        <div class="col-md-1 text-right">
                            <label class="control-label">Challan No:</label>
                        </div>
                        <div class="col-md-2">
                            <input ng-model="VehicleReturnChallan.ReturnChallanNo" class="form-control input-group-sm" disabled />
                        </div>
                       
                        <div class="col-md-1 text-right">
                            <label class="control-label">Challan Date:</label>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group date date-container">
                                <input type="text" class="form-control" ng-model="VehicleReturnChallan.ReturnChallanDateSt" ng-disabled="disabled"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                            </div>
                        </div>
                        <div class="col-md-1 text-right">
                            <label class="control-label" style="font-size:11px">Receive Store:</label>
                        </div>
                        <div class="col-md-5">
                            <select class="form-control" ng-model="VehicleReturnChallan.WorkingUnitID" ng-options="oItem.WorkingUnitID as oItem.OperationUnitName for oItem in ReceiveStores" ng-disabled="disabled">
                                <option value="">---Select Store---</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-1 text-right">
                            <label class="control-label" style="font-size:11px">Amount <span style="font-size:7px">(refund)</span>:</label>
                        </div>
                        <div class="form-inline col-md-5 text-left">
                            <input ng-model="VehicleReturnChallan.CurrencyName" class="form-control input-group-sm" style="height:25px; width:38%" disabled />

                            <input ng-model="VehicleReturnChallan.Refund_Amount" class="form-control text-right number" style="height:25px; width:61%" placeholder="Refund Amount" ng-disabled="disabled" />
                        </div>
                       
                        <div class="col-md-1 text-right">
                            <label class="control-label">Lot:</label>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group">
                                <input ng-model="VehicleReturnChallan.LotNo" class="form-control input-group-sm" ng-disabled="disabled" ng-keydown="SearchKeyDownLot($event)" placeholder="Type Lot No & Press Enter" required />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-sm" aria-label="left Align" ng-click="ClearLot()" ng-disabled="disabled" >
                                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                    </button>
                                    <span style="margin-left:0px;"></span>
                                    <button type="button" class="btn btn-sm" aria-label="left Align" ng-click="PickLot('')" ng-disabled="disabled">
                                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12" style="padding-bottom:15px">
                        <div class="col-md-1 text-right">
                            <label class="control-label">Remarks:</label>
                        </div>
                        <div class="col-md-11">
                            <input ng-model="VehicleReturnChallan.Note" class="form-control input-group-sm" ng-disabled="disabled" />
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
        <div class="row" style="width:100%; height:8%">
            <fieldset style="height:54px; margin:10px 0 0 20px" >
                <legend>Action</legend>
                <div class="row col-md-12 text-right">
                    <button type="button" class="btn btn-success btn-xs" aria-label="Left Align" ng-hide="btnSave" ng-click="Save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> <label id="lblSave">Save</label></span> </button>
                    <button type="button" id="btnclose" class="btn btn-danger btn-xs" aria-label="Left Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
                </div>
            </fieldset>
        </div>
   </div>
</body>
</html>
<style type="text/css">
    .regionVR .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionVR .form-control {
        height: 24px;
        padding: 0px 6px;
        font-size: 12px;
    }
    .regionVR regionVROT .form-control {
        height: 10px;
        padding: 0px 6px;
        font-size: 12px;
    }
    .regionVR .col-md-12 {
        width: 100%;
        padding-right: 2px;
        padding-left: 1px;
        margin-bottom: 3px;
    }
    .regionVR .col-md-11 {
        width: 91%;
        padding-right: 2px;
        padding-left: 1px;
        margin-bottom: 3px;
    }
     .regionVR .col-md-10 {
        width: 84%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 3px;
    }
    .regionVR .col-md-7 {
        width: 58.33%;
        padding-right: 5px;
        padding-left: 5px;
    }
    .regionVR .col-md-2 {
        width: 16%;
        padding-right: 2px;
        padding-left: 2px;
    }
    .regionVR .col-md-1 {
        width: 8.8%;
        padding-right: 2px;
        padding-left: 2px;
    }
     .regionVR .col-md-4 {
        width: 30%;
        padding-right: 5px;
        padding-left: 5px;
    }
    
    .regionVR .col-md-6 {
        width: 50%;
        padding-right: 5px;
        padding-left: 5px;
    }
 
    .regionVR .col-md-5 {
        width: 41%;
        padding-right: 2px;
        padding-left: 2px;
    }
     .regionVR .col-md-3 {
        width: 25%;
        padding-right:3px;
        padding-left:3px;
    }
     
    .regionVR .btn-sm {
        padding: 2px 8px;
    }

    .regionVR .input-group-addon {
        padding: 2px 5px;
    }
    /*.ui-grid-top-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    } 
    .ui-grid-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    }*/
</style>
<script type="text/javascript">

    var oVehicleReturnChallan =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oReceiveStores = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WorkingUnits));
  
    var VehicleReturnChallanApp = angular.module('VehicleReturnChallanApp', ['ngAnimate', 'ui.bootstrap','ui.grid', 'ui.grid.selection', 'ui.grid.edit', 'ms.service']);
    VehicleReturnChallanApp.controller('VehicleReturnChallanController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod,msGridControl) {
        debugger;
       
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });

        if(sessionStorage.getItem("SaleInvoiceReturnChallan")!=undefined && sessionStorage.getItem("SaleInvoiceReturnChallan")!=null &&   sessionStorage.getItem("SaleInvoiceReturnChallan")!="")
        {
            oVehicleReturnChallan=JSON.parse(sessionStorage.getItem("SaleInvoiceReturnChallan"));
        }

        $scope.ReceiveStores=oReceiveStores;
        $scope.VehicleReturnChallan=oVehicleReturnChallan;
        $scope.VehicleReturnChallan.BUID=sessionStorage.getItem('BUID');
       
        debugger;
        if(sessionStorage.getItem("VehicleReturnChallanHeader")=="View Vehicle ReturnChallan")
        {
            $scope.btnSave=true; $scope.disabled=true;
        }

        $scope.SetNetAmount=function (nSet)
        {
            debugger;

            var nCRate= ($scope.VehicleReturnChallan.CRate<=0? 1 : $scope.VehicleReturnChallan.CRate);

            $scope.VehicleReturnChallan.OTRAmountInWord= TakaWords(parseFloat($scope.VehicleReturnChallan.OTRAmount*nCRate));
            $scope.VehicleReturnChallan.DiscountAmountInWord= TakaWords(parseFloat($scope.VehicleReturnChallan.DiscountAmount*nCRate));
            $scope.VehicleReturnChallan.NetAmount =  parseFloat($scope.VehicleReturnChallan.OTRAmount)-parseFloat($scope.VehicleReturnChallan.DiscountAmount);
            $scope.VehicleReturnChallan.NetAmountInWord= TakaWords(parseFloat($scope.VehicleReturnChallan.NetAmount*nCRate));
            $scope.VehicleReturnChallan.AdvanceAmountInWord= TakaWords(parseFloat($scope.VehicleReturnChallan.AdvanceAmount*nCRate));
        }
        $scope.SetNetAmount(0);
       
        $scope.SearchKeyDownCustomer = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var CustomerName = $.trim($scope.VehicleReturnChallan.CustomerName);
                if (CustomerName == "" || CustomerName == null) {
                    alert("Please Type Invoice No and Press Enter!");
                    return;
                }

                var oSInvoice={
                    CustomerName: CustomerName
                };

                $scope.PickInvoice(oSInvoice);
            } else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleReturnChallan={};
            }
        };
        $scope.SearchKeyDownInvoice = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var InvoiceNo = $.trim($scope.VehicleReturnChallan.InvoiceNo);
                if (InvoiceNo == "" || InvoiceNo == null) {
                    alert("Please Type Invoice No and Press Enter!");
                    return;
                }

                var oSInvoice={
                    InvoiceNo: InvoiceNo
                };

                $scope.PickInvoice(oSInvoice);
            } else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleReturnChallan={};
            }
        };
        $scope.PickInvoice = function (oInvocie) {
            debugger;

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/VehicleReturnChallan/GetsInvoice', $.param(oInvocie), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    var oColumn= { field: 'InvoiceDateST', name: 'Invoice Date', width: '15%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn= { field: 'InvoiceNo', name: 'Invoice No', width: '15%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn= { field: 'NetAmount', name: 'SaleAmount', width: '15%', enableSorting: false, cellClass:'text-right', cellFilter:'number' }; oColumns.push(oColumn);
                                    oColumn = { field: 'ProductName', name: 'ProductName', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'CustomerName', name: 'CustomerName', width: '25%', enableSorting: false }; oColumns.push(oColumn);
                                    
                                    var results = JSON.parse(response.data);

                                    if(results.length==0)
                                    {
                                        alert("No Data Found!"); return;
                                    }
                                    else if(results[0].ErrorMessage!=null)// || results[0].ErrorMessage!="")
                                    {
                                        alert(results[0].ErrorMessage); return;
                                    }

                                    var modalObj = {
                                        size: 'lg',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'VehicleReturnChallanController',
                                        objs: results,
                                        multiSelect: false,
                                        pickertitle: 'Invoice List',
                                        searchingbyfieldNo: 'InvoiceNo',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        $scope.VehicleReturnChallan = result
                                        $scope.SetNetAmount(0);
                                        //$scope.VehicleReturnChallan.LotNo = result.LotNo;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(response.statusText); }
                            );
        };
       
        $scope.SearchKeyDownLot = function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var LotNo = $.trim($scope.VehicleReturnChallan.LotNo);
                if (LotNo == "" || LotNo == null) {
                    alert("Type Lot No and Press Enter");
                    return;
                }
                $scope.PickLot(LotNo);
            } else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.VehicleReturnChallan.LotNo = '';
                $scope.VehicleReturnChallan.Lot = 0;
            }
        };
        $scope.PickLot = function (LotNo) {
            debugger;

            if($scope.VehicleReturnChallan.ProductID<=0)
            {
                alert("Invalid Product in Sale Invoice!");return;
            }
            
            if($scope.VehicleReturnChallan.WorkingUnitID<=0)
            {
                alert("Please Select Issue Store And Try Again!");return;
            }

            var oLot = {
                ProductID:$scope.VehicleReturnChallan.ProductID,
                WorkingUnitID: $scope.VehicleReturnChallan.WorkingUnitID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress') + '/VehicleReturnChallan/GetLots', $.param(oLot), config).then(
                                function (response) {
                                    debugger;
                                    var oColumns = [];
                                    var oColumn= { field: 'LotNo', name: 'Lot No', width: '50%', enableSorting: false }; oColumns.push(oColumn);
                                    oColumn = { field: 'Balance', name: 'Balance', width: '30%', enableSorting: false }; oColumns.push(oColumn);
                                    var results = JSON.parse(response.data);

                                    if(results.length==0)
                                    {
                                        alert("No Data Found!"); return;
                                    }else if(results[0].ErrorMessage!=""){
                                        alert(results[0].ErrorMessage); return;
                                    }

                                    var modalObj = {
                                        size: 'md',
                                        modalcontroller: 'ModalCc',
                                        appcontroller: 'VehicleReturnChallanController',
                                        objs: results,
                                        multiSelect: false,
                                        pickertitle: 'Lot List',
                                        searchingbyfieldNo: 'LotNo',
                                        columns: oColumns
                                    }
                                    var modalInstance = msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result) {
                                        debugger;
                                        $scope.VehicleReturnChallan.LotID = result.LotID;
                                        $scope.VehicleReturnChallan.LotNo = result.LotNo;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(response.statusText); }
                            );
        };
        $scope.ClearLot = function () {
            debugger;
            $scope.VehicleReturnChallan.LotNo = "";
            $scope.VehicleReturnChallan.LotID = 0;
        };

        $scope.Save = function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oVehicleReturnChallan= $scope.VehicleReturnChallan;
            oVehicleReturnChallan.ReturnChallanDate = new Date($scope.VehicleReturnChallan.ReturnChallanDateSt);
            oVehicleReturnChallan.OrderStatusInt = 1;//intialize
           
            debugger;
            $http.post(sessionStorage.getItem('BaseAddress')+'/VehicleReturnChallan/Save',oVehicleReturnChallan).then(
                        function (response)
                        {
                            var oVehicleReturnChallan= jQuery.parseJSON(response.data);
                            if (oVehicleReturnChallan.ErrorMessage=="" || oVehicleReturnChallan.ErrorMessage==null)
                            {
                                debugger;
                                alert("Data Saved Successfully!!");
                                userSession.setData('VehicleReturnChallanList',oVehicleReturnChallan);
                                userSession.previousPage();
                                window.location.href = sessionStorage.getItem("BackLink");
                            }
                            else
                            {
                                alert(oVehicleReturnChallan.ErrorMessage);
                            }

                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);$scope.MeasurementUnits=[];}
                    );

        };
        $scope.ValidateInput =  function ()
        {
            debugger;
            if($scope.VehicleReturnChallan.SaleInvoiceID ==undefined || $scope.VehicleReturnChallan.SaleInvoiceID==0)
            {
                alert('Please Pick an Invoice And Try Again.');
                return false;
            }
            if($scope.VehicleReturnChallan.ProductID ==undefined || $scope.VehicleReturnChallan.ProductID==0)
            {
                alert('Your selected product is invalid !');
                return false;
            }
            if($scope.VehicleReturnChallan.Refund_Amount ==undefined ||parseFloat($scope.VehicleReturnChallan.Refund_Amount) <=0)
            {
                alert('Please enter refund amount !');
                return false;
            }
            if(parseFloat($scope.VehicleReturnChallan.Refund_Amount) > parseFloat($scope.VehicleReturnChallan.NetAmount))
            {
                alert('Refund amount can not be greater than sale amount !');
                return false;
            }
            if($scope.VehicleReturnChallan.LotID==0)
            {
                alert('Please Pick a Lot And Try Again.');
                return false;
            }

            //if($scope.gridOptionsVehicleReturnChallanDetail.data.length <=0){alert("Please Add Vechicle Order Detail");  return false;}

            return true;
        };

        $scope.Close=function ()
        {
            debugger;
            window.location.href = sessionStorage.getItem("BackLink");
        };
    });

</script>