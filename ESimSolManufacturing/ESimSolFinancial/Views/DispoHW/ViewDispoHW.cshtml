@{
    ViewBag.Title = "Dispo HW List";
}
@model IEnumerable<ESimSol.BusinessObjects.DispoHW>

<body id="mainDiv">
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>

    <div id="winFabricBeamFinish" class="easyui-window winstyle" title="Fabric Beam Complete" style="width:900px; height:600px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma"> 
            <table border="0" cellpadding="0" cellspacing="0">
                <tr >
                    <td style="width:900px">
                        <table border="0" cellpadding="2" cellspacing="2" style="font-size:12px">
                            <tr style="">
                                <td style="width:900px;" >
                                    <fieldset style="height:480px;">
                                        <legend style="font-weight:bold; font-size:12px"> Info : </legend>
                                        <table border="0" cellpadding="2" cellspacing="2" style=" width:820px; font-size:12px">

                                            <tr style=" width:820px;vertical-align:top;">
                                                <td style="width:90px;float:right;">
                                                    <label>Order No :</label>
                                                </td>
                                                <td style="width:200px;">
                                                    <input type="text" id="txtOrderNo" style="width:100%" disabled />
                                                </td>
                                                <td style="width:5px;"> </td>
                                                <td style="width:125px;float:right;">
                                                    <label>Buyer :</label>
                                                </td>
                                                <td style="width:200px;">
                                                    <input type="text" id="txtBuyer" style="width:100%" disabled />
                                                </td>
                                            </tr>

                                            <tr style=" width:820px;vertical-align:top;">
                                                <td style="width:90px;float:right;">
                                                    <label>Competition :</label>
                                                </td>
                                                <td style="width:200px;">
                                                    <input type="text" id="txtProduct" style="width:100%" disabled />
                                                </td>
                                                <td style="width:5px;"> </td>
                                                <td style="width:125px;float:right;">
                                                    <label>Req. Warp Length :</label>
                                                </td>
                                                <td style="width:200px;">
                                                    <input type="text" id="txtWarpLangth" style="width:100%" disabled />
                                                </td>
                                                
                                            </tr>

                                            <tr style=" width:820px;vertical-align:top;">
                                                <td colspan="5" style="width:100%;height:185px;">
                                                    <table id="tblTempDispoHWs" title="" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" showfooter="true" > @*toolbar="#toolbar3"*@
                                                        <thead>
                                                            <tr>
                                                                <th field="ColorName" width="20%">Color</th>
                                                                <th field="QtyWarp" align="right" formatter="formatPrice" width="12%">Warp Req.</th>
                                                                <th field="QtyDyeing" align="right" formatter="formatPrice" width="12%">Dyeing Kg</th>
                                                                <th field="WarpKg" align="right" formatter="formatPrice" width="12%">Warp Kg</th>
                                                                <th field="WarpTF" align="right" formatter="formatPrice" width="10%">Warp T/F</th>
                                                                <th field="WeftTF" align="right" formatter="formatPrice" width="10%">Weft T/F</th>
                                                                <th field="TotalTFKg" align="right" formatter="formatPrice" width="10%">Total T/F</th>
                                                                <th field="DueTFKg" align="right" formatter="formatPrice" width="10%">Due T/F</th>
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                    @*<div id="toolbar3">
                                                        Suggested : <input type="text" id="txtSuggestedLength" style="width:100px;text-align:right" disabled />
                                                    </div>*@
                                                </td>
                                            </tr>

                                            <tr style=" width:820px;vertical-align:top;">
                                                <td colspan="5" style="width:100%;height:185px;">
                                                    <table id="tblBeamFinish" title="" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar2">
                                                        <thead>
                                                            <tr>
                                                                <th field="ReadyDateInString" width="12%">Ready Date</th>
                                                                <th field="BeamNo" width="13%">BeamNo</th>
                                                                <th field="LengthFinish" align="right" formatter="formatPrice" width="10%">Length Finish</th>
                                                                <th field="IsFinishInString" width="10%">Is Finish</th>
                                                                <th field="Note" width="50%">Note</th>
                                                                
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                    <div id="toolbar2">
                                                        Ready Date : <input id="txtReadyDate" type="text" style="width: 100px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                                        Suggested : <input type="text" id="txtSuggestedLength" style="width:80px;text-align:right" disabled />   
                                                        Length Finish(M) : <input type="text" id="txtLengthFinish" style="width:80px;text-align:right"  />                                                                                                             
                                                        Beam No : <input type="text" id="txtBeam" style="width:100px"  />
                                                        <br />
                                                        Note : <input type="text" id="txtNote" style="width:210px"  />                                                        
                                                        @*Is Finish : <input type="checkbox" id="chkIsFinish" />*@   
                                                        &nbsp;                                                     
                                                        <a id="btnAddBeam" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                                                        <a id="btnDeleteBeam" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                                                    </div>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="5" style="width:100%;">
                                                    <table>
                                                        <tr>
                                                            <td style="width:115px;"></td>
                                                            <td >Total : </td>
                                                            <td><input type="text" id="txtTotalLengthFinish" style="width:100px;text-align:right;" disabled /></td>
                                                            <td style="width:5px;"></td>
                                                            <td>Remaining Length : </td>
                                                            <td><input type="text" id="txtRemainingLength" style="width:100px;text-align:right;" disabled /></td>
                                                            <td style="width:5px;"></td>
                                                            <td>T/F Length : </td>
                                                            <td><input type="text" id="txtTFLength" style="width:80px;text-align:right;" disabled /></td>
                                                            <td style="width:5px;"></td>
                                                            <td>Pending Transfer : </td>
                                                            <td><input type="text" id="txtPendingTransfer" style="width:80px;text-align:right;" disabled /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>


                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                            
                            <tr style="height:25px">
                                <td style="width:900px">
                                    <fieldset>
                                        <legend style="font-weight:bold; font-size:12px"> Action : </legend>
                                        <table border="0" cellpadding="0" cellspacing="0" style=" width:820px; font-size:12px">
                                            <tr style="height:22px; vertical-align:bottom">
                                                <td colspan="2" style="text-align:right">
                                                    @*<a id="btnSaveForFabricBeamFinish" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Save</a>*@
                                                    <a id="btnCloseForFabricBeamFinish" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="menuMainCollectionTable" id="regionDispoHW">
        <table id="tblDispoHWs" title="Dispo HW List" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar" showfooter="true">
            @*data-options="onLoadSuccess: onLoadSuccess"*@
            <thead>
                <tr>
                    <th field="ExeNo" width="8%">Order No</th>
                    <th field="ReceiveDateInString" width="12%">Receive Date</th>
                    <th field="WarpLangth" align="right" formatter="formatPrice" width="8%">Warp Langth</th>
                    <th field="CompLangth" align="right" formatter="formatPrice" width="8%">Comp Langth</th>
                    <th field="TFLangth" align="right" formatter="formatPrice" width="8%">TF Length</th>
                    <th field="TFLangthDue" align="right" formatter="formatPrice" width="8%">Due Langth</th>
                    <th field="ContractorName" width="12%">Contractor</th>
                    <th field="ProductName" width="9%">Product</th>
                    <th field="ColorName" width="9%">Color</th>
                    <th field="QtyWarp" align="right" formatter="formatPrice" width="8%">Warp Req.</th>
                    <th field="QtyWeft" align="right" formatter="formatPrice" width="8%">Weft Req.</th>
                    <th field="QtyTotal" align="right" formatter="formatPrice" width="8%">Total Req.</th>
                    <th field="QtyGREY" align="right" formatter="formatPrice" width="8%">GREY Req</th>
                    <th field="QtyDyeing" align="right" formatter="formatPrice" width="8%">Dyeing Kg</th>
                    <th field="QtyPCS" align="right" formatter="formatPrice" width="8%">Dyeing PCS</th>
                    <th field="WarpTF" align="right" formatter="formatPrice" width="8%">Warp T/F</th>
                    <th field="WeftTF" align="right" formatter="formatPrice" width="8%">Weft T/F</th>
                    <th field="TotalTFKg" align="right" formatter="formatPrice" width="8%">Total T/F</th>
                    <th field="LossQty" align="right" formatter="formatPrice" width="8%">Loss Qty</th>
                    <th field="LossP" align="right" formatter="formatPrice" width="8%">Loss %</th>
                    <th field="ExeDateInString" width="12%">Exe Date</th>
                    @*<th field="BeamNo" width="8%">Beam No</th>
                    <th field="BuyerName" width="12%">Buyer</th>*@

                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <input type="text" id="txtExeNo" placeholder="Type Dispo No & Press Enter" style="width: 160px;" />
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
            <a id="btnAddFabricBeamFinish" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Beam Finish</a>
            <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview(Dispo)</a>
            <a id="btnPreviewStatement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Statement</a>
        </div>
    </div>
    <div id="winAdvanceSearchPicker" class="easyui-window winstyle" title="Advance Search Picker" style="width:480px; height:350px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="font-family:Tahoma">
            @*<table border="0" style="background-color:#CFB53B">
                    <tr>
                        <td style="background-color:#CFB53B; text-align:center; width:460px; color:White">
                            <label id="lblHeaderName" style="font-size:15px; font-weight:bold; text-decoration:Underline"> Search Knitting Order</label>
                        </td>
                    </tr>
                </table>*@
            <table border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td style="width:480px">
                        <table border="0" cellpadding="2" cellspacing="2" style="font-size:12px">
                            <tr style="">
                                <td style="width:480px;">
                                    <fieldset style="height:240px;">
                                        <legend style="font-weight:bold; font-size:12px"> Searching Criteria : </legend>
                                        <table border="0" cellpadding="2" cellspacing="2" style=" width:400px; font-size:12px">

                                            <tr style=" width:400px;vertical-align:top;">
                                                <td style="width:110px;float:right;">
                                                    <label>Dispo No :</label>
                                                </td>
                                                <td style=" width:290px;">
                                                    <input type="text" id="txtDispoNo" style="width:100%" />
                                                </td>
                                            </tr>
                                            <tr style=" width:400px;vertical-align:top;">
                                                <td style="width:110px;float:right;">
                                                    <label>Received Date :</label>
                                                </td>
                                                <td>
                                                    <table>
                                                        <tr>
                                                            <td style=" width:86px;"><select id="cboReceived" style=" width:86px;height:22px;" onchange="DateActionsReceived();"></select> </td>
                                                            <td style="width: 99px;"><input id="txtReceivedDateStart" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                            <td style="width: 6px;text-align:center"><label id="lblTo">To</label></td>
                                                            <td style="width: 99px;"><input id="txtReceivedDateEnd" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>

                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <tr style=" width:400px;vertical-align:top;">
                                                <td style="width:110px;float:right;">
                                                    <label>Ready  Date :</label>
                                                </td>
                                                <td>
                                                    <table>
                                                        <tr>
                                                            <td style=" width:86px;"><select id="cboReadyDate" style=" width:86px;height:22px;" onchange="DateActionsReadyDate();"></select> </td>
                                                            <td style="width: 99px;"><input id="txtReadyDateStart" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                            <td style="width: 6px;text-align:center"><label id="lblTo">To</label></td>
                                                            <td style="width: 99px;"><input id="txtReadyDateEnd" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>

                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>

                                            <tr style=" width:400px;vertical-align:top;">
                                                <td style="width:110px;float:right;">
                                                    <label>Dispo Date :</label>
                                                </td>
                                                <td>
                                                    <table>
                                                        <tr>
                                                            <td style=" width:86px;"><select id="cboDispoDate" style=" width:86px;height:22px;" onchange="DateActionsDispoDate();"></select> </td>
                                                            <td style="width: 99px;"><input id="txtDispoDateStart" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                            <td style="width: 6px;text-align:center"><label id="lblTo">To</label></td>
                                                            <td style="width: 99px;"><input id="txtDispoDateEnd" type="text" style="width: 99px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>

                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>

                                            

                                            <tr style=" width:400px;">
                                                <td style=" width:110px;float:right;">
                                                    <label>Buyer Name :</label>
                                                </td>
                                                <td style=" width:290px;">
                                                    <table style=" width:100%;">
                                                        <tr style=" width:100%;">
                                                            <td style=" width:78%;"><input type="text" style=" width:100%;" id="txtBuyerName" onkeydown="BuyerKeyDown(event);" /> </td>
                                                            <td style="width: 20%;"><input type="button" id="btnBuyer" onclick="PickBuyer()" style="width:100%;float:right;" value="Pick" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>

                                            <tr style=" width:400px;">
                                                <td style=" width:110px;float:right;">
                                                    <label>Customer Name :</label>
                                                </td>
                                                <td style=" width:260px;">
                                                    <table style=" width:100%;">
                                                        <tr style=" width:100%;">
                                                            <td style=" width:78%;"><input type="text" style=" width:100%;" id="txtCustomerName" onkeydown="CustomerKeyDown(event);" /> </td>
                                                            <td style="width: 20%;"><input type="button" id="btnCustomer" onclick="PickCustomer()" style="width:100%;float:right;" value="Pick" /></td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>

                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr style="height:35px">
                                <td style="width:480px">
                                    <fieldset>
                                        <legend style="font-weight:bold; font-size:12px"> Action : </legend>
                                        <table border="0" cellpadding="0" cellspacing="0" style=" width:400px; font-size:12px">
                                            <tr style="height:30px; vertical-align:bottom">
                                                <td style="">
                                                    <label id="lvlMsg" style="color:red;font-size:15px;">Loading... Please Wait</label>
                                                </td>
                                                <td style="text-align:right;">
                                                    <a id="btnRefreshForAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                                                    <a id="btnCloseForAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>

    <script type="text/javascript">
    debugger;
    var _oDispoHW=null;
    var _oDispoHWs=[];
    var _sBaseAddress="";
    //var _oAuthorizationRolesMapping=[];
    var _oCompareOperators = [];
    $(document).ready(function () {
        debugger;
        _oDispoHWs =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        @*_oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));*@
        _oCompareOperators =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        var nBUID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        sessionStorage.setItem('BUID', nBUID);
        var oDispoHWs =sessionStorage.getItem("DispoHWs");
        if(oDispoHWs!=null)
        {
            oDispoHWs = jQuery.parseJSON(oDispoHWs);
        }
        else
        {
            oDispoHWs=_oDispoHWs;
        }
        $('#mainDiv').data('CellRowSpan',[]);
        RefreshList(oDispoHWs);
        //RefreshControlLayout();
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();

        LoadAdvSearchCombos();

        $("#lvlMsg").hide();
        
        $.icsMakeFooterColumn('tblDispoHWs',['ExeNo','WarpLangth','CompLangth','TFLangth','TFLangthDue','QtyWarp','QtyWeft','QtyTotal','QtyGREY','QtyDyeing','QtyPCS','WarpTF','WeftTF','TotalTFKg','LossQty','LossP']);
    });

    function LoadAdvSearchCombos(){
        $("#cboDispoDate,#cboReadyDate,#cboReceived").icsLoadCombo({List:_oCompareOperators,OptionValue: "id",DisplayText: "Value",});

        }

    function ResetAdvSearchWindow() {
        _sContractorIds = '';
        $("#winAdvSearch input").not("input[type='button']").val("");
        $("#winAdvSearch input").removeClass("fontColorOfPickItem");
        $("#winAdvSearch select").val(0);
        DateActionsDispoDate();
        DateActionsReadyDate();
        DateActionsReceived();

        $('#txtReceivedDateStart').datebox({ disabled : true });
        $('#txtReceivedDateEnd').datebox({ disabled : true });

        $('#txtDispoDateStart').datebox({ disabled : true });
        $('#txtDispoDateEnd').datebox({ disabled : true });
        $('#txtDispoDateStart').datebox('setValue',icsdateformat(new Date()));
        $('#txtDispoDateEnd').datebox('setValue',icsdateformat(new Date()));
        $('#txtReadyDateStart').datebox({ disabled : true });
        $('#txtReadyDateEnd').datebox({ disabled : true });
        $('#txtReadyDateStart').datebox('setValue',icsdateformat(new Date()));
        $('#txtReadyDateEnd').datebox('setValue',icsdateformat(new Date()));
        $("#winAdvanceSearchPicker").data("CustomerIDs","");
        $("#winAdvanceSearchPicker").data("BuyerIDs","");
        $("#lvlMsg").hide();
        
    }
    function DateActionsDispoDate() {
        DynamicDateActions("cboDispoDate", "txtDispoDateStart", "txtDispoDateEnd");
    }
    function DateActionsReadyDate() {
        DynamicDateActions("cboReadyDate", "txtReadyDateStart", "txtReadyDateEnd");
    }
    function DateActionsReceived() {
        DynamicDateActions("cboReceived", "txtReceivedDateStart", "txtReceivedDateEnd");
    }

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    function RefreshList(oDispoHWs)
    {
        debugger;
        var data=oDispoHWs;
        data={"total":""+data.length+"","rows":data};
        $('#tblDispoHWs').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        $('#tblDispoHWs').datagrid('selectRow',nIndex);
    }

    $('#btnPreview').click(function(){
        var oDispoHW=$('#tblDispoHWs').datagrid('getSelected');
        if(oDispoHW==null || parseInt(oDispoHW.FEOSID)<=0)
        {
            alert("Select At least One item !");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress + '/FabricExecutionOrderSpecification/PrintFabricSpecification?nId=' +oDispoHW.FEOSID + "&nts=" + nts, "_blank");
    });

    $('#btnPreviewStatement').click(function(){
        var oDispoHW=$('#tblDispoHWs').datagrid('getSelected');
        if(oDispoHW==null || parseInt(oDispoHW.FEOSID)<=0)
        {
            alert("Select At least One item !");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress+ "/RPT_Dispo/Print_HWStatement?nID="+oDispoHW.FEOSID+"&nBUID="+sessionStorage.getItem('BUID'), "_blank");
    });

    $('#txtExeNo').keypress(function (e)
    {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) {
            var txtExeNo = document.getElementById('txtExeNo').value;
            if(txtExeNo==""){
                alert("Please enter Dispo No!!!");
                return false;
            }
            else{
                var sTempString = txtExeNo+'~'+ 0 + '~' + icsdateformat(new Date()) +'~'+ icsdateformat(new Date()) + '~' + 0 + '~' + icsdateformat(new Date()) +'~'+ icsdateformat(new Date()) + '~' +""+ '~'+""+ '~' +  0 + '~' + icsdateformat(new Date()) +'~'+ icsdateformat(new Date()) ;
                var oDispoHW = {
                    ErrorMessage: sTempString
                }

                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+  "/DispoHW/GetsData",
                    traditional: true,
                    data:  JSON.stringify(oDispoHW),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;
                        //var oDispoHWs = jQuery.parseJSON(data);
                        var result = data;
                        if(result.length<=0){
                            alert("No data found");
                        }
                        else{
                            //$('#mainDiv').data('CellRowSpan',result.Item2);
                            DynamicRefreshList(result, "tblDispoHWs");
                            $.icsMakeFooterColumn('tblDispoHWs',['ExeNo','WarpLangth','CompLangth','TFLangth','TFLangthDue','QtyWarp','QtyWeft','QtyTotal','QtyGREY','QtyDyeing','QtyPCS','WarpTF','WeftTF','TotalTFKg','LossQty','LossP']);
                            $("#winAdvanceSearchPicker").icsWindow('close');
                        }
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                    }
                });

            }
        }

    });

    function onLoadSuccess(data)
    {
        var oCellRowSpans=$('#mainDiv').data('CellRowSpan');
        if(oCellRowSpans.length > 0){
            var nIndex=0;
            var nSpan=0;
            for(var i=0;i<oCellRowSpans.length;i++){
                var oMCell=[oCellRowSpans[i].mergerCell];
                nIndex=oMCell[0][0];
                nSpan= oMCell[0][1];
                if(oCellRowSpans[i].FieldName=="Span"){
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'ExeNo', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'ReceiveDateInString', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'WarpLangth', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'CompLangth', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'TFLangth', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'TFLangthDue', rowspan: nSpan});
                    $(this).datagrid('mergeCells',{index: nIndex, field: 'ContractorName', rowspan: nSpan});
            
                }
            }
        }
        
    }

    //start adv search
    $('#btnCloseForAdvSearch').click(function(e) {
        $("#winAdvanceSearchPicker").icsWindow('close');
    });

    $("#btnAdvSearch").click(function(){
        ResetAdvSearchWindow();
        $("#winAdvanceSearchPicker").icsWindow('open', "Advance Search");
    });

    $('#btnRefreshForAdvSearch').click(function(){
        debugger;
        var sDispoNo = $("#txtDispoNo").val();

        var nDispoDate = parseInt($("#cboDispoDate").val());
        var dDispoDateStart = $('#txtDispoDateStart').datebox('getValue');
        var dDispoDateEnd = $('#txtDispoDateEnd').datebox('getValue');

        var nReadyDate = parseInt($("#cboReadyDate").val());
        var dReadyDateStart = $('#txtReadyDateStart').datebox('getValue');
        var dReadyDateEnd = $('#txtReadyDateEnd').datebox('getValue');

        var sBuyerIDs = $("#winAdvanceSearchPicker").data("BuyerIDs");
        var sCustomerIDs = $("#winAdvanceSearchPicker").data("CustomerIDs");

        var nReceived = parseInt($("#cboReceived").val());
        var dReceivedDateStart = $('#txtReceivedDateStart').datebox('getValue');
        var dReceivedDateEnd = $('#txtReceivedDateEnd').datebox('getValue')


        if(sDispoNo == "" && nDispoDate <= 0 && nReadyDate <= 0 && sBuyerIDs == "" && sCustomerIDs == "" && nReceived<=0){
            alert("Please enter Atleast one searching criteria!!!");
            return false;
        }

        var sTempString = sDispoNo+'~'+nDispoDate + '~' + dDispoDateStart+'~'+dDispoDateEnd + '~' + nReadyDate+ '~' + dReadyDateStart+'~'+dReadyDateEnd + '~' + sBuyerIDs + '~' + sCustomerIDs+ '~' + nReceived+ '~' + dReceivedDateStart+'~'+dReceivedDateEnd;

        var oDispoHW = {
            ErrorMessage: sTempString
        }
        $("#lvlMsg").show();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DispoHW/GetsData",
            traditional: true,
            data:  JSON.stringify(oDispoHW),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                //var oDispoHWs = jQuery.parseJSON(data);
                var result = data;
                if(result.length<=0){
                    alert("No data found");
                    $("#lvlMsg").hide();
                }
                else{
                    //$('#mainDiv').data('CellRowSpan',result.Item2);

                    DynamicRefreshList(result, "tblDispoHWs");
                    $("#lvlMsg").hide();
                    $.icsMakeFooterColumn('tblDispoHWs',['ExeNo','WarpLangth','CompLangth','TFLangth','TFLangthDue','QtyWarp','QtyWeft','QtyTotal','QtyGREY','QtyDyeing','QtyPCS','WarpTF','WeftTF','TotalTFKg','LossQty','LossP']);
                    $("#winAdvanceSearchPicker").icsWindow('close');
                }

            },
            error: function (xhr, status, error) {
                alert(error);
                $("#lvlMsg").hide();
            }
        });

    });

    //start buyer picker
    function BuyerKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtBuyerName").val();
            if (oTxtName != null) {
                PickBuyer(oTxtName);
            }
        }
        if (event.which == 8) //backspace=8
        {
            //debugger;
            txtBuyerName.style.color = "black";
            txtBuyerName.style.fontWeight = "normal";
            $("#winAdvanceSearchPicker").data("BuyerIDs","");

        }
    }
    function PickBuyer(oTxtName)
    {
        var oStyleSearch = { Params: 2 + '~' + (typeof(oTxtName) != 'undefined'?oTxtName:"") };
        console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('Buyer',obj,tblColums,true,'Name','ContractorID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }
    function SetBuyer(oSelectedStyle) {
        debugger;
        txtBuyerName.style.color = "green";
        txtBuyerName.style.fontWeight = "bold";


        if(oSelectedStyle.length == 1){
            document.getElementById("txtBuyerName").value = oSelectedStyle[0].Name;
        }
        else if(oSelectedStyle.length > 1){
            document.getElementById("txtBuyerName").value = "You select " + oSelectedStyle.length + " buyers.";
        }
        var ids = "";
        for (var i = 0; i < oSelectedStyle.length; i++) {
            ids += oSelectedStyle[i].ContractorID + ",";
        }
        if(ids.length > 0){
            ids = ids.substring(0, ids.length-1);
        }
        $("#winAdvanceSearchPicker").data("BuyerIDs",ids);
        $("#txtBuyerName").focus();
    }
        //end buyer picker

    //start buyer picker
    function CustomerKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtCustomerName").val();
            if (oTxtName != null) {
                PickCustomer(oTxtName);
            }
        }
        if (event.which == 8) //backspace=8
        {
            //debugger;
            txtCustomerName.style.color = "black";
            txtCustomerName.style.fontWeight = "normal";
            $("#winAdvanceSearchPicker").data("CustomerIDs","");

        }
    }
    function PickCustomer(oTxtName)
    {
        var oStyleSearch = { Params: 2 + '~' + (typeof(oTxtName) != 'undefined'?oTxtName:"") };
        console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('Customer',obj,tblColums,true,'Name','ContractorID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }
    function SetCustomer(oSelectedStyle) {
        debugger;
        txtCustomerName.style.color = "green";
        txtCustomerName.style.fontWeight = "bold";


        if(oSelectedStyle.length == 1){
            document.getElementById("txtCustomerName").value = oSelectedStyle[0].Name;
        }
        else if(oSelectedStyle.length > 1){
            document.getElementById("txtCustomerName").value = "You select " + oSelectedStyle.length + " Customers.";
        }
        var ids = "";
        for (var i = 0; i < oSelectedStyle.length; i++) {
            ids += oSelectedStyle[i].ContractorID + ",";
        }
        if(ids.length > 0){
            ids = ids.substring(0, ids.length-1);
        }
        $("#winAdvanceSearchPicker").data("CustomerIDs",ids);
        $("#txtCustomerName").focus();
    }
    //end Customer picker

    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oResult;
        if (oPickerobj.multiplereturn)
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }
        else
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }


        if (oPickerobj.winid == 'winBuyer')
        {
            SetBuyer(oResult);
        }
        if (oPickerobj.winid == 'winCustomer')
        {
            SetCustomer(oResult);
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 90){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID)
    {
        debugger;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        setInterval(updateProgress,250);

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][pID] > 0) {
                    debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    $("#progressbar").progressbar({ value: 0 });//hide
                    $("#progressbarParent").hide();
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data Not Found.");
                $("#progressbar").progressbar({ value: 0 });//hide
                $("#progressbarParent").hide();
                return;
            }
        });
    }
    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
            else if (e.which == 27)//enter=13
            {
                $("#" + oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
            }
        });
    }

    //end adv search

        //start add fabric beam finish

    $('#btnCloseForFabricBeamFinish').click(function(e) {
        $("#winFabricBeamFinish").icsWindow('close');
    });

    $("#btnAddFabricBeamFinish").click(function(){
        debugger;
        var oDispoHW = $('#tblDispoHWs').datagrid('getSelected');
        if(oDispoHW == null || oDispoHW.FEOSID <= 0){
            alert("Please select a valid item!!");
            return;
        }

        $("#txtOrderNo").val(oDispoHW.ExeNo);
        $("#txtWarpLangth").val(oDispoHW.WarpLangth.toFixed(2));
        $("#txtProduct").val(oDispoHW.ProductName);
        $("#txtBuyer").val(oDispoHW.BuyerName);        

        GetDispoHWs(oDispoHW);

        //Gets Data function
        $('#txtTotalLengthFinish').val("");
        $('#txtRemainingLength').val("");
        GetsFabricBeamFinish(oDispoHW.FEOSID);
        //$('#txtLengthFinish').icsCurrencyBox();
        $('#txtReadyDate').datebox('setValue',icsdateformat(new Date()));
        $('#txtLengthFinish').val(0);
        $('#txtBeam').val('');
        $("#txtNote").val('');

        $("#winFabricBeamFinish").icsWindow('open', "Fabric Beam Finish");
    });

    function SetTotalLength(){
        debugger;
        var oBeamFinishes = $('#tblBeamFinish').datagrid('getRows');
        var nSumTotal = 0;
        if(oBeamFinishes.length > 0){
            for(var i=0;i<oBeamFinishes.length;i++){
                nSumTotal += parseFloat(oBeamFinishes[i].LengthFinish);
            }
        }
        $('#txtTotalLengthFinish').val(nSumTotal.toFixed(2));
        var oDispoHW = $('#tblDispoHWs').datagrid('getSelected');
        var nRemainingLen = parseFloat(oDispoHW.WarpLangth) - nSumTotal;
        $('#txtRemainingLength').val(nRemainingLen.toFixed(2));
        $("#txtTFLength").val(oDispoHW.TFLangth.toFixed(2));
        $('#txtPendingTransfer').val((nSumTotal-parseFloat(oDispoHW.TFLangth)).toFixed(2));
    }

    function GetsFabricBeamFinish(nFEOSID){
        $.ajax({
            type: "GET",
            dataType: "json",
            url : _sBaseAddress+"/DispoHW/GetsFabricBeamFinish",
            traditional: true,
            data:  {nFEOSID:nFEOSID},
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oFBFs = jQuery.parseJSON(data);
                DynamicRefreshList(oFBFs, "tblBeamFinish");
                SetTotalLength();
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    $("#btnAddBeam").click(function ()
    {
        //var nLengthFinish = TempRemoveComma($('#txtLengthFinish').val());
        var nLengthFinish = $('#txtLengthFinish').val();
        if(isNaN(parseFloat(nLengthFinish))){
            alert("Length Finish Should be number!!");
            $('#txtLengthFinish').val(0);
            $('#txtLengthFinish').focus();
            return false;
        }
        //alert(nLengthFinish);
        debugger;
        if(parseFloat(nLengthFinish) <= 0){
            alert("Length Finish Should be greater than 0!!");
            $('#txtLengthFinish').focus();
            return false;
        }
        var oDispoHW = $('#tblDispoHWs').datagrid('getSelected');
        var bIsFinish = false;
        //if($('#chkIsFinish').attr("checked"))
        //{
        //    bIsFinish=true;
        //}
        var oDetail={
            FabricBeamFinishID: 0,
            FESDID: 0,
            DyeingOrderID: 0,
            FEOSID: oDispoHW.FEOSID,
            ReadyDate: $('#txtReadyDate').datetimebox('getValue'),
            LengthFinish:nLengthFinish,
            BeamNo:$("#txtBeam").val(),
            Note:$("#txtNote").val(),
            IsFinish: bIsFinish
        };

        //$('#tblBeamFinish').datagrid('appendRow',oDetail);

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/DispoHW/SaveFabricBeamFinish",
            traditional: true,
            data:  JSON.stringify(oDetail),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oFabricBeamFinish = jQuery.parseJSON(data);
                if (oFabricBeamFinish.ErrorMessage==null || oFabricBeamFinish.ErrorMessage=="") {
                    alert("Data Saved successfully");
                    $('#tblBeamFinish').datagrid('appendRow',oFabricBeamFinish);
                    SetTotalLength();
                    $('#txtLengthFinish').val(0);
                    $('#txtBeam').val('');
                    $("#txtNote").val('');
                }
                else {
                    alert(oFabricBeamFinish.ErrorMessage);
                    //$('#txtLengthFinish').val(0);
                    //$('#txtBeam').val('');
                    //$("#txtNote").val('');
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    });

    $("#btnDeleteBeam").click(function(){
        debugger;
        var oBeamFinish = $('#tblBeamFinish').datagrid('getSelected');
        if(oBeamFinish==null || oBeamFinish.FabricBeamFinishID<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblBeamFinish').datagrid('getRowIndex',oBeamFinish);
        if (oBeamFinish.FabricBeamFinishID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/DispoHW/DeleteFabricBeamFinish",
                data: JSON.stringify(oBeamFinish),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Data delete successfully")
                    {
                        alert("Data delete successfully");
                        $('#tblBeamFinish').datagrid('deleteRow',SelectedRowIndex);
                        SetTotalLength();
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });

    function TempRemoveComma(userInput) {
        //debugger;
        var amountInString = "";
        if (userInput === null || userInput === "") {
            amountInString = "0.00";
        }
        else {
            amountInString = "";
            for (var i = 0; i < userInput.length; i++) {
                var char = userInput.charAt(i);
                var charForCheck = char;
                char = char.match(/\d+/g);
                if (char != null) {
                    amountInString = amountInString + userInput.charAt(i);
                    count = 1;
                }
                else if (charForCheck == ",") {
                    continue;
                }
                else if (charForCheck == ".") {
                    amountInString = amountInString + userInput.charAt(i);
                }
            }
        }
        //debugger;
        return (isNaN(parseFloat(amountInString)) ? parseFloat(0.00) : parseFloat(amountInString)).toFixed(3);
    }

    function GetDispoHWs(oDispoHW){
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DispoHW/GetsData",
            traditional: true,
            data:  JSON.stringify(oDispoHW),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                //var oDispoHWs = jQuery.parseJSON(data);
                var oObjs = data;
                if(oObjs.length<=0){
                    $('#txtSuggestedLength').val(0);
                    $.icsMakeFooterColumn('tblTempDispoHWs',['ColorName','QtyWarp','QtyDyeing','WarpKg','DueTFKg','WarpTF','WeftTF','TotalTFKg','DueTFKg']);
                    //alert("No data found");
                    return;
                }
                else{
                    var result=[];
                    for(var i = 0; i<oObjs.length;i++){
                        if(parseFloat(oObjs[i].QtyWarp) > 0)
                            result.push(oObjs[i]);
                    }
                    if(result.length > 0){
                        var nTotalWarpReq = 0;
                        var nTotalWarpKg = 0;
                        var bIsZeroExist = false;
                        for(var i = 0; i<result.length;i++){
                            nTotalWarpReq += result[i].QtyWarp;
                            if(result[i].QtyWarp < result[i].QtyDyeing){
                                nTotalWarpKg += result[i].QtyWarp;
                                result[i].WarpKg = result[i].QtyWarp;
                            }else{
                                nTotalWarpKg += result[i].QtyDyeing;
                                result[i].WarpKg = result[i].QtyDyeing;
                            }
                        }
                        for(var i = 0; i<result.length;i++){
                            if(result[i].QtyDyeing <= 0){
                                bIsZeroExist = true;
                                break;
                            }
                        }
                        DynamicRefreshList(result, "tblTempDispoHWs");
                        $.icsMakeFooterColumn('tblTempDispoHWs',['ColorName','QtyWarp','QtyDyeing','WarpKg','DueTFKg','WarpTF','WeftTF','TotalTFKg','DueTFKg']);
                        if(bIsZeroExist == false){
                            var nSugVal = ((parseFloat(oDispoHW.WarpLangth)*nTotalWarpKg)/nTotalWarpReq);
                            $('#txtSuggestedLength').val(nSugVal.toFixed(2));
                        }else{
                            $('#txtSuggestedLength').val(0);
                        }
                    }else{
                        $('#txtSuggestedLength').val(0);
                        $.icsMakeFooterColumn('tblTempDispoHWs',['ColorName','QtyWarp','QtyDyeing','WarpKg','DueTFKg','WarpTF','WeftTF','TotalTFKg','DueTFKg']);
                    }
                    
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    //end add fabric beam finish

    </script>
