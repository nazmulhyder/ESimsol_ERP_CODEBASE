@{
    ViewBag.Title = "Knitting Yarn Return List";
}
@model IEnumerable<ESimSol.BusinessObjects.KnittingYarnReturn>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    
    <div class="menuMainCollectionTable" id="regionKnittingFabricReceive">
        <table id="tblKnittingYarnReturns" title="Knitting Receive List" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
            <thead>
                <tr>  
                    <th field="ReturnNo" width="9%">Return No</th>
                    <th field="ReturnDateInString" width="10%">Receive Date</th>
                    <th field="PartyChallanNo" width="12%">Party Challan No</th>
                    <th field="Remarks" width="30%">Remarks</th>
                    <th field="ApprovedByName" width="30%">Approve By</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approve</a>
            <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
         
        </div>
    </div>
    <div id="winKnittingYarnReturn" class="easyui-window" title="Knitting Yarn Return" style="height: 515px; width: 1020px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div id="MainDiv" style="font-family:Tahoma;height:85% ;width:99%">
            <table style="width:100%;">
                <tr style="width:100%;">
                    <td style="width:100%;">
                        <fieldset>
                            <legend>Knitting Yarn Return Info</legend>
                            <table style="width:100%;">
                                <tr>
                                    <td class="align-right" style="width:10%">Return No</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtReturnNo" disabled/>
                                    </td>
                                    <td class="align-right" style="width:10%">Return Date</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtReturnDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                    <td class="align-right" style="width:15%">Party Challan No</td>
                                    <td style="width:25%">
                                        <input type="text" style="width:100%;" id="txtPartyChallanNo" placeholder="Enter Party Challan No" />
                                    </td>
                                </tr>
                                <tr>
                                    <td class="align-right" style="width:10%">Remarks</td>
                                    <td style="width:20%" colspan="5">
                                        <input type="text" style="width:100%;" id="txtRemarks" placeholder="Enter Remarks" />
                                    </td>
                                   
                                </tr>
                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>
            <table id="tblKnittingYarnReturnDetail" title="Knitting Yarn Return Details" class="easyui-datagrid" style="height:300px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#Wintoolbar" data-options="onClickRow:onClickRow,onEndEdit: onEndEdit">
                <thead>
                    <tr> 
                        <th field="ChallanNo" width="10%" align="left">Challan No</th>
                        <th field="YarnName" width="10%" align="left">Yarn Name</th>
                        <th field="OperationUnitName" width="10%" align="left">Store</th>
                        <th field="LotNo" width="15%" align="left">Lot No</th>
                        <th field="MUnitName" width="7%" align="left">M. Unit</th>  
                        <th field="ChallanQty" formatter="formatPrice" width="8%" align="right">Challan Qty</th>
                        <th field="ReturnBalance" formatter="formatPrice" width="8%" align="right">Return Balance</th>
                        <th field="ChallanBalance" formatter="formatPrice" width="8%" align="right">ChallanBalance</th>
                        <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">Qty</th>
                        <th data-options="field:'Remarks',align:'left',editor:{type:'text'}" width="10%">Remarks</th>
                    </tr>
                </thead>
            </table>
            <div id="Wintoolbar">
              
                Challan:<select id="cboChallan" style="width:190px;height:22px;"></select> 
                Store : <select id="cboStore" style="width:100px;height:22px;" ></select> 
                Lot  : <input type="text" id="txtWinLot" style=" width:130px;"  placeholder="Type Lot" disabled/> 
                MUnit : <select id="cboMUnit" style="width:100px;height:22px;" disabled></select>   
                Challan Qty : <input type="text" id="txtChallanQty" style="width:70px;" class="numberbox"  disabled/>
                Qty : <input type="text" id="txtQty" class="number" style="width:70px;" />
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnRefreshDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>

            </div>
        </div>
        <fieldset style="height:14%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:60%; text-align:right"></td>
                    <td style="width:40%;text-align:right;">
                        <a id="btnWinSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnWinClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel"  plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
      
    
    </div>

    <script type="text/javascript">
    var _oKnittingYarnReturn=null;
    var _oKnittingYarnReturns=[];
    var _sBaseAddress="";
    var _oKnittingOrder=null;
    var _MUnits=[];
    var _Stores=[];
    var _oKnittingYarnChallanDetails=[];

    $(document).ready(function () {
        var oAuthorizationRolesMappings =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oKnittingYarnReturns =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _MUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Units));
        _oKnittingOrder=@Html.Raw(Json.Encode(ViewBag.KnittingOrder));
        _Stores=@Html.Raw(Json.Encode(ViewBag.Stores));
        _oKnittingYarnChallanDetails=@Html.Raw(Json.Encode(ViewBag.KnittingYarnChallanDetails));
        DynamicRefreshList(_oKnittingYarnReturns, "tblKnittingYarnReturns");
        var dgPanel = $('#tblKnittingYarnReturns').datagrid('getPanel');
        dgPanel.panel('setTitle',"Return List For : Order No - "+_oKnittingOrder.OrderNo);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        RefreshControlLayout(oAuthorizationRolesMappings);      
    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    $("#btnAdd").click(function(){
        $("#winKnittingYarnReturn").data("ActionName","New");
        RefreshControlWindowLayout(0);
        var oKnittingChallans= $('#tblKnittingYarnReturns').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));
        sessionStorage.setItem("SelectedRowIndex", -1);


    });

    $("#btnEdit").click(function(){
        debugger;
        var oKnittingYarnReturn= $('#tblKnittingYarnReturns').datagrid('getSelected');
        if(oKnittingYarnReturn==null || oKnittingYarnReturn.KnittingYarnReturnID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnReturn.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }

        $("#winKnittingYarnReturn").data("ActionName","Edit");
        RefreshControlWindowLayout(oKnittingYarnReturn.KnittingYarnReturnID);
        var oKnittingChallans= $('#tblKnittingYarnReturns').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));

        var SelectedRowIndex=$('#tblKnittingYarnReturns').datagrid('getRowIndex',oKnittingYarnReturn);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);

    });

    $("#btnView").click(function(){
        var oKnittingYarnReturn= $('#tblKnittingYarnReturns').datagrid('getSelected');
        if(oKnittingYarnReturn==null || oKnittingYarnReturn.KnittingYarnReturnID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        $("#winKnittingYarnReturn").data("ActionName","View");
        RefreshControlWindowLayout(oKnittingYarnReturn.KnittingYarnReturnID);
        var oKnittingChallans= $('#tblKnittingYarnReturns').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));
        var SelectedRowIndex=$('#tblKnittingYarnReturns').datagrid('getRowIndex',oKnittingYarnReturn);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
    });

    $("#btnDelete").click(function(){
        var oKnittingYarnReturn= $('#tblKnittingYarnReturns').datagrid('getSelected');
        if(oKnittingYarnReturn==null || oKnittingYarnReturn.KnittingYarnReturnID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnReturn.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }


        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblKnittingYarnReturns').datagrid('getRowIndex',oKnittingYarnReturn);
        if (oKnittingYarnReturn.KnittingYarnReturnID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnReturn/Delete",
                data: JSON.stringify(oKnittingYarnReturn),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage== "Data delete successfully")
                    {

                        alert("Delete sucessfully");
                        $('#tblKnittingYarnReturns').datagrid('deleteRow',SelectedRowIndex);


                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });
    $("#btnApprove").click(function(){
        var oKnittingYarnReturn= $('#tblKnittingYarnReturns').datagrid('getSelected');
        if(oKnittingYarnReturn==null || oKnittingYarnReturn.KnittingYarnReturnID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnReturn.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }

        if (!confirm("Confirm to Approve?")) return ;
        var SelectedRowIndex=$('#tblKnittingYarnReturns').datagrid('getRowIndex',oKnittingYarnReturn);
        if (oKnittingYarnReturn.KnittingYarnReturnID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnReturn/ApproveChallan",
                data: JSON.stringify(oKnittingYarnReturn),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oKnittingYarnReturn = jQuery.parseJSON(data);
                    if (oKnittingYarnReturn.KnittingYarnReturnID>0)
                    {
                        $('#tblKnittingYarnReturns').datagrid('updateRow', { index: SelectedRowIndex,  row: oKnittingYarnReturn });
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });



    function RefreshList(oKnittingOrders)
    {

        var data=oKnittingOrders;
        data={"total":""+data.length+"","rows":data};
        $('#tblKnittingYarnReturns').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        $('#tblKnittingYarnReturns').datagrid('selectRow',nIndex);
    }

        /*---------------REgion For Picker Knitting Yarn Return----------------------*/
  
   
 
    function WinToolbarLayOutRefresh(){
    $("#cboMUnit").icsLoadCombo({
        List:_MUnits,
        OptionValue: "MeasurementUnitID",
        DisplayText: "Symbol",

    });
    $("#cboStore").icsLoadCombo({
        List:_Stores,
        OptionValue: "WorkingUnitID",
        DisplayText: "OperationUnitName",

    });

    $("#cboChallan").icsLoadCombo({
        List:_oKnittingYarnChallanDetails,
        OptionValue: "KnittingYarnChallanDetailID",
        DisplayText: "ChallanWithLotandQty",
      
    });  
    $("#txtWinLot,#txtChallanQty,#txtQty").val("");
    $("#txtWinLot,#cboMUnit,#txtChallanQty,#txtQty,#txtReturnNo").prop("disabled", true);//#cboStore,
    $("#txtQty").prop("disabled", false);
   
}
    function WinActionNew(){
    $("#txtReturnNo,#txtPartyChallanNo,#txtRemarks").val("");
    $('#txtReturnDate').datebox('setValue',icsdateformat(new Date()));
    DynamicRefreshList([], "tblKnittingYarnReturnDetail");
    $("#btnWinSave").show();
    WinToolbarLayOutRefresh();
    $("#winKnittingYarnReturn").icsWindow('open');
    _oKnittingYarnReturn = null;
    $("#txtQty,#txtPartyChallanNo,#txtRemarks,#txtReturnDate,#cboChallan").prop("disabled", false);
}
    function WinActionOthers(oKnitYarnReturn){
        debugger;
     editIndex = undefined;
    _oKnittingYarnReturn=oKnitYarnReturn;
    var sActionName=$("#winKnittingYarnReturn").data("ActionName");
    $("#txtReturnNo").val(oKnitYarnReturn.ReturnNo);
    $("#txtPartyChallanNo").val(oKnitYarnReturn.PartyChallanNo);
    $("#txtRemarks").val(oKnitYarnReturn.Remarks);
    $('#txtReturnDate').datebox('setValue',oKnitYarnReturn.ReturnDateInString);
    DynamicRefreshList(oKnitYarnReturn.KnittingYarnReturnDetails, "tblKnittingYarnReturnDetail");
    WinToolbarLayOutRefresh();
    if(sActionName=="View"){
        $("#txtQty,#txtReturnNo,#txtPartyChallanNo,#txtRemarks,#txtReturnDate,#cboChallan").prop("disabled", true);
        $("#btnWinSave").hide();
    }
    else{
        $("#txtQty,#txtPartyChallanNo,#txtRemarks,#txtReturnDate,#cboChallan").prop("disabled", false);
        $("#btnWinSave").show();
    }
    $("#txtReturnNo,#cboMUnit").prop("disabled", true);
    $("#winKnittingYarnReturn").icsWindow('open');
}
    function RefreshControlWindowLayout(nKnittingYarnReturnID)
    {
      
        $("#btnWinSave").show();
        var sActionName=$("#winKnittingYarnReturn").data("ActionName");
        if(sActionName=="New"){
            WinActionNew();
        }
        else{
            $.ajax({
                type: "POST",
                dataType: "JSON",
                url: sessionStorage.getItem("BaseAddress")+  "/KnittingYarnReturn/GetKnittingYarnReturn",
                data:  JSON.stringify({KnittingYarnReturnID:nKnittingYarnReturnID}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oResult= JSON.parse(data);
                    WinActionOthers(oResult);
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
                });
            }
        }

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblKnittingYarnReturnDetail').datagrid('validateRow', editIndex)) {
            $('#tblKnittingYarnReturnDetail').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblKnittingYarnReturnDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else {
                $('#tblKnittingYarnReturnDetail').datagrid('selectRow', editIndex);
            }
        }
    }
    function onEndEdit(index, row) {

    }

    function GetKnittingOrderDetailID(nFabricID){
        var KnittingOrderDetailID=0;
        for(var i=0;i<_oKnittingOrder.KnittingYarns.length;i++){
            if(_oKnittingOrder.KnittingYarns[i].YarnID==nFabricID){
                KnittingOrderDetailID=_oKnittingOrder.KnittingYarns[i].KnittingOrderDetailID;
                break;
            }
        }
        return KnittingOrderDetailID;
    }

function GetChallanDetail(nKnittingYarnChallanDetailID){
    var oChallanDetail="";
    for(var i=0;i<_oKnittingYarnChallanDetails.length;i++){
        if(_oKnittingYarnChallanDetails[i].KnittingYarnChallanDetailID==nKnittingYarnChallanDetailID){
            oChallanDetail=_oKnittingYarnChallanDetails[i];
            break;
        }
    }
    return oChallanDetail;
}
$("#cboChallan").on('change',function(){
    debugger;
    var nChallanDetailID =$("#cboChallan").val();
    if(nChallanDetailID>0){
        var oChallanDetail=GetChallanDetail(nChallanDetailID);
        $("#cboStore").val(oChallanDetail.IssueStoreID);
        $("#txtWinLot").val(oChallanDetail.LotNo);
        $("#cboMUnit").val(oChallanDetail.MUnitID);
        $("#txtQty").val(oChallanDetail.ChallanBalance);
        $("#txtChallanQty").val(oChallanDetail.ChallanBalance);
       
    }
});
    $("#btnAddDetail").click(function ()
    {
        if(parseInt($("#cboChallan").val()) <= 0){
            alert("Please Select  Challan!!");
            $("#cboStore").focus();
            return;
        }
       
        if(parseFloat($("#txtQty").val()) <= 0){
            alert("Please enter Qty!!");
            $("#txtQty").focus();
            return;
        }
       
        var oChallanDetail=GetChallanDetail(parseInt($("#cboChallan").val()));
        if(parseFloat($("#txtQty").val()) >oChallanDetail.Qty){
            alert("Return Qty Can Not be Greater than Challan Qty!!");
            $("#txtQty").focus();
            return;
        }
        var oKnittingYarnReturnDetail={

                KnittingYarnReturnDetailID:0,
                KnittingYarnReturnID:0,
                KnittingYarnChallanDetailID:oChallanDetail.KnittingYarnChallanDetailID,
                YarnID:oChallanDetail.YarnID,
                ReceiveStoreID:oChallanDetail.IssueStoreID,
                LotID:oChallanDetail.LotID,
                MUnitID:parseInt($("#cboMUnit").val()),
                Qty:parseFloat($("#txtQty").val()),
                Remarks:'',
                ChallanNo:oChallanDetail.ChallanNo,
                YarnName:oChallanDetail.YarnName,
                OperationUnitName:oChallanDetail.OperationUnitName, 
                LotNo:oChallanDetail.LotNo,
                MUnitName:oChallanDetail.MUnitName,
                ChallanQty:oChallanDetail.Qty,
                ReturnBalance:oChallanDetail.ReturnBalance,
                ChallanBalance:oChallanDetail.ChallanBalance

        };
        $('#tblKnittingYarnReturnDetail').datagrid('appendRow',oKnittingYarnReturnDetail);
     
    });

    $("#btnRemoveDetail").click(function ()
    {
        endEditing();
        var oKnittingYarnReturnDetail=$('#tblKnittingYarnReturnDetail').datagrid('getSelected');
        if(oKnittingYarnReturnDetail==null)
        {
            alert("Please select a valid item from list.");
            return;
        }
        var nIndex= $('#tblKnittingYarnReturnDetail').datagrid('getRowIndex',oKnittingYarnReturnDetail);
        $('#tblKnittingYarnReturnDetail').datagrid('deleteRow',nIndex);
    });

    $("#btnRefreshDetail").click(function ()
    {
        endEditing();
        var data= $('#tblKnittingYarnReturnDetail').datagrid('getRows');
        data={"total":""+data.length+"","rows":data};
        $('#tblKnittingYarnReturnDetail').datagrid('loadData',data);
    });
    $("#btnWinClose").click(function (){
        $("#winKnittingYarnReturn").icsWindow('close');

    });
    function Validation(){
        if($("#txtReturnDate").datebox('getValue') == '' || $("#txtReturnDate").datebox('getValue') == null){
            alert('Please Enter Challan date!!');
            $("#txtReturnDate").focus();
            return false;
        }
        var oRows=$('#tblKnittingYarnReturnDetail').datagrid('getRows');
        if(oRows.length<=0){
            alert("Atleast one Knitting Return detail required!!");
            return false;
        }
        var oRows= $('#tblKnittingYarnReturnDetail').datagrid('getRows');
        var chkVal=false;
        for(var i=0;i<oRows.length;i++){
            if(oRows[i].Qty>oRows[i].ChallanQty){
                chkVal=true;
            }
        }
        if(chkVal){
            alert("Qty Should not be greater than Challan Qty");
            return false;
        }
        return true;
    }
    function RefreshObject()
    {
        var oKnittingYarnReturn={

            KnittingYarnReturnID : (_oKnittingYarnReturn==null)?0:_oKnittingYarnReturn.KnittingYarnReturnID,
            KnittingOrderID:_oKnittingOrder.KnittingOrderID,
            ReturnDate:$('#txtReturnDate').datebox('getValue'),
            Remarks : $.trim($('#txtRemarks').val()),
            PartyChallanNo: $.trim($('#txtPartyChallanNo').val()),
            KnittingYarnReturnDetails:$('#tblKnittingYarnReturnDetail').datagrid('getRows')

        };

        return oKnittingYarnReturn;
    }
    $("#btnWinSave").click(function (){

        endEditing();
        if(!Validation()) return false;
        var oKnittingYarnReturn=RefreshObject();
        //return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/KnittingYarnReturn/Save",
            traditional: true,
            data:JSON.stringify(oKnittingYarnReturn),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                oKnittingYarnReturn = jQuery.parseJSON(data);
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (oKnittingYarnReturn.ErrorMessage==null || oKnittingYarnReturn.ErrorMessage=="") {
                    alert("Data Saved successfully");

                    _oKnittingYarnReturn=oKnittingYarnReturn;
                    //$("#txtWinLot,#txtChallanQty,#txtQty").val("");
                    $('#txtReturnNo').val(_oKnittingYarnReturn.ReturnNo);
                    $('#txtReturnDate').datebox('setValue',_oKnittingYarnReturn.ReturnDateInString);
                    $('#txtPartyChallanNo').val(_oKnittingYarnReturn.PartyChallanNo);
                    $('#txtRemarks').val(_oKnittingYarnReturn.Remarks);
                    DynamicRefreshList(_oKnittingYarnReturn.KnittingYarnReturnDetails, "tblKnittingYarnReturnDetail");
                    var oKnittingChallans = sessionStorage.getItem("KnittingChallans");

                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oKnittingChallans != null) {
                        oKnittingChallans = jQuery.parseJSON(oKnittingChallans);
                    }
                    else
                    {
                        oKnittingChallans = [];
                    }
                    if (nIndex != -1)
                    {
                        oKnittingChallans[nIndex] = oKnittingYarnReturn;
                        $('#tblKnittingYarnReturns').datagrid('updateRow', { index: nIndex,  row: oKnittingYarnReturn });
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oKnittingChallans.length);
                        oKnittingChallans.push(oKnittingYarnReturn);
                        $('#tblKnittingYarnReturns').datagrid('appendRow',oKnittingYarnReturn);
                        $('#tblKnittingYarnReturns').datagrid('selectRow',oKnittingChallans.length-1);
                    }
                 
                }
                else {
                    alert(oKnittingYarnReturn.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $('#btnPreview').click(function()
    {
        debugger;
        var oKnittingYarnReturn=$('#tblKnittingYarnReturns').datagrid('getSelected');
        if(oKnittingYarnReturn==null || parseInt(oKnittingYarnReturn.KnittingYarnReturnID)<=0)
        {
            alert("Please select Knitting Yarn Return ");
            return;
        }
        window.open(_sBaseAddress+ "/KnittingYarnReturn/KnittingFabricReceivePrintPreview?id="+oKnittingYarnReturn.KnittingYarnReturnID);
    });

    function RefreshControlLayout(oAuthorizationRolesMappings)
    {
        $('#btnAdd,#btnEdit,#btnView,#btnDelete,#btnApprove,#btnPreview').hide(); //

        if(PermissionChecker('Add','KnittingYarnReturn', oAuthorizationRolesMappings)){$('#btnAdd').show();}
        if(PermissionChecker('Edit','KnittingYarnReturn', oAuthorizationRolesMappings)){$('#btnEdit').show(); }
        if(PermissionChecker('View','KnittingYarnReturn', oAuthorizationRolesMappings)){$('#btnView').show(); }
        if(PermissionChecker('Delete','KnittingYarnReturn', oAuthorizationRolesMappings)){ $('#btnDelete').show(); }
        if(PermissionChecker('Approved','KnittingYarnReturn', oAuthorizationRolesMappings)){$('#btnApprove').show();}        
        if(PermissionChecker('Preview','KnittingYarnReturn', oAuthorizationRolesMappings)){$('#btnPreview').show();}
    }

/*---------------------------Endregion----------------------------------------*/


    </script>
