<html>
@{
    ViewBag.Title = "Service Invoice Approval";
}
<body>
    @model ESimSol.BusinessObjects.ServiceInvoice

    <div class="menuMainCollectionTable" ng-app="ServiceInvoiceApp" ng-controller="ServiceInvoiceController as SODC" style="height:100%; width:100%; overflow:hidden" id="divServiceInvoice">
        <div style="height:4%; overflow:hidden;" class="ui-grid-top-panel">
            <label ng-model="HeaderStatus">Update Service Status</label>
        </div>

        <div class="regionVR" style="height:80%;">
            <div style="font-family:Tahoma;text-align:center;height:80%; padding-right:24px" class="regionVR">
                <div class="col-md-12" style="height:42%;">
                    <fieldset style="height:460px;width:100%">
                        <div class="row" style="padding-top:120px;">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Invoice No:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.ServiceInvoiceNo" class="form-control" disabled>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">V Type:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.VehicleTypeName" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Reg. No:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.VehicleRegNo" class="form-control" disabled>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">VIN No:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.ChassisNo" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Model No:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.VehicleModelNo" class="form-control" disabled>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Engine No:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.EngineNo" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Customer:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.CustomerName" class="form-control" disabled>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Customer Phone:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.CustomerPhone" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Contact Person:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.ContactPerson" class="form-control" disabled>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Contact P. Phone:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.ContactPersonPhone" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label"> {{lblDateTime}}</label></div>
                                <div class="col-md-4 text-left">
                                    <input id="txtDateTime" type="text" class="easyui-datetimebox" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser,showSeconds:false" required="required" style="width:100%" />
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Serive Advisor:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.AdvisorName" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="col-md-2 text-right"><label class="control-label">Comments:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.Comments" class="form-control" placeholder="Write a comment..">
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Service Schedule:</label></div>
                                <div class="col-md-4 text-left">
                                    <input type="text" ng-model="ServiceInvoice.ScheduleDateSt" disabled style="width:85%;"><input type="button" ng-click="PickSchedule()" value="Pick">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

        <div class="row" style="width:100%; height:10%">
            <fieldset style="margin-left:22px; margin-right:11px">
                <legend>Action</legend>
                <div class="row col-md-12 text-right">
                    <button type="button" class="btn-primary btn-sm" ng-show="btnApprove" aria-label="Left Align" ng-click="Approve()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Approve</button>
                    <button type="button" class="btn-primary btn-sm" ng-show="btnReceive" aria-label="Left Align" ng-click="Receive()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Receive</button>
                    <button type="button" class="btn-primary btn-sm" ng-show="btnDelivered" aria-label="Left Align" ng-click="Delivered()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Delivered</button>
                    <button type="button" class="btn-warning btn-sm" ng-show="btnCancel" aria-label="Left Align" ng-click="Cancel()"> <span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Cancel</button>
                    <button type="button" class="btn-danger btn-sm" aria-label="Right Align" ng-click="Close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Close</button>
                </div>
            </fieldset>
        </div>
    </div>
</body>
</html>
<style type="text/css">
    .regionVR .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionVR .form-control {
        height: 22px;
        padding: 0px 6px;
        font-size: 12px;
    }
    .regionVR regionVROT .form-control {
        height: 20px;
        padding: 0px 6px;
        font-size: 12px;
    }
    .regionVR .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 5px;
    }
  
    .regionVR .col-md-2 {
        width: 16%;
        padding-right: 5px;
        padding-left: 5px;
    }
    .regionVR .col-md-10 {
        width: 82.5%;
        padding-right: 5px;
        padding-left: 5px;
    }
     .regionVR .col-md-4 {
        width: 33.33%;
        padding-right: 5px;
        padding-left: 5px;
    }
    
    .regionVR .col-md-6 {
        width: 50%;
        padding-right: 5px;
        padding-left: 5px;
    }
 
    .regionVR .btn-sm {
        padding: 2px 8px;
    }

    .regionVR .input-group-addon {
        padding: 2px 5px;
    }
    /*.ui-grid-top-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    } 
    .ui-grid-panel {
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
    }*/
</style>
<script type="text/javascript">
    var oServiceInvoice =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var ServiceInvoiceApp = angular.module('ServiceInvoiceApp', ['ngAnimate', 'ui.bootstrap','ui.grid','ui.grid.selection', 'ms.service']);
    ServiceInvoiceApp.controller('ServiceInvoiceController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession,icsMethod) {
       
        $scope.ServiceInvoice=oServiceInvoice;
        $scope.ServiceInvoice.BUID=sessionStorage.getItem('BUID');
      
        $scope.Operation=sessionStorage.getItem("Operation");
        debugger;
        $scope.btnApprove= $scope.btnDelivered = $scope.btnReceive= $scope.btnCancel= false;
        if($scope.Operation=="Approve")
        {
            $scope.btnApprove=true;
            $scope.lblDateTime="Order Date: ";
            $scope.Date_disabled= true;
            $('#txtDateTime').datetimebox('setValue', icsdatetimeformat(new Date(oServiceInvoice.ServiceInvoiceDateSt)));
        }
        else if($scope.Operation=="Receive")
        {
            $scope.btnReceive=true;
            $scope.lblDateTime="Receive Date: ";
            $('#txtDateTime').datetimebox('setValue', icsdatetimeformat(new Date()));
        }
        else if($scope.Operation=="Deliver")
        {
            $scope.lblDateTime="Delivery Date: ";
            $scope.btnDelivered =true;
            $('#txtDateTime').datetimebox('setValue', icsdatetimeformat(new Date()));
        }
        else if($scope.Operation=="Cancel")
        {
            $scope.lblDateTime="Order Date: ";
            $scope.btnCancel= true;
            $scope.Date_disabled= true;
            $('#txtDateTime').datetimebox('setValue', icsdatetimeformat(new Date(oServiceInvoice.ServiceInvoiceDateSt)));
            $("#txtDateTime").datebox("disable");
        }
        
        $scope.PickSchedule =function()
        {
            debugger;
            var oServiceInvoice = { ServiceInvoiceID:$scope.ServiceInvoice.ServiceInvoiceID};
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/ServiceSchedule/GetServiceSchedules',$.param(oServiceInvoice), config).then(
                                function (response)
                                {
                                    debugger;
                                    var oColumns = [];
                                    var oColumn = { field: 'ServiceDateSt', name: 'Service Date',width: '50%' };oColumns.push(oColumn);
                                    oColumn = { field: 'ChargeTypeSt', name: 'Charge Type',width: '50%', enableSorting: false};oColumns.push(oColumn);
                                    //oColumn = { field: 'IsSMSSendSt', name: 'SMS',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                                    //oColumn = { field: 'IsEmailSendSt', name: 'Email',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                                    var results=response.data;
                                    var modalObj={
                                        size:'md',
                                        modalcontroller:'ModalCommonListCtrl',
                                        appcontroller:'ServiceInvoiceController',
                                        objs:results,
                                        multiSelect:false,
                                        pickertitle:'Schedule List',
                                        searchingbyfieldName:'ServiceDateSt',
                                        columns:oColumns
                                    }
                                    var modalInstance=msModal.Instance(modalObj);
                                    modalInstance.result.then(function (result)
                                    {
                                        debugger;
                                        $scope.ServiceInvoice.ServiceScheduleID=result.ServiceScheduleID;
                                        $scope.ServiceInvoice.ScheduleDateSt=result.ServiceDateSt;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message);}
                            );
        }

        $scope.Approve= function () {

            var oServiceInvoice=$scope.ServiceInvoice;
            oServiceInvoice.nRequest=1; // 1: Approve
            oServiceInvoice.Remarks=$scope.ServiceInvoice.Comments; 
            oServiceInvoice.ActualRcvDateTime= $('#txtDateTime').datebox('getValue');

            $http.post(sessionStorage.getItem('BaseAddress')+'/ServiceInvoice/Approve', JSON.stringify(oServiceInvoice)).then(
                            function (response) {
                                if (jQuery.parseJSON(response.data) == 'Approved') 
                                {
                                    var oServiceInvoice=$scope.ServiceInvoice;
                                    alert("Successfully Approved.");
                                    oServiceInvoice.InvoiceStatusInt=2;
                                    oServiceInvoice.InvoiceStatusSt="Approved";

                                    userSession.setData('ServiceInvoiceList',oServiceInvoice);
                                    userSession.previousPage();
                                    $scope.Close();
                                }
                                else 
                                {
                                    alert(jQuery.parseJSON(response.data));
                                }
                            },
                            function (response) { alert(jQuery.parseJSON(response.data)); }
                        );
        };
      
        $scope.Cancel= function () {

            var oServiceInvoice=$scope.ServiceInvoice;
            oServiceInvoice.nRequest=4; // 4: Cancel
            oServiceInvoice.Remarks=$scope.ServiceInvoice.Comments; 
            oServiceInvoice.ActualRcvDateTime= $('#txtDateTime').datebox('getValue');

            $http.post(sessionStorage.getItem('BaseAddress')+'/ServiceInvoice/UpdateStatus', JSON.stringify(oServiceInvoice)).then(
                            function (response) {
                                if (jQuery.parseJSON(response.data) == 'Cancel') 
                                {
                                    alert("Successfully Canceled.");
                                    $scope.ServiceInvoice.OrderStatusInt=4;
                                    $scope.ServiceInvoice.OrderStatusSt="Cancel";

                                    userSession.setData('ServiceInvoiceList',oServiceInvoice);
                                    userSession.previousPage();
                                    $scope.Close();
                                }
                                else 
                                {
                                    alert(jQuery.parseJSON(response.data));
                                }
                            },
                            function (response) { alert(jQuery.parseJSON(response.data)); }
                        );
        };
      

        $scope.Close=function ()
        {
            debugger;
            window.location.href = sessionStorage.getItem("BackLink");
        };
    });

</script>