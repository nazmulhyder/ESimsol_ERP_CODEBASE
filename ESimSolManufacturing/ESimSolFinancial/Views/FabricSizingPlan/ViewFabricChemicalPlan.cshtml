<html>
<head>
    @{
        ViewBag.Title = "Fabric Chemical Plan";
    }
</head>
<body>
    @model IEnumerable<ESimSol.BusinessObjects.FabricChemicalPlan>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div id="MainDiv" class="easyui-panel" title="Fabric Chemical Plan" style="font-family:Tahoma;height:90%">
            
            <fieldset>
                <legend>Sample Request Info</legend>
                <table style="width:100%;">
                    <tr>
                        <td class="align-right" style="width:10%">Dispo No</td>
                        <td style="width:20%">
                            <input type="text" style="width:100%" id="txtDispoNo" disabled />
                        </td>
                        <td class="align-right" style="width:10%">Buyer Name</td>
                        <td style="width:20%">
                            <input type="text" style="width:100%" id="txtBuyerName" disabled />
                        </td>
                        <td class="align-right" style="width:15%">Construction</td>
                        <td style="width:25%">
                            <input type="text" style="width:100%" id="txtConstruction" disabled />
                        </td>
                    </tr>

                    <tr>
                        <td class="align-right" style="width:10%">Composition</td>
                        <td style="width:20%">
                            <input type="text" style="width:100%" id="txtComposition" disabled />
                        </td>
                        <td class="align-right" style="width:10%">Req. Warp Length</td>
                        <td style="width:20%">
                            <input type="text" style="width:100%" id="txtReqWarpLength" class="number" disabled />
                        </td>
                        <td class="align-right" style="width:15%">Water Qty</td>
                        <td style="width:25%">
                            <table style="width:100%">
                                <tr style="width:100%">
                                    <td style="width:30%"><input type="text" style="width:100%" id="txtWaterQty" class="number" /></td>
                                    <td style="width:18%;text-align:right;">Beam</td>
                                    <td style="width:30%"><input type="text" style="width:100%" id="txtWarpBeam" class="number" /></td>
                                    <td style="width:20%"><a id="btnUpdateWaterQty" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" style=" height:22px;width:100%;float:left;">Update</a></td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                </table>
            </fieldset>

            <table id="tblFabricChemicalPlans" title="" class="easyui-datagrid" style="height:80%; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar" data-options="onClickRow:onClickRow">
                <thead>
                    <tr>
                        <th field="ProductName" width="25%" align="left">Product Name</th>
                        <th field="ProductCode" width="20%" align="left">Product Code</th>
                        <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="20%" formatter="formatPrice">Quantity</th>
                        <th field="MUnitName" width="20%" align="left">M. Unit</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar">
                Product : <input type="text" id="txtProduct" style="width:130px;" onkeydown="ProductKeyDown(event)" />
                <input type="button" id="btnProduct" style="width:45px;" onclick="PickProduct()" value="Pick" />                
                @*Qty : <input type="number" id="txtQty" class="number" value="0" style="width:70px;" />
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>*@
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                @*<a id="btnRefreshDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>*@

            </div>
        </div>
        <fieldset style="height:10%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:60%; text-align:right"></td>
                    <td style="width:40%;text-align:right;">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="Close()" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    td, th {
        padding: 2px;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oFabricChemicalPlans = [];
    var _oFabricSizingPlan = {};
    var _nBUID = 0;
    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFabricChemicalPlans =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oFabricSizingPlan = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricSizingPlan));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        
        $("#txtDispoNo").val(_oFabricSizingPlan.ExeNo);
        $("#txtBuyerName").val(_oFabricSizingPlan.ContractorName);
        $("#txtConstruction").val(_oFabricSizingPlan.Construction);
        $("#txtComposition").val(_oFabricSizingPlan.Composition);
        $("#txtReqWarpLength").val(_oFabricSizingPlan.RequiredWarpLength);
        $("#txtWaterQty").val(_oFabricSizingPlan.WaterQty);
        $("#txtWarpBeam").val(_oFabricSizingPlan.WarpBeam);
        
        RefreshList(_oFabricChemicalPlans);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        //$("#MainDiv").data("Products",[]);
    });

    $("#btnUpdateWaterQty").click(function () {
        if (_oFabricSizingPlan ==null || _oFabricSizingPlan.FabricSizingPlanID <=0 ) { alert("Please select a valid item from list."); return ; }        
        var oFabricSizingPlan={
            WaterQty : $("#txtWaterQty").val(),
            WarpBeam : $("#txtWarpBeam").val(),
            FabricSizingPlanID : _oFabricSizingPlan.FabricSizingPlanID
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FabricSizingPlan/UpdateWaterQty",
            traditional: true,
            data: JSON.stringify(oFabricSizingPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFabricSizingPlan = jQuery.parseJSON(data);
                if(oFabricSizingPlan!=null)
                {
                    if(oFabricSizingPlan.ErrorMessage=="" || oFabricSizingPlan.ErrorMessage == null)
                    {
                        alert("Updated Successful");
                        _oFabricSizingPlan = oFabricSizingPlan;
                        $("#txtWaterQty").val(parseFloat(oFabricSizingPlan.WaterQty).toFixed(2))
                    }
                    else
                    {
                        alert(oFabricSizingPlan.ErrorMessage);
                    }
                }
                else
                {
                    alert("Invalid Operation!");
                }

            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    function ProductKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtProduct").val();
            if (oTxtName != null) {
                PickProduct(oTxtName);
            }
        }
        if (event.which == 8) {
            //$("#MainDiv").data("Products",[]);
            txtProduct.style.color="Black";
        }
    }

    function PickProduct(oTxtName)
    {
        debugger;
        if(parseInt(_oFabricSizingPlan.FBID)<=0)
        {
            alert("Fabric Batch Not found!!.");
            return false;
        }

        var oStyleSearch = {
            BUID:_nBUID,
            ProductName: $.trim($("#txtProduct").val())
        };

        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FabricBatch",//FabricSizingPlan
            ActionName: "GetProducts",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: "ProductName", title: "Product Name", width: 150, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductCode", title: "Code", width: 150, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('Product',obj,tblColums,true,'ProductName','ProductID',500);
    }

    function SetProduct(oSelectedStyle) {
        debugger;
        //console.log(document.getElementById("txtProduct").innerHTML);
        //document.getElementById("txtProduct").value = "You select " + oSelectedStyle.length + " Products";
        //$("#MainDiv").data("Products",oSelectedStyle);
        //txtProduct.style.color="Blue";
        if(_oFabricSizingPlan.FabricSizingPlanID<=0)
        {
            alert("Invalid Fabric Sizing Plan!!");
            return false;
        }
        if(_oFabricSizingPlan.FBID<=0)
        {
            alert("Invalid Fabric Batch!!");
            return false;
        }
        var oFabricChemicalPlans=$('#tblFabricChemicalPlans').datagrid('getRows');
        var oProducts = oSelectedStyle;
        for(var i=0;i<oProducts.length;i++){
            var isExist = false;
            for(var j=0;j<oFabricChemicalPlans.length;j++){
                if(oFabricChemicalPlans[j].ProductID == oProducts[i].ProductID){
                    isExist = true;
                    break;
                }
            }
            if(isExist == false){
                var oFabricChemicalPlan={
                    FabricChemicalPlanID : 0,
                    FabricSizingPlanID:_oFabricSizingPlan.FabricSizingPlanID,
                    FBID : _oFabricSizingPlan.FBID,
                    ProductID : oProducts[i].ProductID,
                    ProductName : oProducts[i].ProductName,
                    ProductCode : oProducts[i].ProductCode,
                    MUnitName : oProducts[i].MUnitName,
                    Qty : 0
                };
                $('#tblFabricChemicalPlans').datagrid('appendRow',oFabricChemicalPlan);
            }
        }
    }

    function SetPickerValueAssign(oPickerobj) 
    {
        debugger;
        var oResult;
        if (oPickerobj.multiplereturn)
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }
        else
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winProduct')
        {
            SetProduct(oResult);
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 90){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID,nWidth)
    {
        debugger;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        setInterval(updateProgress,250);

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][pID] > 0) {
                    debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    $("#progressbar").progressbar({ value: 0 });//hide
                    $("#progressbarParent").hide();
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                    $("#progressbar").progressbar({ value: 0 });//hide
                    $("#progressbarParent").hide();
                }
            }
            else{
                alert("Data Not Found.");
                $("#progressbar").progressbar({ value: 0 });//hide
                $("#progressbarParent").hide();
                return;
            }
        });
    }
    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function RefreshList(oFabricChemicalPlanDetails)
    {
        debugger;
        var data=oFabricChemicalPlanDetails;
        data={"total":""+data.length+"","rows":data};
        $('#tblFabricChemicalPlans').datagrid('loadData',data);
    }


    //$("#btnAddDetail").click(function (){
    //    endEditing();
    //    if(_oFabricSizingPlan.FabricSizingPlanID<=0)
    //    {
    //        alert("Invalid Fabric Sizing Plan!!");
    //        return false;
    //    }
    //    if(_oFabricSizingPlan.FBID<=0)
    //    {
    //        alert("Invalid Fabric Batch!!");
    //        return false;
    //    }

    //    var oFabricChemicalPlans=$('#tblFabricChemicalPlans').datagrid('getRows');
    //    var oProducts = $("#MainDiv").data("Products");

    //    for(var i=0;i<oProducts.length;i++){
    //        var isExist = false;
    //        for(var j=0;j<oFabricChemicalPlans.length;j++){
    //            if(oFabricChemicalPlans[j].ProductID == oProducts[i].ProductID){
    //                isExist = true;
    //                break;
    //            }
    //        }
    //        if(isExist == false){
    //            var oFabricChemicalPlan={
    //                FabricChemicalPlanID : 0,
    //                FabricSizingPlanID:_oFabricSizingPlan.FabricSizingPlanID,
    //                FBID : _oFabricSizingPlan.FBID,
    //                ProductID : oProducts[i].ProductID,
    //                ProductName : oProducts[i].ProductName,
    //                ProductCode : oProducts[i].ProductCode,
    //                Qty : $('#txtQty').val()
    //            };
    //            $('#tblFabricChemicalPlans').datagrid('appendRow',oFabricChemicalPlan);
    //        }
    //    }

    //});

    $("#btnSave").click(function (){
        endEditing();
        debugger;
        var oFabricChemicalPlans=$('#tblFabricChemicalPlans').datagrid('getRows');
        if(oFabricChemicalPlans.length <= 0){
            alert("No Detail found!!");
            return false;
        }
        for(var i=0;i<oFabricChemicalPlans.length;i++){
            if(oFabricChemicalPlans[i].Qty <= 0){
                alert("Please enter Qty for Product: " + oFabricChemicalPlans[i].ProductName);
                return;
            }
        }
        //return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $("#btnSave").hide();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricSizingPlan/SaveChemicalPlan",
            traditional: true,
            data:  JSON.stringify(oFabricChemicalPlans),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                oFabricChemicalPlans = jQuery.parseJSON(data);
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if(oFabricChemicalPlans.length > 0){
                    if (oFabricChemicalPlans[0].ErrorMessage=="") {
                        alert("Data Saved successfully");
                        $('#tblFabricChemicalPlans').datagrid('loadData',oFabricChemicalPlans);
                    }
                    else {
                        alert(oFabricChemicalPlans[0].ErrorMessage);
                    }
                }else{
                    alert("No Data found!!");
                }
                $("#btnSave").show();
            },
            error: function (xhr, status, error) {
                alert(error);
                $("#btnSave").show();
            }
        });
    });


    $("#btnRemoveDetail").click(function ()
    {
        endEditing();
        var oFabricChemicalPlan=$('#tblFabricChemicalPlans').datagrid('getSelected');
        if(oFabricChemicalPlan==null)
        {
            alert("Please select a valid item from list.");
            return;
        }
        var nIndex= $('#tblFabricChemicalPlans').datagrid('getRowIndex',oFabricChemicalPlan);
        if(oFabricChemicalPlan.FabricChemicalPlanID <= 0){            
            $('#tblFabricChemicalPlans').datagrid('deleteRow',nIndex);
        }
        else{
            $.ajax
            ({
                type: "GET",
                dataType: "json",                
                url : _sBaseAddress+  "/FabricSizingPlan/DeleteChemicalPlan",
                data: { id: oFabricChemicalPlan.FabricChemicalPlanID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Data delete successfully") 
                    {
                        alert("Delete sucessfully");                        
                        $('#tblFabricChemicalPlans').datagrid('deleteRow',nIndex);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error) 
                {
                    alert(error);
                }
                      
            });
        }
    });

    $("#btnRefreshDetail").click(function ()
    {
        debugger;
        var oFabricChemicalPlan = [];
        var oFabricChemicalPlanDetail = {
            FabricChemicalPlanID: _oFabricChemicalPlan.FabricChemicalPlanID
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricChemicalPlan/GetsDetailsByID",
            traditional: true,
            data:  JSON.stringify(oFabricChemicalPlanDetail),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oFabricChemicalPlan = jQuery.parseJSON(data);
                if (oFabricChemicalPlan.ErrorMessage==null || oFabricChemicalPlan.ErrorMessage=="") {
                    RefreshList(oFabricChemicalPlan.FabricChemicalPlanDetails);
                }
                else {
                    alert(oFabricChemicalPlanDetail.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $('#btnClose').click(function(e){
        //window.location.href = sessionStorage.getItem("BackLink");
        var win = window.open("","_self");
        win.close();
    })

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblFabricChemicalPlans').datagrid('validateRow', editIndex)) {
            $('#tblFabricChemicalPlans').datagrid('endEdit', editIndex);
            $('#tblFabricChemicalPlans').datagrid('selectRow', editIndex);
            //var oESCDetail = $('#tblFabricChemicalPlans').datagrid('getSelected');
            debugger;
            //$('#tblFabricChemicalPlans').datagrid('updateRow', { index: editIndex, row: oESCDetail });

            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblFabricChemicalPlans').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblFabricChemicalPlans').datagrid('getSelected');

                editIndex = index;
            }
            else {
                $('#tblFabricChemicalPlans').datagrid('selectRow', editIndex);
            }
        }
    }

</script>