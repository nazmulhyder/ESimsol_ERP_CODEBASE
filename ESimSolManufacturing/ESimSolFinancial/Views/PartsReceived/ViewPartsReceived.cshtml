@{
    ViewBag.Title = "Parts Received";
}
<html>
<body>
    @model ESimSol.BusinessObjects.GRN
    <div id="divGRN" class="easyui-panel menuMainCollectionTable" title="Parts Received" style="font-family:Tahoma; height:100%; width:100%">
        <div style="width:100%; height:87%; text-align:center">
            <fieldset id="fldGRN" class="bodyfieldsetstyle" style="height:35%">
                <legend style="text-align:left; font-weight:bold;"> Parts Received Informations : </legend>
                <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                    <tr>
                        <td style="width:9%; text-align:right">
                            Rcv Type :
                        </td>
                        <td style="width:16%; text-align:center">
                            <select style="width:100%" id="cboGRNType"></select>
                        </td>
                         <td style="width:9%; text-align:right">
                            Rcv No :
                        </td>
                        <td style="width:13%; text-align:center">
                            <input type="text" style="width:100%" id="txtGRNNo" disabled="disabled" />
                        </td>
                        <td style="width:10%; text-align:right">
                            Rcv Date :
                        </td>
                        <td style="width:16%; text-align:left">
                            <input id="txtGRNDate" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" style="width:100%" />
                        </td>
                        <td style="width:7%; text-align:right">
                            GL Date :
                        </td>
                        <td style="width:20%; text-align:left">
                            <input id="txtGLDate" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" style="width:105%" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:9%; text-align:right">
                            Supplier:
                        </td>
                        <td colspan="3" style="width:39%; text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" width="102%">
                                <tr>
                                    <td style="width:85%">
                                        <input type="text" style="width:98%" id="txtContractorName" placeholder="Press Enter With Vendor Name" />
                                    </td>
                                    <td style="width:15%; text-align:right">
                                        <input type="button" style="width:100%;" id="btnPickContractor" value="Pick" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:10%; text-align:right">
                            Currency :
                        </td>
                        <td style="width:16%; text-align:left">
                            <select style="width:100%" id="cboCurrency" onchange="ChangeCurrency(true);">
                                <option>--Select One--</option>
                            </select>
                        </td>
                        <td style="width:7%; text-align:right">
                            C Rate :
                        </td>
                        <td style="width:20%; text-align:left">
                            <input type="text" style="width:97%" id="txtCRate" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:9%; text-align:right">
                            <label id="lblRefNo" style="font-weight:normal">SO No :</label>
                        </td>
                        <td style="width:12%; text-align:left">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width:85%">
                                        <input type="text" style="width:98%" id="txtRefNo"/>
                                    </td>
                                    <td style="width:15%; text-align:right">
                                        <input type="button" style="width:100%;" id="btnPickRefObject" value="Pick" />
                                    </td>
                                </tr>
                            </table>                            
                        </td>
                        <td style="width:9%; text-align:right">
                            <label id="lblRefDate" style="font-weight:normal">SO Date :</label>
                        </td>
                        <td style="width:13%; text-align:left">
                            <input type="text" style="width:100%" id="txtRefDate" disabled="disabled" />
                        </td>
                        <td style="width:10%; text-align:right">
                            Status :
                        </td>
                        <td style="width:16%; text-align:left">
                            <input type="text" style="width:98%" id="txtStatrus" disabled="disabled" />
                        </td>
                        <td style="width:7%; text-align:right">
                            Remarks :
                        </td>
                        <td style="width:20%; text-align:left">
                            <input type="text" style="width:99.6%" id="txtRemarks" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:9%; text-align:right">
                            Store :
                        </td>
                        <td colspan="3" style="width:39%; text-align:left">
                            <select id="cboStores" style="width:102%;"></select>
                        </td>
                        <td style="width:10%; text-align:right">
                            Challan Date :
                        </td>
                        <td style="width:16%; text-align:left">
                            <input id="txtChallanDate" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" style="width:100%" />
                        </td>
                        <td style="width:7%; text-align:right">
                            Challan No:
                        </td>
                        <td style="width:20%; text-align:left">
                            <input type="text" style="width:99.6%" id="txtChallanNo" />
                        </td>
                    </tr>
                    <tr>
                        <td style="width:9%; text-align:right">
                            Gate Pass No :
                        </td>
                        <td colspan="3" style="width:39%; text-align:left">
                            <input type="text" style="width:100%" id="txtGatePassNo"/>
                        </td>
                        <td style="width:10%; text-align:right">
                            Vehicle No :
                        </td>
                        <td style="width:43%; text-align:left" colspan="3">
                            <input type="text" style="width:100%" id="txtVehicleNo"/>
                        </td>
                    </tr>
                </table>
            </fieldset>
            <div style="height:60%; width:100%">
                <table id="tblGRNDetail" title="Item Descriptions" class="easyui-datagrid" style="width:101%; height:285px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar" data-options="onClickRow: onClickRow">
                    <thead data-options="frozen:true">
                        <tr>
                            <th field="ProductCode" width="12%" align="left">Part No</th>
                            <th field="ProductName" width="22%" align="left">Item Name</th>
                            <th field="ModelShortName" width="10%" align="left">Model No</th>
                            <th field="BuyerName" width="10%" align="left">Buyer Name</th>
                        </tr>
                    </thead>
                    <thead>
                        <tr>                            
                            <th field="ColorName" width="10%" align="left">Color</th>
                            <th field="SizeName" width="10%" align="left">Size</th>                            
                            <th field="MUSymbol" width="8%" align="left">Unit</th>
                            <th field='RefQty' formatter="formatPrice" width="12%" align="right">SO/Invoice Qty</th>
                            <th field='YetToReceiveQty' formatter="formatPrice" width="12%" align="right">Yet To Receive</th>
                            <th data-options="field:'ReceivedQty',align:'right',editor:{type:'numberbox',options:{precision:2}}" formatter="formatPrice" width="12%">Received Qty</th>
                            <th data-options="field:'LotNo',align:'left',editor:{type:'textbox'}" width="20%">Lot No</th>
                            <th data-options="field:'ProjectName',align:'left',editor:{type:'textbox'}" width="15%">Project Name</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="false"></a>          
                    <input type="text" id="txtProductName" style="width:180px" placeholder="Part Name.." disabled />
                    <a id="btnRemoveProduct" style="width:30px" href="javascript:void(0)" class="easyui-linkbutton" plain="false">C</a> 
                    <a id="btnPickItem" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="false">Pick Item</a>
                    <input type="text" id="txtInvoiceQty" style="width:90px" placeholder="SO/Invoice Qty.." disabled />
                    <input type="text" id="txtYeToQty" style="width:90px" placeholder="Yet To Receive.." disabled />
                    <input type="text" id="txtMUnit" style="width:50px" placeholder="M Unit.." disabled />
                    <input type="checkbox" id="IsAutoCheck" href="javascript:void(0)" />
                    <input type="text" id="txtBarCode" style="width:140px" placeholder="Lot No.." />
                    <input type="text" id="txtQty" style="width:90px" placeholder="Rcv Qty.." class="number" />
                    <a id="btnAddGRNDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="false">Add</a>
                    <a id="btnRemove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="false">Remove</a>
                </div>
            </div>
        </div>
        <div style="width:100%; height:10%">
            <fieldset>
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:70%; text-align:right"></td>
                        <td style="width: 20%; text-align:right;">
                            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="false">Approve</a>
                            <a id="btnReceive" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="false">Receive Goods</a>
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="false">Save</a>
                        </td>
                        <td style="width: 10%; text-align:right;">
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="false">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function () {
        var oGRN =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oGRNTypes= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.GRNTypes));
        var oCurrencys= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Currencys));
        var oCompany= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Company));
        var oStores = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Stores));        

        $('#txtChallanDate').datebox('setValue',icsdateformat(new Date()));
        $('#txtGRNDate').datebox('setValue',icsdateformat(new Date()));
        $('#txtGLDate').datebox('setValue',icsdateformat(new Date()));        
        $('#divGRN').data('GRN', oGRN);
        $('#cboGRNType').data('GRNTypes', oGRNTypes);
        $('#cboCurrency').data('Currencys', oCurrencys);
        $('#divGRN').data('Company', oCompany);
        $('#cboStores').data('Stores', oStores);
        $('#txtProductName').data('Product',[]);
        var sGRNHeader=sessionStorage.getItem("GRNHeader");
        $('#divGRN').panel({ title:sGRNHeader});
        RefreshControl(oGRN);
        if(sGRNHeader=="View Goods Received Note" || sGRNHeader=="Confirm Goods Received Note" || sGRNHeader=="Approve Goods Received Note")
        {
            $('#fldGRN input,select').prop('disabled',true);
            $('#txtGRNDate').datebox({disabled:true});
            $('#txtGLDate').datebox({disabled:true});
            $('#txtChallanDate').datebox({disabled:true});
            $('#txtGRNDate').datebox('setValue', oGRN.GRNDateSt);
            $('#txtGLDate').datebox('setValue', oGRN.GLDateSt);
            $('#txtChallanDate').datebox('setValue', oGRN.ChallanDateSt);
            $('#btnSave').hide();
            $('#btnApprove').hide();
            $('#btnReceive').hide();
            if(sGRNHeader=="Approve Goods Received Note")
            {
                $('#btnApprove').show();
                $('#btnReceive').hide();
            }
            else if(sGRNHeader=="Confirm Goods Received Note"){
                $('#btnApprove').hide();
                $('#btnReceive').show();
            }
        }
        else {
            $('#btnApprove').hide();
            $('#btnReceive').hide();
            $('#btnSave').show();
        }
    });

    $('#txtBarCode').keypress(function(){
        if($('#IsAutoCheck').is(':checked'))
        {
            if($('#txtBarCode').val().length>5)
            {
                $('#txtQty').val(1);
                AddGRNDetail();
            }
        }
    });

    $('#IsAutoCheck').tooltip({
        position: 'right',
        content: '<span style="color:#fff">This is the tooltip message.</span>',
        onShow: function(){
            $(this).tooltip('tip').css({
                backgroundColor: '#666',
                borderColor: '#666'
            });
        }
    });

    $("#txtCRate").keypress(function (e) {
        if (e.which != 8 && e.which != 0  && e.which != 46  && (e.which < 48 || e.which > 57)) {
            return false;
        }
    });

    function RefreshControl(oGRN)
    {
        RefreshComboBoxes();
        $('#cboGRNType').val(oGRN.GRNTypeInt);
        $('#txtGRNNo').val(oGRN.GRNNo);
        $('#txtGRNDate').datebox('setValue', oGRN.GRNDateSt);
        $('#txtGLDate').datebox('setValue', oGRN.GLDateSt);
        $('#txtContractorName').val(oGRN.ContractorName);
        $('#txtStatrus').val(oGRN.GRNStatusSt);
        $('#txtRefNo').val(oGRN.RefObjectNo);
        $('#txtRefDate').val(oGRN.RefObjectDateSt);
        $('#cboCurrency').val(oGRN.CurrencyID);
        $('#txtCRate').val(parseFloat(oGRN.ConversionRate).toFixed(3));
        $('#txtRemarks').val(oGRN.Remarks);
        $('#cboStores').val(parseInt(oGRN.StoreID));
        $('#txtChallanDate').datebox('setValue', oGRN.ChallanDateSt);
        $('#txtGatePassNo').val(oGRN.GatePassNo);
        $('#txtVehicleNo').val(oGRN.VehicleNo);
        $('#txtChallanNo').val(oGRN.ChallanNo);
        if(parseInt(oGRN.ContractorID)>0)
        {
            $('#txtContractorName').addClass('fontColorOfPickItem');
        }
        if(parseInt(oGRN.RefObjectID)>0)
        {
            $('#txtRefNo').addClass('fontColorOfPickItem');
            $('#txtRefDate').addClass('fontColorOfPickItem');
        }
        var sGRNHeader=sessionStorage.getItem("GRNHeader");
        $("#btnPickRefObject").prop("disabled", (sGRNHeader=="View Goods Received Note" || sGRNHeader=="Confirm Goods Received Note" || sGRNHeader=="Approve Goods Received Note"));
        $("#cboCurrency").prop("disabled", (sGRNHeader=="View Goods Received Note" || sGRNHeader=="Confirm Goods Received Note" || sGRNHeader=="Approve Goods Received Note"));
        $("#txtCRate").prop("disabled", (sGRNHeader=="View Goods Received Note" || sGRNHeader=="Confirm Goods Received Note" || sGRNHeader=="Approve Goods Received Note"));
        DynamicRefreshList($('#divGRN').data('GRN').GRNDetails, 'tblGRNDetail');
        ChangeCurrency(false);
        RefreshGridColumn();
    }

    function RefreshComboBoxes()
    {
        var oGRNTypes=$('#cboGRNType').data('GRNTypes');
        var oCurrencys =$('#cboCurrency').data('Currencys');
        var oVoucherBatchs= $('#cboBatch').data('VoucherBatchs');
        var oStores= $('#cboStores').data('Stores');

       // oGRNTypes.splice(0,1);
        $("#cboGRNType").icsLoadCombo({List: oGRNTypes,OptionValue: "id",DisplayText: "Value",InitialValue:'Default'});

        $("#cboCurrency").icsLoadCombo({
            List: oCurrencys,
            OptionValue: "CurrencyID",
            DisplayText: "CurrencyName"
        });

        $("#cboStores").icsLoadCombo({
            List: oStores,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName"

        });
    }

    $('#cboGRNType').change(function(){
        GRNTypeChange(true);
    });

    function GRNTypeChange(bIsComboChange)
    {
        //EnumGRNType : LocalInvoice = 1, ImportInvoice = 2, WorkOrder = 3, Service = 4,FancyYarn = 5,ImportPI = 6, FloorReturn = 7, PurchaseOrder = 8 
        var nGRNType = parseInt($('#cboGRNType').val());
        if(nGRNType===1 || nGRNType===2)
        {
            $('#lblRefNo').html('Invoice No :');
            $('#lblRefDate').html('Invoice Date :');
        }else if(nGRNType===3)// For Work Order
        {
            $('#lblRefNo').html('WO No :');
            $('#lblRefDate').html('WO Date :');
        }
        else if(nGRNType===4)// For Servise Invoice
        {
            $('#lblRefNo').html('Contract No :');
            $('#lblRefDate').html('Date :');
        }
        else if(nGRNType===5)// For Servise Invoice
        {
            $('#lblRefNo').html('Invoice No :');
            $('#lblRefDate').html('Invoice Date :');
        }
        else if(nGRNType===6)// For Import PI
        {
            $('#lblRefNo').html('Import PI :');
            $('#lblRefDate').html('PI Date :');
        }
        else if(nGRNType===7)// For Floor Return
        {
            $('#txtContractorName').val('');
            $('#divGRN').data('GRN').ContractorID = 0;
            $('#divGRN').data('GRN').ContractorName = "";
            $('#btnPickContractor').prop('disabled', true);
            $('#txtContractorName').prop('disabled', true);

            $('#lblRefNo').html('Style No :');
            $('#lblRefDate').html('Issue Date :');
        }
        else if(nGRNType===8)// For Purchase Order
        {
            $('#lblRefNo').html('SO No :');
            $('#lblRefDate').html('SO Date :');
        }

        $('#txtRefNo').val('');
        $('#txtRefDate').val('');
        $('#divGRN').data('GRN').RefObjectID=0;
        $('#cboCurrency').val(0);
        $('#txtCRate').val(parseFloat(0).toFixed(3));
        $("#btnPickRefObject").prop("disabled", false);
        $('#btnPickItem').show();
        $("#cboCurrency").prop("disabled", true);
        $("#txtCRate").prop("disabled", true);
        DynamicRefreshList([], 'tblGRNDetail');
        RefreshGridColumn();
    }

    function RefreshGridColumn()
    {
        //EnumGRNType : LocalInvoice = 1, ImportInvoice = 2, WorkOrder = 3, ImportPI = 6, FloorReturn = 7,  PurchaseOrder = 8 
        debugger;
        var nGRNType = parseInt($('#cboGRNType').val());
        if(nGRNType===1 || nGRNType===2 || nGRNType===6 || nGRNType===7 || nGRNType===8)
        {
            $('#tblGRNDetail').datagrid('hideColumn', 'ColorName');
            $('#tblGRNDetail').datagrid('hideColumn', 'SizeName');
            //$('#tblGRNDetail').datagrid('hideColumn', 'StyleNo');
            $('#tblGRNDetail').datagrid('hideColumn', 'BuyerName');
            //$('#tblGRNDetail').datagrid('showColumn', 'TechnicalSpecification');
        }
        else
        {
            //$('#tblGRNDetail').datagrid('hideColumn', 'TechnicalSpecification');
            //$('#tblGRNDetail').datagrid('hideColumn', 'StyleNo');
            $('#tblGRNDetail').datagrid('hideColumn', 'BuyerName');
            $('#tblGRNDetail').datagrid('showColumn', 'ColorName');
            $('#tblGRNDetail').datagrid('showColumn', 'SizeName');
        }

        if(nGRNType==1)
        {
            $('#tblGRNDetail').datagrid('showColumn', 'ProjectName');
        }else{
            $('#tblGRNDetail').datagrid('hideColumn', 'ProjectName');
        }
        if(nGRNType===2 || nGRNType===3 || nGRNType===6 )
        {
            //$('#tblGRNDetail').datagrid('showColumn', 'StyleNo');
            $('#tblGRNDetail').datagrid('showColumn', 'BuyerName');
        }
    }

    function ChangeCurrency(bIsComboChange)
    {
        var nCurrencyID = parseInt($('#cboCurrency').val());
        var oCurrencys =$('#cboCurrency').data('Currencys');

        var oCompany = $('#divGRN').data('Company');
        if(nCurrencyID=== parseInt(oCompany.BaseCurrencyID))
        {
            $('#txtCRate').val(parseFloat(1).toFixed(3));
            $("#txtCRate").prop("disabled", true);
        }
        else
        {
            if(bIsComboChange)
            {
                $('#txtCRate').val(parseFloat(0).toFixed(3));
            }
            $("#txtCRate").prop("disabled", false);
        }
    }

    function ValidateInput()
    {
        var oGRN=$('#divGRN').data('GRN');

        if (parseInt($("#cboGRNType").val()) === 0) {
            alert("Please slect GRN Type");
            $("#cboGRNType").addClass("errorFieldBorder");
            $("#cboGRNType").focus();
            return false;
        } else {
            $("#cboGRNType").removeClass("errorFieldBorder");
        }


        var txtGRNDate = $('#txtGRNDate').datebox('getValue');
        if(txtGRNDate === null || txtGRNDate==="")
        {
            alert("Please Select GRN Date!");
            return false;
        }

        var txtGLDate = $('#txtGLDate').datebox('getValue');
        if(txtGLDate === null || txtGLDate==="")
        {
            alert("Please Select GL Date!");
            return false;
        }

        if (parseInt($("#cboGRNType").val()) != 7) {
            if (!parseInt(oGRN.ContractorID) || parseInt(oGRN.ContractorID)<=0) {
                alert("Please slect an Vendor!");
                $("#txtContractorName").addClass("errorFieldBorder");
                $("#txtContractorName").focus();
                return false;
            } else {
                $("#txtContractorName").removeClass("errorFieldBorder");
            }
        }



        if ($("#cboCurrency").val()=== null ||  $("#cboCurrency").val()=== "" ||  parseInt($("#cboCurrency").val()) === 0) {
            alert("Please slect Currency!");
            $("#cboCurrency").addClass("errorFieldBorder");
            $("#cboCurrency").focus();
            return false;
        } else {
            $("#cboCurrency").removeClass("errorFieldBorder");
        }

        if ($("#txtCRate").val() ===null || $("#txtCRate").val()==="" || parseFloat($("#txtCRate").val()) <= 0) {
            alert("Please slect Conversion Rate!");
            $("#txtCRate").addClass("errorFieldBorder");
            $("#txtCRate").focus();
            return false;
        } else {
            $("#txtCRate").removeClass("errorFieldBorder");
        }

        if ($("#cboStores").val()=== null ||  $("#cboStores").val()=== "" ||  parseInt($("#cboStores").val()) === 0) {
            alert("Please slect received Store!");
            $("#cboStores").addClass("errorFieldBorder");
            $("#cboStores").focus();
            return false;
        } else {
            $("#cboStores").removeClass("errorFieldBorder");
        }

        var txtChallanDate = $('#txtChallanDate').datebox('getValue');
        if(txtChallanDate === null || txtChallanDate==="")
        {
            alert("Please Select Challan Date!");
            return false;
        }

        if ($("#txtChallanNo").val()=== null ||  $("#txtChallanNo").val()=== "") {
            alert("Please slect enter Challan no!");
            $("#txtChallanNo").addClass("errorFieldBorder");
            $("#txtChallanNo").focus();
            return false;
        } else {
            $("#txtChallanNo").removeClass("errorFieldBorder");
        }


        var oGRNDetails = $('#tblGRNDetail').datagrid('getRows');
        if(oGRNDetails===null || oGRNDetails.length<=0)
        {
            alert("Please enter at least one item(s)!")
            return;
        }
        var  nGRNType = $('#cboGRNType').val();
        for(var i=0; i<oGRNDetails.length; i++)
        {
            if(parseFloat(oGRNDetails[i].ReceivedQty)<=0)
            {
                alert("Please enter received qty for : "+ oGRNDetails[i].ProductName);
                return false;
            }
        }
        return true;
    }

    function RefreshObject()
    {
        var oTempGRN=$('#divGRN').data('GRN');
        var oGRN= {
            GRNID : parseInt(oTempGRN.GRNID),
            GRNNo : oTempGRN.GRNNo,
            GRNDate : $('#txtGRNDate').datebox('getValue'),
            GLDate :$('#txtGLDate').datebox('getValue'),
            GRNTypeInt :parseInt($('#cboGRNType').val()),
            GRNStatusInt : parseInt(oTempGRN.GRNStatusInt),
            BUID :sessionStorage.getItem('BUID'),
            ContractorID : parseInt(oTempGRN.ContractorID),
            RefObjectID : parseInt(oTempGRN.RefObjectID),
            GatePassNo:$('#txtGatePassNo').val(),
            VehicleNo:$('#txtVehicleNo').val(),
            Remarks : $('#txtRemarks').val(),
            CurrencyID: parseInt($('#cboCurrency').val()),
            ConversionRate : parseFloat($('#txtCRate').val()),
            ApproveBy : parseInt(oTempGRN.ApproveBy),
            ApproveDate : oTempGRN.ApproveDateSt,
            StoreID: parseInt($('#cboStores').val()),
            ChallanDate :$('#txtChallanDate').datebox('getValue'),
            ChallanNo: $.trim($('#txtChallanNo').val()),
            GRNDetails : $('#tblGRNDetail').datagrid('getRows')
        };
        return oGRN;
    }

    $("#btnSave").click(function(){
        endEditing();

        if(!ValidateInput()) return;
        var oGRN=RefreshObject();
        $('#btnSave').hide();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/PartsReceived/Save",
            traditional: true,
            data:  JSON.stringify(oGRN),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oGRN = jQuery.parseJSON(data);
                $('#btnSave').show();
                if (oGRN.ErrorMessage == '' || oGRN.ErrorMessage == null)
                {
                   
                    if(oGRN.GRNID>0)
                    {
                        alert("Data Save Successfully");
                        $('#txtGRNNo').val(oGRN.GRNNo);
                        var oGRNs =sessionStorage.getItem("GRNs");
                        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if(oGRNs!=null)
                        {
                            oGRNs = jQuery.parseJSON(oGRNs);
                        }
                        else
                        {
                            oGRNs=[];
                        }
                        if(nIndex!=-1)
                        {
                            oGRNs[nIndex]=oGRN;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oGRNs.length);
                            oGRNs.push(oGRN);
                        }
                        sessionStorage.setItem("GRNs", JSON.stringify(oGRNs));
                        window.location.href = sessionStorage.getItem('BackLink');
                    }
                    else
                    {
                        alert("Invalid Operation!");
                    }
                }
                else
                {
                    alert(oGRN.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });

    $("#btnApprove").click(function(){
        endEditing();

        if(!ValidateInput()) return false;
        if(!confirm('Confirm to Approve?')){return false;}
        var oGRN=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/PartsReceived/Approve",
            traditional: true,
            data:  JSON.stringify(oGRN),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oGRN = jQuery.parseJSON(data);
                if (oGRN.ErrorMessage == '' || oGRN.ErrorMessage == null)
                {
                    if(oGRN.GRNID>0)
                    {
                        alert("Approved Successfully");
                        var oGRNs =sessionStorage.getItem("GRNs");
                        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if(oGRNs!=null)
                        {
                            oGRNs = jQuery.parseJSON(oGRNs);
                        }
                        else
                        {
                            oGRNs=[];
                        }
                        if(nIndex!=-1)
                        {
                            oGRNs[nIndex]=oGRN;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oGRNs.length);
                            oGRNs.push(oGRN);
                        }
                        sessionStorage.setItem("GRNs", JSON.stringify(oGRNs));
                        window.location.href = sessionStorage.getItem('BackLink');
                    }
                    else
                    {
                        alert("Invalid Operation!");
                    }
                }
                else
                {
                    alert(oGRN.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });

    $("#btnReceive").click(function(){
        endEditing();
        if(!ValidateInput()) return false;
        if(!confirm('Confirm to Receive?')){return false;}
        var oGRN=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress')+  "/PartsReceived/Receive",
            traditional: true,
            data:  JSON.stringify(oGRN),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oGRN = jQuery.parseJSON(data);
                if (oGRN.ErrorMessage == '' || oGRN.ErrorMessage == null)
                {
                    if(oGRN.GRNID>0)
                    {
                        alert("Goods Received Successfully");
                        var oGRNs =sessionStorage.getItem("GRNs");
                        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if(oGRNs!=null)
                        {
                            oGRNs = jQuery.parseJSON(oGRNs);
                        }
                        else
                        {
                            oGRNs=[];
                        }
                        if(nIndex!=-1)
                        {
                            oGRNs[nIndex]=oGRN;
                        }
                        else
                        {
                            sessionStorage.setItem("SelectedRowIndex", oGRNs.length);
                            oGRNs.push(oGRN);
                        }
                        sessionStorage.setItem("GRNs", JSON.stringify(oGRNs));
                        window.location.href = sessionStorage.getItem('BackLink');
                    }
                    else
                    {
                        alert("Invalid Operation!");
                    }
                }
                else
                {
                    alert(oGRN.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(xhr+'~' +status+'~'+error);
            }
        });
    });

    $("#btnClose").click(function(){
        window.location.href = sessionStorage.getItem('BackLink');
    });

 var editIndex = undefined;
 function endEditing() {
     if (editIndex == undefined) { return true }
     if ($('#tblGRNDetail').datagrid('validateRow', editIndex)) {
         $('#tblGRNDetail').datagrid('endEdit', editIndex);
         $('#tblGRNDetail').datagrid('selectRow', editIndex);
         var oGRNDetail = $('#tblGRNDetail').datagrid('getSelected');
         if(oGRNDetail.IsSerialNoApply){oGRNDetail.ReceivedQty=1;}
         oGRNDetail.Amount = parseFloat(parseFloat(oGRNDetail.ReceivedQty) * parseFloat(oGRNDetail.UnitPrice));
         $('#tblGRNDetail').datagrid('updateRow', { index: editIndex, row: oGRNDetail });
         editIndex = undefined;
         return true;
     }
     else {
         return false;
     }
 }

 function onClickRow(index) {
     if (editIndex != index) {
         if (endEditing()) {
             $('#tblGRNDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
             var oGRNDetail= $('#tblGRNDetail').datagrid('getSelected');
             editIndex = index;
         }
         else {
             $('#tblGRNDetail').datagrid('selectRow', editIndex);
         }
     }
 }

 $("#btnPickContractor").click(function () {

     var sContractorName=$.trim($("#txtContractorName").val());
     _bIsIssueTo=true;
     GetContractors(sContractorName);
 });

 $("#txtContractorName").keydown(function (e) {
     var nkeyCode = e.keyCode || e.which;
     if(nkeyCode==13){
         var sContractorName=$.trim($("#txtContractorName").val());
         _bIsIssueTo=true;
         GetContractors(sContractorName);
     }
     else if(nkeyCode==8){
         $("#txtContractorName").val("");
         _nContractorID=0;
         $("#cboCPIssueTo").empty();
     }
 });
 $("#btnResetContractor").click(function () {
     $("#txtContractorName").val("");
     _nContractorID=0;
 });

 function GetContractors(sContractorName){

     var oContractor = {
         Params: '1' +'~'+sContractorName+'~'+sessionStorage.getItem('BUID'),
     };
     var obj = {
         BaseAddress: sessionStorage.getItem('BaseAddress'),
         Object: oContractor,
         ControllerName: "Contractor",
         ActionName: "ContractorSearchByNameType",
         IsWinClose: false
     };

     $.icsDataGets(obj, function (response) {

         if (response.status && response.objs.length > 0) {
             if (response.objs[0].ContractorID > 0) {

                 var tblColums = [];
                 var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                 oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                 oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);

                 var oPickerParam = {
                     winid: 'winContractorPicker',
                     winclass:'clsContractorPicker',
                     winwidth: 460,
                     winheight: 460,
                     tableid: 'tblContractorPicker',
                     tablecolumns: tblColums,
                     datalist: response.objs,
                     multiplereturn: false,
                     searchingbyfieldName:'Name',
                     windowTittle: 'Contractor List'
                 };
                 $.icsPicker(oPickerParam);
                 IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
             }
             else { alert(response.objs[0].ErrorMessage); }
         }
         else{
             alert("No contractor found.");
         }
     });
 }

 //Ref Object Part
 $("#btnPickRefObject").click(function () {
     var nType = $('#cboGRNType').val();
     var nGRNType = parseInt($('#cboGRNType').val());
     if(nGRNType===0)
     {
         alert("Please select GRN Type!");
         return;
     }

     if(nGRNType===7)
     {
         if($('#txtRefNo').val()===null || $('#txtRefNo').val()==="")
         {
             alert("Please Pick With Style No!");
             return;
         }
     }

     var oGRN = {
         BUID : parseInt(sessionStorage.getItem('BUID')),
         GRNTypeInt : nGRNType,
         RefObjectNo : $.trim($('#txtRefNo').val()),
         ContractorID : parseInt($('#divGRN').data('GRN').ContractorID)
     };
     if(parseInt(nGRNType)===1 )
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsPurchaseInvocie",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].PurchaseInvoiceID > 0) {
                     var tblColums = [];var oColumn = { field: "PurchaseInvoiceNo", title: "Invoice No", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "BillNo", title: "Bill No", width: 80, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "DateofInvoiceSt", title: "Invoice Date", width: 80, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "ContractorName", title: "Vendor Name", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "ProductName", title: "Product Name", width: 120, align: "left" };tblColums.push(oColumn);
                     var oPickerParam = {
                         winid: 'winPurchaseInvoices',
                         winclass: 'clsPurchaseInvoice',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblPurchaseInvoices',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'PurchaseInvoiceNo',
                         windowTittle: 'Purchase Invoice List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert(response.objs[0].ErrorMessage); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }
     else if(parseInt(nGRNType)===2 || parseInt(nGRNType)===4 || parseInt(nGRNType)===5)
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsImportInvocie",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].RefObjectID > 0) {
                     var tblColums = [];var oColumn = { field: "RefObjectNo", title: "Invoice No", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "RefObjectDateSt", title: "Invoice Date", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "ContractorName", title: "Vendor Name", width: 150, align: "left" };tblColums.push(oColumn);

                     var oPickerParam = {
                         winid: 'winImportInvoices',
                         winclass: 'clsImportInvoice',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblImportInvoices',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'RefObjectNo',
                         windowTittle: 'Import Invoice List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert("Data Not Found!"); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }
     else if(parseInt(nGRNType)===3)
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsWorkOrder",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].WorkOrderID > 0) {
                     var tblColums = [];var oColumn = { field: "FullFileNo", title: "File No", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "WorkOrderNo", title: "WO No", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "WorkOrderDateSt", title: "WO Date", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "SupplierName", title: "Supplier Name", width: 150, align: "left" };tblColums.push(oColumn);

                     var oPickerParam = {
                         winid: 'winWorkOrder',
                         winclass: 'clsWorkOrder',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblWorkOrder',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'FileNo',
                         windowTittle: 'Work Order List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert("Data Not Found!"); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }
     else if(parseInt(nGRNType)===6)
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsImportPIs",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].ImportPIID > 0) {
                     var tblColums = [];var oColumn = { field: "ImportPINo", title: "ImportPI No", width: 125, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "ImportLCNo", title: "ImportLC No", width: 125, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "IssueDateSt", title: "Issue Date", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "SupplierName", title: "Supplier Name", width: 150, align: "left" };tblColums.push(oColumn);

                     var oPickerParam = {
                         winid: 'winImportPI',
                         winclass: 'clsImportPI',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblImportPI',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'ImportPINo',
                         windowTittle: 'ImportPI List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert("Data Not Found!"); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }
     else if(parseInt(nGRNType)===7)
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsConsumptions",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].ConsumptionRequisitionID > 0) {
                     var tblColums = [];var oColumn = { field: "RefNo", title: "Ref No", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "RequisitionNo", title: "Requisition No", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "IssueDateSt", title: "Issue Date", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "RequisitionForName", title: "Style No", width: 150, align: "left" };tblColums.push(oColumn);

                     var oPickerParam = {
                         winid: 'winConsumption',
                         winclass: 'clsConsumption',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblConsumption',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'RequisitionForName',
                         windowTittle: 'Style List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert("Data Not Found!"); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }else if(parseInt(nGRNType)===8 )//for PO
     {
         var obj = {
             BaseAddress: sessionStorage.getItem('BaseAddress'),
             Object: oGRN,
             ControllerName: "PartsReceived",
             ActionName: "GetsPurchaseOrders",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].POID > 0) {
                     var tblColums = [];var oColumn = { field: "PONo", title: "Invoice No", width: 100, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "PODateSt", title: "SO Date", width: 80, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "ContractorName", title: "Vendor Name", width: 150, align: "left" };tblColums.push(oColumn);
                     oColumn = { field: "YetToGRNQty",formatter:formatPrice,  title: "Qty", width: 100, align: "right" };tblColums.push(oColumn);
                     var oPickerParam = {
                         winid: 'winPurchaseOrders',
                         winclass: 'clsPurchaseOrder',
                         winwidth: 500,
                         winheight: 420,
                         tableid: 'tblPurchaseOrders',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: false,
                         searchingbyfieldName: 'PONo',
                         windowTittle: 'Purchase Order List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert(response.objs[0].ErrorMessage); }
             }
             else
             {
                 alert("Data Not Found!");
             }
         });
     }
 });

//Item with reference
 $("#btnPickItem").click(function () {
     var nGRNType = parseInt($('#cboGRNType').val());
     if(parseInt($('#divGRN').data('GRN').RefObjectID)<=0)
     {
         if(nGRNType===1)
         {
             alert("Please slect an Local Invoice!");
             return false;
         }
         else if(nGRNType===2||nGRNType===4||nGRNType===5)
         {
             alert("Please slect an Import Invoice!");
             return false;
         }
         else if(nGRNType===3)
         {
             alert("Please slect an Work Order!");
             return false;
         }
         else if(nGRNType===6)
         {
             alert("Please slect an Import PI!");
             return false;
         }
         else if(nGRNType===7)
         {
             alert("Please slect an Style!");
             return false;
         }else if(nGRNType===8)//PO
         {
             alert("Please slect an Purchase Order!");
             return false;
         }
     }
     var oGRN = {
         GRNTypeInt : nGRNType,
         RefObjectID : parseInt($('#divGRN').data('GRN').RefObjectID)
     };
     var obj = {
         BaseAddress: sessionStorage.getItem('BaseAddress'),
         Object: oGRN,
         ControllerName: "PartsReceived",
         ActionName: "GetsRefItems",
         IsWinClose: false
     };
     $.icsDataGets(obj, function (response) {

         if (response.status && response.objs.length > 0) {
             if (response.objs[0].ProductID > 0) {
                 var tblColums = [];var oColumn = { field: "ProductCode", title: "Part No", width: 80, align: "left" };tblColums.push(oColumn);
                 oColumn = { field: "ProductName", title: "Item Name", width: 150, align: "left" };tblColums.push(oColumn);
                 oColumn = { field: "RefQty", title: "Yet To GRN", width: 100, align: "right" };tblColums.push(oColumn);
                 oColumn = { field: "MUSymbol", title: "Unit", width: 80, align: "left" };tblColums.push(oColumn);
                 oColumn = { field: "ModelShortName", title: "Model", width:140, align: "left" };tblColums.push(oColumn);
                 var oPickerParam = {
                     winid: 'winRefItems',
                     winclass: 'clsRefItem',
                     winwidth: 700,
                     winheight: 420,
                     tableid: 'tblRefItems',
                     tablecolumns: tblColums,
                     datalist: response.objs,
                     multiplereturn: false,
                     searchingbyfieldName: 'ProductName',
                     windowTittle: 'Item List'
                 };
                 $.icsPicker(oPickerParam);
                 IntializePickerbutton(oPickerParam);
             }
             else { alert(response.objs[0].ErrorMessage); }
         }
         else
         {
             alert("Data Not Found!");
         }
     });
 });
 
 function IntializePickerbutton(oPickerobj) {

     $("#" + oPickerobj.winid).find("#btnOk").click(function () {

         //for Single Select
         SetPickerValueAssign(oPickerobj);
     });
     $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
         if (e.which == 13)//enter=13
         {
             SetPickerValueAssign(oPickerobj);

         }
     });
 }

 function SetPickerValueAssign(oPickerobj) {
     var oreturnObj = null, oreturnobjs = [];
     if (oPickerobj.multiplereturn) {
         oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
     } else {
         oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
     }
     $("#" + oPickerobj.winid).icsWindow("close");
     $("#" + oPickerobj.winid).remove();
     if (oPickerobj.winid == 'winContractorPicker') {
         if (oreturnObj != null && oreturnObj.ContractorID > 0) {
             $('#txtContractorName').val(oreturnObj.Name);
             $('#txtContractorName').addClass('fontColorOfPickItem');
             $('#divGRN').data('GRN').ContractorID = parseInt(oreturnObj.ContractorID);
             $('#divGRN').data('GRN').ContractorName = oreturnObj.Name;
             $('#txtRefNo').focus();
         }
     }   
     else if (oPickerobj.winid == 'winItemPicker') 
     {
         if (oreturnObj != null && oreturnObj.ProductID > 0) {
             if(!IsItemExist(oreturnObj.ProductID))
             {
                 var oGRNDetails = $('#tblGRNDetail').datagrid('getRows');
                 var nIndex = oGRNDetails.length;
                 var oGRNDetail = MapGRNDetailObject(oreturnObj);
                 $('#tblGRNDetail').datagrid('appendRow',oGRNDetail);
                 $('#tblGRNDetail').datagrid('selectRow', nIndex);
             }
             else
             {
                 alert("Your Selected Item Already Exists!");
             }
         }
     } else if (oPickerobj.winid == 'winPurchaseInvoices') {
         if (oreturnObj != null && oreturnObj.PurchaseInvoiceID > 0) {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.PurchaseInvoiceID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.PurchaseInvoiceNo;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.DateofInvoiceSt;
             $('#txtRefNo').val(oreturnObj.PurchaseInvoiceNo);
             $('#txtRefDate').val(oreturnObj.DateofInvoiceSt);
             $('#txtRefNo').addClass('fontColorOfPickItem');
             $('#txtRefDate').addClass('fontColorOfPickItem');
             $('#cboCurrency').val(oreturnObj.CurrencyID);
             $('#txtCRate').val(parseFloat(oreturnObj.ConvertionRate).toFixed(3));
             $('#divGRN').data('GRN').BUID = parseInt(oreturnObj.BUID);
             $('#divGRN').data('GRN').BusinessUnitName = oreturnObj.BUName;

         }
     }else if (oPickerobj.winid == 'winPurchaseOrders') {
         if (oreturnObj != null && oreturnObj.POID > 0) {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.POID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.PONo;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.PODateSt;
             $('#txtRefNo').val(oreturnObj.PONo);
             $('#txtRefDate').val(oreturnObj.PODateSt);
             $('#txtRefNo').addClass('fontColorOfPickItem');
             $('#txtRefDate').addClass('fontColorOfPickItem');
             $('#cboCurrency').val(oreturnObj.CurrencyID);
             $('#txtCRate').val(parseFloat(oreturnObj.CRate).toFixed(3));
             $('#divGRN').data('GRN').BUID = parseInt(oreturnObj.BUID);
             $('#divGRN').data('GRN').BusinessUnitName = oreturnObj.BUName;

         }
     }
     else if (oPickerobj.winid == 'winImportInvoices')
     {
         if (oreturnObj != null && oreturnObj.RefObjectID > 0)
         {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.RefObjectID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.RefObjectNo;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.RefObjectDateSt;
             $('#txtRefNo').val(oreturnObj.RefObjectNo);
             $('#txtRefDate').val(oreturnObj.RefObjectDateSt);
             $('#txtContractorName').val(oreturnObj.ContractorName);
             $('#txtRefNo,#txtRefDate,#txtContractorName').addClass('fontColorOfPickItem');
             $('#divGRN').data('GRN').ContractorID = parseInt(oreturnObj.ContractorID);
             $('#divGRN').data('GRN').ContractorName = oreturnObj.ContractorName;
             $('#cboCurrency').val(oreturnObj.CurrencyID);
             $('#txtCRate').val(parseFloat(oreturnObj.ConversionRate).toFixed(3));
         }
     }
     else if (oPickerobj.winid == 'winWorkOrder')
     {
         if (oreturnObj != null && oreturnObj.WorkOrderID > 0)
         {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.WorkOrderID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.FileNo;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.WorkOrderDateSt;
             $('#txtRefNo').val(oreturnObj.FileNo);
             $('#txtRefDate').val(oreturnObj.WorkOrderDateSt);
             $('#txtContractorName').val(oreturnObj.SupplierName);
             $('#txtRefNo,#txtRefDate,#txtContractorName').addClass('fontColorOfPickItem');
             $('#divGRN').data('GRN').ContractorID = parseInt(oreturnObj.SupplierID);
             $('#divGRN').data('GRN').ContractorName = oreturnObj.SupplierName;
             $('#cboCurrency').val(oreturnObj.CurrencyID);
             $('#txtCRate').val(parseFloat(oreturnObj.CRate).toFixed(3));
         }
     }
     else if (oPickerobj.winid == 'winImportPI')
     {
         if (oreturnObj != null && oreturnObj.ImportPIID > 0)
         {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.ImportPIID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.ImportPINo;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.IssueDateSt;
             $('#txtRefNo').val(oreturnObj.ImportPINo);
             $('#txtRefDate').val(oreturnObj.IssueDateSt);
             $('#txtContractorName').val(oreturnObj.SupplierName);
             $('#txtRefNo,#txtRefDate,#txtContractorName').addClass('fontColorOfPickItem');
             $('#divGRN').data('GRN').ContractorID = parseInt(oreturnObj.SupplierID);
             $('#divGRN').data('GRN').ContractorName = oreturnObj.SupplierName;
             $('#cboCurrency').val(oreturnObj.CurrencyID);
             $('#txtCRate').val('78.00');
             $('#cboCurrency,#txtCRate').prop('disabled', false);
         }
     }
     else if (oPickerobj.winid == 'winConsumption')
     {
         if (oreturnObj != null && oreturnObj.ConsumptionRequisitionID > 0)
         {
             $('#divGRN').data('GRN').RefObjectID = parseInt(oreturnObj.ConsumptionRequisitionID);
             $('#divGRN').data('GRN').RefObjectNo = oreturnObj.RequisitionForName;
             $('#divGRN').data('GRN').RefObjectDateSt = oreturnObj.IssueDateSt;
             $('#txtRefNo').val(oreturnObj.RequisitionForName);
             $('#txtRefDate').val(oreturnObj.IssueDateSt);
             $('#txtContractorName').val('');
             $('#txtRefNo,#txtRefDate,#txtContractorName').addClass('fontColorOfPickItem');
             $('#divGRN').data('GRN').ContractorID = 0;
             $('#divGRN').data('GRN').ContractorName = '';
             $('#cboCurrency').val(1);
             $('#txtCRate').val(parseFloat(1.00));
         }
     }
     else if (oPickerobj.winid == 'winRefItems')
     {
         if (oreturnObj != null && oreturnObj.ProductID > 0)
         {
             $('#txtProductName').val(oreturnObj.ProductName);
             $('#txtInvoiceQty').val(oreturnObj.RefQty);
             $('#txtYeToQty').val(oreturnObj.YetToReceiveQty);
             $('#txtMUnit').val(oreturnObj.MUSymbol);
             $('#txtProductName').data('Product',oreturnObj);
         }
     }else if(oPickerobj.winid=='winTechnicalSheets')
     {
         if (oreturnObj != null && oreturnObj.TechnicalSheetID > 0)
         {
             var oGRNDetail = $('#tblGRNDetail').datagrid('getSelected');
             if(oGRNDetail==null)
             {
                 alert("Sorry, There is No GRN Detail. Please Select GRN Detail");
                 return;
             }
             oGRNDetail.StyleID = oreturnObj.TechnicalSheetID;
             oGRNDetail.StyleNo = oreturnObj.StyleNo;
             oGRNDetail.BuyerName = oreturnObj.BuyerName;             
             $('#tblGRNDetail').datagrid('updateRow',{index:parseInt(sessionStorage.getItem('TempGRNDetailIndex')),row: oGRNDetail});
             alert("Succesfully Updated.");
         }
     }

 }

 function IsItemExist(nRefObjectID)
 {
     var oGRNDetails = $('#tblGRNDetail').datagrid('getRows');
     if(oGRNDetails!=null)
     {
         for(var i=0; i<oGRNDetails.length; i++)
         {
             if(parseInt(oGRNDetails[i].RefObjectID)===parseInt(nRefObjectID))
             {
                 return true;
             }
         }
     }
     return false;
 }
 $("#btnRemoveProduct").click(function()
     {
         $('#txtProductName').val('');
         $('#txtInvoiceQty').val('');
         $('#txtYeToQty').val('');
         $('#txtMUnit').val('');
         $('#txtProductName').data('Product',[]);
 });

 $("#btnAddGRNDetail").click(function ()
 {
     AddGRNDetail();
 });
 function AddGRNDetail()
 {
     if($('#txtProductName').data('Product').ProductID>0)
     {
         var oGRNDetails = $('#tblGRNDetail').datagrid('getRows');
         var nIndex = oGRNDetails.length;
         var oGRNDetail = MapGRNDetailObject($('#txtProductName').data('Product'));
         $('#tblGRNDetail').datagrid('appendRow',oGRNDetail);
         $('#tblGRNDetail').datagrid('selectRow', nIndex);
         $('#txtBarCode').val('');
         $('#txtQty').val('');
         $('#txtBarCode').focus();
     }
     else
     {
         alert('Please Select An Item And Try Again!!');
         $('#txtProductName').focus();
     }
 }
 function MapGRNDetailObject(oItem)
 {
     var oGRNDetail={
         GRNDetailID : 0,
         GRNID : 0,
         ProductID : parseInt(oItem.ProductID),
         VehicleModelID : parseInt(oItem.VehicleModelID),
         ModelShortName : oItem.ModelShortName,
         TechnicalSpecification : oItem.ShortName,
         MUnitID : parseInt(oItem.MUnitID),
         RefQty : oItem.RefQty,
         ReceivedQty : ($('#txtQty').val()==undefined?'':$('#txtQty').val()),
         YetToReceiveQty:oItem.YetToReceiveQty,
         UnitPrice :  oItem.UnitPrice,
         Amount : 0,
         LotID : 0,
         LotNo : ($('#txtBarCode').val()==undefined?'':$('#txtBarCode').val()),
         RefTypeInt : 1,
         RefObjectID : parseInt(oItem.RefObjectID),
         GRNNo : "",
         MUName : oItem.MeasurementUnitName,
         MUSymbol : oItem.Symbol,
         OperationUnitName : "",
         LocationName : "",
         ProductName : oItem.ProductName,
         ProductCode : oItem.ProductCode,
         ProjectName:''
     };
     return oGRNDetail;
 }

 $('#btnRemove').click(function(e){
     var oGRNDetail= $('#tblGRNDetail').datagrid('getSelected');
     if(oGRNDetail==null || parseInt(oGRNDetail.ProductID) <=0)
     {
         alert("please select an Item!");
         return false;
     }
     if (!confirm("Confirm to Delete?")) return ;
     var SelectedRowIndex=$('#tblGRNDetail').datagrid('getRowIndex',oGRNDetail);
     $('#tblGRNDetail').datagrid('deleteRow',SelectedRowIndex);
     editIndex = undefined;
 });

 $('#btnRefresh').click(function(e){
     endEditing();
     var oGRNDetails = $('#tblGRNDetail').datagrid('getRows');
     RefreshList(oGRNDetails);
 });

 $(document).keydown(function(e) {
     if(e.which == 27)//escape=27
     {
         window.location.href = sessionStorage.getItem('BaseAddress')+ "/PartsReceived/ViewGRNs?menuid="+sessionStorage.getItem('MenuID');
     }
 });
</script>