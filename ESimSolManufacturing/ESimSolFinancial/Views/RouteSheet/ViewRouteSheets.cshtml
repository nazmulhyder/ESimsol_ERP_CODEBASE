@{
    ViewBag.Title = "Dyeing Card";
}

@model IEnumerable<ESimSol.BusinessObjects.RouteSheet>

    <head>
        <title>Route Sheet</title>
    </head>
    <body>
        <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
            <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
                <label style="font-size:18px;">Please wait</label>
                <div id="progressbar" style="width:100%;height:37px;"></div>
            </div>
        </div>
        <div class="menuMainCollectionTable" id="divRSs">
            <table id="tblRouteSheet" title="Dyeing Card List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarRouteSheet" showfooter="true">
                <thead>
                    <tr>
                        <th field="RouteSheetDateStr" width="8%">Date</th>
                        <th field="RouteSheetNo" width="10%"><span class="lblRSNo"></span></th>
                        <th field="OrderNoFull" width="10%">Order No</th>
                        <th field="RSStateStr" width="8%">Status</th>
                        <th field="MachineName" width="10%">Machine</th>
                        <th field="ProductName" width="15%">Yarn Type</th>
                        <th field="ColorName" width="10%">Color Name</th>
                        <th field="Qty" width="10%" formatter="formatPrice" align="right">Qty</th>
                        <th field="DyeingType" width="10%">Dyeing Type</th>
                        <th field="IsReDyeingSt" width="8%">Re-Dye</th>
                        <th field="PrepareByName" width="14%">Prepared By</th>
                        <th field="ApproveByName" width="14%">Approved</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarRouteSheet">
                <input type="text" id="txtRouteSheetNo" placeholder="Search by DL No" style="width:10%;" />
                <input type="text" id="txtOrderNo" placeholder="Search by Order" style="width:10%;" />
                @*<a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>*@
                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv Search</a>
                <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-edit" plain="true">Edit</a>
                <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-remove" plain="true">Delete</a>
                <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-details" plain="true">View</a>
                <a id="btnReDyeing" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-copy" plain="true">Re-Dyeing</a>
                <a id="btnCopy" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-copy" plain="true">Copy</a>
                <a id="btnAddGrace" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Grace</a>

                @*<a id="btnCancel" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-cancel" plain="true">Cancel</a>*@
                @*<a id="btnPrintRS_Custom" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Preview</a>*@
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Preview</a>
                <a id="btnRSState" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true"> <label id="lblRSState">Send To Floor</label> </a>
                <a id="btnUndo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-undo" plain="true">Undo</a>
                <a id="btnPrintCard" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Batch print</a>
                <a id="btnAddMachineLiquor" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">D.Card Edit</a>
            </div>
        </div>
        <div id="winAdvSearch" class="easyui-window winClass" style="width:700px" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%">
                <tr>
                    <td>
                        <fieldset>
                            <legend>Searching Criteria</legend>
                            <table style="width:100%">
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label> Date:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <select id="cboRSDateAdvS" style="width:30%;" onchange="DateActionsRSDateAdvSearch();"></select>
                                        <input id="dtRouteSheetDateFromAdv" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="dtRouteSheetDateToAdv" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>

                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Machine:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <input id="txtMachine" style="width:70%;" placeholder="Search Machine" />
                                        <a id="btnPickMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnResetMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>

                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Buyer:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <input id="txtBuyer" style="width:70%;"  placeholder=" search issue to" />
                                        <a id="btnPickBuyer" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnResetBuyer" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>

                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Yarn:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <input id="txtProductName" style="width:70%;" type="text" placeholder="Type & Press Enter" />
                                        <a id="btnProductPiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnClrProductPiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Order Type:</label>
                                    </td>
                                    <td style=" width:30%;text-align:left;">
                                        <select id="cboOrderType" class="cbo-styler"></select>
                                    </td>
                                    <td style=" width:15%;text-align:right;">
                                    </td>
                                    <td style=" width:30%;text-align:left;">
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Order No:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <input id="txtOrderNoAdv" style="width:70%;" placeholder="Search Issue To" />
                                        <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnResetOrder" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>

                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Status:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <table id="tblOrderStatus" class="easyui-datagrid" style="height:200px;" fitcolumn="true" rownumbers="true" pagination="false" multiselect="true" autorowheight="false">
                                            <thead>
                                                <tr>
                                                    <th data-options="field:'Selected',checkbox:true"> </th>
                                                    <th field="Text" width="80%">Status</th>
                                                </tr>
                                            </thead>

                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label style="font-size:11px">Date by Status:</label>
                                    </td>
                                    <td colspan="3" style=" width:75%;text-align:left;">
                                        <select id="cboRSDateAdvS_His" style="width:20%;" onchange="DateActionsRSDateAdvSearch_His();"></select>
                                        <select id="cboRSStatusHis" style="width:25%;" onchange="DateActionsRSDateAdvSearch_His();"></select>
                                        <input id="dtRouteSheetDateFromAdv_His" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                        <input id="dtRouteSheetDateToAdv_His" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label> Shift :</label>
                                    </td>
                                    <td style=" width:25%;text-align:left;" colspan="3">
                                        <select id="cboRSShift" class="cbo-styler" style="width:100%"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:20%;text-align:right;">
                                        <label>Dye Type:</label>
                                    </td>
                                    <td style=" width:30%;text-align:left;" colspan="3">
                                        <select id="cboDUDyeingType" class="cbo-styler" style="width:100%"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:25%;text-align:right;">
                                        <label>Is Re-Dyeing ?</label>
                                    </td>
                                    <td style=" width:30%;text-align:left;" colspan="3">
                                        <input id="chkIsReDyeing" type="checkbox" />
                                    </td>
                                </tr>
                                <tr>
                                    <td height="5px" colspan="4"></td>
                                </tr>

                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
                <a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>
        
        <div id="winAddGrace" class="easyui-window winClass" style="width:500px" title="Grace Entry" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%">
                <tr>
                    <td>
                        <fieldset>
                            <legend>Batch InFo: </legend>
                            <table style="width:100%">
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label> Order No:</label>
                                    </td>
                                    <td colspan="2"  style=" width:50%;text-align:left;">
                                        <select id="cboRSOrders" style="width:100%;" onchange="RSOrderChange();"></select>
                                    </td>
                                    <td  style=" width:20%;text-align:left;">
                                    </td>
                                </tr>

                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Yarn Type:</label>
                                    </td>
                                    <td colspan="3" style=" width:70%;text-align:left;">
                                        <input id="txtProductNameGrace" style="width:100%;" placeholder="Product Name" disabled />
                                        @*<select id="txtProductNameGrace" style="width:70%;" onchange="RSYarnChange();"></select>*@
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Order Qty:</label>
                                    </td>
                                    <td  style=" width:20%;text-align:left;">
                                        <input id="txtOrderQty" style="width:100%;" class="number" placeholder=" Order qty" disabled />
                                    </td>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Total Dyeing Qty:</label>
                                    </td>
                                    <td  style=" width:20%;text-align:left;">
                                        <input id="txtDyeingQty_Prv" style="width:100%;" class="number" placeholder=" Order qty" disabled />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Previous Grace Qty:</label>
                                    </td>
                                    <td style=" width:20%;text-align:left;">
                                        <input id="txtQtyGrace_Previous" style="width:100%;" class="number" placeholder=" Previous Grace qty" disabled />
                                    </td>
                                    <td style=" width:30%;text-align:right;">
                                        <label>New Dyeing Qty:</label>
                                    </td>
                                    <td style=" width:20%;text-align:left;">
                                        <input id="txtDyeingQty_New" style="width:100%;" class="number" placeholder=" Order qty" disabled />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Recycle & Westage:</label>
                                    </td>
                                    <td  style=" width:20%;text-align:left;">
                                        <input id="txtRecWestage" style="width:100%;" class="number" placeholder=" Previous qty" disabled />
                                    </td>
                                    <td style=" width:30%;text-align:right;">
                                    </td>
                                    <td style=" width:20%;text-align:left;">
                                    </td>

                                </tr>
                                <tr>
                                    <td colspan="4" style="width:80%; text-align:center; font-size: 8px; font-style:italic;"><label style=" font-size: 8px;color:red" >Short Qty=(Order Qty+Previous Grace)-(Total Prev. Dyeing Qty+ New Dyeing Qty) </label></td>
                                </tr>
                               
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                    </td>
                                    <td style=" width:20%;text-align:right;"><label>Short Qty:</label></td>
                                    <td  style=" width:30%;text-align:left;">
                                        <input id="txtDyeingQty_Exceed" style="width:100%;" class="number" placeholder=" Exceed qty" disabled />
                                    </td>
                                   
                                    <td style=" width:20%;text-align:left;"></td>
                                </tr>
                                <tr> 
                                    
                                    <td  colspan="2" style=" width:20%;text-align:right;"><label>Request For Grace Qty:</label></td>
                                    <td  style=" width:30%;text-align:left;">
                                        <input id="txtDyeingQty_Grace" style="width:100%;" class="number" placeholder=" Grace qty" />
                                    </td>
                                   
                                    <td style=" width:20%;text-align:left;"></td>
                                </tr>
                                <tr>
                                    <td style=" width:30%;text-align:right;">
                                        <label>Reason:</label>
                                    </td>
                                    <td colspan="3" style=" width:70%;text-align:left;">
                                        <input id="txtNote_Grace" style="width:100%;" class="text" placeholder="Type Reason/Note.." />
                                    </td>
                                </tr>
                                <tr>
                                    <td height="5px" colspan="4"></td>
                                </tr>

                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <div style="width:100%">
                    <div style="width:50%" class="text-left">
                        <label id="lblRSGrace"></label>
                    </div>
                    <div style="width:40%;float:right">
                        <a id="btnSaveGrace" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="SaveRSGrace()">Save</a>
                        <a id="btnCloseGrace" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </div>
            </fieldset>
        </div>

        <!--NAZMUL 18/11/2019 -->
        <div id="winMachineLiquor" class="easyui-window winstyle" style=" height:auto;width:60%" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div class="menuMainCollectionTable">
                <div style="overflow:hidden;display:block;">
                    <fieldset style="height:10%">
                        <legend style="font-weight: bold"> Update Machine Liquor </legend>
                        <div style="overflow:hidden;display:block">
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                   Batch No:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtBatchNoML" style="float:left;width:100%" disabled/>
                                </div>
                            </div>                           
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                   Order No:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtOrderNoML" type="text" style=" width:100%;"  disabled/>
                                </div>
                            </div>
                        </div>
                        <div style="overflow:hidden;display:block;margin-top:3px">
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                    Machine:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <select id="cboMachineType" style="width:36%"></select>
                                    <input type="text" id="txtMachineName" style="width:62%" placeholder="Machine Type & Enter" />
                                </div>
                            </div>
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                   T.Liquor:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtTtlLiquire" type="text" style=" width:65%;text-align:right" placeholder="Liquor" />
                                    <input type="button" id="btnLabel" style="width:10%;" />
                                </div>
                            </div>
                        </div>
                        <div style="overflow:hidden;display:block;margin-top:3px">
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                    Cotton Liquor:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtCottonLiquor" style="float:left;width:100%" />
                                </div>
                            </div>
                            <div style="overflow:hidden;float:left; width:48%">
                              
                            </div>
                        </div>
                        <div style="overflow:hidden;display:block;margin-top:3px">
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                    Qty(dummy):
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtQtyDummy" type="text" style=" width:100%;" />
                                </div>
                            </div>
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                    Qty(Omit):
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <input id="txtQtyOmit" type="text" style=" width:100%;" />
                                </div>
                            </div>
                        </div>
                        <div style="overflow:hidden;display:block;margin-top:3px">
                            <div style="overflow:hidden;float:left; width:48%">
                                <div style="overflow:hidden;float:left;width:30%;text-align:right">
                                   Shift:
                                </div>
                                <div style="overflow:hidden;float:left;width:70%">
                                    <select id="cboRSShiftRS" style="width:100%"></select>
                                </div>
                            </div>
                            <div style="overflow:hidden;float:left; width:48%">
                              
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div style="display:block;overflow:hidden;">
                    <fieldset style="height:10%">
                        <legend style="font-weight: bold">Action : </legend>
                        <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                            <tr>
                                <td style="width:60%; text-align:right"></td>
                                <td style="width:40%;text-align:right;">
                                    <a id="btnMachineLiquorSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                    <a id="btnMachineLiquorClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
            </div>
        </div>
    </body>

    <style type="text/css">
      
    </style>



    <script type="text/javascript">
    var _sBaseAddress="";
    var _oRouteSheets=[];
    var _oRSStatuss=[];
    var _sPTUIDs="";
    var _sContractorIDs="";
    var _sMachineIDs="";
    var _sProductIds="";
    var _sMessage='';
    var _nNextStatus=-1;
    var _nBUID=0;
    var _oAuthorizationRolesMapping=[];
    var _oMachineTypes = [];

    $(document).ready(function () {
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheets =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oRSStatuss=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.EnumRSStatuss));
        var oOrderTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.OrderTypes));
        var oCompareOperators=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CompareOperators));
        var oRouteSheetSetup=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RouteSheetSetup));
        var oRSShifts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RSShifts));
        var oDUDyeingTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.DUDyeingTypes));
        _oMachineTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.MachineTypes));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        RSSetup(oRouteSheetSetup);
        $('#txtTtlLiquire').icsCurrencyBox();
        $('#txtCottonLiquor').icsCurrencyBox();
        $('#txtQtyDummy,#txtQtyOmit').icsCurrencyBox();
        $('.number').icsCurrencyBox();
        $('#divRSs').data('MachineLiquor',[]);
        $('.initial-state').hide();
        debugger;
        if(sessionStorage.getItem("RouteSheets")!=null && sessionStorage.getItem("RouteSheets").length>0){
            _oRouteSheets= jQuery.parseJSON(sessionStorage.getItem('RouteSheets'));
            var nIndex= sessionStorage.getItem('SelectedRowIndex');
            DynamicRefreshList(_oRouteSheets, 'tblRouteSheet');
            if(nIndex>-1){
                $('#tblRouteSheet').datagrid('selectRow',nIndex);
                OperationPerforms(nIndex, _oRouteSheets[nIndex]);
            }
        }
        else{
            DynamicRefreshList(_oRouteSheets, 'tblRouteSheet');
        }

        DynamicRefreshList(_oRSStatuss, 'tblOrderStatus');

        $("#cboRSShiftRS").icsLoadCombo({
            List: oRSShifts,
            OptionValue: "RSShiftID",
            DisplayText: "Name",

        });

        $("#cboRSStatusHis").icsLoadCombo({
            List: _oRSStatuss,
            OptionValue: "Value",
            DisplayText: "Text",
        });


        $("#cboOrderType").icsLoadCombo({
            List: oOrderTypes,
            OptionValue: "OrderType",
            DisplayText: "ShortName",
        });
        $("#cboRSShift").icsLoadCombo({
            List: oRSShifts,
            OptionValue: "RSShiftID",
            DisplayText: "Name",
        });
        $("#cboDUDyeingType").icsLoadCombo({
            List: oDUDyeingTypes,
            OptionValue: "DyeingType",
            DisplayText: "Name",
        });

        $("#cboRSDateAdvS,#cboRSDateAdvS_His").icsLoadCombo({
            List: oCompareOperators,
            OptionValue: "id",
            DisplayText: "Value",

        });
        $("#cboMachineType").icsLoadCombo({ List: _oMachineTypes,  OptionValue: "MachineTypeID", DisplayText: "Name", InitialValue:'-- All Machine --'});
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $(".lblLoadingMessage").hide();
        RefreshControlLayout();
        $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);
    });


    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });
    function RSSetup(oRouteSheetSetup)
    {
        $('#btnAddGrace').hide();
        if(oRouteSheetSetup.IsGraceApplicable)
        {
            $('#btnAddGrace').show();
        }
        $(".lblRSNo").html(oRouteSheetSetup.RSShortName);
        $("#txtRouteSheetNo").attr("placeholder", "Search By"+oRouteSheetSetup.RSShortName);
    }
    ////Start adv Searching

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    $('#tblRouteSheet').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData) {
        $('#btnEdit,#btnDelete,#btnCopy,#btnPrint,#btnPrintRS_Custom,#btnRSState,#btnUndo,#btnReDyeing,#btnAddMachineLiquor').hide();
        if (rowData != null && rowData.RouteSheetID > 0) {
            _nNextStatus=-1;
            _sMessage="";
            $('#btnPrint,#btnPrintRS_Custom').show();
            if (rowData.RSState==1 || rowData.RSState==2)  //Initialized = 1,
            {


                // $('#btnEdit,#btnDelete,#btnRSState').show();
                _nNextStatus=3;
                _sMessage="Send to Floor";
                $('#lblRSState').text('Send to Floor');

                if (PermissionChecker('Add', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnAdd").show();}
                if (PermissionChecker('Edit', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
                if (PermissionChecker('Delete', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
                if (PermissionChecker('Approved', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnRSState").show();}

            }
            else if (rowData.RSState==3)  //In Floor
            {
                $('#btnCopy,#btnUndo').show();
                if (PermissionChecker('UnApproved', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnUndo").show();}
                if (PermissionChecker('Copy', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnCopy").show();}
            }
            else if (rowData.RSState>3)
            {
                //$('#btnCopy').show();
                if (PermissionChecker('Copy', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnCopy").show();}
                if (PermissionChecker('Edit', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnReDyeing").show();}
            }
            
            if (rowData.RSState<6)
            {
                if (PermissionChecker('ExtremeEdit', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnAddMachineLiquor").show();}
            }
            //$("#btnAddMachineLiquor").show();
            //if (rowData.RSState>=14 && rowData.RSState<=17)  //Sub Finishing Store to Finish
            //{
            //    $('#btnCancel').hide();
            //}
        }
    }

    /*.......... Searching ............. */
    $("#txtRouteSheetNo").keyup(function (e) {
        var oRouteSheets =[];
        var keyCode = e.keyCode || e.which;
        $('#txtRouteSheetNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if (!$.trim($("#txtRouteSheetNo").val()).length) {

                alert("Please enter routesheet no to search.");
                $('#txtRouteSheetNo').focus();
                $('#txtRouteSheetNo').val("");
                return;
            }
            else { $('#txtRouteSheetNo').removeClass("errorFieldBorder"); }

            ResetAdvSearchPicker();

            var oRouteSheet={
                Params:   $.trim($("#txtRouteSheetNo").val())+'~'+0+ '~'+ icsdateformat(new Date())+'~'+ icsdateformat(new Date())+'~'+ _sPTUIDs +'~'+ _sContractorIDs + '~'+_sMachineIDs +'~'+ ''+'~'+''+'~'+_sProductIds+'~'+0+''

            };
            GetsRouteSheet(oRouteSheet,false);
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oRouteSheets.length;++i)
            {
                sTempName=oRouteSheets[i]['RouteSheetNo'];
                if(sTempName.toUpperCase().indexOf($('#txtRouteSheetNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oRouteSheets[i]);
                }
            }
            $('#tblRouteSheet').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oRouteSheets, "tblRouteSheet");$.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);}
            else { DynamicRefreshList(oSearchedData, "tblRouteSheet"); $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);}

        }
    });
    $("#txtOrderNo").keyup(function (e) {
        var oRouteSheets =[];
        var keyCode = e.keyCode || e.which;
        $('#txtOrderNo').removeClass("errorFieldBorder");
        if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13) // Enter Press
        {
            if (!$.trim($("#txtOrderNo").val()).length) {

                alert("Please enter routesheet no to search.");
                $('#txtOrderNo').focus();
                $('#txtOrderNo').val("");
                return;
            }
            else { $('#txtOrderNo').removeClass("errorFieldBorder"); }
            ResetAdvSearchPicker();
            var oRouteSheet={
                Params:   ''+'~'+0+ '~'+ icsdateformat(new Date())+'~'+ icsdateformat(new Date())+'~'+ _sPTUIDs +'~'+ _sContractorIDs + '~'+_sMachineIDs +'~'+ ''+'~'+$.trim($("#txtOrderNo").val())+'~'+_sProductIds+'~'+0+''

            };

            GetsRouteSheet(oRouteSheet,false);
        }
        else {
            var sTempName="";
            var oSearchedData = [];
            for(i=0;i<oRouteSheets.length;++i)
            {
                sTempName=oRouteSheets[i]['RouteSheetNo'];
                if(sTempName.toUpperCase().indexOf($('#txtOrderNo').val().toUpperCase())>-1)
                {
                    oSearchedData.push(oRouteSheets[i]);
                }
            }
            $('#tblRouteSheet').empty();
            if (oSearchedData.length == 0) { DynamicRefreshList(_oRouteSheets, "tblRouteSheet"); $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);}
            else { DynamicRefreshList(oSearchedData, "tblRouteSheet"); $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);}

        }
    });

    /*..........Adv Searching ............. */
    function ResetAdvSearchPicker(){
        _sContractorIDs="";
        _sPTUIDs="";
        _sMachineIDs="";
        _sProductIds="";
        $('#txtOrderNoAdv,#txtBuyer,#txtMachine,#txtProductName').val("");
        $('#cboOrderType,#cboRSDateAdvS,#cboRSDateAdvS_His,#cboDUDyeingType,#cboRSShift').val(0);

        $('#dtRouteSheetDateFromAdv,#dtRouteSheetDateToAdv').datebox({disabled:true});
        $('#dtRouteSheetDateFromAdv,#dtRouteSheetDateToAdv').datebox('setValue',icsdateformat(new Date()));
        $('#tblOrderStatus').datagrid('uncheckAll');

    }

    function DateActionsRSDateAdvSearch() {
        DynamicDateActions("cboRSDateAdvS", "dtRouteSheetDateFromAdv", "dtRouteSheetDateToAdv");
    }
    function DateActionsRSDateAdvSearch_His() {
        DynamicDateActions("cboRSDateAdvS_His", "dtRouteSheetDateFromAdv_His", "dtRouteSheetDateToAdv_His");
    }

    function GetOrderStatus(){

        var sOrderStatus="";

        var oOrderStatus=$('#tblOrderStatus').datagrid('getChecked');

        if(oOrderStatus.length>0){
            for(var i=0;i<oOrderStatus.length;i++){
                sOrderStatus= sOrderStatus + oOrderStatus[i].Value+","
            }
            sOrderStatus=sOrderStatus.substring(0,sOrderStatus.length-1);
        }
        return sOrderStatus;
    }

    $("#btnAdvSearch").click(function (e) {
        ResetAdvSearchPicker();
        $("#winAdvSearch").icsWindow("open", "Adv Search");
    });
    $("#btnCloseAdvSearch").click(function (e) {
        $("#winAdvSearch").icsWindow("close");
    });


    $("#btnSearchAdvSearch").click(function (e) {

        var sRSStatus=GetOrderStatus();

        if(_sPTUIDs =="" && _sContractorIDs=="" && _sMachineIDs=="" && _sProductIds=="" && parseInt($("#cboOrderType").val())<=0  && parseInt($("#cboRSDateAdvS").val())<=0 && sRSStatus=="" && parseInt($("#cboRSShift").val())<=0 && parseInt($("#cboDUDyeingType").val())<=0 && $('#chkIsReDyeing').prop('checked') == false && parseInt($("#cboRSStatusHis").val())<=0 ){
            alert("No searching criteria found to search.");
            return false;
        }
        //alert( $('#chkIsReDyeing').prop('checked'));

        var oRouteSheet={
            Params:  ""+'~'+ parseInt($("#cboRSDateAdvS").val())+ '~'+ $('#dtRouteSheetDateFromAdv').datebox('getValue')+'~'+ $('#dtRouteSheetDateToAdv').datebox('getValue')+'~'+ _sPTUIDs +'~'+ _sContractorIDs + '~'+_sMachineIDs +'~'+ sRSStatus+'~'+''+'~'+_sProductIds+'~'+parseInt($("#cboOrderType").val())+'~'+ parseInt($("#cboRSDateAdvS_His").val())+ '~'+ $('#dtRouteSheetDateFromAdv_His').datebox('getValue')+'~'+ $('#dtRouteSheetDateToAdv_His').datebox('getValue')
                       +'~'+ parseInt($("#cboRSShift").val())+'~'+ parseInt($("#cboDUDyeingType").val()) +'~'+ $('#chkIsReDyeing').prop('checked')+'~'+ parseInt($("#cboRSStatusHis").val())
        };
        GetsRouteSheet(oRouteSheet,true);
    });

    function GetsRouteSheet(oRouteSheet, bIsAdvSearch) {
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "Gets",
            IsWinClose: bIsAdvSearch
        };

        $(".lblLoadingMessage").show();
        $.icsMaxDataGets(obj, function (response) {

            if (response.status && response.objs != null) {
                //if(bIsAdvSearch){
                //    ResetAdvSearchPicker();
                //    $("#winAdvSearch").icsWindow("close");
                //}
                if (response.objs.length > 0)
                {
                    if(response.objs[0].RouteSheetID>0)
                    {
                        _oRouteSheets=response.objs;
                        DynamicRefreshList(response.objs, "tblRouteSheet");
                        $(".lblLoadingMessage").hide();
                        $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);
                    }
                    else
                    {
                        DynamicRefreshList([], "tblRouteSheet"); alert(response.objs[0].ErrorMessage);
                        $(".lblLoadingMessage").hide();
                        $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);
                    }
                }
                else
                {
                    DynamicRefreshList([], "tblRouteSheet"); alert("No Dyeing Card/Batch found.");
                    $(".lblLoadingMessage").hide();
                    $.icsMakeFooterColumn('tblRouteSheet',['ColorName','Qty']);
                }
            }
        });
    }



    // ================= GRACE OPERATIONS (START)
    $("#btnAddGrace").click(function (e)
    {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }

        $("#winAddGrace").data("RS",{});
        $("#winAddGrace").data("RSGraces",[]);

        ResetGrace();
        GetRouteSheetDOs(oRouteSheet);
    });
    function RSOrderChange()
    {
        debugger;
        ResetGrace();
        if(  $('#cboRSOrders').val() <= 0 ) return;

        var nDyeingOrderDetailID =  $('#cboRSOrders').val();
        var oRSGraces = $("#winAddGrace").data("RSGraces");

        for(var i=0; i< oRSGraces.length; i++)
        {
            if(oRSGraces[i].DyeingOrderDetailID == nDyeingOrderDetailID)
            {
                SetValuesGrace(oRSGraces[i]); break;
            }
        }
    }
    function ResetGrace()
    {
        //cboRSOrders  txtProductNameGrace txtOrderQty  txtDyeingQty_Prv txtDyeingQty_New txtDyeingQty_Exceed txtDyeingQty_Grace

        //$('#cboRSOrders').val(0);
        $('#txtProductNameGrace').val("");
        $('#txtOrderQty').val(0);
        $('#txtDyeingQty_Prv,#txtRecWestage,#txtQtyGrace_Previous').val(0);
        $('#txtDyeingQty_New').val(0);
        $('#txtDyeingQty_Exceed').val(0);
        $('#txtDyeingQty_Grace').val(0);
        $('#txtNote_Grace').val("");
    }

    function RefreshGrace(RouteSheetGraces)
    {
        $("#cboRSOrders").icsLoadCombo({
            List: RouteSheetGraces,
            OptionValue: "DyeingOrderDetailID",
            DisplayText: "OrderNo",
        });

        //cboRSOrders  txtProductNameGrace txtOrderQty  txtDyeingQty_Prv txtDyeingQty_New txtDyeingQty_Exceed txtDyeingQty_Grace
        //RouteSheetGraceID, QtyGrace  ,RouteSheetID   ,DyeingOrderDetailID ,     ProductName   ,QtyRS       ,OrderQty      ,QtyRS_Previous

        if(RouteSheetGraces.length<=0){ alert("Dyeing Order(s) Not Found!"); return;}

        SetValuesGrace(RouteSheetGraces[0]);

        $("#winAddGrace").icsWindow("open", "Adv Search");
    }
    function SetValuesGrace(RouteSheetGrace)
    {
        debugger;
        $("#winAddGrace").data("RSGrace",RouteSheetGrace);
        $("#winAddGrace").data("RS").RouteSheetGraceID = RouteSheetGrace.RouteSheetGraceID;

        $('#cboRSOrders').val(RouteSheetGrace.DyeingOrderDetailID);
        $('#txtProductNameGrace').val(RouteSheetGrace.ProductName);
        $('#txtOrderQty').val(parseFloat(RouteSheetGrace.OrderQty).toFixed(2));
        $('#txtDyeingQty_Prv').val(parseFloat(RouteSheetGrace.QtyRS_Previous).toFixed(2));
        $('#txtQtyGrace_Previous').val(parseFloat(RouteSheetGrace.QtyGrace_Previous).toFixed(2));

        $('#txtRecWestage').val(parseFloat(RouteSheetGrace.RecycleQty+RouteSheetGrace.WastageQty).toFixed(2));

        $('#txtDyeingQty_New').val(parseFloat(RouteSheetGrace.QtyRS).toFixed(2));

        //=========================== Exceed QTY =====================
        var nExceed_Qty = parseFloat(( (parseFloat(RouteSheetGrace.QtyRS_Previous) + parseFloat(RouteSheetGrace.QtyRS))-parseFloat(RouteSheetGrace.QtyGrace_Previous)-parseFloat(RouteSheetGrace.OrderQty)).toFixed(2));
        nExceed_Qty = (nExceed_Qty < 0 || isNaN(nExceed_Qty)) ? 0 : nExceed_Qty;

        $('#txtDyeingQty_Exceed').val(nExceed_Qty);

        // console.log( nExceed_Qty , parseFloat(RouteSheetGrace.RecycleQty)  ,   parseFloat(RouteSheetGrace.WastageQty));
        //=========================== GRACE QTY =====================
        //var nGraceQty = nExceed_Qty +parseFloat(RouteSheetGrace.RecycleQty)  +   parseFloat(RouteSheetGrace.WastageQty);
        //nGraceQty = (nGraceQty < 0 || isNaN(nGraceQty)) ? 0 : parseFloat(nExceed_Qty).toFixed(2);

        if(RouteSheetGrace.QtyGrace > 0) nExceed_Qty = RouteSheetGrace.QtyGrace;

        $('#txtDyeingQty_Grace').val(nExceed_Qty);
        $('#txtNote_Grace').val(RouteSheetGrace.Note);

        if(RouteSheetGrace.ApprovedByID!=0)
        {
            $('#lblRSGrace').html("Approved By : " + RouteSheetGrace.ApprovedByName);
            $('#txtDyeingQty_Grace').prop("disabled",true);
            $('#txtNote_Grace').prop("disabled",true);
            $('#txtNote_Grace').prop("disabled",true);
            $('#btnSaveGrace').hide();
        }
        else
        {
            $('#lblRSGrace').html("");
            $('#txtDyeingQty_Grace').prop("disabled",false);
            $('#txtNote_Grace').prop("disabled",false);
            $('#btnSaveGrace').show();
        }
    }
    function GetRouteSheetDOs(oRouteSheet)
    {
        var obj =
           {
               BaseAddress: _sBaseAddress,
               Object: oRouteSheet,
               ControllerName: "RouteSheet",
               ActionName: "GetsRouteSheetDO_Grace"
           };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs != null) {

                if (response.objs.length > 0) {
                    if(response.objs[0].RouteSheetID>0)
                    {
                        $("#winAddGrace").data("RS",oRouteSheet);
                        $("#winAddGrace").data("RSGraces",response.objs);   console.log(response.objs);
                        RefreshGrace(response.objs);
                    }
                    else
                    {alert(response.objs[0].ErrorMessage);}
                }
                else { alert("No Dyeing Card/Batch found."); }
            }
        });
    }

    function SaveRSGrace()
    {
        if( $("#winAddGrace").data("RS").RouteSheetID <=0 ) {alert("Invalid Dyeing Batch!"); return;}
        if(  $('#txtNote_Grace').val() ==null || $('#txtNote_Grace').val()=="") {alert("Please entry /Reason/Note!");  $('#txtNote_Grace').focus(); return;}
        if(  $('#cboRSOrders').val() <= 0 ) {alert("Please select a dyeing order!"); return;}
        if( parseFloat( $('#txtDyeingQty_Grace').val()) <= 0 || isNaN(parseFloat( $('#txtDyeingQty_Grace').val()))) {alert("Please enter a valid grace qty!"); return;}

        if( parseFloat($('#txtDyeingQty_Grace').val()) > parseFloat($('#txtDyeingQty_Exceed').val()) ) {alert("Grace qty is greater than exceed qty. Please enter a valid grace qty!"); return;}

        if(!confirm("Confirm to save grace ?")) return false;

        var oRSHG=
            {
                RouteSheetID : $("#winAddGrace").data("RS").RouteSheetID,
                RouteSheetGraceID : $("#winAddGrace").data("RS").RouteSheetGraceID,
                DyeingOrderDetailID : $('#cboRSOrders').val(),
                QtyGrace : $('#txtDyeingQty_Grace').val(),
                Note : $('#txtNote_Grace').val(),
            };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSHG,
            ObjectId: oRSHG.RouteSheetGraceID,
            ControllerName: "RouteSheetGrace",
            ActionName: "Save",
        };
        $.icsSave(obj, function (response)
        {
            if (response.status && response.obj != null)
            {
                $("#winAddGrace").icsWindow("close");
            }
        });
    }

    $("#btnCloseGrace").click(function (e) {
        $("#winAddGrace").icsWindow("close");
    });
    // ================= GRACE OPERATIONS (END)


    /*-------------Pick Pro------*/
    //Product Pick
    $("#txtProductName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtProductName').val()==null || $('#txtProductName').val()=="")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtProductName').focus();
                return;
            }
            PickProduct($('#txtProductName').val());
        }
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtProductName").removeClass("fontColorOfPickItem");
            _sProductIds= "";
        }
    });
    $("#btnProductPiker").click(function () {

        if($('#txtProductName').val()==null || $('#txtProductName').val()=="")
        {
            alert("Please Type Product and Press Enter.");
            $('#txtProductName').focus();
            return;
        }
        PickProduct($('#txtProductName').val());
    });
    $("#btnClrProductPiker").click(function () {
        $("#txtProductName").val('');
        $("#txtProductName").removeClass("fontColorOfPickItem");
        _sProductIds= [];
    });
    function PickProduct(sProductName)
    {
        var oProduct = { BUID:sessionStorage.getItem("BUID"),ProductName:sProductName};

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 300, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass: 'clsProductPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }
    /*..........Pick Order ............. */

    $("#btnPickOrderNo").click(function () {
        debugger;
        if (parseInt($("#cboOrderType").val())<=0 ) {

            alert("Please Select Order Type.");
            $('#cboOrderType').focus();
            $('#cboOrderType').addClass("errorFieldBorder");
            return;
        }
        else{
            $('#cboOrderType').removeClass("errorFieldBorder");
        }

        var oPSDetail = {
            OrderType:$('#cboOrderType').val(),
            OrderNo:$('#txtOrderNo').val(),
            LabDipDetailID:0,
            ContractorName:_sContractorIDs
        };

        GetOrders(oPSDetail);
    });
    $("#txtOrderNoAdv").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNoAdv").val());
            if (parseInt($("#cboOrderType").val())<=0 ) {

                alert("Please Select Order Type.");
                $('#cboOrderType').focus();
                $('#cboOrderType').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#cboOrderType').removeClass("errorFieldBorder");
            }

            var oPSDetail = {
                OrderType:$('#cboOrderType').val(),
                OrderNo:$('#txtOrderNoAdv').val(),
                LabDipDetailID:0
            };
            GetOrders(oPSDetail);
        }
        else if(nkeyCode==8){
            $("#txtOrderNoAdv").val("");

        }
    });
    function GetOrders(oPSDetail){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "DUPSchedule",
            ActionName: "GetsDyeingOrder",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DODID > 0) {
                    debugger;
                    var tblColums = [];

                    var oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);

                    oColumn = { field: "OrderQty", title: "OrderQty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_Pro", title: "Prod Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_RS", title: "Yet To Pro", width: 75, align: "right" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn", width: 225, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ShadeSt", title: "Shade", width: 40, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LabdipNo", title: "LabdipNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderTypeSt", title: "OrderType", width: 100, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 1000,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });

    }

    $('#btnPrintCard').click(function(){

        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintCard?nId="+oRouteSheet.RouteSheetID+"&buid="+_nBUID, "_blank");
    });
    $("#btnResetOrder").click(function () {
        $('#txtOrderNoAdv').val("");
        _sPTUIDs="";
    });


    /*..........Contractor Pick ............. */
    $("#btnResetBuyer").click(function () {
        $("#txtBuyer").val("");
        _sContractorIDs="";
    });
    $("#btnPickBuyer").click(function () {

        var sContractorName=$.trim($("#txtBuyer").val());
        GetContractors(sContractorName);
    });
    $("#txtBuyer").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sContractorName=$.trim($("#txtBuyer").val());
            GetContractors(sContractorName);
        }
        else if(nkeyCode==8){
            $("#txtBuyer").val("");
            _sContractorIDs=0;
        }
    });

    function GetContractors(sContractorName){

        var oContractor = {
            Params: '2,3' +'~'+sContractorName+'~'+sessionStorage.getItem("BUID"),
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);

        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "center" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 190, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Phone", title: "Phone", width: 140, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass:'clsContractorPicker',
                        winwidth: 460,
                        winheight: 460,
                        tableid: 'tblContractorPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No contractor found.");
            }
        });


    }

    /*---------------- Machine Pick --------------*/

    $("#btnResetMachine").click(function () {

        $("#txtMachine").val("");
        _sMachineIDs="";
    });

    $("#btnPickMachine").click(function () {

        var sMachineName=$.trim($("#txtMachine").val());
        if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachines(sMachineName);
    });

    $("#txtMachine").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachine").val());
            if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachines(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachine").val("");
            _sMachineIDs="";
        }
    });

    function GetMachines(sMachineName){

        var oCapitalResource = {
            BUID:sessionStorage.getItem("BUID"),
            ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oCapitalResource,
            ControllerName: "CapitalResource",
            ActionName: "GetsCapitalResourceLastLayer",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].CRID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Name", title: "Machine Name", width: 130, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MachineCapacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OperationUnitName", title: "Store", width: 185, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMachinePicker',
                        winclass:'clsMachinePicker',
                        winwidth: 500,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });


    }



    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winContractorPicker')
        {
            if (oreturnObjs != null && oreturnObjs.length> 0)
            {

                _sContractorIDs=''; var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Buyers Selected" : oreturnObjs[0].Name;
                $('#txtBuyer').val(sMessage);
                $("#txtBuyer").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sContractorIDs=_sContractorIDs+oreturnObjs[i].ContractorID+',';
                }
                _sContractorIDs=_sContractorIDs.substring(0,_sContractorIDs.length-1);

            }
            else
            {
                alert("Please select a contractor.");
                return false;
            }
        }

        else if (oPickerobj.winid == 'winBuyers') {
            if (oreturnObjs != null && oreturnObjs.length> 0)
            {
                _sDeliverToIDs='';
                var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Contractors Selected" : oreturnObjs[0].Name;
                $('#txtDeliverToAdvS').val(sMessage);
                $("#txtDeliverToAdvS").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sDeliverToIDs=_sDeliverToIDs+oreturnObjs[i].ContractorID+',';
                }
                _sDeliverToIDs=_sDeliverToIDs.substring(0,_sDeliverToIDs.length-1);
            }
            else
            {
                alert("Please select a buyer.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                _sProductIds=''; var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" ProductName Selected" : oreturnObjs[0].ProductName;
                $('#txtProductName').val(sMessage);
                $("#txtProductName").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sProductIds=_sProductIds+oreturnObjs[i].ProductID+',';
                }
                _sProductIds=_sProductIds.substring(0,_sProductIds.length-1);

            }
            else
            {
                alert("Please select a Product.");
                return false;
            }

        }
        else  if (oPickerobj.winid == 'winMachinePicker')
        {
            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                _sMachineIDs=''; var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Machine Selected" : oreturnObjs[0].Name;
                $('#txtMachine').val(sMessage);
                $("#txtMachine").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sMachineIDs=_sMachineIDs+oreturnObjs[i].CRID+',';
                }
                _sMachineIDs=_sMachineIDs.substring(0,_sMachineIDs.length-1);
            }
            else
            {
                alert("Please select a Machine.");
                return false;
            }
        }
        else  if (oPickerobj.winid == 'winOrderPicker')
        {
            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                _sPTUIDs=''; var sMessage='';
                sMessage=(oreturnObjs.length>1)? oreturnObjs.length +" Order Selected" : oreturnObjs[0].OrderNo;
                $('#txtOrderNoAdv').val(sMessage);
                $("#txtOrderNoAdv").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnObjs.length;i++){
                    _sPTUIDs=_sPTUIDs+oreturnObjs[i].DODID+',';
                }
                _sPTUIDs=_sPTUIDs.substring(0,_sPTUIDs.length-1);
            }
            else
            {
                alert("Please select a order.");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winMachineLabelPicker')
        {
            debugger;
            if(oreturnObj !=null  && oreturnObj.MachineID>0){
             
                $('#txtTtlLiquire').val(oreturnObj.Liquor);
                $('#btnLabel').val(oreturnObj.Label);
              
            }
            else{
                alert("Please select machine.");
            }
            
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    /*------------------------------------*/





    $("#btnAdd").click(function(){
        debugger;
        sessionStorage.setItem("Operation", "New");
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("RouteSheetHeader", "Add RouteSheet");
        sessionStorage.setItem("RouteSheets", JSON.stringify($('#tblRouteSheet').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        sessionStorage.setItem("BUID", _nBUID);
        window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId=0&buid="+_nBUID+"&ts="+tsv;

        // window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?id=0&buid="+_nBUID;
    });

    $('#btnEdit').click(function (e)
    {

        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }


        var nIndex=$('#tblRouteSheet').datagrid('getRowIndex',oRouteSheet);

        sessionStorage.setItem("Operation", "Edit");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("RouteSheetHeader", "Edit Production");
        sessionStorage.setItem("RouteSheets", JSON.stringify($('#tblRouteSheet').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        sessionStorage.setItem("BUID", _nBUID);
        window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId="+oRouteSheet.RouteSheetID+"&buid="+_nBUID+"&ts="+tsv;
        //   window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId=0&buid="+_nBUID+"&ts="+tsv;
    });

    $('#btnDelete').click(function(e){
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        if (!confirm("Confirm to delete?")) return;
        sessionStorage.clear();
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "Delete",
            TableId: "tblRouteSheet",
            IsWinClose: false
        };
        $.icsDelete(obj);

    });

    $('#btnView').click(function (e)
    {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblRouteSheet').datagrid('getRowIndex',oRouteSheet);

        sessionStorage.clear();
        sessionStorage.setItem("Operation", "View");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("RouteSheetHeader", "View Production");
        sessionStorage.setItem("RouteSheets", JSON.stringify($('#tblRouteSheet').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        //window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId="+oRouteSheet.RouteSheetID+"&ts="+tsv;;
        sessionStorage.setItem("BUID", _nBUID);
        window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId="+oRouteSheet.RouteSheetID+"&buid="+_nBUID+"&ts="+tsv;
    });

    $('#btnPrint').click(function (e)
    {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheet?nId="+oRouteSheet.RouteSheetID+"&bIsCommon="+true+"&nts="+tsv, "_blank");
    });
    $('#btnPrintRS_Custom').click(function (e)
    {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheetCustom?nId="+oRouteSheet.RouteSheetID+"&bIsCommon="+false+"&nts="+tsv, "_blank");
    });


    /*----------Copy---------------*/

    $("#btnCopy").click(function () {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblRouteSheet').datagrid('getRowIndex',oRouteSheet);

        sessionStorage.clear();
        sessionStorage.setItem("Operation", "Copy");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("RouteSheetHeader", "View Production");
        sessionStorage.setItem("RouteSheets", JSON.stringify($('#tblRouteSheet').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        sessionStorage.setItem("BUID", _nBUID);
        window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId="+oRouteSheet.RouteSheetID+"&buid="+_nBUID+"&ts="+tsv;
    });
    $("#btnReDyeing").click(function () {
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblRouteSheet').datagrid('getRowIndex',oRouteSheet);

        sessionStorage.clear();
        sessionStorage.setItem("Operation", "ReDyeing");
        sessionStorage.setItem("SelectedRowIndex", nIndex);
        sessionStorage.setItem("RouteSheetHeader", "View Production");
        sessionStorage.setItem("RouteSheets", JSON.stringify($('#tblRouteSheet').datagrid('getRows')));
        sessionStorage.setItem("BackLink", window.location.href);
        var tsv=((new Date()).getTime())/1000;
        sessionStorage.setItem("BUID", _nBUID);
        window.location.href = _sBaseAddress+ "/RouteSheet/ViewRouteSheet?nId="+oRouteSheet.RouteSheetID+"&buid="+_nBUID+"&ts="+tsv;
    });

    /*----------Order Status Change----------------*/



    //$("#btnCancel").click(function () {
    //    _nNextStatus=18;
    //    _sMessage="cancel";
    //    ChangeRSState();
    //});
    $("#btnRSState").click(function () {
        _sMessage=" Send In Floor";
        _nNextStatus=3;
        ChangeRSState();
    });

    $("#btnUndo").click(function () {
        _nNextStatus=1;
        _sMessage="Initialized";
        ChangeRSState();
    });
    function ChangeRSState(){

        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        if (oRouteSheet ==null || oRouteSheet.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        if (parseInt(oRouteSheet.RSState)>=4) { alert("Alreadt Yarn Out."); return ; }

        if(!confirm("Confirm to "+_sMessage)) return false;

        var oRSH={
            RouteSheetID : oRouteSheet.RouteSheetID,
            CurrentStatus : _nNextStatus,
            PreviousState : oRouteSheet.RSState,
            EventTime : new Date(),
            EventEmpID : 0
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSH,
            ObjectId: oRSH.RouteSheetID,
            ControllerName: "RouteSheet",
            ActionName: "ChangeRSStatus",
            TableId: "tblRouteSheet",
            IsWinClose: false,
            Message: _sMessage.charAt(0).toUpperCase()+_sMessage.slice(1) +" Successfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetID > 0) {
                    OperationPerforms(-1, response.obj);
                }
            }
        });
    }
    function RefreshControlLayout()
    {
        $("#btnAdd,#btnEdit,#btnView,#btnDelete,#btnCopy,#btnReDyeing,#btnUndo,#btnRSState,#btnAddMachineLiquor").hide();
        if (PermissionChecker('Add', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnAdd").show();}
        if (PermissionChecker('Edit', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
        if (PermissionChecker('View', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnView").show();}
        if (PermissionChecker('Delete', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
        // if (PermissionChecker('Issued', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnRSState").show();}
        if (PermissionChecker('Approved', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnRSState").show();}
        if (PermissionChecker('UnApproved', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnUndo").show();}
        if (PermissionChecker('Copy', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnCopy").show();}
        if (PermissionChecker('Edit', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnReDyeing").show();}
        if (PermissionChecker('Revise', 'RouteSheet',_oAuthorizationRolesMapping)) {$("#btnAddMachineLiquor").show();}

    }

    //NAZMUL : 18/11/19
    //****************************(Machine Picker)*********************************//
    $("#btnAddMachineLiquor").click(function (e) {
        debugger;
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        $('#txtBatchNoML').val(oRouteSheet.RouteSheetNo);
        $('#txtOrderNoML').val(oRouteSheet.OrderNoFull);
        $('#txtCottonLiquor').val(parseFloat(oRouteSheet.TtlCotton));
        $('#txtQtyDummy').val(parseFloat(oRouteSheet.QtyDye));
        $('#txtQtyOmit').val(parseFloat(oRouteSheet.QtyOmit));
        
        $('#txtMachineName').val(oRouteSheet.MachineName);
        $('#cboRSShiftRS').val(oRouteSheet.RSShiftID);
      
        $('#btnLabel').val(oRouteSheet.Label);
        $('#txtTtlLiquire').val(parseFloat(oRouteSheet.TtlLiquire));
        var oResult={MachineID:oRouteSheet.MachineID,Name:oRouteSheet.MachineName};
        SetMachine(oResult);
        $('#divRSs').data('MachineLiquor',oResult);
        $("#winMachineLiquor").icsWindow('open',"Edit Machine Liquor");
    });
    $("#btnMachineLiquorClose").click(function (e) {
        $("#winMachineLiquor").icsWindow('close');
    });

    $("#txtMachineName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            PickTypeWiseMachines();
        }
    });

    function PickTypeWiseMachines()
    {
        var oMechine = {
            Name : $('#txtMachineName').val(),
            MachineTypeID : $('#cboMachineType').val(),
            BUID : sessionStorage.getItem('BUID')
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMechine,
            ControllerName: "DUPSchedule",
            ActionName: "SearchMachineType",
            IsWinClose: false
        };
        debugger;
        var tblColums = [];
        var oColumn = { field: "Code", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Name", title: "Name", width: 180, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "MachineTypeName", title: "Machine Type ", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Capacity", title: "Capacity", width: 180, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "SequenceNo", title: "SL", width: 40, align: "left" }; tblColums.push(oColumn);

        var oPickerMachines = {
            winid: 'winPickerMachine',
            winclass: 'clsMachinePicker',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblMachinePicker',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'Name',
            windowTittle: 'Machine List',
            paramObj: obj,
            pkID: 'MachineID',
            callBack: SetMachine
        };
        $.icsDynamicPicker(oPickerMachines);
    }
    function SetMachine(oResult)
    {
        debugger;
        if(oResult.MachineID>0)
        {
            $('#txtMachineName').data('MachineID', oResult.MachineID);
            $('#txtMachineName').val(oResult.Name);
            $('#txtMachineName').addClass('fontColorOfPickItem');
            $('#divRSs').data('MachineLiquor',oResult);
            //LOAD MACHINE LABEL
       
        }
        else
        {
            $('#txtMachineName').val('');
            $('#txtMachineName').data('MachineID', '');
            $('#txtMachineName').removeClass('fontColorOfPickItem');
            $('#divRSs').data('MachineLiquor',null);
        }
    }


    $("#btnLabel").click(function () {
        debugger;
        if(parseInt($('#divRSs').data('MachineLiquor').MachineID)<=0 ){ alert("Type machine name to search."); return false; }
        var nMachineID=parseInt($('#divRSs').data('MachineLiquor').MachineID);
        var oMachineLiquor = {
            MachineID : nMachineID
        };
        if(parseInt(oMachineLiquor.MachineID)<=0 ){ alert("Type machine name to search."); return false; }
        GetMachineLabel(oMachineLiquor);
    });
    function GetMachineLabel(oMachineLiquor)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachineLiquor,
            ControllerName: "RouteSheet",
            ActionName: "GetMachineLabelByMachineID",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].MachineID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Label", title: "Label", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Liquor", title: "Liquor", width: 150, align: "left" };tblColums.push(oColumn);
                  
                    var oPickerParam = {
                        winid: 'winMachineLabelPicker',
                        winclass:'clsMachineLabelPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Label',
                        windowTittle: 'Liquor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine Liquor found.");
            }
        });


    }

    $('#btnMachineLiquorSave').click(function(){
        debugger;
        var oRouteSheet = $('#tblRouteSheet').datagrid('getSelected');
        var nSelectedRowIndex=$('#tblRouteSheet').datagrid('getRowIndex', oRouteSheet);
        var oRouteSheetEdit =
            {
                RouteSheetID : parseInt(oRouteSheet.RouteSheetID),
                MachineID: parseInt($('#txtMachineName').data('MachineID')),
                TtlLiquire : parseFloat(TempRemoveComma($("#txtTtlLiquire").val())),
                TtlCotton : parseFloat($("#txtCottonLiquor").val()),
                QtyDye : parseFloat($("#txtQtyDummy").val()),
                QtyOmit : parseFloat($("#txtQtyOmit").val()),
                Label:parseInt($('#btnLabel').val()),
                RSShiftID : parseInt($('#cboRSShiftRS').val())
            }
        debugger;
        //if(!ValidateInput()){return;}
        $.ajax({
            type: "POST",
            dataType: "json",
            url :  _sBaseAddress+"/RouteSheet/RouteSheetEditSave",
            traditional: true,
            data:  JSON.stringify(oRouteSheetEdit),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                oRouteSheet = jQuery.parseJSON(data);
                if (oRouteSheet.ErrorMessage=="" || oRouteSheet.ErrorMessage==null)
                {
                    $('#tblRouteSheet').datagrid('updateRow',{index : nSelectedRowIndex, row:oRouteSheet});
                    alert("Data Saved sucessfully");
                    $("#winMachineLiquor").icsWindow('close');
                                        //RefreshML();
                }
                else
                {
                    alert(oRouteSheet.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    });

        //*****************************(END)*****************************************//
    //REMOVE COMMA
    function TempRemoveComma(userInput) {
        var amountInString = "";
        if (userInput === null || userInput === "") {
            amountInString = "0.00";
        }
        else {
            amountInString = "";
            for (var i = 0; i < userInput.length; i++) {
                var char = userInput.charAt(i);
                var charForCheck = char;
                char = char.match(/\d+/g);
                if (char != null) {
                    amountInString = amountInString + userInput.charAt(i);
                    count = 1;
                }
                else if (charForCheck == ",") {
                    continue;
                }
                else if (charForCheck == ".") {
                    amountInString = amountInString + userInput.charAt(i);
                }
            }
        }
        //debugger;
        return (isNaN(parseFloat(amountInString)) ? parseFloat(0.00) : parseFloat(amountInString)).toFixed(3);
    }
    function TempAddComma(nStr) {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? '.' + x[1] : '';
        var process = /(\d+)(\d{3})/;
        while (process.test(x1)) {
            x1 = x1.replace(process, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }


</script>
