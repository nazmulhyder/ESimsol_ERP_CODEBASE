@{
    ViewBag.Title = "Ready beams for weaving";
}
@model IEnumerable<ESimSol.BusinessObjects.FabricBatchLoom>


<html>
    <head>
        <title>Ready beams for weaving</title>
    </head>
    <body>

        <div class="menuMainCollectionTable">
                <table id="tblFabricBatchLooms" title="Ready beams for weaving" class="easyui-datagrid" style="height:570px; width:100%;" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="true" toolbar="#toolbarBeam">
                    <thead>
                        <tr>
                            <th data-options="field:'Selected',checkbox:true"></th>
                            <th field="Construction" width="12%">Construction</th>
                            <th field="OrderNo" width="10%">Dispo No</th>
                            <th field="BuyerName" width="15%">Buyer</th>
                            <th field="FabricWeave" width="10%">Weave</th>
                            <th field="TotalEnds" width="8%" align="right">Total Ends</th>
                            <th field="BeamNo" width="8%">Beam No</th>
                            <th field="QtyInMtr" width="10%" align="right" formatter="formatPrice">Beam Length(M)</th>
                            <th field="StatusSt" width="10%" formatter="formatStatus">Status</th>
                            <th field="FabricMachineName" width="12%">Loom</th>
                            <th field="QtyProInM" width="10%" align="right" formatter="formatPrice">Loom Qty(M)</th>
                            <th field="RemainingQtyInM" width="10%" align="right" formatter="formatPrice">Yet Qty(M)</th>
                            <th field="BatchNo" width="12%">Program No</th>
                            <th field="FabricBatchStatusInString" width="12%">Batch Status</th>
                            <th field="SizingFinishDateStr" width="12%">Sizing Date</th>
                            <th field="LowerUpperType" width="10%">Type</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbarBeam">
                    <table class="ms-custom-control">
                        <tr>
                            <td class="form-inline">
                                <input id="txtDispoNo" type="text" placeholder="Type Dispo No & Press Enter" style="width:165px;" />
                                <input id="txtLoomNoGrid" type="text" placeholder="Type Loom No & Press Enter" style="width:165px;" />
                                <input id="txtBeamNoGrid" type="text" placeholder="Type Beam No & Press Enter" style="width:165px;" />
                                <select id="cboStatus" class="form-control" style="width:130px">
                                    <option value="0">--Loom Status--</option>
                                    <option value="1">Loom Running</option>
                                    <option value="3">Ready For Loom</option>
                                    <option value="2">Hold Loom</option>
                                    @*<option value="3">Hold Beam</option>*@
                                </select>
                                <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                                <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
                                
                                <a id="btnCreateWeaving" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Weaving</a>
                                <a id="btnDeleteWeaving" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                                <a id="btnPrintLoomRunning" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Ready Beam In Stock</a>
                            </td>
                        </tr>
                        
                    </table>

                </div>

                <div id="winProposeLoom" style="width:200px;" class="easyui-window" title="Fabric Batch" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
                    <div id="divwinFabricBatch" tabindex="-1">
                        <fieldset>
                            <table style="width:100%;">
                                <tr>

                                    <td>
                                        <input id="txtProposeLooms" type="text" style="width:86%;" class="number" />
                                    </td>
                                </tr>
                            </table>
                        </fieldset>
                        <fieldset>
                            <legend>Actions</legend>
                            <div style="float:right;">
                                <a id="btnOKProposeLoomWindow" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true"> OK </a>
                                <a id="btnCloseProposeLoomWindow" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div id="winComingBeamFinished" style="width:400px;" class="easyui-window" title="Fabric Batch" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
                    <div id="divwinFabricBatch" tabindex="-1">
                        <fieldset>
                            <table style="width:100%;">
                                <tr>
                                    <td>
                                        <label>Coming Beam Qty</label>
                                    </td>
                                    <td>
                                        <input id="txtComingBeam" type="text" style="width:50%;" class="number" />
                                    </td>
                                </tr>
                            </table>
                        </fieldset>
                        <fieldset>
                            <legend>Actions</legend>
                            <div style="float:right;">
                                <a id="btnOKDailyLogReport" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-excel" plain="true"> OK </a>
                                <a id="btnCloseDailyLogReport" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div id="winImport" style="width:600px;" class="easyui-window" title="Fabric Batch" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
                    <div>
                        @using (Html.BeginForm("ViewFabricBatchProductioUpload", "FabricBatchProduction", FormMethod.Post, new { enctype = "multipart/form-data" }))
                        {
                            <fieldset>

                                <table style="width:100%;">
                                    <tr>
                                        <td>

                                            <div class="col-md-5"><input type="file" id="fileImport" name="fileImport" /></div>

                                        </td>

                                    </tr>
                                    <tr>
                                        <td>
                                            <input type="text" id="Params" name="Params" hidden />
                                            Shift :<select id="cboShift" name="cboShift"></select>&nbsp;
                                            Date :
                                            <input id="txtFinishDate" style="width:150px;" type="text" class="easyui-datebox" required="required" name="txtFinishDate" value="date()" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                            <input id="txtFinishTimer" class="easyui-timespinner" style="width:60px;" name="txtFinishTimer" value="00:00" required="required" />
                                            <input type="checkbox" id="chkFinishDate" name="chkBox">&nbsp; &nbsp; RunOut &nbsp; &nbsp;
                                        </td>
                                    </tr>
                                </table>
                            </fieldset>
                            <fieldset>
                                <legend>Actions</legend>

                                <button type="submit" class="btn btn-sm" aria-label="Left Align" onclick="ValidateUpload()"> <span class="glyphicon glyphicon-import" aria-hidden="true"></span> Import</button>
                                <a id="btnCloseImportLoomWindow" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>

                            </fieldset>
                        }

                    </div>
                </div>

        </div>

        <div id="winWeavingProcess" style="width:1200px;height:560px" class="easyui-window winstyle" title="Fabric Batch Weaving Process" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="padding-left:0px; padding-right:0px; padding-top:2px;">
                <fieldset>
                    <legend>Basic Information</legend>
                    <div style="margin:0 auto;width:90%;">
                        <table border="0" cellpadding="1" cellspacing="1">
                            <tr>
                                <td style="width:15%; text-align:right;">Construction :</td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" id="txtConstruction" style="width:260px;" disabled />
                                </td>
                                <td style="width:15%; text-align:right;">Sizing Beam :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtBeamQtyY" class="number" disabled /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtBeamQtyM" class="number" disabled />&nbsp;(M)
                                </td>

                                @*<td style="width:15%; text-align:right;">Beam No :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:96px;" id="txtBeamNo" disabled />
                                    <input type="text" style="width:78px;" id="txtBeamQtyY" disabled />
                                    <input type="text" style="width:78px;" id="txtBeamQtyM" disabled />
                                    <input type="text" style="width:272px;display:none;" id="txtBatchNo" disabled />
                                </td>*@
                            </tr>                            
                            <tr>
                                <td style="width:15%; text-align:right;">Textile Sub Unit :</td>
                                <td style="width:40%;text-align:left;">
                                    <select style="width:80px;" id="cboTextileSubUnit" onchange="ChangeTSU()"></select>
                                    Dispo: 
                                    <input type="text" id="txtDispo" style="width:139px;" disabled />
                                </td>
                                <td style="width:15%; text-align:right;">Yet To Weaving :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtYetToWeavLengthY" class="number" disabled /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtYetToWeavLengthM" class="number" disabled />&nbsp;(M)
                                </td>
                            </tr>

                            <tr>
                                <td style="width:10%; text-align:right;">Machine Name :</td>
                                <td style="width:40%;text-align:left;">
                                    <select style="width:260px;" id="cboMachineName" onchange="MachineChange()"></select>
                                </td>
                                
                                <td style="width:15%; text-align:right;">Finish Length :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtTotalFinishLengthY" class="number" disabled /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtTotalFinishLengthM" class="number" disabled />&nbsp;(M)
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">
                                    RPM :
                                </td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" style="width:80px;" id="txtRPM" class="number" />
                                    Reed Count:
                                    <input type="text" style="width:45px;" id="txtReedCount" class="number" />
                                    <span>/</span>
                                    <input type="text" style="width:45px;" id="txtDent" />
                                </td>
                                <td style="width:15%; text-align:right;">No Of Color :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:258px;" id="txtNoOfColor" disabled />
                                </td>
                                
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">Start Time :</td>
                                <td style="width:40%;text-align:left;">
                                    <input id="txtStartDate" style="width:145px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                    <a id="btnRun" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Run</a>
                                    <a id="btnChangeReedDent" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Edit</a>
                                </td>
                                <td style="width:15%; text-align:right;">Texture :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:258px;" id="txtTexture" disabled />
                                </td>
                            </tr>

                            <tr>
                                <td style="width:10%; text-align:right;">End Time :</td>
                                <td style="width:40%;text-align:left;">
                                    <input id="txtEndDate" style="width:145px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                    <a id="btnRunOut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Out</a>
                                    <a id="btnHold" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Hold</a>
                                </td>
                                <td style="width:15%; text-align:right;">Weaving Duration :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:258px; margin-right:5px" id="txtWeavingDuration" disabled />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">Shift :</td>
                                <td style="width:40%;text-align:left;">
                                    <select style="width:260px;" id="cboBatchShift"></select>
                                </td>
                                <td style="width:15%; text-align:right;">Efficiency :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtEfficiency" class="number" /> &nbsp;Pick&nbsp;
                                    <input type="text" style="width:118px;" id="txtPick" class="number"  />
                                </td>
                            </tr>
                        </table>
                    </div>
                </fieldset>
            </div>
            
            <table id="tblFBLoomDetail" class="easyui-datagrid" style="height:44%;width:100%" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" data-options="onClickRow: onClickRowBatchMan" toolbar="#toolbarBatchMan">
                <thead>
                    <tr>
                        @*<th field="EmployeeName" width="200">Batch Man</th>*@
                        <th field="ShiftNameWithDuration" width="120">Shift</th>
                        <th field="Qty" width="80" align="right">Len(Y)</th>
                        <th field="QtyInM" width="80" align="right">Len(M)</th>
                        <th field="FinishDateInString" width="120">Date</th>
                        <th field="Efficiency" width="80" align="right">Efficiency</th>
                        <th field="RPM" width="80" align="right">RPM</th>
                        <th field="Warp" width="80" align="right">Warp</th>
                        <th field="Weft" width="80" align="right">Weft</th>
                        @*<th field="TotalFBPBreakage" width="10%" align="right">Breakage</th>
                    <th field="TotalNoOfBreakage" width="12%" align="right">No of Breakage</th>*@
                        <th data-options="field:'Note',align:'left',editor:{type:'text'}" width="100">Remark</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarBatchMan">
                Batch Man:
                <select id="cboBatchMan" style="width:100px;"></select>
                Shift:
                <select id="cboHRMShift" style="width:100px;"></select>
                Date:
                <input id="txtDetailFinishDate" style="width:120px" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                RPM:
                <input type="text" id="txtFPBRPM" style="width:50px" class="number" />
                Efficiency:
                <input type="text" id="txtEff" style="width:50px" class="number" />
                Warp:
                <input type="text" id="txtWarp" style="width:50px" class="number" />
                Weft:
                <input type="text" id="txtWeft" style="width:50px" class="number" />
                Production Length:
                <input type="text" id="txtFinishLengthY" style="width:65px" class="number" disabled />(Y)
                <input type="text" id="txtFinishLengthM" style="width:65px" class="number"  />(M)
                
                <a id="btnAddLoomDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="AddFBLDetail()">Add</a>
                <a id="btnDeleteBatchMan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="DeleteFBLDetail()">Remove</a>
                <a id="btnTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Breakages</a>
            </div>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                    <tr>
                        <td style="width:60%;text-align:left;"></td>
                        <td style="width:40%;text-align:right;">
                            @*<a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;" onclick="Save(false)">Save</a>*@
                            <a id="btnClosePS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>

        <div id="winAdvSearch" class="easyui-window winClass" style="width:550px;" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <table style="width:100%;">
                <tr>
                    <td>
                        <fieldset style="margin-bottom: 0px;">
                            <legend>Searching Criteria</legend>
                            <table>

                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Sub-Textile: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <select id="cboTextileSubUnitAdv" style="width:100%"></select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Order No: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <input id="txtOrderNoAdv" type="text" placeholder="Type Order No" style="width:100%;" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Buyer: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <input id="txtBuyerAdv" type="text" placeholder="Type Buyer Name & Press Enter" style="width:90%;" />
                                        <a id="btnBuyerAdv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Machine No: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <input id="txtMachineNo" type="text" placeholder="Type Machine No" style="width:100%;" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Beam No: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <input id="txtBeamNoAdv" type="text" placeholder="Type Beam No" style="width:100%;" />
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Prod. Date :</label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <table style="width:100%;">
                                            <tr>
                                                <td style=" width:28%;"><select id="cboProductionDateAdv" onchange="DateActions_ProductionDateAdv()" style=" width:100%;height:22px;"></select> </td>
                                                <td style="width: 33%;"><input id="txtFromProductionDateAdv" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                <td style="width: 6%;text-align:center">To</td>
                                                <td style="width: 33%;"><input id="txtToProductionDateAdv" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>

                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Start Date :</label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <table style="width:100%;">
                                            <tr>
                                                <td style=" width:28%;"><select id="cboStartDate" style=" width:100%;height:22px;"></select> </td>
                                                <td style="width: 33%;"><input id="txtStartDateStart" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                <td style="width: 6%;text-align:center">To</td>
                                                <td style="width: 33%;"><input id="txtStartDateEnd" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>End Date :</label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <table style="width:100%;">
                                            <tr>
                                                <td style=" width:28%;"><select id="cboEndDate" style=" width:100%;height:22px;"></select> </td>
                                                <td style="width: 33%;"><input id="txtEndDateStart" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                                <td style="width: 6%;text-align:center">To</td>
                                                <td style="width: 33%;"><input id="txtEndDateEnd" type="text" style="width: 100%;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>                                
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>First Droping status:</label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <select id="cboDropingStatus" style="width:100%;">
                                            <option value="0">--Select One--</option>
                                            <option value="1">No Dropping</option>
                                            <option value="2">Dropping (01-20)M</option>
                                            <option value="3">Dropping (20-50)M</option>
                                            <option value="4">Dropping (50-100)M</option>
                                            <option value="5">Dropping (100-500)M</option>
                                            <option value="6">Dropping (500 More)M</option>

                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Last Droping status:</label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <select id="cboLastDropingStatus" style="width:100%;">
                                            <option value="0">--Select One--</option>
                                            <option value="1">No Dropping</option>
                                            <option value="2">Dropping (01-20)M</option>
                                            <option value="3">Dropping (20-50)M</option>
                                            <option value="4">Dropping (50-100)M</option>
                                            <option value="5">Dropping (100-500)M</option>
                                            <option value="6">Dropping (500 More)M</option>

                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style=" width:26%;text-align:right;">
                                        <label>Reed Count: </label>
                                    </td>
                                    <td colspan="3" style="width:74%;text-align:left;">
                                        <input id="txtReedCountAdv" type="text" placeholder="Type Reed Count" class="number" style="width:100%;" />
                                    </td>
                                </tr>
                                <tr>
                                    <td height="5px" colspan="4"></td>
                                </tr>
                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>

            <fieldset class="actionfieldsetstyle">
                <legend>Actions : </legend>
                <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
                <a id="btnPrintShiftWiseReportXL" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">XL</a>
                <a id="btnPrintShiftWiseReport" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Shift Wise Report</a>
                <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
            </fieldset>
        </div>

        <div id="winTotalBreakageInformation" class="easyui-window" title="Total Breakage Information" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div style="width:915px; margin-left:2px;">
                <table id="tblFBPBreakage" class="easyui-datagrid" style="height:250px;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarBreakage" data-options="onClickRow: onClickRowBreakage">
                    <thead>
                        <tr>
                            <th field="FabricBreakageName" width="250">Break Description</th>
                            <th data-options="field:'DurationInMin',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="150" align="right">Duration(Min)</th>
                            <th data-options="field:'NoOfBreakage',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="150" align="right">No Of Breakage</th>
                            <th data-options="field:'Note',align:'left',editor:{type:'text'}" width="100">Remark</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbarBreakage">
                    Break :<select id="cboBreakage" style="width:250px;"></select>&nbsp;
                    Duration :<input type="text" id="txtDuration" class="easyui-numberbox" data-options="min:0,precision:0" style="width:100px" />(Min)&nbsp;
                    No Of Breakage :<input type="text" id="txtNumberOfBreakage" class="easyui-numberbox" data-options="min:0,precision:0" style="width:100px" />&nbsp;
                    <a id="btnAddBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                    <a id="btnDeleteBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                    <a id="btnRefreshBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                </div>
                <table>
                    <tr>
                        <td style="width:702px;"></td>
                        <td>Total : <label id="lblTotalNoOfBreakage">0</label></td>
                    </tr>
                </table>
                <fieldset>
                    <legend>Actions : </legend>
                    <div style="float:right;">
                        @*<a id="btnOkTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>*@
                        <a id="btnCloseTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>
            </div>
        </div>
        
    </body>
</html>
<style>
    #toolbarBeam .ms-custom-control .col-lg-5, .col-lg-7, .col-md-5, .col-md-7{
        padding-left:0px;
        padding-right:0px;
    }
</style>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oFabricBatchLooms = [];
    var _sBuyerIDs="";
    var _oHRMShifts=[];
    var _oRSShifts=[];
    var _IsClear=false;
    var _nBUID=0;
    var _oFabricBreakages = [];
    $(document).ready(function () {
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oAuthorizationRolesMapping = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oFabricBatchLooms = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var MenuID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MenuID));
        var oTextileSubUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.TextileSubUnits));
        _oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.HRMShifts));
        _oRSShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RSShifts));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BUID));
        var oCompareOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        _oFabricBreakages = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricBreakages));
        $("#cboTextileSubUnitAdv").icsLoadCombo({List: oTextileSubUnits,OptionValue: "TSUID", DisplayText: "Name", InitialValue:'--Select Shade--'});
        $("#cboTextileSubUnit").icsLoadCombo({List: oTextileSubUnits,OptionValue: "TSUID", DisplayText: "Name", InitialValue:'--Select Shade--'});
        $("#cboBreakage").icsLoadCombo({List: _oFabricBreakages,OptionValue: "FBreakageID",DisplayText: "Name"});
        //$("#cboBatchShift").icsLoadCombo({List: _oHRMShifts,OptionValue: "ShiftID",DisplayText: "ShiftWithDuration"});
        $("#cboBatchShift").icsLoadCombo({List: _oRSShifts,OptionValue: "RSShiftID",DisplayText: "Name"});

        $("#cboProductionDateAdv").icsLoadCombo({List:oCompareOperators,OptionValue: "id",DisplayText: "Value",});
        $("#cboStartDate").icsLoadCombo({List:oCompareOperators,OptionValue: "id",DisplayText: "Value",});
        $("#cboEndDate").icsLoadCombo({List:oCompareOperators,OptionValue: "id",DisplayText: "Value",});

        sessionStorage.setItem("MenuID", MenuID);
        var oSessionList = jQuery.parseJSON(sessionStorage.getItem("Beams"));
        if(oSessionList!=null && oSessionList!="null" && oSessionList.length > 0)
        {
            DynamicRefreshListForMultipleSelection(oSessionList,"tblFabricBatchLooms");
        }
        else{
            DynamicRefreshListForMultipleSelection(_oFabricBatchLooms, "tblFabricBatchLooms");
        }
        debugger;
        $("#txtProposeLooms").val(200);
        $("#winWeavingProcess").data("FabricBatchLoom",null);

        $("#btnDeleteWeaving").hide();
        if(PermissionChecker('Delete','FabricBatchLoom', oAuthorizationRolesMapping)){$("#btnDeleteWeaving").show();}
    });

    $('#cboStartDate').change(function(e){
        //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
        var nCompareOperator =   parseInt($('#cboStartDate').val());
        if(nCompareOperator===0)
        {
            $('#txtStartDateStart').datebox({ disabled : true });
            $('#txtStartDateEnd').datebox({ disabled : true });
        }
        else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
        {
            $('#txtStartDateStart').datebox({ disabled : false });
            $('#txtStartDateEnd').datebox({ disabled : true });
        }
        else
        {
            $('#txtStartDateStart').datebox({ disabled : false });
            $('#txtStartDateEnd').datebox({ disabled : false });
        }
        $('#txtStartDateStart').datebox('setValue', icsdateformat(new Date()));
        $('#txtStartDateEnd').datebox('setValue', icsdateformat(new Date()));
    });

    function DateActions_ProductionDateAdv() {
        DynamicDateActions("cboProductionDateAdv", "txtFromProductionDateAdv", "txtToProductionDateAdv");
    }

    $('#cboEndDate').change(function(e){
        //EqualTo = 1, NotEqualTo = 2, GreaterThen = 3, SmallerThen = 4, Between = 5, NotBetween = 6
        var nCompareOperator =   parseInt($('#cboEndDate').val());
        if(nCompareOperator===0)
        {
            $('#txtEndDateStart').datebox({ disabled : true });
            $('#txtEndDateEnd').datebox({ disabled : true });
        }
        else if (nCompareOperator===1 || nCompareOperator===2 || nCompareOperator===3 || nCompareOperator===4)
        {
            $('#txtEndDateStart').datebox({ disabled : false });
            $('#txtEndDateEnd').datebox({ disabled : true });
        }
        else
        {
            $('#txtEndDateStart').datebox({ disabled : false });
            $('#txtEndDateEnd').datebox({ disabled : false });
        }
        $('#txtEndDateStart').datebox('setValue', icsdateformat(new Date()));
        $('#txtEndDateEnd').datebox('setValue', icsdateformat(new Date()));
    });

    function formatStatus(val,row){
        if (row.WeavingProcessType==1){
            return '<div style="background-color:#E3BFF6; width:100%; height:100%">'+val+'</div>';
        }
        else if (row.WeavingProcessType==3 && row.EndTimeStr==""){
            return '<div style="background-color:#80C761;width:100%">'+val+'</div>';
        }
        else if (row.WeavingProcessType==3 && row.EndTimeStr!=""){
            return '<div style="background-color:#17B1EA;width:100%">'+val+'</div>';
        }
        else
            return val;
    }

    $("#btnPrintFBPB").click(function(){

        var oFabricBatchLooms = $("#tblFabricBatchLooms").datagrid("getRows");
        if(!oFabricBatchLooms.any()){
            alert("No data found.");
            return false;
        }
        var objs=[{key:'txtFBPBList', data: oFabricBatchLooms.select('FabricBatchLoomID').separator() }];
        OpenWindowWithPost(_sBaseAddress+'/FabricBatchProduction/PrintFBPB',objs )

        //var nts = ((new Date()).getTime()) / 1000;
        //window.open(_sBaseAddress + '/FabricBatchProduction/PrintFabricBatchLoom?nFabricID=' + oFabric.FabricID + "&nts=" + nts, "_blank");
    });


    $("#btnRefreshGrid").click(function(e){
        _IsClear=false;
        DynamicRefreshListForMultipleSelection(_oFabricBatchLooms, "tblFabricBatchLooms");

    });

    $("#btnRemoveFromList").click(function(e){
        _IsClear=true;
        DynamicRefreshListForMultipleSelection([], "tblFabricBatchLooms");

    });

    $("#btnSearch").click(function(){
        debugger;
        if(parseInt($("#cboStatus").val()) <= 0){
            alert("Please select status!!");
            return;
        }
        var oFabricBatchLoom={
            Status : $("#cboStatus").val()
        };
        SearchFBPB(oFabricBatchLoom);
    });

    $("#btnBuyerAdv").click(function(){
        var oContractor = {
            Params: 2 + '~' + ''
        };
        PickBuyer(oContractor);
    });

    $("#txtBuyerAdv").keydown(function (e) {
        if (e.keyCode === 13) {
            var oContractor = {
                Params: 2 + '~' + $.trim($("#txtBuyerAdv").val())
            };
            PickBuyer(oContractor);
        }
        else if (e.keyCode === 8) {
            _sBuyerIDs = "";
            $(this).val("");
            //DynamicRefreshList(_oFabricBatchLooms, "tblFabricBatchLooms");
        }
    });

    function PickBuyer(oContractor){
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 400, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winBuyers',
                        winclass: 'clsBuyer',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblBuyers',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Buyer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Buyer Found.");
            }
        });
    }

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        var oreturnObj = null, oreturnobjs = [];

        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }

        if (oPickerobj.winid == 'winBuyers') {
            if (oreturnObjs != null && oreturnObjs.length > 0) {
                var sBuyerIDs = "";
                for (var i = 0; i < oreturnObjs.length; i++) {
                    sBuyerIDs += oreturnObjs[i].ContractorID + ","
                }
                _sBuyerIDs = sBuyerIDs.substring(0, sBuyerIDs.length - 1);
                $('#txtBuyerAdv').val(oreturnObjs.length + " buyer" + (oreturnObjs.length > 1 ? "s" : "") + " selected.");
                $('#txtBuyerAdv').focus();
            }
            else {
                alert("Select item(s) from list.");
                return false;
            }
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function SearchFBPB(oFabricBatchLoom)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatchLoom,
            ControllerName: "FabricBatchLoom",
            ActionName: "SearchFBPB",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if ($.trim(response.objs[0].Errormessage) == "") {
                    if(_IsClear){
                        var results= response.objs;
                        for(var i=0; i<results.length;i++){
                            $('#tblFabricBatchLooms').datagrid('appendRow',results[i]);

                        }
                    }
                    else{
                        DynamicRefreshListForMultipleSelection(response.objs, "tblFabricBatchLooms");
                    }

                }
                else{
                    alert(response.objs[0].Errormessage);
                    // DynamicRefreshList([], "tblFabricBatchLooms");
                }
            }
            else {
                alert("Data not found!!");
                DynamicRefreshList([], "tblFabricBatchLooms");
            }
        });
    }

    //$('#btnReadyBeamStock').click(function(e){
    //    $("#txtProposeLooms").val(200);
    //    $("#winProposeLoom").icsWindow("open");
    //});

    $('#btnPrintLoomRunning').click(function(e){
        $("#txtProposeLooms").val(200);
        $("#winProposeLoom").icsWindow("open");
    });

    $("#btnCloseProposeLoomWindow").click(function(){
        $("#winProposeLoom").icsWindow("close");
    });

    $("#btnOKProposeLoomWindow").click(function(){
        var TotalEnds = (($("#txtProposeLooms").val())!="")? $("#txtProposeLooms").val() :200;

        window.open(_sBaseAddress + '/FabricBatchLoom/PrintRptReadyBeamInStock?TotalEnds='+TotalEnds+'&nBUID='+_nBUID, "_blank");
        $("#winProposeLoom").icsWindow("close");
    });

    $('#btnExcelDailyLog').click(function(e){


        $("#txtComingBeam").val(200);
        $("#winComingBeamFinished").icsWindow("open");
    });

    $("#btnOKDailyLogReport").click(function () {
        $("#winComingBeamFinished").icsWindow("close");
        window.open(_sBaseAddress + '/FabricReport/ExcelDailyLogReport?tsuid='+$('#cboTextileSubUnitAdv').val()+'&sParams=' + (new Date()).toISOString() + '~' + "" + "~" + "" + "~" +0 + "~" + 0 + "~" + ""+"~"+0+"~"+$("#txtComingBeam").val(), "_blank");

    });
    $("#btnCloseDailyLogReport").click(function () {
        $("#winComingBeamFinished").icsWindow("close");

    });


    $("#cboShift,#chkFinishDate").change(function(){
        debugger;

        var chkDate = ($('#chkFinishDate').is(':checked'))? true :false;
        $('#txtFinishDate').datebox('setValue', icsdateformat(new Date()));
        if($('#cboShift').val()==1)
        {
            if(chkDate){
                $('#txtFinishTimer').timespinner('setValue', "14:00");
            }
            else{
                $('#txtFinishTimer').timespinner('setValue', "06:00");
            }
        }
        if($('#cboShift').val()==2)
        {
            if(chkDate){
                $('#txtFinishTimer').timespinner('setValue', "22:00");
            }
            else{
                $('#txtFinishTimer').timespinner('setValue', "14:00");
            }
        }
        if($('#cboShift').val()==3)
        {
            if(chkDate){
                var tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                $('#txtFinishTimer').timespinner('setValue', "06:00");
                $('#txtFinishDate').datebox('setValue', icsdateformat(tomorrow));
            }
            else{
                $('#txtFinishTimer').timespinner('setValue', "22:00");
            }
        }
        if($('#cboShift').val()==0)
        {
            $('#txtFinishTimer').timespinner('setValue', "00:00");

        }
    });

    function ValidateUpload(){
        debugger;

        if ($.trim($("#fileImport").val()) == "") {
            alert("No file found");
            return false;
        }
        if(parseInt($('#cboShift').val())<=0)
        {
            alert("Select Shift !");
            $('#cboShift').focus();
            return false;
        }

        else{
            var chkDate = ($('#chkFinishDate').is(':checked'))? true :false;
            var dStartDate =$('#txtFinishDate').datebox('getValue');
            var startTime= $('#txtFinishTimer').timespinner('getValue');
            var sTime=startTime.split(':');
            var hStartTime= parseFloat(sTime[0]);
            var mStartTime= parseFloat(sTime[1]);
            dStartDate = new Date(dStartDate);
            dStartDate.setHours(hStartTime);
            dStartDate.setMinutes(mStartTime);

            document.getElementById('Params').value = $('#cboShift').val() +'~'+ icsdatetimeformat(dStartDate) +'~' +chkDate;
            return true;
        }
    }
    function RefreshValueForImportWindow(){
        $("#fileImport").val("");
        //$("#cboShift").icsLoadCombo({List: _oHRMShifts,OptionValue: "ShiftID",DisplayText: "ShiftWithDuration"});
        $("#cboShift").icsLoadCombo({List: _oRSShifts,OptionValue: "RSShiftID",DisplayText: "Name"});

        $('#txtFinishTimer').timespinner('setValue', "00:00");
        $('#txtFinishDate').datebox('setValue', icsdateformat(new Date()));
        $('#chkFinishDate').prop('checked', false);

    }
    function onClickImportWindow(){
        RefreshValueForImportWindow();
        $("#winImport").icsWindow("open");
    }

    $("#btnCloseImportLoomWindow").click(function(){
        $("#winImport").icsWindow("close");
    });

    $('#btnPrintLoomCard').click(function (e) {

        debugger;
        var getBeams = [];
        var getBeams = $("#tblFabricBatchLooms").datagrid("getChecked");
        if (getBeams.length <= 0) {
            alert("Please select an item from list.");
            return false;
        }
        var FabricBatchLoomIDs="";
        for(var i=0;i<getBeams.length;i++){
            FabricBatchLoomIDs += getBeams[i].FabricBatchLoomID+',';
        }
        FabricBatchLoomIDs= FabricBatchLoomIDs.substring(0,FabricBatchLoomIDs.length-1);
        console.log(FabricBatchLoomIDs)
        var objs = [{ key: 'txtBeams', data: FabricBatchLoomIDs}]
        var url = _sBaseAddress + '/FabricBatchProduction/PrintLoomCards'
        OpenWindowWithPost(url, objs);

    });

    //$("#btnCreateWeaving").click(function(){
    //    var oFabricBatchLoom = $("#tblFabricBatchLooms").datagrid("getSelected");
    //    if(oFabricBatchLoom == null || oFabricBatchLoom.FabricBatchLoomID <= 0)
    //    {
    //        alert("Select an item from list.");
    //        return false;
    //    }
    //    _nBUID=0;
    //    _nBUID= parseInt(sessionStorage.getItem("BUID"));

    //    var obj = {
    //        BaseAddress: _sBaseAddress,
    //        TableId: "",
    //        OpenedPageTitle: "Fabric Batch Weaving Process",
    //        Object: oFabricBatchLoom,
    //        ObjectId: oFabricBatchLoom.FabricBatchLoomID + "~" + oFabricBatchLoom.BeamID + "~" + oFabricBatchLoom.FBID + "~" + oFabricBatchLoom.FabricSalesContractDetailID +"~"+oFabricBatchLoom.FBPID+"~"+_nBUID,
    //        PrimaryKeyName: "FabricBatchLoomID",
    //        ControllerName: "FabricBatchProduction",
    //        ActionName: "View_Weaving",
    //        BtnID : $(this).attr("id")
    //    };
    //    var oBeams = $("#tblFabricBatchLooms").datagrid("getRows");
    //    sessionStorage.setItem("RBForWeavingHeader", "Ready beams for weaving");
    //    sessionStorage.setItem("FabricBatchLoomID", oFabricBatchLoom.FabricBatchLoomID);
    //    sessionStorage.setItem("Beams", JSON.stringify(oBeams));
    //    $.icsOpenPickerInNewPage(obj);
    //});

    $('#txtRPM').keyup(function(e){
        debugger;
        var nFirstPart = parseFloat($('#txtRPM').val()) * parseFloat($('#txtEfficiency').val()) * 24 * 60;
        var nSecondPart = (parseFloat($('#txtPick').val()) * 39.37 * 100);
        if(nSecondPart != 0){
            var nres = (parseFloat($('#txtBeamQtyM').val()) / (nFirstPart/nSecondPart));
            //$('#txtWeavingDuration').val(nres.toFixed(1));
            var oDt = $('#txtStartDate').datebox('getValue');
            var dt = new Date(oDt);
            var nday = parseInt(nres.toFixed(1).split(".")[0]);
            var nhr = parseInt(nres.toFixed(1).split(".")[1]);
            dt.setDate(dt.getDate() + nday);
            dt.setHours(dt.getHours()+nhr);
            var Duration = icsdatetimeformat(dt);
            $('#txtWeavingDuration').val(nres.toFixed(1) + "    (" + Duration + ")");
        }
    });

    $('#txtEfficiency').keyup(function(e){
        debugger;
        var nFirstPart = parseFloat($('#txtRPM').val()) * parseFloat($('#txtEfficiency').val()) * 24 * 60;
        var nSecondPart = parseFloat($('#txtPick').val()) * 39.37 * 100;
        if(nSecondPart != 0){
            var nres = (parseFloat($('#txtBeamQtyM').val()) / (nFirstPart/nSecondPart));
            //$('#txtWeavingDuration').val(nres.toFixed(1));
            var oDt = $('#txtStartDate').datebox('getValue');
            var dt = new Date(oDt);
            var nday = parseInt(nres.toFixed(1).split(".")[0]);
            var nhr = parseInt(nres.toFixed(1).split(".")[1]);
            dt.setDate(dt.getDate() + nday);
            dt.setHours(dt.getHours()+nhr);
            var Duration = icsdatetimeformat(dt);
            $('#txtWeavingDuration').val(nres.toFixed(1) + "    (" + Duration + ")");
        }
    });

    $('#txtPick').keyup(function(e){
        debugger;
        var nFirstPart = parseFloat($('#txtRPM').val()) * parseFloat($('#txtEfficiency').val()) * 24 * 60;
        var nSecondPart = parseFloat($('#txtPick').val()) * 39.37 * 100;
        if(nSecondPart != 0){
            var nres = (parseFloat($('#txtBeamQtyM').val()) / (nFirstPart/nSecondPart));
            //$('#txtWeavingDuration').val(nres.toFixed(1));
            var oDt = $('#txtStartDate').datebox('getValue');
            var dt = new Date(oDt);
            var nday = parseInt(nres.toFixed(1).split(".")[0]);
            var nhr = parseInt(nres.toFixed(1).split(".")[1]);
            dt.setDate(dt.getDate() + nday);
            dt.setHours(dt.getHours()+nhr);
            var Duration = icsdatetimeformat(dt);
            $('#txtWeavingDuration').val(nres.toFixed(1) + "    (" + Duration + ")");
        }
    });

    function MachineChange(){
        var nMachine = parseInt($('#cboMachineName').val());
        if(nMachine > 0){
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricMachine/GetMachineByID",
                data: {nMachine: nMachine},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFM = jQuery.parseJSON(data);
                    if(oFM.FMID > 0){
                        $('#txtRPM').val(oFM.RPM);
                        //$('#txtFPBRPM').val(oFM.RPM);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    }

    function ResetWeavingValue(){
        $("#txtConstruction").val("");
        $("#cboTextileSubUnit").val(0);
        $("#cboMachineName").val(0);
        $("#cboBatchShift").val(0);
        $("#txtRPM").val(0);
        $("#txtReedCount").val("");
        $("#txtDent").val("");
        //$("#txtBeamNo").val("");
        $("#txtDispo").val("");
        $("#txtBeamQtyY").val(0);
        $("#txtBeamQtyM").val(0);
        $("#txtYetToWeavLengthY").val("");
        $("#txtYetToWeavLengthM").val("");
        $("#txtTotalFinishLengthY").val("");
        $("#txtTotalFinishLengthM").val("");
        $("#txtNoOfColor").val("");
        $("#txtTexture").val("");
        $("#txtWeavingDuration").val("");
        $("#txtEfficiency").val(0);
        $("#txtPick").val(0);
    }

    $("#btnCreateWeaving").click(function(){
        DynamicRefreshList([],"tblFBLoomDetail");
        debugger;
        var oFabricBatchLoom = $("#tblFabricBatchLooms").datagrid("getSelected");
        if(oFabricBatchLoom == null) // || oFabricBatchLoom.FabricBatchLoomID <= 0
        {
            alert("Select an item from list.");
            return false;
        }
        $('#txtStartDate').datebox('setValue', oFabricBatchLoom.StartDateSt);
        debugger;
        var sIDs = oFabricBatchLoom.FBPBeamID + "~" + oFabricBatchLoom.BeamID + "~" + oFabricBatchLoom.FBID + "~" + oFabricBatchLoom.FSCDID +"~"+oFabricBatchLoom.FabricBatchLoomID+"~"+_nBUID+"~"+oFabricBatchLoom.FMID+"~"+oFabricBatchLoom.FLPID
        ResetWeavingValue();
        $.ajax({
            type: "GET",
            dataType: "json",
            url : _sBaseAddress+  "/FabricBatchLoom/CreateWeaving",
            traditional: true,
            data: {sIDs:sIDs},
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFabricBatchLoom = jQuery.parseJSON(data);
                if(oFabricBatchLoom!=null)
                {
                    debugger;
                    $("#winWeavingProcess").data("FabricBatchLoom",oFabricBatchLoom);
                    SetFieldValues(oFabricBatchLoom);
                    SetFabricBatchInfo(oFabricBatchLoom);
                    SetFabricBatchLoomInfo(oFabricBatchLoom);
                    $("#cboBatchMan").icsLoadCombo({List: oFabricBatchLoom.BatchMans,OptionValue: "EmployeeID",DisplayText: "Name"});
                    //$("#cboHRMShift").icsLoadCombo({List: oFabricBatchLoom.HRMShifts,OptionValue: "ShiftID",DisplayText: "ShiftWithDuration"});
                    $("#cboHRMShift").icsLoadCombo({List: _oRSShifts,OptionValue: "RSShiftID",DisplayText: "Name"});

                    if(oFabricBatchLoom.FabricBatchLoomDetails.length>0)
                    {
                        DynamicRefreshList(oFabricBatchLoom.FabricBatchLoomDetails,"tblFBLoomDetail");
                        $("#cboBatchMan").val(oFabricBatchLoom.FabricBatchLoomDetails[0].EmployeeID);
                        $("#cboHRMShift").val(oFabricBatchLoom.FabricBatchLoomDetails[0].ShiftID);
                        $('#txtDetailFinishDate').datebox('setValue', oFabricBatchLoom.FabricBatchLoomDetails[0].FinishDateInString);

                        $("#txtFPBRPM").val(oFabricBatchLoom.FabricBatchLoomDetails[0].RPM);
                        $("#txtEff").val(oFabricBatchLoom.FabricBatchLoomDetails[0].Efficiency);
                        $("#txtWarp").val(oFabricBatchLoom.FabricBatchLoomDetails[0].Warp);
                        $("#txtWeft").val(oFabricBatchLoom.FabricBatchLoomDetails[0].Weft);
                        $("#txtFinishLengthY").val(oFabricBatchLoom.FabricBatchLoomDetails[0].Qty);
                        $("#txtFinishLengthM").val(oFabricBatchLoom.FabricBatchLoomDetails[0].QtyInM);
                    }
                    SetFinishLength();
                    //else{
                    //    debugger;
                    //    var nQty = oFabricBatchLoom.Qty - oFabricBatchLoom.FabricBatchProductionBeam.Qty;
                    //    $("#txtYetToWeavLengthY").val(parseFloat(nQty).toFixed(2));
                    //    $("#txtYetToWeavLengthM").val(parseFloat(GetMeter(nQty,2)).toFixed(2));
                    //    $("#txtTotalFinishLengthY").val(parseFloat(oFabricBatchLoom.FabricBatchProductionBeam.Qty.toFixed(2)));
                    //    $("#txtTotalFinishLengthM").val(GetMeter(oFabricBatchLoom.FabricBatchProductionBeam.Qty.toFixed(2)));
                    //    DynamicRefreshList([],"tblFBLoomDetail");
                    //}

                    $("#winWeavingProcess").icsWindow('open', "Add Weaving Process");

                }
                else
                {
                    alert("Invalid Operation!");
                }

            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    function SetFabricBatchInfo(oFabricBatchLoom)
    {
        if(oFabricBatchLoom.FabricBatch.FBID > 0){

            $("#txtBatchNo").val(oFabricBatchLoom.FabricBatch.BatchNo);
            //$("#txtOrderNo").val(oFabricBatchLoom.FabricBatch.OrderNo);

            $("#txtConstruction").val(oFabricBatchLoom.FabricBatch.Construction);
            //$("#txtBuyer").val(oFabricBatchLoom.FabricBatch.BuyerName);
            //$("#txtFEOLengthY").val(ConvertToFixed2(oFabricBatchLoom.FabricBatchProductionBeam.FEOQty));
            //$("#txtFEOLengthM").val(ConvertToFixed2(oFabricBatchLoom.FabricBatchProductionBeam.FEOQtyInMtr));

            //$("#cboMachineName").val(oFabricBatchLoom.FabricBatch.FMID);

            if($.trim($("#txtTexture").val()) == ""){
                $("#txtTexture").val(oFabricBatchLoom.FabricBatch.Texture);
            }
        }
    }

    function SetFieldValues(oFabricBatchLoom)
    {
        debugger;
        if(oFabricBatchLoom.FabricBatchLoomID > 0){
            //$("#txtBeamNo").val(oFabricBatchLoom.BeamNo);
            $("#txtDispo").val(oFabricBatchLoom.OrderNo);

        }else if(oFabricBatchLoom.FabricBatchProductionBeam.BeamID>0){
            //$("#txtBeamNo").val(oFabricBatchLoom.FabricBatchProductionBeam.BeamNo);
            $("#txtDispo").val(oFabricBatchLoom.FabricBatchProductionBeam.OrderNo);

        }
        //$("#txtFEOLengthY").val(ConvertToFixed2(oFabricBatchLoom.FabricBatchProductionBeam.FEOQty));
        //$("#txtFEOLengthM").val(ConvertToFixed2(oFabricBatchLoom.FabricBatchProductionBeam.FEOQtyInMtr));

        if(oFabricBatchLoom.Status==3)// Run out
        {
            $("#btnRun, #btnChangeReedDent, #btnHold, #btnRunOut").hide();
        }
        else if(oFabricBatchLoom.Status==2)// Hold
        {
            $("#btnRun, #btnChangeReedDent, #btnRunOut").show();
            $("#btnHold").hide();
        }
        else
        {
            if(oFabricBatchLoom.FabricBatchLoomID > 0){
                $("#btnRun").hide();
                $("#btnChangeReedDent, #btnHold, #btnRunOut").show();
            }else{
                $("#btnRun").show();
                $("#btnChangeReedDent, #btnHold, #btnRunOut").hide();
            }
        }
    }

    function SetFabricBatchLoomInfo(oFabricBatchLoom)
    {
        $("#cboTextileSubUnit").val(oFabricBatchLoom.TSUID);
        $('#cboMachineName').icsLoadCombo({List: oFabricBatchLoom.FabricMachines,OptionValue: "FMID",DisplayText: "MachineCodeWithName"  });
        $("#cboMachineName").val(oFabricBatchLoom.FMID);
        debugger;
        if(oFabricBatchLoom.IsRunOut)
        {
            $("#toolbarBatchMan").hide();
            $("#cboTextileSubUnit,#cboMachineName,cboBatchShift").prop("disabled",true);

            $('#txtStartDate').datebox({disabled:true});
            $('#tpStartTime').timespinner({disabled:true});
            $('#txtEndDate').datebox({disabled:true});
            $('#tpEndTime').timespinner({disabled:true});
            $("#txtRPM,#txtReedCount,#txtDent").prop("disabled",true);
            debugger;
            $("#cboTextileSubUnit").val(oFabricBatchLoom.TSUID);
            ChangeTSU();
            $("#cboMachineName").val(oFabricBatchLoom.FMID);
            $("#cboBatchShift").val(oFabricBatchLoom.ShiftID);
            $('#tpStartTime').timespinner('setValue', oFabricBatchLoom.StartDateStForTimeSpan);
            $('#tpEndTime').timespinner('setValue', oFabricBatchLoom.EndDateStForTimeSpan);
            $('#txtStartDate').datebox('setValue', oFabricBatchLoom.StartDateSt);
            $('#txtEndDate').datebox('setValue', oFabricBatchLoom.EndDateSt);

            debugger;
            $("#txtRPM").val(oFabricBatchLoom.RPM>0?oFabricBatchLoom.RPM:"");
            $("#txtReedCount").val(oFabricBatchLoom.ReedCount>0?oFabricBatchLoom.ReedCount:"");
            $("#txtDent").val(oFabricBatchLoom.Dent);
            $("#txtTexture").val(oFabricBatchLoom.Texture);
            $('#txtWeavingDuration').val(oFabricBatchLoom.BatchDuration);
        }
        else
        {
            $("#toolbarBatchMan").show();
            if(oFabricBatchLoom.FabricBatchLoomID > 0)
            {
                $("#cboTextileSubUnit,#cboMachineName,#cboBatchShift").prop("disabled",true);

                $('#txtStartDate').datebox({disabled:true});
                $('#tpStartTime').timespinner({disabled:true});
                $('#txtEndDate').datebox({disabled:false});
                $('#tpEndTime').timespinner({disabled:false});

                $("#cboTextileSubUnit").val(oFabricBatchLoom.TSUID);
                //ChangeTSU();

                $('#tpStartTime').timespinner('setValue', oFabricBatchLoom.StartDateStForTimeSpan);
                $('#tpEndTime').timespinner('setValue', oFabricBatchLoom.EndDateStForTimeSpan);
                $('#txtStartDate').datebox('setValue', oFabricBatchLoom.StartDateSt);
                $('#txtEndDate').datebox('setValue',oFabricBatchLoom.EndDateSt == "01 Jan 0001" ? icsdateformat(new Date) : oFabricBatchLoom.EndDateSt);
                $("#cboBatchShift").val(oFabricBatchLoom.ShiftID);

                $("#txtRPM").val(oFabricBatchLoom.RPM>0?oFabricBatchLoom.RPM:"");
                //$("#txtReedCount").val(oFabricBatchLoom.ReedCount>0?oFabricBatchLoom.ReedCount:"");
                $("#txtReedCount").val(oFabricBatchLoom.ReedCount>0?oFabricBatchLoom.ReedCount:oFabricBatchLoom.FEOS.Reed);
                $("#txtDent").val(oFabricBatchLoom.Dent);
                $("#txtTexture").val(oFabricBatchLoom.Texture);
                $('#txtWeavingDuration').val(oFabricBatchLoom.BatchDuration);

                $("#txtPick").val(oFabricBatchLoom.Pick>0?oFabricBatchLoom.Pick:oFabricBatchLoom.FEOS.Picks);
                $("#txtEfficiency").val(oFabricBatchLoom.Efficiency);
                if(parseFloat(oFabricBatchLoom.RPM) <= 0)
                    MachineChange();
            }
            else
            {
                $("#cboTextileSubUnit,#cboMachineName").prop("disabled",false);
                $('#txtStartDate').datebox({disabled:false});
                $('#tpStartTime').timespinner({disabled:false});
                $('#txtEndDate').datebox({disabled:false});
                $('#tpEndTime').timespinner({disabled:false});
                $("#txtRPM,#txtReedCount,#txtDent").prop("disabled",false);

                //$("#cboTextileSubUnit,#cboMachineName").val(0);
                $('#tpStartTime').timespinner('setValue', "00:00");
                $('#tpEndTime').timespinner('setValue', "00:00");

                if ($('#txtStartDate').datebox('getValue') == null || $('#txtStartDate').datebox('getValue') == "") {
                    $('#txtStartDate').datebox('setValue', icsdateformat(new Date));
                }

                //if (_oExportLC.OpeningDateST != "-") {
                //    $('#txtOpeningDate').datebox('setValue', _oExportLC.OpeningDateST);
                //}
                $('#txtStartDate').datebox('setValue', icsdateformat(new Date));
                $('#txtEndDate').datebox('setValue', icsdateformat(new Date));

                $("#txtReedCount").val(oFabricBatchLoom.FEOS.Reed);
                $("#txtPick").val(oFabricBatchLoom.FEOS.Picks);
                MachineChange();
            }
        }
    }

    function ChangeTSU(){
        if($('#cboTextileSubUnit').val()>0){

            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: {TSUID: $('#cboTextileSubUnit').val()},
                ControllerName: 'FabricMachine',
                ActionName: 'GetsLoomMachineByTextileSubUnit',
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {
                if (response.status && response.objs != null) {
                    if (response.objs.length > 0) {
                        if(response.objs.first().FMID>0){
                            $('#cboMachineName').icsLoadCombo({List: response.objs,OptionValue: "FMID",DisplayText: "MachineCodeWithName"  });
                        }
                        else{
                            $('#cboMachineName').empty()
                        }
                    }
                    else { $('#cboMachineName').empty(); }
                }
            });

        }
    }

    $('#btnClosePS').click(function(e) {
        $("#winWeavingProcess").data("FabricBatchLoom",null);
        $("#winWeavingProcess").icsWindow('close');
    });

    $("#txtFinishLengthM").keyup(function (e) {
        var nVal = $(this).val();
        $('#txtFinishLengthY').val(GetYard(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    $("#txtFinishLengthY").keyup(function (e) {
        var nVal = $(this).val();
        $('#txtFinishLengthM').val(GetMeter(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    function ValidateInput()
    {
        if(parseInt($('#cboTextileSubUnit').val())<=0)
        {
            alert("Select Textile Sub Unit!");
            $('#cboTextileSubUnit').focus();
            return false;
        }
        if(parseInt($('#cboMachineName').val())<=0)
        {
            alert("Select machine!");
            $('#cboMachineName').focus();
            return false;
        }
        return true;
    }

    function RefreshObject()
    {
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        //var oFBPB={
        //    FBPBeamID:0,
        //    FBPID : _oFabricBatchProduction.FBPID,
        //    BeamID : _oFBPB.BeamID,
        //    Qty : _oFBPB.Qty,
        //    IsFinish : 1
        //};
        //var oFBPBs=[];
        //oFBPBs.push(oFBPB);
        debugger;
        var oFabricBatchLoom = $("#winWeavingProcess").data("FabricBatchLoom");
        var oFBL = $("#tblFabricBatchLooms").datagrid("getSelected");
        var oFabBatchLoom= {
            FabricBatchLoomID:0,
            FBID: (oFabricBatchLoom.FabricBatchLoomID == 0 ? oFabricBatchLoom.FabricBatch.FBID : oFabricBatchLoom.FBID),
            Status:1,
            FMID:$('#cboMachineName').val(),
            RPM:$('#txtRPM').val(),
            ReedCount:$('#txtReedCount').val(),
            Dent:$('#txtDent').val(),
            TSUID : $('#cboTextileSubUnit').val(),
            Texture:$('#txtTexture').val(),
            StartTime: dStartDate,
            FabricBatchStatus:8,//Weaving
            FBPriviousStatus:oFabricBatchLoom.FabricBatchStatus,//Sizing finish, Drawing or  Drawing_fionish
            Qty:oFabricBatchLoom.Qty,
            //FBPBs : oFBPBs,
            ShiftID : $('#cboBatchShift').val(),
            FBPBeamID : oFBL.FBPBeamID,
            BeamID : oFBL.BeamID,
            Efficiency : $('#txtEfficiency').val(),
            Pick : $('#txtPick').val(),
            FLPID: oFabricBatchLoom.FLPID
        };
        return oFabBatchLoom;
    }

    $("#btnRun").click(function(){
        if(!confirm("Are you sure to run?"))
            return false;
        debugger;
        var oFBL = $("#tblFabricBatchLooms").datagrid("getSelected");
        var nSelectedRowIndex=$('#tblFabricBatchLooms').datagrid('getRowIndex',oFBL);
        if (oFBL == null) { alert("Please select an item from list!"); return false; }
        if(!ValidateInput()) return false;
        var oFabricBatchLoom = RefreshObject();
        oFabricBatchLoom.FabricBatchLoomID=oFBL.FabricBatchLoomID;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchLoom/Save",
            traditional: true,
            data:  JSON.stringify(oFabricBatchLoom),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFabricBatchLoom = jQuery.parseJSON(data);
                if (oFabricBatchLoom.FabricBatchLoomID>0)
                {
                    //_oFabricBatchLoom= oFabricBatchLoom;
                    alert("Succefully Run");
                    $("#winWeavingProcess").data("FabricBatchLoom",oFabricBatchLoom);
                    $('#tpStartTime').timespinner({disabled:true});
                    $('#txtStartDate').datebox({disabled:true});
                    $('#tpStartTime').timespinner('setValue', oFabricBatchLoom.StartDateStForTimeSpan);
                    $('#txtStartDate').datebox('setValue', oFabricBatchLoom.StartDateSt);
                    $('#btnChangeReedDent, #btnHold, #btnRunOut').show();
                    $('#btnRun').hide();
                    //$('#txtSizingDuration').val(oFabricBatchLoom.BatchDuration);

                    $("#cboTextileSubUnit,#cboMachineName").prop("disabled",true);

                    $('#tblFabricBatchLooms').datagrid('updateRow', { index: nSelectedRowIndex, row: oFabricBatchLoom });
                    $('#tblFabricBatchLooms').datagrid('selectRow', nSelectedRowIndex);


                    //DynamicRefreshList(oFabricBatchLoom.FBPBs,"tblBeamsSizing");
                    //return false ;
                }
                else {
                    alert(oFabricBatchLoom.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    function AddFBLDetail()
    {
        if(parseInt($('#cboHRMShift').val())<=0)
        {
            alert("Select Shift !");
            $('#cboHRMShift').focus();
            return false;
        }
        if(parseInt($('#txtFinishLengthY').val())<=0 || $('#txtFinishLengthY').val()=="")
        {
            alert("Give finish length");
            $('#txtFinishLengthY').focus();
            return false;
        }
        if(parseInt($('#txtFPBRPM').val())<=0 || $('#txtFPBRPM').val()=="")
        {
            alert("Give RPM");
            $('#txtFinishLengthY').focus();
            return false;
        }
        if(parseInt($('#txtEff').val())<=0 || $('#txtEff').val()=="")
        {
            alert("Give Efficiency");
            $('#txtEff').focus();
            return false;
        }
        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        if(oFBL == null || oFBL.FabricBatchLoomID <=0)
        {
            alert("Run first.");
            return false;
        }
        debugger;
        var oFBPBatchMan = {
            FBLDetailID:0,
            FabricBatchLoomID:oFBL.FabricBatchLoomID,
            EmployeeID:$('#cboBatchMan').val(),// 1706=Batchman-A
            ShiftID:$('#cboHRMShift').val(),
            Qty:$('#txtFinishLengthY').val(),
            FinishDate:$('#txtDetailFinishDate').datebox('getValue'),
            Note:'',
            Efficiency:$('#txtEff').val(),
            RPM:$('#txtFPBRPM').val(),
            Warp:$('#txtWarp').val(),
            Weft:$('#txtWeft').val()
        };

        SaveBatchMan(oFBPBatchMan,false, 0);

    }

    function SaveBatchMan(oFBPBatchMan,bIsEdit, nSelectedIndex)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchLoom/SaveBatchMan",
            traditional: true,
            data:  JSON.stringify(oFBPBatchMan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var _oFBPBatchMan = jQuery.parseJSON(data);
                if (parseInt(_oFBPBatchMan.FBLDetailID)>0)
                {
                    if(bIsEdit)
                    {
                        $('#tblFBLoomDetail').datagrid('updateRow', { index: nSelectedIndex, row: _oFBPBatchMan});
                    }else{
                        //$("#tblFBLoomDetail").datagrid("appendRow", _oFBPBatchMan);
                        var oFinalList = [];
                        oFinalList.push(_oFBPBatchMan);
                        var oRows = $("#tblFBLoomDetail").datagrid("getRows");
                        for(var i=0;i<oRows.length;i++)
                            oFinalList.push(oRows[i]);
                        DynamicRefreshList(oFinalList,"tblFBLoomDetail");
                        $('#tblFBLoomDetail').datagrid('selectRow', 0);
                    }

                    //$('#cboBatchMan').val(0);
                    //$('#cboHRMShift').val(0);
                    //$('#txtFinishLengthY').val("");
                    //$('#txtFinishLengthM,#txtEff,#txtFPBRPM').val("");
                    //$('#txtDetailFinishDate').datebox('setValue',icsdateformat(new Date()));
                    SetFinishLength();
                }
                else {
                    alert(_oFBPBatchMan.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function SetFinishLength()
    {
        debugger;

        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        //$("#txtBeamQtyY").val((oFBL.FabricBatchProductionBeam.Qty).toFixed(2) + "(Y)");
        //$("#txtBeamQtyM").val(GetMeter(oFBL.FabricBatchProductionBeam.Qty,2) + "(M)");
        $("#txtBeamQtyY").val((oFBL.Qty).toFixed(2) + "(Y)");
        $("#txtBeamQtyM").val(GetMeter(oFBL.Qty,2) + "(M)");


        var oRows = $("#tblFBLoomDetail").datagrid("getRows");
        var nQtyInY = oRows.select('Qty').sum();
        var nQtyInM = GetMeter(nQtyInY,2);

        $("#txtTotalFinishLengthY").val(parseFloat(nQtyInY).toFixed(2));
        $("#txtTotalFinishLengthM").val(parseFloat(nQtyInM,2).toFixed(2));

        //nQty=oFBL.FabricBatchProductionBeam.Qty-nQtyInY;
        nQty=oFBL.Qty-nQtyInY;
        $("#txtYetToWeavLengthY").val(parseFloat(nQty).toFixed(2));
        $("#txtYetToWeavLengthM").val(parseFloat(GetMeter(nQty,2)).toFixed(2));

        //$("#txtFinishLengthY").val(parseFloat(nQty.toFixed(2)));
        //$("#txtFinishLengthM").val(GetMeter(nQty.toFixed(2)));
        //$("#txtFinishLengthY").val(0);
        //$("#txtFinishLengthM").val("");
    }

    function DeleteFBLDetail()
    {
        var oFBPBatchMan= $("#tblFBLoomDetail").datagrid("getSelected");
        if (oFBPBatchMan == null || parseInt(oFBPBatchMan.FBLDetailID) <= 0) {
            alert("Please select an item from list!");
            return false;
        }
        //var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        //if(oFBL.FabricBatchStatus >= 9){
        //    alert("This item already out, delete not possible.");
        //    return false;
        //}

        if (!confirm("Confirm to Delete?")) return false;
        var nRowIndex = $("#tblFBLoomDetail").datagrid("getRowIndex", oFBPBatchMan);
        if (parseInt(oFBPBatchMan.FBLDetailID) > 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchLoom/DeleteFBLDetail",
                data: { id: oFBPBatchMan.FBLDetailID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $("#tblFBLoomDetail").datagrid("deleteRow", nRowIndex);
                        SetFinishLength();
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                    editIndexBatchMan = undefined;
                    endEditingBatchMan();
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    }

    var editIndexBatchMan = undefined;
    function endEditingBatchMan(){
        if (editIndexBatchMan == undefined){return true}
        if ($('#tblFBLoomDetail').datagrid('validateRow', editIndexBatchMan)){
            $('#tblFBLoomDetail').datagrid('endEdit', editIndexBatchMan);
            $('#tblFBLoomDetail').datagrid('selectRow',editIndexBatchMan);
            var oFBPBatchMan=$('#tblFBLoomDetail').datagrid('getSelected');
            //oFBPBatchMan.Qty=oFBPBatchMan.Qty;
            oFBPBatchMan.FinishDate= icsdateformat(new Date(oFBPBatchMan.FinishDate)),
            oFBPBatchMan.Note=oFBPBatchMan.Note;
            SaveBatchMan(oFBPBatchMan, true,editIndexBatchMan);
            editIndexBatchMan = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRowBatchMan(index){

        if (editIndexBatchMan != index){
            if (endEditingBatchMan())
            {
                $('#tblFBLoomDetail').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                editIndexBatchMan = index;
            }
            else
            {
                $('#tblFBLoomDetail').datagrid('selectRow', editIndexBatchMan);
            }
        }
    }

    $("#btnChangeReedDent").click(function(){
        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        if(parseInt(oFBL.FabricBatchLoomID)<=0)
        {
            alert("Sorry, there is no Fabric Batch Loom!");
            return false;
        }
        if(!confirm("Are you sure to Change Reed Dent?"))
            return false;
        var oFBP = {
            FabricBatchLoomID:oFBL.FabricBatchLoomID,
            RPM:$('#txtRPM').val(),
            ReedCount:$('#txtReedCount').val(),
            Dent:$('#txtDent').val()
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchLoom/UpdateWeaving",
            traditional: true,
            data:  JSON.stringify(oFBP),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFBL = jQuery.parseJSON(data);
                if (oFBL.FabricBatchLoomID>0)
                {
                    $("#winWeavingProcess").data("FabricBatchLoom",oFBL);
                    alert("Update Succesfully!!");
                }
                else {
                    alert(oFBL.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    $('#btnHold').click(function(){
        RunOutOrHold(false);
    });

    $("#btnRunOut").click(function(){
        RunOutOrHold(true);
    });

    function RunOutOrHold(IsRunOut){
        var sMsg="Hold"
        if(IsRunOut)
            sMsg="Run Out";
        if(!confirm("Are you sure to "+sMsg+"?"))
            return false;
        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        if(parseInt(oFBL.FabricBatchLoomID)<=0)
        {
            alert("Sorry, there is no fabric batch loom!");
            return false;
        }

        if($("#tblFBLoomDetail").datagrid("getRows").length == 0){
            alert("Add batch wise production entry");
            return false;
        }

        var dEndDate =$('#txtEndDate').datebox('getValue');
        var EndTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndTime.split(':');
        var hEndTime= parseFloat(sTime[0]);
        var mEndTime= parseFloat(sTime[1]);
        dEndDate = new Date(dEndDate);
        dEndDate.setHours(hEndTime);
        dEndDate.setMinutes(mEndTime);

        var oFabricBatchProduction = {
            FabricBatchLoomID:oFBL.FabricBatchLoomID,
            FBID:oFBL.FBID,
            WeavingProcess : 3,
            Status:1,
            FMID:$('#cboMachineName').val(),
            TSUID: $('#cboTextileSubUnit').val(),
            RPM:$('#txtRPM').val(),
            ReedCount:$('#txtReedCount').val(),
            Dent:$('#txtDent').val(),
            FabricBatchStatus:9,//Weaving_Finish
            FBPriviousStatus:oFBL.FabricBatchStatusInInt,
            EndTime:dEndDate,
            Qty:$('#txtTotalFinishLengthY').val(),
            IsRunOut:IsRunOut,
            IsHold: !IsRunOut,
            ShiftID:$('#cboBatchShift').val()
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchLoom/Save",
            traditional: true,
            data:  JSON.stringify(oFabricBatchProduction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFabBatchloom = jQuery.parseJSON(data);
                if (oFabBatchloom.FabricBatchLoomID>0)
                {
                    $("#winWeavingProcess").data("FabricBatchLoom",oFabBatchloom);
                    alert(((IsRunOut)?"Run Out Successfully.":"Hold Successfully."));
                    $('#txtSizingDuration').val(oFabBatchloom.BatchDuration);
                    $('#btnChangeReedDent, #btnHold, #btnRunOut').hide();
                    // $('#txtProductName,#cboLot,#cboStore, #btnPickProduct,#btnLotRefresh,#btnAddChemical,#btnDeleteChemical,#btnOutMaterials').hide();
                    $('#tpEndTime').timespinner({disabled:true});
                    $('#txtEndDate').datebox({disabled:true});
                    $('#tpEndTime').timespinner('setValue', oFabBatchloom.EndDateStForTimeSpan);
                    $('#txtEndDate').datebox('setValue', oFabBatchloom.EndDateSt);
                    return false;
                }
                else {
                    alert(oFabBatchloom.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    $("#btnCloseAdvSearch").click(function () {
        $("#winAdvSearch").icsWindow("close");
    });

    $("#btnAdvSearch").click(function () {
        debugger;
        _sBuyerIDs="";
        $(".lblLoadingMessage").hide();
        DynamicResetAdvSearchWindow("winAdvSearch");
        $('#txtStartDateStart').datebox({ disabled : true });
        $('#txtStartDateEnd').datebox({ disabled : true });
        $('#txtEndDateStart').datebox({ disabled : true });
        $('#txtEndDateEnd,#txtFromProductionDateAdv,#txtToProductionDateAdv').datebox({ disabled : true });
        $('#txtStartDateStart').datebox('setValue', icsdateformat(new Date()));
        $('#txtStartDateEnd').datebox('setValue', icsdateformat(new Date()));
        $('#txtEndDateStart').datebox('setValue', icsdateformat(new Date()));
        $('#txtEndDateEnd,#txtFromProductionDateAdv,#txtToProductionDateAdv').datebox('setValue', icsdateformat(new Date()));
        $('#cboDropingStatus').val();
        $('#cboLastDropingStatus').val();
        $("#winAdvSearch").icsWindow("open", " Advance Search");


        //ResetAdvSearchWindow();
        //$("#cboDateAdvS").icsLoadCombo({ List: _oCompareOperators, OptionValue: "id", DisplayText: "Value" });
    });

    $("#btnSearchAdvSearch").click(function () {
        debugger;
        var nStartDate = parseInt($("#cboStartDate").val());
        var dStartDateStart = $('#txtStartDateStart').datebox('getValue');
        var dStartDateEnd = $('#txtStartDateEnd').datebox('getValue');
        var nEndDate = parseInt($("#cboEndDate").val());
        var dEndDateStart = $('#txtEndDateStart').datebox('getValue');
        var dEndDateEnd = $('#txtEndDateEnd').datebox('getValue');
        var nCboProductionDateAdv = parseInt($("#cboProductionDateAdv").val());
        var dFromProductionDateAdv = $('#txtFromProductionDateAdv').datebox('getValue');
        var dToProductionDateAdv = $('#txtToProductionDateAdv').datebox('getValue');

        if($.trim($("#txtOrderNoAdv").val()) == "" && _sBuyerIDs == "" && $("#txtBeamNoAdv").val() == "" && $("#txtMachineNo").val() == "" && $("#cboTextileSubUnitAdv").val() <= 0 && $("#cboDropingStatus").val() <= 0 && nStartDate <= 0 && nEndDate <= 0 && $('#cboLastDropingStatus').val() <= 0 && ($.trim($("#txtReedCountAdv").val()) == "" || $.trim($("#txtReedCountAdv").val()) == 0) && nCboProductionDateAdv <= 0){
            alert("Please Enter atleast one searching criteria!!");
            return;
        }
        var sTempString = nStartDate+'~'+dStartDateStart+'~'+dStartDateEnd+'~'+nEndDate+'~'+dEndDateStart+'~'+dEndDateEnd+'~'+$("#cboDropingStatus").val() +'~'+ $('#cboLastDropingStatus').val()+'~'+nCboProductionDateAdv+'~'+dFromProductionDateAdv+'~'+dToProductionDateAdv;
        var oFabricBatchLoom={
            FEONo : $.trim($("#txtOrderNoAdv").val()),
            BuyerName : _sBuyerIDs,
            BeamNo:$("#txtBeamNoAdv").val(),
            MachineCode:$("#txtMachineNo").val(),
            TSUID: $("#cboTextileSubUnitAdv").val(),
            ErrorMessage: sTempString,
            ReedCount: $.trim($("#txtReedCountAdv").val())
            //Status: 1
        };
        //SearchFBPB(oFabricBatchLoom);

        $(".lblLoadingMessage").show();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricBatchLoom/AdvSearchFBPB",
            traditional: true,
            data: JSON.stringify(oFabricBatchLoom),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFabricBatchLooms = data;
                debugger;
                if (oFabricBatchLooms.length > 0)
                {
                    DynamicRefreshListForMultipleSelection(oFabricBatchLooms, "tblFabricBatchLooms");
                    $("#winAdvSearch").icsWindow("close");

                } else {
                    alert("Sorry, No data found. ");
                }
                $(".lblLoadingMessage").hide();
            }
        });

    });

    $('#txtDispoNo').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oFBL = {
                FEONo : $.trim($("#txtDispoNo").val())
            };

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricBatchLoom/SearchByDispoNo",
                traditional: true,
                data: JSON.stringify(oFBL),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricBatchLooms = data;
                    debugger;
                    if (oFabricBatchLooms.length > 0)
                    {
                        if(oFabricBatchLooms[0].Errormessage == "" || oFabricBatchLooms[0].Errormessage == null){
                            DynamicRefreshListForMultipleSelection(oFabricBatchLooms, "tblFabricBatchLooms");
                        }else{
                            alert(oFabricBatchLooms[0].Errormessage);
                        }

                    } else {
                        alert("Sorry, No data found. ");
                    }
                }
            });
        }
        else if (code === 8) {
            DynamicRefreshList([], "tblExportBillReports");
        }
    });

    $('#txtLoomNoGrid').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oFBL = {
                MachineCode : $.trim($("#txtLoomNoGrid").val())
            };

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricBatchLoom/SearchByDispoNo",
                traditional: true,
                data: JSON.stringify(oFBL),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricBatchLooms = data;
                    debugger;
                    if (oFabricBatchLooms.length > 0)
                    {
                        if(oFabricBatchLooms[0].Errormessage == "" || oFabricBatchLooms[0].Errormessage == null){
                            DynamicRefreshListForMultipleSelection(oFabricBatchLooms, "tblFabricBatchLooms");
                        }else{
                            alert(oFabricBatchLooms[0].Errormessage);
                        }

                    } else {
                        alert("Sorry, No data found. ");
                    }
                }
            });
        }
        else if (code === 8) {
            DynamicRefreshList([], "tblExportBillReports");
        }
    });

    $('#txtBeamNoGrid').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oFBL = {
                BeamNo : $.trim($("#txtBeamNoGrid").val())
            };
            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricBatchLoom/SearchByDispoNo",
                traditional: true,
                data: JSON.stringify(oFBL),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricBatchLooms = data;
                    debugger;
                    if (oFabricBatchLooms.length > 0)
                    {
                        if(oFabricBatchLooms[0].Errormessage == "" || oFabricBatchLooms[0].Errormessage == null){
                            DynamicRefreshListForMultipleSelection(oFabricBatchLooms, "tblFabricBatchLooms");
                        }else{
                            alert(oFabricBatchLooms[0].Errormessage);
                        }

                    } else {
                        alert("Sorry, No data found. ");
                    }
                }
            });
        }
        else if (code === 8) {
            DynamicRefreshList([], "tblExportBillReports");
        }
    });

    $("#btnPrintShiftWiseReport").click(function(){
        var nStartDate = parseInt($("#cboStartDate").val());
        var dStartDateStart = $('#txtStartDateStart').datebox('getValue');
        var dStartDateEnd = $('#txtStartDateEnd').datebox('getValue');
        var nEndDate = parseInt($("#cboEndDate").val());
        var dEndDateStart = $('#txtEndDateStart').datebox('getValue');
        var dEndDateEnd = $('#txtEndDateEnd').datebox('getValue');
        var nCboProductionDateAdv = parseInt($("#cboProductionDateAdv").val());
        var dFromProductionDateAdv = $('#txtFromProductionDateAdv').datebox('getValue');
        var dToProductionDateAdv = $('#txtToProductionDateAdv').datebox('getValue');

        if($.trim($("#txtOrderNoAdv").val()) == "" && _sBuyerIDs == "" && $("#txtBeamNoAdv").val() == "" && $("#txtMachineNo").val() == "" && $("#cboTextileSubUnitAdv").val() <= 0 && $("#cboDropingStatus").val() <= 0 && nStartDate <= 0 && nEndDate <= 0 && $('#cboLastDropingStatus').val() <= 0 && ($.trim($("#txtReedCountAdv").val()) == "" || $.trim($("#txtReedCountAdv").val()) == 0) && nCboProductionDateAdv <= 0){
            alert("Please Enter atleast one searching criteria!!");
            return;
        }
        var sTempString = nStartDate+'~'+dStartDateStart+'~'+dStartDateEnd+'~'+nEndDate+'~'+dEndDateStart+'~'+dEndDateEnd+'~'+$("#cboDropingStatus").val() +'~'+ $('#cboLastDropingStatus').val()+'~'+nCboProductionDateAdv+'~'+dFromProductionDateAdv+'~'+dToProductionDateAdv;
        var oFabricBatchLoom={
            FEONo : $.trim($("#txtOrderNoAdv").val()),
            BuyerName : _sBuyerIDs,
            BeamNo:$("#txtBeamNoAdv").val(),
            MachineCode:$("#txtMachineNo").val(),
            TSUID: $("#cboTextileSubUnitAdv").val(),
            ErrorMessage: sTempString,
            ReedCount: $.trim($("#txtReedCountAdv").val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricBatchLoom/SetFabricBatchLoomData",
            traditional: true,
            data: JSON.stringify(oFabricBatchLoom),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open(_sBaseAddress + '/FabricBatchLoom/PrintShiftWiseReport?nBUID='+_nBUID, "_blank");
                }
            }
        });

    });

    $("#btnPrintShiftWiseReportXL").click(function(){
        var nStartDate = parseInt($("#cboStartDate").val());
        var dStartDateStart = $('#txtStartDateStart').datebox('getValue');
        var dStartDateEnd = $('#txtStartDateEnd').datebox('getValue');
        var nEndDate = parseInt($("#cboEndDate").val());
        var dEndDateStart = $('#txtEndDateStart').datebox('getValue');
        var dEndDateEnd = $('#txtEndDateEnd').datebox('getValue');
        var nCboProductionDateAdv = parseInt($("#cboProductionDateAdv").val());
        var dFromProductionDateAdv = $('#txtFromProductionDateAdv').datebox('getValue');
        var dToProductionDateAdv = $('#txtToProductionDateAdv').datebox('getValue');

        if($.trim($("#txtOrderNoAdv").val()) == "" && _sBuyerIDs == "" && $("#txtBeamNoAdv").val() == "" && $("#txtMachineNo").val() == "" && $("#cboTextileSubUnitAdv").val() <= 0 && $("#cboDropingStatus").val() <= 0 && nStartDate <= 0 && nEndDate <= 0 && $('#cboLastDropingStatus').val() <= 0 && ($.trim($("#txtReedCountAdv").val()) == "" || $.trim($("#txtReedCountAdv").val()) == 0) && nCboProductionDateAdv <= 0){
            alert("Please Enter atleast one searching criteria!!");
            return;
        }
        var sTempString = nStartDate+'~'+dStartDateStart+'~'+dStartDateEnd+'~'+nEndDate+'~'+dEndDateStart+'~'+dEndDateEnd+'~'+$("#cboDropingStatus").val() +'~'+ $('#cboLastDropingStatus').val()+'~'+nCboProductionDateAdv+'~'+dFromProductionDateAdv+'~'+dToProductionDateAdv;
        var oFabricBatchLoom={
            FEONo : $.trim($("#txtOrderNoAdv").val()),
            BuyerName : _sBuyerIDs,
            BeamNo:$("#txtBeamNoAdv").val(),
            MachineCode:$("#txtMachineNo").val(),
            TSUID: $("#cboTextileSubUnitAdv").val(),
            ErrorMessage: sTempString,
            ReedCount: $.trim($("#txtReedCountAdv").val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricBatchLoom/SetFabricBatchLoomData",
            traditional: true,
            data: JSON.stringify(oFabricBatchLoom),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open(_sBaseAddress + '/FabricBatchLoom/PrintShiftWiseReportXL?nBUID='+_nBUID, "_blank");
                }
            }
        });

    });

    $("#btnTotalBreakageInformation").click(function(){
        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        if(oFBL.Status==3)// Run out
        {
            alert("in 'Run Out' status, You can't add Breakage!!");
            return false;
        }
        DynamicRefreshList([],"tblFBPBreakage");
        var oFBLoomDetail = $("#tblFBLoomDetail").datagrid("getSelected");
        if(oFBLoomDetail == null || oFBLoomDetail.FBLDetailID <=0)
        {
            alert("Please select a valid item from list.");
            return false;
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFBLoomDetail,
            ControllerName: "FabricBatchLoom",
            ActionName: "GetsTotalBreakageInformation",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if($.trim(response.objs[0].ErrorMessage) == "")
                {
                    DynamicRefreshList(response.objs,"tblFBPBreakage");
                }
                else
                {
                    alert(response.objs[0].ErrorMessage);
                    return false;
                }
            }
            TotalNoOfBreakage();
            $('#txtDuration').numberbox('setValue',0);
            $('#txtNumberOfBreakage').numberbox('setValue',1);
            $("#winTotalBreakageInformation").icsWindow("open","Total Breakage Information");
        });
    });

    function TotalNoOfBreakage()
    {
        var nTotalNoOfBreakage=0;
        var oFBPBreakages = $("#tblFBPBreakage").datagrid("getRows");
        if(oFBPBreakages.length>0)
        {
            for(var i=0;i<oFBPBreakages.length;i++)
            {
                nTotalNoOfBreakage = parseInt(oFBPBreakages[i].NoOfBreakage) + parseInt(nTotalNoOfBreakage);
            }
        }
        $("#lblTotalNoOfBreakage").text(nTotalNoOfBreakage);
    }

    $("#btnAddBreakage").click(function(){
        var oFBL = $("#winWeavingProcess").data("FabricBatchLoom");
        if(parseInt(oFBL.FabricBatchLoomID)<=0)
        {
            alert("Please Run the Batch Loom then Add Breakage!");
            return false;
        }
        if(parseInt($('#cboBreakage').val())<=0)
        {
            alert("Select Breakage !");
            $('#cboBreakage').focus();
            return false;
        }
        var oFBLoomDetail = $("#tblFBLoomDetail").datagrid("getSelected");
        if(oFBLoomDetail == null || oFBLoomDetail.FBLDetailID <=0)
        {
            alert("Please select a valid item from list.");
            return false;
        }
        var oFBPBreakage = {
            FBPBreakageID:0,
            FBLDetailID: oFBLoomDetail.FBLDetailID,
            FBreakageID:$('#cboBreakage').val(),
            DurationInMin:$('#txtDuration').numberbox('getValue'),
            NoOfBreakage:$('#txtNumberOfBreakage').numberbox('getValue'),
            Note:''
        };
        SaveBreakage(oFBPBreakage,false, 0);
        $('#cboBreakage').val(0);
        $('#txtDuration').numberbox('setValue',0);
        $('#txtNumberOfBreakage').numberbox('setValue',1);
    });

    function SaveBreakage(oFBPBreakage,bIsEdit, nSelectedIndex)
    {
        //if(parseInt(_oFabricBatchProduction.FabricBatchStatusInInt)!=2)//warping
        //{
        //    return;//in this step can't add any data
        //}
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchLoom/SaveFBLBreakage",
            traditional: true,
            data:  JSON.stringify(oFBPBreakage),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFBPBreakage = jQuery.parseJSON(data);
                if (oFBPBreakage.FBPBreakageID>0)
                {
                    if(bIsEdit)
                    {
                        $('#tblFBPBreakage').datagrid('updateRow', { index: nSelectedIndex, row: oFBPBreakage});
                    }else{
                        $("#tblFBPBreakage").datagrid("appendRow", oFBPBreakage);
                    }
                    TotalNoOfBreakage();
                    $("#cboBreakage").focus();
                    //UpdateFBPBatchMan(oFBPBreakage.FabricBatchProductionBreakages);
                    return;
                }
                else {
                    alert(oFBPBreakage.ErrorMessage);
                    TotalNoOfBreakage();
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    $("#btnDeleteBreakage").click(function(){
        var oFBPBreakage= $("#tblFBPBreakage").datagrid("getSelected");
        if (oFBPBreakage == null || parseInt(oFBPBreakage.FBPBreakageID) <= 0) {
            alert("Please select an item from list!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return false;
        var nRowIndex = $("#tblFBPBreakage").datagrid("getRowIndex", oFBPBreakage);
        if (parseInt(oFBPBreakage.FBPBreakageID) > 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchLoom/DeleteFBPBreakage",
                data: { id: oFBPBreakage.FBPBreakageID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $("#tblFBPBreakage").datagrid("deleteRow", nRowIndex);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                    TotalNoOfBreakage();
                    //UpdateFBPBatchMan($("#tblFBPBreakage").datagrid("getRows"));
                    editIndexBreakage = undefined;
                    endEditingBreakage();
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });

    $("#btnRefreshBreakage").click(function(){
        endEditingBreakage();
    });

    $("#btnCloseTotalBreakageInformation").click(function(){
        $("#winTotalBreakageInformation").icsWindow("close");
    });

    var editIndexBreakage = undefined;
    function endEditingBreakage(){
        if (editIndexBreakage == undefined){return true}
        if ($('#tblFBPBreakage').datagrid('validateRow', editIndexBreakage)){
            $('#tblFBPBreakage').datagrid('endEdit', editIndexBreakage);
            $('#tblFBPBreakage').datagrid('selectRow',editIndexBreakage);
            var oFBPBreakage=$('#tblFBPBreakage').datagrid('getSelected');
            oFBPBreakage.DurationInMin = parseInt(oFBPBreakage.DurationInMin);
            oFBPBreakage.NoOfBreakage = parseInt(oFBPBreakage.NoOfBreakage);
            oFBPBreakage.Note = oFBPBreakage.Note;
            SaveBreakage(oFBPBreakage, true,editIndexBreakage);
            editIndexBreakage = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRowBreakage(index){

        if (editIndexBreakage != index){
            if (endEditingBreakage())
            {
                $('#tblFBPBreakage').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndexBreakage = index;
            }
            else
            {
                $('#tblFBPBreakage').datagrid('selectRow', editIndexBreakage);
            }
        }
    }

    $("#btnDeleteWeaving").click(function(){
        var oFabricBatchLoom = $("#tblFabricBatchLooms").datagrid("getSelected");
        if(oFabricBatchLoom == null)
        {
            alert("Select an item from list.");
            return false;
        }
        if(oFabricBatchLoom.Status != 1)
        {
            alert("Please select Running Item only!!");
            return false;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblFabricBatchLooms').datagrid('getRowIndex',oFabricBatchLoom);

        $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchLoom/DeleteFabricBatchLoom",
                data: JSON.stringify(oFabricBatchLoom),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage.toLowerCase() == "deleted")
                    {
                        $('#tblFabricBatchLooms').datagrid('deleteRow',SelectedRowIndex);
                        alert("Delete sucessfully!!");
                        //var oFBLs= $('#tblFabricBatchLooms').datagrid('getRows');
                        //sessionStorage.setItem("Beams", JSON.stringify(oFBLs));
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });

    });

</script>
