@{
    ViewBag.Title = "Weaving";
}
<html>
<body>
@model ESimSol.BusinessObjects.FabricBatchProduction
    <div id="winTotalBreakageInformation" class="easyui-window" title="Total Breakage Information" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="width:915px; margin-left:2px;">
            <table id="tblFBPBreakage" class="easyui-datagrid" style="height:250px;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarBreakage" data-options="onClickRow: onClickRowBreakage">
                <thead>
                    <tr>
                        <th field="FabricBreakageName" width="250">Break Description</th>
                        <th data-options="field:'DurationInMin',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="150" align="right">Duration(Min)</th>
                        <th data-options="field:'NoOfBreakage',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="150" align="right">No Of Breakage</th>
                        <th data-options="field:'Note',align:'left',editor:{type:'text'}" width="100">Remark</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarBreakage">
                Break :<select id="cboBreakage" style="width:250px;"></select>&nbsp;
                Duration :<input type="text" id="txtDuration" class="easyui-numberbox" data-options="min:0,precision:0" style="width:100px" />(Min)&nbsp;
                No Of Breakage :<input type="text" id="txtNumberOfBreakage" class="easyui-numberbox" data-options="min:0,precision:0" style="width:100px" />&nbsp;
                <a id="btnAddBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnDeleteBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnRefreshBreakage" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
            </div>
            <table>
                <tr>
                    <td style="width:702px;"></td>
                    <td>Total : <label id="lblTotalNoOfBreakage">0</label></td>
                </tr>
            </table>
            <fieldset>
                <legend>Actions : </legend>
                <div style="float:right;">
                    <a id="btnOkTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                    <a id="btnCloseTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </div>
            </fieldset>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div class="easyui-panel" title="Fabric Batch Weaving Process" style="font-family:Tahoma;text-align:center; width:100%;height:100%;">
            <div id="divFBInfo" style="width:100%">
                <fieldset>
                    <legend>Fabric Batch Info </legend>
                    <div style="margin:0 auto;width:90%;">
                        <table border="0" cellpadding="1" cellspacing="1">
                            <tr>
                                <td style="width:15%; text-align:right;">Program No:</td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" style="width:96px;" id="txtBatchNo" />
                                    <a id="btnSearchBatch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                                    <input type="text" style="width:96px;" id="txtFEONo" placeholder="Type Dispo No" />
                                    <a id="btnSearchFEONo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                                </td>
                                <td style="width:15%; text-align:right;">Order No :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:120px; text-align:left;" id="txtOrderNo" disabled />
                                    Status:
                                    <input type="text" style="width:85px;" id="txtStatus" disabled />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:15%; text-align:right;">Construction :</td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" id="txtConstruction" style="width:260px;" disabled />
                                </td>
                                <td style="width:15%; text-align:right;">Buyer :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:258px;" id="txtBuyer" disabled />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">Machine Name :</td>
                                <td style="width:40%;text-align:left;">
                                    <select style="width:260px;" id="cboMachineName"></select>
                                </td>
                                <td style="width:15%; text-align:right;">Length :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtWeavingLengthY" class="number" disabled /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtWeavingLengthM" class="number" disabled />&nbsp;(M)
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">RPM :</td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" style="width:105px;" id="txtRPM" />
                                    Texture:
                                    <input type="text" style="width:105px;" id="txtTexture" />
                                </td>
                                <td style="width:15%; text-align:right;">Yet To Weaving :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtYetToWeavLengthY" class="number" disabled /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtYetToWeavLengthM" class="number" disabled />&nbsp;(M)
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">Start Time :</td>
                                <td style="width:40%;text-align:left;">
                                    <input id="txtStartDate" style="width:150px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                    <a id="btnRun" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="Run()">Run</a>
                                </td>
                                <td style="width:15%; text-align:right;">Finish Length :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:100px;" id="txtTotalFinishLengthY" class="number" /> &nbsp;(Y) &nbsp;
                                    <input type="text" style="width:90px;" id="txtTotalFinishLengthM" class="number" />&nbsp;(M)
                                </td>
                            </tr>

                            <tr>
                                <td style="width:10%; text-align:right;">End Time:</td>
                                <td style="width:40%;text-align:left;">
                                    <input id="txtEndDate" style="width:150px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                                    <a id="btnRunOut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="RunOut()">Out</a>
                                </td>
                                <td style="width:15%; text-align:right;">No Of Color :</td>
                                <td style="width:30%;text-align:left;">
                                    <input type="text" style="width:258px;" id="txtNoOfColor" disabled />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right;">Weaving Duration :</td>
                                <td style="width:40%;text-align:left;">
                                    <input type="text" style="width:260px;" id="txtWeavingDuration" disabled />
                                </td>
                                <td style="width:15%; text-align:right;"></td>
                                <td style="width:30%;text-align:left;"></td>
                            </tr>
                        </table>
                    </div>
                </fieldset>
            </div>
            <div class="easyui-accordion" style="height:46%;width:100%" data-options="selected:false">
                <div title="Add Beams" style="width:100%;">
                    <div style="width:45%;float:left;">
                        <table id="tblBeams" class="easyui-datagrid" title="Sizing Beams" style="width:100%;height:175px;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false">
                            <thead>
                                <tr>
                                    <th field="BeamCode" width="18%">Beam No</th>
                                    <th field="Qty" width="18%" align="right" formatter="formatPrice">Qty(Y)</th>
                                    <th field="QtyInMtr" width="18%" align="right" formatter="formatPrice">Qty(M)</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div style="width:52%;float:right;margin-left:10px;">
                        <table id="tblBeamsWeaving" class="easyui-datagrid" title="Weaving/Loom Beams" style="width:100%;height:175px;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarBeamWeaving">
                            <thead>
                                <tr>
                                    <th field="BeamCode" width="18%">Beam No</th>
                                    <th field="Qty" width="18%" align="right" formatter="formatPrice">Qty(Y)</th>
                                    <th field="QtyInMtr" width="18%" align="right" formatter="formatPrice">Qty(M)</th>
                                </tr>
                            </thead>
                        </table>
                        <div id="toolbarBeamWeaving">
                            Beam No :
                            <select id="cboBeams" style="width:108px;margin-right:10px;"></select>
                            Qty :
                            <input id="txtBeamQty" type="text" style="width:50px;" class="number" />(Y)
                            <input id="txtBeamQtyMeter" type="text" style="width:50px;" class="number" />(M)
                            <a id="btnAddBeam" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                            <a id="btnRemoveBeam" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                        </div>
                    </div>
                </div>
                <div title="Batch Wise Production Entry" data-options="selected:false">
                    <table id="tblFBPBatchMan" class="easyui-datagrid" style="height:100%;" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarBatchMan" data-options="onClickRow: onClickRowBatchMan">
                        <thead>
                            <tr>
                                <th field="EmployeeName" width="200">Batch Man</th>
                                <th field="ShiftNameWithDuration" width="150">Shift</th>
                                <th data-options="field:'Qty',align:'center',editor:{type:'numberbox',options:{precision:2}}" width="100" align="right">Len(Y)</th>
                                <th field="QtyInM" width="100" align="right">Len(M)</th>
                                <th field="FinishDateInString" width="150">Date</th>
                                <th field="TotalFBPBreakage" width="10%" align="right">Breakage</th>
                                <th field="TotalNoOfBreakage" width="12%" align="right">No of Breakage</th>
                                <th data-options="field:'Note',align:'left',editor:{type:'text'}" width="100">Remark</th>
                            </tr>
                        </thead>
                    </table>
                    <div id="toolbarBatchMan">
                        Batch Man :<select id="cboBatchMan" style="width:180px;"></select>&nbsp;
                        Shift :<select id="cboShift"></select>&nbsp;
                        Date :<input id="txtFinishDate" style="width:120px" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />&nbsp;
                        Finish Length :<input type="text" id="txtFinishLengthY" style="width:80px" class="number" />&nbsp;(Y)&nbsp;<input type="text" id="txtFinishLengthM" style="width:80px" class="number" />&nbsp;(M)
                        <a id="btnAddBatchMan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="AddBatchMan()">Add</a>
                        <a id="btnDeleteBatchMan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="DeleteBatchMan()">Remove</a>
                        <a id="btnTotalBreakageInformation" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Breakages</a>
                    </div>
                </div>
            </div>
            <fieldset>
                <legend style="font-weight:bold">Action : </legend>
                <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print()" style="float:right;">Print</a>
            </fieldset>
        </div>
    </div>
</body>
</html>


<script type="text/javascript">
    var _oFabricBatchProduction=null;
    var _sBaseAddress="";
    var _objName = "";
    var _lBackLink = "";
    var _oProduct = "";
    var _oFabricBreakages = [];
    var _oFabricMachines =[];
    var _oBatchMans = [];
    var _oHRMShifts = [];
    var _nRemoveLastItemID = 0;
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFabricBatchProduction =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oFabricMachines = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.FabricMachines));
        _oFabricBreakages = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.FabricBreakages));
        _oBatchMans = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.BatchMans));
        _oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.HRMShifts));
        var oBeams = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Beams));

        $("#cboBreakage").icsLoadCombo({List: _oFabricBreakages,OptionValue: "FBreakageID",DisplayText: "Name"});
        $("#cboBatchMan").icsLoadCombo({List: _oBatchMans,OptionValue: "EmployeeID",DisplayText: "Name"});
        $("#cboMachineName").icsLoadCombo({List: _oFabricMachines,OptionValue: "FMID",DisplayText: "MachineCodeWithName"});
        $("#cboShift").icsLoadCombo({List: _oHRMShifts,OptionValue: "ShiftID",DisplayText: "ShiftWithDuration"});
        $("#cboBeams").icsLoadCombo({List: oBeams,OptionValue: "FMID",DisplayText: "Code"});
        $('#tpStartTime,#tpEndTime').timespinner('setValue', "00:00");
        $('#txtStartDate,#txtEndDate').datebox('setValue', icsdateformat(new Date));
        $('#btnRun').hide();
        $('#btnRunOut').hide();
        $(".number").val(0);
        $("#txtBeamQty,#txtBeamQtyMeter").val("");
    });
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });


    $("#btnSearchFEONo").click(function(){
        EFOPicker();
    });

    function EFOPicker()
    {
        var oFabricBatch={
            FEONo : $.trim($("#txtFEONo").val()),
            IsNotWarpDone:false,
            WeavingProcessType : 3
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatch,
            ControllerName: "FabricBatch",
            ActionName: "Search",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    var tblColums = [];
                    var oColumn = { field: "OrderNo", title: "Dispo No", width: "30%", align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BatchNo", title: "Program No", width: "20%", align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "QtySt", title: "Qty (Y)", width: "15%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "QtyInMeterSt", title: "Qty (M)", width: "15%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "StatusSt", title: "Status", width: "30%", align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winFabricBatchs',
                        winclass: 'clsFabricBatch',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblFabricBatchs',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'BatchNo',
                        windowTittle: 'Fabric Batch List',
                        placeholder : "Search By Program No"
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                   
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("Sorry, No FEO Found.");
            }
        });
    }

    $("#txtFEONo").keydown(function(e){
        if(e.keyCode === 13)
        {
            EFOPicker();
        }
    });

    $("#txtBeamQty").keyup(function(e){
        $("#txtBeamQtyMeter").val(GetMeter(parseFloat($(this).val()),2));
    });
    $("#txtBeamQtyMeter").keyup(function(e){
        $("#txtBeamQty").val(GetYard(parseFloat($(this).val()),2));
    });

    function ResetBeamsInfo()
    {
        $("#txtBeamQty,#txtBeamQtyMeter").val("");
        $("#cboBeams").val(0);
        DynamicRefreshList([],"tblBeams");
        DynamicRefreshList([],"tblBeamsWeaving");
    }

    $("#btnRemoveBeam").click(function(){
        var oBeam = $("#tblBeamsWeaving").datagrid("getSelected");
        if(oBeam == null)
        {
            alert("Please select an item from list.");
            return false;
        }

        if(oBeam.FBPBeamID > 0)
        {
            if (!confirm("Confirm to Delete?")) return false;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oBeam,
                ControllerName: "FabricBatchProductionBeam",
                ActionName: "Delete",
                TableId: "tblBeamsWeaving",
                IsWinClose: false
            };
            $.icsDelete(obj);
        }
        else
        {
            var nRowIndex = $("#tblBeamsWeaving").datagrid("getRowIndex", oBeam);
            $("#tblBeamsWeaving").datagrid("deleteRow", nRowIndex);
        }

    });

    function AddWeavingBeam()
    {
        var nBeamId = parseInt($("#cboBeams").val());
        if(nBeamId <= 0)
        {
            alert("Select Beam.");
            $("#cboBeams").focus();
            return false;
        }

        var oBeams = $("#tblBeamsWeaving").datagrid("getRows");
        var nLength = oBeams.length;
        for(var i=0;i<nLength;i++)
        {
            if(parseInt(oBeams[i].BeamID) == nBeamId)
            {
                alert("Selected Beam already in list.");
                $("#cboBeams").focus();
                return false;
            }
        }

        var oFBPBeam = {
            FBPBeamID:0,
            FBPID:_oFabricBatchProduction.FBPID,
            BeamID:nBeamId,
            Qty: parseFloat($("#txtBeamQty").val()),
            BeamCode : $('#cboBeams option:selected').text(),
            QtyInMtr : GetMeter(parseFloat($("#txtBeamQty").val()),2)
        };

        if(_oFabricBatchProduction.FBPID <= 0)
        {
            var nIndex = $("#tblBeamsWeaving").datagrid("getRows").length;
            $("#tblBeamsWeaving").datagrid("appendRow", oFBPBeam);
            $("#tblBeamsWeaving").datagrid("selectRow", nIndex);
        }
        else
        {
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFBPBeam,
                ObjectId: oFBPBeam.FBPBeamID,
                ControllerName: "FabricBatchProductionBeam",
                ActionName: "Save",
                TableId: "tblBeamsWeaving",
                IsWinClose: true,
                Message:""
            };
            $.icsSave(obj);
        }

        $("#cboBeams").val(0);
        $("#cboBeams").focus();
        $("#txtBeamQty,#txtBeamQtyMeter").val("");
    }

    $("#txtBeamQty,#txtBeamQtyMeter").keydown(function(e){
        if(e.keyCode===13)
        {
            AddWeavingBeam();
        }
    });

    $("#btnAddBeam").click(function(){
        AddWeavingBeam();
    });

    function TotalNoOfBreakage()
    {
        var nTotalNoOfBreakage=0;
        var oFBPBreakages = $("#tblFBPBreakage").datagrid("getRows");
        if(oFBPBreakages.length>0)
        {
            for(var i=0;i<oFBPBreakages.length;i++)
            {
                nTotalNoOfBreakage = parseInt(oFBPBreakages[i].NoOfBreakage) + parseInt(nTotalNoOfBreakage);
            }
        }
        $("#lblTotalNoOfBreakage").text(nTotalNoOfBreakage);
    }

    $("#btnRefreshBreakage").click(function(){
        endEditingBreakage();
    });

    $("#btnOkTotalBreakageInformation").click(function(){
        var oFBPBreakages=$("#tblFBPBreakage").datagrid("getRows");
        if(oFBPBreakages.length == 0)
        {
            alert("Add minimum one item.");
            return false;
        }
        endEditingBreakage();
        $("#winTotalBreakageInformation").icsWindow("close");
    });

    $("#btnTotalBreakageInformation").click(function(){
        DynamicRefreshList([],"tblFBPBreakage");
        var oFBPBatchMan = $("#tblFBPBatchMan").datagrid("getSelected");
        if(oFBPBatchMan == null || oFBPBatchMan.FBPBID <=0)
        {
            alert("Please select an item from list.");
            return false;
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFBPBatchMan,
            ControllerName: "FabricBatchProduction",
            ActionName: "GetsTotalBreakageInformation",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if($.trim(response.objs[0].ErrorMessage) == "")
                {
                    DynamicRefreshList(response.objs,"tblFBPBreakage");
                }
                else
                {
                    alert(response.objs[0].ErrorMessage);
                    return false;
                }
            }
            TotalNoOfBreakage();
            $("#winTotalBreakageInformation").icsWindow("open","Total Breakage Information");
        });
    });

    $("#btnCloseTotalBreakageInformation").click(function(){
        $("#winTotalBreakageInformation").icsWindow("close");
    });

    //for Weaving
    $("#txtTotalFinishLengthY").keyup(function (e) {

        var nVal =  $(this).val();
        $('#txtTotalFinishLengthM').val(GetMeter(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    $("#txtTotalFinishLengthM").keyup(function (e) {
        var nVal = $(this).val();
        $('#txtTotalFinishLengthY').val(GetYard(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

   //for Batch Man
    $("#txtFinishLengthY").keyup(function (e) {

        var nVal =  $(this).val();
        $('#txtFinishLengthM').val(GetMeter(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    $("#txtFinishLengthM").keyup(function (e) {
        var nVal = $(this).val();
        $('#txtFinishLengthY').val(GetYard(nVal,2));
        if (nVal == "" || nVal == null) {
            $(this).val(0);
        }
    });

    $("#btnSearchBatch").click(function () {
        var oFabricBatch={
            BatchNo:$("#txtBatchNo").val(),
            WeavingProcessType : 3 // Loom/Weaving = 3
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatch,
            ControllerName: "FabricBatch",
            ActionName: "GetsByBatchNo",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    var tblColums = []; 
                    var oColumn = { field: "OrderNo", title: "FEO No", width: "30%", align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "BatchNo", title: "Program No", width: "20%", align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "QtySt", title: "Qty", width: "15%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "QtyInMeterSt", title: "Qty (M)", width: "15%", align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "StatusSt", title: "Status", width: "30%", align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winBatchs',
                        winclass: 'clsBatch',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblBatchs',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'BatchNo',
                        windowTittle: 'Batch List',
                        placeholder : "Search By Program No"
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else
            {
                alert("Sorry, No Batch Found.");
            }
        });
    });

    function IntializePickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            ButtonEvents(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                ButtonEvents(oPickerobj);
            }
        });
    }
    function ButtonEvents(oPickerobj)
    {
        var oreturnobj = "";var oreturnobjs = [];
        if(oPickerobj.multiplereturn)
        {
            oreturnobjs = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }else{
            oreturnobj = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }

        if(oPickerobj.winid == 'winBatchs')
        {
            if (oreturnobj != null && oreturnobj.FBID> 0)
            {
                SelectBatch(oreturnobj.BatchNo);
            }
            else{
                alert("Please select a batch.");
                return false;
            }
        }
        else if(oPickerobj.winid == 'winFabricBatchs')
        {
            if (oreturnobj != null && oreturnobj.FBID>0)
            {
                $("#txtFEONo").val("");
                SelectBatch(oreturnobj.BatchNo);
            }
            else
            {
                alert("Please select an item from list.");
                return false;
            }
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function SelectBatch(sBatchNo)
    {
        var oFabricBatch={
            BatchNo: $.trim(sBatchNo),
            WeavingProcessTypeTemp : 3
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatch,
            ControllerName: "FabricBatch",
            ActionName: "SearchByBatchNo",
            IsWinClose: false
        };
        $.icsDataGet(obj, function (response) {
            if (response.status && response.obj!=null) {
                ResetBeamsInfo();
                if (parseInt(response.obj.FBID) > 0) {
                    SetFabricBatchInfo(response.obj);
                }
                else {  alert("Data Not Found"); }
            }
        });
    }

    $("#txtBatchNo").keydown(function (e){
        if (e.keyCode === 13) // Enter Press
        {
            SelectBatch($("#txtBatchNo").val());
        }
        else if (e.keyCode === 8 || e.keyCode==27) // Back space
        {
            ResetBeamsInfo();
            $("#txtBatchNo").removeClass("fontColorOfPickItem");
            _oFabricBatch = "";
            $('#divFBInfo').find('input').not("#txtBatchNo").val('');//all field will be empty
            $('#divFBInfo').find('select').val(0);
            $("#cboMachineName,#txtTotalFinishLengthY,#txtTotalFinishLengthM" ).prop( "disabled", false );
            $('#btnRun').hide();
            $('#btnRunOut').hide();
            $('#btnAddBreakage').show();
            $('#btnDeleteBreakage').show();
            $('#btnAddBatchMan').show();
            $('#btnDeleteBatchMan').show();
            $("#btnTotalBreakageInformation").show();
            $('#btnPrint').show();
            $('#txtStartDate,#txtEndDate').datebox({disabled:false});
            $('#tpStartTime,#tpEndTime').timespinner({disabled:false});
            $('#tpStartTime,#tpEndTime').timespinner('setValue', "00:00");
            $('#txtStartDate,#txtEndDate').datebox('setValue', icsdateformat(new Date));
            MachineRefresh();
            var oList = [];
            RefreshList(oList,0);RefreshList(oList,1);
            $('#txtBatchNo').focus();
            
            GetFreeBeams(0);
        }
    });
   
    function SetFabricBatchInfo(oFabricBatch)
    {
        $("#txtBatchNo").val(oFabricBatch.BatchNo);
        $("#txtBatchNo").addClass("fontColorOfPickItem");
        $("#txtOrderNo").val(oFabricBatch.OrderNo);
        $("#txtStatus").val(oFabricBatch.StatusSt);
        $("#txtConstruction").val(oFabricBatch.Construction);

        $("#txtBuyer").val(oFabricBatch.BuyerName);
        $("#txtWeavingLengthY").val(oFabricBatch.Qty.toFixed(2));
        $("#txtWeavingLengthM").val(GetMeter(oFabricBatch.Qty,2));
        $("#txtTotalFinishLengthY").val(oFabricBatch.Qty.toFixed(2));
        $("#txtTotalFinishLengthM").val(GetMeter(oFabricBatch.Qty,2));
        $("#txtYetToWeavLengthY").val(oFabricBatch.Qty.toFixed(2));
        $("#txtYetToWeavLengthM").val(GetMeter(oFabricBatch.Qty,2));
        _oFabricBatchProduction.FEOID = oFabricBatch.FEOID;
        _oFabricBatchProduction.FBID = oFabricBatch.FBID;
        _oFabricBatchProduction.FabricBatchStatusInInt = oFabricBatch.StatusInInt;
        //Ratin
        ResetAllTables("tblBeams","tblBeamsWeaving","tblFBPBatchMan");

        GetWeavingInformation(oFabricBatch.FBID);
        
        if(parseInt(oFabricBatch.StatusInInt)>4 && parseInt(oFabricBatch.StatusInInt)<8 )//Sizing finish to  drawing finish (in any Step)
        {
            $('#btnRun').show();
        }
        if(parseInt(oFabricBatch.StatusInInt)==8)//Weaving
        {
            $('#btnRunOut').show();
        }
        else if(parseInt(oFabricBatch.StatusInInt)>8)//Weaving Finish
        {
            $('#btnAddBreakage').hide();
            $('#btnDeleteBreakage').hide();
            $('#btnAddBatchMan').hide();
            $('#btnDeleteBatchMan').hide();
            $("#btnTotalBreakageInformation").hide();
            $("#cboMachineName,#txtTotalFinishLengthY,#txtTotalFinishLengthM" ).prop("disabled", true );
            $('#tpStartTime').timespinner({disabled:true});
            $('#txtStartDate').datebox({disabled:true});
            $('#tpEndTime').timespinner({disabled:true});
            $('#txtEndDate').datebox({disabled:true});
        }
        else
        {
            GetFreeBeams(oFabricBatch.FBID);
        }
        $('#txtBatchNo').focus();
    }
    function GetFreeBeams(nFBID)
    {
        var oFabricMachine={
            WeavingProcess:3, // Warping
            MachineStatus:3, //Free
            FBID : nFBID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricMachine,
            ControllerName: "FabricMachine",
            ActionName: "GetsMachine",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if($.trim(response.objs[0].ErrorMessage) == "")
                {
                    $("#cboBeams").icsLoadCombo({
                        List: response.objs,
                        OptionValue: "FMID",
                        DisplayText: "Code"
                    });
                    
                    if(nFBID > 0)
                    {
                        var nLength = response.objs.length;
                        for(var i=0;i<nLength;i++)
                        {
                            if(response.objs[i].IsFromWeaving)
                            {
                                $("#cboBeams").val(response.objs[i].FMID);
                                _nRemoveLastItemID = response.objs[i].FMID;
                                break;
                            }
                        }
                    }
                    else
                    {
                        _nRemoveLastItemID = 0;
                    }
                }
                else
                {
                    $("#cboBeams").empty();
                }
            }
        });

        if(nFBID == 0)
        {
            if(_nRemoveLastItemID > 0)
            {
                $("#cboBeams option[value='"+_nRemoveLastItemID+"']").remove();
            }
            _nRemoveLastItemID = 0;
        }
    }


    function MachineRefresh()
    {
        $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricMachine/GetMachines",
                data: { nWeavingProcess:3, nMachineStatus:3},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //
                    _oFabricMachines = jQuery.parseJSON(data);
                    if (_oFabricMachines.length>0 )
                    {
                        $("#cboMachineName").icsLoadCombo({List: _oFabricMachines,OptionValue: "FMID",DisplayText: "Name"});
                    }

                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
    }


    function GetWeavingInformation(nFBID)
    {
        if (parseInt(nFBID) > 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchProduction/GetFabricBatchProductionForWeaving",
                data: { nFBID:nFBID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricBatchProduction = jQuery.parseJSON(data);
                    if (parseInt(oFabricBatchProduction.FBPID)>0)
                    {
                         _oFabricBatchProduction = oFabricBatchProduction;
                        RefreshControl(oFabricBatchProduction);
                        RefreshList(oFabricBatchProduction.FabricBatchProductionBreakages,0)//Breakage refresh
                        RefreshList(oFabricBatchProduction.FabricBatchProductionBatchMans,1)//Batchman refresh
                    }
                    else{
                        var sStartDate = oFabricBatchProduction.StartDateSt;
                        var sEndDateSt = oFabricBatchProduction.EndDateSt;
                        if(sStartDate == "01 Jan 0001")
                        {
                            sStartDate = icsdateformat(new Date);
                        }
                        if(sEndDateSt == "01 Jan 0001")
                        {
                            sEndDateSt = icsdateformat(new Date);
                        }

                        $("#txtStartDate").datebox("setValue", oFabricBatchProduction.StartDateSt);
                        $('#tpStartTime').timespinner('setValue', oFabricBatchProduction.StartDateStForTimeSpan);
                        $("#txtEndDate").datebox("setValue", oFabricBatchProduction.EndDateSt);
                        $('#tpEndTime').timespinner('setValue', oFabricBatchProduction.EndDateStForTimeSpan);
                        DynamicRefreshList(oFabricBatchProduction.FBPBs,"tblBeams");
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
    }
    function RefreshControl(oFabricBatchProduction)
    {

        if(parseInt(oFabricBatchProduction.FabricBatchStatusInInt)==8)
        {
            $('#btnRunOut').show();
            $("#cboMachineName" ).prop( "disabled", true);
            $('#tpStartTime').timespinner({disabled:true});
            $('#txtStartDate').datebox({disabled:true});
        }
        $("#txtRPM").val(oFabricBatchProduction.RPM);
        $("#txtTexture").val(oFabricBatchProduction.Texture);
        if(parseInt(oFabricBatchProduction.FMID)>0)
        {
            var oFM = {FMID:oFabricBatchProduction.FMID, Name:oFabricBatchProduction.FabricMachineName};
            _oFabricMachines.push(oFM);
            $("#cboMachineName").icsLoadCombo({List: _oFabricMachines,OptionValue: "FMID",DisplayText: "Name"});
            $("#cboMachineName").val(oFabricBatchProduction.FMID);
        }
        $("#txtTotalFinishLengthY").val(oFabricBatchProduction.Qty);
        $("#txtTotalFinishLengthM").val(GetMeter(oFabricBatchProduction.Qty,2));

        $('#tpStartTime').timespinner('setValue', oFabricBatchProduction.StartDateStForTimeSpan);
        $('#tpEndTime').timespinner('setValue', oFabricBatchProduction.EndDateStForTimeSpan);
        $('#txtStartDate').datebox('setValue', oFabricBatchProduction.StartDateSt);
        $('#txtEndDate').datebox('setValue',oFabricBatchProduction.EndDateSt);

        $("#txtYetToWeavLengthY").val( parseFloat($('#txtWeavingLengthY').val()) - parseFloat(oFabricBatchProduction.Qty));
        $("#txtYetToWeavLengthM").val(GetMeter((parseFloat($('#txtWeavingLengthY').val()) - parseFloat(oFabricBatchProduction.Qty)),2));
        $('#txtWeavingDuration').val(oFabricBatchProduction.BatchDuration);


        DynamicRefreshList(oFabricBatchProduction.FBPBs,"tblBeams");
        DynamicRefreshList(oFabricBatchProduction.FBPBs1,"tblBeamsWeaving");

        $('#cboBeams').append($("<option></option>").attr("value",oFabricBatchProduction.BeamID).text(oFabricBatchProduction.BeamNo)); 

    }


    //Breakage Start
  
    $("#btnAddBreakage").click(function(){
        if(parseInt(_oFabricBatchProduction.FBPID)<=0)
        {
            alert("Please Run the Batch Card then Add Breakage!");
            return false;
        }
        if(parseInt($('#cboBreakage').val())<=0)
        {
            alert("Select Breakage !");
            $('#cboBreakage').focus();
            return false;
        }
        if(parseInt($('#txtDuration').numberbox('getValue'))<=0)
        {
            alert("Duration Should be greater than 0 ");
            $('#txtDuration').focus();
            return false;
        }

        var oFBPBatchMan = $("#tblFBPBatchMan").datagrid("getSelected");
        if(oFBPBatchMan == null || oFBPBatchMan.FBPBID <=0)
        {
            alert("Invalid Fabric Batch Production Batch Man.");
            return false;
        }

        var oFBPBreakage = {
            FBPBreakageID:0,
            FBPBID: oFBPBatchMan.FBPBID,
            FBreakageID:$('#cboBreakage').val(),
            DurationInMin:$('#txtDuration').numberbox('getValue'),
            NoOfBreakage:$('#txtNumberOfBreakage').numberbox('getValue'),
            Note:''
        };

        SaveBreakage(oFBPBreakage,false, 0);
        $('#cboBreakage').val(0);
        $('#txtDuration').numberbox('setValue',0);
        $('#txtNumberOfBreakage').numberbox('setValue',0);
    });

    function SaveBreakage(oFBPBreakage,bIsEdit, nSelectedIndex)
    {
        //
        if(parseInt(_oFabricBatchProduction.FabricBatchStatusInInt)!=8)//weaving
        {
            alert("Can't add Breakage in this Step")
            return;//in this step can't add any data
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchProduction/SaveFBPBreakage",
            traditional: true,
            data:  JSON.stringify(oFBPBreakage),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                _oFBPBreakage = jQuery.parseJSON(data);
                if (_oFBPBreakage.FBPBreakageID>0)
                {
                    if(bIsEdit)
                    {
                        $('#tblFBPBreakage').datagrid('updateRow', { index: nSelectedIndex, row: _oFBPBreakage});
                    }else{
                        $("#tblFBPBreakage").datagrid("appendRow", _oFBPBreakage);
                    }
                    TotalNoOfBreakage();
                    //Update table tblFBPBatchMan
                    UpdateFBPBatchMan(_oFBPBreakage.FabricBatchProductionBreakages);
                    return;
                }
                else {
                    alert(_oFBPBreakage.ErrorMessage);
                    TotalNoOfBreakage();
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }

    $("#btnDeleteBreakage").click(function(){
        var oFBPBreakage= $("#tblFBPBreakage").datagrid("getSelected");
        if (oFBPBreakage == null || parseInt(oFBPBreakage.FBPBreakageID) <= 0) {
            alert("Please select an item from list!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return false;
        var nRowIndex = $("#tblFBPBreakage").datagrid("getRowIndex", oFBPBreakage);
        if (parseInt(oFBPBreakage.FBPBreakageID) > 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchProduction/DeleteFBPBreakage",
                data: { id: oFBPBreakage.FBPBreakageID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $("#tblFBPBreakage").datagrid("deleteRow", nRowIndex);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                    TotalNoOfBreakage();
                    UpdateFBPBatchMan($("#tblFBPBreakage").datagrid("getRows"));
                    editIndexBreakage = undefined;
                    endEditingBreakage();
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
    });

    function UpdateFBPBatchMan(oFabricBatchProductionBreakages)
    {
        if(oFabricBatchProductionBreakages.length > 0)
        {
            var nTotalBreakages=0;
            var nTotalNoOfBreakage=0;
            for(var i=0;i<oFabricBatchProductionBreakages.length;i++)
            {
                nTotalBreakages++;
                nTotalNoOfBreakage = parseInt(oFabricBatchProductionBreakages[i].NoOfBreakage) + parseInt(nTotalNoOfBreakage);
            }

            var oFBPBatchMan = $("#tblFBPBatchMan").datagrid("getSelected");
            var nRowIndex = $("#tblFBPBatchMan").datagrid("getRowIndex", oFBPBatchMan);

            oFBPBatchMan.TotalFBPBreakage = nTotalBreakages;
            oFBPBatchMan.TotalNoOfBreakage = nTotalNoOfBreakage

            $("#tblFBPBatchMan").datagrid("updateRow", { index: nRowIndex, row: oFBPBatchMan });
            $('#tblFBPBatchMan').datagrid('selectRow',nRowIndex);
        }
    }

   
    var editIndexBreakage = undefined;
    function endEditingBreakage(){
        if (editIndexBreakage == undefined){return true}
        if ($('#tblFBPBreakage').datagrid('validateRow', editIndexBreakage)){

            $('#tblFBPBreakage').datagrid('endEdit', editIndexBreakage);
            $('#tblFBPBreakage').datagrid('selectRow',editIndexBreakage);
            var oFBPBreakage=$('#tblFBPBreakage').datagrid('getSelected');
            oFBPBreakage.DurationInMin = parseInt(oFBPBreakage.DurationInMin);
            oFBPBreakage.NoOfBreakage = parseInt(oFBPBreakage.NoOfBreakage);
            oFBPBreakage.Note = oFBPBreakage.Note;
            SaveBreakage(oFBPBreakage, true,editIndexBreakage);
            editIndexBreakage = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRowBreakage(index){

        if (editIndexBreakage != index){
            if (endEditingBreakage())
            {
                $('#tblFBPBreakage').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                editIndexBreakage = index;
            }
            else
            {
                $('#tblFBPBreakage').datagrid('selectRow', editIndexBreakage);
            }
        }
    }
    //Breakage End

    //BatchMan Start
    function AddBatchMan()
    {
        if(parseInt(_oFabricBatchProduction.FBPID)<=0)
        {
            alert("Please Run the Batch Card then Add Batch Man!");
            return false;
        }
        if(parseInt($('#cboBatchMan').val())<=0)
        {
            alert("Select BatchMan !");
            $('#cboBatchMan').focus();
            return false;
        }
        if(parseInt($('#cboShift').val())<=0)
        {
            alert("Select Shift !");
            $('#cboShift').focus();
            return false;
        }
        if(parseInt($('#txtFinishLengthY').val())<=0)
        {
            alert("Finish Length greater than 0 ");
            $('#txtFinishLengthY').focus();
            return false;
        }
        var oFBPBatchMan = {
                        FBPBID:0,
                        FBPID:_oFabricBatchProduction.FBPID,
                        EmployeeID:$('#cboBatchMan').val(),
                        ShiftID:$('#cboShift').val(),
                        Qty:$('#txtFinishLengthY').val(),
                        FinishDate:$('#txtFinishDate').datebox('getValue'),
                        Note:''
        };

        SaveBatchMan(oFBPBatchMan,false, 0);
        $('#cboBatchMan').val(0);
        $('#cboShift').val(0);
        $('#txtFinishLengthY').val(0);
        $('#txtFinishLengthM').val(0);
        $('#txtFinishDate').datebox('setValue',icsdateformat(new Date()));

    }
    function SaveBatchMan(oFBPBatchMan,bIsEdit, nSelectedIndex)
    {
        if(parseInt(_oFabricBatchProduction.FabricBatchStatusInInt)!=8)//Weaving
        {
            alert("in this step can't add any data");
            return;//in this step can't add any data
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchProduction/SaveFBPBatchMan",
            traditional: true,
            data:  JSON.stringify(oFBPBatchMan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //
                _oFBPBatchMan = jQuery.parseJSON(data);
                if (parseInt(_oFBPBatchMan.FBPBID)>0)
                {
                    if(bIsEdit)
                    {
                        $('#tblFBPBatchMan').datagrid('updateRow', { index: nSelectedIndex, row: _oFBPBatchMan});
                    }else{
                        $("#tblFBPBatchMan").datagrid("appendRow", _oFBPBatchMan);
                    }
                    return;
                }
                else {
                    alert(_oFBPBatchMan.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
    function DeleteBatchMan()
    {

        var oFBPBatchMan= $("#tblFBPBatchMan").datagrid("getSelected");
        if (oFBPBatchMan == null || parseInt(oFBPBatchMan.FBPBID) <= 0) {
            alert("Please select an item from list!");
            return false;
        }

        if (!confirm("Confirm to Delete?")) return false;
        var nRowIndex = $("#tblFBPBatchMan").datagrid("getRowIndex", oFBPBatchMan);
        if (parseInt(oFBPBatchMan.FBPBID) > 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/FabricBatchProduction/DeleteFBPBatchMan",
                data: { id: oFBPBatchMan.FBPBID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $("#tblFBPBatchMan").datagrid("deleteRow", nRowIndex);
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                    editIndexBatchMan = undefined;
                    endEditingBatchMan();
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }

    }
    var editIndexBatchMan = undefined;
    function endEditingBatchMan(){
        if (editIndexBatchMan == undefined){return true}
        if ($('#tblFBPBatchMan').datagrid('validateRow', editIndexBatchMan)){
            $('#tblFBPBatchMan').datagrid('endEdit', editIndexBatchMan);
            $('#tblFBPBatchMan').datagrid('selectRow',editIndexBatchMan);
            var oFBPBatchMan=$('#tblFBPBatchMan').datagrid('getSelected');
            oFBPBatchMan.Qty=oFBPBatchMan.Qty;
            oFBPBatchMan.FinishDate= icsdateformat(new Date(oFBPBatchMan.FinishDate)),
            oFBPBatchMan.Note=oFBPBatchMan.Note;
            SaveBatchMan(oFBPBatchMan, true,editIndexBatchMan);
            editIndexBatchMan = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRowBatchMan(index){

        if (editIndexBatchMan != index){
            if (endEditingBatchMan())
            {
                $('#tblFBPBatchMan').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                editIndexBatchMan = index;
            }
            else
            {
                $('#tblFBPBatchMan').datagrid('selectRow', editIndexBatchMan);
            }
        }
    }
    //BatchMan End

    //Run Start
    function ValidateInput()
    {
        if(parseInt(_oFabricBatchProduction.FBID)<=0)
        {
            alert("Sorry, there is no Fabric Batch!");
            return false;
        }

        if(parseInt($('#cboMachineName').val())<=0)
        {
            alert("Select machine!");
            $('#cboMachineName').focus();
            return false;
        }

        return true;
    }

    function RefreshObject()
    {

        var dStartDate =$('#txtStartDate').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var oFabricBatchProduction= {
                FBPID:0,
                FBID:_oFabricBatchProduction.FBID,
                WeavingProcess:3,
                FMID:$('#cboMachineName').val(),
                RPM:$('#txtRPM').val(),
                Texture:$('#txtTexture').val(),
                StartTime: dStartDate,
                FabricBatchStatus:8,//Weaving
                FBPriviousStatus:_oFabricBatchProduction.FabricBatchStatusInInt,//Sizing finish, Drawing or  Drawing_fionish
                Qty:$('#txtTotalFinishLengthY').val()
        };
        return oFabricBatchProduction;
    }

    function Run()
    {
        if(!ValidateInput()) return;
        var oFabricBatchProduction = RefreshObject();

        oFabricBatchProduction.FBPBs = $("#tblBeamsWeaving").datagrid("getRows");

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchProduction/Save",
            traditional: true,
            data:  JSON.stringify(oFabricBatchProduction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //
               var oFabricBatchProduction = jQuery.parseJSON(data);
                if (oFabricBatchProduction.FBPID>0)
                {
                    alert("Succefully Run");
                    $('#txtStatus').val(oFabricBatchProduction.FabricBatchStatusInString);
                    $('#tpStartTime').timespinner({disabled:true});
                    $('#txtStartDate').datebox({disabled:true});
                    $('#tpStartTime').timespinner('setValue', oFabricBatchProduction.StartDateStForTimeSpan);
                    $('#txtStartDate').datebox('setValue', oFabricBatchProduction.StartDateSt);
                    $('#txtWeavingDuration').val(oFabricBatchProduction.BatchDuration);
                    $('#btnRunOut').show();
                    $('#btnRun').hide();
                    _oFabricBatchProduction=oFabricBatchProduction;
                    return;

                }
                else {
                    alert(oFabricBatchProduction.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
    //Run end

    //RunOut Start
    function RunOut()
    {
        if(parseInt(_oFabricBatchProduction.FBPID)<=0)
        {
            alert("Sorry, there is no Fabric Batch Production!");
            return false;
        }
        if(parseInt(_oFabricBatchProduction.FabricBatchStatusInInt)!=8)
        {
            alert("Please Run First Then Run Out!");
            return false;
        }
        
        if($("#tblBeamsWeaving").datagrid("getRows").length <= 0)
        {
            alert("Add Beam!");
            $('#cboBeams').focus();
            return false;
        }


        var dEndDate =$('#txtEndDate').datebox('getValue');
        var EndTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndTime.split(':');
        var hEndTime= parseFloat(sTime[0]);
        var mEndTime= parseFloat(sTime[1]);
        dEndDate = new Date(dEndDate);
        dEndDate.setHours(hEndTime);
        dEndDate.setMinutes(mEndTime);

        var oFabricBatchProduction = {
            FBPID:_oFabricBatchProduction.FBPID,
            FBID:_oFabricBatchProduction.FBID,
            WeavingProcess:3, //Loom=3
            FMID:$('#cboMachineName').val(),
            FabricBatchStatus:9,//weaving-finish
            FBPriviousStatus:_oFabricBatchProduction.FabricBatchStatusInInt,
            EndTime:dEndDate,
            RPM:$('#txtRPM').val(),
            Qty:$('#txtTotalFinishLengthY').val(),
            IsFromRunOut:true
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FabricBatchProduction/Save",
            traditional: true,
            data:  JSON.stringify(oFabricBatchProduction),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //
               var  oFabricBatchProduction = jQuery.parseJSON(data);
                if (oFabricBatchProduction.FBPID>0)
                {
                    alert("Succefully Run Out");
                    $('#txtStatus').val(oFabricBatchProduction.FabricBatchStatusInString);
                    $('#txtWeavingDuration').val(oFabricBatchProduction.BatchDuration);
                    $('#txtEndDate').datebox({disabled:true});
                    $('#tpEndTime').timespinner({disabled:true});
                    $('#tpEndTime').timespinner('setValue', oFabricBatchProduction.EndDateStForTimeSpan);
                    $('#txtEndDate').datebox('setValue', oFabricBatchProduction.EndDateSt);
                    $('#btnRunOut').hide();
                    $('#btnAddBreakage').hide();
                    $('#btnDeleteBreakage').hide();
                    $('#btnAddBatchMan').hide();
                    $('#btnDeleteBatchMan').hide();
                    $("#btnTotalBreakageInformation").hide();
                    $('#btnAddColor').hide();
                    $('#btnDeleteColor').hide();
                    return;

                }
                else {
                    alert(oFabricBatchProduction.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
    //RunOut End

    //nType: Breakage;1=Batchmans;2
    function RefreshList(oList,nType)
    {
        var data=oList;
        data={"total":""+data.length+"","rows":data};
         if(parseInt(nType)==0)
        {
            $('#tblFBPBreakage').datagrid('loadData',data);
        }else if(parseInt(nType)==1)
        {
            $('#tblFBPBatchMan').datagrid('loadData',data);
        }
    }
    function Print()
    {
        if (_oFabricBatchProduction == null || parseInt(_oFabricBatchProduction.FBPID) <= 0) {
            alert("Sorry, there is no Batch Production. Please Pick Batch!");
            return;
        }
        if ( parseInt(_oFabricBatchProduction.FabricBatchStatusInInt) < 8) {
            alert("Sorry, yet not start Weaving for this Batch!");
            return;
        }
        var nts = ((new Date()).getTime()) / 1000;
        window.open(_sBaseAddress + '/FabricBatchProduction/PrintRollDoffingCard?nFBPID=' + _oFabricBatchProduction.FBPID + "&nts=" + nts, "_blank");
    }

</script>