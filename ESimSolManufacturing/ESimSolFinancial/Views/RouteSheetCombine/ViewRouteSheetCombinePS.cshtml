@{
    ViewBag.Title = "Combine RouteSheet ";
}

<body>
    @model ESimSol.BusinessObjects.RouteSheetCombine
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div id="tabRS" class="easyui-tabs" >
            <div title="Dye line Entry" id="divOne">
                <div style="width:99%;">
                    <fieldset >
                        <legend style="font-weight:bold">Order info </legend>
                        <table cellpadding="1" cellspacing="1" style="width:100%">
                            <tr>
                                <td style="width:15%; text-align: right">
                                    <label>Combine Dye line No</label>
                                </td>
                                <td style="width: 20%; text-align: left">
                                    <input id="txtRSNo_Combine" style="width: 70%" placeholder="Auto No" />
                                </td>

                                <td style="width: 15%; text-align: right">
                                    <label>Date</label>
                                </td>
                                <td style="width: 10%; text-align: right">
                                    <input id="txtDate" type="text" class="easyui-datebox" style="width: 105px;" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                            </tr>
                        </table>
                        <table style="width:100%;width:100%">
                                <tr>
                                    <td style="width: 10%; text-align: right">
                                        <label>Machine</label>
                                    </td>
                                    <td style="width: 30%; text-align: left">
                                        <input id="txtMachine" class="reset-text txt-styler-picker" placeholder="Search Machine" />
                                        <a id="btnPickMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnResetMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                    </td>
                                    <td style="width: 10%; text-align: right">
                                     Note:
                                    </td>
                                    <td style="width: 50%; text-align: left">
                                        <input id="txtNote" style="width:100%;"/>
                                    </td>
                                </tr>

                            </table>
                      
                    </fieldset>
                    <fieldset>
                        <legend style="font-weight:bold">Detail info </legend>
                        <table id="tblRouteSheetCombineDetail" class="easyui-datagrid" style="width:100%;height:280px;"
                               data-options="singleSelect: true,fitcolumn:false,  rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbar',onClickRow:onClickRow ">
                            <thead>
                                <tr>
                                    <th data-options="field:'Selected',checkbox:true"></th>
                                    <th field="RouteSheetNo" width="10%" align="left">Dye line No</th>
                                    <th field="OrderNo" width="10%" align="left">Order No</th>
                                    <th field="Qty" width="10%" align="right" formatter="formatPrice">Qty(Kg)</th>
                                    @*<th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">Qty(Kg)</th>*@
                                    @*<th field="QtyKg" width="10%" align="right" formatter="formatPrice">Qty(Lbs)</th>*@
                                    <th data-options="field:'TtlLiquire',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">TtlLiquire</th>
                                    <th data-options="field:'TtlCotton',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">TtlCotton</th>
                                    <th data-options="field:'QtyDye',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">Qty(Dummy)</th>
                                    <th data-options="field:'NoOfHanksCone',align:'right',editor:{type:'numberbox',options:{precision:0}}" width="8%">Bag/Cone</th>
                                    <th field="ProductName" width="10%" align="left">Product</th>
                                    <th field="ColorNameShade" width="10%" align="left">Color Name</th>
                                    <th field="RSStateStr" width="10%" align="left">Status</th>

                                </tr>
                            </thead>
                        </table>
                        <div id="toolbar">
                            <table>

                                <tr>
                                    <td>
                                        <input id="txtRSNo" class="reset-text" placeholder="Search by Batch" style="width: 18%" />
                                        <a id="btnPickRSNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        <a id="btnResetRSNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                        @*<input id="txtLabdipNo" class="reset-text" placeholder="Search by Lab dip No" style="width: 10%" />
                                       <a id="btnPickLabdipNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>*@
                                        <input id="txtColorNo" class="reset-text" placeholder="Search by Color No" style="width: 15%" />
                                        <a id="btnPickColorNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                        @*<a id="btnResetColorNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>*@

                                        @*<a id="btnRSCreate" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-add" plain="true"></a>
                                        <a id="btnUpdate" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-mini-edit" plain="true">Update</a>
                                        <a id="btnUpdateAll" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-ok" plain="true">Apply All</a>*@
                                        <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                                        <a id="btnRefreshRSDO" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                                        <label>Liquor</label> <input id="txtTtlLiquire" style="width:10%;" class="number" />
                                        <label>Qty(Dummy)</label> <input id="txtQtyDye" style="width:10%;" class="number" />
                                        <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-mini-edit" plain="true">Qty Edit</a>
                                    </td>
                                </tr>
                            </table>

                        </div>
                        <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                            <tr>
                                <td style="width:10%;  text-align:right;font-weight:bold;">Total:</td>
                                <td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label> </td>
                                @*<td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblTotalQtyTwo">0</label> </td>*@
                                <td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblTtlLiquire">0</label> </td>
                                <td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblTtlCotton">0</label> </td>
                                <td style="width:15%;  text-align:right;font-weight:bold;"><label id="lblQtyDye">0</label> </td>
                                <td style="width:15%;  text-align:right;font-weight:bold;"> </td>

                            </tr>
                        </table>
                    </fieldset>

                </div>
                <fieldset>
                    <legend>Action</legend>
                    <div style="width:100%;height:10%">
                        <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                            <tr>
                                <td style=" float:left;  width:55%; text-align: left ">
                                    <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Combine)</a>
                                    <a id="btnPrintSingle" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Single)</a>
                                </td>

                                <td style="width: 20%; text-align: right"></td>
                                <td style="width:25%; text-align: right">
                                    <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                    <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Approve</a>
                                    <a id="btnUndoApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Undo Approve</a>
                                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </fieldset>
            </div>
            <div title="Solution Templete" id="divTwo" style="height:99%">
                <div>
                    <div style="width:100%;height:88%">
                        <fieldset>
                            <legend>Solution Templete</legend>
                            <div style="width:100%">
                                <table id="tblTreeGridProcess" class="easyui-treegrid" style="width:100%; height:425px;"
                                       data-options="idField:'RouteSheetDetailID',treeField:'ProcessName', rownumbers:'true', toolbar:'#toolbarTemplet'">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'ProcessName'" width="20%">Name</th>
                                            <th data-options="field:'GL', align:'center'" width="5%">GL</th>
                                            <th data-options="field:'Percentage', align:'center'" width="5%">(%)</th>
                                            <th data-options="field:'TempTime',align:'center'" width="8%">Temp & Time</th>
                                            <th data-options="field:'TotalQtyStr',align:'center'" width="10%">Total Qty (Kg)</th>
                                            <th data-options="field:'AddOneQtyStr',align:'center'" width="10%">Add One Qty (Kg)</th>
                                            <th data-options="field:'AddTwoQtyStr',align:'center'" width="10%">Add Two Qty (Kg)</th>
                                            <th data-options="field:'AddThreeQtyStr',align:'center'" width="10%">Add Three Qty (Kg)</th>
                                            <th data-options="field:'ReturnQtyStr',align:'center'" width="10%">Return Qty (Kg)</th>
                                            <th data-options="field:'Note', align:'center'" width="8%">Note</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarTemplet">
                                    <input type="text" id="txtDyeingSolution" placeholder="Search dyeing solution" style="width:15%" />
                                    <a id="btnPickDyeingSolution" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                    <a id="btnResetDyeingSolution" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>

                                    <input type="checkbox" id="chkDyeChemical" /> <label id="lblDyesChemical">Dye Chemical</label>
                                    <a id="btnAddTemplet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                                    <a id="btnEditTemplet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                                    <a id="btnDeleteTemplet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                                    <a id="btnAdditional" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"><label id="lblAdditional">Add. One</label></a>
                                    @*<a id="btnReturn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Return</a>*@
                                    <a id="btnSequenceConfigure" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Sequence</a>
                                    <a id="btnLabdipRecipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Show Labdip Recipe</a>
                                    <input type="text" id="txtRSNoFrom" placeholder="Copy From Batch" style="width:10%" />
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <fieldset>
                        <legend>Action</legend>
                        <div style="width:100%;height:10%">
                            <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                                <tr>
                                    <td style=" float:left;  width:65%; text-align: left ">
                                        <a id="btnPrintTwo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Combine)</a>
                                        <a id="btnPrintSingleTwo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print(Single)</a>
                                    </td>

                                    <td style="width: 20%; text-align: right"></td>
                                    <td style="width:15%; text-align: right">
                                        <a id="btnSaveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                        <a id="btnCloseTwo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                    </td>
                                </tr>
                            </table>


                        </div>
                    </fieldset>
                </div>
            </div>

        </div>
    </div>
    <div id="winTemplet" class="easyui-window winstyle" title="Dyeing Solution" style="width:620px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="width: 98%; font-family: Tahoma;">
            <table class="tbl-Win">
                <tr class="templet">
                    <td class="td-col-5 align-right">
                        <label>Process :</label>
                    </td>
                    <td class="td-styler td-col-25" colspan="3">
                        <select id="cboProcess" class="cbo-styler"></select>
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>
                <tr class="templet">
                    <td class="td-col-5 align-right">
                        <label>Temp & Time :</label>
                    </td>
                    <td class="td-styler td-col-25" colspan="3">
                        <input id="txtTempTime" class="reset-text txt-styler" placeholder="Temp & Time" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>

                <tr class="templet-dc">
                    <td class="td-col-5 align-right">
                        <label>Product :</label>
                    </td>
                    <td class="td-styler td-col-25" colspan="4">
                        <select style="width:20%;" id="cboProductType">
                            <option value="12">Dyes</option>
                            <option value="13">Chemicals</option>
                        </select>
                        <input id="txtProduct-DS" style="width:60%" placeholder="Search Product" />
                        <a id="btnPickProduct-DS" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnResetProduct-DS" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    </td>
                    @*<td class="td-styler td-col-1"></td>*@
                </tr>
                <tr class="templet-dc">
                    <td class="td-col-5 align-right">
                        <label>GL :</label>
                    </td>
                    <td class="td-styler td-col-4">
                        <input id="txtGL" min="0" max="100" class="number reset-text txt-styler" placeholder="GL" />
                    </td>
                    <td class="td-styler td-col-6 align-right">
                        <label>Percentage (%) :</label>
                    </td>
                    <td class="td-styler td-col-15">
                        <input id="txtPercentage" min="0" max="100" class="number reset-text txt-styler-Percentage" placeholder="%" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>

                <tr class="templet-dc">
                    <td class="td-col-5 align-right">
                        <label>Adjustment :</label>
                    </td>
                    <td class="td-styler td-col-4">
                        <input id="txtAdjustment" min="0" max="100" class="number reset-text txt-styler" placeholder="Adjustment" />
                    </td>
                    <td class="td-styler td-col-6 align-right">
                        <label>For Cotton :</label>
                    </td>
                    <td class="td-styler td-col-15">
                        <input type="checkbox" id="chkForCotton" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>
                <tr>
                    <td class="td-col-5 align-right">
                        <label>Note :</label>
                    </td>
                    <td class="td-styler td-col-25" colspan="3">
                        <input id="txtNoteTemplet" class="reset-text txt-styler" placeholder="Note" />
                    </td>
                    <td class="td-styler td-col-1"></td>
                </tr>
                <tr>
                    <td colspan="5" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                        <a id="btnSaveTemplet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnCloseTemplet" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div id="winAdditionalReturn" class="easyui-window winstyle" title="Additional Return" style="width:450px; height:auto" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table class="tbl-Win">
            <tr>
                <td class="td-col-5 align-right">
                    <label>Product Name :</label>
                </td>
                <td class="td-styler td-col-14">
                    <input id="txtAdditionalReturnProduct" class="reset-text txt-styler" placeholder="Product Name" disabled />
                </td>
                <td class="td-styler td-col-1"></td>
            </tr>
            <tr>
                <td class="td-col-5 align-right">
                    <label>Quantity :</label>
                </td>
                <td class="td-styler td-col-14">
                    <div class="region-parent">
                        <div class="region-child">
                            <input id="txtAdditionalReturnQtyKg" class="reset-text only-number txt-styler-custom align-right" />
                            <span>kg</span>
                        </div>
                        <div class="region-child align-right">
                            <input id="txtAdditionalReturnQtyGm" class="reset-text only-number txt-styler-custom align-right" />
                            <span>gm</span>
                        </div>
                    </div>
                </td>
                <td class="td-styler td-col-1"></td>
            </tr>
            <tr>
                <td colspan="3" style="text-align:right; padding-top:10px; padding-bottom:10px;">
                    <a id="btnSaveAdditionalReturn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                    <a id="btnCloseAdditionalReturn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </div>
    <div id="winRSDequence" class="easyui-window" title="View  Sequence Configure" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table id="tblDSTSequence" class="easyui-datagrid" style="width:100%;height:400px" data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarSequence' ">
            <thead>
                <tr>
                    <th field="ProcessName" width="50%" align="left">ProcessName</th>
                    <th field="TempTime" width="15%" align="left">TempTime</th>
                    <th field="Note" width="20%" align="left">Note</th>
                    <th field="Sequence" width="10%" align="left">Sequence</th>
                </tr>
            </thead>
        </table>
        <div id="toolbarSequence">
            <a href="javascript:void(0)" id="btnUp" class="easyui-linkbutton" iconcls="icon-up" plain="true" onclick="UP()">Up</a>
            <a href="javascript:void(0)" id="btnDown" class="easyui-linkbutton" iconcls="icon-down" plain="true" onclick="Down()">Down</a>
            <a href="javascript:void(0)" id="btnRefresh" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="RefreshMenuSequence()">Refresh</a>
        </div>

        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnSaveSequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="SaveSequence()">Save</a>
            <a id="btnCloseDSTSequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>

    </div>
    <div id="winLabdipRecipe" class="easyui-window" title="View  Sequence Configure" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table id="tblLabdipRecipe" class="easyui-datagrid" style="width:100%;height:400px" data-options="singleSelect: false,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false">
            <thead>
                <tr>
                    <th data-options="field:'Selected',checkbox:true"></th>
                    <th field="ProductCode" width="10%" align="left">Code</th>
                    <th field="ProductName" width="40%" align="left">ProductName</th>
                    <th field="Qty" width="10%" align="left">Qty</th>
                    <th field="Note" width="20%" align="left">Note</th>
                </tr>
            </thead>
        </table>

        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnSaveLabdipRecipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">OK</a>
            <a id="btnCloseLabdipRecipe" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>

    <div id="winRouteSheetDO" class="easyui-window" title="View  Route Sheet DO" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table id="tblRouteSheetDO" class="easyui-datagrid" style="width:100%;height:400px" data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, onClickRow:onClickRowRSDO">
            <thead>
                <tr>
                    <th field="OrderNoFull" width="20%" align="left"> Order No</th>
                    <th data-options="field:'Qty_RS',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="15%"> <label>Qty</label><span class="lblMUnit"></span></th>
                    <th data-options="field:'Qty_RSKG',align:'right',editor:{type:'numberbox',options:{precision:8}}" width="15%"><label>Qty</label><span class="lblMUnitTwo"></span></th>
                </tr>
            </thead>
        </table>

        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnSaveRouteSheetDO" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">OK</a>
            <a id="btnCloseRouteSheetDO" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>
</body>

<style type="text/css">
   .td-styler input, select {
        padding-left: 5px;
    }
    .txt-styler{
        width:95%;
    }
    .txt-styler-picker{
        width:50%;
    }
    .cbo-styler{
        width:98%;
    }
    .txt-styler-Note{
         width:98.5%;
    }

    .txt-styler-Mul{
        width:70%;
    }
    .region-parent{
        float:left; width:100%;
    }
    .region-child{
        float:left; width:50%;
    }

    .region-hanks-cone{
        float:left; width:95%;
    }

    .region-hanks-cone-input{
        float:left; width:30%;
    }
    .region-hanks-cone-label{
        float:left; width:40%;
    }

    .tbl-Win{
        width:100%;
    }
    .txt-styler-Percentage{
         width:82%;
    }

    .txt-styler-custom{
        width:75%;
    }

     #winRSDequence {
      width: 600px;
      }
      #winLabdipRecipe {
      width: 600px;
      }
       #winRouteSheetDO {
      width: 500px;
      }
</style>

<script type="text/javascript">
    var _sBaseAddress = "";
    var _oRouteSheetCombine=null;
    var _oRouteSheetDO=null;
    var _nLabDipDetailID=0;
    var _oRouteSheetCombineDetail=[];
    var _nProductID = 0;
    var _nLotID = 0;
    var _nMachineID = 0;
    var _nLocationID = 0;
    var _oRouteSheetDetail=null;
    var _nBUID=0;
    var _sBackLink="";
    var _nQty_RS = 0;
    var _nQty_RSKG = 0;

    $(document).ready(function ()
    {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oRouteSheetCombine =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oWorkingUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        var oOrderTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.OrderTypes));
        var oLocations=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Locations));
        var oRouteSheetDOs=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RouteSheetDOs));
        _oRouteSheetDO=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RouteSheetDO));
        var IsOut=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.IsOut));
        var oRouteSheetSetup=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RouteSheetSetup));
        var oProductTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ProductTypes));
        debugger;
        RSSetup(oRouteSheetSetup);
        _sBackLink=sessionStorage.getItem("BackLink");
        //Control_disabled();
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $("#cboOrderType").icsLoadCombo({
            List: oOrderTypes,
            OptionValue: "OrderType",
            DisplayText: "ShortName"
        });

        $("#cboStore").icsLoadCombo({
            List: oWorkingUnits,
            OptionValue: "WorkingUnitID",
            DisplayText: "WorkingUnitName",
            InitialValue:""
        });
        $("#cboLocation").icsLoadCombo({
            List: oLocations,
            OptionValue: "LocationID",
            DisplayText: "Name",
            InitialValue:""
        });
      //  $("#cboProductType").icsLoadCombo({  List: oProductTypes, OptionValue: "id",  DisplayText: "Value"});
        _oRouteSheetDetail=_oRouteSheetCombine.RouteSheetDetail;
        if(oRouteSheetDOs!=null && oRouteSheetDOs.length>0)
        {
            _oRouteSheetDO=oRouteSheetDOs[0];
        }
        Initialization(_oRouteSheetCombine,((sessionStorage.length>0)?sessionStorage.getItem('Operation'):'New'),IsOut);
    });
    function RSSetup(oRouteSheetSetup)
    {
        $('#lblRSNo').html(oRouteSheetSetup.RSShortName);
        $(".lblMUnit").html("("+oRouteSheetSetup.MUnit+")");
        $(".lblMUnitTwo").html("("+oRouteSheetSetup.MUnitTwo+")");
        //$('#lblMunit').html(oRouteSheetSetup.MUnit);
        //$("#txtLabdipNo").attr("placeholder", "Type "+oLabDipSetup.OrderName);
    }
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    function Initialization(oRouteSheetCombine, sOperation,IsOut){
        ResetControll();
        if(oRouteSheetCombine.RouteSheetCombineID>0)
        {
            RefreshControl(oRouteSheetCombine);
        }

        if(sOperation=="View")
        {
            $('#toolbar,#btnApprove,#btnUndoApprove,#btnSave,.ics-pick').hide();
            $('input,select').not('#txtRSNo_Combine').prop('disabled',true);
        }

        else if(sOperation=="Approve")
        {
            $('#toolbar,#btnSave,#btnUndoApprove,.ics-pick').hide();
            $('#btnApprove').show();
            //$('input,select').not('#txtClaimOrderNo').prop('disabled',true);
        }
        else if(sOperation=="UndoApprove")
        {
            $('#toolbar,#btnApprove,#btnSave,.ics-pick').hide();
            $('#btnUndoApprove').show();
            //$('input,select').not('#txtClaimOrderNo').prop('disabled',true);
        }
        else{
            $('#btnApprove,#btnUndoApprove').hide();
            $('#toolbar,#btnSave,.ics-pick').show();

            if(IsOut){
                $('#txtDyeingSolution,#btnPickDyeingSolution,#btnResetDyeingSolution').hide();
                $('#tblParent .ics-pick, #btnSave').hide();
                $('#tblParent input,#tblParent select').not('#txtRouteSheetNo').prop('disabled',true);
                $('#tblParent .txt-styler-picker').css('width','95%');
            }
            else{
                $('#toolbarTemplet,#btnSave,.ics-pick').show();
                $('input,select').not('.type-diabaled').prop('disabled',false);
                $('.txt-styler-picker').css('width','70%');
            }
        }
    }


    function ResetControll()
    {
        $('#txtDate').datebox('setValue', icsdateformat(new Date()));
        $('.reset-text').val("");
        DynamicRefreshList([], 'tblRouteSheetCombineDetail');
        RefreshSummary();
    }
    function RefreshControl(oRouteSheetCombine)
    {
        debugger;

        if(_oRouteSheetDO.RouteSheetDOID>0)
        {
            $('#cboOrderType').val(_oRouteSheetDO.OrderTypeInt);
            $('#txtOrderNo').val(_oRouteSheetDO.OrderNoFull);

        }

        _oRouteSheetCombine=oRouteSheetCombine;
        $('#txtRSNo_Combine').val(oRouteSheetCombine.RSNo_Combine);
        $('#txtDate').datebox('setValue',oRouteSheetCombine.CombineRSDateSt);
        $('#txtNote').val(oRouteSheetCombine.Note);
        var nQty=0;
        var nQtyDye=0;
        if(oRouteSheetCombine.RouteSheetCombineDetails!==null && oRouteSheetCombine.RouteSheetCombineDetails.length>0)
        {
            DynamicRefreshList(oRouteSheetCombine.RouteSheetCombineDetails, 'tblRouteSheetCombineDetail');

            _nMachineID=oRouteSheetCombine.RouteSheetCombineDetails[0].MachineID;
            _nProductID=oRouteSheetCombine.RouteSheetCombineDetails[0].ProductID_Raw;
            _nLotID=oRouteSheetCombine.RouteSheetCombineDetails[0].LotID;
            $("#txtMachine").val(oRouteSheetCombine.RouteSheetCombineDetails[0].MachineName);
            $("#txtProduct").val(oRouteSheetCombine.RouteSheetCombineDetails[0].ProductName_Raw);
            $("#txtLot").val(oRouteSheetCombine.RouteSheetCombineDetails[0].LotNo);
            $("#cboStore").val(oRouteSheetCombine.RouteSheetCombineDetails[0].WorkingUnitID);

            for(var i = 0; i<oRouteSheetCombine.RouteSheetCombineDetails.length;i++)
            {
                nQty=nQty+parseFloat(oRouteSheetCombine.RouteSheetCombineDetails[i].TtlLiquire);
                nQtyDye=nQtyDye+parseFloat(oRouteSheetCombine.RouteSheetCombineDetails[i].QtyDye);
            }
            $('#txtTtlLiquire').val(parseFloat(nQty));
            $('#txtQtyDye').val(parseFloat(nQtyDye));
        }
        else{
            DynamicRefreshList([], 'tblRouteSheetCombineDetail');
        }
        RefreshSummary();
        var oTree=[];
        if(_oRouteSheetDetail!=null && _oRouteSheetDetail.RouteSheetDetailID>0)
        {
            oTree=[_oRouteSheetDetail];
        }
        LoadTreeGrid(oTree);
    }
    function Control_disabled()
    {
        document.getElementById("txtQty").disabled = true;
        document.getElementById("txtQtyTwo").disabled = true;
        document.getElementById("txtTtlLiquire").disabled = true;
        document.getElementById("txtQtyDye").disabled = true;
        document.getElementById("txtTtlLiquire_Cotton").disabled = true;
        document.getElementById("txtRSNo_Combine").disabled = true;
    }
    function Validation(){

        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');

        if(oRSCombineDetails ==null || oRSCombineDetails.length<=0){
            $('#txtRSNo').focus();
            $('#txtRSNo').addClass("errorFieldBorder");
            alert('Dyeline not found required.');
            return false;
        }
        else{
            $('#txtRSNo').removeClass("errorFieldBorder");
        }

        if(_nMachineID ==null || _nMachineID<=0){
            $('#txtRSNo').focus();
            $('#txtRSNo').addClass("errorFieldBorder");
            alert('Machaine required.');
            return false;
        }
        else{
            $('#txtRSNo').removeClass("errorFieldBorder");
        }

        return true;
    }


    /*---------------- LadDip Gets By Labdip No and color No  --------------*/

    $("#btnPickLabdipNo").click(function () {

        var sLabdipNo=$.trim($("#txtLabdipNo").val());

        var oLabDipDetails = {
            ColorNo:"",
            LabdipNo:sLabdipNo
        };

        GetLabDipDetails(oLabDipDetails);
    });

    $("#txtLabdipNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLabdipNo=$.trim($("#txtLabdipNo").val());
            var oLabDipDetails = {
                ColorNo:"",
                LabdipNo:sLabdipNo
            };
            GetLabDipDetails(oLabDipDetails);
        }
        else if(nkeyCode==8){
            $("#sLabdipNo").val("");
            _nLabDipDetailID=0;
        }
    });
    $("#btnColorNo").click(function () {

        var sColorNo=$.trim($("#txtColorNo").val());



        var oLabDipDetails = {
            ColorNo:sColorNo,
            LabdipNo:""
        };

        GetLabDipDetails(oLabDipDetails);
    });

    $("#txtColorNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sColorNo=$.trim($("#txtColorNo").val());

            var oLabDipDetails = {
                ColorNo:sColorNo,
                LabdipNo:""
            };
            GetLabDipDetails(oLabDipDetails);
        }
        else if(nkeyCode==8){
            $("#txtColorNo").val("");
            _nLabDipDetailID=0;
        }
    });
    function GetLabDipDetails(oLabDipDetails){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLabDipDetails,
            ControllerName: "RouteSheetCombine",
            ActionName: "GetsLabDipDetail",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LabDipDetailID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LabdipNo", title: "LabdipNo", width: 110, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 110, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 160, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winLabDipPicker',
                        winclass:'clsLabDipPicker',
                        winwidth: 550,
                        winheight: 460,
                        tableid: 'tblLabDipPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ColorNo',
                        windowTittle: 'LabDip List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Order found.");
            }
        });


    }
    //End Labdip
    ///*--------Pick RS-------------
    $("#btnPickRSNo").click(function () {


        var oRouteSheet = {
            RouteSheetNo:"",
            LabDipDetailID:_nLabDipDetailID
        };

        GetsRSs(oRouteSheet);
    });

    $("#txtRSNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRSNo=$.trim($("#txtRSNo").val());

            var oRouteSheet = {
                RouteSheetNo:sRSNo,
                LabDipDetailID:_nLabDipDetailID
            };
            GetsRSs(oRouteSheet);
        }
        else if(nkeyCode==8){
            $("#txtRSNo").val("");

        }
    });
    function GetsRSs(oRouteSheet){

        var oRouteSheetCombineDetails= $('#tblRouteSheetCombineDetail').datagrid('getSelected');
        //if (oRouteSheetCombineDetails==null || oRouteSheetCombineDetails.length<=0) {
        //    alert("No checked item found to print.");
        //    return false;
        //}
        debugger
        var Ids="";
        if ( oRouteSheetCombineDetails!=null)
        {
            if ( oRouteSheetCombineDetails.length>0)
            {
                for(var i=0;i<oRouteSheetCombineDetails.length;i++){
                    Ids+=oRouteSheetCombineDetails[i].RouteSheetID+",";
                }
                Ids=Ids.substring(0,Ids.length-1);
            }
        }
        oRouteSheet.ErrorMessage=Ids;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheetCombine",
            ActionName: "GetRoutesheets",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "Dye line No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty(LBS)", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "QtyKg", title: "Qty(KG)", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "TtlLiquire", title: "Liquire", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "TtlCotton", title: "TtlCotton", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn", width: 120, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRSPicker',
                        winclass:'clsRSPicker',
                        winwidth: 550,
                        winheight: 460,
                        tableid: 'tblRSPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'RouteSheetNo',
                        windowTittle: 'Dye line List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Order found.");
            }
        });


    }
    ///-----End--GetsRS--

    //Order No
    $("#btnPickOrderNo").click(function () {

        if (parseInt($("#cboOrderType").val())<=0 ) {

            alert("Please Select Order Type.");
            $('#cboOrderType').focus();
            $('#cboOrderType').removeClass("errorFieldBorder");
            return;
        }

        var oRouteSheetDO = {
            OrderTypeInt:$('#cboOrderType').val(),
            OrderNo:$('#txtOrderNo').val(),
            LabDipDetailID:_nLabDipDetailID
        };

        GetOrders(oRouteSheetDO);
    });

    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNo").val());
            if (parseInt($("#cboOrderType").val())<=0 ) {

                alert("Please Select Order Type.");
                $('#cboOrderType').focus();
                $('#cboOrderType').removeClass("errorFieldBorder");
                return;
            }

            var oRouteSheetDO = {
                OrderTypeInt:$('#cboOrderType').val(),
                OrderNo:sorderNo,
                LabDipDetailID:_nLabDipDetailID
            };
            GetOrders(oRouteSheetDO);
        }
        else if(nkeyCode==8){
            $("#txtOrderNo").val("");

        }
    });
    function GetOrders(oRouteSheetDO){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetDO,
            ControllerName: "RouteSheet",
            ActionName: "GetsRouteSheetDO",
            IsWinClose: false
        };
        //$("#progressbar").progressbar({ value: 0 });
        //$("#progressbarParent").show();
        $.icsDataGets(obj, function (response) {
            //clearInterval(intervalID);
            //$("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DyeingOrderDetailID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderQty", title: "OrderQty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_Pro", title: "Prod Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_RS", title: "Yet To Pro", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LabdipNo", title: "LabdipNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ShadeSt", title: "Shade", width: 20, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn", width: 120, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 800,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();


        if (oPickerobj.winid == 'winLabDipPicker')
        {
            if (oreturnObj != null && oreturnObj.LabDipDetailID > 0)
            {
                $('#txtColorNo').val(oreturnObj.ColorNo);
                //$('#txtColorName').val(oreturnObj.ColorName);
                $('#txtLabdipNo').val(oreturnObj.LabdipNo);
                GetRoutesheets( oreturnObj.LabDipDetailID)
            }
            else{
                alert("Data Not Found.");
                return;
            }

        }


        else if (oPickerobj.winid == 'winRSPicker')
        {
            if (oreturnobjs.length > 0)
            {
                debugger;
                for (i=0; i<oreturnobjs.length;i++)
                {
                    $('#tblRouteSheetCombineDetail').datagrid('appendRow', oreturnobjs[i]);
                }
                endEditing();
                RefreshSummary();
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winOrderPicker')
        {
            if (oreturnObj != null && oreturnObj.DyeingOrderDetailID > 0)
            {
                _oRouteSheetDO= oreturnObj;
                $('#txtOrderNo').val(oreturnObj.OrderNo);
                $('#txtOrderQty').val(formatPrice(oreturnObj.Qty_RS));
                $('#txtOrderQtyTwo').val(formatPrice(oreturnObj.Qty_RSKG));
                _nProductID= oreturnObj.ProductID;
                $('#txtProduct').val(oreturnObj.ProductName);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winLotPicker')
        {
            if(oreturnObj !=null  && oreturnObj.LotID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtLot').val(oreturnObj.LotNo);
                _nLotID= oreturnObj.LotID;
            }
            else{
                alert("Please select lot.");
            }
        }
        else if (oPickerobj.winid == 'winMachinePicker')
        {
            debugger;
            if(oreturnObj !=null  && oreturnObj.MachineID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtMachine').val(oreturnObj.Name);
                _nMachineID= oreturnObj.MachineID;
                _nLocationID=oreturnObj.LocationID;
            }
            else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if(oreturnObj !=null  && oreturnObj.ProductID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtProduct').val(oreturnObj.ProductNameCode);
                _nProductID= oreturnObj.ProductID;
                _nLotID=0;
                $("#txtLot").val("");

            }
            else{
                alert("Please select product.");
            }
        }
    }

    $("#txtRSCount").keyup(function (e) {
        CalculateRS();
    });
    function CalculateRS(){

        var nOrderQty= icsRemoveComma($("#txtOrderQty").val());
        var nOrderQtyTwo= icsRemoveComma($("#txtOrderQtyTwo").val());
        var nRSCount= icsRemoveComma($("#txtRSCount").val());
        if(nOrderQty<=0)
        {
            alert("Please, first pick order");
            return;
        }
        if(nRSCount<=0)
        {
            nRSCount=1;
        }
        if(!isNaN(nOrderQty) && !isNaN(nRSCount)){
            $("#txtQty").val(formatPrice(parseFloat(nOrderQty) / parseFloat(nRSCount)));
        }
        else{
            $("#txtQty").val("0.00");
        }

        if(!isNaN(nOrderQtyTwo) && !isNaN(nRSCount)){
            $("#txtQtyTwo").val(formatPrice(parseFloat(nOrderQtyTwo) / parseFloat(nRSCount)));
        }
        else{
            $("#txtQtyTwo").val("0.00");
        }


    }
    function GetRoutesheets(nLabDipDetailID)

    {
        var oRouteSheet={LabDipDetailID:nLabDipDetailID}

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/RouteSheetCombine/GetRoutesheets",
            traditional: true,
            data:  JSON.stringify(oRouteSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oRouteSheetCombineDetails= jQuery.parseJSON(data);
                if (oRouteSheetCombineDetails!=null)
                {
                    for (i=0; i<oRouteSheetCombineDetails.length;i++)
                    {
                        $('#tblRouteSheetCombineDetail').datagrid('appendRow', oRouteSheetCombineDetails);
                    }
                    endEditing();
                    RefreshSummary();
                }
                else
                {
                    alert("Data not found");
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });

    }
    function RefreshObject()
    {
        var oRouteSheetCombineDetails=$('#tblRouteSheetCombineDetail').datagrid('getRows');
        for (i=0; i<oRouteSheetCombineDetails.length;i++)
        {
            oRouteSheetCombineDetails[i].MachineID=_nMachineID;
            //if(_oRouteSheetDO.DyeingOrderDetailID>0)
            //{

            //    oRouteSheetCombineDetails[i].RouteSheetDOID=_oRouteSheetDO.RouteSheetDOID;
            //    oRouteSheetCombineDetails[i].DyeingOrderDetailID=_oRouteSheetDO.DyeingOrderDetailID;
            //}
        }

        var oRouteSheetCombine={
            RSNo_Combine:$.trim($('#txtRSNo_Combine').val()),
            RouteSheetCombineID: (_oRouteSheetCombine!=null && _oRouteSheetCombine.RouteSheetCombineID>0)? _oRouteSheetCombine.RouteSheetCombineID:0,
            Date: $('#txtDate').datebox('getValue'),
            Note:$.trim($('#txtNote').val()),
            RouteSheetCombineDetails:oRouteSheetCombineDetails
        };
        return oRouteSheetCombine;
    }
    $("#btnSave").click(function (){

        endEditing();
        if(!Validation()) return false;

        debugger;
        var oRouteSheetCombine=RefreshObject();
        $("#btnSave").hide();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/RouteSheetCombine/Save",
            traditional: true,
            data:  JSON.stringify(oRouteSheetCombine),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oRSC= jQuery.parseJSON(data);
                if (oRSC.ErrorMessage=="" || oRSC.ErrorMessage==null)
                {
                    //oRSC.RouteSheetDetail=_oRouteSheetCombine.RouteSheetDetail;
                    RefreshControl(oRSC);
                    _oRouteSheetCombine=oRSC;
                    alert("Data Save Succesfully!!");
                    $('#tabRS').tabs('select',1);

                    var oRouteSheetCombines =sessionStorage.getItem("RouteSheetCombines");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oRouteSheetCombines!=null)
                    {
                        oRouteSheetCombines = jQuery.parseJSON(oRouteSheetCombines);
                    }
                    else
                    {
                        oRouteSheetCombines=[];
                    }
                    if(nIndex!=-1)
                    {
                        oRouteSheetCombines[nIndex]=_oRouteSheetCombine;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oRouteSheetCombines.length);
                        oRouteSheetCombines.push(_oRouteSheetCombine);
                    }
                    sessionStorage.setItem("RouteSheetCombines", JSON.stringify(oRouteSheetCombines));
                    $("#btnSave").show();


                }
                else
                {
                    $("#btnSave").show();
                    alert(oRSC.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });
    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
    $('#btnCloseTwo').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
    $("#btnRemoveDetail").click(function () {

        var oRouteSheetCombineDetail = $("#tblRouteSheetCombineDetail").datagrid("getSelected");
        if (oRouteSheetCombineDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblRouteSheetCombineDetail').datagrid('getRowIndex',oRouteSheetCombineDetail);
        if (!confirm("Confirm to Delete?")) return ;
        if(oRouteSheetCombineDetail.RouteSheetCombineDetailID<=0)
        {
            $('#tblRouteSheetCombineDetail').datagrid('deleteRow',nIndex);
            alert("Delete sucessfully");
        }
        else
        {
            var obj =
           {
               BaseAddress: _sBaseAddress,
               Object: oRouteSheetCombineDetail,
               ControllerName: "RouteSheetCombine",
               ActionName: "DeleteDetail",
               TableId: "tblRouteSheetCombineDetail",
               IsWinClose: false
           };
            $.icsDelete(obj);
        }
        //$("#tblRouteSheetCombineDetail").datagrid("deleteRow", nIndex);
        RefreshSummary();

    });

    function RefreshSummary()
    {
        var oRSCombineDetail = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        var nTotalQty = 0, nTotalQtyKg= 0,nTtlLiquire= 0,nTtlCotton= 0,nQtyDye=0;
        for(var i = 0; i<oRSCombineDetail.length;i++)
        {
            nTotalQty+=parseFloat(oRSCombineDetail[i].Qty);
            nTotalQtyKg+=parseFloat(oRSCombineDetail[i].QtyKg);
            nTtlLiquire+=parseFloat(oRSCombineDetail[i].TtlLiquire);
            nTtlCotton+=parseFloat(oRSCombineDetail[i].TtlCotton);
            nQtyDye+=parseFloat(oRSCombineDetail[i].QtyDye);
        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0)+"Kg";
        //document.getElementById('lblTotalQtyTwo').innerHTML = formatPrice(nTotalQtyKg,0)+"KG";
        document.getElementById('lblTtlLiquire').innerHTML = formatPrice(nTtlLiquire,0);
        document.getElementById('lblTtlCotton').innerHTML = formatPrice(nTtlCotton,0);
        if(nQtyDye>0)
        { document.getElementById('lblQtyDye').innerHTML = "Qty(Dummy):"+formatPrice(nQtyDye,2);}
        else
        {
            document.getElementById('lblQtyDye').innerHTML = formatPrice(nQtyDye,2);
        }
        _oRouteSheetCombine.TotalLiquor=nTtlLiquire;
        _oRouteSheetCombine.TotalQty=nTotalQty;
        $('#txtOrderQty').val(formatPrice(nTotalQty));
        $('#txtOrderQtyTwo').val(formatPrice(nTotalQtyKg))

    }

    //////////// Detail ////////

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblRouteSheetCombineDetail').datagrid('validateRow', editIndex)) {
            $('#tblRouteSheetCombineDetail').datagrid('endEdit', editIndex);
            $('#tblRouteSheetCombineDetail').datagrid('selectRow', editIndex);
            var oESCDetail = $('#tblRouteSheetCombineDetail').datagrid('getSelected');

            debugger;
            $('#tblRouteSheetCombineDetail').datagrid('updateRow', { index: editIndex, row: oESCDetail });

            RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {
        if (editIndex != index) {
            if (endEditing()) {
                $('#tblRouteSheetCombineDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oPRDetail= $('#tblRouteSheetCombineDetail').datagrid('getSelected');
                editIndex = index;
            }
            else {
                $('#tblRouteSheetCombineDetail').datagrid('selectRow', editIndex);
            }
        }
    }


    $('#btnApprove').click(function () {

        debugger;
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oRouteSheetCombine.ApproveBy!=0)
        {
            alert("Already Approve.");
            return;
        }
        if( _oRouteSheetCombine.CheckedBy==0)
        {
            alert("Already yet not verified.");
            return;
        }
        var conf = confirm("Are you sure you want to Approve ?");
        if(conf==false)return;
        _oRouteSheetCombine.Note_Approve= $('#txtComment').val();

        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/RouteSheetCombine/Approve",
            traditional: true,
            data:  JSON.stringify(_oRouteSheetCombine),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oRouteSheetCombine=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oRouteSheetCombines =sessionStorage.getItem("RouteSheetCombines");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oRouteSheetCombines!=null)
                    {
                        oRouteSheetCombines = jQuery.parseJSON(oRouteSheetCombines);
                    }
                    else
                    {
                        oRouteSheetCombines=[];
                    }
                    if(nIndex!=-1)
                    {
                        oRouteSheetCombines[nIndex]=_oRouteSheetCombine;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oRouteSheetCombines.length);
                        oRouteSheetCombines.push(_oRouteSheetCombine);
                    }
                    sessionStorage.setItem("RouteSheetCombines", JSON.stringify(oRouteSheetCombines));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });
    $('#btnUndoApprove').click(function ()
    {
        debugger;
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }

        if( _oRouteSheetCombine.ApproveBy==0)
        {
            alert("Yet Not Approved.");
            return;
        }
        //if( _oRouteSheetCombine.CheckedBy==0)
        //{
        //    alert("Already yet not verified.");
        //    return;
        //}

        var conf = confirm("Are you sure you want to Undo approve?");
        if(conf==false)return;
        _oRouteSheetCombine.Note_Approve= $('#txtComment').val();

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/RouteSheetCombine/UndoApprove",
            traditional: true,
            data:  JSON.stringify(_oRouteSheetCombine),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUDO = jQuery.parseJSON(data);
                if (oDUDO.ErrorMessage=="" || oDUDO.ErrorMessage==null)
                {
                    _oRouteSheetCombine=oDUDO;
                    alert("Data Save Succesfully!!");
                    //if(_oPurchaseOrder.PurchaseOrderDetails!=null)
                    //{
                    //    DynamicRefreshList(_oPurchaseOrder.PurchaseOrderDetails, 'tblPODetail');
                    //}

                    var oRouteSheetCombines =sessionStorage.getItem("RouteSheetCombines");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    debugger;
                    if(oRouteSheetCombines!=null)
                    {
                        oRouteSheetCombines = jQuery.parseJSON(oRouteSheetCombines);
                    }
                    else
                    {
                        oRouteSheetCombines=[];
                    }
                    if(nIndex!=-1)
                    {
                        oRouteSheetCombines[nIndex]=_oRouteSheetCombine;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oRouteSheetCombines.length);
                        oRouteSheetCombines.push(_oRouteSheetCombine);
                    }
                    sessionStorage.setItem("RouteSheetCombines", JSON.stringify(oRouteSheetCombines));
                    window.location.href = _sBackLink;
                }
                else
                {
                    alert(oDUDO.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    $('#btnPrint').click(function (e)
    {
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheetCombine?nId="+_oRouteSheetCombine.RouteSheetCombineID+"&nRSID=0&bIsCombine=true&nts="+tsv, "_blank");

    });
    $('#btnPrintTwo').click(function (e)
    {
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheetCombine?nId="+_oRouteSheetCombine.RouteSheetCombineID+"&nRSID=0&bIsCombine=true&nts="+tsv, "_blank");
    });

    $('#btnPrintSingle').click(function (e)
    {
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheetCombine?nId="+_oRouteSheetCombine.RouteSheetCombineID+"&nRSID="+_oRouteSheetCombine.RouteSheetID +"&bIsCombine=false&nts="+tsv, "_blank");

    });
    $('#btnPrintSingleTwo').click(function (e)
    {
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetCombineID <=0 ) { alert("Please select an item from list."); return ; }
        if (_oRouteSheetCombine ==null || _oRouteSheetCombine.RouteSheetID <=0 ) { alert("Please select an item from list."); return ; }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/RouteSheet/PrintRouteSheetCombine?nId="+_oRouteSheetCombine.RouteSheetCombineID+"&nRSID="+_oRouteSheetCombine.RouteSheetID +"&bIsCombine=false&nts="+tsv, "_blank");

    });
    $("#btnRefreshRSDO").click(function () {

        endEditing();
    });
    $('#btnRSCreate').click(function (e)
    {
        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        for(var i = 0; i<oRSCombineDetails.length;i++)
        {
            if(oRSCombineDetails[i].RouteSheetID>0)
            {
                alert("Please,Dye line already create, If you want to change it, first remove it!"); return false;
            }
        }


        debugger;
        DynamicRefreshList([], 'tblRouteSheetCombineDetail');
        if(_oRouteSheetDO==null)
        {
            alert("Please, Pick a order ");
            return false;
        }
        var nRSCount=parseFloat(icsRemoveComma($('#txtRSCount').val()));
        if(nRSCount==null || nRSCount<=0)
        {
            alert("Please, entry Count ");
            return false;
        }
        $('#tblRouteSheetCombineDetail').empty();
        MapObject(nRSCount);

    });
    $('#btnAddOne').click(function (e)
    {

        if(_oRouteSheetDO==null)
        {
            alert("Please, Pick a order ");
            return false;
        }
        var nRSCount=1;
        MapObject(nRSCount);
    });
    function MapObject(nRSCount)
    {

        debugger;
        var oRSCD=null;



        for(var i=0; i<nRSCount;i++)
        {
            oRSCD={

                RouteSheetCombineDetailID : 0,
                RouteSheetCombineID  : 0,
                RouteSheetID : 0,
                ProductionScheduleDetailID : 0,
                OrderNo : _oRouteSheetDO.OrderNo,
                OrderType : _oRouteSheetDO.OrderTypeInt,
                ProductName : _oRouteSheetDO.ProductName,
                LabdipNo:_oRouteSheetDO.LabdipNo,
                ColorName:_oRouteSheetDO.ColorName,
                ColorNo:_oRouteSheetDO.ColorNo,
                LabDipDetailID:_oRouteSheetDO.LabDipDetailID,
                DyeingOrderDetailID:_oRouteSheetDO.DyeingOrderDetailID,
                Qty :  parseFloat(icsRemoveComma($('#txtQty').val())),
                QtyKg:parseFloat(icsRemoveComma($('#txtQtyTwo').val())),
                PTUID :_oRouteSheetDO.PTUID,
                MachineID: _nMachineID,
                ProductID_Raw: _nProductID,
                LotID: _nLotID,
                RSState : 0,
                LocationID: $('#cboLocation').val(),
                TtlCotton : parseFloat(icsRemoveComma($('#txtTtlLiquire_Cotton').val())),
                TtlLiquire: parseFloat(icsRemoveComma($('#txtTtlLiquire').val())),
                QtyDye : parseFloat(icsRemoveComma($('#txtQtyDye').val())),
                LotNo: $('#txtLot').val(),
                MachineName: $('#txtMachine').val(),
                ProductName: $('#txtProduct').val(),
                MachineName: $('#txtMachine').val()
            };
            $('#tblRouteSheetCombineDetail').datagrid('appendRow',oRSCD);
            //nQty= parseFloat(nQty)+parseFloat(oPSDs[i].ProductionQty);
            //oRSCDs.push(oRSCD);

        }
        RefreshSummary();
    }
    $('#btnUpdateAll').click(function (e)
    {
        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        var nSelectedIndex=0, nTotalQty = 0, nTotalQtyKg= 0;nTtlLiquire= 0;nTtlCotton= 0;

        for (i = 0; i < oRSCombineDetails.length; ++i)
        {
            oRSCombineDetails[i].MachineID= _nMachineID;
            oRSCombineDetails[i].ProductID_Raw= _nProductID;
            oRSCombineDetails[i].LotID= _nLotID;
            oRSCombineDetails[i].LocationID= $('#cboLocation').val();
            oRSCombineDetails[i].TtlCotton = parseFloat(icsRemoveComma($('#txtTtlLiquire_Cotton').val()));
            oRSCombineDetails[i].TtlLiquire= parseFloat(icsRemoveComma($('#txtTtlLiquire').val()));
            oRSCombineDetails[i].QtyDye= parseFloat(icsRemoveComma($('#txtQtyDye').val()));
            oRSCombineDetails[i].LotNo= $('#txtLot').val();
            oRSCombineDetails[i].MachineName= $('#txtMachine').val();
            oRSCombineDetails[i].ProductName_Raw= $('#txtProduct').val();

            nSelectedIndex = $('#tblRouteSheetCombineDetail').datagrid('getRowIndex', oRSCombineDetails[i]);
            $('#tblRouteSheetCombineDetail').datagrid('updateRow', { index:  nSelectedIndex, row: oRSCombineDetails[i] });;
        }
        RefreshSummary();
    });

    $('#btnUpdate').click(function (e)
    {
        var oRouteSheetCombineDetail = $("#tblRouteSheetCombineDetail").datagrid("getSelected");
        if (oRouteSheetCombineDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblRouteSheetCombineDetail').datagrid('getRowIndex',oRouteSheetCombineDetail);

        oRouteSheetCombineDetail.MachineID= _nMachineID;
        oRouteSheetCombineDetail.ProductID_Raw= _nProductID;
        oRouteSheetCombineDetail.LotID= _nLotID;
        oRouteSheetCombineDetail.LocationID= $('#cboLocation').val();
        oRouteSheetCombineDetail.TtlCotton = parseFloat(icsRemoveComma($('#txtTtlLiquire_Cotton').val()));
        oRouteSheetCombineDetail.TtlLiquire= parseFloat(icsRemoveComma($('#txtTtlLiquire').val()));
        oRouteSheetCombineDetail.QtyDye= parseFloat(icsRemoveComma($('#txtQtyDye').val()));
        oRouteSheetCombineDetail.LotNo= $('#txtLot').val();
        oRouteSheetCombineDetail.MachineName= $('#txtMachine').val();
        oRouteSheetCombineDetail.ProductName_Raw= $('#txtProduct').val();

        $('#tblRouteSheetCombineDetail').datagrid('updateRow', { index:  nIndex, row:oRouteSheetCombineDetail });;
        RefreshSummary();
    });
    $("#btnResetProduct").click(function () {
        _nProductID=0;
        _nLotID=0;
        $("#txtProduct,#txtLot").val("");
    });

    $("#btnPickProduct").click(function () {

        var sProductName=$.trim($("#txtProduct").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        GetProducts(sProductName);
    });

    $("#txtProduct").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }
            GetProducts(sProductName);
        }
        else if(nkeyCode==8){
            _nProductID=0;
            _nLotID=0;
            $("#txtProduct,#txtLot").val("");
        }
    });

    function GetProducts(sProductName){

        var oProduct = {
            BUID:sessionStorage.getItem("BUID"),
            ProductName:sProductName,
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Product",
            ActionName: "SearchByProductBUWise",
            IsWinClose: false
        };
        //$("#progressbar").progressbar({ value: 0 });
        //$("#progressbarParent").show();
        $.icsDataGets(obj, function (response) {
            //clearInterval(intervalID);
            //$("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass:'clsProductPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }
    $("#btnResetLot").click(function () {
        _nLotID=0;
        $("#txtLot").val("");
    });

    $("#btnPickLot").click(function () {
        if(!ValidationLot()) return false;
        var sLotNo=$.trim($("#txtLot").val());
        //  if(sLotNo==""){ alert("Type lot no to search."); return false; }
        GetLots(sLotNo);
    });

    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(!ValidationLot()) return false;
            var sLotNo=$.trim($("#txtLot").val());
            if(sLotNo==""){ alert("Type lot no to search."); return false; }
            GetLots(sLotNo);
        }
        else if(nkeyCode==8){
            _nLotID=0;
            $("#txtLot").val("");
        }
    });
    function ValidationLot(){

        if($('#cboStore').val()<=0){
            $('#cboStore').focus();
            $('#cboStore').addClass("errorFieldBorder");
            alert('Select store.');
            return false;
        }
        else{
            $('#cboStore').removeClass("errorFieldBorder");
        }

        if($('#cboLocation').val()<=0){
            $('#cboLocation').focus();
            $('#cboLocation').addClass("errorFieldBorder");
            alert('Select store.');
            return false;
        }
        else{
            $('#cboLocation').removeClass("errorFieldBorder");
        }

        if(_nProductID<=0){
            $('#txtProduct').focus();
            $('#txtProduct').addClass("errorFieldBorder");
            alert('No raw product found.');
            return false;
        }
        else{
            $('#txtProduct').removeClass("errorFieldBorder");
        }
        return true;
    }
    function GetLots(sLotNo){

        var oLot = {
            ProductID:_nProductID,
            LotNo:sLotNo,
            WorkingUnitID: $('#cboStore').val()
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLot,
            ControllerName: "Lot",
            ActionName: "GetsLot",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "Lot No", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Balance", title: "Qty", width: 80, align: "right", formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "MUName", title: "Unit", width: 70, align: "left"};tblColums.push(oColumn);
                    oColumn = { field: "ProductNameCode", title: "Name", width: 180, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "WorkingUnitName", title: "Store", width: 180, align: "left" };tblColums.push(oColumn);


                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No lot found.");
            }
        });


    }
    $("#btnResetMachine").click(function () {

        $("#txtMachine").val("");
        _nMachineID=0;
    });

    $("#btnPickMachine").click(function () {

        var sMachineName=$.trim($("#txtMachine").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachines(sMachineName);
    });

    $("#txtMachine").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachine").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachines(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachine").val("");
            _nMachineID=0;
        }
    });

    function GetMachines(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem("BUID"),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "DUPSchedule",
            ActionName: "GetsMachine",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].MachineID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MachineTypeName", title: "Type", width: 70, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Capacity", title: "Capacity", width: 60, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winMachinePicker',
                        winclass:'clsMachinePicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });


    }

    /*---------------- Dyeing Soution --------------*/
    $("#btnSaveDetail").click(function (){
        debugger;
        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        if(oRSCombineDetails==null || oRSCombineDetails.length<=0){
            alert("There is no dye line, Save first ."); return false;
        }
        if(_oRouteSheetCombine==null ||_oRouteSheetCombine.RouteSheetCombineID<=0){
            alert("There is no dye line, Save first ."+ _oRouteSheetCombine.RouteSheetCombineID); return false;
        }



        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress+ '/RouteSheetCombine/UpdateDetail',
            traditional: true,
            data:  JSON.stringify(_oRouteSheetCombine),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oRSD = jQuery.parseJSON(data);
                if (oRSD.ErrorMessage==""|| oRSD.ErrorMessage==null)
                {
                    var oTree=[];
                    if(oRSD.RouteSheetDetailID>0)
                    {
                        alert("Save Successfully")
                        _oRouteSheetCombine.RouteSheetDetail=oRSD;
                        oTree=[oRSD];
                        LoadTreeGrid(oTree);

                    }
                    else{
                        alert("Unable to Save"+oRSD.ErrorMessage)
                    }


                }
                else
                {
                    alert(oRSD.ErrorMessage);
                    return;
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });
    $("#btnResetDyeingSolution").click(function () {

        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        if(oRSCombineDetails==null || oRSCombineDetails.length<=0){
            alert("There is no dye line, Save first ."); return false;
        }
        if(_oRouteSheetCombine==null ||_oRouteSheetCombine.RouteSheetCombineID<=0){
            alert("There is no dye line, Save first ."+ _oRouteSheetCombine.RouteSheetCombineID); return false;
        }
        $("#txtDyeingSolution").val("");
    });

    $("#btnPickDyeingSolution").click(function () {

        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        if(oRSCombineDetails==null || oRSCombineDetails.length<=0){
            alert("There is no dye line, Save first ."); return false;
        }
        if( _oRouteSheetCombine.ApproveBy!=0){
            alert("Please,Already approved. you can not change it."); return false;
        }
        var sName=$.trim($("#txtDyeingSolution").val());
        GetDyeingSolutions(sName);
    });

    $("#txtDyeingSolution").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
            if(oRSCombineDetails==null || oRSCombineDetails.length<=0){
                alert("There is no dye line, Save first ."); return false;
            }
            if( _oRouteSheetCombine.ApproveBy!=0){
                alert("Please,Already approved. you can not change it."); return false;
            }
            var sName=$.trim($("#txtDyeingSolution").val());
            if(sName==""){ alert("Type solution name to search."); return false; }
            GetDyeingSolutions(sName);
        }
        else if(nkeyCode==8){
            $("#txtDyeingSolution").val("");
        }
    });

    function GetDyeingSolutions(sName){

        var oDyeingSolution = {
            Name:sName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDyeingSolution,
            ControllerName: "DyeingSolutiontemplate",
            ActionName: "GetsDyeingSolution",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DyeingSolutionID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Name", title: "Solution Name", width: 330, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winDyeingSolutionPicker',
                        winclass:'clsDyeingSolutionPicker',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblDyeingSolutionPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Solution List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDyeingSolutionPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No solution found.");
            }
        });


    }

    function IntializeDyeingSolutionPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            DyeingSolutionSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                DyeingSolutionSelect(oPickerobj);
            }
        });
    }

    function DyeingSolutionSelect(oPickerobj){
        if(!confirm('Are you sure to add this soution.'));

        var oDyeingSolution = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winDyeingSolutionPicker')
        {
            if(oDyeingSolution !=null  && oDyeingSolution.DyeingSolutionID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();

                var oRouteSheetCombine={
                    RouteSheetCombineID:_oRouteSheetCombine.RouteSheetCombineID,
                    Params:oDyeingSolution.DyeingSolutionID
                };

                var obj = {
                    BaseAddress: _sBaseAddress,
                    Object: oRouteSheetCombine,
                    ObjectId: 0,
                    ControllerName: "RouteSheetCombine",
                    ActionName: "IUDTemplate",
                    TableId: "",
                    IsWinClose: false,
                    Message: "Save Successfully."// (oRouteSheetDetail.RouteSheetDetailID>0)?"Update Successfully." : "Save Successfully."
                };
                $.icsSave(obj, function (response) {
                    if (response.status && response.obj != null) {
                        debugger
                        if (response.obj.RouteSheetDetailID > 0) {
                            _oRouteSheetDetail=response.obj;
                            LoadTreeGrid([response.obj])
                        }
                    }
                });
            }
            else{
                alert("Please select solution.");
            }
        }
        else if (oPickerobj.winid == 'winRouteSheetFromPicker')
        {
            if(oDyeingSolution !=null  && oDyeingSolution.RouteSheetID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();


                var oRouteSheetCombine={
                    RouteSheetCombineID:_oRouteSheetCombine.RouteSheetCombineID,
                    Params:oDyeingSolution.RouteSheetID
                };

                var obj = {
                    BaseAddress: _sBaseAddress,
                    Object: oRouteSheetCombine,
                    ObjectId: 0,
                    ControllerName: "RouteSheetCombine",
                    ActionName: "IUDTemplateeCopyFromRS",
                    TableId: "",
                    IsWinClose: false,
                    Message: "Save Successfully."// (oRouteSheetDetail.RouteSheetDetailID>0)?"Update Successfully." : "Save Successfully."
                };
                $.icsSave(obj, function (response) {
                    if (response.status && response.obj != null) {
                        debugger

                        if (response.obj.RouteSheetDetailID > 0) {
                            _oRouteSheetDetail=response.obj;
                            LoadTreeGrid([response.obj])
                        }
                    }
                });
            }
            else{
                alert("Please select solution.");
            }
        }
    }

    function LoadTreeGrid(oTree){
        var data= oTree;
        data={"total":""+data.length+"","rows":data};
        $('#tblTreeGridProcess').treegrid('loadData',data);
    }
    /*---------------- Templete  As Route Sheet Detail--------------*/

    function GetDyeingProcess(nIndex){
        var oDyeingSolution = {
            Name:""
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oDyeingSolution,
            ControllerName: "DyeingSolutiontemplate",
            ActionName: "GetsDyeingProcess",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                debugger;
                if (response.objs[0].DyeingSolutionID > 0) {
                    $("#cboProcess").icsLoadCombo({
                        List: response.objs,
                        OptionValue: "DyeingSolutionID",
                        DisplayText: "Name",
                        InitialValue:""
                    });
                    if(nIndex>0)
                        $("#cboProcess").val(nIndex);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No solution found.");
            }
        });
    }

    function ResetTemplet(bIsSearch){

        _oRSDRoot=null;
        _oRSD=null;
        _nProcessID = 0;
        if($('#chkDyeChemical').is(':checked')){
            $('.templet-dc').show();
            $('.templet').hide();
        }
        else{

            $('.templet').show();
            $('.templet-dc').hide();
            if(bIsSearch)
                GetDyeingProcess(0);
        }

        $("#cboProcess").val(0);
        $('#chkForCotton').prop('checked',false);
        $('winTemplet .reset-text').val("");
    }

    function ValidationRouteSheetDetail()
    {

        if($('#chkDyeChemical').is(':checked')){

            if(_nProcessID<=0){
                $('#txtProduct-DS').focus();
                $('#txtProduct-DS').addClass("errorFieldBorder");
                alert('Product required.');
                return false;
            }
            else{
                $('#txtProduct-DS').removeClass("errorFieldBorder");
            }

            if(parseFloat($('#txtGL').val())<=0 && parseFloat($('#txtPercentage').val())<=0){
                $('#txtGL').focus();
                $('#txtGL').addClass("errorFieldBorder");
                alert('GL/ Percentage required.');
                return false;
            }
            else{
                $('#txtGL').removeClass("errorFieldBorder");
            }

            //if(parseFloat(icsRemoveComma($('#txtPercentage').val()))<=0){
            //    $('#txtPercentage').focus();
            //    $('#txtPercentage').addClass("errorFieldBorder");
            //    alert('Percentage required.');
            //    return false;
            //}
            //else{
            //    $('#txtPercentage').removeClass("errorFieldBorder");
            //}
        }
        else{
            if($('#cboProcess').val()<=0){
                $('#cboProcess').focus();
                $('#cboProcess').addClass("errorFieldBorder");
                alert('Please select process.');
                return false;
            }
            else{
                $('#cboProcess').removeClass("errorFieldBorder");
            }
            if($.trim($('#txtTempTime').val())==""){
                $('#txtTempTime').focus();
                $('#txtTempTime').addClass("errorFieldBorder");
                alert('Temp & time required.');
                return false;
            }
            else{
                $('#txtTempTime').removeClass("errorFieldBorder");
            }
        }


        return true;
    }

    function RefreshObjectRouteSheetDetail(){


        debugger;
        var bIsDC=$('#chkDyeChemical').is(':checked');

        var oRSD={
            RouteSheetDetailID : (_oRSD==null || _oRSD.RouteSheetDetailID<=0)? 0 : _oRSD.RouteSheetDetailID,
            RouteSheetID : _oRouteSheetCombine.RouteSheetID,
            ProcessID : (bIsDC)? _nProcessID : $('#cboProcess').val(),
            ParentID : (_oRSD==null || _oRSD.RouteSheetDetailID<=0)? _oRSDRoot.RouteSheetDetailID : _oRSD.ParentID,
            IsDyesChemical : (_oRSD==null || _oRSD.RouteSheetDetailID<=0)?  bIsDC  : _oRSD.IsDyesChemical,
            TempTime : $.trim($('#txtTempTime').val()),
            GL : (bIsDC)?parseFloat($('#txtGL').val()):0,
            Percentage : (bIsDC)?parseFloat($('#txtPercentage').val()):0,
            DAdjustment : (bIsDC)?parseFloat($('#txtAdjustment').val()):0,
            Note : $.trim($('#txtNoteTemplet').val()),
            ForCotton : $('#chkForCotton').is(':checked'),
        };
        return oRSD;

    }

    function SaveRouteSheetDetail(oRSD){
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRSD,
            ObjectId: oRSD.RouteSheetDetailID,
            ControllerName: "RouteSheet",
            ActionName: "SaveDetail",
            TableId: "",
            IsWinClose: true,
            Message: "Save sucessfully."
        };
        $.icsSave(obj, function (response) {
            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetDetailID > 0) {
                    if(oRSD.RouteSheetDetailID>0){
                        response.obj.children=oRSD.children;
                        $('#tblTreeGridProcess').treegrid('update',{ id: oRSD.RouteSheetDetailID, row: response.obj });
                    }
                    else{
                        $('#tblTreeGridProcess').treegrid('append',{ parent: response.obj.ParentID, data: [response.obj] });
                    }
                }
            }
        });
    }

    $("#btnAddTemplet").click(function (e) {
        if(_oRouteSheetCombine==null || _oRouteSheetCombine.RouteSheetID<=0){
            alert("Save route sheet first."); return false;
        }
        var oRouteSheetDetail= $('#tblTreeGridProcess').datagrid('getSelected');
        if (oRouteSheetDetail == null || oRouteSheetDetail.RouteSheetDetailID <= 0) { alert("Please select an item from list."); return; }
        if (oRouteSheetDetail.IsDyesChemical) { alert("Your Selected item is Dyes or chemical. Please select process to add."); return; }
        ResetTemplet(($('#chkDyeChemical').is(':checked'))?false:true);
        _oRSDRoot= $('#tblTreeGridProcess').datagrid('getSelected');
        if(_oRSDRoot==null || _oRSDRoot.RouteSheetDetailID<=0){ alert("Please select an item from list."); return false; }
        $("#winTemplet").icsWindow("open", (($('#chkDyeChemical').is(':checked'))? "Add Dyes/ Chemical" : "Add Process"));
    });

    $('#btnEditTemplet').click(function (e)
    {
        if(_oRouteSheetCombine==null || _oRouteSheetCombine.RouteSheetID<=0){
            alert("Save route sheet first."); return false;
        }
        var oRSD= $('#tblTreeGridProcess').datagrid('getSelected');
        if(oRSD==null || oRSD.RouteSheetDetailID<=0){ alert("Please select an item from list."); return false; }
        $('#chkDyeChemical').prop('checked',oRSD.IsDyesChemical);
        ResetTemplet(false);

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRSD,
            ControllerName: "RouteSheet",
            ActionName: "GetRouteSheetDetail",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetDetailID > 0) {
                    _oRSD=response.obj;
                    if(response.obj.IsDyesChemical){
                        $('#chkDyeChemical').prop('checked',true);
                        _nProcessID=response.obj.ProcessID;
                        $("#txtProduct-DS").val(response.obj.ProcessName);
                        $("#txtGL").val(response.obj.GL);
                        $("#txtPercentage").val(response.obj.Percentage);
                        $("#txtAdjustment").val(response.obj.DAdjustment);
                        $('#chkForCotton').prop('checked',response.obj.ForCotton);
                    }
                    else{
                        debugger;
                        $('#chkDyeChemical').prop('checked',false);
                        GetDyeingProcess(response.obj.ProcessID)
                        $("#txtTempTime").val(response.obj.TempTime);
                    }

                    $('#txtNoteTemplet').val(response.obj.Note)
                    $("#winTemplet").icsWindow("open", "Edit Dyeing Solution Detail");
                }
                else { alert(response.obj.ErrorMessage); }
            }
        });


    });

    $('#btnDeleteTemplet').click(function (e)
    {
        var oRSD=$('#tblTreeGridProcess').datagrid('getSelected');
        if (oRSD==null || oRSD.RouteSheetDetailID<=0) { alert('Please select an item from list.'); return false;}
        if(oRSD.children!=null && oRSD.children.length>0){
            alert("Please delete child element first."); return false;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRSD,
            ControllerName: "RouteSheet",
            ActionName: "DeleteDetail",
            TableId: "",
            IsWinClose: false
        };
        $.icsDelete(obj, function (response) {
            if (response.status && response.Message =='deleted') {
                $('#tblTreeGridProcess').treegrid('remove',oRSD.RouteSheetDetailID);

                $('#tblTreeGridProcess').treegrid('select',oRSD.ParentID);
                var oParent=  $('#tblTreeGridProcess').datagrid('getSelected');
                if(oParent!=null){
                    var oChildrens=[];
                    for(var i=0;i<oParent.children.length;i++){

                        if(oParent.children[i].RouteSheetDetailID!=oRSD.RouteSheetDetailID){
                            oChildrens.push(oParent.children[i]);
                        }
                    }
                    oParent.children=oChildrens;
                    $('#tblTreeGridProcess').treegrid('update',{	id: oParent.RouteSheetDetailID, row: oParent });
                }
            }
        });
    });

    $("#btnSaveTemplet").click(function (e) {

        if (!ValidationRouteSheetDetail()) return false;
        var oRSD=RefreshObjectRouteSheetDetail();
        SaveRouteSheetDetail(oRSD);
    });

    $("#btnCloseTemplet").click(function (e) {
        $("#winTemplet").icsWindow("close");
    });


    $("#btnResetProduct-DS").click(function () {

        $("#txtProduct-DS").val("");
        _nProcessID=0;
    });

    $("#btnPickProduct-DS").click(function () {

        var sProductName=$.trim($("#txtProduct-DS").val());
        if(sProductName==""){ alert("Type product name to search."); return false; }
        var oProduct = {
            ProductName:sProductName,
            ProductCategoryID:$("#cboProductType").val()
        };
        GetDyesChemical(oProduct);
    });

    $("#txtProduct-DS").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sProductName=$.trim($("#txtProduct-DS").val());
            if(sProductName==""){ alert("Type product name to search."); return false; }

            var oProduct = {
                BUID:sessionStorage.getItem("BUID"),
                ProductName:sProductName,
                ProductCategoryID:$("#cboProductType").val()
            };
            GetDyesChemical(oProduct);
        }
        else if(nkeyCode==8){
            $("#txtProduct-DS").val("");
            _nProcessID=0;
        }
    });

    function GetDyesChemical(oProduct){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "RouteSheet",
            ActionName: "GetProducts",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winDyesChemicalPicker',
                        winclass:'clsDyesChemicalPicker',
                        winwidth: 520,
                        winheight: 460,
                        tableid: 'tblDyesChemicalPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'ProductName',
                        windowTittle: 'DyesChemical List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDyesChemicalPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No dyes chemical found.");
            }
        });


    }

    function IntializeDyesChemicalPickerbutton(oPickerobj)
    {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            DyesChemicalSelect(oPickerobj);
        });
        $(document).find('.' +oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                DyesChemicalSelect(oPickerobj);
            }
        });
    }

    function DyesChemicalSelect(oPickerobj){
        var oProduct = $('#'+oPickerobj.tableid).datagrid('getSelected');
        if (oPickerobj.winid == 'winDyesChemicalPicker')
        {
            if(oProduct !=null  && oProduct.ProductID>0){
                $("#"+oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
                $('#txtProduct-DS').val(oProduct.ProductNameCode);
                _nProcessID= oProduct.ProductID;
            }
            else{
                alert("Please select dyes chemical.");
            }
        }
    }


    $("#txtGL").keyup(function(e){

        if(icsRemoveComma($('#txtGL').val())>0){
            $("#txtPercentage").val(formatPrice(0));
        }
    });

    $("#txtPercentage").keyup(function(e){

        if(icsRemoveComma($('#txtPercentage').val())>0){
            $("#txtGL").val(formatPrice(0));
        }
    });


    /*----------------------- Additional Qty Add----------------*/

    function ResetAdditionalReturn(){
        _oRSD=null;
        _bIsReturn=false;
        $('#txtAdditionalReturnProduct, #txtAdditionalReturnQtyKg, #txtAdditionalReturnQtyGm').val("");
        $('#txtAdditionalReturnQtyKg,#txtAdditionalReturnQtyGm').removeClass("errorFieldBorder");
    }

    function SetAdditionalReturnQty(nQty){

        var nKg=0, mGm=0;
        var nTotalQty = parseFloat(nQty)*1000;
        if(nTotalQty>0)
            nKg= parseInt(nQty);

        mGm= parseFloat(nTotalQty)-parseInt(nKg*1000);

        $('#txtAdditionalReturnQtyKg').val(nKg);
        $('#txtAdditionalReturnQtyGm').val(mGm.toFixed(4));


    }

    function GetRouteSheetDetail(oRSD,stitle){
        var obj =
         {
             BaseAddress: _sBaseAddress,
             Object: oRSD,
             ControllerName: "RouteSheet",
             ActionName: "GetRouteSheetDetail",
             IsWinClose: false
         };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                if (response.obj.RouteSheetDetailID > 0) {

                    if(_bIsReturn){
                        SetAdditionalReturnQty(response.obj.ReturnQty);
                    }
                    else{
                        if(response.obj.AddOneLotID<=0)
                        {
                            SetAdditionalReturnQty(response.obj.AddOneQty);
                        }
                        else if(response.obj.AddTwoLotID<=0)
                        {
                            SetAdditionalReturnQty(response.obj.AddTwoQty);
                        }
                        else if(response.obj.AddThreeLotID<=0)
                        {
                            SetAdditionalReturnQty(response.obj.AddThreeQty);
                        }
                    }

                    _oRSD=response.obj;

                    $('#txtAdditionalReturnProduct').val(response.obj.ProcessName);
                    $("#winAdditionalReturn").icsWindow("open", stitle);

                }
                else { alert(response.obj.ErrorMessage); }
            }
        });
    }

    function ValidationAdditionalReturn(){
        if($('#txtAdditionalReturnQtyKg').val()=='' && $('#txtAdditionalReturnQtyGm').val()==''){
            $('#txtAdditionalReturnQtyKg,#txtAdditionalReturnQtyGm').focus();
            $('#txtAdditionalReturnQtyKg').addClass("errorFieldBorder");
            alert('Please enter quantity.');
            return false;
        }
        else{
            $('#txtAdditionalReturnQtyKg,#txtAdditionalReturnQtyGm').removeClass("errorFieldBorder");
        }
        return true;
    }

    $("#btnAdditional").click(function (e) {
        ResetAdditionalReturn();
        var oRSD= $('#tblTreeGridProcess').datagrid('getSelected');
        if(oRSD==null || oRSD.RouteSheetDetailID<=0){ alert("Please select an item from list."); return false; }
        _bIsReturn=false;
        if(oRSD.TotalQtyLotID<=0){
            alert("Initial dye chemical yet not out."); return false;
        }

        if(oRSD.AddOneLotID<=0)
            GetRouteSheetDetail(oRSD,"First Additional Qty");
        else if(oRSD.AddTwoLotID<=0)
            GetRouteSheetDetail(oRSD,"Second Additional Qty");
        else if(oRSD.AddThreeLotID<=0)
            GetRouteSheetDetail(oRSD,"Third Additional Qty");
        else
            alert("Additional qty fullfiled.");

    });

    $("#btnReturn").click(function (e) {
        ResetAdditionalReturn();
        var oRSD= $('#tblTreeGridProcess').datagrid('getSelected');
        if(oRSD==null || oRSD.RouteSheetDetailID<=0){ alert("Please select an item from list."); return false; }
        _bIsReturn=true;
        if(oRSD.ReturnLotID<=0)
            GetRouteSheetDetail(oRSD,"Return Qty");
        else
            alert("Already disbursed.");

    });


    $("#btnSaveAdditionalReturn").click(function (e) {

        if(!ValidationAdditionalReturn()) return false;

        var nQty= parseFloat(($('#txtAdditionalReturnQtyKg').val()=='')? 0 : $('#txtAdditionalReturnQtyKg').val()) + parseFloat(parseFloat(($('#txtAdditionalReturnQtyGm').val()=='')? 0 : $('#txtAdditionalReturnQtyGm').val())/1000);

        if(_bIsReturn){
            _oRSD.ReturnQty=nQty;
        }
        else{
            if(_oRSD.AddOneLotID<=0)
                _oRSD.AddOneQty=nQty;
            else if(_oRSD.AddTwoLotID<=0)
                _oRSD.AddTwoQty=nQty;
            else if(_oRSD.AddThreeLotID<=0)
                _oRSD.AddTwoQty=nQty;
        }

        SaveRouteSheetDetail(_oRSD);

    });

    $("#btnCloseAdditionalReturn").click(function (e) {
        $("#winAdditionalReturn").icsWindow("close");
    });

    /*------------------------------------------------------*/

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
    $('#btnNew').click(function(e){

        var sBackLink=sessionStorage.getItem('BackLink');
        var nIndex=sessionStorage.getItem('SelectedRowIndex');
        var oRouteSheets= (sessionStorage.getItem('RouteSheets').length>0)? jQuery.parseJSON(sessionStorage.getItem('RouteSheets')):[] ;
        sessionStorage.clear();
        sessionStorage.setItem("BackLink", sBackLink);
        sessionStorage.setItem("SelectedRowIndex", -1);
        sessionStorage.setItem("RouteSheets", JSON.stringify(oRouteSheets));
        ResetControll();
    });

    $('.only-number').keydown(function (e) {

        if ((e.which >= 48 && e.which <= 57) || (e.which >= 96 && e.which <= 105)|| e.which==9 || e.which==38 || e.which==40 || e.which==8 || e.which==37 || e.which==39 || e.which==46) {
            return true;
        }
        else {
            return false
        }
    });


    //Sequence
    $("#btnSequenceConfigure").click(function () {
        var oRSD = $('#tblTreeGridProcess').datagrid('getSelected');
        if (oRSD == null || parseInt(oRSD.RouteSheetDetailID) <= 0) {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex = $('#tblTreeGridProcess').datagrid('getRowIndex', oRSD);
        $("#winRSDequence").icsWindow('open', "Selected parent DST : " + oRSD.text);
        $("#winRSDequence input").val("");
        $("#winRSDequence select").val(0);
        GetChildRSDs(oRSD,'tblDSTSequence');
    });
    function GetChildRSDs(oRSD,tblid) {
        var oTempDST = { ParentID: oRSD.RouteSheetDetailID };
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oTempDST,
            ControllerName: "RouteSheet",
            ActionName: "GetRSDChilds",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            debugger;
            if (response.status && response.obj != null) {
                if (response.obj.ErrorMessage != "" || response.obj.ErrorMessage != null)
                {
                    _oRSD = response.obj;
                    DynamicRefreshList(response.obj.children, tblid);
                    _oRSDs = response.obj.children;
                }
                else { alert(response.obj.ErrorMessage); }
            }
            else { alert("No information found."); }
        });
    }
    function SaveSequence()
    {
        //debugger;
        var oRSD= {
            children :$('#tblDSTSequence').datagrid('getRows')
        };
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/RouteSheet/RefreshMenuSequence",
            traditional: true,
            data:  JSON.stringify(oRSD),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var  oRSD = jQuery.parseJSON(data);
                if (oRSD.DisplayMessage=="" || oRSD.DisplayMessage==null)
                {
                    alert("Data Saved sucessfully");
                    $("#winRSDequence").icsWindow("close");
                    $("#winRSDequence input").val("");
                    $("#winRSDequence select").val(0);
                }
                else {
                    alert(oRSD.DisplayMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }
    $("#btnCloseDSTSequence").click(function () {
        $("#winRSDequence").icsWindow("close");
        $("#winRSDequence input").val("");
        $("#winRSDequence select").val(0);
    });
    function UP()
    {
        debugger;
        var oRSD = $('#tblDSTSequence').datagrid('getSelected');
        if(oRSD==null)
        {
            alert("Please select Item");
            return;
        }
        var SelectedRowIndex=$('#tblDSTSequence').datagrid('getRowIndex',oRSD);
        if(SelectedRowIndex==0)return;
        var oRSDs=$('#tblDSTSequence').datagrid('getRows');
        _oRSDs = [];
        for(var i=0; i<oRSDs.length; i++)
        {
            if(i==(SelectedRowIndex-1))
            {
                _oRSDs[i]=oRSDs[i+1];
            }
            else if(i==SelectedRowIndex)
            {
                _oRSDs[i]=oRSDs[i-1];
            }
            else
            {
                _oRSDs[i]=oRSDs[i];
            }
            _oRSDs[i].Sequence=i+1;
        }
        data = _oRSDs;
        data={"total":""+data.length+"","rows":data};
        $('#tblDSTSequence').datagrid('loadData',data);
        //    MakeMenu();
        var newSelectedRowIndex=SelectedRowIndex-1;
        $('#tblDSTSequence').datagrid('selectRow',newSelectedRowIndex);

    }
    function Down()
    {
        debugger;
        var oRSD = $('#tblDSTSequence').datagrid('getSelected');
        if(oRSD==null)
        {
            alert("Please select a item from list!");
            return;
        }
        var SelectedRowIndex=$('#tblDSTSequence').datagrid('getRowIndex',oRSD);
        if(SelectedRowIndex==(_oRSDs.length-1))return;
        var oRSDs=$('#tblDSTSequence').datagrid('getRows');
        _oRSDs=[];
        for(var i=0; i<oRSDs.length; i++)
        {
            if(i==(SelectedRowIndex+1))
            {
                _oRSDs[i]=oRSDs[i-1];
            }
            else if(i==SelectedRowIndex)
            {
                _oRSDs[i]=oRSDs[i+1];
            }
            else
            {
                _oRSDs[i]=oRSDs[i];
            }
            _oRSDs[i].Sequence=i+1;
        }
        data = _oRSDs;
        data={"total":""+data.length+"","rows":data};
        $('#tblDSTSequence').datagrid('loadData',data);

        var newSelectedRowIndex=SelectedRowIndex+1;
        $('#tblDSTSequence').datagrid('selectRow',newSelectedRowIndex);
    }
    function RefreshSequence()
    {
        var oRSDs = $('#tblDSTSequence').datagrid('getRows');
        if(oRSDs.length>0)
        {
            for(var i = 0;i<oRSDs.length;i++)
            {
                oRSDs[i].Sequence = i+1;
            }
            RefreshListSequence(oRSDs);
        }
    }
    function RefreshListSequence(oRSDs)
    {
        data=oRSDs;
        data={"total":""+data.length+"","rows":data};
        $('#tblDSTSequence').datagrid('loadData',data);
    }
    //end Sequence

    //Gets Labdip Recepi
    $("#btnLabdipRecipe").click(function () {

        debugger;
        if(_oRouteSheetCombine==null ||_oRouteSheetCombine.RouteSheetCombineID<=0){
            alert("There is no dye line, Save first ."+ _oRouteSheetCombine.RouteSheetCombineID); return false;
        }
        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        if(oRSCombineDetails==null || oRSCombineDetails.length<=0){
            alert("There is no dye line, Save first ."); return false;
        }
        var nLabDipDetailID=0;
        var nShade=0;
        var sLabdipNo="";
        var sColorNo="";
        var sColorNameShade="";
        for(var i = 0; i<oRSCombineDetails.length;i++)
        {
            if(_oRouteSheetCombine.RouteSheetID==oRSCombineDetails[i].RouteSheetID)
            {
                nLabDipDetailID=oRSCombineDetails[i].LabDipDetailID;
                nShade=oRSCombineDetails[i].Shade;
                sLabdipNo=oRSCombineDetails[i].LabdipNo;
                sColorNo=oRSCombineDetails[i].ColorNo;
                sColorNameShade=oRSCombineDetails[i].ColorNameShade;
            }
        }

        var oPTU={LabDipDetailID:nLabDipDetailID,Shade: nShade}

        $("#winLabdipRecipe").icsWindow('open',"Labdip No:"+sLabdipNo+ " Color No : " +sColorNo+" Color"+sColorNameShade);
        $("#winLabdipRecipe input").val("");
        $("#winLabdipRecipe select").val(0);
        GetLabdipRecipe(oPTU,'tblLabdipRecipe');
    });
    function GetLabdipRecipe(oPTU,tblid) {

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oPTU,
            ControllerName: "RouteSheet",
            ActionName: "GetLabdipRecipe",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs != null) {
                if (response.objs.length>0 )
                {

                    DynamicRefreshList(response.objs, tblid);
                }
                else { alert(response.obj.ErrorMessage); }
            }
            else { alert("No information found."); }
        });
    }
    $("#btnCloseLabdipRecipe").click(function () {
        $("#winLabdipRecipe").icsWindow("close");
        $("#winLabdipRecipe input").val("");
        $("#winLabdipRecipe select").val(0);
    });

    function RefreshObjectRSDetail_LR(oLabdipRecipe){

        var oRSDTemp= $('#tblTreeGridProcess').datagrid('getSelected');
        if(oRSDTemp==null || oRSDTemp.RouteSheetDetailID<=0){ alert("Please select an item from list."); return false; }
        if( _oRouteSheetCombine.RouteSheetID<=0)
        {
            alert("Please select a valid item."); return false;
        }
        debugger;
        var bIsDC=true;

        var oRSD={
            RouteSheetDetailID : (oRSDTemp==null || oRSDTemp.RouteSheetDetailID<=0)? 0 : oRSDTemp.RouteSheetDetailID,
            RouteSheetID : _oRouteSheetCombine.RouteSheetID,
            ProcessID : oLabdipRecipe.ProductID,
            ParentID : oRSDTemp.RouteSheetDetailID,
            IsDyesChemical :bIsDC,
            TempTime : "",
            GL : (oLabdipRecipe.IsGL)? oLabdipRecipe.Qty: 0,
            Percentage :(oLabdipRecipe.IsGL)? 0: oLabdipRecipe.Qty,
            DAdjustment : 0,
            Note : '',
            ForCotton : false,
        };
        return oRSD;

    }
    $("#btnSaveLabdipRecipe").click(function (e) {

        //if (!ValidationRouteSheetDetail()) return false;
        debugger
        var oLabdipRecipes = $("#tblLabdipRecipe").datagrid('getChecked');
        for(var i=0; i<oLabdipRecipes.length; i++)
        {
            var oRSD=RefreshObjectRSDetail_LR(oLabdipRecipes[i]);
            SaveRouteSheetDetail(oRSD);
        }

    });
    //end Labdip Recepi


    //start Route Sheet Do Start
    $("#btnEditDetail").click(function () {
        debugger;
        endEditingRSDO();
        var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getChecked');
        //var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
        if(oRSCombineDetails==null || oRSCombineDetails.length<=0)
        {
            alert("Please Select  at Least One Item From List."); return false;
        }
        var sRouteSheetIDs = ICS_PropertyConcatation(oRSCombineDetails,'RouteSheetID');
        $("#winRouteSheetDO").icsWindow('open',"Route Sheet DO List");

        GetRouteSheetDOs(sRouteSheetIDs);
    });
    function GetRouteSheetDOs(sRouteSheetIDs)
    {
        var oRouteSheet = {Params:sRouteSheetIDs};
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheetCombine",
            ActionName: "GetRouteSheetDOs",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs != null) {
                if (response.objs.length>0 )
                {
                    DynamicRefreshList(response.objs, 'tblRouteSheetDO');
                }
                else { alert(response.obj.ErrorMessage); }
            }
            else { alert("No information found."); }
        });
    }
    $("#btnCloseRouteSheetDO").click(function () {
        $("#winRouteSheetDO").icsWindow("close");
        $("#winRouteSheetDO input").val("");
        $("#winRouteSheetDO select").val(0);
    });

    $("#btnSaveRouteSheetDO").click(function (e) {
        debugger
        endEditingRSDO();
        var oRouteSheet ={ RouteSheetDOs: $("#tblRouteSheetDO").datagrid('getRows')}
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/RouteSheetCombine/SaveRouteSheetDO",
            traditional: true,
            data:  JSON.stringify(oRouteSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oRouteSheetCombineDetails = jQuery.parseJSON(data);
                if (oRouteSheetCombineDetails.length>0 &&  (oRouteSheetCombineDetails[0].ErrorMessage==null || oRouteSheetCombineDetails[0].ErrorMessage==""))
                {
                    var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getChecked');
                    for(var i = 0;i<oRSCombineDetails.length;i++)
                    {
                        var SelectedRowIndex=$('#tblRouteSheetCombineDetail').datagrid('getRowIndex',oRSCombineDetails[i]);
                        oRSCombineDetails[i].Qty = ICS_FindObject(oRouteSheetCombineDetails,'RouteSheetID',oRSCombineDetails[i].RouteSheetID).Qty;
                        $('#tblRouteSheetCombineDetail').datagrid('updateRow',{index: SelectedRowIndex,row: oRSCombineDetails[i]});
                    }
                    alert("Data Saved successfully");
                    $("#winRouteSheetDO").icsWindow("close");
                }
                else {
                    alert(oRouteSheetCombineDetails[0].ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    var editIndexRSDO = undefined;
    function endEditingRSDO() {
        if (editIndexRSDO == undefined) { return true }
        if ($('#tblRouteSheetDO').datagrid('validateRow', editIndexRSDO)) {
            $('#tblRouteSheetDO').datagrid('endEdit', editIndexRSDO);
            $('#tblRouteSheetDO').datagrid('selectRow', editIndexRSDO);
            var oRSDO = $('#tblRouteSheetDO').datagrid('getSelected');
            debugger;
            if (oRSDO == null) {
                return;
            }
            debugger;
            if (parseFloat(oRSDO.Qty_RSKG) != _nQty_RSKG )
            {
                oRSDO.Qty_RS = (oRSDO.Qty_RSKG / oRSDO.SMUnitValue).toFixed(8); //0.45359237001003542909395360718511
                //oRSDO.AdjValue = parseFloat(oRSDO.AdjQty) * parseFloat((parseFloat(oRSDO.UnitPrice)- parseFloat(oRSDO.AdjRate)))+ parseFloat((parseFloat(oRSDO.Qty)*parseFloat(oRSDO.AdjRate)));
                //oRSDO.MUNameTwo = 'KG'
            }
            else
            {

                oRSDO.Qty_RSKG = (oRSDO.Qty_RS * oRSDO.SMUnitValue).toFixed(8); //0.45359237001003542909395360718511
            }

            $('#tblRouteSheetDO').datagrid('updateRow', { index: editIndexRSDO, row: oRSDO });
            //RefreshRSDO();
            _nQty_RS = 0;
            _nQty_RSKG = 0;
            editIndexRSDO = undefined;
            return true;
        }
        else {
            return false;
        }
    }
    _nQty_RS = 0;
    _nQty_RSKG = 0;

    function onClickRowRSDO(index) {

        if (editIndexRSDO != index) {
            if (endEditingRSDO()) {
                $('#tblRouteSheetDO').datagrid('selectRow', index).datagrid('beginEdit', index);
                var oRSDO= $('#tblRouteSheetDO').datagrid('getSelected');
                _nQty_RS = parseFloat(oRSDO.Qty_RS).toFixed(10);
                _nQty_RSKG = parseFloat(oRSDO.Qty_RSKG).toFixed(8);
                editIndexRSDO = index;
            }
            else {
                $('#tblRouteSheetDO').datagrid('selectRow', editIndexRSDO);
            }
        }
    }
    //end Route Sheet DO


    $("#txtTtlLiquire").keyup(function (e) {
        debugger;
        var keyCode = e.keyCode || e.which;
        //$('#txtRouteSheetNo').removeClass("errorFieldBorder");
        //if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        //else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13)
        {
            var txtTtlLiquire = parseFloat($('#txtTtlLiquire').val());
            var nQty=0;
            var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
            for(var i = 0; i<oRSCombineDetails.length;i++)
            {
                nQty=nQty+parseFloat(oRSCombineDetails[i].Qty);
            }
            for(var i = 0; i<oRSCombineDetails.length;i++)
            {
                if(txtTtlLiquire>=0 && nQty>0)
                {
                    oRSCombineDetails[i].TtlLiquire=(txtTtlLiquire*parseFloat(oRSCombineDetails[i].Qty))/nQty;
                }
            }
            DynamicRefreshList(oRSCombineDetails, 'tblRouteSheetCombineDetail');
            RefreshSummary();
        }

    });
    $("#txtQtyDye").keyup(function (e) {
        debugger;
        var keyCode = e.keyCode || e.which;
        //$('#txtRouteSheetNo').removeClass("errorFieldBorder");
        //if (keyCode == 8) { oRouteSheets = _oRouteSheets; }
        //else{ oRouteSheets = $('#tblRouteSheet').datagrid('getRows'); }
        if (e.keyCode == 13)
        {
            var txtQtyDye = parseFloat($('#txtQtyDye').val());
            var nQty=0;
            var oRSCombineDetails = $('#tblRouteSheetCombineDetail').datagrid('getRows');
            for(var i = 0; i<oRSCombineDetails.length;i++)
            {
                nQty=nQty+parseFloat(oRSCombineDetails[i].Qty);
            }
            for(var i = 0; i<oRSCombineDetails.length;i++)
            {
                if(txtQtyDye>=0 && nQty>0)
                {
                    oRSCombineDetails[i].QtyDye=(txtQtyDye*parseFloat(oRSCombineDetails[i].Qty))/nQty;
                }
            }
            DynamicRefreshList(oRSCombineDetails, 'tblRouteSheetCombineDetail');
            RefreshSummary();
        }

    });
    $("#txtRSNoFrom").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            if(_oRouteSheetCombine==null || _oRouteSheetCombine.RouteSheetCombineID<=0){
                alert("Please, First  Save Batch/Dyeing Card."); return false;
            }
            if( _oRouteSheetCombine.ApproveBy!=0){
                alert("Please,Already approved. you can not change it."); return false;
            }

            var sName=$.trim($("#txtRSNoFrom").val());
            if(sName==""){ alert("Type Batch No."); return false; }
            GetsRSNoFromCopy(sName);
        }
        else if(nkeyCode==8){
            $("#txtRSNoFrom").val("");
        }
    });

    function GetsRSNoFromCopy(sRSNo){
        debugger;
        var oRouteSheet={
            Params:  sRSNo+'~'+ 0+ '~'+  icsdateformat(new Date())+'~'+ icsdateformat(new Date())+'~'+ "" +'~'+ "" + '~'+"" +'~'+ ""+'~'+''+'~'+""+'~'+0+'~'+ 0+ '~'+ ""+'~'+ ""+''
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheet,
            ControllerName: "RouteSheet",
            ActionName: "Gets",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RouteSheetID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "RouteSheetNo", title: "Batch No", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "Order No", width: 130, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "Color Name", width: 200, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winRouteSheetFromPicker',
                        winclass:'clsRouteSheetFromPicker',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblRouteSheetFromPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'RouteSheetNo',
                        windowTittle: 'Batch List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializeDyeingSolutionPickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No solution found.");
            }
        });


    }
</script>