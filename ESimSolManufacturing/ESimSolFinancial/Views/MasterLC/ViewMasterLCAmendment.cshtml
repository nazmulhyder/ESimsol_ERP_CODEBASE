<html>
@{
    ViewBag.title = "Master LC";
}
<body>
    @model ESimSol.BusinessObjects.MasterLC
    <script src="~/Views/CommonModal/CommonListModal.js"></script>
    <script src="~/Views/ProformaInvoice/PIReviseHistory.js"></script>
    <div class="menuMainCollectionTable" ng-app="MasterLCApp" ng-controller="MasterLCController as MLCC" id="divMLC">
        <div style="font-family:Tahoma;text-align:center;height:90%;">
            <section>
                <ul class="nav nav-tabs" style="background:#d6dbdf; color:white;">
                    <li ng-class="{active:MLCC.IsSet(1)}">
                        <a href="" ng-click="MLCC.SetTab(1)" style="color:black;">Master LC</a>
                    </li>
                    <li ng-class="{active:MLCC.IsSet(2)}">
                        <a href="" ng-click="MLCC.SetTab(2)" style="color:black;">Terms & Condition</a>
                    </li>
                </ul>
                <div ng-show="MLCC.IsSet(1)">
                    <fieldset style="width:100%">
                        <legend>Master LC Info :</legend>
                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label"> File No:</label></div>
                            <div class="col-md-3 text-left">
                                <input ng-model="MasterLC.FileNo" class="form-control" disabled />
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">LC No:</label></div>
                            <div class="col-md-3 text-left">
                                <input ng-model="MasterLC.MasterLCNo" class="form-control" ng-disabled="disabled" required />
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Applicant:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group">
                                    <input ng-model="MasterLC.ApplicantName" class="form-control" ng-keydown="SearchKeyDownApplicant($event)" placeholder="Type Applicant & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickApplicant()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>

                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label"> Issue Date:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="MasterLC.MasterLCDateSt"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Receive Date:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="MasterLC.ReceiveDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Beneficiary:</label></div>
                            <div class="col-md-3 text-left">
                                <select class="form-control" ng-model="MasterLC.Beneficiary" ng-options="item.BusinessUnitID as item.Name for item in BusinessUnits"></select>
                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label"> Shipment Date:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="MasterLC.LastDateofShipmentSt"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Expire Date:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="MasterLC.ExpireDateSt"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Issue Bank:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group">
                                    <input ng-model="MasterLC.IssueBankName" class="form-control" placeholder="Type Applicant & Press Enter" ng-keydown="SearchKeyDownIssueBank($event)" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="IssueBank()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label"> Currency:</label></div>
                            <div class="col-md-3 text-left">
                                <select class="form-control" ng-model="MasterLC.CurrencyID" ng-options="item.CurrencyID as item.Symbol for item in Currencies"></select>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Amount:</label></div>
                            <div class="col-md-3 text-right">
                                <input type="text" class="form-control" ng-model="MasterLC.LCValue">

                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Advice Bank:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group">
                                    <input ng-model="MasterLC.AdviceBankName" class="form-control" ng-keydown="SearchKeyDownAdviceBank($event)" placeholder="Type Bank Acccount & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="AdviceBank()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label"> LC Status:</label></div>
                            <div class="col-md-3 text-left">
                                <input ng-model="MasterLC.LCStatusInString" class="form-control" disabled />
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Consignee:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group">
                                    <input ng-model="MasterLC.ConsigneeName" class="form-control" ng-keydown="SearchKeyDownConsignee($event)" placeholder="Type Consignee & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickConsignee()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">Notify Party:</label></div>
                            <div class="col-md-3 text-left">
                                <div class="input-group">
                                    <input ng-model="MasterLC.NotifyPartyName" class="form-control" ng-keydown="SearchKeyDownNotifyParty($event)" placeholder="Type Consignee & Press Enter" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickNotifyParty()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label">Remark:</label></div>
                            <div class="col-md-10 text-left">
                                <input ng-model="MasterLC.Remark" class="form-control" />
                            </div>
                        </div>
                    </fieldset>

                    <div class="ui-grid-top-panel" style="text-align:left;">
                        PI No: <select id="cboPI" style=" width:200px;"></select>
                        <button type="button" id="btnLoadPI" class="btn btn-default btn-sm" aria-label="right Align" ng-click="LoadPI()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> Load PI</span></button>
                        <button type="button" id="btnAddLCDetail" class="btn btn-default btn-sm" aria-label="right Align" ng-click="AddMasterLCDetail()"><span class="glyphicon glyphicon-plus" aria-hidden="true"> Add</span></button>
                        <button type="button" id="btnRemovePIDetail" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RemoveDetail()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
                        <button type="button" id="btnPIHistory" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PIHistory()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> PI History</span></button>
                        <button type="button" id="btnRefreshPIDetail" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RefreshPIDetail()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> Refresh</span></button>
                    </div>
                    <div style="width: 100%; height:220px;" ui-grid="gridOptionsMLCDetail" ui-grid-selection></div>
                </div>
                <div ng-show="MLCC.IsSet(2)">
                    <fieldset>
                        <legend>LC Info </legend>
                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label">Shipment Port:</label></div>
                            <div class="col-md-4 text-left">
                                <input ng-model="MasterLC.ShipmentPort" class="form-control" disabled />
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">LC Type:</label></div>
                            <div class="col-md-3 text-left">
                                <select class="form-control" ng-model="MasterLC.LCTypeInInt" ng-options="item.id as item.Value for item in LCTypes" ng-class="ChangeLCType()"></select>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label">D.Charge(%):</label></div>
                            <div class="col-md-2 text-left">
                                <input type="number" ng-model="MasterLC.DiscrepancyCharge" class="form-control" required />
                            </div>
                        </div>

                        <div class="row col-md-12">
                            <div class="col-md-2 text-right"><label class="control-label">Partial Shipment:</label></div>
                            <div class="col-md-4 text-left">
                                <div class="col-md-5">
                                    <select class="form-control" ng-model="MasterLC.PartialShipmentAllowInInt" ng-options="item.id as item.Value for item in PartialShipmentAllows"></select>
                                </div>
                                <div class="col-md-5 text-right"><label class="control-label">Transshipment:</label> </div>
                                <div class="col-md-5 text-left">
                                    <select class="form-control" ng-model="MasterLC.TransferableInInt" ng-options="item.id as item.Value for item in Transferables"></select>
                                </div>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label" id="lblDafferdCountFrom">Days Count From:</label></div>
                            <div class="col-md-3 text-left">
                                <select class="form-control" ng-hide="hidDefferedFrom" ng-disabled="DisabledDeferredFrom" ng-model="MasterLC.DeferredFromInInt" ng-options="item.id as item.Value for item in DeferredFroms"></select>
                            </div>
                            <div class="col-md-2 text-right"><label class="control-label" id="lblDysCount">Days Count:</label></div>
                            <div class="col-md-2 text-left"><input type="text" ng-model="MasterLC.DefferedDaysCount" ng-hide="hideDefferedDaysCount" ng-disabled="DisabledDefferedDaysCount" class="form-control" /></div>
                        </div>
                    </fieldset>
                    <div class="ui-grid-top-panel" style="text-align:left;">
                        <button type="button" id="btnAddTermsAndConditon" class="btn btn-default btn-sm" aria-label="right Align" ng-click="AddTermsAndCondition()"><span class="glyphicon glyphicon-plus" aria-hidden="true"> Terms And Condition</span></button>
                        <button type="button" id="btnRemoveTermsAndCondition" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RemoveTermsAndCondition()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
                        <button type="button" id="btnRefreshTermsAndCondition" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RefreshTermsAndCondition()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> Refresh</span></button>
                    </div>
                    <div style="width: 100%; height:300px;" ui-grid="gridOptionsMLCTermsAndCondition" ui-grid-selection ui-grid-edit ui-grid-row-edit ui-grid-cellnav></div>
                </div>
            </section>
        </div>
        <fieldset>
            <legend>Action</legend>
            <div class="row col-md-12 text-right">
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Commit</span> </button>
                <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
            </div>
        </fieldset>
    </div>
</body>
</html>
<style type="text/css">
    .form-horizontal .control-label {
        padding-top: 1px;
    }

    .form-control {
        height: 26px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 5px;
    }

    .col-md-2 {
        width: 13%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .col-md-3 {
        width: 20%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .col-md-4 {
        width: 28%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .col-md-5 {
        width: 33.33%;
        padding-right: 5px;
        padding-left: 0px;
    }

    .col-md-6 {
        width: 60%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .col-md-10 {
        width: 86%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .btn-sm {
        padding: 3px 10px;
    }

    .input-group-addon {
        padding: 4px 8px;
    }
</style>
<script type="text/javascript">
    var oMasterLC =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oCurrencies =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.Currencies));
    var oBusinessUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.BusinessUnits));
    var oMasterLCDetails = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.MasterLCDetails));
    var oMasterLCTermsAndConditions =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.MasterLCTermsAndConditions));
    var oLCTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.LCTypes));
    var oPartialShipmentAllows = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PartialShipmentAllows));
    var oTransferables = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Transferables));
    var oDeferredFroms = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DeferredFroms));
    debugger;
    var MasterLCApp = angular.module('MasterLCApp', ['ngAnimate', 'ui.bootstrap','ui.grid','ui.grid.selection','ui.grid.edit', 'ui.grid.rowEdit','ui.grid.cellNav','ms.service']);
    MasterLCApp.controller('MasterLCController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession) {
        debugger;
        $('.date-container').datepicker({
            format: "dd M yyyy",
            calendarWeeks: true,
            autoclose: true,
            todayHighlight: true
        });
        oMasterLC.BUID = sessionStorage.getItem('BUID');
        $scope.Currencies=oCurrencies;
        $scope.BusinessUnits=oBusinessUnits;
        $scope.MasterLCDetails=oMasterLCDetails;
        $scope.MasterLCTermsAndConditions=oMasterLCTermsAndConditions;
        $scope.ProformaInvoices = [];
        $scope.LCTypes = oLCTypes;
        $scope.PartialShipmentAllows = oPartialShipmentAllows;
        $scope.Transferables = oTransferables;
        $scope.DeferredFroms = oDeferredFroms;
        $scope.MasterLC=oMasterLC;

        ////Master LC Detail
        $scope.gridOptionsMLCDetail = {
            //showGridFooter: true,
            showColumnFooter: true,
            multiSelect: false,
            enableRowSelection: true,
            enableHorizontalScrollbar: uiGridConstants.scrollbars.NEVER,
            columnDefs: [
              { field: 'PINo', name:'PI No', width:'15%' },
              { field: 'PIStatusInString', name:'PI Status', width:'15%' },
              { field: 'BuyerName', name: 'Buyer', width: '20%',align:'left', enableSorting: false },
              { field: 'PIIssueDateInString', name: 'Issue Date', width: '10%', enableSorting: false },
              { field: 'PIQty', name: 'PI Qty',aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true, width: '10%',align:'right' },
              { field: 'Amount', name: 'Total Amount',aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true,  width: '15%', enableSorting: false }
            ],
            data:oMasterLCDetails,
            onRegisterApi: function (gridApi) {
                $scope.gridDetailApi = gridApi;
            }
        };

        //Master LC Terms and condition
        $scope.gridOptionsMLCTermsAndCondition = {
            multiSelect: false,
            enableRowSelection: true,
            multiSelect: false,
            //enableHorizontalScrollbar: uiGridConstants.scrollbars.NEVER,
            columnDefs: [
              { field: 'TermsAndCondition', name:'Terms and condition', width:'90%',enableCellEdit:true  }
            ],
            data:oMasterLCTermsAndConditions,
            onRegisterApi: function (gridApi) {
                $scope.gridApiTermsAndCondition = gridApi;
            }
        };

        $scope.hidDefferedFrom = true;
        $scope.hideDefferedDaysCount = true;
        document.getElementById('lblDafferdCountFrom').innerHTML ='';
        document.getElementById('lblDysCount').innerHTML ='';


        $scope.LoadPI= function ()
        {
            if(parseInt($scope.MasterLC.Applicant)<=0)
            {
                alert(" Please Pick Buyer");
                $('#txtApplicantName').focus();
                return;
            }
            $('#cboPI').empty();
            $.ajax
         ({
             type: "GET",
             dataType: "json",
             url : sessionStorage.getItem('BaseAddress')+"/MasterLC/GetPI",
             data: {BuyerID:parseInt($scope.MasterLC.Applicant)},
             contentType: "application/json; charset=utf-8",
             success: function (data) {
                 debugger;
                 var oProformaInvoices = jQuery.parseJSON(data);
                 if (oProformaInvoices !=null)
                 {
                     if(oProformaInvoices.length>0)
                     {
                         $scope.ProformaInvoices = oProformaInvoices;
                         $("#cboPI").icsLoadCombo({List: oProformaInvoices, OptionValue: "ProformaInvoiceID", DisplayText: "PINo"});
                     }
                 }
                 else
                 {
                     alert("data not found");
                 }
             },
             error: function (xhr, status, error)
             {
                 alert(error);
             }

         });
        };
        $scope.SearchKeyDownIssueBank = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var IssueBankName = $.trim($scope.MasterLC.IssueBankName);
                if(IssueBankName=="" || IssueBankName==null)
                {
                    alert("Type Issue bank Name and Press Enter");
                }
                $scope.IssueBank();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.MasterLC.IssueBankName='';
                $scope.MasterLC.IssueBankID=0;
            }
        };
        $scope.IssueBank=   function ()
        {
            var oBankBranch = {
                BUID: sessionStorage.getItem('BUID'),
                DeptIDs: '5',//EnumOperationalDept : Export_Party=5
                BankName: $.trim($scope.MasterLC.IssueBankName)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/BankBranch/GetsBankBranchSearchByBankName',$.param(oBankBranch), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'BankName', name: 'Bank Name',width: '20%'  };oColumns.push(oColumn);
                            oColumn = { field: 'BranchName', name: 'Branch Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            oColumn = { field: 'Address', name: 'Address',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                                modalcontroller:'ModalCommonListCtrl',
                                appcontroller:'MasterLCController',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Bank List',
                                searchingbyfieldName:'Name',
                                columns:oColumns
                            }
                            var modalInstance=msModal.call(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.MasterLC.IssueBankName=result.BankName;
                                $scope.MasterLC.IssueBankID=result.BankID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };


        $scope.SearchKeyDownAdviceBank = function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var AdviceBankName = $.trim($scope.MasterLC.AdviceBankName);
                if(AdviceBankName=="" || AdviceBankName==null)
                {
                    alert("Type Advice bank Account and Press Enter");
                    return;
                }
                $scope.AdviceBank();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.MasterLC.AdviceBankName='';
                $scope.MasterLC.AdviceBankID=0;
            }
        };
        $scope.AdviceBank= function ()
        {
            var oBankAccount= {
                BusinessUnitID: sessionStorage.getItem('BUID'),
                OperationalDeptInInt: '4',//EnumOperationalDept : Export_Own=4
                AccountNo: $.trim($scope.MasterLC.AdviceBankName)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(sessionStorage.getItem('BaseAddress')+'/BankAccount/GetsBUWithDeptWise',$.param(oBankAccount), config).then(
                        function (response)
                        {
                            var oColumns = [];
                            var oColumn = { field: 'BankNameAccountNo', name: 'Account No',width: '20%'  };oColumns.push(oColumn);
                            oColumn = { field: 'BranchName', name: 'Branch Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                            var results=jQuery.parseJSON(response.data);
                            var modalObj={
                                size:'md',
                                url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                                modalcontroller:'ModalCommonListCtrl',
                                appcontroller:'MasterLCController',
                                objs:results,
                                multiSelect:false,
                                pickertitle:'Bank Account List',
                                searchingbyfieldName:'BankNameAccountNo',
                                columns:oColumns
                            }
                            var modalInstance=msModal.call(modalObj);
                            modalInstance.result.then(function (result)
                            {
                                debugger;
                                $scope.MasterLC.AdviceBankName=result.BankNameAccountNo;
                                $scope.MasterLC.AdviceBankID=result.BankAccountID;

                            }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                        },
                            function (response) { alert(jQuery.parseJSON(response.data).Message);}
                    );

        };


        $scope.RefreshDetail = function ()
        {
            $scope.gridOptionsMLCDetail.data =  $scope.gridOptionsMLCDetail.data;
        };

        $scope.AddMasterLCDetail= function ()
        {
            debugger;

            if($scope.ProformaInvoices.length<=0)
            {
                alert("Please Load Proforma Invoice");
                return;
            }
            if(document.getElementById("cboPI").value<=0)
            {
                alert("Please select PI");
                return;
            }

            var oMLCDetails =  $scope.gridOptionsMLCDetail.data;
            for(var i =0;i<$scope.ProformaInvoices.length;i++)
            {

                if($scope.ProformaInvoices[i].ProformaInvoiceID == $("#cboPI").val())
                {

                    if(!ICS_IsExist(oMLCDetails,'ProformaInvoiceID', $scope.ProformaInvoices[i].ProformaInvoiceID))
                    {
                        var oMLCDetail = $scope.ProformaInvoices[i];
                        oMLCDetail.Amount = $scope.ProformaInvoices[i].NetAmount>0?$scope.ProformaInvoices[i].NetAmount:$scope.ProformaInvoices[i].Amount;
                        oMLCDetail.PIStatusInInt = $scope.ProformaInvoices[i].PIStatus;
                        oMLCDetail.PIQty = $scope.ProformaInvoices[i].Quantity;
                        oMLCDetail.PIIssueDateInString =$scope.ProformaInvoices[i].IssueDateInString;
                        oMLCDetail.PIIssueDate = new Date($scope.ProformaInvoices[i].IssueDateInString);
                        $scope.gridOptionsMLCDetail.data.push(oMLCDetail);
                        $scope.SetTotal();
                        return;

                    }
                }
            }

        };

        $scope.RemoveDetail = function ()
        {
            debugger;
            var oMLCDetail = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oMLCDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex=$scope.gridOptionsMLCDetail.data.indexOf(oMLCDetail);
            if (!confirm("Confirm to Delete?")) return ;
            $scope.gridOptionsMLCDetail.data.splice(SelectedRowIndex,1);
            $scope.SetTotal();
        };

        $scope.PIHistory =function ()
        {
            debugger;
            var oProformaInvoice = $scope.gridDetailApi.selection.getSelectedRows()[0];
            if(oProformaInvoice==null || oProformaInvoice.ProformaInvoiceID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            if(oProformaInvoice.PIStatus<2 )
            {
                alert("There is No Revise History!");
                return;
            }
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/ProformaInvoice/GetProformaInvoiceReviseHistory',$.param(oProformaInvoice), config).then(
                                function (response)
                                {
                                    var results=jQuery.parseJSON(response.data);
                                    var modalObj={
                                        size:'lg',
                                        url:sessionStorage.getItem('BaseAddress')+'/ProformaInvoice/PIReviseHistory',
                                        modalcontroller:'ModalPIReviseHistoryCtrl',
                                        appcontroller:'MasterLCController',
                                        objs:results
                                    }
                                    var modalInstance=msModal.call(modalObj);

                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message);}
                            );
        };

        $scope.SetTotal = function ()
        {
            debugger;
            var oMLCDetails = $scope.gridOptionsMLCDetail.data;
            var nTotalQty =0;
            var nTotalLCValue = 0;
            if(oMLCDetails.length>0)
            {

                for(var i =0;i<oMLCDetails.length;i++)
                {
                    nTotalQty+=parseFloat(oMLCDetails[i].PIQty);
                    nTotalLCValue+= parseFloat(oMLCDetails[i].Amount);
                    parseFloat(nTotalQty);
                    parseFloat(nTotalLCValue);
                }
            }
            $scope.MasterLC.LCValue = nTotalLCValue;
        };

        $scope.AddTermsAndCondition= function ()
        {
            debugger;
            var oExportTermsAndCondition = {
                Note: "1,5", //common and MasterLC Terms
                BUID: sessionStorage.getItem("BUID")
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/ExportTermsAndCondition/GetsByType',$.param(oExportTermsAndCondition), config).then(
                    function (response)
                    {
                        var oColumns = [];
                        var oColumn = { field: 'Clause', name: 'Terms And Condition',width: '70%'  };oColumns.push(oColumn);
                        oColumn = { field: 'Note', name: 'Remarks',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                        var results=jQuery.parseJSON(response.data);
                        var modalObj={
                            size:'md',
                            url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                            modalcontroller:'ModalCommonListCtrl',
                            appcontroller:'MasterLCController',
                            objs:results,
                            multiSelect:true,
                            pickertitle:'Applicant List',
                            searchingbyfieldName:'Clause',
                            columns:oColumns
                        }
                        var modalInstance=msModal.call(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            if (result!= null && result.length > 0)
                            {
                                for(var i =0;i<result.length;i++)
                                {
                                    var oMasterLCTermsAndConditions = $scope.gridOptionsMLCTermsAndCondition.data;
                                    if(!ICS_IsExist(oMasterLCTermsAndConditions,'TermsAndCondition', result[i].Clause))
                                    {
                                        var oLCTAndC ={
                                            MasterLCTermsAndConditionID : 0,
                                            MasterLCID : $scope.MasterLC.MasterLCID,
                                            TermsAndCondition : result[i].Clause
                                        };
                                        $scope.gridOptionsMLCTermsAndCondition.data.push(oLCTAndC);
                                    }
                                }
                            }
                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );

        };

        $scope.RemoveTermsAndCondition=  function ()
        {
            debugger;
            //$scope.gridApi.selection.getSelectedRows()[0];
            var oLCTermsAndCondition=$scope.gridApiTermsAndCondition.selection.getSelectedRows()[0];
            if(oLCTermsAndCondition==null)
            {
                alert("Select At least One item !");
                return;
            }
            var SelectedRowIndex= $scope.gridOptionsMLCTermsAndCondition.data.indexOf(oLCTermsAndCondition);
            if (!confirm("Confirm to Delete?")) return ;
            $scope.gridOptionsMLCTermsAndCondition.data.splice(SelectedRowIndex,1);
        };

        $scope.RefreshTermsAndCondition = function ()
        {
            $scope.gridOptionsMLCTermsAndCondition.data =  $scope.gridOptionsMLCTermsAndCondition.data;
        };

        $scope.save = function ()
        {
            debugger;
            if(!$scope.ValidateInput()) return;
            var oMasterLC= $scope.MasterLC;
            oMasterLC.MasterLCDate = new Date(oMasterLC.MasterLCDateSt);
            oMasterLC.ReceiveDate = new Date(oMasterLC.ReceiveDateInString);
            oMasterLC.LastDateofShipment = new Date(oMasterLC.LastDateofShipmentSt);
            oMasterLC.ExpireDate = new Date(oMasterLC.ExpireDateSt);
            oMasterLC.LCStatusInInt = 1;
            oMasterLC.MasterLCDetails=$scope.GetMasterLCDetails();
            oMasterLC.MasterLCTermsAndConditions= $scope.gridOptionsMLCTermsAndCondition.data;
            $.ajax({
                type: "POST",
                dataType: "json",
                url : sessionStorage.getItem('BaseAddress')+"/MasterLC/AcceptMasterLCAmendment",
                traditional: true,
                data:  JSON.stringify(oMasterLC),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //debugger;
                    var oMasterLC= jQuery.parseJSON(data);
                    if (oMasterLC.ErrorMessage=="" || oMasterLC.ErrorMessage==null)
                    {
                        alert("Data Save Successfully!!");
                        var oMasterLCs = sessionStorage.getItem("MasterLCs");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oMasterLCs != null) {
                            oMasterLCs = jQuery.parseJSON(oMasterLCs);
                        }
                        else {
                            oMasterLCs = [];
                        }
                        if (nIndex != -1) {
                            oMasterLCs[nIndex] = oMasterLC;
                        }
                        else {
                            sessionStorage.setItem("SelectedRowIndex", oMasterLCs.length);
                            oMasterLCs.push(oMasterLC);
                        }
                        sessionStorage.setItem("MasterLCs", JSON.stringify(oMasterLCs));
                        window.location.href = sessionStorage.getItem("BackLink");
                    }
                    else
                    {
                        alert(oMasterLC.ErrorMessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });

        };

        $scope.ValidateInput =  function ()
        {
            debugger;
            if(parseInt($scope.MasterLC.Applicant)<=0) { alert("Please Pick Applicant"); /*$('#txtApplicantName').focus();*/ return false; }
            if(parseInt($scope.MasterLC.Beneficiary) ==0) { alert("Please select Beneficiary"); return false; }
            if(parseInt($scope.MasterLC.IssueBankID)<=0) { alert("Please Pick Issue Bank"); return false; }
            if(parseInt($scope.MasterLC.AdviceBankID)<=0) { alert("Please Pick Advice Bank"); return false; }
            if(parseFloat($scope.MasterLC.LCValue)<=0 ) { alert("Ammount Should Be greater than O");  return false; }
            if(parseInt($scope.MasterLC.CurrencyID)==0) { alert("Please select Currency"); return false; }
            if(parseInt($scope.MasterLC.LCType)!=0)
            {
                if(parseInt($scope.MasterLC.DeferredFrom)==0)
                {
                    alert("Please Select Deffered Count From");
                    return false;
                }
                if(parseInt($scope.MasterLC.DefferedDaysCount)<=0)
                {
                    alert("Please Type Days Count Value. ");
                    //$('#txtDefferedDaysCount').focus();
                    return false;
                }
            }else
            {
                $scope.MasterLC.DeferredFrom = 0;
                $scope.MasterLC.DefferedDaysCount = 0;
            }
            var dMasterLCDate = new Date($scope.MasterLC.MasterLCDateSt); //$('#txtMasterLCDate').datebox('getValue')
            var dReceiveDate = new Date($scope.MasterLC.ReceiveDateInString); //$('#txtReceiveDate').datebox('getValue')
            var dLastDateofShipment = new  Date($scope.MasterLC.LastDateofShipment);//$('#txtLastDateofShipment').datebox('getValue')
            var dExpireDate = new Date($scope.MasterLC.ExpireDateSt); //$('#txtExpireDate').datebox('getValue')
            if(dMasterLCDate>=dReceiveDate)
            {
                alert("Receive Date Should be Greter than Issue Date");
                return false;
            }
            if(dReceiveDate>=dLastDateofShipment)
            {
                alert("Shipment Date Should be Greater than than Receive Date");
                return false;
            }
            if(dLastDateofShipment>=dExpireDate)
            {
                alert("Expire Date Should be Greater than Shipment Date");
                return false;
            }
            if($scope.gridOptionsMLCDetail.data.length <=0){alert("Please Add Master LC Details");  return false;}
            return true;
        };

        $scope.GetMasterLCDetails= function ()
        {
            var oMLCDetails = $scope.gridOptionsMLCDetail.data;
            for(var i = 0;i<oMLCDetails.length;i++)
            {
                oMLCDetails[i].MasterLCDate = new Date(oMLCDetails[i].MasterLCDateInString);
            }
            return oMLCDetails;
        };
        $scope.close=function ()
        {
            window.location.href = sessionStorage.getItem("BackLink");
        };

        // Search Applicant Start
        $scope.SearchKeyDownApplicant=function (e)
        {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13)
            {
                var ApplicantName = $.trim($scope.MasterLC.ApplicantName);
                if(ApplicantName==""||ApplicantName==null)
                {
                    alert("Type Applicant Name and Press Enter");
                    return;
                }
                $scope.PickApplicant();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.MasterLC.ApplicantName='';
                $scope.MasterLC.Applicant = 0;
            }
        };
        $scope.PickApplicant= function () {
            // debugger;
            var oContractor = {
                Params: '2' + '~' + $.trim($scope.ApplicantName)+'~'+sessionStorage.getItem('BUID')
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(oContractor), config).then(
                                function (response)
                                {
                                    var oColumns = [];
                                    var oColumn = { field: 'ContractorID', name: 'Code',width: '20%'  };oColumns.push(oColumn);
                                    oColumn = { field: 'Name', name: 'Applicant Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                                    oColumn = { field: 'Address', name: 'Address',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                                    var results=response.data;
                                    var modalObj={
                                        size:'md',
                                        url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                                        modalcontroller:'ModalCommonListCtrl',
                                        appcontroller:'MasterLCController',
                                        objs:results,
                                        multiSelect:false,
                                        pickertitle:'Applicant List',
                                        searchingbyfieldName:'Name',
                                        columns:oColumns
                                    }
                                    var modalInstance=msModal.call(modalObj);
                                    modalInstance.result.then(function (result)
                                    {
                                        debugger;
                                        $scope.MasterLC.ApplicantName=result.Name;
                                        $scope.MasterLC.Applicant=result.ContractorID;
                                    }, function () {
                                        $log.info('Modal dismissed at: ' + new Date());
                                    });
                                },
                                  function (response) { alert(jQuery.parseJSON(response.data).Message);}
                            );
        };


        //ConsigneeName
        $scope,SearchKeyDownConsignee= function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtConsigneeName = $.trim($scope.MasterLC.ConsigneeName);
                if(txtConsigneeName=="" || txtConsigneeName==null)
                {
                    alert("Type Consignee Name and Press Enter");
                    return;
                }
                $scope.PickConsignee();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.ConsigneeName = '';
                $scope.Consignee = 0;
            }
        };
        $scope.PickConsignee= function () {
            var oContractor = {
                Params: '5' + '~' + $.trim($scope.ConsigneeName)+'~'+sessionStorage.getItem("BUID")
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(oContractor), config).then(
                    function (response)
                    {
                        var oColumns = [];
                        var oColumn = { field: 'ContractorID', name: 'Code',width: '20%'  };oColumns.push(oColumn);
                        oColumn = { field: 'Name', name: 'Applicant Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'Address', name: 'Address',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                        var results=response.data;
                        var modalObj={
                            size:'md',
                            url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                            modalcontroller:'ModalCommonListCtrl',
                            appcontroller:'MasterLCController',
                            objs:results,
                            multiSelect:false,
                            pickertitle:'Consignee List',
                            searchingbyfieldName:'Name',
                            columns:oColumns
                        }
                        var modalInstance=msModal.call(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            $scope.MasterLC.ConsigneeName=result.Name;
                            $scope.MasterLC.Consignee=result.ContractorID;
                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };

        $scope.SearchKeyDownNotifyParty =  function (e) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtNotifyPartyName = $.trim($scope.MasterLC.NotifyPartyName);
                if(txtNotifyPartyName=="" || txtNotifyPartyName==null)
                {
                    alert("Type NotifyParty Name and Press Enter");
                    return;
                }
                $scope.PickNotifyParty();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.NotifyPartyName = '';
                $scope.NotifyParty = 0;
            }
        };
        $scope.PickNotifyParty= function () {
            var oContractor = {
                Params: '5' + '~' + $.trim($scope.NotifyPartyName)+'~'+sessionStorage.getItem("BUID")
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(oContractor), config).then(
                    function (response)
                    {
                        var oColumns = [];
                        var oColumn = { field: 'ContractorID', name: 'Code',width: '20%'  };oColumns.push(oColumn);
                        oColumn = { field: 'Name', name: 'Applicant Name',width: '50%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'Address', name: 'Address',width: '30%', enableSorting: false  };oColumns.push(oColumn);
                        var results=response.data;
                        var modalObj={
                            size:'md',
                            url:sessionStorage.getItem('BaseAddress')+'/CommonModal/CommonListModal',
                            modalcontroller:'ModalCommonListCtrl',
                            appcontroller:'MasterLCController',
                            objs:results,
                            multiSelect:false,
                            pickertitle:'Notify Party List',
                            searchingbyfieldName:'Name',
                            columns:oColumns
                        }
                        var modalInstance=msModal.call(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            $scope.MasterLC.NotifyPartyName=result.Name;
                            $scope.MasterLC.NotifyParty=result.ContractorID;
                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };

        $scope.ChangeLCType =function ()
        {
            //debugger;
            var ncboLCType = $scope.MasterLC.LCTypeInInt;//  $("#cboLCType").val();
            if (parseInt(ncboLCType)==1)//deffered
            {
                $scope.hidDefferedFrom = false;
                $scope.hideDefferedDaysCount = false;
                document.getElementById('lblDafferdCountFrom').innerHTML ='Daffered Count From:';
                document.getElementById('lblDysCount').innerHTML ='Days Count:';
            }
            else //at-sight
            {
                $scope.hidDefferedFrom = true;
                $scope.hideDefferedDaysCount = true;
                document.getElementById('lblDafferdCountFrom').innerHTML ='';
                document.getElementById('lblDysCount').innerHTML ='';
            }
        };


        if($scope.MasterLC.MasterLCID>0)
        {
            if($scope.MasterLC.LCType!=0)
            {
                $scope.hidDefferedFrom =  false;
                $scope.hideDefferedDaysCount = false;

                document.getElementById('lblDafferdCountFrom').innerHTML ='Daffered Count From:';
                document.getElementById('lblDysCount').innerHTML ='Days Count:';
            }
            $scope.SetTotal();
        };

        //TAb selection
        this.tab = 1;
        this.SetTab = function (tabId)
        {
            this.tab = tabId;
        }
        this.IsSet = function (tabid)
        {
            return this.tab === tabid;
        }
    });




</script>
