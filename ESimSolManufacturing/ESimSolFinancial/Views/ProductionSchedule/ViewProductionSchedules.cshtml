<html>
<head>
    <title></title>
</head>
@model ESimSol.BusinessObjects.ProductionSchedule
@{
    ViewBag.Title = "Production Schedule";
}
<body>
    <div style="font-family: Tahoma; width: 100%;">
        <table border="0" cellspacing="2" cellpadding="2" style="width: 100%;">
            <tr>
                <td>
                    <div>
                        <center>
                               <a id="hprlnkDefaultView" href="javascript:void(0)">Default View</a> 
                            || <a id="hprlnkBuyerWise" href="javascript:void(0)">Buyer Wise</a> 
                            || <a id="hprlnkExecutionWise" href="javascript:void(0)"> Execution Wise </a>
                            || <a id="hprlnkProductWise" href="javascript:void(0)">Product Wise</a>
                        </center>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div id="scheduleDetail" style="margin-left: 0px; height: 500px; width: 100%; padding-top: 10px;">
        <table id="tblScheduleDetail" title="Schedule Detail" class="easyui-datagrid" style="height: 500px;
            width: 100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" striped="true"
               autorowheight="false" toolbar="#scheduleDetailtoolbar" data-options="onLoadSuccess: onLoadSuccess">
            <thead frozen="true">
                <tr>
                    <th field="MachineName" width="90" striped="true" align="left"> Machine Name </th>
                    <th field="CheckBox" checkbox="true"></th>
                    <th field="ProductionScheduleNo" width="100" align="left"> PS No </th>
                </tr>
            </thead>
            <thead>
                <tr>
                    <th field="OrderNoWithoutExe" width="90" align="left"> Order No</th>
                    <th field="BuyerName" width="120" align="left"> Buyer Name </th>
                    <th field="BuyerRef" width="140" align="left"> Buyer Ref </th>
                    <th field="ColorName" width="100" align="left"> Color Name </th>
                    <th align="right" width="65" data-options="field:'ProductionQty',formatter:formatPrice"> Qty </th>
                    <th field="ExpDeliveryDateByFactoryInString" width="90" align="left"> Delivery Date </th>
                    <th field="ProductName" width="120" align="left"> Product Name</th>
                    <th field="RSStateInString" width="120" align="left"> Status </th>
                    <th field="PSBatchNo" width="80" align="center"> Color Batch </th>
                    <th field="BatchCardNo" width="80" align="left"> Batch </th>
                    <th field="StartTimeInString" width="130" align="left"> Start Date </th>
                    <th field="EndTimeInString" width="130" align="left"> End Date </th>
                    @*<th field="LocationName" width="100" align="left"> Location name </th>*@
                    <th field="Remarks" width="120" align="left"> Match </th>


                </tr>
            </thead>
        </table>

        <div id="scheduleDetailtoolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="scheduleDetailRefresh()"></a>
            <input type="text" id="txtSearchbyScheduleDetailColorName" placeholder="Search by Color" style="width: 80px; font-size: 11px;" />
            <input id="txtProductName" type="text" placeholder="Search By Count" style="width: 80px; font-size: 11px;" />
            <input type="text" placeholder="Buyer Ref" style="width: 80px; font-size: 11px;" id="txtBuyerRef" />
            <input type="text" placeholder="Order Ref" style="width: 80px; font-size: 11px;"id="txtOrderRef" />
            <input id="txtJobCode" type="text" placeholder="Code" value="33" style="width: 33px;  font-size: 11px;" maxlength="2" />
            <input id="txtJobNo" type="text" placeholder="Exe No" style="width: 40px; font-size: 11px;"  maxlength="5" />
            <input id="txtJobYear" type="text" placeholder="Year" style="width: 33px; font-size: 11px;" maxlength="2" />

            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true" id="btnAdvanceSearch">Adv. Search</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" id="btnDetail">Detail</a>
            <a href="javascript:void(0)" class="easyui-linkbutton"iconcls="icon-edit" plain="true" id="btnEdit">Edit</a>
            <input type="button" id="btnCut" style=" font-size:11px; width:30px; " value="Cut" />
            <input type="button" id="btnPaste" style=" font-size:11px; width:40px;" value="Paste" />
            <input type="button" id="btnSwap" style=" font-size:11px; width:40px;" value="Swap" />
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" id="btnPrintDefault">All</a> 
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" id="btnPrintSchedule"> Schedule </a>
        </div>
    </div>
    <div id="partyWise" style="margin-left: 0px; height: 500px; width: 100%; padding-top: 10px;">
        <table id="tblPartyWise" title="Buyer Wise" class="easyui-datagrid" style="height: 500px; width: 100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#partyWisetoolbar">
            <thead>
                <tr>
                    <th field="BuyerName" width="286" align="left"> Buyer Name </th>
                    <th field="ProductName" width="286" align="left"> Product Name </th>
                    <th align="right" width="286" data-options="field:'ProductionQty',formatter:formatPrice"> Production Qty </th>
                </tr>
            </thead>
        </table>

        <div id="partyWisetoolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="partyWiseRefresh()"></a>
            <input type="text" id="txtSearchbyPartyWiseBuyerName" placeholder="Search by Buyer Name" style="width: 170px" />
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="Show('Party Wise')">Show</a> 
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" id="btnPrintPartyWise">Print</a>
        </div>
    </div>
    
    <div id="OrderWise" style="margin-left: 0px; height: 500px; width: 100%; padding-top: 10px;">
        <table id="tblOrderWise" title="Execution Wise" class="easyui-datagrid" style="height: 500px; width: 100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#orderWisetoolbar">
            <thead>
                <tr>
                    <th field="OrderNoWithoutExe" width="286" align="left"> Order No </th>
                    <th field="BuyerName" width="286" align="left"> Buyer Name </th>
                    <th align="right" width="286" data-options="field:'ProductionQty',formatter:formatPrice"> Production Qty </th>
                </tr>
            </thead>
        </table>

        <div id="orderWisetoolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="orderWiseRefresh()"></a>
            <input type="text" id="txtSearchbyOrderWiseOrderNo" placeholder="Search by Order Name" style="width: 170px" />
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="Show('Order Wise')">Show</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" id="btnPrintOrderWise">Print</a>
        </div>
    </div>
  
    <div id="productWise" style="margin-left: 0px; height: 500px; width: 100%; padding-top: 10px;">
        <table id="tblProductWise" title="Product Wise" class="easyui-datagrid" style="height: 500px;  width: 100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#productWisetoolbar">
            <thead>
                <tr>
                    <th field="ProductName" width="430" align="left"> Product Name </th>
                    <th align="right" width="430" data-options="field:'ProductionQty',formatter:formatPrice"> Production Qty </th>
                </tr>
            </thead>
        </table>

        <div id="productWisetoolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="productWiseRefresh()"></a>
            <input type="text" id="txtSearchbyProductWiseProductName" placeholder="Search by Product Name" style="width: 170px" />
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="Show('Product Wise')">Show</a> 
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" id="btnPrintProductWise">Print</a>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">

var _oProductionSchedule;
var _sBaseAddress="";
var _sPSDIds="";
var _oPSDs=[];
var _oPSDetails=[];
var _oMCells=[];
var _oMCellPSs=[];
var _sPSIDs='';
var _oPS=null;

$(document).ready(function () {
    debugger;
    _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    _oProductionSchedule =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var bStatus=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(TempData["Details"]));
    if(bStatus==false)
    {
        document.getElementById('btnDetail').style.display='none';
    }
    $('#txtJobCode').numberbox({min:0,precision:0});
    $('#txtJobYear').numberbox({min:0,precision:0});
    var sYear=(new Date()).getFullYear().toString();
    $('#txtJobYear').numberbox('setValue',parseInt(sYear.substring(2,sYear.length)));

    $('#tblScheduleDetail').datagrid({selectOnCheck:false, checkOnSelect:false});
    ShowSelectedGrid(_oProductionSchedule.sActionLink);

    if(_oProductionSchedule.ProductionScheduleDetails.length>0)
    {
        _oPSDs=_oProductionSchedule.ProductionScheduleDetails;
        RefreshControll();
    }

});

function GenerateExeNo()
{
    debugger;
    var sExecution="";
    var sYear=(new Date()).getFullYear().toString();
    var nYear= parseInt(sYear.substring(2,sYear.length));

    var sExeCode=$('#txtJobCode').numberbox('getValue');
    var sExeNo=document.getElementById('txtJobNo').value;
    var sExeYear=$('#txtJobYear').numberbox('getValue');
    if( (sExeCode=='33' && $.trim(sExeNo)=='' &&  parseInt(sExeYear)==nYear) || $.trim(sExeCode)=='' || $.trim(sExeNo)=='' || $.trim(sExeYear)=='') { sExecution="";}
    else
    {
        if($.trim(sExeNo).length>0 && $.trim(sExeNo).length<5)
        {
            for(var i=0;$.trim(sExeNo).length<5;i++)
            {
                sExeNo="0"+$.trim(sExeNo);
            }
        }
        sExecution=sExeCode+'-'+$.trim(sExeNo)+'/'+sExeYear;
    }

    return sExecution;
}

function Validation()
{
    var bExecutionSearch=true;
    var sExecution=GenerateExeNo();
    if(sExecution==""){bExecutionSearch=false;}
    if(bExecutionSearch)
    {
        var sCode=sExecution.split('-')[0];
        var sExeNo=(sExecution.split('/')[0]).split('-')[1];
        var sYear=sExecution.split('/')[1];
        if(  sCode.length!=2){ alert("Exe code must be two digit"); document.getElementById('txtJobCode').focus(); return false;}
        else if( sExeNo.length!=5){ alert("Exe no must be five digit"); document.getElementById('txtJobNo').focus(); return false;}
        else if(  sYear.length!=2){ alert("Please enter last two digit of a year."); document.getElementById('txtJobYear').focus(); return false;}
    }
    return true;

}
 
$('#txtJobNo').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key
    {
        if(Validation())
        {
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/ProductionSchedule/PSSeachByExecution",
                traditional: true,
                data:  JSON.stringify({sExecution:GenerateExeNo(),nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    var oPSDs  = jQuery.parseJSON(data);
                    if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
                    {
                        _oPSDs= oPSDs;
                        RefreshControll();

                    }
                    else
                    { alert(oPSDs[0].ErrorMessage); }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }
    }
});

function RefreshControll()
{
    _sPSDIds="";
    var oMachineNames=[];
    var oPSs=[];
    if(_oPSDs.length>0)
    {
        for(var i=0; i<_oPSDs.length;i++)
        {
            oMachineNames.push(_oPSDs[i].MachineName);
            oPSs.push(_oPSDs[i].ProductionScheduleNo);
            _sPSDIds +=_oPSDs[i].ProductionScheduleDetailID + ",";
        }
        _sPSDIds=_sPSDIds.substring(0,_sPSDIds.length-1);
        _oMCells=GenerateRowSpan(oMachineNames);
        _oMCellPSs=GenerateRowSpan(oPSs);
        $('#tblScheduleDetail').empty();
        data = _oPSDs;
        data={"total":""+data.length+"","rows":data};
        $('#tblScheduleDetail').datagrid('loadData',data);
        TotalProductionQuantity(_oPSDs,'tblScheduleDetail')
    }
}

function onLoadSuccess(data)
{
    for(var i=0; i<_oMCells.length; i++)
    {
        $(this).datagrid('mergeCells',{index: _oMCells[i].Index,field: 'MachineName', rowspan: _oMCells[i].RowSpan});

    }
    for(var i=0; i<_oMCellPSs.length; i++)
    {
        $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'CheckBox', rowspan: _oMCellPSs[i].RowSpan});
        $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'ProductionScheduleNo', rowspan: _oMCellPSs[i].RowSpan});
        $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'StartTimeInString', rowspan: _oMCellPSs[i].RowSpan});
        $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'EndTimeInString', rowspan: _oMCellPSs[i].RowSpan});
    }
}

function ShowSelectedGrid(sActionLink)
{
    if(sActionLink==null)
    {
        document.getElementById("scheduleDetail").style.display = 'block';
        document.getElementById("partyWise").style.display = 'none';
        document.getElementById("productWise").style.display = 'none';
        document.getElementById("OrderWise").style.display = 'none';
    }
    else if(sActionLink=="Schedule Detail")
    {
        document.getElementById("scheduleDetail").style.display = 'block';
        document.getElementById("partyWise").style.display = 'none';
        document.getElementById("productWise").style.display = 'none';
        document.getElementById("OrderWise").style.display = 'none';
    }
    else if(sActionLink=="Party Wise")
    {
        document.getElementById("partyWise").style.display = 'block';
        document.getElementById("scheduleDetail").style.display = 'none';
        document.getElementById("productWise").style.display = 'none';
        document.getElementById("OrderWise").style.display = 'none';
    }
    else if(sActionLink=="Product Wise")
    {
        document.getElementById("productWise").style.display = 'block';
        document.getElementById("scheduleDetail").style.display = 'none';
        document.getElementById("partyWise").style.display = 'none';
        document.getElementById("OrderWise").style.display = 'none';
    }
    else if(sActionLink=="Order Wise")
    {
        document.getElementById("OrderWise").style.display = 'block';
        document.getElementById("scheduleDetail").style.display = 'none';
        document.getElementById("partyWise").style.display = 'none';
        document.getElementById("productWise").style.display = 'none';
    }
}

function RefreshListScheduleDetail(oScheduleDtails)
{
    data=oScheduleDtails;
    data={"total":""+data.length+"","rows":data};
    $('#tblScheduleDetail').datagrid('loadData',data);
    $('#tblScheduleDetail').datagrid({selectOnCheck:false, checkOnSelect:false});
    if(oScheduleDtails !=null && oScheduleDtails.length>0){TotalProductionQuantity(oScheduleDtails,'tblScheduleDetail');}
}
   
function RefreshListPartyWise(oScheduleDtails)
{
    data=oScheduleDtails;
    data={"total":""+data.length+"","rows":data};
    $('#tblPartyWise').datagrid('loadData',data);
    $('#tblPartyWise').datagrid({selectOnCheck:false, checkOnSelect:false});
    if(oScheduleDtails !=null && oScheduleDtails.length>0){TotalProductionQuantity(oScheduleDtails,'tblPartyWise');}

}

function RefreshListOrderWise(oScheduleDtails)
{
    data=oScheduleDtails;
    data={"total":""+data.length+"","rows":data};
    $('#tblOrderWise').datagrid('loadData',data);
    $('#tblOrderWise').datagrid({selectOnCheck:false, checkOnSelect:false});
    if(oScheduleDtails !=null && oScheduleDtails.length>0){TotalProductionQuantity(oScheduleDtails,'tblOrderWise');}
}
    
function RefreshListProductWise(oScheduleDtails)
{
    data=oScheduleDtails;
    data={"total":""+data.length+"","rows":data};
    $('#tblProductWise').datagrid('loadData',data);
    $('#tblProductWise').datagrid({selectOnCheck:false, checkOnSelect:false});
    if(oScheduleDtails !=null && oScheduleDtails.length>0){TotalProductionQuantity(oScheduleDtails,'tblProductWise');}
}


$('#hprlnkDefaultView').click(function (e) {
    AdvanceSearch('Schedule Detail');
});

$('#hprlnkBuyerWise').click(function (e) {
    if(_oPSDs==null || _oPSDs.length<=0){alert("No information availbale."); return;}
    AdvanceSearch('Party Wise');
});

$('#hprlnkExecutionWise').click(function (e) {
    if(_oPSDs==null || _oPSDs.length<=0){alert("No information availbale."); return;}
    AdvanceSearch('Order Wise');
});

$('#hprlnkProductWise').click(function (e) {
    if(_oPSDs==null || _oPSDs.length<=0){alert("No information availbale."); return;}
    AdvanceSearch('Product Wise');
});

$('#btnAdvanceSearch').click(function (e)
{
    var oMachineNames=[];
    var oPSs=[];
    var oParameter=new Object();
    var url =_sBaseAddress+ "/ProductionSchedule/ViewAdvanceSearchProductionScheduleDetails";
    var oProductionSchedule = window.showModalDialog(url, oParameter, 'dialogHeight:620px;dialogWidth:830px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
    if(oProductionSchedule!=null)
    {
        _sPSDIds="";
        _oPSDs=oProductionSchedule.SelectedProductionSchedules;

        if(_oPSDs.length>0)
        {
            for(var i=0; i<_oPSDs.length;i++)
            {
                oMachineNames.push(_oPSDs[i].MachineName);
                oPSs.push(_oPSDs[i].ProductionScheduleNo);
                _sPSDIds +=_oPSDs[i].ProductionScheduleDetailID + ",";
            }
            _sPSDIds=_sPSDIds.substring(0,_sPSDIds.length-1);
            _oMCells=GenerateRowSpan(oMachineNames);
            _oMCellPSs=GenerateRowSpan(oPSs);
            $('#tblScheduleDetail').empty();
            data = _oPSDs;
            data={"total":""+data.length+"","rows":data};
            $('#tblScheduleDetail').datagrid('loadData',data);
            TotalProductionQuantity(_oPSDs,'tblScheduleDetail')
        }
        else
        {
            $('#tblScheduleDetail').empty();
            data = [];
            data={"total":""+data.length+"","rows":data};
            $('#tblScheduleDetail').datagrid('loadData',data);
            alert("No information found.");
        }
    }

});

function AdvanceSearch(sGroupSearch)
{
    if( sGroupSearch=="Schedule Detail")
    {
        ShowSelectedGrid(sGroupSearch);
        if(_oPSDs.length>0)
        {
            $('#tblScheduleDetail').empty();
            data = _oPSDs;
            data={"total":""+data.length+"","rows":data};
            $('#tblScheduleDetail').datagrid('loadData',data);
            TotalProductionQuantity(_oPSDs,'tblScheduleDetail');
        }
        else
        {
            $('#tblScheduleDetail').empty();
            data = [];
            data={"total":""+data.length+"","rows":data};
            $('#tblScheduleDetail').datagrid('loadData',data);
            alert("No information found.");
        }
    }
    else if( sGroupSearch=="Party Wise" || sGroupSearch=="Order Wise" || sGroupSearch=="Product Wise")
    {
        if(_sPSDIds.length>0) { loadIntoGrid(_sPSDIds,sGroupSearch);}
        else{alert("No information found.");}
    }

}

function loadIntoGrid(sPSDIds,sGroupSearch)
{
    ShowSelectedGrid(sGroupSearch);
    _oPSDetails=[];
    var oProductionSchedule=RefreshObject(sPSDIds,sGroupSearch);
    $.ajax({
    type: "POST",
    dataType: "json",
    url : _sBaseAddress+  "/ProductionSchedule/viewGroupSearch",
    traditional: true,
    data:  JSON.stringify(oProductionSchedule),
    contentType: "application/json; charset=utf-8",
    success: function (data)
    {

        debugger;
        _oProductionSchedule = jQuery.parseJSON(data);
        if (_oProductionSchedule != null) {
            if(_oProductionSchedule.ProductionScheduleDetails.length>0)
            {
                _oPSDetails=_oProductionSchedule.ProductionScheduleDetails;
                if( sGroupSearch=="Party Wise"){ RefreshListPartyWise(_oPSDetails); }
                else if( sGroupSearch=="Order Wise"){ RefreshListOrderWise(_oPSDetails); }
                else if( sGroupSearch=="Product Wise"){ RefreshListProductWise(_oPSDetails);}
            }
            else{ alert("No information found."); }
        }
    },
    error: function (xhr, status, error) {
        alert(error);
    }
    });

}

function scheduleDetailRefresh()
{
    document.getElementById("txtSearchbyScheduleDetailColorName").value="";
    RefreshListScheduleDetail(_oPSDs);
}
   
function partyWiseRefresh()
{
    document.getElementById("txtSearchbyPartyWiseBuyerName").value="";
    RefreshListPartyWise(_oPSDetails);
}

function orderWiseRefresh()
{
    document.getElementById("txtSearchbyOrderWiseOrderNo").value="";
    RefreshListOrderWise(_oPSDetails);
}
    
function productWiseRefresh()
{
    document.getElementById("txtSearchbyProductWiseProductName").value="";
    RefreshListProductWise(_oPSDetails);
}

$('#txtSearchbyScheduleDetailColorName').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchbyColorName();
    }
    $('#txtSearchbyScheduleDetailColorName').focus();
});

$('#txtSearchbyPartyWiseBuyerName').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchbyPartyWise();
    }
    $('#txtSearchbyPartyWiseBuyerName').focus();

});

$('#txtSearchbyOrderWiseOrderNo').keypress(function (e) {

    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchbyOrderWise();
    }
    $('#txtSearchbyOrderWiseOrderNo').focus();
});

$('#txtSearchbyProductWiseProductName').keypress(function (e) {

    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchbyProductName();
    }
    $('#txtSearchbyProductWiseProductName').focus();

});
  
function  SearchbyColorName()
{
    var oPSDs=$('#tblScheduleDetail').datagrid('getRows');

    if (oPSDs==null || oPSDs.length <= 0)
    {
        alert("There are no data for searching!!!!");
        return;
    }
    var sSearchbyColorName= document.getElementById('txtSearchbyScheduleDetailColorName').value;
    if($.trim(sSearchbyColorName)=="")
    {
        RefreshListScheduleDetail(oPSDs);
    }
    else
    {

        var sName = "";
        var oSearchedData = [];

        var n = 0;
        for (i = 0; i <oPSDs.length; ++i)
        {
            sName = oPSDs[i].ColorName;

            n = 0;
            n = sName.toUpperCase().indexOf(sSearchbyColorName.toUpperCase());
            if (n != -1)
            {
                oSearchedData.push(oPSDs[i]);
            }
        }

        RefreshListScheduleDetail(oSearchedData);

    }
}

function  SearchbyPartyWise()
{

    var oPSDs=$('#tblPartyWise').datagrid('getRows');
    if (oPSDs==null || oPSDs.length <= 0)
    {
        alert("There are no data for searching!!!!");
        return;
    }
    var sSearchbyPartyWise= document.getElementById('txtSearchbyPartyWiseBuyerName').value;
    if($.trim(sSearchbyPartyWise)=="")
    {
        RefreshListPartyWise(oPSDs);
    }
    else
    {
        var sName = "";
        var oSearchedData = [];

        var n = 0;
        for (i = 0; i < oPSDs.length; ++i)
        {
            sName = oPSDs[i].BuyerName;
            n = 0;
            n = sName.toUpperCase().indexOf(sSearchbyPartyWise.toUpperCase());
            if (n != -1)
            {
                oSearchedData.push(oPSDs[i]);
            }
        }
        RefreshListPartyWise(oSearchedData);
    }

}

function  SearchbyOrderWise()
{
    var oPSDs=$('#tblOrderWise').datagrid('getRows');
    if (oPSDs==null || oPSDs.length <= 0)
    {
        alert("There are no data for searching!!!!");
        return;
    }
    var sSearchbyOrderWise= document.getElementById('txtSearchbyOrderWiseOrderNo').value;
    if(sSearchbyOrderWise=="")
    {
        RefreshListOrderWise(oPSDs);
    }
    else
    {

        var sName = "";
        var oSearchedData = [];
        var n = 0;
        for (i = 0; i < oPSDs.length; ++i)
        {
            sName = oPSDs[i].OrderNo;
            n = 0;
            n = sName.toUpperCase().indexOf(sSearchbyOrderWise.toUpperCase());
            if (n != -1)
            {
                oSearchedData.push(oPSDs[i]);
            }
        }
        RefreshListOrderWise(oSearchedData);

    }

}

function  SearchbyProductName()
{
    var oPSDs=$('#tblProductWise').datagrid('getRows');
    if (oPSDs==null || oPSDs.length <= 0)
    {
        alert("There are no data for searching!!!!");
        return;
    }
    var sSearchbyProductName= document.getElementById('txtSearchbyProductWiseProductName').value;
    if(sSearchbyProductName=="")
    {
        RefreshListProductWise(oPSDs);
    }
    else
    {

        var sName = "";
        var oSearchedData = [];

        var n = 0;
        for (i = 0; i < oPSDs.length; ++i)
        {
            sName = oPSDs[i].ProductName;
            n = 0;
            n = sName.toUpperCase().indexOf(sSearchbyProductName.toUpperCase());
            if (n != -1)
            {
                oSearchedData.push(oPSDs[i]);
            }
        }

        RefreshListProductWise(oSearchedData);
    }
}

function RefreshObject(sPSDIds,sGroupSearch)
{
    var oProductionSchedule = {
                                sProductionScheduleIds  : sPSDIds,
                                sActionLink             : sGroupSearch
                            };

    return oProductionSchedule;
}

function Show(sGroupSearch)
{
    var oScheduleDetail=null;
    if( sGroupSearch=="Party Wise")
    {
        oScheduleDetail = $('#tblPartyWise').datagrid('getSelected');
        ShowLoadIntoGrid(sGroupSearch,oScheduleDetail);
    }
    else if( sGroupSearch=="Order Wise")
    {
        oScheduleDetail = $('#tblOrderWise').datagrid('getSelected');
        ShowLoadIntoGrid(sGroupSearch,oScheduleDetail);
    }
    else if( sGroupSearch=="Product Wise")
    {
            oScheduleDetail = $('#tblProductWise').datagrid('getSelected');
            ShowLoadIntoGrid(sGroupSearch,oScheduleDetail);
    }
}

function ShowRefreshObject(sGroupSearch,oScheduleDetail)
{

    if( sGroupSearch=="Party Wise")
    {
        oProductionSchedule = {
                                    BuyerName       : oScheduleDetail.BuyerName,
                                    ProductName     : oScheduleDetail.ProductName,
                                    sActionLink     : sGroupSearch
                                };

    }
    else if( sGroupSearch=="Order Wise")
    {
        oProductionSchedule = {
                                    OrderNo         : oScheduleDetail.OrderNo,
                                    BuyerName       : oScheduleDetail.BuyerName,
                                    sActionLink     : sGroupSearch
                                };

    }
    else if( sGroupSearch=="Product Wise")
    {
        oProductionSchedule = {
                                    ProductName     : oScheduleDetail.ProductName,
                                    sActionLink     : sGroupSearch
                                };
    }

    return oProductionSchedule;
}

function ShowLoadIntoGrid(sGroupSearch,oScheduleDetail)
{

    var oProductionScheduleDetail=ShowRefreshObject(sGroupSearch,oScheduleDetail);
    $.ajax({
    type: "POST",
    dataType: "json",
    url : _sBaseAddress+  "/ProductionSchedule/ShowGroupSearch",
    traditional: true,
    data:  JSON.stringify(oProductionScheduleDetail),
    contentType: "application/json; charset=utf-8",
    success: function (data)
    {
            _oProductionSchedule = jQuery.parseJSON(data);
            if (_oProductionSchedule != null) {
                if(_oProductionSchedule.ProductionScheduleDetails.length>0)
                {
                    sGroupSearch="Schedule Detail";
                    ShowSelectedGrid(sGroupSearch);
                    RefreshListScheduleDetail(_oProductionSchedule.ProductionScheduleDetails);
                }
                else
                {
                    alert("Data not found!!");
                }
            }
        },
        error: function (xhr, status, error) {
            alert(error);
        }
    });
}

function TotalProductionQuantity(oProductionScheduleDetails, sTableName)
{

    var nTotalQuantity=0;
    var x;

    if(oProductionScheduleDetails.length>0)
    {
        for( var i=0; i<oProductionScheduleDetails.length; i++)
        {
            nTotalQuantity= Number(nTotalQuantity)+ Number(oProductionScheduleDetails[i].ProductionQty);
        }
        if(sTableName=='tblScheduleDetail')
        {
            x={
                RSStateInString    :  '<b>Total</b>',
                ProductionQty  :  nTotalQuantity
              };
        }

        else if(sTableName=='tblOrderWise')
        {

            x={
                BuyerName    :  '<b>Total</b>',
                ProductionQty  :  nTotalQuantity
              };

        }
        else
        {
            x={
                ProductName    :  '<b>Total</b>',
                ProductionQty  :  nTotalQuantity
              };
        }

        oProductionScheduleDetails.push(x);

        data=oProductionScheduleDetails;
        data={"total":""+data.length+"","rows":data};
        $('#'+sTableName+'').datagrid('loadData',data);

        oProductionScheduleDetails.pop(x);
    }

}

//sGroupSearch=="Party Wise" || sGroupSearch=="Order Wise" || sGroupSearch=="Product Wise"

$('#btnPrintDefault').click(function (e)
{

    if( $.trim(_sPSDIds)=="")
    {
        alert("There is no items in the list.");
        return;
    }
    var nts=(new Date()).getTime()/1000;
    window.open(_sBaseAddress+'/ProductionSchedule/PrintProductionScheduleTrackingReportDefault?sIDs='+ $.trim(_sPSDIds) +'&nts='+nts,"_blank");
});

$('#btnPrintPartyWise').click(function (e)
{

    if( $.trim(_sPSDIds)=="")
    {
        alert("There is no items in the list.");
        return;
    }
    Print('Party Wise', _sPSDIds);

});

$('#btnPrintOrderWise').click(function (e)
{

    if( $.trim(_sPSDIds)=="")
    {
        alert("There is no items in the list.");
        return;
    }
    Print('Order Wise', _sPSDIds);

});

$('#btnPrintProductWise').click(function (e)
{
    if( $.trim(_sPSDIds)=="")
    {
        alert("There is no items in the list.");
        return;
    }
    Print('Product Wise', _sPSDIds);
});


function Print(sType, sIDs)
{
    var nts=(new Date()).getTime()/1000;
    window.open(_sBaseAddress+'/ProductionSchedule/PrintProductionScheduleTrackingReport?sType='+ sType +'&sIDs='+ sIDs +'&nts='+nts,"_blank");
}

function formatPrice(val,row)
{

    val=parseFloat(val);
    var test = val.toFixed(2);
    if (val < 0)
    {
    test=(-1*test);
    }
    var tests = addComma(test);
    if (val < 0)
    {
    return '<span style="color:red;">('+tests+')</span>';
    }
    else
    {
    return tests;
    }

}

function addComma(nStr)
{
    nStr += '';
    x = nStr.split('.');
    x1 = x[0];
    x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
	    x1 = x1.replace(rgx, '$1' + ',' + '$2');
    }
    return x1 + x2;
}

function GenerateRowSpan(oDatas)
{
    var oMCell=null;
    var nIndex=0;
    var nRowSpan=0;
    var oMCells=[];
    for (var i=0; i<oDatas.length;i++)
    {
        nRowSpan=0;
        for(var j=i; j<oDatas.length;j++)
        {
            if(oDatas[i]==oDatas[j]){++nRowSpan;}
        }
        nRowSpan = (nRowSpan >= 0) ? nRowSpan : 0;
        oMCell={
            ParentID : 0,
            Index : nIndex,
            RowSpan : nRowSpan
        };
        oMCells.push(oMCell);
        nIndex = nIndex + nRowSpan;
        i=nIndex-1;
    }
    return oMCells;
}


$('#btnPrintSchedule').click(function(e)
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getChecked');

    if(oPSDs.length<=0)
    {
        alert("please select at least one item");
        return;
    }
    var sPSIDs='';
    for(var i=0; i<oPSDs.length;i++)
    {

        if(oPSDs[i]!=null)
        {
            if(oPSDs[i].ProductionScheduleID>0){ sPSIDs=sPSIDs+oPSDs[i].ProductionScheduleID+',';}
        }

    }

    sPSIDs=sPSIDs.substring(0,sPSIDs.length-1);
    var bPortrait=false;
    var oParameter=new Object();
    var url =_sBaseAddress+ "/ProductionSchedule/ViewPrintTypeSelector";
    var sReturnValue = window.showModalDialog(url,oParameter,'dialogHeight:130px;dialogWidth:300px;dialogLeft:500;dialogTop:130;center:yes;resizable:no;status:no;scroll:yes');
    if(sReturnValue=='Landscape'){ bPortrait=false;}
    if(sReturnValue=='Portrait'){ bPortrait=true;}

    window.open(_sBaseAddress + '/ProductionSchedule/PrintProductionScheduleFromTracking?sPSIDs='+sPSIDs+'&bPortrait='+bPortrait, '_blank'); // Print in Portrait

});


$('#txtBuyerRef').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchByReference();
    }
});

$('#txtOrderRef').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key-13
    {
        SearchByReference();
    }
});

function SearchByReference()
{
    if($.trim(document.getElementById('txtBuyerRef').value)=='' && $.trim(document.getElementById('txtOrderRef').value)=='')
    {
        alert("Please enter buyer or order reference. ");
        return;
    }
    var sValue=$.trim(document.getElementById('txtBuyerRef').value)+'~'+$.trim(document.getElementById('txtOrderRef').value);

    var nts=(new Date()).getTime()/1000;
    $.ajax({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+  "/ProductionSchedule/PSSeachByOrderBuyerRef",
        traditional: true,
        data:  JSON.stringify({sValue:sValue,nts:nts}),
        contentType: "application/json; charset=utf-8",
        success: function (data)
        {
                debugger;
                var oPSDs  = jQuery.parseJSON(data);
                if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
                {
                    _oPSDs= oPSDs;
                    RefreshControll();

                }
                else
                { alert(oPSDs[0].ErrorMessage); }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
}


$('#btnEdit').click(function(e)
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getChecked');

    if(oPSDs.length<=0)
    {
        alert("Please select an item.");
        return;
    }
    if(oPSDs.length>1){alert("Multiple selection exists. Please select only one.");  return;}
    var nProductionScheduleID= oPSDs[0].ProductionScheduleID;
    if(nProductionScheduleID>0)
    {
        var nts=(new Date()).getTime()/1000;
        $.ajax({
            type: "Get",
            dataType: "json",
            url: _sBaseAddress + "/ProductionSchedule/GetProductionSchedule",
            traditional: true,
            data:  {nID : nProductionScheduleID, nts:nts},
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var oProductionSchedule= jQuery.parseJSON(data);
                if(oProductionSchedule.ProductionScheduleID>0)
                {
                    ViewScheduleInformation(oProductionSchedule);
                }
                else
                {
                    alert(oProductionSchedule.ErrorMessage);
                }


            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }
    else
    {
        alert("Invalid request.");
    }

});


function ViewScheduleInformation(oProductionSchedule)
{
    var oParameter = new Object();
    oParameter.Name = "Schedule Information";
    oParameter.oProductionSchedule =  oProductionSchedule;

    var url =_sBaseAddress+ "/ProductionSchedule/ViewScheduleInformation?id="+oProductionSchedule.ProductionScheduleID;
    var sReturnValue = window.showModalDialog(url, oParameter,'dialogHeight:350px;dialogWidth:800px;dialogLeft:385;dialogTop:150;center:yes;resizable:no;status:no;scroll:yes');
    if(sReturnValue=='Modified')
    {

            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/ProductionSchedule/GetProductionScheduleTrackings",
                traditional: true,
                data:  JSON.stringify({sIDs:_sPSDIds,nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    var oPSDs  = jQuery.parseJSON(data);
                    if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
                    {
                        _oPSDs= oPSDs;
                        RefreshControll();

                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
    }
}


$('#btnCut').click(function(e)
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getChecked');

    if(oPSDs.length<=0)
    {
        alert("Please select an item.");
        return;
    }
    if(oPSDs.length>1){alert("Multiple selection exists. Please select only one.");  return;}
    var nProductionScheduleID= oPSDs[0].ProductionScheduleID;
    if(nProductionScheduleID>0)
    {
        var nts=(new Date()).getTime()/1000;
        $.ajax({
            type: "Get",
            dataType: "json",
            url: _sBaseAddress + "/ProductionSchedule/GetProductionSchedule",
            traditional: true,
            data:  {nID : nProductionScheduleID, nts:nts},
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var oProductionSchedule= jQuery.parseJSON(data);
                if(oProductionSchedule.ProductionScheduleID>0)
                {
                    _oPS=oProductionSchedule;
                    $('#tblScheduleDetail').datagrid('clearChecked');
                }
                else
                {
                    alert(oProductionSchedule.ErrorMessage);
                }


            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }
});

$('#btnPaste').click(function(e)
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getChecked');

    if(oPSDs.length<=0)
    {
        alert("Please select an item.");
        return;
    }
    if(oPSDs.length>1){alert("Multiple selection exists. Please select only one.");  return;}
    var nProductionScheduleID= oPSDs[0].ProductionScheduleID;
    if(nProductionScheduleID>0)
    {
        var nts=(new Date()).getTime()/1000;
        $.ajax({
            type: "Get",
            dataType: "json",
            url: _sBaseAddress + "/ProductionSchedule/GetProductionSchedule",
            traditional: true,
            data:  {nID : nProductionScheduleID, nts:nts},
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var oProductionSchedule= jQuery.parseJSON(data);
                if(oProductionSchedule.ProductionScheduleID>0)
                {
                    var oDateTime=new Date(oProductionSchedule.EndTimeInPerfect);
                    SchedulePaste(oProductionSchedule.LocationID,oProductionSchedule.PSSID,oDateTime.getDate(),(oDateTime.getMonth()+1),oDateTime.getFullYear(),oDateTime.getHours(),oDateTime.getMinutes())
                }
                else
                {
                    alert(oProductionSchedule.ErrorMessage);
                }


            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }
});

function RefreshObjectForPaste(nLocationID,nPSSID,nDate,nMonth,nYear,nHour,nMin)
{
    var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var nTempStartHourMinute=_oPS.StartTimeInPerfect.split(" ")[3];
    var nTempMinute=_oPS.EndTimeInPerfect.split(":")[1];
    var sStartTime=nDate+' '+Month[parseInt(nMonth)-1]+' '+nYear+' '+nTempStartHourMinute;
    var sEndTime=nDate+' '+Month[parseInt(nMonth)-1]+' '+nYear+' '+'00:' +nTempMinute;
    var oStartTime=new Date(sStartTime);
    var oEndTime=new Date(sEndTime);
    oEndTime= new Date(oEndTime.setHours( oStartTime.getHours() +_oPS.TimeDiffInHours));
    oEndTime= new Date(oEndTime.setMinutes( oEndTime.getMinutes() +1));

    _oPS.LocationID=nLocationID;
    _oPS.PSSID=nPSSID;
    _oPS.StartTime=oStartTime;
    _oPS.EndTime=oEndTime;
    return _oPS;

}

function SchedulePaste(nLocationID,nPSSID,nDate,nMonth,nYear,nHour,nMin,nView)
{
    if(_oPS==null){alert("Nothing found for paste."); return;}
    var oProductionSchedule=RefreshObjectForPaste(nLocationID,nPSSID,nDate,nMonth,nYear,nHour,nMin);
    var nts=(new Date()).getTime()/1000;
    $.ajax({
        type: "POST",
        dataType: "json",
        url: _sBaseAddress + "/ProductionSchedule/ScheduleInTimePeriod",
        data: JSON.stringify({oProductionSchedule:oProductionSchedule, nts: nts}),
        contentType: "application/json; charset=utf-8",
        success: function(data)
        {
            //debugger;
            nCount = jQuery.parseJSON(data);
            if (nCount>0)
            {
                if(confirm("Are you sure to increase time from next all schedules."))
                {
                    oProductionSchedule.bIncreaseTime=true;
                    SaveProductionSchedule(oProductionSchedule);
                }
            }
            else if(nCount==0)
            {
                oProductionSchedule.bIncreaseTime=false;
                SaveProductionSchedule(oProductionSchedule);
            }

        },
        error: function(xhr, status, error)
        {
            alert(error);
        }
    });
}


function SaveProductionSchedule(oProductionSchedule)
{
    $.ajax({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+  "/ProductionSchedule/Save",
        traditional: true,
        data:  JSON.stringify(oProductionSchedule),
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            debugger;
            oProductionSchedule = jQuery.parseJSON(data);
            _oPS=null;
            if (oProductionSchedule.ErrorMessage=="")
            {
                alert("Data Saved successfully");
                Refresh();
            }
            else
            {
                alert(oProductionSchedule.ErrorMessage);
            }

        },
        error: function (xhr, status, error) {
            alert(error);
        }
    });
}

$('#btnSwap').click(function(e)
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getChecked');

    if(oPSDs.length<2)
    {
        alert("Please select two items.");
        return;
    }
    if(oPSDs.length>2){alert("Please select only two items.");  return;}
    var nts=(new Date()).getTime()/1000;
    {
        var sPSIDs=oPSDs[0].ProductionScheduleID+','+oPSDs[1].ProductionScheduleID;
        $.ajax({
            type: "Post",
            dataType: "json",
            url: _sBaseAddress + "/ProductionSchedule/SwapProductionSchedule",
            traditional: true,
            data:   JSON.stringify({sPSIDs : sPSIDs, nts:nts}),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {

                var sMessage=jQuery.parseJSON(data);
                alert(sMessage);
                if(sMessage=="Swap Successfully") { Refresh(); }

            },
            error: function (xhr, status, error) {alert(error);}
        });
    }
});


function Refresh()
{
    var oPSDs = $('#tblScheduleDetail').datagrid('getRows');

    if(oPSDs.length<=0)
    {
        alert("please select at least one item");
        return;
    }
    var sPSIDs='';
    for(var i=0; i<oPSDs.length;i++)
    {

        if(oPSDs[i]!=null)
        {
            if(oPSDs[i].ProductionScheduleID>0){ sPSIDs=sPSIDs+oPSDs[i].ProductionScheduleID+',';}
        }
    }
    sPSIDs=sPSIDs.substring(0,sPSIDs.length-1);
    var nts=(new Date()).getTime()/1000;
    $.ajax({
        type: "POST",
        dataType: "json",
        url : _sBaseAddress+  "/ProductionSchedule/RefreshScheduleTrackings",
        traditional: true,
        data:  JSON.stringify({sIDs:sPSIDs,nts:nts}),
        contentType: "application/json; charset=utf-8",
        success: function (data)
        {
            debugger;
            var oPSDs  = jQuery.parseJSON(data);
            if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
            {
                _oPSDs= oPSDs;
                RefreshControll();

            }
        },
        error: function (xhr, status, error) {
            alert(error);
        }
    });

}

$('#txtProductName').keypress(function (e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13)//Enter key
    {
        var sProductName=$.trim($('#txtProductName').val());
        if(sProductName!="")
        {
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/ProductionSchedule/PSSeachByProductName",
                traditional: true,
                data:  JSON.stringify({sProductName:sProductName,nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    var oPSDs  = jQuery.parseJSON(data);
                    if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
                    {
                        _oPSDs= oPSDs;
                        RefreshControll();

                    }
                    else
                    { alert(oPSDs[0].ErrorMessage); }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }
        else{
            alert("Please enter valid product name ");
        }
    }
});


$('#btnDetail').click(function (e){
    var oParameter = new Object();
    oParameter.Name = "";
    oParameter.MultipleItemReturn=false;
    var tsv = ((new Date()).getTime()) / 1000;
    var url = _sBaseAddress + "/PTU/DEOForSchedulePlan?nDEOID=0&nts="+ tsv;
    var sReturnValue = window.showModalDialog(url, oParameter, 'dialogHeight:450px;dialogWidth:950px;dialogLeft:300;dialogRight:200;dialogTop:150;center:yes;resizable:no;status:no;scroll:no');
    if(sReturnValue=='Changes')
    {
        var nts=(new Date()).getTime()/1000;
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/ProductionSchedule/PSRefresh",
            traditional: true,
            data:  JSON.stringify({nts:nts}),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oPSDs  = jQuery.parseJSON(data);
                if (oPSDs.length>0 && oPSDs[0].ErrorMessage=="")
                {
                    _oPSDs= oPSDs;
                    RefreshControll();

                }
                else
                { alert(oPSDs[0].ErrorMessage); }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }
});

</script>
