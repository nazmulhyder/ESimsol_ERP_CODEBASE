@{
    ViewBag.Title = "FN Production";
}
@model ESimSol.BusinessObjects.FNBatch

<div class="menuMainCollectionTable" style="width:100%">
    <div id="divPanel" class="ics-panel-header" title="FN Batch" style="font-family:Tahoma;text-align:left; width:100%">
        <label> Treatment </label>
        @*<label style="padding-left:20px"> Treatment  </label>*@
        <select id="cboFNTreatment" class="cbo-styler" style="width:26%; height:22px; background-color:#EFF5FF; font-size:12px; font-weight:bold"></select>
    </div>
        <div id="divPanel" title="FN Batch" style="font-family:Tahoma;text-align:center; width:100%">
           <fieldset>
                <legend class="text-left">Search Criteria : </legend>
                <table border="0" cellpadding="1" cellspacing="1" style="margin:0 auto">
                    <tr>
                        <td style="width:15%; text-align:right;"><label class="text-right" style="padding-top:5px">Dispo No :</label></td>
                        <td style="width:20%;text-align:left;">
                            <input type="text" id="txtFNExONo" style="font-weight:bold; width:100%" placeholder="Type Dispo no & press enter" />
                        </td>
                        <td style="width:10%; text-align:left;">
                            <a id="btnPrintPB" href="javascript:void(0)" style="font-weight:bold" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Preview</a>
                        </td>
                        <td style="width:25%; text-align:right;"><label class="text-right" style="padding-top:5px">Batch/Lot No :</label></td>
                        <td style="width:20%;text-align:left;">
                            <input type="text" id="txtFNBatchNo" style="font-weight:bold;width:180px" placeholder="Type Batch no & press enter" />
                        </td>
                        <td style="width:10%; text-align:left;">
                            <a id="btnBatchPrint" style="float:left; font-weight:bold" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintBatch()">Preview</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
            <fieldset>
                <legend class="text-left">Batch Info</legend>
                <table border="0" cellpadding="1" cellspacing="1" style="margin:0 auto">
                    <tr>
                        <td style="width:8%; text-align:right;">MKT Ref No:</td>
                        <td style="width:16%;text-align:left;">
                            <input type="text" id="txtFabricNo" style="font-weight:bold;width:100%" placeholder="Marketing Ref. No.." disabled />
                        </td>
                        <td style="width:8%; text-align:right;">PO No :</td>
                        <td style="width:16%;text-align:left;">
                            <input type="text" id="txtSCNoFull" style="font-weight:bold;width:100%" placeholder="Marketing Ref. No.." disabled />
                        </td>
                        <td style="width:8%; text-align:right;">Customer :</td>
                        <td style="width:53%;text-align:left;" colspan="3">
                            @Html.TextBoxFor(model => model.BuyerName, new { style = "width:100%;", id = "txtBuyerName", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                    </tr>
                    <tr>
                        <td style="width:8%; text-align:right;">Dispo Qty:</td>
                        <td style="width:16%;text-align:left;">
                            @Html.TextBoxFor(model => model.ExeQty, new { style = "width:35%;  text-align:right", id = "txtExecutionOrderQtyYard", disabled = "disabled", @class = "reset-fnexe" })
                            (Y)
                            <input type="text" id="txtExecutionOrderQtyInMeter" style="width:35%;  text-align:right" class="reset-fnexe" disabled />
                            (M)
                        </td>
                        <td style="width:8%; text-align:right;">Construction:</td>
                        <td style="width:16%;text-align:left;">
                            @Html.TextBoxFor(model => model.Construction, new { style = "width:100%;", id = "txtConstruction", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                        <td style="width:13%; text-align:right;">Count:</td>
                        <td style="width:53%;text-align:left;" colspan="3">
                            @Html.TextBoxFor(model => model.CountName, new { style = "width:100%;", id = "txtCountName", disabled = "disabled", @class = "reset-fnexe" })
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
        <div style="height:375px; width:100%">
            <table id="tblFNBatchCard" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" showfooter="true" autorowheight="false" toolbar="#toolbarFNBatch">
                <thead>
                    <tr>
                        <th field="Code" width="10%">Code</th>
                        <th field="FNProcess" width="10%"> Process</th>
                        <th field="PlannedDateSt" width="10%">Plan Date</th>
                        <th field="StartQty" width="10%" align="right" formatter="formatPrice">Start Qty(Y)</th>
                        <th field="EndQty" width="10%" align="right" formatter="formatPrice">End Qty(Y)</th>
                        <th field="FNTreatmentSt" width="15%" align="left">Treatment</th>
                        <th field="QCStatusStr" width="10%" align="center">QC Status</th>
                        <th field="SequenceNo" width="10%" align="center">Sequence</th>
                        <th field="QCStatus" width="115" formatter="formatDoneInfo" align="center">QC Pass/Fail</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarFNBatch">
                @*<a id="btnUpdateProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-edit" plain="true">Production Process</a>*@
                <a id="btnAddProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-add" plain="true">Add New Process</a>
                <a id="btnSequenceProcess" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-add" plain="true">Sequence Process</a>

                @*<a id="btnPrintXL" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintXL()">WIP In XL</a>*@
                <a id="btnPrint_Production" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print_Production()">Production Statement</a>
                <a id="btnPrint" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print()">Batch Statement</a>
                <a id="btnPrint_Requisition" style="float:right" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintRequisitionStatement()">Requisition Statement</a>

            </div>
        </div>
    </div>

<div id="winFNPBatch" class=" easyui-window winclass" title="Update Process" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div id="divFNPB">
        <fieldset>
            <div style="width:1200px;font-size: 11px; font-weight: bold; padding-left:30px">
                <div class="col-md-12 top">
                    <div class="col-md-1" style="text-align: right"><label>Department:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtTreatment" style="width:76%" class="txt-styler" type="text" disabled />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Process:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtProcess" style="width:76%" class="txt-styler" type="text" disabled />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>User:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtUser" style="width:76%" class="txt-styler" type="text" disabled />
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="col-md-1" style="text-align: right"><label>Date:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="dtIssue" style="width:76%" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Machine:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboMachine" class="cbo-styler" style="width:76%; height:22px"></select>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Qty ST:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtProcessQty" style="width:34%" class="txt-styler number" type="text" disabled/>
                        <label>EN:</label><input id="txtProcessQty_End" style="width:33%" class="txt-styler number" type="text" />
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="col-md-1" style="text-align:right"><label>Shift:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboShift" class="cbo-styler" style="width:76%; height:22px"></select>
                    </div>
                   
                    <div class="col-md-1" style="text-align:right"><label>Start Batcher:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <div class="input-group" style="width:78%">
                            <input id="txtStartBatcherName" style="width:86%" onkeydown="SearchKeyStartBatcher(event)" placeholder="Start Batcher Name" />
                            <button type="button" aria-label="Left Align" onclick="btnSearchStartBatcher()"> P </button>
                        </div>
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>End Batcher:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <div class="input-group" style="width:78%">
                            <input id="txtEndBatcherName" style="width:86%" onkeydown="SearchKeyStartBatcher(event)" placeholder="End Batcher Name" />
                            <button type="button" aria-label="Left Align" onclick="btnSearchEndBatcher()"> P </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Start Date:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="dtStart" class="easyui-datetimebox" style="width:76%" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>End Date:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="dtEnd" class="easyui-datetimebox" style="width:76%" data-options="formatter:icsdatetimeformat,parser:icsdatetimeparser" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Pro. Hour:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtTtoalProHour" class="txt-styler" style="width:76%" type="text" disabled />
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Start Width:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtStartWidth" style="width:76%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>End Width:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtEndWidth" style="width:76%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Shade:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <select id="cboShade" class="cbo-styler" style="width:76%; height:22px"></select>
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label style="font-size:11px">Machine Speed:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtMachineSpeed_Actual" style="width:35%" class="txt-styler number" type="text" disabled/>
                        <input id="txtMachineSpeed" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right;"><label style="font-size:10px">Paddder Pressure:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtPressure_Bar_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtPressure_Bar" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Temp (C):</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtTemp_C_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtTemp_C" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                </div>
                <div class="col-md-12 bottom">
                    <div class="col-md-1" style="text-align: right"><label>Intensity:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtFlameIntensity_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtFlameIntensity" style="width:40%" class="txt-styler number" type="text" />
                    </div>
                    <div class="col-md-1" style="text-align: right"><label>Position:</label></div>
                    <div class="col-md-3" style="text-align: left">
                        <input id="txtFlamePosition" style="width:76%" class="txt-styler number" type="text" />
                        @*<input id="txtFlamePosition_Actual" style="width:35%" class="txt-styler number" type="text" disabled />
                        <input id="txtFlamePosition" style="width:40%" class="txt-styler number" type="text" />*@
                    </div>
                    <div class="col-md-1" style="text-align:right"><label>Remark:</label></div>
                    <div class="col-md-3" style=" text-align: left">
                        <input id="txtRemark" style="width:76%" class="txt-styler" type="text" />
                    </div>
                </div>
                @*Shade, StartWidth, EndWidth, Pressure_Bar, Temp_C, MachineSpeed, FlameIntensity, FlamePosition, Remark*@ 
            </div>
        </fieldset>
        <fieldset>
            <legend>Consumption Details:</legend>
            <table id="tblFNPConsumption" title="Process List" class="easyui-datagrid" style="width:100%;height:250px"
                   data-options="onClickCell : onClickCellPD, idField:'id',treeField:'code',singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false" toolbar="#toolbar_consumption">
                @*data-options=", rownumbers:'true'">*@
                <thead>
                    <tr>
                        <th field="ProductCode" width="10%" align="left">Code</th>
                        <th field="ProductName" width="12%" align="left">ProductName</th>
                        <th field="LotNo" width="10%" align="left">Lot No</th>
                        <th field="MUName" width="10%" align="left">M Unit</th>
                        <th field="LotBalance" width="10%" align="right">Lot Balance</th>
                        <th field="Qty" width="10%" align="center" editor="{type:'numberbox',options:{precision:3}}">Qty</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbar_consumption">
                <input id="txtProductName" style="width:16%" placeholder="Type Name & Press Enter.." /> @*onkeydown="SearchKeyStartBatcher(event)"*@ 
                <button type="button" aria-label="Left Align" onclick="PickProduct()"> Pick Dyes/Chem. </button>

                <input id="txtLotNo" style="width:16%" placeholder="Type Lot No & Press Enter.." /> @*onkeydown="SearchKeyStartBatcher(event)"*@
                <button type="button" aria-label="Left Align" onclick="PickLot()"> Update Lot </button>
                <button type="button" aria-label="Left Align" onclick="PickLotAll()"> Update Lot (All)</button>

                <button type="button" aria-label="Left Align" onclick="RemoveProductConsumption()"> Remove Product</button>
            </div>
        </fieldset>
        <div style="width:100%;">
            <fieldset>
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:80%; text-align:left">
                            <span>
                                <label id="lblRemarks"></label>
                            </span>
                        </td>
                        <td style="width: 10%">
                            <a id="btnSaveFNP" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width: 10%">
                            <a id="btnCloseFNP" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<div id="winFNPConsumption" class=" easyui-window winclass" title="Add Plan Date" style="width:600px" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div>
        <table id="tblFNPConsumption" title="Process List" class="easyui-datagrid" style="width:100%;height:500px"
               data-options="onClickCell : onClickCellPD, idField:'id',treeField:'code',singleSelect: true, fitColumns:false, rownumbers:true,pagination:false,autoRowHeight:false,toolbar: '#toolbar'">
            @*data-options=", rownumbers:'true'">*@
            <thead>
                <tr>
                    <th field="ProductCode" width="30%" align="left">Code</th>
                    <th field="ProductName" width="30%" align="left">ProductName</th>
                    <th field="Qty" width="30%" align="center" editor="{type:'number'}">Qty</th>
                    <th field="MUName" width="30%" align="left">M Unit</th>
                    <th field="LotNo" width="30%" align="left">Lot No</th>
                    <th field="LotBalance" width="30%" align="right">Lot Balance</th>
                    <th field="FNRNo" width="30%" align="left">Req. No</th>
                </tr>
                @*
                    ProductID = oFNR.ProductID,
                    ProductName = oFNR.ProductName,
                    ProductCode = oFNR.ProductCode,
                    FNPBatchID = oFNRecipe.FNPBatchID,
                    Qty = oFNRecipe.Qty,
                    LotID = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotID).FirstOrDefault(),
                    LotNo = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotNo).FirstOrDefault(),
                    LotBalance = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.LotBalance).FirstOrDefault(),
                    MUID = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.MeasurementUnitID).FirstOrDefault(),
                    MUName = oFNRequisitionDetails.Where(x => x.ProductID == oFNR.ProductID).Select(x => x.MUName).FirstOrDefault()
                *@
            </thead>
        </table>
        <div style="width:100%;">
            <fieldset>
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:80%; text-align:left">
                            <span>
                                @*<label id="lblRemarks"></label>*@
                            </span>
                        </td>
                        <td style="width: 10%">
                            <a id="btnSavePlanedDate" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width: 10%">
                            <a id="btnCloseFNPConsumption" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
</div>

<div id="winDone" class="easyui-window" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma">
        <fieldset style="margin-top:3px">
            <div align="left" style="padding:10px 10px 10px 10px">
                <table id="tblUser" border="0" style="font-size:12px;">
                    <tr>
                        <td style="text-align:right; width:15%"><label>QC Status :</label></td>
                        <td style="width:85%">
                            <select id="cboQCStatus" style="width:100%;">
                                <option value="">--Select One--</option>
                                <option value="2">QC Pass (OK)</option>
                                <option value="3">Qc Fail (Not OK)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right; width:15%"><label>Note :</label></td>
                        <td style="width:85%">
                            <input id="txtQCNote" type="text" required="required" style="width:100%;" />
                        </td>
                    </tr>
                </table>
            </div>
        </fieldset>
        <fieldset style="margin-bottom:3px">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                <tr>
                    <td style="width:300px; text-align:right"></td>
                    <td style="width:50px">
                        <a id="btnConfirm" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="Confirm()">Done</a>
                    </td>
                    <td style="width:50px">
                        <a id="btnCloseForDone" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

<div id="winBatch_Entry" class="easyui-window" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma">
        <fieldset style="margin-top:3px">
            <div align="left" style="padding:10px 10px 10px 10px">
                <table border="0" style="font-size:12px;">
                    <tr>
                        @*<td style="text-align:right; width:15%"><label>Process Code :</label></td>*@
                        <td style="width:15%; text-align:right;"><label class="text-right" style="padding-top:5px">Process :</label></td>
                        <td style="width:20%;text-align:left;">
                            <input type="text" id="txtFNProcess_Entry" style="font-weight:bold; width:76%" placeholder="Type Process name & press enter" />
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right; width:15%"><label>Plan Date :</label></td>
                        <td style="width:85%">
                            <input id="dtPlanDate_Entry" style="width:76%" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                        </td>
                    </tr>
                </table>
            </div>
        </fieldset>
        <fieldset style="margin-bottom:3px">
            <legend style="font-weight:bold"> Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:400px">
                <tr>
                    <td style="width:300px; text-align:right"></td>
                    <td style="width:50px">
                        <a id="btnSaveFNBatch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                    </td>
                    <td style="width:50px">
                        <a id="btnClose_Batch_Entry" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
</div>

<div id="winBatch_Sequence" class="easyui-window" style="width:800px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
    <div style="font-family:Tahoma; height:480px">
        <table id="tblFNBatchCard_Sequence" class="easyui-datagrid" fit="true" style="width:98%;height:480px" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" showfooter="true" autorowheight="false" toolbar="#toolbarFNBatch_Sequence">
            <thead>
                <tr>
                    <th field="Code" width="10%">Code</th>
                    <th field="FNProcess" width="10%"> Process</th>
                    <th field="PlannedDateSt" width="10%">Plan Date</th>
                    <th field="FNTreatmentSt" width="15%" align="left">Treatment</th>
                    <th field="QCStatusStr" width="10%" align="center">QC Status</th>
                    <th field="SequenceNo" width="10%" align="center">Sequence</th>
                </tr>
            </thead>
        </table>
        <div id="toolbarFNBatch_Sequence">
            <a id="btnUp_Process" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-up" plain="true" onclick="SetSequence(1)"> Process Up</a>
            <a id="btnDown_Process" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-down" plain="true" onclick="SetSequence(2)"> Process Down</a>
        </div>
    </div>
    <fieldset style="margin-bottom:3px">
        <legend style="font-weight:bold"> Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size:11px; width:98%">
            <tr>
                <td style="width:600px; text-align:right"></td>
                <td style="width:50px">
                    <a id="btnSaveFNBatchSequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                </td>
                <td style="width:50px">
                    <a id="btnClose_Batch_Sequence" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>

<style type="text/css">
     
     /*.form-control {
        height: 22px;
        padding: 0px 4px;
        font-size: 12px;
    }*/
     .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 10px;
        margin-top: 0px;
        margin-bottom: 5px;
    }
     .col-md-12 .top{
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-top: 10px;
    }
       .col-md-12 .bottom{
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 10px;
    }
     
     .col-md-1 {
        width: 8.3%;
        padding-right: 3px;
        padding-left: 0px;
    }
     .col-md-3 {
        width: 24%;
        padding-right: 3px;
        padding-left: 0px;
    }

     .col-md-9 {
        width: 72%;
        padding-right: 2px;
        padding-left: 2px;
    }

    .btn-sm {
        padding: 2px 7px;
    }

     .input-group-addon {
        padding: 3px 6px;
    }
</style>

<script type="text/javascript">
    var _sBaseAddress="";
    var _oFNBatchs=[];
    var BackLink = "";
    var _oFNBatch = [];
    var _nMenuid = 0;
    var FabricSCReport = [];
    var BatchObjForPrint = [];
    $(document).ready(function ()
    {
        debugger;
        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oFNBatchs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNBatchs));
        _oFNBatch =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        FabricSCReport = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricSCReport));
        var oWUs =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.WUs));
        var oFNTreatments =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNTreatments));
        
        oFNMachineProcessList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FNMachineProcessList));
        oShades = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Shades));
        oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.HRMShifts));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _nFNTreatment = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Treatment));

        $("#cboShift").icsLoadCombo({
            List: oHRMShifts,
            OptionValue: "ShiftID",
            DisplayText: "Name",
            InitialValue:"Default"
        });
        $("#cboMachine").icsLoadCombo({
            List: oFNMachineProcessList,
            OptionValue: "FNMachineID",
            DisplayText: "NameCode",
            InitialValue:"Default"
        });
        $("#cboFNTreatment").icsLoadCombo({
            List: oFNTreatments,
            OptionValue: "id",
            DisplayText: "Value",
            InitialValue:"Default"
        });
        //$("#cboStore").icsLoadCombo({
        //    List: oWUs,
        //    OptionValue: "WorkingUnitID",
        //    DisplayText: "WorkingUnitName",
        //    InitialValue:"Default"
        //});

        //$("#cboStore").data("WorkingUnitID", ((oWUs.length>0)? oWUs[0].WorkingUnitID: 0))
        $("#divPanel").data("FNExO",{});
        $("#divPanel").data("FNBatch",{});
        $('#txtFNExONo').focus();

        $('.number').icsCurrencyBox();
        $('#dtIssue').datebox('setValue',_oFNBatch.IssueDateStr);
        $('#dtDelivery').datebox('setValue',_oFNBatch.IssueDateStr);
        $('#txtFNExONo').data('FNExOID',_oFNBatch.FNExOID);
        $('#txtGLM').data('GLM',_oFNBatch.GLM);
        $("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(_oFNBatch.ExeQty,2)));
        $('#txtQtyMeter').val(formatPrice(GetMeter(_oFNBatch.Qty,2)));
        RefreshControl(FabricSCReport);
        $("#txtFNExONo").data('FNExOID',0);
    });
    function MakeFooterColumn(sTable, FieldNames)
    {
        var FooterField=[];
        var obj=new Object();

        obj['BuyerName']="Gross Total: ";
        for(var j=0; j<FieldNames.length;j++)
        {
            obj[FieldNames[j]]=GetSum(FieldNames[j],sTable);
        }
        FooterField.push(obj);
        $('#'+sTable).datagrid('reloadFooter',FooterField);
    }
    function GetSum(sFieldName,sTable)
    {
        debugger;
        var data=$('#'+sTable).datagrid('getRows').select(sFieldName);
        var sum = 0;

        for (i = 0; i < data.length; i++)
        {
            sum+=parseFloat(data[i]);
        }
        return sum;
    }

    /* ====QC OK / NOT OK ===== */
    function formatDoneInfo(value,row,index)
    {
        debugger;
        if(value==2)
        {
            return "<label style='color:green'>"+row.QCStatusStr+"</label>";
        }
        else if(value==3)
        {
            //return "<label style='color:red'>"+row.QCStatusStr+"</label>";

            return "<input type=button id='btnDone'"+index+" Value='Reprocess' style='width:65px;height:28px;text-align:center;vertical-align: middle' onclick='QC_Reprocess("+index+")' />";
        }
        else if(value==1)
        {
            return "<input type=button id='btnDone'"+index+" Value='Done' style='width:45px;height:28px;text-align:center;vertical-align: middle' onclick='QC_FaillPass("+index+")' />";
        }
    }

    $('#btnCloseForDone').click(function(e) {
        $("#winDone").icsWindow('close');
    });

    function QC_FaillPass(nIndex)
    {
        debugger;
        if (nIndex >= 0)
        {
            $('#tblFNBatchCard').datagrid('selectRow',nIndex);
            var oFNBatchCard = $('#tblFNBatchCard').datagrid('getSelected');

            if(parseInt(oFNBatchCard.QCStatus)!=1)
            {
                alert("Invalid QC Operation!");
                return;
            }

            $('#winDone').data("FNBatchCard_Index",nIndex);
            $('#winDone').data("FNBatchCard_QC",oFNBatchCard);

            $('#cboQCStatus').val(0);
            $('#txtQCNote').val("");
            $("#winDone").icsWindow('open','Update QC Status');
        }
        else
        {
            alert("Invalid Batch Card!");
            return;
        }
    }

    function Confirm() {
        debugger;
        var oFNBatchCard  = $('#winDone').data("FNBatchCard_QC");
        var nIndex = $('#winDone').data("FNBatchCard_Index");

        if (!confirm("Confirm to Update QC?")) return ;

        var bIsOK = ($('#cboQCStatus').val()==2 ? true : false);

        var oFNProductionBatchQuality = {
            FNPBQualityID:0,
            FNPBatchID:oFNBatchCard.FNPBatchID,
            IsOk : bIsOK,
            Remark: ( $('#txtQCNote').val()==undefined?"":$('#txtQCNote').val())
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FNProductionBatchQuality/Save",
            traditional: true,
            data:  JSON.stringify(oFNProductionBatchQuality),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var oFNPBQ = jQuery.parseJSON(data);
                if (oFNPBQ.ErrorMessage == "" || oFNPBQ.ErrorMessage == null)
                {
                    alert("Succefully Complete QC.");
                    $("#winDone").icsWindow('close');
                    var oRows=$('#tblFNBatchCard').datagrid('getRows');
                    oRows[nIndex].QCStatus = $('#cboQCStatus').val();
                    oRows[nIndex].QCStatusStr = oFNPBQ.QCStatusStr;
                    $('#tblFNBatchCard').datagrid('updateRow',{row: oRows[nIndex], index: nIndex});
                }
                else {
                    alert(oFNPBQ.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    function QC_Reprocess(nIndex)
    {
        debugger;
        if (nIndex >= 0)
        {
            $('#tblFNBatchCard').datagrid('selectRow',nIndex);
            var oFNBatchCard = $('#tblFNBatchCard').datagrid('getSelected');

            if(parseInt(oFNBatchCard.QCStatus)!=3)
            {
                alert("Invalid Reprocess !");
                return;
            }


            if (!confirm("Confirm to Update QC?")) return ;


            var oFNProductionBatchQuality = oFNBatchCard;

            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FNProductionBatchQuality/Reprocess",
                traditional: true,
                data:  JSON.stringify(oFNProductionBatchQuality),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oFNPBQ = jQuery.parseJSON(data);
                    if (oFNPBQ.ErrorMessage == "" || oFNPBQ.ErrorMessage == null)
                    {
                        alert("Succefully Reprocessed.");
                        $("#winDone").icsWindow('close');
                        var oRows=$('#tblFNBatchCard').datagrid('getRows');
                        oRows[nIndex].QCStatus = 4;
                        oRows[nIndex].QCStatusStr = oFNPBQ.QCStatusStr;
                        $('#tblFNBatchCard').datagrid('updateRow',{row: oRows[nIndex], index: nIndex});
                    }
                    else {
                        alert(oFNPBQ.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }
        else
        {
            alert("Invalid Batch Card!");
            return;
        }
    }

    /* ===== END ====== */

    function Print()
    {
        var oFNBatch = $("#divPanel").data("FNBatch"); // $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID == undefined || oFNBatch.FNBatchID <=0 )
        {
            alert("Please select a batch first.");
            return ;
        }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/Print_FNPProcess_Consumtion?nFNBatchID="+oFNBatch.FNBatchID+"&nBUID="+_nBUID+"&treatment="+_nFNTreatment+"&nts="+tsv);
    }
    function Print_Production()
    {
        var oFNBatch = $("#divPanel").data("FNBatch"); // $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNExOID == undefined || oFNBatch.FNExOID <=0 )
        {
            alert("Please select a dispo first.");
            return ;
        }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/Print_FNProduction_Consumtion?nID="+oFNBatch.FNExOID+"&nBUID="+_nBUID+"&treatment="+_nFNTreatment+"&nts="+tsv);
    }

    function PrintRequisitionStatement()
    {
        if (parseInt($("#txtFNExONo").data('FNExOID')) <=0 )
        {
            alert("Please select a dispo first.");
            return ;
        }
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/PrintRequisitionStatement?nID="+parseInt($("#txtFNExONo").data('FNExOID'))+"&nBUID="+_nBUID+"&treatment="+_nFNTreatment+"&nts="+tsv);
    }

    $('#btnPrintPB').click(function (e)
    {
        var oFNExO=$("#divPanel").data("FNExO");
        if(oFNExO.FabricID==undefined || oFNExO.FabricID<=0){ alert("Please pick a dispo first & try again!"); $('#txtFNExONo').focus(); return; }
        console.log(oFNExO);
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+ "/FNBatch/Print_FNPProcess?nFabricID="+oFNExO.FabricID+"&nBUID="+_nBUID+"&nts="+tsv, "_blank");
    });
    function PrintXL()
    {
        var tsv=((new Date()).getTime())/1000;
        window.open(_sBaseAddress+"/FNBatch/PrintXL?buid="+_nBUID+"&nTreatment="+_nFNTreatment+"&sDateCriteria=''&nts="+tsv);
    }
    function PrintBatch()
    {
        if($('#txtFNBatchNo').val() == "")
        {
            alert("Please Enter The lot No");
            return;
        }
        window.open(_sBaseAddress+"/FNBatch/PrintBatch?buid="+_nBUID+"&treatment="+_nFNTreatment+"&nFNBatchID="+BatchObjForPrint.FNBatchID);
    }

    function RefreshList(oFNBatchs)
    {
        debugger;
        $('#tblFNBatchCard').empty();
        data = oFNBatchs;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblFNBatchCard').datagrid('loadData', data);

        if(parseInt(sessionStorage.getItem("SelectedRowIndexBatch"))>0 && sessionStorage.getItem("OperationSave")=="OperationSave")
        {
            $('#tblFNBatchCard').datagrid('selectRow',parseInt(sessionStorage.getItem("SelectedRowIndexBatch")));
        }
    }
    function ResetFNExe()
    {
        $('.reset-fnexe').val("");
        $('#txtGLM').val($('#txtGLM').data('GLM'));
        $('#txtFNExONo').data('FNExOID',0);
        $('#txtQtyYard').data('YetToOutQty',0);
        $('#txtQtyYard,#txtQtyMeter').val('');
        $('#txtFabricNo').val("");
        $('#txtSCNoFull').val("");
        $('#txtFNBatchNo').val("");
        $("#txtFNExONo").data('FNExOID',0);
        DynamicRefreshList([],'tblFNBatchCard');
    }

    //------------PICK FSCD REPORT --------------//
    $('#txtFNExONo').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) {
            GetFNExeNo();
        }
        else if(code==27 || code==08){
            ResetFNExe();
            ResetFNBatch();
        }
    });
    function RefreshControl(FabricSCReport)
    {
        $('#txtQtyYard').val(formatPrice(FabricSCReport.Qty-FabricSCReport.Qty_PRO));
        $('#txtQtyMeter').val(formatPrice(GetMeter(FabricSCReport.Qty-FabricSCReport.Qty_PRO)));
        $('#txtQtyYard').data('YetToOutQty',FabricSCReport.Qty-FabricSCReport.Qty_PRO);
        $("#txtFNExONo").data('FNExOID',FabricSCReport.FabricSalesContractDetailID);
        $("#txtFNExONo").val(FabricSCReport.ExeNo);
        $("#txtFNExONo").addClass("fontColorOfPickItem");

        $("#txtCountName").val(FabricSCReport.ProductName);
        $('#txtBuyerName').val(FabricSCReport.BuyerName);
        $('#txtConstruction').val(FabricSCReport.Construction);
        $('#txtFinishWidth').val(FabricSCReport.FinishWidth);
        $('#txtFabricNo').val(FabricSCReport.FabricNo);
        $('#txtSCNoFull').val(FabricSCReport.SCNoFull);
        $('#txtFinishTypeName').val(FabricSCReport.FinishTypeName);
        $('#txtFabricWeaveName').val(FabricSCReport.FabricWeaveName);
    }
    function SetFNExO(oreturnobj)
    {
        $('#txtQtyYard').val(formatPrice(oreturnobj.Qty-oreturnobj.Qty_PRO));
        $('#txtQtyMeter').val(formatPrice(GetMeter(oreturnobj.Qty-oreturnobj.Qty_PRO)));
        $('#txtQtyYard').data('YetToOutQty',oreturnobj.Qty-oreturnobj.Qty_PRO);
        $("#txtFNExONo").data('FNExOID',oreturnobj.FabricSalesContractDetailID);
        $("#txtFNExONo").val(oreturnobj.ExeNo);
        $("#txtFNExONo").addClass("fontColorOfPickItem");
        //$("#txtExecutionOrderQtyYard").val(formatPrice(oreturnobj.Qty));
        //$("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(oreturnobj.Qty,2)));
        $("#txtCountName").val(oreturnobj.ProductName);
        $('#txtBuyerName').val(oreturnobj.BuyerName);
        $('#txtConstruction').val(oreturnobj.Construction);
        $('#txtFinishWidth').val(oreturnobj.FinishWidth);
        $('#txtFinishTypeName').val(oreturnobj.FinishTypeName);
        $('#txtFabricWeaveName').val(oreturnobj.FabricWeaveName);
        $('#txtFabricNo').val(oreturnobj.FabricNo);
        $('#txtSCNoFull').val(oreturnobj.SCNoFull);
        $('#txtFNBatchNo').focus();
        /*---------- Set FN Exe Order ----------------*/
        var oFNBatch = {
            FNExOID: oreturnobj.FabricSalesContractDetailID,
            FabricID:oreturnobj.FabricID,
            FabricWidth:oreturnobj.FabricWidth,
            Shrinkage:oreturnobj.Shrinkage
        }
        $("#divPanel").data("FNExO",oFNBatch);
    }

    $("#btnProductPick").click(function () {
        GetFNExeNo()
    });
    function GetFNExeNo()
    {
        if ($.trim($("#txtFNExONo").val()).length == 0) {
            alert("Type Dispo no to search.");
            $("#txtFNExONo").focus();
            return false;
        }

        $('#txtFNBatchNo').val("");
        ResetFNBatch();

        var oFNEO = {
            ExeNo: $.trim($("#txtFNExONo").val())
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNEO,
            ControllerName: "FNBatch",
            ActionName: "GetsByFNExONo",
            IsWinClose: false
        };

        debugger;
        var tblColums = []; var oColumn = { field: "ExeNo", title: "Dispo No", width: 70, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Qty", width: 50, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "Count", width: 120, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Construction", title: "Construction", width: 100, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "BuyerName", title: "Customer", width: 120, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "FabricWeaveName", title: "FabricWeaveName", width: 90, align: "left" }; tblColums.push(oColumn);

        var oPickerParam = {
            winid: 'winFSCDs',
            winclass: 'clsFSCD',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFSCDs',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ExeNo',
            windowTittle: 'Dispo List',
            paramObj: obj,
            pkID: 'FabricSalesContractDetailID',
            callBack: SetFNExO
        };

        $.icsDynamicPicker(oPickerParam);
    }
    //------------END FSCD REPORT --------------//


    //------------PICK FN BATCH --------------//
    $('#txtFNBatchNo').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            //if ($.trim($("#txtFNBatchNo").val()).length == 0) {
            //    alert("Please Type Batch No To Search !");
            //    $("#txtFNBatchNo").focus();
            //    return false;
            //}

            PickFNBatch( $.trim($("#txtFNBatchNo").val()) );
        }
        else if(code==27 || code==08){
            ResetFNBatch();
        }
    });
    function ResetFNBatch()
    {
        DynamicRefreshList([],'tblFNBatchCard');
    }
    function PickFNBatch(oTxtName)
    {
        //var oStyleSearch = {BuyerName:(typeof(oTxtName) != 'undefined'?oTxtName:"")};//
        var oFNExO=$("#divPanel").data("FNExO");
        if(oFNExO.FNExOID==undefined || oFNExO.FNExOID<=0){ alert("Please pick a dispo first & try again!"); $('#txtFNExONo').focus(); return; }
        //console.log(oFNExO);
        var oStyleSearch = {
            FNExOID: oFNExO.FNExOID,
            BatchNo: (typeof(oTxtName) != 'undefined'?oTxtName:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetsFNBatch",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "FNExONo", title: "Dispo No", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "BatchNo", title: "Batch No", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "FNBatchStatusStr", title: "Status", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('FNBatch',obj,tblColums,false,'BatchNo','FNBatchID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }
    function SetBatch(oSelectedBatch) {
        debugger;
        document.getElementById("txtFNBatchNo").style.color = "green";
        document.getElementById("txtFNBatchNo").style.fontWeight = "bold";
        document.getElementById("txtFNBatchNo").value = oSelectedBatch.BatchNo;

        $("#txtExecutionOrderQtyYard").val(formatPrice(oSelectedBatch.Qty));
        $("#txtExecutionOrderQtyInMeter").val(formatPrice(GetMeter(oSelectedBatch.Qty,2)));

        $("#divPanel").data("FNBatch",oSelectedBatch);
        oSelectedBatch.FNTreatmentProcessID=_nFNTreatment;
        BatchObjForPrint = oSelectedBatch;
        GetFNBatchCard(oSelectedBatch);
        $("#txtFNBatchNo").focus();
    }
    function GetFNBatchCard(oFNBatch)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNBatch,
            ControllerName: "FNBatch",
            ActionName: "GetsFNBatchCard",
            IsWinClose: false
        };
        $.icsDataGet(obj, function (response)
        {
            if (response.status && response.obj!=null)
            {
                DynamicRefreshList(response.obj,'tblFNBatchCard');
            }
        });
    }
    //------------END FN BATCH --------------//

    //------------PICK FN BATCHER --------------//
    function SearchKeyStartBatcher(e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            if ($.trim($("#txtStartBatcherName").val()).length == 0) {
                alert("Please Type Batch Name To Search !");
                $("#txtStartBatcherName").focus();
                return false;
            }
            PickFNBatcher(true, $.trim($("#txtFNBatchNo").val()));
        }
        else if(code==27 || code==08){
            ResetFNBatcher_Start();
        }
    };
    function SearchKeyEndBatcher(e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            if ($.trim($("#txtEndBatcherName").val()).length == 0) {
                alert("Please Type Batch Name To Search !");
                $("#txtEndBatcherName").focus();
                return false;
            }
            PickFNBatcher(false, $.trim($("#txtEndBatcherName").val()));
        }
        else if(code==27 || code==08){
            ResetFNBatcher_End();
        }
    };
    function ResetFNBatcher_Start()
    {
        $("#divFNPB").data('FNBatcher_Start',{});
    }
    function ResetFNBatcher_End()
    {
        $("#divFNPB").data('FNBatcher_End',{});
    }

    function btnSearchStartBatcher()
    {
        PickFNBatcher(true,"");
    }
    function btnSearchEndBatcher()
    {
        PickFNBatcher(false,"");
    }

    function PickFNBatcher(bIsStartBatcher,sBatcherName)
    {
        var oFNMachine = {
            Name: $.trim(sBatcherName),
            Params:"2,3"//Batcher = 2,Trolly=3
        };

        var obj = {
            BaseAddress:_sBaseAddress,
            Object: oFNMachine,
            ControllerName: "FNMachine", //TechnicalSheet
            ActionName: "GetFNMachines",//ViewStyleSearch
            IsWinClose: false
        };

        var tblColums = [];
        var oColumn = { field: "Code", title: "Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Name", title: "Name", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "FNMachineTypeSt", title: "Type", width: 90, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "FreeTime", title: "Free Time", width: 90, align: "left" }; tblColums.push(oColumn);

        sessionStorage.setItem('bIsStartBatcher',bIsStartBatcher);
        //DynamicPiker('FNBatcher',obj,tblColums,false,'Name','FNMachineID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winFNBatchers',
            winclass: 'clsFNBatcher',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBatchers',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'Name',
            windowTittle: 'Bathcer List',
            paramObj: obj,
            pkID: 'FNMachineID',
            callBack: SetBatcher
        };

        $.icsDynamicPicker(oPickerParam);

    }
    function SetBatcher(result) {
        debugger;
        var bIsStartBatcher = sessionStorage.getItem('bIsStartBatcher');
        if(bIsStartBatcher=="true")
        {
            //$scope.StartBatcherName = result.Name+'['+result.Code+']';
            //$scope.FNProductionBatch.StartBatcherID = result.FNMachineID;

            $('#txtStartBatcherName').val(result.Name+'['+result.Code+']');
            $('#divFNPB').data('FNBatcher_Start',result);
            $('#txtEndBatcherName').focus();
        }
        else{
            //$scope.EndBatcherName = result.Name+'['+result.Code+']';
            //$scope.FNProductionBatch.EndBatcherID = result.FNMachineID;

            $('#txtEndBatcherName').val(result.Name+'['+result.Code+']');
            $('#divFNPB').data('FNBatcher_End',result);
            //$('#txtFNBStartTime').focus();
        }
    }
    //------------END FN BATCH --------------//

    //------------PICK FN PRODUCT --------------//
    $('#txtProductName').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            //if ($.trim($("#txtFNBatchNo").val()).length == 0) {
            //    alert("Please Type Batch No To Search !");
            //    $("#txtFNBatchNo").focus();
            //    return false;
            //}

            PickProduct( $.trim($("#txtProductName").val()) );
        }
        else if(code==27 || code==08){
            //ResetProduct();
        }
    });
    function PickProduct(oTxtName)
    {
        var oStyleSearch = {
            BUID: _nBUID,
            ProductName: (typeof(oTxtName) != 'undefined'?oTxtName:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetProducts",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "ProductCode", title: "Product Code", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 280, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "Qty", title: "Qty", width: 90, align: "right" }; tblColums.push(oColumn);
        //oColumn = { field: "FNBatchStatusStr", title: "Status", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winFNBatchProducts',
            winclass: 'clsFNBatchProduct',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBatchProducts',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetProduct
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function RemoveProductConsumption()
    {
        var oFNPConsumption = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPConsumption ==null || oFNPConsumption.ProductID <=0 ) { alert("Please select an item from list."); return ; }
        //  if (oFNPConsumption.FNPConsumptionID > 0) { alert("Please select an initialized item from the list."); return ; }

        if(confirm("Confirm to remove product: "+ oFNPConsumption.ProductName +"?"))
        {
            var nRowIndexBank = $("#tblFNPConsumption").datagrid("getRowIndex", oFNPConsumption);

            alert("Delete successfully.");
            $("#tblFNPConsumption").datagrid("deleteRow", nRowIndexBank);
        }
        editIndex = undefined;
    }
    function SetProduct(result)
    {
        if(result.ProductID>0)
        {
            $('#txtProductName').val('');
            result.FNPBatchID=parseInt($('#divFNPB').data('FNPBatchID'));
            result.FNPBatchID =$('#divFNPB').data('FNPBatchID');
            $('#tblFNPConsumption').datagrid('appendRow',result);
        }
    }
    //------------PICK FN PRODUCT ENDS--------------//


    //------------PICK LOT --------------//
    $('#txtLotNo').keydown(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            PickLot( $.trim($("#txtLotNo").val()) );
        }
        else if(code==27 || code==08){
            //ResetProduct();
        }
    });
    function PickLot(txtLotNo)
    {
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPBatch ==null || oFNPBatch.ProductID <=0 ) { alert("Please select an item from list."); return ; }
        //oFNBatchCard.FSCDID=$("#txtFNExONo").data('FNExOID');

        var oStyleSearch = {
                BUID: _nBUID,
                Params: $("#divPanel").data("FNExO").FNExOID,
                ProductID: oFNPBatch.ProductID,
                LotNo: (typeof(txtLotNo) != 'undefined'?txtLotNo:"")
            };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetLots",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "LotNo", title: "Lot No", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 280, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Balance", title: "Balance", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "OperationUnitName", title: "Store", width: 150, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winLots',
            winclass: 'clsLot',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblLots',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetLot
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function PickLotAll(txtLotNo)
    {
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        if (oFNPBatch ==null || oFNPBatch.ProductID <=0 ) { alert("Please select an item from list."); return ; }
        //oFNBatchCard.FSCDID=$("#txtFNExONo").data('FNExOID');

        var oStyleSearch = {
            BUID: _nBUID,
            ProductID: oFNPBatch.ProductID,
            LotNo: (typeof(txtLotNo) != 'undefined'?txtLotNo:"")
        };

        //console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "FNBatch", //TechnicalSheet
            ActionName: "GetLots",//ViewStyleSearch
            IsWinClose: false
        };
        var tblColums = []; var oColumn = { field: "LotNo", title: "Lot No", width: 80, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "ProductName", title: "ProductName", width: 280, align: "left" }; tblColums.push(oColumn);
        oColumn = { field: "Balance", title: "Balance", width: 90, align: "right" }; tblColums.push(oColumn);
        oColumn = { field: "OperationUnitName", title: "Store", width: 150, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "CountName", title: "Count", width: 90, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "BuyerName", title: "Buyer Name", width: 90, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('FNBatchProduct',obj,tblColums,false,'ProductName','ProductID'); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID

        var oPickerParam = {
            winid: 'winLots',
            winclass: 'clsLot',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblLots',
            tablecolumns: tblColums,
            multiplereturn: false,
            searchingbyfieldName: 'ProductName',
            windowTittle: 'Product List',
            paramObj: obj,
            pkID: 'ProductID',
            callBack: SetLot
        };

        $.icsDynamicPicker(oPickerParam);
    }
    function SetLot(result)
    {
        var oFNPBatch = $('#tblFNPConsumption').datagrid('getSelected');
        var nIndex = $('#tblFNPConsumption').datagrid('getRowIndex',oFNPBatch);
        if(result.LotID>0 && oFNPBatch.ProductID>0)
        {
            $('#txtLotNo').val('');
            //result.FNPBatchID=parseInt($('#divFNPB').data('FNPBatchID'));
            //result.FNPBatchID =$('#divFNPB').data('FNPBatchID');
            oFNPBatch.LotID = result.LotID;
            oFNPBatch.LotNo = result.LotNo;
            oFNPBatch.LotBalance = result.Balance;
            oFNPBatch.MUID = result.MUID;
            oFNPBatch.FNRDetailID = result.FNRDetailID;

            //FNRD.ProductID, FNRD.ProductCode, FNRD.ProductName, FNRD.LotID, FNRD.LotNo, FNRD.MeasurementUnitID, FNRD.MUName

            $('#tblFNPConsumption').datagrid('updateRow',{row: oFNPBatch, index: nIndex});
        }
    }
    //------------PICK FN PRODUCT ENDS--------------//

    function ValidateInput()
    {
        if(parseInt($('#txtFNExONo').data('FNExOID'))<=0)
        {
            alert("Dispo No order required.!");
            $('#txtFNExONo').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($('#txtQtyYard').val()))<=0)
        {
            alert("Issue qty required!");
            $('#txtQtyYard').focus();
            return false;
        }
        return true;
    }
    function RefreshObject()
    {
        debugger;
        var oFNBatch= {
            FNBatchID : 0,
            FNExOID : parseInt($("#txtFNExONo").data('FNExOID')),
            Qty: icsRemoveComma($('#txtQtyYard').val()),
            FNBatchStatus : _oFNBatch.FNBatchStatus,
            GLM : 0,// icsRemoveComma($('#txtGLM').val()),
            FNPPID :_oFNBatch.FNPPID ,
            IssueDate : $('#dtIssue').datebox('getValue'),
            ExpectedDeliveryDate:$('#dtDelivery').datebox('getValue')// $('#dtDelivery').datebox('getValue'),
        };
        debugger;
        return oFNBatch;
    }
    function Save()
    {
        debugger;
        if(!ValidateInput()) return;
        var oFNBatch=RefreshObject();
        var nBatchQty = $('#txtQtyMeter').val();
        var nBalance = parseInt($('#lblBalance').text());
        if(parseInt(nBalance)<=0)
        {
            alert("You Cannot Add More Quantity Than Balance ");
            return;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/FNBatch/Save",
            traditional: true,
            data:  JSON.stringify(oFNBatch),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oResult = jQuery.parseJSON(data);
                if (oResult.ErrorMessage=="") {
                    alert("Data Saved sucessfully");
                    sessionStorage.setItem("SelectedRowIndexBatch", _oFNBatchs.length);
                    sessionStorage.setItem("OperationSave", "OperationSave");
                    $('#tblFNBatchCard').datagrid('appendRow',oResult);
                    //location.reload();
                    MakeFooterColumn('tblFNBatchCard', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndexBatch"));
                    $('#tblFNBatchCard').datagrid('selectRow',nIndex);
                }
                else {
                    alert(oResult.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });

    }
    $('#btnDelete').click(function(e){
        var oFNBatch = $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        //if (parseFloat(oFNBatch.OutQty)>0 ) { alert("Unable to delete. Already Update Process."); return ; }
        if (!confirm("Confirm to delete?")) return;
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatch,
            ControllerName: "FNBatch",
            ActionName: "Delete",
            TableId: "tblFNBatchCard",
            IsWinClose: false
        };

        $.ajax({
            type: "POST",
            dataType: "json",
            url: obj.BaseAddress + "/" + obj.ControllerName + "/" + obj.ActionName,
            traditional: true,
            data: JSON.stringify(obj.Object),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sMessage = jQuery.parseJSON(data);
                if (sMessage != null) {
                    if (sMessage.toLowerCase() == "deleted")
                    {
                        alert("Delete successfully.");
                        if ($.trim(obj.TableId).length)
                        {
                            var oSelectedObject = $("#" + obj.TableId).datagrid("getSelected");
                            var nRowIndexBank = $("#" + obj.TableId).datagrid("getRowIndex", oSelectedObject);
                            $("#" + obj.TableId).datagrid("deleteRow", nRowIndexBank);
                        }
                        MakeFooterColumn('tblFNBatchCard', ['Qty','QtyInMtr','OutQty','OutQtyInMtr']);
                    }
                    else {
                        alert(sMessage);
                    }
                }
                else { alert("Operation Unsuccessful."); }

                if (defaultSettings.IsWinClose) { IcsWindowClose(oActiveWindows); };
                if (callback != null) { return callback({ status: true, Message: sMessage.toLowerCase() }); }
            },
            error: function (xhr, status, error) {
                alert(error);
                if (callback != null) { return callback({ status: false, Message: "" }); }
            }
        });
        //location.reload();
    });
    function Close()
    {
        debugger;
        //var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
        //sessionStorage.setItem("SelectedRowIndex",nIndex);
        //var FabricSalesContractID = parseInt(sessionStorage.getItem("FabricSalesContractID"));
        //$.ajax({
        //    type: "GET",
        //    dataType: "json",
        //    url : _sBaseAddress+"/FNBatch/GetFabricSaleReport",
        //    traditional: true,
        //    data: { nId: FabricSalesContractID},
        //    contentType: "application/json; charset=utf-8",
        //    success: function (data) {
        //        debugger;
        //        var oResult = jQuery.parseJSON(data);
        //        if(oResult.FabricSalesContractID>0)
        //        {
        //            sessionStorage.setItem("FabricSCReport",oResult);
        //        }


        //    },
        //    error: function (xhr, status, error) {
        //        alert(error);
        //    }

        //});
        //window.location.href = sessionStorage.getItem('BaseAddress')+ "/FNBatch/ViewFNBatchs_FSC?menuid="+_nMenuid;
        window.location.href = sessionStorage.getItem("BackLink");
    }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('div').icsWindow('close'); } });

    function Reset_FNP(oFNBatchCard, oRecipe)
    {
        var oFSCD  =  $("#divPanel").data("FNExO");
        var oFNBatch = $("#divPanel").data("FNBatch");
        //console.log("RESET::",oFNBatchCard);
        $('#divFNPB').data('FNBatchID',oFNBatchCard.FNBatchID);
        $('#divFNPB').data('FNBatchCardID',oFNBatchCard.FNBatchCardID);
        $("#divFNPB").data('FNBatcher_Start',{});
        $("#divFNPB").data('FNBatcher_End',{});
        $('#txtStartBatcherName').val("");
        $('#txtEndBatcherName').val("");

        $('#txtBatchNo').val(oFNBatchCard.BatchNo);
        $('#txtProcess').val(oFNBatchCard.FNProcess);
        $('#txtUser').val(oFNBatchCard.PreparedByName);
        $('#cboShift').val(0);
        $('#cboMachine').val(0);

        debugger;
        $('#txtProcessQty').val(0);
        if(oFNBatchCard.SequenceNo==1)
        {
            $('#txtProcessQty').val(oFNBatch.Qty);
            $('#txtStartWidth').val(0.00);
        }
        else
        {
            $('#txtProcessQty').val(oFNBatchCard.Qty_End_Prv);
            $('#txtStartWidth').val(oFNBatchCard.FabricWidth_End_Prv);
        }
        $('#txtProcessQty_End').val(0);

        $('#txtEndWidth').val(0.0);
        $('#txtPressure_Bar').val(0);
        $('#txtTemp_C').val(0.0);
        $('#txtMachineSpeed').val(0);
        $('#txtFlameIntensity').val(0);
        $('#txtFlamePosition').val(0);

        $('#txtPressure_Bar').val(oRecipe.Pressure_Bar);
        $('#txtTemp_C').val(oRecipe.Temp_C);
        $('#txtMachineSpeed').val(oRecipe.MachineSpeed);
        $('#txtFlameIntensity').val(oRecipe.FlameIntensity);
        $('#txtFlamePosition').val(oRecipe.FlamePosition);

        $('#txtPressure_Bar_Actual').val(oRecipe.Pressure_Bar_Actual);
        $('#txtTemp_C_Actual').val(oRecipe.Temp_C_Actual);
        $('#txtMachineSpeed_Actual').val(oRecipe.MachineSpeed_Actual);
        $('#txtFlameIntensity_Actual').val(oRecipe.FlameIntensity_Actual);
        $('#txtFlamePosition_Actual').val(oRecipe.FlamePosition_Actual);

        $('#txtShade').val(0);
        $('#txtRemark').val("");
        debugger;
        $('#txtTreatment').val(oFNBatchCard.FNTreatmentSt);
        //$('#dtIssue,#dtExpDelivery').datebox({'disabled':true})
        $('#dtIssue').datebox('setValue',icsdateformat(new Date()));
        $('#dtStart').datetimebox('setValue',icsdatetimeformat(new Date()));
        $('#dtEnd').datetimebox('setValue',icsdatetimeformat(new Date()));

        DynamicRefreshList([],'tblFNPConsumption');
        //$('#dtExpDelivery').datebox('setValue',response.obj.ExpectedDeliveryDateStr);
        //$('#txtCount').val(response.obj.CountName);
        //$('#txtConstruction').val(response.obj.Construction);
        //$('#txtProcessQty').val(formatPrice(oFNBatchCard.Qty));
    }
    function Set_FNP(oFNPBatch, oFNBC)
    {
        //console.log("SET::",oFNBatchCard);
        $('#divFNPB').data('FNBatchID',oFNPBatch.FNBatchID);
        $('#divFNPB').data('FNBatchCardID',oFNPBatch.FNBatchCardID);
        $('#divFNPB').data('FNPBatchID',oFNPBatch.FNPBatchID);
        $("#divFNPB").data('FNBatcher_Start', { FNMachineID: oFNPBatch.StartBatcherID });
        $("#divFNPB").data('FNBatcher_End', { FNMachineID: oFNPBatch.EndBatcherID });

        $('#txtBatchNo').val(oFNPBatch.BatchNo);
        $('#txtProcess').val(oFNPBatch.FNProcess);
        $('#txtUser').val(oFNPBatch.PreparedByName);
        $('#cboShift').val(oFNPBatch.ShiftID);
        $('#cboShade').val(oFNPBatch.ShadeID);
        $('#cboMachine').val(oFNPBatch.FNMachineID);
        debugger;

        $('#txtTreatment').val(oFNPBatch.FNTreatmentSt);
        $('#txtStartBatcherName').val(oFNPBatch.StartBatcherName);
        $('#txtEndBatcherName').val(oFNPBatch.EndBatcherName);

        $('#txtEndWidth').val(oFNPBatch.EndWidth);
        $('#txtPressure_Bar').val(oFNPBatch.Pressure_Bar);
        $('#txtTemp_C').val(oFNPBatch.Temp_C);
        $('#txtMachineSpeed').val(oFNPBatch.MachineSpeed);
        $('#txtFlameIntensity').val(oFNPBatch.FlameIntensity);
        $('#txtFlamePosition').val(oFNPBatch.FlamePosition);

        $('#txtPressure_Bar_Actual').val(oFNPBatch.Pressure_Bar_Actual);
        $('#txtTemp_C_Actual').val(oFNPBatch.Temp_C_Actual);
        $('#txtMachineSpeed_Actual').val(oFNPBatch.MachineSpeed_Actual);
        $('#txtFlameIntensity_Actual').val(oFNPBatch.FlameIntensity_Actual);
        $('#txtFlamePosition_Actual').val(oFNPBatch.FlamePosition_Actual);

        $('#txtShade').val(oFNPBatch.ShadeID);
        $('#txtRemark').val(oFNPBatch.Remark);
        //$('#dtIssue,#dtExpDelivery').datebox({'disabled':true})   StartDateTime : $('#dtStart').datetimebox('getValue'),  EndDateTime : $('#dtEnd').datetimebox('getValue'),
        if(oFNPBatch.StartDateTimeSt!='-')
            $('#dtStart').datetimebox('setValue',oFNPBatch.StartDateTimeSt);
        if(oFNPBatch.EndDateTimeSt!='-')
            $('#dtEnd').datetimebox('setValue',oFNPBatch.EndDateTimeSt);
        //$('#dtExpDelivery').datebox('setValue',response.obj.ExpectedDeliveryDateStr);

        $('#txtStartWidth').val(oFNPBatch.StartWidth);
        $('#txtProcessQty').val(oFNPBatch.StartQty);
        if(oFNBC.SequenceNo!=1)
        {
            $('#txtProcessQty').val(oFNBC.Qty_End_Prv);
            $('#txtStartWidth').val(oFNBC.FabricWidth_End_Prv);
        }

        $('#txtProcessQty_End').val(oFNPBatch.EndQty);

        console.log(oFNPBatch.FNProductionConsumptions);
        DynamicRefreshList(oFNPBatch.FNProductionConsumptions,'tblFNPConsumption');
        //$('#txtConstruction').val(response.obj.Construction);
        //$('#txtProcessQty').val(formatPrice(oFNPBatch.Qty));
    }

    // ------ OPEN UPDATE PROCESS WIN ----- //
    $("#btnUpdateProcess").click(function () {
        debugger;
        editIndex = undefined;
        $('#cboStore').val($("#cboStore").data("WorkingUnitID"));
        $('#lblRemarks').html('');

        $('#divFNPB').data('FNBatchID',0);
        $('#divFNPB').data('FNBatchCardID',0);
        $('#divFNPB').data('FNPBatchID',0);
        $("#divFNPB").data('FNBatcher_Start',{});
        $("#divFNPB").data('FNBatcher_End',{});

        var oFNBatchCards = $('#tblFNBatchCard').datagrid('getRows');
        var oFNBatchCard = $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchCardID <=0 ) { alert("Please select an item from list."); return ; }
        if(oFNBatchCard.SequenceNo<=0) { alert("Please update plan date to set sequence number!"); return ; }


        var bIsTreatmentDone = false;
        var nPrvFNTP = oFNBatchCard.FNTreatment - 1;
        for(var i=0; i<oFNBatchCards.length;i++)
        {
            if(parseInt(oFNBatchCards[i].SequenceNo) >= parseInt(oFNBatchCard.SequenceNo)) break;

            if(parseInt(oFNBatchCards[i].SequenceNo) < parseInt(oFNBatchCard.SequenceNo) && parseInt(oFNBatchCards[i].QCStatus)==0)
            { alert("Please First Update Production For : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] . Then try again!'); return ; }

            if(parseInt(oFNBatchCards[i].FNTreatment) == parseInt(nPrvFNTP) && !bIsTreatmentDone && oFNBatchCards[i].QCStatus!=2)
            { alert("QC is not done for : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] !!'); return ; }
        }


        oFNBatchCard.FSCDID=$("#txtFNExONo").data('FNExOID');

        var nIndex=$('#tblFNBatchCard').datagrid('getRowIndex',oFNBatchCard);
        oFNBatchCard_Prv = $('#tblFNBatchCard').datagrid('getRows')[nIndex-1];
        if(oFNBatchCard_Prv!=undefined)
        {
            oFNBatchCard.Qty_End_Prv = oFNBatchCard_Prv.EndQty;
            oFNBatchCard.FabricWidth_End_Prv = oFNBatchCard_Prv.EndWidth;
        }else
        {
            oFNBatchCard.Qty_End_Prv = 0;
            oFNBatchCard.FabricWidth_End_Prv = "";
        }
        //oFNBatchCard.oFNBatch.FNTreatmentProcessID,
        //FNPBatchID : $('#divFNPB').data('FNPBatchID'),

        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatchCard,
            ControllerName: "FNBatch",
            ActionName: "GetsFNProductionBatch",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null)
            {
                $("#cboShift").icsLoadCombo({
                    List: oHRMShifts,
                    OptionValue: "ShiftID",
                    DisplayText: "Name",
                    InitialValue:"Default"
                });
                $("#cboShade").icsLoadCombo({
                    List: oShades,
                    OptionValue: "id",
                    DisplayText: "Value",
                    InitialValue:"Default"
                });


                if(response.obj[0].ErrorMessage.length>0){ alert(response.obj[0].ErrorMessage); return; }

                $("#cboMachine").icsLoadCombo({
                    List: response.obj[0].FNMachines,
                    OptionValue: "FNMachineID",
                    DisplayText: "NameCode",
                    InitialValue:"Default"
                });

                if(response.obj[0].FNPBatchID>0)
                {
                    response.obj[0].FNProcess = oFNBatchCard.FNProcess;
                    response.obj[0].FNTreatment = oFNBatchCard.FNTreatment;
                    response.obj[0].FNTreatmentSt = oFNBatchCard.FNTreatmentSt;                  // added by akram to show Trtment Name
                    Set_FNP(response.obj[0], oFNBatchCard);
                    $("#winFNPBatch").icsWindow('open', "Update Process");
                }
                else
                {
                    Reset_FNP(oFNBatchCard, response.obj[0]);
                    FNPConsumption();
                    $("#winFNPBatch").icsWindow('open', "Update Process");
                }
            }
        });
    });

    function hasLotAssign()
    {
        var data = $('#tblFNPConsumption').datagrid('getRows');
        for(var i=0; i<data.length; i++)
        {
            if(data[i].LotID==0 || data[i].LotID== undefined){ alert("Please select a lot for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
            if(data[i].Qty<=0){ alert("Please enter a valid  Qty for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
            if(data[i].Qty > data[i].LotBalance){ alert("Insufficient Balance for : "+data[i].ProductName+" ["+(i+1)+"] !"); return false; }
        }
        return true;
    }
    function Refresh_FNP()
    {
        var oFNBatchCard = $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }
        var oFNP={
            FNPBatchID : $('#divFNPB').data('FNPBatchID'),
            FNProductionID : 0,
            FNBatchID : oFNBatchCard.FNBatchID,
            FNBatchCardID : $('#divFNPB').data('FNBatchCardID'),
            StartQty : $('#txtProcessQty').val(),
            EndQty : $('#txtProcessQty_End').val(),
            FNMachineID : $('#cboMachine').val(),
            StartDateTime : $('#dtStart').datetimebox('getValue'),
            EndDateTime : $('#dtEnd').datetimebox('getValue'),
            StartBatcherID : $('#divFNPB').data('FNBatcher_Start').FNMachineID,
            EndBatcherID : $('#divFNPB').data('FNBatcher_End').FNMachineID,
            // StartWidth, EndWidth,Pressure_Bar, Temp_C,MachineSpeed,FlameIntensity,FlamePosition,Remark, ShadeID
            MachineSpeed : parseInt($('#txtMachineSpeed').val()),
            StartWidth : $('#txtStartWidth').val(),
            EndWidth :  $('#txtEndWidth').val(),
            FlameIntensity :  parseInt($('#txtFlameIntensity').val()),
            FlamePosition : parseInt($('#txtFlamePosition').val()),
            Pressure_Bar : $('#txtPressure_Bar').val(),
            Temp_C :  $('#txtTemp_C').val(),
            Remark :  $('#txtRemark').val(),
            ShiftID : $('#cboShift').val(),
            ShadeID : $('#cboShade').val(),
            FNProductionConsumptions: $('#tblFNPConsumption').datagrid('getRows')
        };
        return oFNP;
    }
    $('#btnSaveFNP').click(function(e){

        if($('#cboStore').val()<=0){
            alert("Please select a store.");
            $('#cboStore').focus();
            return false;
        }

        var oFNBatchCard = $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchID <=0 ) { alert("Please select an item from list."); return ; }

        if($('#divFNPB').data('FNBatcher_Start').FNMachineID<=0){alert("Please select Start Batcher & try again."); return ;}
        if($('#divFNPB').data('FNBatcher_End').FNMachineID<=0){alert("Please select End Batcher & try again."); return ;}
        if($('#divFNPB').data('FNBatchCardID') <=0 || $('#divFNPB').data('FNBatchCardID') == undefined){alert("Production Batch Card Is Invalid!"); return ;}
        if($('#cboMachine').val() <=0 || $('#cboMachine').val() == undefined){alert("Please select a machine!"); return ;}

        endEditing_PD();
        var oFNPBatch = Refresh_FNP();

        if(oFNPBatch.StartQty==0){alert("Start Qty Should Be Greater Than Zero!! Please Update Previous End Qty."); return;}
        if(oFNPBatch.EndQty==0){alert("End Qty Should Be Greater Than Zero!!"); return;}
        if(!hasLotAssign())return;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNPBatch,
            ObjectId:"FNPBatchID",
            ControllerName: "FNProduction",
            ActionName: "SaveFNPBatch_Process",
            TableId:"",
            IsWinClose: false,
            Message: ""
        };

        $.icsSave(obj, function (response)
        {
            if (response.status && response.obj!=null) {
                if (response.obj.FNPBatchID > 0)
                {
                    if (response.obj.ErrorMessage!="")return;

                    alert("Process Is Updated successfully.");
                    $("#winFNPBatch").icsWindow('close');
                    //var nOutQty=0;
                    //for(var i=0;i<response.obj.FNBatchRawMaterials.length;i++){
                    //    nOutQty=nOutQty+parseFloat(response.obj.FNBatchRawMaterials[i].Qty);
                    //}
                    var oFNBatchCard=$('#tblFNBatchCard').datagrid('getSelected');
                    var nIndex=$('#tblFNBatchCard').datagrid('getRowIndex',oFNBatchCard);

                    debugger;

                    oFNBatchCard.FNMachineName = response.obj.FNMachineName;
                    oFNBatchCard.QCStatus = 1;
                    oFNBatchCard.FNPBatchID = response.obj.FNPBatchID;

                    oFNBatchCard.QCStatusStr = "In QC";//response.obj.QCStatusStr;
                    oFNBatchCard.StartQty= parseFloat(response.obj.StartQty);
                    oFNBatchCard.EndQty=parseFloat(response.obj.EndQty);
                    oFNBatchCard.StartWidth=parseFloat(response.obj.StartWidth);
                    oFNBatchCard.EndWidth=parseFloat(response.obj.EndWidth);
                    //$('#tblFNBatchCard').datagrid("updateRow", { index: editIndex, row: oFNBatch });
                    $("#tblFNBatchCard").datagrid("updateRow", { index: nIndex, row: oFNBatchCard });

                }
            }
            else{
                alert("Unable to Update Process.");
            }
        });
    });
    $("#btnCloseFNP").click(function () {
        $("#winFNPBatch").icsWindow('close');
    });

    //---------------------------Consumption Production--------------------------//
    var nIndex=undefined;
    function onClickCellPD(index)
    {
        debugger;
        nIndex=index;
        if (endEditing_PD('tblFNPConsumption'))
        {
            debugger;
            $('#tblFNPConsumption').datagrid('selectRow', parseInt(index));
            $('#tblFNPConsumption').datagrid('beginEdit', parseInt(index));
            var oMLC=$('#tblFNPConsumption').datagrid('getSelected');
            editIndex = index;
        }
        else
        {
            $('#tblFNPConsumption').datagrid('selectRow', editIndex);
        }
    }
    function endEditing_PD(tblId) {
        debugger;
        tblId="tblFNPConsumption";
        if (editIndex == undefined) {
            return true;
        }
        if ($('#'+tblId).datagrid('validateRow', editIndex))
        {
            $('#'+tblId).datagrid('endEdit', editIndex);
            $('#'+tblId).datagrid('selectRow', editIndex);

            var oFNBatch=$('#'+tblId).datagrid('getSelected');
            oFNBatch.PlannedDate= new Date(oFNBatch.PlannedDateSt);
            $('#'+tblId).datagrid("updateRow", { index: editIndex, row: oFNBatch });

            if(editIndex==nIndex)
                editIndex = undefined;
            else
            {
                editIndex = nIndex;
                $('#'+tblId).datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
            }
            return true;
        }
        else { return false; }
    }
    var editIndex=undefined;
    $('#btnCloseFNPConsumption').click(function(){
        $('#winFNPConsumption').icsWindow('close');
    })
    function FNPConsumption()
    {
        debugger;
        var oFNBatchC = $('#tblFNBatchCard').datagrid('getSelected');
        if (oFNBatchC ==null || oFNBatchC.FNBatchID <=0 )
        {
            alert("Please select an item from list.");
            return ;
        }
        var oFNBatchCard = {
            FNBatchID : oFNBatchC.FNBatchID,
            FSCDID:$("#txtFNExONo").data('FNExOID'),
            FNTPID:oFNBatchC.FNTreatmentProcessID,
            FNTreatment:oFNBatchC.FNTreatment,
            FNPBatchID : $('#divFNPB').data('FNPBatchID'),
            //FNBatchCardID : FabricSCReport.FabricSalesContractID
        }
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFNBatchCard,
            ControllerName: "FNBatch",
            ActionName: "GetsFNProductionConsumption",
            IsWinClose: false
        };

        $.icsDataGet(obj, function (response) {
            //console.log(response);
            if (response.status && response.obj != null) {
                if(response.obj.length>0)
                {
                    if(response.obj[0].ErrorMessage!=""){alert(response.obj[0].ErrorMessage); return;};
                    //$('#winFNPConsumption').icsWindow('open');
                    DynamicRefreshList(response.obj,'tblFNPConsumption');
                }
                else
                {
                    alert("No Production Consumption Found.");
                }
            }
        });
    }
    $('#btnSavePlanedDate').click(function(){
        debugger;
        endEditing_PD();
        var oLists=$('#tblFNPConsumption').datagrid('getRows');

        for(var i=0; i<oLists.length;i++)
        {
            if(oLists[i].PlannedDateSt!="")
            {
                oLists[i].PlannedDate = icsdateformat(new Date(oLists[i].PlannedDateSt));
            }
        }
        debugger;

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLists,
            ControllerName: "FNExecutionOrder",
            ActionName: "SaveFNPConsumption",
            IsWinClose: false
        };
        $.icsSave(obj, function (response) {

            if (response.status && response.obj!=null) {
                debugger;
                if (response.ErrorMessage=="" || response.ErrorMessage==null) {
                    $('#winFNPConsumption').icsWindow('close');
                }
                else{
                    alert("Unable to Save");
                }
            }
        });
    });

    //------------------- PICKER FUNCTION ---------------------------//
    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID)
    {
        debugger;
        $.icsProgressBar(true);

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0][pID] > 0) {
                    debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    $.icsProgressBar(false);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("Data Not Found.");
                $.icsProgressBar(false);
                return;
            }
        });
    }
    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);
            }
            else if (e.which == 27)//enter=13
            {
                $("#" + oPickerobj.winid).icsWindow("close");
                $("#" + oPickerobj.winid).remove();
            }
        });
    }
    function SetPickerValueAssign(oPickerobj)
    {
        debugger;
        var oResult;
        if (oPickerobj.multiplereturn)
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getChecked');
        }
        else
        {
            oResult = $('#'+oPickerobj.tableid).datagrid('getSelected');
        }
        if (oPickerobj.winid == 'winFNBatch')
        {
            SetBatch(oResult);
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }


    // ------ OPEN PROCESS ENTRY WIN ----- //
    $("#btnAddProcess").click(function ()
    {
        if(parseInt($('#txtFNExONo').data('FNExOID'))<=0 || parseInt($('#txtFNExONo').data('FNExOID'))==undefined || isNaN(parseInt($('#txtFNExONo').data('FNExOID'))))
        {
            alert("Unable to Find Dispo (FNExO) !!"); return;
        }

        var oFNBatch = $("#divPanel").data("FNBatch");
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select a batch first."); return ; }

        $('#txtFNProcess_Entry').val('');
        $("#divPanel").data("FNTreatmentProcess",{FNTreatmentProcessID:0});

        $("#winBatch_Entry").icsWindow('open', "Process Entry");
    });
    $('#btnClose_Batch_Entry').click(function(){
        $('#winBatch_Entry').icsWindow('close');
    });

    $('#btnSaveFNBatch').click(function(e)
    {
        var oFNBatch = $("#divPanel").data("FNBatch");
        var oFNTreatmentProcess = $("#divPanel").data("FNTreatmentProcess");
        if (oFNBatch ==null || oFNBatch.FNBatchID <=0 ) { alert("Please select a batch first."); return ; }
        if (oFNTreatmentProcess ==null || oFNTreatmentProcess.FNTreatmentProcessID <=0 ) { alert("Please select a process first."); return ; }

        var oFNPBatch =
            {
                FNBatchID:oFNBatch.FNBatchID,
                FNTreatmentProcessID : oFNTreatmentProcess.FNTreatmentProcessID,
                PlannedDate : $('#dtPlanDate_Entry').datebox('getValue')
            }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: [oFNPBatch],
            ObjectId:"FNBatchCardID",
            ControllerName: "FNExecutionOrder",
            ActionName: "SavePlannedDate",
            TableId:"",
            IsWinClose: false,
            Message: ""
        };

        $.icsSave(obj, function (response)
        {
            debugger;
            if (response.status && response.obj!=null)
            {
                if (response.obj.FNBatchCardID > 0)
                {
                    if (response.obj.ErrorMessage!="")
                    {
                        alert(response.obj.ErrorMessage); return;
                    }
                    oFNBatchCard = response.obj;

                    alert("Process Is Added successfully.");
                    $("#winFNPBatch").icsWindow('close');
                    $('#tblFNBatchCard').datagrid('appendRow',oFNBatchCard);
                    $('#winBatch_Entry').icsWindow('close');

                    //var oFNBatchCards = $('#tblFNBatchCard').datagrid('getRows');

                    //var bIsTreatmentDone = false;
                    //var nPrvFNTP = oFNBatchCard.FNTreatment - 1;
                    //for(var i=0; i<oFNBatchCards.length;i++)
                    //{
                    //    if(parseInt(oFNBatchCards[i].SequenceNo) >= parseInt(oFNBatchCard.SequenceNo)) break;

                    //    if(parseInt(oFNBatchCards[i].SequenceNo) < parseInt(oFNBatchCard.SequenceNo) && parseInt(oFNBatchCards[i].QCStatus)==0)
                    //    { alert("Please First Update Production For : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] . Then try again!'); return ; }

                    //    if(parseInt(oFNBatchCards[i].FNTreatment) == parseInt(nPrvFNTP) && !bIsTreatmentDone && oFNBatchCards[i].QCStatus!=2)
                    //    { alert("QC is not done for : "+oFNBatchCards[i].FNProcess+'['+oFNBatchCards[i].FNTreatmentSt+'] !!'); return ; }
                    //}

                    //var oFNBatchCard=$('#tblFNBatchCard').datagrid('getSelected');
                    //var nIndex=$('#tblFNBatchCard').datagrid('getRowIndex',oFNBatchCard);

                    //$("#tblFNBatchCard").datagrid("updateRow", { index: nIndex, row: oFNBatchCard });
                }
            }
            else
            {
                alert("Unable to Update Process.");
            }
        });
    });

    /* ================ Gets FN Treatment Process ====================*/
    $('#txtFNProcess_Entry').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)
        {
            GetsFNTreatmentProcess();
        }
    });
    $("#btnFNTreatmentProcess").click(function () {
        GetsFNTreatmentProcess()
    });
    function SetFNProcess (oResult)
    {
        if(oResult.FNTPID > 0)
        {
            $("#divPanel").data("FNTreatmentProcess",{FNTreatmentProcessID: oResult.FNTPID});

            $('#txtFNProcess_Entry').val(oResult.FNProcess);
        }
    }
    function GetsFNTreatmentProcess()
    {
        var ProcessName = $('#txtFNProcess_Entry').val();
        if(parseInt($('#txtFNExONo').data('FNExOID'))<=0 || parseInt($('#txtFNExONo').data('FNExOID'))==undefined || isNaN(parseInt($('#txtFNExONo').data('FNExOID'))))
        {
            alert("Unable to Find Dispo (FNExO) !!"); return;
        }

        var oFNTreatmentProcess = {
            FNProcess: ProcessName,
            ErrorMessage: $('#txtFNExONo').data('FNExOID')
        };

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFNTreatmentProcess,
            ControllerName: "FNTreatmentProcess",
            ActionName: "GetsFNTreatmentProcessForFNRecipeLab",
            IsWinClose: false
        };

        debugger;
        var oColumns = [];
        oColumn = { field: 'FNTreatmentSt', name: 'FNTreatment', width: '35%', enableSorting: false }; oColumns.push(oColumn);
        oColumn = { field: 'Code', name: 'Code', width: '20%' }; oColumns.push(oColumn);
        oColumn = { field: 'FNProcess', name: 'Process Name', width: '35%', enableSorting: false }; oColumns.push(oColumn);


        var oPickerParam = {
            winid: 'winFNBC',
            winclass: 'clsFNBC',
            winwidth: 600,
            winheight: 460,
            tableid: 'tblFNBCs',
            tablecolumns: oColumns,
            multiplereturn: false,
            searchingbyfieldName: 'Code',
            windowTittle: 'Process List',
            paramObj: obj,
            pkID: 'FNTPID',
            callBack: SetFNProcess
        };

        $.icsDynamicPicker(oPickerParam);
    }

    // =================== FN PROCESS SEQUENCE

    $("#btnSequenceProcess").click(function ()
    {
        var oFNBatchCards = $('#tblFNBatchCard').datagrid('getRows');
        if(oFNBatchCards.length<=0)
        {
            alert("No Batch Card Found !!"); return;
        }

        var nSequenceNo =0;
        var oTotalBatchList=[];
        for(var n=1; n<=6; n++) // Max Treatment Type : 6, Printing
        {
            var oNewBatchList=[];
            var oCurrentBatchList=[];
            debugger;
            for(var i= 0; i < oFNBatchCards.length ; i++)
            {
                if(parseInt(oFNBatchCards[i].FNTreatment) == n)
                {
                    if(parseInt(oFNBatchCards[i].SequenceNo) == 0)
                        oNewBatchList.push(oFNBatchCards[i]);
                    else
                        oCurrentBatchList.push(oFNBatchCards[i]);
                }
            }
            for(var i= 0; i < oCurrentBatchList.length ; i++)
            {
                oCurrentBatchList[i].SequenceNo = ++nSequenceNo;
                oTotalBatchList.push(oCurrentBatchList[i]);
            }
            for(var i= 0; i < oNewBatchList.length ; i++)
            {
                oNewBatchList[i].SequenceNo = ++nSequenceNo;
                oTotalBatchList.push(oNewBatchList[i]);
            }
        }

        DynamicRefreshList(oTotalBatchList,'tblFNBatchCard_Sequence');
        $("#winBatch_Sequence").icsWindow('open', "Sequence Process");
    });

    $('#btnSaveFNBatchSequence').click(function(e)
    {
        var oFNBatchCards = $('#tblFNBatchCard_Sequence').datagrid('getRows');
        if(oFNBatchCards.length<=0)
        {
            alert("No Batch Card Found !!"); return;
        }

        var oTotalBatchList=[];
        for(var i= 0; i < oFNBatchCards.length ; i++)
        {
            if(parseInt(oFNBatchCards[i].QCStatus) <= 0 )
                oTotalBatchList.push(oFNBatchCards[i]);
        }

        if(oTotalBatchList.length<=0)
        {
            alert("No Data Found To Save!!"); return;
        }

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oTotalBatchList,
            ObjectId:"FNBatchCardID",
            ControllerName: "FNExecutionOrder",
            ActionName: "SavePlannedDate",
            TableId:"",
            IsWinClose: false,
            Message: ""
        };

        $.icsSave(obj, function (response)
        {
            debugger;
            if (response.status && response.obj!=null)
            {
                if (response.obj.FNBatchCardID > 0)
                {
                    if (response.obj.ErrorMessage!="")
                    {
                        alert(response.obj.ErrorMessage); return;
                    }
                    oFNBatchCard = response.obj;

                    alert("Process Is Updated Successfully.");

                    DynamicRefreshList(oFNBatchCards,'tblFNBatchCard');
                    $('#winBatch_Sequence').icsWindow('close');
                }
            }
            else
            {
                alert("Unable to Update Process.");
            }
        });
    });

    $('#btnClose_Batch_Sequence').click(function(){
        $('#winBatch_Sequence').icsWindow('close');
    });

    function SetSequence(n)
    {
        debugger;
        var oFNBatchCard = $('#tblFNBatchCard_Sequence').datagrid('getSelected');
        if (oFNBatchCard ==null || oFNBatchCard.FNBatchID <=0 )
        {
            alert("Please select an item from list.");return ;
        }
        if (oFNBatchCard.QCStatus >= 1 )
        {
            alert("This item is not in initial status!! Please select another."); return ;
        }

        var nNextIndex = -1;
        var nRowIndex = $("#tblFNBatchCard_Sequence").datagrid("getRowIndex", oFNBatchCard);
        var oFNBatchCards = $('#tblFNBatchCard_Sequence').datagrid('getRows');

        var oFNBatchCard_Next = {}

        if(n==1)
            nNextIndex = nRowIndex-1;
        else
            nNextIndex = nRowIndex+1;
        oFNBatchCard_Next = oFNBatchCards[nNextIndex];

        if (oFNBatchCard_Next ==null || oFNBatchCard_Next.FNBatchID <=0 ) return ;
        if (oFNBatchCard_Next.QCStatus >= 1 ) return ;
        if (oFNBatchCard_Next.FNTreatment != oFNBatchCard.FNTreatment) return ;

        var nSequenceNo =  oFNBatchCard.SequenceNo
        oFNBatchCard.SequenceNo = oFNBatchCard_Next.SequenceNo;
        oFNBatchCard_Next.SequenceNo = nSequenceNo;

        oFNBatchCards[nNextIndex] = oFNBatchCard;
        oFNBatchCards[nRowIndex] = oFNBatchCard_Next;
        DynamicRefreshList(oFNBatchCards,'tblFNBatchCard_Sequence');

        $("#tblFNBatchCard_Sequence").datagrid("selectRow", nNextIndex);
    }

</script>








