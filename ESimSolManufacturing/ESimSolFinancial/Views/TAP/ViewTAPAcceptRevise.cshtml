<html>
@{
    ViewBag.Title = "Time Action Plan";
}
<body>
    @model ESimSol.BusinessObjects.TAP
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div class="menuMainCollectionTable">
        <div id="accABC" class="easyui-accordion"  style="font-family:Tahoma;width:101.5%;height:93%; ">
            <div title="Time Action Plan">
                 <fieldset style=" width:98%;">
                <legend style="font-weight: bold;">Time Action Plan Info: </legend>
                <table border="0" cellspacing="0" cellpadding="1" style="font-size: 11px; font-weight: bold">
                    <tr>
                        <td style="width: 150px; text-align: right; "><label class="asterixStyle">*</label>Buyer Name:</td>
                        <td style="width:250px; text-align:left;">@Html.TextBoxFor(model => model.BuyerName, new { style = "width: 200px;", id = "txtBuyerName", placeholder = "Type & press Enter", disabled = "disabled" }) <input type="button" id="btnBuyerPick" value="Pick" style="width:45px;" onclick="PickBuyer()" disabled="disabled" />  </td>
                        <td style="width:165px; text-align: right">Plan Type</td>
                        <td style="width:200px; text-align:left;"><select id="cboPlanType" style="width:200px;" class="_PlanTypeChangeIssue" disabled="disabled"><option value="1">Order Recap</option><option value="2">Development Recap</option></select></td>
                        <td style="width:210px; vertical-align:bottom; text-align:right;" rowspan="5">
                            <table border="1" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style=" text-align:center; width:210px; height:190px;">
                                        <img id="imgCoverImage" src="@Url.Action("GetLargeImage", "TechnicalSheet", new { id = Model.TechnicalSheetID })" alt="Photo" style="width:210px; height:190px" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <tr>
                        <td style="width: 150px; text-align: right">Brand:</td>
                        <td style="width:250px; text-align:left;">@Html.TextBoxFor(model => model.BrandName, new { style = "width: 250px;", id = "txtBrandName", disabled = "disabled" }) </td>

                        <td style="width:165px; text-align: right">Plan No:</td>
                        <td style="width:200px; text-align:left;">@Html.TextBoxFor(model => model.PlanNo, new { style = "width:200px;", id = "txtPlanNo", disabled = "disabled" }) </td>
                    </tr>
                    <tr>
                        <td style="width: 150px; text-align: right"><label class="asterixStyle">*</label><label id="lblRcpNo">PO No:</label></td>
                        <td style="width:250px; text-align:left;">@Html.TextBoxFor(model => model.OrderRecapNo, new { style = "width: 200px;", id = "txtOrderNo", disabled = "disabled" }) <input type="button" value="Pick" id="btnRecapPick" style="width:45px;" onclick="PickOrder()" disabled="disabled" />  </td>
                        <td style="width:165px; text-align: right">Order Date:</td>
                        <td style="width:200px; text-align:left;">@Html.TextBoxFor(model => model.OrderDateInString, new { style = "width:200px;", id = "txtOrderDate", disabled = "disabled" }) </td>
                    </tr>

                    <tr>
                        <td style="width: 150px; text-align: right">Style No:</td>
                        <td style="width:250px; text-align:left;">@Html.TextBoxFor(model => model.StyleNo, new { style = "width: 250px;", id = "txtStyleNo", disabled = "disabled" }) </td>


                        <td style="width:165px; text-align: right"> <label id="lblfactryshpmntdt">Factory Shipment Date: </lable></td>
                        <td style="width:200px; text-align:left;">@Html.TextBoxFor(model => model.FactoryShipmentDateInString, new { style = "width: 200px;", id = "txtFactoryShipmentDateInString", disabled = "disabled" }) </td>

                    </tr>

                    <tr>
                        <td style="width: 150px; text-align: right">
                            <label id="lblShpmntDate">Shipment Date:</label>
                        </td>
                        <td style="width: 250px;">
                            @Html.TextBoxFor(model => model.ShipmentDateInString, new { style = "width: 250px;", id = "txtShipmentDate", disabled = "disabled" })
                        </td>

                        <td style="width: 165px; text-align: right">
                            Remarks:
                        </td>
                        <td style="width: 200px;">
                            @Html.TextBoxFor(model => model.Remarks, new { style = "width:200px;", id = "txtRemarks" })
                        </td>
                    </tr>
                </table>
                     <table border="0" cellpadding="0" cellspacing="0" width="100%">
                         <tr id="tdOrderRecapColorSizeRatio">
                             <td style="vertical-align:top; width:100%;">
                                 <table border="0" width="99%">
                                     <tr>
                                         <td style="width:100%; text-align:left;font-weight:normal;"><table id="tblColorSizeWiseRatio" class="easyui-datagrid" title="Color Wise Order BreakDown" style="width:100%;height:200px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false"></table></td>
                                     </tr>
                                     <tr>
                                         <td style="width:100%;text-align:left;">
                                             <div id="divTotalSummary" style="font-size:12px; height:15px; width:100%;"><b>Total :</b></div>
                                         </td>
                                     </tr>
                                 </table>
                             </td>
                         </tr>
                         <tr>
                             <td style="vertical-align:top; width:100%;" id="tdDevDetail">
                                 <table border="0" width="99%">
                                     <tr>
                                         <td style="width:100%; text-align:left; font-weight:normal;" colspan="2">
                                             <div>
                                                 <table id="tblDevelopmentRecapDetail" title="Sample Development Factory Wise List" class="easyui-datagrid" style="width:100%; height:200px;" fitcolumns="false" rownumbers="true" singleselect="true" autorowheight="false" toolbar="#"></table>
                                             </div>
                                         </td>
                                     </tr>
                                     <tr>
                                         <td style="width:100%;font-size:12px; text-align:right;">
                                             <div style="width:945px;">Total: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <label id="lblTotalDevelopmentRecapDetailQty" style="font-size: 12px; text-align: center; ">0</label></div>
                                         </td>
                                     </tr>
                                 </table>

                             </td>
                         </tr>
                     </table>
            </fieldset>
            </div>
            <div id="tdDetailDiv" title="Time Action Plan Details" style="margin-left:3px; margin-top:2px;">
                <table id="tblTAPDetail" class="easyui-treegrid" style="width:100%;height:460px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" data-options="idField:'id',treeField:'text', rownumbers:'true', toolbar:'#TAPDetailstoolbar'">
                    <thead>
                        <tr>
                            <th field="text" width="300">Step Name</th>
                            <th field="SequenceInString" width="100">Sequence</th>
                            <th field="ApprovalPlanDateInString" align="center" width="170">Approve Plan Date</th>
                            <th width="150" data-options="field:'Remarks',align:'center',editor:{type:'text',options:{precision:0}}">Remarks</th>
                        </tr>
                    </thead>
                </table>
                <div id="TAPDetailstoolbar" style="text-align:left; font-weight:normal">
                    <label class="asterixStyle">*</label><a href="javascript:void(0)" id="btnAddOrderStep" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="AddOrderStep()">Add Order Step</a>
                    <a href="javascript:void(0)" id="btnAddTemplate" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="PickTimeActionPlanTemplate()">Time Action Plan Template</a>
                    <a href="javascript:void(0)" id="btnRemoveDetail" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="RemoveStep()">Remove</a>
                    <a href="javascript:void(0)" id="btnRemoveAll" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="RemoveAll()">Remove ALL</a>
                    <input id="txtPlanDate" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" style="width: 135px;" />
                    <a href="javascript:void(0)" id="btnUpdate" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="Update()">Update</a>
                </div>

            </div>
        </div>
        <fieldset style="height:38px; width:98%;">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="0" cellpadding="0" style="font-size: 11px; font-weight: bold; vertical-align:middle; width:100%">
                <tr>
                    <td style="width:15%; text-align:center">
                        <label id="lblTemplateName" style="color:navy;font-size:11px;"></label>&nbsp;                        
                    </td>
                    <td style="width:57%; text-align:center">                        
                        <label id="lblInfoFirstPart" style="color:blue; font-size:11px;"></label><br />
                        <label id="lblInfoSecondPart" style="color:blue; font-size:11px;"></label>
                    </td>
                    <td style="width:28%; text-align:right;">                        
                        <a id="btnAcceptRevise" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" onclick="AcceptRevise(false,false)">Accept Revise</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="Close()">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
        </div>
</body>
</html>
<style>
    #progressbarParent {
        opacity: 0.8;
        background-color: #DCD9D4;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0px;
        left: 0px;
        z-index: 1000;
    }
</style>
<script type="text/javascript">
    var _oTAP=null;
    var _sBaseAddress="";
    var _oTechnicalSheetSizes =[];
    var _oColorSizeRatios = [];
    var _oDevelopmentRecapDetails = [];
    var _oTAPDetails = [];
    var _oTempOrderSteps= [];
    var _sTAPHeader = "";
    var _oAuthorizationRolesMapping = [];
    var _lBackLink = "";
    $(document).ready(function () {
        debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oTAP =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oTechnicalSheetSizes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.TechnicalSheetSizes));
        _oColorSizeRatios = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.ColorSizeRatios));
        _oDevelopmentRecapDetails = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.DevelopmentRecapDetails));
        sessionStorage.setItem("PercentWiseDays",0);
        _sTAPHeader = sessionStorage.getItem("TAPHeader");
        _lBackLink = sessionStorage.getItem("BackLink");  
        RefreshControl();
        RefreshDetails(_oTAP.TTAPDetail.children);
      
        
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $('#tblTAPDetail').treegrid('collapseAll',0);
        $('#txtPlanDate').datebox('setValue',icsdateformat(new Date()));
        $('#tblTAPDetail').treegrid({onClickRow:function(row){onClickRow(row);}});
        $('#tblTAPDetail').treegrid({onSelect: function(rowData){ RowSelect(rowData );}});
        RefreshControlLayout();
    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 90){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    $('._PlanTypeChangeIssue').change(function(){
        $('#txtOrderNo').val('');
        $('#txtPlanNo').val('');
        $('#txtStyleNo').val('');
        $('#txtOrderDate').val('');
        $('#txtShipmentDate').val('');
        $('#txtFactoryShipmentDateInString').val('');
        _oTAP.OrderRecapID = 0;
        var nPlanType = $("#cboPlanType").val();
        if(parseInt(nPlanType)==2)
        {
            _oTAP.IsDevelopmentRecap = true;
            $("#lblRcpNo").html("Dev. Recap No :");
            $("#lblShpmntDate").html("Sending Dead Line :");
            $("#lblfactryshpmntdt").html("Sending Receive Date:");
            $('#tdOrderRecapColorSizeRatio').hide();
            $('#tdDevDetail').show();
            MakeDevelopmentRecapDetailTable();
        }else{
            _oTAP.IsDevelopmentRecap = false;
            $("#lblRcpNo").html("PO No :");
            $("#lblShpmntDate").html("Shipment Date :");
            $("#lblfactryshpmntdt").html("Factory Shipment Date:");
            $('#tdDevDetail').hide();
            $('#tdOrderRecapColorSizeRatio').show();
            MakeOrderRecapDetailTable(_oTechnicalSheetSizes);
            RefreshOrderRecapColorSizeList(_oColorSizeRatios);
        }


    });

    function RefreshControl()
    {   
        sessionStorage.setItem("DynamicParentDate",icsdateformat(new Date(_oTAP.OrderDateInString)));//just Initialze or se for update time
        sessionStorage.setItem("DynamicChildDate",icsdateformat(new Date(_oTAP.OrderDateInString)));//just Initialze or se for update time
        if(_oTAP.TampleteName!="" && _oTAP.TampleteName!=null)
        {
            $('#lblTemplateName').html("Template : "+_oTAP.TampleteName);
        }
        var txtBuyerName=document.getElementById("txtBuyerName");
        txtBuyerName.style.color="blue";
        txtBuyerName.style.fontWeight="bold";
        
        if(_oTAP.IsDevelopmentRecap)
        {
            $('#tdOrderRecapColorSizeRatio').hide();
            $('#tdDevDetail').show();
            $('#cboPlanType').val(2);
            MakeDevelopmentRecapDetailTable();
            RefreshDevelopmentRecapList(_oDevelopmentRecapDetails);
        }else{

            $('#cboPlanType').val(1);
            $('#tdDevDetail').hide();
            $('#tdOrderRecapColorSizeRatio').show();
            MakeOrderRecapDetailTable(_oTechnicalSheetSizes);
            RefreshOrderRecapColorSizeList(_oColorSizeRatios);
        }
        if(parseInt(_oTAP.TAPID)>0)
        {
            $('#lblInfoFirstPart').html('Buyer : '+_oTAP.BuyerName +' || Style No : '+_oTAP.StyleNo);
            $('#lblInfoSecondPart').html('Order No : '+_oTAP.OrderRecapNo +' || Qty : '+ parseInt(_oTAP.Quantity) +' || Shipment Date : '+_oTAP.ShipmentDateInString);
        }
    }

    function RefreshDetails(oTTAPDetail)
    {
        data=oTTAPDetail;
        data={"total":""+data.length+"","rows":data};
        $('#tblTAPDetail').treegrid('loadData',data);
    }

    function RowSelect(rowData)
    {
       // debugger;
        $('#txtPlanDate').datebox('setValue',rowData.ApprovalPlanDateInString);
    }

    function Update()
    {
        debugger;
        var oTAPDetail = $('#tblTAPDetail').treegrid('getSelected');
        if(oTAPDetail== null)
        {
            alert("Please Select Detail");
            return;
        }
        oTAPDetail.ApprovalPlanDate = $('#txtPlanDate').datebox('getValue');
        oTAPDetail.ApprovalPlanDateInString = icsdateformat( new Date($('#txtPlanDate').datebox('getValue')));
        $('#tblTAPDetail').treegrid('update',{
            id: oTAPDetail.id,
            row:oTAPDetail
        });
        return;
    }

    function PickTimeActionPlanTemplate()
    {
        if(parseInt(_oTAP.OrderRecapID)<=0)
        {
            alert("Please select Order");
            return;
        }
        var oTAPDetails = $('#tblTAPDetail').treegrid('getData');
        if(oTAPDetails.length>0)
        {
            alert("Please Press Remove All button to  Delete All Privoius Data.");
            return;
        }
        var oParameter = new Object();
        var tsv=((new Date()).getTime())/1000;
        oParameter.Name = "View Template Picker";
        var url =_sBaseAddress+ "/TAPTemplate/TAPTemplatePicker?nTamplateType="+_oTAP.TSType;
        var oTAPTemplateDetails = window.showModalDialog(url, oParameter, 'dialogHeight:545px;dialogWidth:752px;dialogLeft:300;dialogTop:80;center:yes;resizable:no;status:no;scroll:no');
        debugger;
        if(oTAPTemplateDetails!= null)
        {
            if(oTAPTemplateDetails.length >0)
            {
                _oTAPDetails = [];
                _oTAP.TampleteName = oTAPTemplateDetails[0].TemplateName;
                $('#lblTemplateName').html("Template : "+_oTAP.TampleteName);
                
                for(var i = 0; i< oTAPTemplateDetails.length; i++)
                {
                    if(!IsExist(oTAPTemplateDetails[i].OrderStepID))
                    {
                        debugger;
                        var dTempDate = new Date();
                        var dShipmentDate = new Date(_oTAP.ShipmentDateInString);
                        if(parseInt(oTAPTemplateDetails[i].CalculationType)==0)//for Day wise
                        {
                            dShipmentDate.setDate(dShipmentDate.getDate() - parseInt(parseInt(oTAPTemplateDetails[i].BeforeShipment)));
                            dTempDate = dShipmentDate;
                        }else{
                            /* Code written by Md. Mahabub Alam*/
                            if(parseInt(oTAPTemplateDetails[i].OrderStepParentID)== 1)
                            {
                                var oneDay = 24 * 60 * 60 * 1000;// hours*minutes*seconds*milliseconds
                                var nDateDiff = parseInt(Math.abs(dShipmentDate.getTime() - new Date(_oTAP.OrderDateInString).getTime())/(oneDay));//calculate days between two dates
                                var nPercentWiseDays = parseInt(parseInt(nDateDiff) * parseInt(oTAPTemplateDetails[i].BeforeShipment)/100);//here beforeshipment field use for Percent values depends on calculation Type; keep privous dys 
                                sessionStorage.setItem("PercentWiseDays",nPercentWiseDays);//set parent step Percent wise days
                                var dDynamicParentDate = new Date(sessionStorage.getItem("DynamicParentDate"));//get privious parent step date
                                sessionStorage.setItem("DynamicChildDate",dDynamicParentDate);//keep privious parent step date in child step date
                                dDynamicParentDate.setDate(dDynamicParentDate.getDate()+nPercentWiseDays);//calculate new  parent step date
                                sessionStorage.setItem("DynamicParentDate",dDynamicParentDate);//keep new parent step date
                                dTempDate = dDynamicParentDate;//set actual date
                            }else{
                                var nPercentWiseDays = sessionStorage.getItem("PercentWiseDays");//Get percent wise days of  parent step
                                var nChildPercentWiseDays = parseInt( parseInt(nPercentWiseDays) * parseInt(oTAPTemplateDetails[i].BeforeShipment)/100);
                                var dDynamicChildDate = new Date(sessionStorage.getItem("DynamicChildDate"));//get privious child step date
                                dDynamicChildDate.setDate(dDynamicChildDate.getDate()+nChildPercentWiseDays);//calculate new child step date
                                sessionStorage.setItem("DynamicChildDate",dDynamicChildDate);//keep new Child step Date
                                dTempDate = dDynamicChildDate;//set actual date
                            }
                        }
                        var oTAPDetail ={
                            TAPDetailID:0,
                            TAPID:_oTAP.TAPID,
                            OrderStepID :oTAPTemplateDetails[i].OrderStepID,
                            OrderStepName :oTAPTemplateDetails[i].OrderStepName,
                            Sequence :0,
                            ApprovalPlanDate:dTempDate,
                            ApprovalPlanDateInString:icsdateformat(dTempDate),
                            Remarks :oTAPTemplateDetails[i].Remarks
                        };
                        _oTAPDetails.push(oTAPDetail);
                    }
                }
                // debugger;
                AcceptRevise(false,false);
            }
        }
    }
    function PickOrder()
    {
        if(parseInt(_oTAP.BuyerID)<=0)
        {
            alert("Please select Buyer");
            return;
        }

        if(parseInt($('#cboPlanType').val())==2)
        {
            var oTAP = { BuyerID: _oTAP.BuyerID, OrderRecapID:_oTAP.OrderRecapID};
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oTAP,
                ControllerName: "TAP",
                ActionName: "BuyerWiseDevelopmentRecaps",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {
                debugger;
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].DevelopmentRecapID > 0) {
                        debugger;
                        var tblColums = []; var oColumn = { field: "StyleNo", title: "Style No", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "DevelopmentRecapNo", title: "Development Recap", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ProductName", title: "Product Name", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ApproveByName", title: "Approve By", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "SampleQty", title: "Quantity", width: 100, align: "right" }; tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winDevelopmentRecaps',
                            winclass: 'clsDevelopmentRecap',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblDevelopmentRecaps',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'StyleNo',
                            windowTittle: 'View Buyer Wise Development Recap Picker ['+$('#txtBuyerName').val()+']'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else
                {
                    alert("Data Not Found.");
                    return;
                }
            });
        }else
        {
            var oTAP = { BuyerID: _oTAP.BuyerID, OrderRecapID:_oTAP.OrderRecapID};
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oTAP,
                ControllerName: "TAP",
                ActionName: "BuyerWiseOrderRecaps",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {
                debugger;
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].OrderRecapID > 0) {
                        debugger;
                        var tblColums = []; var oColumn = { field: "StyleNo", title: "Style No", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "OrderRecapNo", title: "Order Recap", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShipmentDateInString", title: "Shipment Date", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "FactoryName", title: "Factory", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "FabricName", title: "Fabrication", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ProductName", title: "Product Name", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ApproveByName", title: "Approve By", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "TotalQuantity", title: "Quantity", width: 100, align: "right" }; tblColums.push(oColumn);

                        var oPickerParam = {
                            winid: 'winOrderRecaps',
                            winclass: 'clsOrderRecap',
                            winwidth: 820,
                            winheight: 500,
                            tableid: 'tblOrderRecaps',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'StyleNo',
                            windowTittle: 'View Buyer Wise Order Recap Picker ['+$('#txtBuyerName').val()+']'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else
                {
                    alert("Data Not Found.");
                    return;
                }
            });
        }
    }

    function LoadDevelopmentRecapDetails(nDevelopmentRecapID)
    {
        if(parseInt(nDevelopmentRecapID)>0)
        {
            $.ajax
          ({
              type: "GET",
              dataType: "json",
              url : _sBaseAddress+  "/DevelopmentRecap/GetDevelopmentRecapDetails",
              data: { id:nDevelopmentRecapID},
              contentType: "application/json; charset=utf-8",
              success: function (data) {
                  //debugger;
                  _oDevelopmentRecapDetails = jQuery.parseJSON(data);
                  if (_oDevelopmentRecapDetails.length>0)
                  {
                      if(parseInt(_oDevelopmentRecapDetails[0].DevelopmentRecapDetailID)>0)
                      {
                          RefreshDevelopmentRecapList(_oDevelopmentRecapDetails);
                      }
                  }
                  else
                  {
                      alert("There is No Details");
                  }
              },
              error: function (xhr, status, error)
              {
                  alert(error);
              }

          });
        }

    }
    function AddOrderStep()
    {
        var oOrderStep = {};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oOrderStep,
            ControllerName: "OrderStep",
            ActionName: "GetOrderSteps",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].OrderStepID > 0) {
                    _oTempOrderSteps = [];
                    _oTempOrderSteps = response.objs;
                    var oNewOrderSteps = [];
                    for(var i =0;i<_oTempOrderSteps.length;i++)
                    {
                        if(parseInt(_oTempOrderSteps[i].ParentID)==1)
                        {
                            oNewOrderSteps.push(_oTempOrderSteps[i]);
                        }
                    }
                    debugger;
                    var tblColums = []; var oColumn = { field: "OrderStepName", title: "Order Step Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Note", title: "Note", width: 100, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderSteps',
                        winclass: 'clsOrderStep',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblOrderSteps',
                        tablecolumns: tblColums,
                        datalist: oNewOrderSteps,
                        multiplereturn: true,
                        searchingbyfieldName: 'OrderStepName',
                        windowTittle: 'Oder Step Picker'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else
            {
                alert("Data Not Found.");
                return;
            }
        });

    }

    function IsExist(nOrderStepID)
    {
        var oTAPDetails = $('#tblTAPDetail').treegrid('getData');
        if(oTAPDetails.length>0)
        {
            for(var i =0;i<oTAPDetails.length;i++)
            {
                if(parseInt(oTAPDetails[i].OrderStepID)== parseInt(nOrderStepID))
                {
                    return true;
                }
                var oTempChildrens =oTAPDetails[i].children;
                for(var j = 0; j<oTempChildrens.length;j++)
                {
                    if(parseInt(oTempChildrens[j].OrderStepID)== parseInt(nOrderStepID))
                    {
                        return true;
                    }
                }
            }
        }

        return false;
    }
      
    function RefreshSequence()
    {
        RefreshDetails(_oTAP.TTAPDetail.children);
    }

    function RemoveStep()
    {
        debugger;
        var oTAPDetail= $('#tblTAPDetail').treegrid('getSelected');
        if(oTAPDetail==null)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if (!confirm("Confirm to Delete?")) return ;
        endEditing();
        $('#tblTAPDetail').treegrid('remove',oTAPDetail.id);
        alert("Delete sucessfully");
    }

    function RemoveAll()
    {
        if(_oTAP==null || parseInt(_oTAP.TAPID)<=0)
        {
            alert("Invalid Field!!! please select a valid Field!");
            return false;
        }
        if (!confirm("Confirm to Remove All Data From List?")) return ;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        if (parseInt(_oTAP.TAPID)> 0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/TAP/Delete",
                data: { id: _oTAP.TAPID},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    //debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Data delete successfully")
                    {
                        $("#progressbar").progressbar({ value: 0 });//hide
                        $("#progressbarParent").hide();
                        alert("Delete sucessfully");
                        _oTAP.TAPID = 0;//Reset TAP ID
                        $('#txtPlanNo').val('');
                        RefreshDetails({});
                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }
    }

    var editid = undefined;
    function endEditing(){
        if (editid == undefined){return true}
        if ($('#tblTAPDetail').treegrid('validateRow', editid)){
            $('#tblTAPDetail').treegrid('endEdit', editid);
            $('#tblTAPDetail').treegrid('select',editid);
            var oTAPDetail=$('#tblTAPDetail').treegrid('getSelected');
            oTAPDetail.ApprovalPlanDate = new Date(oTAPDetail.ApprovalPlanDateInString);
            oTAPDetail.ApprovalPlanDateInString =  icsdateformat(oTAPDetail.ApprovalPlanDate);
            $('#tblTAPDetail').treegrid('update',{id: editid,	row: oTAPDetail});
            editid = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }

    function onClickRow(row){

        if (editid != row.id){
            if (endEditing())
            {
                $('#tblTAPDetail').treegrid('select', row.id).treegrid('beginEdit', row.id);
                editid = row.id;
            }
            else
            {
                $('#tblTAPDetail').treegrid('select', editid);
            }
        }
    }


    function ValidateInput()
    {
        if(_oTAP.OrderRecapID <=0)
        {
            alert("Please Pick Order Recap");
            return false;
        }
        var oTAPDetails =$('#tblTAPDetail').treegrid('getData');
        if(oTAPDetails.length<=0 && _oTAPDetails.length<=0)
        {
            alert("Please add at least One Detail");
            return false;
        }
        return true;
    }


    function RefreshObject()
    {
        var oTAP= {
            TAPID :_oTAP.TAPID,
            OrderRecapID :_oTAP.OrderRecapID,
            IsDevelopmentRecap:_oTAP.IsDevelopmentRecap,
            ShipmentDate : _oTAP.ShipmentDateInString,
            PlanNo :_oTAP.PlanNo,
            TampleteName:_oTAP.TampleteName,
            Remarks :$("#txtRemarks").val(),
            TAPDetails :MakeRefreshDetails()
        };
        return oTAP;
    }

    function MakeRefreshDetails()
    {
        debugger;
        var oTAPDetails = $('#tblTAPDetail').treegrid('getData');
        var oTempTAPDetails= [];
        if(oTAPDetails.length>0)
        {
            for(var i =0;i<oTAPDetails.length;i++)
            {
               // var dtmep = new Date(oTAPDetails[i].ApprovalPlanDateInString);
                var oTAPDetail= {
                    TAPDetailID :oTAPDetails[i].TAPDetailID,
                    TAPID:_oTAP.TAPID,
                    OrderStepID :oTAPDetails[i].id,
                    Sequence :oTAPDetails[i].Sequence,
                    ApprovalPlanDate :new Date(oTAPDetails[i].ApprovalPlanDateInString),
                    Remarks :oTAPDetails[i].Remarks
                };
                oTempTAPDetails.push(oTAPDetail);
                var oTempChildrens =oTAPDetails[i].children;
                for(var j = 0; j<oTempChildrens.length;j++)
                {
                    var oTAPDetail= {
                        TAPDetailID :oTempChildrens[j].TAPDetailID,
                        TAPID:_oTAP.TAPID,
                        OrderStepID :oTempChildrens[j].id,
                        Sequence :oTempChildrens[j].Sequence,
                        ApprovalPlanDate :new Date(oTempChildrens[j].ApprovalPlanDateInString),
                        Remarks :oTempChildrens[j].Remarks
                    };
                    oTempTAPDetails.push(oTAPDetail);
                }
            }
        }

        if(_oTAPDetails.length>0)//Data exist in _oTAPDetails when pick Template or Order STep
        {
            for(var i =0;i<_oTAPDetails.length;i++)
            {
                var oTAPDetail= {
                    TAPDetailID :_oTAPDetails[i].TAPDetailID,
                    TAPID:_oTAP.TAPID,
                    OrderStepID :_oTAPDetails[i].OrderStepID,
                    Sequence :_oTAPDetails[i].Sequence,
                    ApprovalPlanDate :new Date(_oTAPDetails[i].ApprovalPlanDateInString),
                    Remarks :_oTAPDetails[i].Remarks
                };
                oTempTAPDetails.push(oTAPDetail);
            }
        }
        _oTAPDetails = [];//Reset
        return oTempTAPDetails;
    }

    function AcceptRevise(bIsInitialSave, bIsForRemove)
    {
        debugger;
        if(!bIsForRemove)
        {
            endEditing();
        }
        if(!ValidateInput()) return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        var oTAP=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/TAP/AcceptRevise",
            traditional: true,
            data:  JSON.stringify(oTAP),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                _oTAP = jQuery.parseJSON(data);
                $("#progressbar").progressbar({value: 100});
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (_oTAP.TAPID>0)
                {
                    if(!bIsInitialSave)
                    {
                        alert("Data Saved sucessfully");
                        var oTAPs = sessionStorage.getItem("TAPs");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oTAPs != null) {
                            oTAPs = jQuery.parseJSON(oTAPs);
                        }
                        else {
                            oTAPs = [];
                        }
                        if (nIndex != -1) {
                            oTAPs[nIndex] = _oTAP;
                        }
                        else {
                            sessionStorage.setItem("SelectedRowIndex", oTAPs.length);
                            oTAPs.push(_oTAP);
                        }
                        sessionStorage.setItem("TAPs", JSON.stringify(oTAPs));
                        window.location.href = _lBackLink;
                    }else{

                        //RefreshDetails(_oTAP.TTAPDetail.children);
                        $('#accABC').accordion('select',1);//SElect second accordin  after reload page
                        window.location.href = _sBaseAddress+ "/TAP/ViewTAP?id="+_oTAP.TAPID;
                    }
                }
                else {
                    alert(_oTAP.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    }

    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            debugger;
            //for Single Select
            PickerEvents(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                PickerEvents(oPickerobj);
            }
        });
    }
    function PickerEvents(oPickerobj) {
        var oreturnobj = null, oreturnobjs = [];
        if(oPickerobj.multiplereturn)
        {
            oreturnobjs = $('#' + oPickerobj.tableid).treegrid('getChecked');
        }else{
            oreturnobj = $('#' + oPickerobj.tableid).treegrid('getSelected');
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winclass == 'clsBuyer')
        {
            $('#txtBuyerName').val(oreturnobj.Name);
            _oTAP.BuyerID = oreturnobj.ContractorID;
            $('#txtBuyerName').focus();
            var txtBuyerName = document.getElementById("txtBuyerName");
            txtBuyerName.style.color = "blue";
            txtBuyerName.style.fontWeight = "bold";
        }else  if (oPickerobj.winclass == 'clsDevelopmentRecap')
        {
            debugger;
            if(oreturnobj.DevelopmentRecapID>0)
            {
                $('#txtOrderNo').val( oreturnobj.DevelopmentRecapNo);
                $('#txtOrderDate').val(oreturnobj.InquiryReceivedDateInString);
                $('#txtStyleNo').val(oreturnobj.StyleNo);
                $('#txtBrandName').val(oreturnobj.BrandName);
                $('#txtShipmentDate').val( oreturnobj.SendingDeadLineInString);
                $('#txtFactoryShipmentDateInString').val(oreturnobj.SampleReceivedDateInString);                
                //set Order date 
                sessionStorage.setItem("DynamicParentDate",oreturnobj.SampleReceivedDateInString);
                sessionStorage.setItem("DynamicChildDate",oreturnobj.SampleReceivedDateInString);
                _oTAP.OrderDateInString = oreturnobj.SampleReceivedDateInString;
                _oTAP.FactoryShipmentDateInString = oreturnobj.SampleReceivedDateInString;
                _oTAP.ShipmentDateInString  = oreturnobj.SendingDeadLineInString;
                _oTAP.IsDevelopmentRecap = true;
                _oTAP.OrderRecapID = oreturnobj.DevelopmentRecapID;
                _oTAP.TSType = oreturnobj.TSType;
                RefreshStyleImage(oreturnobj.TechnicalSheetID);
                LoadDevelopmentRecapDetails(oreturnobj.DevelopmentRecapID);
            }
        }else  if (oPickerobj.winclass == 'clsOrderRecap')
        {
            debugger;
            if(oreturnobj.OrderRecapID>0)
            {
                $('#txtOrderNo').val(oreturnobj.OrderRecapNo);
                $('#txtOrderDate').val(oreturnobj.OrderDateInString);
                $('#txtStyleNo').val(oreturnobj.StyleNo);
                $('#txtBrandName').val(oreturnobj.BrandName);
                $('#txtShipmentDate').val(oreturnobj.ShipmentDateInString);
                $('#txtFactoryShipmentDateInString').val(oreturnobj.FactoryShipmentDateInString);                
                //set Order date 
                sessionStorage.setItem("DynamicParentDate",icsdateformat(new Date(oreturnobj.OrderDateInString)));
                sessionStorage.setItem("DynamicChildDate",icsdateformat(new Date(oreturnobj.OrderDateInString)));
                _oTAP.OrderDateInString = oreturnobj.OrderDateInString;
                _oTAP.FactoryShipmentDateInString = oreturnobj.FactoryShipmentDateInString;
                _oTAP.ShipmentDateInString  = oreturnobj.ShipmentDateInString;
                _oTAP.IsDevelopmentRecap = false;
                _oTAP.OrderRecapID = oreturnobj.OrderRecapID;
                _oTAP.TSType = oreturnobj.TSType;
                TechnicalSheetSize(oreturnobj.TechnicalSheetID);
                RefreshStyleImage(oreturnobj.TechnicalSheetID);
                GetColorSizeRatios(oreturnobj.TechnicalSheetID,oreturnobj.OrderRecapID);
            }
        }
    }
    function GetSequence()
    {
        debugger;
        var oTAPDetails = $('#tblTAPDetail').treegrid('getRoots');
        return oTAPDetails.length;
    }
    function MakeTAPDetails(nOrderStepID)
    {
        debugger;
        for(var j = 0; j<_oTempOrderSteps.length;j++)
        {
            if(parseInt(_oTempOrderSteps[j].ParentID) == parseInt(nOrderStepID))
            {
                if(!IsExist(_oTempOrderSteps[j].OrderStepID))
                {
                    var dTempDate = new Date(_oTAP.ShipmentDateInString);
                    dTempDate.setDate(dTempDate.getDate() - 1);
                    var oTAPDetail ={
                        TAPDetailID:0,
                        TAPID:_oTAP.TAPID,
                        OrderStepID :_oTempOrderSteps[j].OrderStepID,
                        OrderStepName :_oTempOrderSteps[j].OrderStepName,
                        Sequence :0,
                        ApprovalPlanDate:dTempDate,
                        ApprovalPlanDateInString:icsdateformat(dTempDate),
                        Remarks :_oTempOrderSteps[j].Remarks
                    };
                    _oTAPDetails.push(oTAPDetail);
                }
            }
        }
    }

    function GetColorSizeRatios (nTechnicalSheetID, nOrderRecapID)
    {
        if(parseInt(nTechnicalSheetID)>0 && parseInt(nOrderRecapID)>0)
        {
            $.ajax
            ({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+"/TAP/GetColorSizeRatio",
                data: {nTechnicalSheetID: nTechnicalSheetID,nOrderRecapID:nOrderRecapID},
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    //debugger;
                    oColorSizeRatios = jQuery.parseJSON(data);
                    if (oColorSizeRatios.length >0)
                    {
                        _oColorSizeRatios = oColorSizeRatios;
                        RefreshOrderRecapColorSizeList(_oColorSizeRatios);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }

            });
        }

    }

    function RefreshOrderRecapColorSizeList(oColorSizeRatios)
    {
        data=oColorSizeRatios;
        data={"total":""+data.length+"","rows":data};
        $('#tblColorSizeWiseRatio').datagrid('loadData',data);
        RefreshSummary(_oTechnicalSheetSizes);
    }
    function RefreshDevelopmentRecapList(oDevRecpDtls)
    {
        data=oDevRecpDtls;
        data={"total":""+data.length+"","rows":data};
        $('#tblDevelopmentRecapDetail').datagrid('loadData',data);
        setDevelopmentRecapTotal();
    }

    function setDevelopmentRecapTotal()
    {
        var oDevDetails = $('#tblDevelopmentRecapDetail').datagrid('getRows');
        var ntotalQty = 0;
        for(var i = 0;i<oDevDetails.length;i++)
        {
            ntotalQty+=parseFloat(oDevDetails[i].SampleQty);
        }
        $('#lblTotalDevelopmentRecapDetailQty').html(formatPrice(ntotalQty,0));
    }


    function TechnicalSheetSize(nTechnicalSheetID)
    {
        //debugger;
        var oTechnicalSheet={
            TechnicalSheetID : nTechnicalSheetID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/OrderRecap/GetTechnicalSheetSize",
            data:  JSON.stringify(oTechnicalSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var  oTechnicalSheetSizes = jQuery.parseJSON(data);
                if (oTechnicalSheetSizes!=null)
                {
                    if(oTechnicalSheetSizes.length>0)
                    {
                        MakeOrderRecapDetailTable(oTechnicalSheetSizes);
                    }
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }


    function MakeOrderRecapDetailTable(oTechnicalSheetSizes)
    {
        _oTechnicalSheetSizes=[];
        var tblColums=[];
        var oColumn=null;
        oColumn= { field :"ColorName", title:"Color Name", width:"120"};
        tblColums.push(oColumn);
        var count =0;
        for(var i=0; i<oTechnicalSheetSizes.length;i++)
        {
            count++;
            oColumn= {
                field:"OrderQty"+count,
                title: oTechnicalSheetSizes[i].SizeCategoryName,
                width: "60",
                align: "right",
                editor: {type:'numberbox',options:{ precision:0}}
            };
            tblColums.push(oColumn);
            _oTechnicalSheetSizes.push(oTechnicalSheetSizes[i]);
        }
        oColumn= { field :"ColorWiseTotal", title:"Total", width:"100",  align: "right"};
        tblColums.push(oColumn);
        $('#tblColorSizeWiseRatio').datagrid({ columns:[tblColums]});
        RefreshOrderRecapColorSizeList(_oColorSizeRatios);
        RefreshSummary(_oTechnicalSheetSizes);
    }

    function RefreshSummary(oTechnicalSheetSizes)
    {
        debugger;
        var sInnerHTML="<table border='0' cellspacing='2' cellpadding='2' style='font-size:11px; font-weight:bold'><tr>";
        sInnerHTML=sInnerHTML+"<td style='width:135px; text-align:right'> Total :</td>";
        var count =0;
        for(var j=0; j<oTechnicalSheetSizes.length;j++)
        {
            count++;
            sInnerHTML=sInnerHTML+"<td style='width:56px; text-align:right'>"+SizeWiseTotal(count)+"</td>";
        }
        var nTotalQuantity=SizeWiseTotal(21);
        sInnerHTML=sInnerHTML+"<td style='width:90px; text-align:right'>"+nTotalQuantity+"</td>";
        sInnerHTML=sInnerHTML+"</tr></table>";
        //debugger;
        var divTotalSummary= document.getElementById('divTotalSummary');
        divTotalSummary.innerHTML=sInnerHTML;
    }


    function MakeDevelopmentRecapDetailTable()
    {
        var tblColums=[];
        var oColumn=null;
        oColumn= { field :"FactoryName", title:"Factory Name", width:"230"};
        tblColums.push(oColumn);

        oColumn= { field :"FactoryPersonName", title:"Factory C.Person", width:"180",  align: "left"};
        tblColums.push(oColumn);

        oColumn= { field :"SeekingDateInString", title:" Seeking Date", width:"100",  align: "left"};
        tblColums.push(oColumn);

        oColumn= { field :"ReceivedByName", title:"Recive By", width:"150",  align: "left"};
        tblColums.push(oColumn);

        oColumn= { field :"UnitName", title:"Unit", width:"100",  align: "left"};
        tblColums.push(oColumn);

        oColumn= { field :"SampleQty", title:"Qty", width:"185",  align: "right"};
        tblColums.push(oColumn);
        $('#tblDevelopmentRecapDetail').datagrid({ columns:[tblColums]});
    }

    function RefreshStyleImage(nTechnicalSheetID)
    {
        $.ajax({
            cache:true,
            type: "GET",
            url: "@(Url.Action("GetStyleImageInBase64", "TechnicalSheet"))",
            data: "id=" + nTechnicalSheetID,
            success: function (data) {
                //debugger;
                $('#imgCoverImage').attr('src', "data:image/jpg;base64," + data.base64imgage );
            }
        });
    }


    function SizeWiseTotal(n)
    {
        var nSizeWiseTotal=0;
        var oColorSizeWiseRatios = $('#tblColorSizeWiseRatio').datagrid('getRows');
        for(var i=0; i<oColorSizeWiseRatios.length; i++)
        {
            if(n==1){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty1);}
            else if(n==1){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty1);}
            else if(n==2){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty2);}
            else if(n==3){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty3);}
            else if(n==4){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty4);}
            else if(n==5){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty5);}
            else if(n==6){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty6);}
            else if(n==7){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty7);}
            else if(n==8){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty8);}
            else if(n==9){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty9);}
            else if(n==10){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty10);}
            else if(n==11){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty11);}
            else if(n==12){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty12);}
            else if(n==13){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty13);}
            else if(n==14){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty14);}
            else if(n==15){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty15);}
            else if(n==16){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty16);}
            else if(n==17){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty17);}
            else if(n==18){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty18);}
            else if(n==19){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty19);}
            else if(n==20){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].OrderQty20);}
            else if(n==21){nSizeWiseTotal=nSizeWiseTotal+parseInt(oColorSizeWiseRatios[i].ColorWiseTotal);}
        }
        return nSizeWiseTotal;
    }

    function Close()
    {
        window.location.href = _lBackLink;
    }

    $(document).keydown(function(e) {
        //debugger;
        if(e.which == 27)//escape=27
        {
            //debugger;
            window.location.href = _lBackLink;
        }
    });

    function RefreshControlLayout()
    {
        $('#btnRemoveDetail').hide();
        $('#btnRemoveAll').hide();
        if(HavePermission('Delete','TAPDetail')){$('#btnRemoveDetail').show(); $('#btnRemoveAll').show();}
    }

    function HavePermission(sOperationType, sDbObject)
    {
        var nSessionID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.currentUserID]));
        if(nSessionID == -9) //check SuperUser
        {
            return true;
        }else
        {

            for(var i =0;i<_oAuthorizationRolesMapping.length;i++)
            {
                if(_oAuthorizationRolesMapping[i].OperationTypeInString == sOperationType && _oAuthorizationRolesMapping[i].DBObjectName == sDbObject)
                    return  true;
            }
            return false;
        }
    }

</script>
