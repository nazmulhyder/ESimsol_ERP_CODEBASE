@{
    ViewBag.Title = "Sales Contract List";
}
@model ESimSol.BusinessObjects.PTU
<head>
    
</head>
<body>
    <div id="divPTUs" class="easyui-panel menuMainCollectionTable" style="font-family:Tahoma; height:100%; width:100%;overflow:hidden;">
      
         <div style="height:88%;width:100%;overflow:hidden;">
             <table border="0" cellspacing="2" cellpadding="2" style="width:100%;">
                 <tr>
                     <td style=" background-color:#cfb53b; text-align:center; width:100%; color:white">
                         <label id="lblHeaderName" style="font-size:15px; font-weight:bold; text-decoration:Underline"> Stock Distribution</label>
                     </td>
                 </tr>
             </table>
            <div style="width:100%;">
                <fieldset>
                    <legend style="text-align:left; font-weight:bold;"> </legend>
                    <table style="width: 100%;" cellspacing="1" cellpadding="1">
                        <tr>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Party Name
                                </label>
                            </td>
                            <td colspan="3" style="width:30%; text-align:left">
                                <input type="text" id="txtContractorName" style="width:100%;" readonly="readonly" />
                            </td>

                            <td style="width:10%; text-align:right">
                                <label>
                                    Buyer Name
                                </label>
                            </td>
                            <td colspan="3" style="width:30%; text-align:left">
                                <input type="text" id="txtBuyerName" style="width:100%;" readonly="readonly" />
                            </td>
                          
                            <td style="width:10%; text-align:right">
                                <label>
                                    P/I No
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtPINo" style="width:90%;" readonly="readonly" />
                            </td>

                        </tr>
                        <tr>
                            <td style="width:10%; text-align:right">
                                <label>
                                   Product Name
                                </label>
                            </td>
                            <td colspan="3" style="width:30%; text-align:left">
                                <input type="text" id="txtProductName" style="width:100%;" readonly="readonly" />
                            </td>

                            <td style="width:10%; text-align:right">
                                <label>
                                    Color Name
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtColor" style="width:100%;" readonly="readonly" />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Color No
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtColorNo" style="width:90%;" readonly="readonly" />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Lab-Dip No
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtLabDipNo" style="width:90%;" readonly="readonly" />
                            </td>

                        </tr>
                    </table>
                    <table style="width: 100%;" cellspacing="1" cellpadding="1">
                        <tr>
                            <td style="width:10%; text-align:right">
                                <label>   Order Qty  </label> 
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtOrderQty" style="width:100%;" readonly="readonly" />
                            </td>

                            <td style="width:10%; text-align:right">
                                <label>Pro Pipeline </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtProductionPipeLineQty" style="width:100%;" readonly="readonly" />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Yet To Pro
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtYetToProduction" style="width:100%;" readonly="readonly" />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Delivery Qty
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtActualDeliveryQty" style="width:100%;" readonly="readonly" />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label>
                                    Yet To Delivery
                                </label>
                            </td>
                            <td style="width:10%; text-align:left">
                                <input type="text" id="txtYetToDelivery" style="width:100%;" readonly="readonly" />
                            </td>
                        </tr>
                        
                    </table>
                </fieldset>
            </div>
            <fieldset>
                
                <table style="width:100% ;height:250px">
                    <tr>
                        
                        <td style="width:65% ;height:250px">
                            <fieldset>
                                <legend style="text-align:left; font-weight:bold;"> Gets Source Order : </legend>
                                <table style="width:100%;height:250px" id="tblPTUDistribution_Source" class="easyui-datagrid" singleselect="true" autorowheight="false" toolbar="#toolbarPTU_Sourch">
                                    <thead>
                                        <tr>
                                            
                                            <th field="LotNo" width="20%" align="left">Lot No</th>
                                            <th field="OrderNo" width="20%" align="left">OrderNo</th>
                                            <th field="ProductName" width="20%" align="left">Yarn Type</th>
                                            <th field="ColorName" width="15%" align="left">ColorName</th>
                                            <th field="Qty" width="15%" align="right" formatter="formatPrice">Qty</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarPTU_Sourch">
                                    <table>
                                        <tr>
                                            <td>
                                                <select id="cboOrderType" style="width:112px;"></select>
                                                <input type="text" id="txtOrderNo" placeholder="ype Order No and Press enter" style="width:180px;" /><a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                                                <input type="text" id="txtLotNo_PTUD" placeholder="Type Lot No and Press enter" style="width:180px;" /><a id="btnPickLot_PTUD" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a> 
                                            </td>

                                        </tr>
                                    </table>
                                </div>
                                <table border="0" cellpadding="01" cellspacing="1" style="width:100%;">
                                    <tr>
                                        <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                        <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblTotalQty_Source">0</label><span class="lblMUnit"></span> </td>

                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                        <td style="width:35% ;height:250px">
                            <fieldset>
                                <legend style="text-align:left; font-weight:bold;"> Current  Stock In Hand : </legend>
                                <table style="width:100%;height:250px" id="tblPTUDistribution" class="easyui-datagrid" singleselect="true" autorowheight="false" toolbar="#toolbarPTU">
                                    <thead>
                                        <tr>
                                            <th field="LotNo" width="60%" align="left">Lot No</th>
                                            <th field="Qty" width="40%" align="right" formatter="formatPrice">Qty</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarPTU">
                                    <table>
                                        <tr>
                                            <td></td>

                                        </tr>
                                    </table>
                                </div>
                                <table border="0" cellpadding="1" cellspacing="1" style="width:100%;">
                                    <tr>
                                        <td style="width:25%;  text-align:right;font-weight:bold;">Total:</td>
                                        <td style="width:20%;  text-align:right;font-weight:bold;"><label id="lblTotalQty">0</label><span class="lblMUnit"></span> </td>

                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:65%; text-align:left">
                            <label id="lbTransfer">
                                Transfer Qty
                            </label>
                            <input type="text" id="txtTransferQty" style="width:10%;" />
                            <a id="btncommit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Commit</a>
                        </td>
                        <td style="width:35%; text-align:left">
                           
                        </td>
                    </tr>
                </table>
              
            </fieldset>
</div>
        <div style="height:10%;width:100%;overflow:hidden;">
            <fieldset>
                <legend>Action</legend>
                <div class="align-right">
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </div>
            </fieldset>
        </div>
    </div>
    
</body>

<script type="text/javascript">
    var _oPTU = null;
    var _sBaseAddress = "";
    var _oAuthorizationRolesMapping = [];
    var _oOrderTypes=[];
    var  _oDyeingOrderDetails=[];
    var _nSelectedRowIndex=-1;
    var _oPTUDistributions=[];
    var _oPTUDistribution=null;
    var _nSelectedIndex=-1;
    $(document).ready(function() {
        debugger;

        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));

        _nMenuid = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oPTU =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oDyeingOrderDetails=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DyeingOrderDetails));
        _oPTUDistributions=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PTUDistributions));
        _oOrderTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.OrderTypes));
        DynamicRefreshList(_oPTUDistributions, 'tblPTUDistribution');
        RefreshControl();

      


    });


    function RefreshControl()
    {

        $("#cboOrderType").icsLoadCombo({
            List: _oOrderTypes,
            OptionValue: "OrderType",
            DisplayText: "ShortName"
        });

        debugger;
         $(".lblMUnit").html("(LBS)");
        $('#txtContractorName').val(_oPTU.ContractorName);
        $('#txtBuyerName').val(_oPTU.BuyerName);
        $('#txtPINo').val(_oPTU.PINo);
        $('#txtProductName').val(_oPTU.ProductName);
        $('#txtColor').val(_oPTU.ColorNameShade);
        $('#txtColorNo').val(_oPTU.ColorNo);
        $('#txtLabDipNo').val(_oPTU.LabdipNo);

        $('#txtProductionPipeLineQty').val(formatPrice(_oPTU.ProductionPipeLineQty,null));
        $('#txtActualDeliveryQty').val(formatPrice(_oPTU.ActualDeliveryQty,null));
        RefreshOrderQty();
        RefreshSummary();
    }
    function RefreshOrderQty()
    {
        $('#txtOrderQty').val(formatPrice(_oPTU.OrderQty,null));
        $('#txtYetToProduction').val(formatPrice(_oPTU.OrderQty+_oPTU.ReOrderQty+_oPTU.ReturnQty -_oPTU.ReadyStockInhand -_oPTU.ActualDeliveryQty,null));
        $('#txtYetToDelivery').val(formatPrice(_oPTU.OrderQty+_oPTU.ReOrderQty+_oPTU.ReturnQty -_oPTU.ActualDeliveryQty,null));
    }


    function RefreshSummary()
    {
        debugger;
        var oPTUDistributions = $('#tblPTUDistribution').datagrid('getRows');
        var nTotalQty = 0;
        for(var i = 0; i<oPTUDistributions.length;i++)
        {
            nTotalQty+=parseFloat(oPTUDistributions[i].Qty);
        }
        document.getElementById('lblTotalQty').innerHTML = formatPrice(nTotalQty,0);

        nTotalQty = 0;
        var oPTUDistributions_Source = $('#tblPTUDistribution_Source').datagrid('getRows');
        for(var i = 0; i<oPTUDistributions_Source.length;i++)
        {
            nTotalQty+=parseFloat(oPTUDistributions_Source[i].Qty);
        }
        document.getElementById('lblTotalQty_Source').innerHTML = formatPrice(nTotalQty,0);
      
    }

    //$("#btnPrintPreview").click(function() {
    //    var oDyeingOrderDetail= $('#tblDyeingOrderDetail').datagrid('getSelected');
    //    if(oDyeingOrderDetail==null || oDyeingOrderDetail.ExportSCID<=0)
    //    {
    //        alert("Please select a item from list!");
    //        return;
    //    }
    //    var nts = ((new Date()).getTime()) / 1000;
    //    window.open(_sBaseAddress + '/PTU/PrintStatement_DOBalance?nExportSCID=' + parseInt(oDyeingOrderDetail.ExportSCID) + "&nDOID=" + parseInt(0) + "&nProductID=" + parseInt(oDyeingOrderDetail.ProductID) + "&nts=" + nts, "_blank");

    //});

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnPickOrderNo").click(function () {

        if (parseInt($("#cboOrderType").val())<=0 ) {

            alert("Please Select Order Type.");
            $('#cboOrderType').focus();
            $('#cboOrderType').removeClass("errorFieldBorder");
            return;
        }
       
        var oRouteSheetDO = {
            OrderTypeInt:$('#cboOrderType').val(),
            OrderNo:$.trim($("#txtOrderNo").val()),
            LabDipDetailID:0
        };

        GetOrders(oRouteSheetDO);
    });

    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sOrderNo=$.trim($("#txtOrderNo").val());
          
            if(sOrderNo=="" || sOrderNo==null)
            {
                alert("Please Type No or part of No");
                $('#txtOrderNo').focus();
                $('#txtOrderNo').removeClass("errorFieldBorder");
                return;
            }

            if (parseInt($("#cboOrderType").val())<=0 ) {
                alert("Please Select Order Type.");
                $('#cboOrderType').focus();
                $('#cboOrderType').removeClass("errorFieldBorder");
                return;
            }

            var oRouteSheetDO = {
                OrderTypeInt:$('#cboOrderType').val(),
                OrderNo:sOrderNo,
                LabDipDetailID:0
            };
            GetOrders(oRouteSheetDO);
        }
        else if(nkeyCode==8){
            $("#txtOrderNo").val("");
           
        }
    });
    function GetOrders(oRouteSheetDO){

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRouteSheetDO,
            ControllerName: "PTU",
            ActionName: "GetsDyeingOrderDetail",
            IsWinClose: false
        };
        //$("#progressbar").progressbar({ value: 0 });
        //$("#progressbarParent").show();
        $.icsDataGets(obj, function (response) {
            //clearInterval(intervalID);
            //$("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DyeingOrderDetailID > 0) {
                    debugger;
                    var tblColums = [];
                    var ncboOrderType=parseInt($("#cboOrderType").val());
                    var oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    if( ncboOrderType===5)
                    {
                        oColumn = { field: "ClaimOrderNo", title: "ClaimOrderNo", width: 75, align: "left" };tblColums.push(oColumn);
                    }
                    oColumn = { field: "OrderQty", title: "OrderQty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_Pro", title: "Prod Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_RS", title: "Yet To Pro", width: 75, align: "right" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn", width: 225, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ShadeSt", title: "Shade", width: 40, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LabdipNo", title: "LabdipNo", width: 100, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 1000,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }

    $("#btnPickLot_PTUD").click(function () 
    {
        var sLotNo=$.trim($("#txtLotNo_PTUD").val());
        if(sLotNo=="" || sLotNo==null)
        {
            alert("Please Type No or part of No");
            $('#txtOrderNo').focus();
            $('#txtOrderNo').removeClass("errorFieldBorder");
            return;
        }
        var oPTUDistribution={PTUID:0 ,LotNo:sLotNo};
        GetsPTUDIS(oPTUDistribution)
    });
    $("#txtLotNo_PTUD").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLotNo=$.trim($("#txtLotNo_PTUD").val());
            if(sLotNo=="" || sLotNo==null)
            {
                alert("Please Type No or part of No");
                $('#txtOrderNo').focus();
                $('#txtOrderNo').removeClass("errorFieldBorder");
                return;
            }

            var oPTUDistribution={PTUID:0 ,LotNo:sLotNo};
            GetsPTUDIS(oPTUDistribution)
        }
        else if(nkeyCode==8){
            $("#txtLotNo_PTUD").val("");
            
        }
    });
    function GetsPTUDIS(oPTUDistribution){

    
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUDistribution,
            ControllerName: "PTUDistribution",
            ActionName: "Gets",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "ProductName", title: "Name", width: 220, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LotNo", title: "LotNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Qty", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "OrderNo", title: "OrderNo", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "MUName", title: "Unit", width: 60, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winPTUDisPicker',
                        winclass:'clsPTUDesPicker',
                        winwidth: 750,
                        winheight: 460,
                        tableid: 'tblPTUPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'LotNo',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No product found.");
            }
        });


    }

    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        
    
         if (oPickerobj.winid == 'winOrderPicker')
        {
            if (oreturnObj != null && oreturnObj.PTUID > 0)
            {
                $('#txtOrderNo').val(oreturnObj.ProductName+","+oreturnObj.ColorNameShade);
                var oPTUDistribution={PTUID:oreturnObj.PTUID ,LotNo:''};
                LoadLots(oPTUDistribution);
            }
            else{
                alert("Data Not Found.");
                return;
            }
         }
         else if (oPickerobj.winid == 'winPTUDisPicker')
         {
             if (oreturnObj != null && oreturnObj.LotID > 0)
             {
                 $('#txtLotNo_PTUD').val(oreturnObj.LotNo);
                 var oPTUDistribution={PTUID:0 ,LotID:oreturnObj.LotID};
                 LoadLots(oPTUDistribution);
             }
             else{
                 alert("Data Not Found.");
                 return;
             }
         }
        
    }

  
    function LoadLots(oPTUDistribution)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUDistribution,
            ControllerName: "PTUDistribution",
            ActionName: "Gets",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0)
            {
                var oPTUDistributions= response.objs;
                DynamicRefreshList(oPTUDistributions, 'tblPTUDistribution_Source');
                RefreshSummary();
            }
        });
    }


    $('#tblPTUDistribution_Source').datagrid({ onSelect: function (rowIndex, rowData) { PTUDistribution_SourceSelection(rowIndex, rowData); } });

    function PTUDistribution_SourceSelection(rowIndex, rowData){
     
        $('#txtTransferQty').val("");
        _oPTUDistribution=null;
        var oPTUDistributions_Source = $('#tblPTUDistribution_Source').datagrid('getRows');
        if(rowData!=null && rowData.PTUDistributionID>0)
        {
            
            for(var i=0; i<oPTUDistributions_Source.length;i++){
                if(oPTUDistributions_Source[i].PTUDistributionID==rowData.PTUDistributionID){
                    document.getElementById('lbTransfer').innerHTML = "Transfer From Lot:"+oPTUDistributions_Source[i].LotNo+", Qty(Lbs):";
                    $('#txtTransferQty').val(oPTUDistributions_Source[i].Qty);
                    _oPTUDistribution=oPTUDistributions_Source[i];
                    _nSelectedIndex=rowIndex;
                   
                }
            }
            
        }
   
    }


    $('#btncommit').click(function () {

        

        if (_oPTUDistribution ==null || _oPTUDistribution.PTUDistributionID <=0 )
        { alert("Please select an item from list."); return ; }

        if (_oPTU ==null || _oPTU.PTUID <=0 )
        { alert("Please select an valid Order."); return ; }

        var nQty_PTUD_Source= _oPTUDistribution.Qty;
        if(parseFloat($("#txtTransferQty").val())<=0)
        {
            alert("Your entry Qty is in valid.");
            $("#txtTransferQty").focus();
            $('#txtTransferQty').addClass("errorFieldBorder");
            return ;
        }
        if(parseFloat($("#txtTransferQty").val())>parseFloat(nQty_PTUD_Source))
        {
            alert("You can't  exced Source lot Qty.");
            $("#txtTransferQty").focus();
            $('#txtTransferQty').addClass("errorFieldBorder");
            return ;
        }

        _oPTUDistribution.PTUID_Dest=_oPTU.PTUID;
        _oPTUDistribution.Qty=$("#txtTransferQty").val();
        var conf = confirm("Are you sure you want to Transfer Lot ?");
        if(conf==false)return;
      
        $.ajax({
            type: "POST",
            dataType: "json",

            url : _sBaseAddress+  "/PTUDistribution/PTUToPTU_Transfer",
            traditional: true,
            data:  JSON.stringify(_oPTUDistribution),

            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oPTUDistribution = jQuery.parseJSON(data);
                if ( oPTUDistribution.ErrorMessage=="" || oPTUDistribution.ErrorMessage==null )
                {
                    _oPTUDistribution.Qty= parseFloat(nQty_PTUD_Source)-parseFloat($("#txtTransferQty").val());
                    $('#tblPTUDistribution_Source').datagrid('updateRow', { index: _nSelectedIndex, row: _oPTUDistribution });
                    _oPTUDistribution=null;
                    _nSelectedIndex=-1;
                    AppendPTUD_Destanation(oPTUDistribution);
                    alert("Lot transfer done successfully");
                   
                }
                else
                {
                    alert(oPTUDistribution.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });

    });

    function AppendPTUD_Destanation(oTempoPTUDistribution)
    {

        var oPTUDistributions = $("#tblPTUDistribution").datagrid("getRows");
        var nFlag = 0;
        for (var i = 0; i < oPTUDistributions.length; i++) {

            if (oPTUDistributions[i].LotID == oTempoPTUDistribution.LotID) {
                $('#tblPTUDistribution').datagrid('updateRow', { index: i, row: oTempoPTUDistribution });
                nFlag = 1;
                break;
            }
        }
        if (nFlag == 0) {
            var nIndex = oPTUDistributions.length;
            $("#tblPTUDistribution").datagrid("appendRow", oTempoPTUDistribution);
            $("#tblPTUDistribution").datagrid("selectRow", nIndex);
        }
    }

</script>