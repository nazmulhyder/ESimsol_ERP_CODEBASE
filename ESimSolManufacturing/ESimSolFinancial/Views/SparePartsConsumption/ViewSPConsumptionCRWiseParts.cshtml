@{
    ViewBag.Title = "Spare Parts Consumption Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model ESimSol.BusinessObjects.SparePartsConsumptionRegister

<div id="divSPCRegister" style="margin-left:0px; width:100%; height:89%" class="menuMainCollectionTable">
    <table id="tblSPCRegister" style="width:896px;height:548px" title="Spare Parts List" class="easyui-datagrid" fit="true" fitcolumns="true" showfooter="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="true" toolbar="#toolbar">
        <thead>
            <tr>
                <th field="ProductCode" width="10%">Code</th>
                <th field="ProductName" data-options="formatter:cellClickEvent" width="55%">Spare Parts Name</th>
                <th field="ConsumptionQty" width="14%" formatter="formatPrice" align="right">Consumption Qty</th>
                <th field="MUnitName" width="5%">Unit</th>
                <th field="Amount" align="right" formatter="formatPrice" width="14%">Consumption Amount</th>
            </tr>
        </thead>
    </table>
    <div id="toolbar" style="height:auto">
        <table>
            <tr>
                <td>
                    <select id="cboBU" style="height:24px; min-width:125px"></select>
                    <select id="cboResourceTypes" style="height:24px; min-width:125px"></select>
                    <label>Capital Resource :</label>
                    <input type="text" id="txtSearchByCode" placeholder="Search by Code" style="width:110px" />
                    <input type="text" id="txtSearchByName" placeholder="Search by Name" style="width:110px" />
                    <label>Spare Parts :</label>
                    <input type="text" id="txtSearchBySPCode" placeholder="Search by Code" style="width:125px" />
                    <input type="text" id="txtSearchBySPName" placeholder="Search by Name" style="width:125px" />
                    <input type="text" class="easyui-datebox" style="width: 110px; font-size:11px;" id="txtDateFrom" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    <label>to</label>
                    <input type="text" class="easyui-datebox" style="width: 110px; font-size:11px;" id="txtDateTo" data-options="formatter:icsdateformat,parser:icsdateparser" />
                    <a id="btnSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true"></a>
                    <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Print</a>
                </td>
            </tr>
        </table>

    </div>

</div>
<div style="width:100%; height:10%">
    <fieldset>
        <legend style="font-weight: bold">Action : </legend>
        <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
            <tr>
                <td style="width:80%; text-align:right"></td>
                <td style="width:20%">
                    <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </td>
            </tr>
        </table>
    </fieldset>
</div>
<script type="text/javascript">
    var _nSelectedIndex = 0;
    $(document).ready(function () {
        debugger;
        var sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oSPCRegister = @Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oResourcesTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ResourcesType));
        var oBUs = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUs));

        $('#divSPCRegister').data('CRID', oSPCRegister.CRID);
        $('#divSPCRegister').data('BaseAddress', sBaseAddress);
        $("#cboBU").icsLoadCombo({List: oBUs, OptionValue: "BusinessUnitID", DisplayText: "ShortName", InitialValue:"Business Unit"});
        $("#cboResourceTypes").icsLoadCombo({List: oResourcesTypes, OptionValue: "CRID", DisplayText: "Name", InitialValue:"Resources Type"});
        RefreshControl(oSPCRegister);
        RefreshList(oSPCRegister.SparePartsConsumptionRegisters);
        ChangeHeader(oSPCRegister.SearchingCiteria);
    });
    function RefreshControl(oSPCRegister)
    {
        $('#cboBU').val(oSPCRegister.BUID);
        $('#cboResourceTypes').val(oSPCRegister.ResourceType);
        $('#txtDateFrom').datebox('setValue',oSPCRegister.StartDateSt);
        $('#txtDateTo').datebox('setValue',oSPCRegister.EndDateSt);
        $('#txtSearchByCode').val(oSPCRegister.CRCode);
        $('#txtSearchByName').val(oSPCRegister.CRName);
        $('#txtSearchBySPCode').val(oSPCRegister.ProductCode);
        $('#txtSearchBySPName').val(oSPCRegister.ProductName);
        if(oSPCRegister.BUID>0)
        {
            $('#cboBU').val(oSPCRegister.BUID);
            $('#cboBU').prop("disabled", true);
        }
    }
    function RefreshList(oSPCRegisters)
    {
        data=oSPCRegisters;
        data={"total":""+data.length+"","rows":data};
        $('#tblSPCRegister').datagrid('loadData',data);
        if(sessionStorage.getItem('SPCRegisterCRWiseParts')!=null)
        {
            var nID = JSON.parse(sessionStorage.getItem('SPCRegisterCRWiseParts')).LineNumber;
            $('#tblSPCRegister').datagrid('selectRow', nID);
        }
        $.icsMakeFooterColumn('tblSPCRegister',['ProductCode','ConsumptionQty','Amount']);
    }
    function ChangeHeader(oText)
    {
        var p = $('#tblSPCRegister').datagrid('getPanel');  // get the panel object
        p.panel('setTitle',oText);
    }
    function cellClickEvent(value,row,index) {
        return '<a id="btnShowDetail" href="javascript:void(0)" class="easyui-linkbutton" style="font-weight:bold" iconcls="" plain="true" onclick="CellOnClick('+row.ProductID+','+index+')">'+row.ProductName+'</a>';
    }
    function CellOnClick(nProductID, index) {
        debugger;
        _nSelectedIndex = index;
        SetObjectIntoSession(50);       //for destination Page
        sessionStorage.setItem("BackLinkSecondLayer", window.location.href);
        window.location.href = $('#divSPCRegister').data('BaseAddress')+  "/SparePartsConsumption/ViewSPConsumptionTransaction?nCRID="+$('#divSPCRegister').data('CRID')+"&buid="+sessionStorage.getItem('BUID')+"&nSPID=" + nProductID;
    }
    $('#btnClose').click(function(e)
    {
        SetObjectIntoSession(46);
        var menuid = sessionStorage.getItem("BackLinkFirstLayer").slice(-4);
        window.location.href = $('#divSPCRegister').data('BaseAddress')+  "/SparePartsConsumption/ViewSPConsumptionCR?isMenu=0&buid="+sessionStorage.getItem('BUID')+"&menuid=" + menuid;
    });
    //-----------------------Basic Search(Start)--------------------------------------//
    function MakeObject(nReportLayout)
    {
        var tempObj = {
            BUID: sessionStorage.getItem("BUID"),
            StartDate:$('#txtDateFrom').datebox('getValue'),
            EndDate:$('#txtDateTo').datebox('getValue'),
            CRName:$('#txtSearchByName').val(),
            CRCode:$('#txtSearchByCode').val(),
            ProductName:$('#txtSearchBySPName').val(),
            ProductCode:$('#txtSearchBySPCode').val(),
            ReportLayout: nReportLayout
        }
        return tempObj;
    }
    $('#btnSearch').click(function(e)
    {
        SetObjectIntoSession(47);
        var obj = MakeObject(47);
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/SparePartsConsumption/Gets",
            traditional: true,
            data:  JSON.stringify(obj),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                if(data.SparePartsConsumptionRegisters.length>0)
                {
                    RefreshList(data.SparePartsConsumptionRegisters);
                }
                else{alert("No Data Found !!");}

            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });
    function SetObjectIntoSession(nReportLayout)
    {
        debugger;
        //-----------------set page control into session(START)-----------------//
        var oLayoutControl = MakeObject(47);
        var oSPCRegister = $('#tblSPCRegister').datagrid('getRows')[_nSelectedIndex ];
        oLayoutControl.LineNumber = _nSelectedIndex;
        sessionStorage.setItem("SPCRegisterCRWiseParts", JSON.stringify(oLayoutControl));
        //-----------------set page control into session (END)-----------------//

        var obj = [];
        if(nReportLayout == 46)         // previous page
        {
            obj = JSON.parse(sessionStorage.getItem("SPCRegisterCR"));
        }
        if(nReportLayout == 47)        //searching
        {
            obj = MakeObject(nReportLayout);
        }
        else if(nReportLayout == 50)    // next page
        {
            if(sessionStorage.getItem('SPCRegisterTransaction')==null)
            {
                obj = MakeObject(nReportLayout);
                obj.ProductID = oSPCRegister.ProductID;
                obj.ProductCode = oSPCRegister.ProductCode;
                obj.ProductName = oSPCRegister.ProductName;
            }
            else
            {
                obj = JSON.parse(sessionStorage.getItem('SPCRegisterTransaction'));
                obj.ProductID = oSPCRegister.ProductID;
                obj.ProductCode = oSPCRegister.ProductCode;
                obj.ProductName = oSPCRegister.ProductName;
            }
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url : $('#divSPCRegister').data('BaseAddress')+  "/SparePartsConsumption/SetSessionData",
            traditional: true,
            data:  JSON.stringify(obj),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                ChangeHeader(JSON.parse(data));
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }
    $('#btnPrint').click(function(e)
    {
        SetObjectIntoSession(47);
        var nts = (new Date().getTime()) / 1000;
        window.open($('#divSPCRegister').data('BaseAddress') +"/SparePartsConsumption/PrintCapitalResourceList?nBuid="+ sessionStorage.getItem('BUID') +"&nReportLayout=47&nts="+nts , "_blank");
    });

    //-----------------------------PRINT------------------------------------//

    //$('#btnPrint').click(function(e)
    //{
    //    var oCR = $('#tblSPCRegister').datagrid('getSelected');
    //    if(oCR==null ||oCR.id<=0) { alert("Please select a valid item");return; }
    //    var nts = (new Date().getTime()) / 1000;
    //    window.open(_sBaseAddress +"/SparePartsConsumptionRegister/PrintMachine?nCRID="+oCR.CRID+"&nts="+nts , "_blank");
    //});
    //$('#btnPrintList').click(function(e)
    //{
    //    var nts = (new Date().getTime()) / 1000;
    //    window.open(_sBaseAddress +"/SparePartsConsumptionRegister/PrintMachineList?nBuid="+ _nBUID +"&nts="+nts , "_blank");
    //});
    //-----------------------------PRINT(END)------------------------------------//

</script>

