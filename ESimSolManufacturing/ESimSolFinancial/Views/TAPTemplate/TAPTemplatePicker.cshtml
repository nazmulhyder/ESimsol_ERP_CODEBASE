<html>
<head>
    
    <link href="@Url.Content("~/Content/CSS/icon.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/easyui.css")" rel="stylesheet" type="text/css" /> 
    <link href="@Url.Content("~/Content/CSS/Pikerstyle.css")" rel="stylesheet" type="text/css" />  

    <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>            
    <script src="@Url.Content("~/Scripts/jquery.ics.customize.js")" type="text/javascript"></script>  
    <script src="@Url.Content("~/Scripts/jquery.easyui.min.js")" type="text/javascript"></script>    

    <script src="@Url.Content("~/Scripts/jquery-ui.min.js")" type="text/javascript"></script> 
    <script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script>  
</head>
<body>


@model ESimSol.BusinessObjects.TAPTemplate

<div style="font-family:Tahoma">
    <table border="0" style="background-color:#CFB53B;width:745px">
        <tr>            
            <td style="width:745px; text-align:center; text-decoration:underline; font-size:15px; color: White; font-weight:bold;"><label id="lblHeaderName">Template  Search</label></td>
        </tr>
    </table>
    <table border="0" cellpadding="0" cellspacing="0" style ="font-size:12px" >
        <tr style="height:270px">
            <td style="width:500px">
                    <table border="0" cellpadding="0" cellspacing="0" style ="font-size:12px;margin-left:3px;">
                        <tr style="height:260px">  
                            <td style="width:400px; vertical-align:top;height:450px;">

                                    <table id="tblTAPTemplate" title=" Template Info " class="easyui-datagrid" style="width:370px;height:450px;font-size:12px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" , autorowheight="false">
                                        <thead>
                                            <tr>
                                                <th field="TemplateNo" width="110">Template No</th>
                                                <th field="TemplateName" width="215">Template Name</th>
                                            </tr>
                                        </thead>
                                    </table>  

               
                            </td>  
      
                            <td style="width:323px; height:453px;vertical-align:top">

                                    <table id="tblTAPTemplateDetail" title="Template Details" class="easyui-datagrid" style="width:370px;height:450px;font-size:12px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" , autorowheight="false">
                                        <thead>
                                            <tr>
                                                <th field="OrderStepName" width="180">Step Name</th>
                                                <th field="BeforeShipment" width="145"><label id="lblTemplateCalculationType">Before Shipment(Days)</label></th>
                                            </tr>
                                        </thead>
                                    </table>                   
                            </td>
                            
                        </tr>
                    </table>
            </td>
        </tr>
      <tr style="height:50px; width:750px;">
            <td style="width:650px; text-align:right">
                <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="OkButtonClick()">Ok</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" onclick="Close()">Close</a>               
            </td>
        </tr>
    </table>
</div>
</body>
</html>
<script type="text/javascript">
    var _sBaseAddress="";
    var obj = window.dialogArguments;
    var _oTAPTemplate="";
    var _oTAPTemplateDetails=[];
    var _oTAPTemplateList = null;

    $(document).ready(function () {
    debugger;
           //var obj = window.dialogArguments;
            _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress])); 
            _oTAPTemplate=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
            _oTAPTemplateList=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.TAPTemplates));
            _oTAPTemplateDetails =  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.TAPTemplateDetails));
            RefreshList(_oTAPTemplateList);

    }); 

  
  function RowSelect(oTAPTemplate)
  {
      if(parseInt(oTAPTemplate.CalculationType)==1)
      {
          $('#lblTemplateCalculationType').html("Before Shipment(%)");
      }else{
          $('#lblTemplateCalculationType').html("Before Shipment(Days)");
      }
      var oTAPTemplateDetails = [];
    for(var i = 0;i<_oTAPTemplateDetails.length;i++)
    {
        if(parseInt(_oTAPTemplateDetails[i].TAPTemplateID) == parseInt(oTAPTemplate.TAPTemplateID) && parseInt(_oTAPTemplateDetails[i].OrderStepParentID) == 1)   
      {
        oTAPTemplateDetails.push(_oTAPTemplateDetails[i]);
      }
    }
    oTAPTemplateDetails.sort(compare);
    RefreshTAPTemplateDetails(oTAPTemplateDetails);
  }

  function compare(a,b) {
      if (a.Sequence < b.Sequence)
          return -1;
      if (a.Sequence > b.Sequence)
          return 1;
      return 0;

  }
 function RefreshTAPTemplateDetails(oTAPTemplateDetails)
  {    
          data=oTAPTemplateDetails;
          data={"total":""+data.length+"","rows":data};
          $('#tblTAPTemplateDetail').datagrid('loadData',data);
 }


 function RefreshList(oTAPTemplates)
{
        data =oTAPTemplates;       
        data={"total":""+data.length+"","rows":data};
        $('#tblTAPTemplate').datagrid('loadData',data);
        $('#tblTAPTemplate').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowData);}});  
}



    function OkButtonClick()
    { 
    debugger;    
        var oTAPTemplateDetails=[];
        var oTAPTemplate = $('#tblTAPTemplate').datagrid('getSelected');               
        if(oTAPTemplate==null || oTAPTemplate.TAPTemplateID<=0)
        {
            alert("Sorry, Please Select TAP Template");
            return;
        }
        for(var i =0;i<_oTAPTemplateDetails.length;i++)
        {
            if(parseInt(_oTAPTemplateDetails[i].TAPTemplateID) == parseInt(oTAPTemplate.TAPTemplateID))   
            {
                oTAPTemplateDetails.push(_oTAPTemplateDetails[i]);
            }
        }
        //oTAPTemplateDetails.sort(compare);//normal sequence
        //Sequence Manage
        debugger;
        var oTAPTemplate = {TAPTemplateDetails:oTAPTemplateDetails};
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/TAPTemplate/GetSequenceManagedTAPTemplateDetails",
            traditional: true,
            data:  JSON.stringify(oTAPTemplate),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oTAPTemplateDetails= jQuery.parseJSON(data);
                if (oTAPTemplateDetails.length>0)
                {
                    window.returnValue= oTAPTemplateDetails;            
                    window.close();
                }else{
                    alert("Data not found");
                    return;
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
        
    }
      
   function Close()
   {
     window.close();
   }



$(document).keydown(function(e) {    
    //debugger;
    if(e.which == 27)//escape=27
    {
        //debugger;        
        window.close();
    }
});

</script>