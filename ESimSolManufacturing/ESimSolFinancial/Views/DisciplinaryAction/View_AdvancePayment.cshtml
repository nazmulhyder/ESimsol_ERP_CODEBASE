<!DOCTYPE html>
<html>
<head>
    <title>Advance Payment</title>
    <link href="@Url.Content("~/Content/CSS/icon.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/easyui.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/CSS/Pikerstyle.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.ics.customize.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.easyui.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery-ui.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script>
</head>
<body>

    @model IEnumerable<ESimSol.BusinessObjects.DisciplinaryAction>
        <table border="0" cellspacing="0" cellpadding="0">
            <tr>
                <td style="background-color: #cfb53b; text-align: center; width: 1055px; color: White">
                    <label id="lblHeader" style="font-size:20px; font-weight: bold; text-decoration: Underline; font-family:Tahoma">
                        Advance Payment
                    </label>
                </td>
            </tr>

        </table>
        <div style="margin-left:0px; height:452px; font-family:Tahoma">
            @*<table id="tblDAP" class="easyui-datagrid" style="width:1055px;height:452px;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar">*@

            <table id="tblDAP" class="easyui-datagrid" style="width: 1055px; height: 452px;"
                   fitcolumns="false" pagination="false" singleselect="true" autorowheight="false"
                   toolbar="#toolbar" data-options="singleSelect: false, fitColumns:false,  rownumbers:true,pagination:false,autoRowHeight:false, toolbar: '#toolbar1', onClickRow: onClickRow">
                <thead>
                    <tr>
                        <th data-options="field:'Selected',checkbox:true"></th>
                        <th field="EmployeeCode" width="200" align="left">Employee Code</th>
                        <th field="EmployeeName" width="200" align="left">Employee Name</th>
                        <th field="DesignationName" width="150" align="left">Designation</th>
                        <th field="ProductionAmount" width="150" align="left" formatter="formatPrice">Production Amount(tk.)</th>
                        @*<th field="NetPayment" width="150" align="left" formatter="formatPrice">Net Payment(tk.)</th>*@
                        <th id="NetPayment" data-options="field:'NetPayment',width:150,align:'right',editor:{type:'numberbox',options:{precision:0}}" align="center">Net Payment(tk.)</th>
                        <th field="JoiningDateInString" width="140" align="left">Joinning Date</th>

                    </tr>
                </thead>
            </table>
            ​<table>
                <tr>
                    <td>
                        @*Load <input id="txtLoadRecords" type="text" style="width:70px"/>  &nbsp; Records*@
                        <input id="chkRange" type="checkbox" />Range
                        <label id="lblRange1">
                            <input id="txtFrom" type="text" style="width:40px" />&nbsp; To &nbsp;
                        </label>
                        <label id="lblRange2">
                            <input id="txtTo" type="text" style="width:40px" />
                        </label>
                        &nbsp; &nbsp;
                        <label id="lblcount"></label>
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="Next()">Next</a>
                    </td>
                </tr>
            </table>
            <div id="toolbar" style="height : 50px;">
                Prod. Date :
                <input id="dtDateFrom" type="text" style="width: 95px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />&nbsp; To &nbsp;
                <input id="dtDateTo" type="text" style="width: 95px" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />&nbsp;&nbsp;
                <input id="txtEmployeeCode" style="width:180px;" type="text" placeholder="Type Code & Enter" />
                <input id="btnEmployee" type="button" value="P" />
                <input id="btnCEmployee" type="button" value="C" style="margin-right:2px;" />
                <input id="txtDepartment" type="text" style="width:130px;" placeholder="Pick Department" />
                <input id="btnDepartment" type="button" value="P" onclick="DepartmentPicker()" />
                <input id="btnCDepartment" type="button" value="C" style="margin-right:2px;" />
                
                <input id="txtDesignation" type="text" style="width:130px;" placeholder="Pick Designation" />
                <input id="btnDesignation" type="button" value="P" onclick="DesignationPicker()" />
                <input id="btnCDesignation" type="button" value="C" style="margin-right:2px;" />
                @*<a id="btnSearchByDepartmentAndDateRange" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-search" onclick="SearchWithPasignation()">Search</a>*@
                &nbsp;
                <br />
                Exe. Date   &nbsp;:
                <input id="dtExeDate" type="text" style="width: 95px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" plain="true" iconcls="icon-save" onclick="Save()">Save</a>
                <a id="btnRemoveFromGrid" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove from the list</a>
            </div>
        </div>
</body>
</html>
<script type="text/javascript">
    var _oDAPs=[];
    var _sBaseAddress="";
    var _obj=null;
    var _sEmployeeIds ="";
    var _oEmployee = null;
    var _oEmployees=[];
    var _nLoadRecords = 0;
    var _nRowLength = 0;
    var _bNext = false;
    var _nLastDAPID=0;
    var _sDesignationIDs = "" ;
    var _sDesignationNames = "";
    var _sDepartmentIds = "" ;
    var _sDepartmentNames = "";

    $(document).ready(function ()
    {
        _oDAPs =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _obj = window.dialogArguments;

        $('#dtDateFrom').datebox('setValue', icsdateformat(new Date()));
        $('#dtDateTo').datebox('setValue', icsdateformat(new Date()));
        $('#dtExeDate').datebox('setValue', icsdateformat(new Date()));
        $('#txtLoadRecords').numberbox({min:0, precision:0 });
        $('#txtFrom').numberbox({min:0, precision:0 });
        $('#txtTo').numberbox({min:0, precision:0 });

        $('#txtFrom').numberbox('setValue',1);
        $('#txtTo').numberbox('setValue',50);
        document.getElementById("lblRange1").style.display = 'none';
       
        if(_obj.oDAs.length>0)
        {
            data = _obj.oDAs ;
            data = { "total": "" + data.length + "", "rows": data };
            $('#tblDAP').datagrid('loadData', data);
            $('#dtExeDate').datebox('setValue', _obj.oDAs[0].ExecutedOnInString);
        }
    });

    $('#chkRange').click(function()
    {
        if(document.getElementById("chkRange").checked == true)
        {
            document.getElementById("lblRange1").style.display = '';
        }
        else
        {
            document.getElementById("lblRange1").style.display = 'none';

        }
    });

    function  icsdateformat(date)
    {
        var mthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        var y = date.getFullYear();
        var m = date.getMonth();
        var d = date.getDate();
        var result= d +' '+ mthNames[m]+' '+ y;
        return result;
    }

    $('#txtEmployeeCode').keypress(function (e)
    {

        var code = (e.keyCode ? e.keyCode : e.which);
        var sEmpCode=document.getElementById("txtEmployeeCode").value;
        if (code == 13)//Enter key-13
        {
            if(sEmpCode=="")
            {
                alert("Please Enter Code !");
                return;
            }
            var nts=(new Date()).getTime()/1000;
            var oParameter = new Object();
            oParameter.MultipleItemReturn = false;
            var url = _sBaseAddress + "/Employee/EmployeePikerByCode?sCode="+sEmpCode+"&nDepartmentID=0"+"&nts="+nts;

            _oEmployee = window.showModalDialog(url, oParameter, 'dialogHeight:415px;dialogWidth:515px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');

            if(_oEmployee!=null)
            {
                //_nEmployeeID = _oEmployee.EmployeeID;
                $("#txtEmployeeCode")[0].value=_oEmployee.Name+"["+_oEmployee.Code+"]";
                _sEmployeeIds=_oEmployee.EmployeeID;
                SearchWithPasignation();
            }
        }
    });

    function RefreshList(oDAs)
    {
        debugger
        
        data = oDAs ;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblDAP').datagrid('loadData', data);
    }

    $('#btnCEmployee').click(function (e)
    {
        $("#txtEmployeeCode")[0].value = "";
        _oEmployees = [];
        _sEmployeeIds="";
        _oEmployee=null;
    });

    $('#btnEmployee').click(function (e)
    {
        var oParameter = new Object();
        oParameter.Name = "Employee Advance Search";
        oParameter.MultipleItemReturn=true;
        var url = _sBaseAddress + "/Employee/EmployeeHRMPiker";
        //_oEmployees = window.showModalDialog(url, oParameter, 'dialogHeight:510px;dialogWidth:1000px;dialogLeft:50;dialogRight:50;dialogTop:50;center:yes;resizable:yes;status:no;scroll:no');
        var nLeft=(window.screen.width/2)-(1000/2);
        var nHeight=(window.screen.height/2)-(530/2);
        _oEmployees = window.showModalDialog(url, oParameter, 'dialogHeight:530px;dialogWidth:1000px;dialogLeft:'+nLeft+';dialogTop:'+nHeight+';center:yes;resizable:no;status:no;scroll:yes');
        if(_oEmployees!=[] && _oEmployees.length>0)
        {
            var sIDs="";
            var sEmployeeName = "";
            for(var i=0; i<_oEmployees.length; i++)
            {
                sEmployeeName+=_oEmployees[i].Name+",";
                sIDs+=_oEmployees[i].EmployeeID+",";
            }
            sIDs=sIDs.substring(0,sIDs.length-1);
            sEmployeeName=sEmployeeName.substring(0,sEmployeeName.length-1);
            $("#txtEmployeeCode")[0].value=sEmployeeName;
            _sEmployeeIds=sIDs;
            SearchWithPasignation();
        }
    });

    function formatPrice(val,row)
    {


        if(val==null)
        {
            val=0.00;
        }
        val=parseFloat(val);
        var test = val.toFixed(2);
        var tests = addComma(test);
        return tests;
    }

    function addComma(nStr)
    {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? '.' + x[1] : '';
        var process = /(\d+)(\d{3})/;
        while (process.test(x1)) {
            x1 = x1.replace(process, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }

    function SearchWithPasignation()
    {
        if(_sEmployeeIds == "")
        {
            alert("Please enter employee!!");
            return;
        }

        if(!_bNext)
        {
            _nRowLength = 0;
            _nLastDAPID = 0;
        }

        //if(!ValidationOfStartTime()) return;
        //if(!ValidationOfEndTime()) return;

        var dtDateFrom= $('#dtDateFrom').datebox('getValue');
        var dtDateTo= $('#dtDateTo').datebox('getValue');

        //var dtDateFrom = GenerateStartTimeInString();
        //var dtDateTo = GenerateEndTimeInString();
        //_nLoadRecords = document.getElementById("txtLoadRecords").value;

        _nLoadRecords = document.getElementById("txtTo").value;
        if(document.getElementById("chkRange").checked == true)
        {
            var RangeFrom = 0;
            var RangeTo = 0;
            RangeFrom = parseFloat(document.getElementById("txtFrom").value);
            RangeTo = parseFloat(document.getElementById("txtTo").value);

            if(RangeFrom > RangeTo)
            {
                alert("Invalid Range !");
                return;
            }
            _nRowLength = 0;
            _nLoadRecords = 0;

            _nRowLength = RangeFrom-1;
            _nLoadRecords = RangeTo - RangeFrom +1;

        }

        var tsv = ((new Date()).getTime()) / 1000;
        var sParams = _sEmployeeIds+"~"+_sDepartmentIds+"~"+_sDesignationIDs+"~"+true+"~"+dtDateFrom+"~"+dtDateTo+"~"+false+"~"+"2 jan 2015"+"~"+"2 jan 2015"+"~"+_nLoadRecords+"~"+_nRowLength;
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/DisciplinaryAction/SearchWithPagination",
            data: JSON.stringify({sParams:sParams, ts: tsv}),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            {
                var oDAPs =[];
                oDAPs = jQuery.parseJSON(data);
                if(oDAPs.length>0 && oDAPs[0].ErrorMessage=="")
                {
                    //if(!_bNext)
                    //{
                    //    _oDAPs=[];
                    //    RefreshList(_oDAPs);
                    //}
                  
                    for (var j = 0; j < oDAPs.length; j++)
                    {
                        var oCurrentLists=$('#tblDAP').datagrid('getRows');
                        if(oCurrentLists.length>0)
                        {
                            for(var k=0;k<oCurrentLists.length;k++)
                            {
                                if(oDAPs[j].EmployeeID != oCurrentLists[k].EmployeeID)
                                {
                                    $('#tblDAP').datagrid('appendRow',oDAPs[j]);
                                }
                            }
                        }
                        else
                        {
                            $('#tblDAP').datagrid('appendRow',oDAPs[j]);
                        }
                    }
                }
                else
                {
                    if(_bNext == false)
                    {
                        alert("Data not found !!");
                        _oDAPs=[];
                        RefreshList(_oDAPs);
                    }
                    else
                    {
                        alert("No more data found !");
                    }
                }
                var oDAPs=$('#tblDAP').datagrid('getRows');
                document.getElementById("lblcount").innerHTML = " | Count ="+ oDAPs.length;
                _bNext = false;
            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function Next()
    {
        var oDAPs =[];
        oDAPs=$('#tblDAP').datagrid('getRows');
        _nRowLength = oDAPs.length;
        _bNext = true;

        if (oDAPs.length<=0)
        {
            alert('Please Select Criteria and click on "Search" to find information.!!');
            return;
        }
        var oDAP = oDAPs[oDAPs.length-1];

        if (_nLastDAPID==oDAP.DAPID)
        {
            alert('No more data found by this date range');
            return;
        }
        _nLastDAPID=oDAP.DAPID;
        SearchByDepartmentAndDateRangeWithPasignation();
    }


    function onClickRow(index)
    {
        debugger
        if (editIndex != index)
        {
            if (endEditing())
            {
                $('#tblDAP').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;

            }
            else
            {
                $('#tblDAP').datagrid('selectRow', editIndex);
            }
        }
    }

    var editIndex = undefined;

    function endEditing()
    {
        debugger
        if (editIndex == undefined){return true}
        if ($('#tblDAP').datagrid('validateRow', editIndex))
        {
            $('#tblDAP').datagrid('endEdit', editIndex);
            //oDAP= $('#tblDAP').datagrid('getSelected');
            //$('#tblDAP').datagrid('updateRow', { index: editIndex, row: oDAP });

            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }


    }

    function Save()
    {
        debugger;
        endEditing();
        var dtExeDate= $('#dtExeDate').datebox('getValue');
        var oDisciplinaryActions=$('#tblDAP').datagrid('getRows');
        if(oDisciplinaryActions.length<=0 || oDisciplinaryActions == null)
        {
            alert("Nothing to print!");
            return;
        }
        for(var i=0;i<oDisciplinaryActions.length;i++)
        {
            oDisciplinaryActions[i].Amount = oDisciplinaryActions[i].NetPayment;
            oDisciplinaryActions[i].ExecutedOn = dtExeDate;
            oDisciplinaryActions[i].Remark=oDisciplinaryActions[i].ProductionAmount;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/DisciplinaryAction/DisciplinaryAction_IUD_List",
            traditional: true,
            data: JSON.stringify(oDisciplinaryActions),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                debugger;
                oDAs = jQuery.parseJSON(data);
                if (oDAs[0].ErrorMessage=="")
                {
                    alert("Saved sucessfully!");
                    for(var i=0;i<oDisciplinaryActions.length;i++)
                    {
                        for(var j=0;j<oDAs.length;j++)
                        {
                            if(oDisciplinaryActions[i].EmployeeID ==oDAs[j].EmployeeID)
                            {
                                oDAs[j].ProductionAmount = oDisciplinaryActions[i].ProductionAmount ;
                                oDAs[j].NetPayment = oDAs[j].Amount ;
                            }
                        }
                    }
                    window.returnValue = oDAs;
                    window.close();
                }
                else
                {
                    alert(oDAs[0].ErrorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        });

    }
    
    $('#btnRemoveFromGrid').click(function (e)
    {
        var oDAPs= $('#tblDAP').datagrid('getChecked');
        if(oDAPs.length<=0)
        {
            alert("Please select at least onr item!");
            return;
        }

        for(var i=0; i<oDAPs.length;i++)
        {
            var SelectedRowIndex = $('#tblDAP').datagrid('getRowIndex', oDAPs[i]);
            $('#tblDAP').datagrid('deleteRow', SelectedRowIndex);
        }

    });
    function DepartmentPicker()
    {

        var oParameter = new Object();
        oParameter.MultipleItemReturn = true;
        var url = _sBaseAddress + "/Department/DepartmentPickerWithCheckBox?id=0";
        var oReturnObjects = window.showModalDialog(url, oParameter, 'dialogHeight:470px;dialogWidth:550px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
        if (oReturnObjects != null)
        {
            for(var i=0; i<oReturnObjects.length; i++)
            {
                _sDepartmentNames+=oReturnObjects[i].text+",";
                _sDepartmentIds+=oReturnObjects[i].id+",";
            }

            _sDepartmentNames=_sDepartmentNames.substring(0,_sDepartmentNames.length-1);
            _sDepartmentIds=_sDepartmentIds.substring(0,_sDepartmentIds.length-1);

            //_sDepartmentNames = oReturnObject.text;
            //_nDepartmentId = oReturnObject.id ;
            $("#txtDepartment").val(_sDepartmentNames);
            //$("#txtDepartment")[0].value = oReturnObject.text;
            //$("#departmentID")[0].value = oReturnObject.id;
            //var departmentID= oReturnObject.id;
        }
    }

    $('#txtDepartment').keypress(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oParameter = new Object();
            oParameter.MultipleItemReturn = false;
            var url = _sBaseAddress + "/Department/DepartmentPickerWithCheckBox?id=0";
            var oReturnObject = window.showModalDialog(url, oParameter, 'dialogHeight:470px;dialogWidth:550px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
            if (oReturnObject != null)
            {
                //for(var i=0; i<oReturnObjects.length; i++)
                //{
                //    _sDepartmentNames+=oReturnObjects[i].text+",";
                //    _sDepartmentIds+=oReturnObjects[i].id+",";
                //}

                //_sDepartmentNames=_sDepartmentNames.substring(0,_sDepartmentNames.length-1);
                //_sDepartmentIds=_sDepartmentIds.substring(0,_sDepartmentIds.length-1);

                _sDepartmentNames = oReturnObject.text;
                _sDepartmentIds = oReturnObject.id ;
                $("#txtDepartment").val(_sDepartmentNames);
                //$("#txtDepartment")[0].value = oReturnObject.text;
                //$("#departmentID")[0].value = oReturnObject.id;
                //var departmentID= oReturnObject.id;
            }
        }
    });

    $('#btnCDepartment').click(function (e)
    {
        document.getElementById("txtDepartment").value = "" ;
        _sDepartmentIds = "" ;
        _sDepartmentNames = "";
    });

    function DesignationPicker()
    {
        var oParameter = new Object();
        oParameter.MultipleItemReturn = true;
        var url = _sBaseAddress + "/Designation/DesignationPickerWithCheckBox?id=0";
        var oReturnObjects = window.showModalDialog(url, oParameter, 'dialogHeight:470px;dialogWidth:550px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
        if(oReturnObjects!=null)
        {
            for(var i=0; i<oReturnObjects.length; i++)
            {
                _sDesignationNames+=oReturnObjects[i].text+",";
                _sDesignationIDs+=oReturnObjects[i].id+",";
            }
            _sDesignationNames=_sDesignationNames.substring(0,_sDesignationNames.length-1);
            _sDesignationIDs=_sDesignationIDs.substring(0,_sDesignationIDs.length-1);
            $("#txtDesignation")[0].value = _sDesignationNames;
        }
    }

    $('#txtDesignation').keypress(function (e)
    {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var oParameter = new Object();
            oParameter.MultipleItemReturn = false;
            var url = _sBaseAddress + "/Designation/DesignationPickerWithCheckBox?id=0";
            var oReturnObject = window.showModalDialog(url, oParameter, 'dialogHeight:470px;dialogWidth:550px;dialogLeft:400;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
            if(oReturnObject!=null)
            {
                _sDesignationNames = oReturnObject.text;
                _sDesignationIDs = oReturnObject.id ;
                $("#txtDesignation").val(_sDesignationNames);
            }
        }
    });

    $('#btnCDesignation').click(function (e)
    {
        document.getElementById("txtDesignation").value = "" ;
        _sDesignationIDs = "" ;
        _sDesignationNames = "";
    });

</script>