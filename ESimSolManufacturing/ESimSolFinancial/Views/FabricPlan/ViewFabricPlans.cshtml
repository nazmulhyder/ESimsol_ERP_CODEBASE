@{
    ViewBag.Title = "Fabric Pattern List";
}
    @model IEnumerable<ESimSol.BusinessObjects.FabricPlanOrder>
      <div id="divFabricPlanOrder" class="menuMainCollectionTable" style="height:100%">
                              <div style="height:90%;">
                                  <table id="tblFabricPlanOrders" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarPlans">
                                      <thead>
                                          <tr>
                                              <th field="RefNo" width="10%">Fabric No</th>
                                              <th field="WeaveName" width="10%">Weave Name</th>
                                              <th field="ColumnCount" width="12%">No Of Column</th>
                                          </tr>
                                      </thead>
                                  </table>
                                  <div id="toolbarPlans">
                                   
                                      <a id="btnWarp" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Warp</a>
                                      <a id="btnWeft" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Weft</a>
                                      @*<select style="width:100px;height:22px;" id="cboWarp"></select>
                                      <a id="btnCopyFabricPlans44" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-copy" plain="true"></a>*@
                                      <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                                    
                                      <a id="btnPrintPO" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                                      <a id="btnPrintV1PO" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print(v1)</a>

                                  
                                      @*<a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>*@

                                      <select style="width:150px;height:22px;text-align:left" id="cboFabricPlanRefType"></select>
                                      <input id="txtSearchByRefno" style="width:150px;" class="reset-text" placeholder="Fabric ID" />
                                      <a id="btnCopyFabricAll" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-copy" plain="true"></a>

                                  </div>
                              </div>
                              <fieldset>
                                  <legend>Action</legend>
                                  <table border="0" cellpadding="0" cellspacing="0" style="float:left; width:100%;">
                                      <tr>
                                          <td style="width:20%;float:left; text-align:left">
                                              <a id="btnSpecification" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Specification</a>
                                          </td>
                                          <td style="width:60%;float:right; text-align:right">
                                            
                                          </td>
                                          <td style="width:20%; text-align:right">
                                              <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                          </td>
                                      </tr>
                                  </table>
                              </fieldset>
                          </div>
    <div id="winPatternPicker" class="easyui-window" title="Pattern Picker" style=" height:auto;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <fieldset>
            <table style="width:100%; margin-top:1px">
                <tr>
                    <td style=" width:5%; text-align:right">
                        <label>Reed:</label>
                    </td>
                    <td style="width:5%; text-align:left">
                        <input id="txtReed" class="numberfiled" type="text" style="width:100%" />
                    </td>
                    <td style=" width:5%;text-align:right">
                        <label>Dent:</label>
                    </td>
                    <td style="width:5%; text-align:left">
                        <input id="txtDent" type="text" style="width:100%" />
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Pick:</label>
                    </td>
                    <td style="width:5%; text-align:left">
                        <input id="txtPick" class="numberfiled" type="text" style="width:100%" />
                    </td>
                    <td style="width:10%; text-align:left"></td>
                    <td style="width:5%; text-align:right">
                        <label>Weave: </label>
                    </td>
                    <td style="width:10%; text-align:left">
                        <select id="cboWeave" style="width:100%"></select>
                    </td>
                    <td style="width:5%;text-align:right">
                        <label>Warp:</label>
                    </td>
                    <td style="width:10%; text-align:left">
                        <input id="txtWarp" type="text" style="width:100%" />
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Weft:</label>
                    </td>
                    <td style="width:10%; text-align:left">
                        <input id="txtWeft" type="text" style="width:100%" />
                    </td>
                </tr>
                <tr>
                    <td style="width:5%;text-align:right">
                        <label>GSM:</label>
                    </td>
                    <td style="width:5%; text-align:left">
                        <input id="txtGSM" class="numberfiled" type="text" style="width:100%" />
                    </td>
                    <td style="width:5%;text-align:right">
                        <label>S.Ratio: </label>
                    </td>
                    <td style="width:5%; text-align:left">
                        <input id="txtRepeatSize" class="numberfiled" type="text" style="width:100%" />
                    </td>
                    <td style="width:5%; text-align:left"></td>
                    <td style="width:5%; text-align:left"></td>
                    <td style="width:10%; text-align:left"></td>
                    <td style="width:5%;text-align:right">
                        <label>Note:</label>
                    </td>
                    <td colspan="3" style="width:25%; text-align:left">
                        <input id="txtNote" type="text" style="width:100%" />
                    </td>

                    <td style="width:5%; text-align:right"></td>
                    <td style="width:10%; text-align:left"></td>
                </tr>

            </table>
        </fieldset>
        <fieldset>
            <table style="width:100% ;  margin-top:1px">
                <tr>
                    <td id="tdCopyWeft" style="width:6%; text-align:right">
                        <a id="btnCopyFabricPlans" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-copy" plain="true"></a>
                    </td>
                  
                    <td style="width:6%; text-align:right">
                        <label>LD No:</label>
                    </td>
                    <td style="width:18%; text-align:left">
                        <input type="text" id="txtLDNo" style="width:75%" placeholder="Enter LD No">
                        <a id="btnPickLDNo" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true"></a>
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Yarn:</label>
                    </td>
                    <td style="width:20%; text-align:left">
                        <input id="txtProduct" style="width:60%;" class="reset-text" placeholder="Search Product" />
                        <a id="btnPickProduct" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                        <a id="btnUpdateYarn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true"></a>
                    </td>
                    <td style="width:5%; text-align:right">
                        <label>Color :</label>
                    </td>
                    <td style="width:15%; text-align:left">
                        <input id="txtColorName" style="float:left; width:100%;" class="reset-text" placeholder="Color Name" />
                    </td>

                    <td style="width:5%; text-align:right">
                        <label>Color: </label>
                    </td>
                    <td style="width:25%; text-align:left">
                        <input id="txtRGB" style="float:left; width:15%;" onkeydown="ColorChange(1)" type="text">
                        <input id="txtRGBPriview" type="color" onchange="ColorChange(2)">
                        <button id="btnPickColor" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true">Pick</button>
                    </td>

                </tr>
            </table>
        </fieldset>
        <div style="padding-left:2px; padding-right:2px;">
            <table id="tblFabricPlan" title="Fabric Pattern" class="easyui-datagrid" style="width:100%;height:320px;" fitcolumns="true" singleselect="true" rownumbers="true" pagination="false" autorowheight="false"
                   data-options="toolbar: '#toolbar',onClickRow:onClickRow,onLoadSuccess: onLoadSuccess"></table>

            <div id="toolbar">
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                <a id="btnEditDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true"><label id="lblEditUpdate">Edit</label></a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                <a id="btnMakeTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Create Group</a>
                <a id="btnRemoveTwisted" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Remove Group</a>
                <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                <input type="text" id="txtLDNo_Warp" style="width:10%" placeholder="Enter LD No and Press Enter">
                <a id="btnAddLD_Warp" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-pick" plain="true">Pick</a>
                <a id="btnAddColumn" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add Column</a>
                <a id="btnRepeatSection" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-redo" plain="true">Repeat Entry</a>

                <a href="javascript:void(0)" id="btnUp" class="easyui-linkbutton" iconcls="icon-up" plain="true" onclick="UP()">Up</a>
                <a href="javascript:void(0)" id="btnDown" class="easyui-linkbutton" iconcls="icon-down" plain="true" onclick="Down()">Down</a>
                <a href="javascript:void(0)" id="btnSaveSequence" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Save</a>

            </div>
        </div>
        <fieldset>
            <legend>Action</legend>
            <table border="0" cellpadding="0" cellspacing="0" style="float:right; width:100%;">
                <tr>
                    <td style=" float:left;  width:50%; float:left;">
                        <a id="btnPrint" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print</a>
                        <a id="btnPrintV1" href="javascript:void(0)" class="easyui-linkbutton initial-state" iconcls="icon-print" plain="true">Print(v1)</a>
                        @*<a id="btnDeleteAll" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete All</a>*@

                    </td>
                    <td style="width:50%;float:right; text-align:right">
                        <a id="btnSaveFPO" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Save</a>
                        <a id="btnClosePattern" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>
    <div id="winFabricPlanRepeat" class="easyui-window winstyle" style=" height:auto;width:60%" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div title="Fabric Plan Repeat" style="height:300px">
            <div style="width:100%">
                <div style="width:20%;float:left;height:290px;">
                    <div style="width:100%;height:290px">
                        <table id="tblEndColmns" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#dfsdfsd" style="height:290px;width:100%">
                            <thead>
                                <tr>
                                    <th data-options="field:'Selected',checkbox:true"></th>
                                    <th field="title" width="40%">Columns</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>
                <div style="width:78%;float:right;height:290px;">
                    <div style="width:100%;height:290px">
                        <table id="tblFabricPlanRepeat" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" toolbar="#toolbar4" style="height:290px;width:100%">
                            <thead>
                                <tr>
                                    <th field="SLNo" align="center" width="5%">SL</th>
                                    <th field="WarpWeftTypeST" align="center" width="15%">Warp Weft Type</th>
                                    <th field="StartColST" align="center" width="10%">Start Col</th>
                                    <th field="EndColST" align="center" width="10%">End Col</th>
                                    <th field="RepeatNo" align="center" width="15%">Repeat No</th>
                                </tr>
                            </thead>
                        </table>
                        <div id="toolbar4">
                            <select id="cboWarpWeftType" style="width:100px;"></select>
                            <input type="text" id="txtRepeatNo" style="width:100px;" placeholder="Repeat No" />
                            <a id="btnAddFabricPlanRepeat" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
                            <a id="btnRemoveFabricPlanRepeat" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div style="display:block;overflow:hidden;">
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:60%; text-align:left;"></td>
                        <td style="width:40%; float:right">
                            <a id="btnFabricPlanRepeatClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
    </div>
    <script type="text/javascript">

    var _sBaseAddress ="";
    var _nEndsCount=0;
    var _oFabricSCReport=[];
    var _oStartEndCols = [];
    var _oFabricPlans = [];
    var _bIsNew=false;

    $(document).ready(function () {
        var oFabricPlanOrders =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        
        var oFabricPlanRefTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricPlanRefTypes));
        var nRefID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RefID));
        var nRefType = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.RefType));
        var oWarpWeftTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WarpWeftTypes));
        _oFabricSCReport=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricSCReport));
        _oFabricPlans = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.FabricPlans));
        var oFabricWeaves=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricWeaves));
        $("#cboWeave").icsLoadCombo({
            List: oFabricWeaves,
            OptionValue: "FabricProcessID",
            DisplayText: "Name"
        });

        debugger;

        var sBankHeader ="FabricID:"+_oFabricSCReport.FabricNo+", Const:"+_oFabricSCReport.Construction+" , Buyer Name: "+_oFabricSCReport.BuyerName+" , FEO No: "+_oFabricSCReport.FEONo;
        $('#divFabricPlanOrder').panel({ title:sBankHeader});
        $("#winPatternPicker").data('CellRowSpans',null);
        $("#winPatternPicker").data('FabricPlanOrder',null);
            $("#winPatternPicker").data('WarpWeftTypes',oWarpWeftTypes);
            $("#winPatternPicker").data('RefID',nRefID);
            $("#winPatternPicker").data('RefType',nRefType);
            $("#cboFabricPlanRefType").icsLoadCombo({List: oFabricPlanRefTypes,OptionValue: "id",DisplayText: "Value",});
            $("#cboWarp").icsLoadCombo({List: oWarpWeftTypes,OptionValue: "id",DisplayText: "Value"});
            $('#tblFabricPlanOrders').data('BaseAddress', _sBaseAddress);
            //var oTempFabricPlanOrders =sessionStorage.getItem("FabricPlanOrders");
            //if(oTempFabricPlanOrders!=null)
            //{
            //    oFabricPlanOrders = jQuery.parseJSON(oTempFabricPlanOrders);
            //}
            RefreshList(oFabricPlanOrders);
            $("#btnSpecification").hide();
            var nRefType=sessionStorage.getItem("RefType");
            if(parseInt(nRefType)==2)
            {
                $("#btnSpecification").show();
            }
        });
        $('#btnSpecification').click(function (e)
        {
            if (sessionStorage.getItem("BackLink") != ""){
                window.location.href = sessionStorage.getItem("BackLink");
            }
            var nRefType=sessionStorage.getItem("RefType");

            if(parseInt(nRefType)!=2)    {alert("This Patern only for Specification "); return}

            var tsv=((new Date()).getTime())/1000;
            window.location.href = _sBaseAddress+ "/FabricExecutionOrderSpecification/ViewSpecification?nFSCDID="+sessionStorage.getItem("RefID")+"&nFEOSID="+sessionStorage.getItem("FEOSID")+"&nts="+tsv;
        });
        $('#cboFabricPlanRefType').change(function(e){
            $("#btnSpecification").hide();
            if(parseInt($("#cboFabricPlanRefType").val())==2)
            {
                $("#btnSpecification").show();
            }
        });

        $("#txtSearchByRefno").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sRefNo=$.trim($("#txtSearchByRefno").val());
                if(sRefNo==null ||sRefNo==""){   $('#txtSearchByRefno').focus(); alert("Type no to search."); return false; }
                GetsByRefNo(sRefNo);
            }
        });

        function GetsByRefNo(sRefNo){
         //   if(parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID)>0){   alert("Already pattern confirm. If you can change first delete this pattern."); return false; }
            var oFabricPlanOrder = {
                RefNo : $.trim($('#txtSearchByRefno').val()),
                FabricPlanOrderID:0,
                RefType:parseInt( $("#cboFabricPlanRefType").val()),
                ErrorMessage :""
            }
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFabricPlanOrder,
                ControllerName: "FabricPlan",
                ActionName: "GetsRefNo",
                IsWinClose: false
            };

            var tblColums = [];
            var oColumn = { field: "RefTypeSt", title: "Type", width: 80, align: "left" };tblColums.push(oColumn);
            oColumn = { field: "RefNo", title: "FabricID", width: 270, align: "left" };tblColums.push(oColumn);

            var oPickerParam = {
                winid: 'winRefNo',
                winclass:'clsRefNoPicker',
                winwidth: 520,
                winheight: 460,
                tableid: 'tblRefNoPicker',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName:'RefNo',
                windowTittle: 'Product List',
                paramObj:obj,
                pkID:'RefID',
                callBack:SetRefNo
            };

            $.icsDynamicPicker(oPickerParam);
        }
        function SetRefNo(oFabricPlanOrder)
        {
            if(oFabricPlanOrder !=null  && oFabricPlanOrder.FabricPlanOrderID>0){
                $('#txtSearchByRefno').val(oFabricPlanOrder.RefNo);
                //  GetsPlan(oFabricPlanOrder);
                var oFabricPlanOrders=[];
                debugger;
                //  oFabricPlanOrder.FabricPlanOrderID=0;
                $("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderIDFrom=oFabricPlanOrder.FabricPlanOrderID;
                $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID=0;
              //  var a=  $("#winPatternPicker").data('FabricPlanOrder');
              
            }
        }
        function GetsPlan(oFabricPlanOrder)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+"/FabricPlan/GetsPlan",
                traditional: true,
                data:  JSON.stringify(oFabricPlanOrder),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    $("#winPatternPicker").data('FabricPlanOrder',data);

                    MakeGrid();
                    if($("#winPatternPicker").data('FabricPlanOrder').FabricPlans.length>0)
                    {
                        var oCellRowSpans=$("#winPatternPicker").data('FabricPlanOrder').FabricPlans[0].CellRowSpans;
                        $("#winPatternPicker").data('CellRowSpans',oCellRowSpans);
                    }
                    Refresh($("#winPatternPicker").data('FabricPlanOrder').FabricPlans);debugger;
                    //$("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID=0;
                    //$("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderIDTo=data.FabricPlanOrderID;
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }

        $("#btnCopyFabricAll").click(function(){
            debugger;
            var ntype = parseInt($('#cboWarp').val());
            var oFPs=[];
            if (!confirm("Confirm to Copy?")) return ;
            var oFabricPlanOrders=[];
            var oFabricPlanOrder=  $("#winPatternPicker").data('FabricPlanOrder');
            if(oFabricPlanOrder!==null)
            {
                if(parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderIDFrom)==0)
                {
                    alert("Pattern not found!");
                    return;
                }
            }
            var obj = {
                FabricPlanOrderIDFrom: oFabricPlanOrder==null?0:oFabricPlanOrder.FabricPlanOrderIDFrom,
                FabricPlanOrderID: 0,
                FabricID:_oFabricSCReport.FabricID,
                RefID: sessionStorage.getItem("RefID"),
                RefType:sessionStorage.getItem("RefType"),
                WarpWeftType: 0
            }
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/FabricPlan/CopyFabricPlans",
                traditional: true,
                data: JSON.stringify(obj),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oFabricPlanOrder = data;
                    if (oFabricPlanOrder.ErrorMessage ==''|| oFabricPlanOrder.ErrorMessage == null)
                    {
                        alert("Data Save Successfully");
                        oFabricPlanOrders.push(oFabricPlanOrder);
                        RefreshList(oFabricPlanOrders);
                        //$("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                        //$("#winPatternPicker").data('FabricPlans',$("#winPatternPicker").data('FabricPlanOrder').FabricPlans);
                        //if($("#winPatternPicker").data('FabricPlanOrder').FabricPlans.length>0)
                        //{
                        //    var oFabricPlans=$("#winPatternPicker").data('FabricPlanOrder').FabricPlans;
                        //    $("#winPatternPicker").data('FabricPlans',oFabricPlans);
                        //    $("#winPatternPicker").data('CellRowSpans', $("#winPatternPicker").data('FabricPlanOrder').FabricPlans[0].CellRowSpans);
                        //}
                        //$('#cboWarp').val(1);
                        //ChangeWarpWeft();
                    }
                    else {
                        alert(oFabricPlanOrder.ErrorMessage);
                    }

                },error: function (xhr, status, error) {
                    alert(error);
                }
            });


        });

        $('#btnDelete').click(function(){
            debugger;
            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            if(oFabricPlanOrder==null || oFabricPlanOrder.FabricPlanOrderID<=0)
            {
                alert("Please select an item from list!");
                return;
            }
            //if(parseInt(oFabricPlanOrder.ApprovedBy)!=0)
            //{
            //    alert("Your selected Inventory Transfer already approved!");
            //    return;
            //}
            if (!confirm("Confirm to Delete?")) return ;

            var SelectedRowIndex=$('#tblFabricPlanOrders').datagrid('getRowIndex',oFabricPlanOrder);

            if (oFabricPlanOrder.FabricPlanOrderID > 0)
            {
                debugger;
                $.ajax
                ({
                    type: "POST",
                    dataType: "json",
                    url :_sBaseAddress+  "/FabricPlan/DeleteAll",
                    data: JSON.stringify(oFabricPlanOrder),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;
                        feedbackmessage = jQuery.parseJSON(data);
                        if (feedbackmessage == "Deleted")
                        {
                            
                            $("#winPatternPicker").data('FabricPlanOrder',null);
                            alert("Delete sucessfully");
                            $('#tblFabricPlanOrders').datagrid('deleteRow',SelectedRowIndex);
                            var oFabricPlanOrders= $('#tblFabricPlanOrders').datagrid('getRows');
                            sessionStorage.setItem("FabricPlanOrders", JSON.stringify(oFabricPlanOrders));
                        }
                        else
                        {
                            alert(feedbackmessage);
                        }
                    },
                    error: function (xhr, status, error)
                    {
                        alert(error);
                    }

                });
            }
        });

        function RefreshList(oFabricPlanOrders)
        {
            data={"total":""+oFabricPlanOrders.length+"","rows":oFabricPlanOrders};
            $('#tblFabricPlanOrders').datagrid('loadData',data);
            var nSelectedRowIndex =parseInt(sessionStorage.getItem("SelectedRowIndex"));
            if(nSelectedRowIndex!=-1)
            {
                $('#tblFabricPlanOrders').datagrid('selectRow', nSelectedRowIndex);
            }
        }

        $("#btnCopyFabricPlans").click(function(){
            debugger;
            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            var ntype = parseInt($('#cboWarp').val());
            var oFPs=[];
         
                var obj = {
                    FabricPlanOrderID: oFabricPlanOrder.FabricPlanOrderID,
                    FabricPlanOrderIDFrom: oFabricPlanOrder.FabricPlanOrderID,
                    RefID: $("#tblFabricPlanOrders").data('RefID'),
                    RefType:$("#tblFabricPlanOrders").data('RefType'),
                    WarpWeftType: 2
                }
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+"/FabricPlan/CopyFabricWefts",
                    traditional: true,
                    data: JSON.stringify(obj),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        var oFabricPlanOrder = data;
                        debugger;
                        if (oFabricPlanOrder.ErrorMessage == '' || oFabricPlanOrder.ErrorMessage == null)
                        {
                            debugger;
                            oFabricPlanOrder=oFabricPlanOrder;
                            $("#winPatternPicker").data('FabricPlans',oFabricPlanOrder.FabricPlans);
                            $("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                            //ChangeWarpWeft();
                            RefreshControl(oFabricPlanOrder);

                            MakeGrid();
                            if(oFabricPlanOrder.FabricPlans.length>0)
                            {
                                $("#winPatternPicker").data('CellRowSpans',oFabricPlanOrder.FabricPlans[0].CellRowSpans);
                            }
                            Refresh(oFabricPlanOrder.FabricPlans);

                            alert("Data Save Successfully");
                        }
                        else {
                            alert(oFabricPlanOrder.ErrorMessage);
                        }

                    },error: function (xhr, status, error) {
                        alert(error);
                    }
                });
           // }

        });

        $('#btnClose').click(function(){
            window.close();
        });

        //Picker
        $('#btnWarp').click(function () {
            debugger;
          
            var oFabricPlanOrders= $('#tblFabricPlanOrders').datagrid('getRows');

            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            var nFabricPlanOrderID = oFabricPlanOrder==null?0:oFabricPlanOrder.FabricPlanOrderID;
           
            if(oFabricPlanOrders.length>0 && (nFabricPlanOrderID<=0 || oFabricPlanOrder==null))
            {
                alert("Please Select a item from list!");
                return;
            }

            if(nFabricPlanOrderID<=0)
            {
                _bIsNew=true;
                oFabricPlanOrder=$("#winPatternPicker").data('FabricPlanOrder');
                if(oFabricPlanOrder!=null)
                {
                    nFabricPlanOrderID=parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID);
                }
            }
            sessionStorage.setItem("FabricPlanOrderHeader", "Add Warp");
            $("#winPatternPicker").data('PlanTypeName',"Warp");
            $("#winPatternPicker").data('SelectedWarpWeftType',1);//Warp
            LoadFabricPlan(nFabricPlanOrderID,1);
            $("#winPatternPicker").icsWindow('open',"Add Faric Plan For Warp");
        });

        $('#btnWeft').click(function(){

            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            var nFabricPlanOrderID = oFabricPlanOrder==null?0:oFabricPlanOrder.FabricPlanOrderID;
            if(nFabricPlanOrderID<=0)
            {
                nFabricPlanOrderID=parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID);
            }
            if(parseInt(nFabricPlanOrderID)<=0)
            {
                alert("First Save Warp Pattern!");
                return;
            }
            _bIsNew=false;

            sessionStorage.setItem("FabricPlanOrderHeader", "Add Weft");
            $("#winPatternPicker").data('PlanTypeName',"Weft");
            $("#winPatternPicker").data('SelectedWarpWeftType',2);//Warp
            LoadFabricPlan(nFabricPlanOrderID,2);
            $("#winPatternPicker").icsWindow('open',"Add Faric Plan For Weft");
        });
        function LoadFabricPlan(nFabricPlanOrderID,nWarpWeftType)
        {
            var oFabricPlanOrder= {
                FabricPlanOrderID:nFabricPlanOrderID,
                WarpWeftType:nWarpWeftType,
                RefID: sessionStorage.getItem("RefID"),
                RefType:sessionStorage.getItem("RefType"),
                FabricID:$("#winPatternPicker").data('RefID')
            };
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/FabricPlan/LoadFabricPlanInfo",
                traditional: true,
                data:  JSON.stringify(oFabricPlanOrder),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    oFabricPlanOrder = data;
                    if (oFabricPlanOrder.ErrorMessage=="" || oFabricPlanOrder.ErrorMessage==null)
                    {
                        $("#winPatternPicker").data('FabricPlans',oFabricPlanOrder.FabricPlans);
                        $("#winPatternPicker").data('CellRowSpans',null);
                        $("#winPatternPicker").data('FabricPlan',null);
                        $("#winPatternPicker").data('FabricID',0);
                        $("#winPatternPicker").data('ProductID',0);
                        $("#winPatternPicker").data('LabdipDetailID',0);
                        $("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                        $("#winPatternPicker").data('FabricWeaves',oFabricPlanOrder.FabricWeaves);
                        $("#winPatternPicker").data('FabricExecutionOrder',_oFabricSCReport);
                        var sBankHeader ="FabricID:"+_oFabricSCReport.FabricNo+", Const:"+_oFabricSCReport.Construction+" , Buyer Name: "+_oFabricSCReport.BuyerName+", Pattern Type : "+ $("#winPatternPicker").data('PlanTypeName')+" , FEO No: "+_oFabricSCReport.FEONo;
                        //$("#cboWeave").icsLoadCombo({List: oFabricPlan.FabricWeaves,OptionValue: "FabricProcessID",DisplayText: "Name"});
                        $('#winPatternPicker').panel({ title:sBankHeader});
                       
                        $('#txtRepeatNo').icsCurrencyBox(null, 0);
                        $('#txtReed').icsCurrencyBox(null, 0);
                        $('#txtPick').icsCurrencyBox(null, 0);
                        $('#txtDent').icsCurrencyBox(null, 2);
                        $('#txtGSM').icsCurrencyBox(null, 2);
                        $("#cboWarpWeftType").icsLoadCombo({List:$("#winPatternPicker").data('WarpWeftTypes'),OptionValue: "id",DisplayText: "Value",});
                        debugger;
                        if($("#winPatternPicker").data('FabricPlanOrder').ColumnCount<=0)
                        {
                            $("#winPatternPicker").data('FabricPlanOrder').ColumnCount=10;
                        }
                        if(parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID)<=0)
                        {
                            $('#tdFullcopy').show();
                            $("#cboWeave").val(_oFabricSCReport.FabricWeave);
                        }
                        else{
                            $('#tdFullcopy').hide();
                        }
                      
                    
                        debugger;
                        $('#tdCopyWeft').hide();
                    
                       
                        if( $("#winPatternPicker").data('FabricPlans').length>0)
                        {
                          
                            $("#winPatternPicker").data('CellRowSpans',$("#winPatternPicker").data('FabricPlans')[0].CellRowSpans);
                        }
                        else{

                            if(nWarpWeftType==2)
                            {
                                $('#tdCopyWeft').show();
                          
                            }
                        }
                        MakeGrid();
                        $('#txtRGB').val("255,255,255");
                        $('#txtProduct').focus();
                        Refresh($("#winPatternPicker").data('FabricPlans'));
                        ChangeWarpWeft();
                        RefreshControl($("#winPatternPicker").data('FabricPlanOrder'));
                      
                    }
                    else
                    {
                        alert(oFabricPlan.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }

            });

        }

        function MakeGrid()
        {
            debugger;
            var tblColums=[];
            var otblfrozenColumns=[];
            var oColumn=null;
            oColumn=  {field : 'FabricPlanID',title:'',width:10,checkbox:true,frozen:true}; otblfrozenColumns.push(oColumn);
            oColumn= { field :"WarpWeftTypeSt", title:"Type", width:"5%",frozen:true}; otblfrozenColumns.push(oColumn);
            oColumn= { field :"ProductName", title:"Yarn", width:"10%",frozen:true}; otblfrozenColumns.push(oColumn);
            oColumn= { field :"Color", title:"Color Name", width:"10%",frozen:true}; otblfrozenColumns.push(oColumn);
            for(var i = 1; i <=$("#winPatternPicker").data('FabricPlanOrder').ColumnCount; i++)
            {
                oColumn= { field :"EndsCount"+i, title:"Col" + i, width:"4%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }};
                tblColums.push(oColumn);
            }
            oColumn= { field :"EndsCount", title:"Total", width:"5%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"Value", title:"Value", width:"5%", align: "right",editor: {type:'numberbox',options:{ precision:0}},  formatter: function(value,row,index){ return formatPrice(value, 0); }}; tblColums.push(oColumn);
            oColumn= { field :"ColorNo", title:"Labdip No", width:"10%"}; tblColums.push(oColumn);
            oColumn= { field :"PantonNo", title:"Panton No", width:"10%"}; tblColums.push(oColumn);
            oColumn= { field :"SLNo", title:"SL No", width:"10%"}; tblColums.push(oColumn);
            oColumn= { field :"TwistedGroup", title:"Twisted", width:"10%"}; tblColums.push(oColumn);
            oColumn= { field :"RGB", title:"Color", width:"10%"}; tblColums.push(oColumn);
            oColumn= { field:'ColorInHEX', title:'ColorView', width:'15%',
                formatter:function(val, row, idx)
                {
                    return '<div style="background-color:'+val+';">('+val+')</div>';
                } }; tblColums.push(oColumn);
            // $('#tblFabricPlan').datagrid({ columns:[tblColums]});
            $('#tblFabricPlan').datagrid({
                frozenColumns:[otblfrozenColumns],
                columns:[tblColums]
            });
        }

        function Refresh(oData)
        {
            debugger;
            var oFabricPlanOrder = $("#winPatternPicker").data('FabricPlanOrder');
            for(var i=0;i<oData.length;i++)
            {
                oData[i].ColorInHEX="#"+CP.RGB2HEX(oData[i].RGB.split(','));
            }
            var oFPDs=[];
            for(var i=0;i<oData.length;i++)
            {
                var oFabricPlanDetails=oData[i].FabricPlanDetails;
                oFPDs=[];

                for(j=0; j <=oFabricPlanOrder.ColumnCount; j++)
                {
                    var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo:j, EndsCount:0, SLNo:j};
                    oFPDs.push(oFPD);
                }

                for(k=0; k < oFabricPlanDetails.length; k++)
                {
                    var oFPD={FabricPlanID:oData[i].FabricPlanID, ColNo: oFabricPlanDetails[k].ColNo, EndsCount:oFabricPlanDetails[k].EndsCount, SLNo:k};
                    oFPDs.splice( oFabricPlanDetails[k].ColNo, 1, oFPD);
                }

                for(p=0; p < oFPDs.length; p++)
                {
                    oData[i]["EndsCount"+p] = oFPDs[p].EndsCount;
                    oData[i]["ColNo"+p] = oFPDs[p].ColNo;
                }
            }
            DynamicRefreshList(oData, 'tblFabricPlan');
        }

        function ChangeWarpWeft()
        {
            debugger;
            var oFabricPlans = $("#winPatternPicker").data('FabricPlans');
            if(parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) > 0)
            {
                var ntype = parseInt($("#winPatternPicker").data('SelectedWarpWeftType'));
                var oFPs=[];
                if(ntype == 3){
                    DynamicRefreshList(oFabricPlans, 'tblFabricPlan');
                }
                else{
                    if(oFabricPlans.length>0){
                        for(var i = 0;i<oFabricPlans.length;i++){
                            if(oFabricPlans[i].WarpWeftType == ntype)
                                oFPs.push(oFabricPlans[i]);
                        }
                        Refresh(oFPs);
                    }
                    else{
                        DynamicRefreshList([], 'tblFabricPlan');
                    }
                }
            }
        }

        function RefreshControl(oFabricPlanOrder)
        {
            debugger;
            $("#txtReed").val(parseInt(oFabricPlanOrder.Reed));
            $("#txtDent").val(TempAddComma(parseFloat(oFabricPlanOrder.Dent)));
            $("#txtPick").val(parseInt(oFabricPlanOrder.Pick));
            $("#txtGSM").val(TempAddComma(parseFloat(oFabricPlanOrder.GSM)));
            $("#txtWarp").val(oFabricPlanOrder.Warp);
            $("#txtWeft").val(oFabricPlanOrder.Weft);
            $("#cboWeave").val(parseInt(oFabricPlanOrder.Weave));
            $("#txtRepeatSize").val(oFabricPlanOrder.RepeatSize);
            $("#txtNote").val(oFabricPlanOrder.Note);
        }





        //$('#btnSaveFPDetail').click(function (e) {

        //    endEditing();
        //    debugger;
        //    var oFabricPlanDetails=[];
        //    var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');

        //    if (oFabricPlans.length==0) {
        //        alert("No Yarn/Color found!");
        //        return false;
        //    }
        //    var oFabricPlanOrder =  $("#winPatternPicker").data('FabricPlanOrder');

        //    for(var i=0;i<oFabricPlans.length;i++)
        //    {
        //        var oFabricPlan=  oFabricPlans[i]
        //        for(var j=1;j<=oFabricPlanOrder.ColumnCount;j++)
        //        {
        //            var nEndsCount=  oFabricPlan["EndsCount"+j];

        //            if(nEndsCount>0)
        //            {
        //                var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:nEndsCount, SLNo:0};
        //                oFabricPlanDetails.push(oFPD);
        //            }
        //        }
        //    }

        //    debugger;
        //    if (oFabricPlanDetails.length==0) {
        //        alert("No EPI/PPI found!");
        //        return false;
        //    }
        //    if (!confirm("Confirm to Save ?")) return false;
        //    $.ajax({
        //        type: "POST",
        //        dataType: "json",
        //        url: _sBaseAddress + "/FabricPlan/SaveAll",
        //        traditional: true,
        //        data: JSON.stringify(oFabricPlanDetails),
        //        contentType: "application/json; charset=utf-8",
        //        success: function (data) {
        //            oFabricPlanDetails = jQuery.parseJSON(data);

        //            if (oFabricPlanDetails[0].ErrorMessage == '' || oFabricPlanDetails[0].ErrorMessage == null) {
        //                alert("Data Save Successfully");
        //            }
        //            else {
        //                alert(oFabricPlanDetails[0].ErrorMessage);
        //            }
        //        },
        //        error: function (xhr, status, error) {
        //            alert(xhr + '~' + status + '~' + error);
        //        }
        //    });
        //});

        $('#btnSaveFPO').click(function (e) {
            debugger;
            var oFabricPlansTemp=[];
            endEditing();
            var oTempFabricPlanOrder =  $("#winPatternPicker").data('FabricPlanOrder');
            var oFabricPlanOrder=
                {
                    FabricPlanOrderID: oTempFabricPlanOrder.FabricPlanOrderID,
                    RefID: sessionStorage.getItem("RefID"),
                    RefType:sessionStorage.getItem("RefType"),
                    Reed : parseInt(icsRemoveComma($('#txtReed').val())),
                    Pick: parseInt(icsRemoveComma($('#txtPick').val())),
                    Weave :parseInt($('#cboWeave').val()),
                    GSM:parseFloat(icsRemoveComma($('#txtGSM').val())),
                    Dent:parseFloat(icsRemoveComma($('#txtDent').val())),
                    Warp : $('#txtWarp').val(),
                    Weft : $('#txtWeft').val(),
                    Note : $('#txtNote').val(),
                    RepeatSize : $('#txtRepeatSize').val(),
                    WarpWeftType:parseInt($("#winPatternPicker").data('SelectedWarpWeftType')),
                    FabricPlans:[],
                    FabricPlanRepeats:[]
                }

            debugger;
            var oFabricPlanDetails=[];
            var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');

            if (oFabricPlans.length==0) {
                alert("No Yarn/Color found!");
                return false;
            }

      
            debugger;

            for(var i=0;i<oFabricPlans.length;i++)
            {
                oFabricPlanDetails=[];
                var oFabricPlan=
              {
                  FabricPlanID: oFabricPlans[i].FabricPlanID,
                  ProductID: oFabricPlans[i].ProductID,
                  LabdipDetailID: oFabricPlans[i].LabdipDetailID,
                  WarpWeftType: oFabricPlans[i].WarpWeftType,
                  Color: oFabricPlans[i].Color,
                  RGB: oFabricPlans[i].RGB,
                  Value: oFabricPlans[i].Value,
                  EndsCount: oFabricPlans[i].EndsCount,
                  FabricPlanOrderID: oFabricPlans[i].FabricPlanOrderID,
                  RefID: oFabricPlans[i].RefID,
                  RefType: oFabricPlans[i].RefType,
                  SLNo: oFabricPlans[i].SLNo,
                  FabricPlanDetails:[]
              }

              //  var oFabricPlan=  oFabricPlans[i]
                for(var j=1;j<=oTempFabricPlanOrder.ColumnCount;j++)
                {
                    var nEndsCount=  oFabricPlans[i]["EndsCount"+j];

                    if(nEndsCount>0)
                    {
                        var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:nEndsCount, SLNo:0};
                        oFabricPlanDetails.push(oFPD);
                    }
                }
                oFabricPlan.FabricPlanDetails=oFabricPlanDetails;
                oFabricPlans[i].ProductName="";
                oFabricPlans[i].ColorInHEX="";
                oFabricPlansTemp.push(oFabricPlan);
                
                //if(oTempFabricPlanOrder.FabricPlanOrderID<=0) // For Insert new Pattern
                //{
                //    oFabricPlans[i].FabricPlanID=0;
                //}
            }
            oFabricPlanOrder.FabricPlans=oFabricPlansTemp;
            oFabricPlanOrder.FabricPlanRepeats=oTempFabricPlanOrder.FabricPlanRepeats;
            Save(oFabricPlanOrder);
        });

        function Save(oFabricPlanOrder)
        {
            debugger;
            if (!confirm("Confirm to Save ?")) return false;
            $('#btnSaveFPO').hide();
          
           oFabricPlanOrder.ColumnCount=  $("#winPatternPicker").data('FabricPlanOrder').ColumnCount;
           $.ajax({
               type: "POST",
               dataType: "json",
               url: _sBaseAddress + "/FabricPlan/Save",
               traditional: true,
               data: JSON.stringify(oFabricPlanOrder),
               contentType: "application/json; charset=utf-8",
               success: function (data) {
          
             
                    debugger;
                    var oFabricPlanOrder = data;
                    if (oFabricPlanOrder.ErrorMessage == '' || oFabricPlanOrder.ErrorMessage == null) {
                        
                        if(_bIsNew==true)
                        {
                            var oFabricPlanOrders= $('#tblFabricPlanOrders').datagrid('getRows');
                            var nIndex=oFabricPlanOrders.length;
                            $('#tblFabricPlanOrders').datagrid('appendRow', oFabricPlanOrder);
                            $('#tblFabricPlanOrders').datagrid('selectRow', nIndex);
                        }
                        _bIsNew=false;
                        $("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                     
                        MakeGrid();
                        if($("#winPatternPicker").data('FabricPlanOrder').FabricPlans.length>0)
                        {
                            $("#winPatternPicker").data('CellRowSpans',$("#winPatternPicker").data('FabricPlanOrder').FabricPlans[0].CellRowSpans);
                        }
                        Refresh($("#winPatternPicker").data('FabricPlanOrder').FabricPlans);
                        alert("Data Save Successfully");
                    }
                    else {
                        alert(oFabricPlanOrder.ErrorMessage);
                    }
                    $('#btnSaveFPO').show();
                },
                error: function (xhr, status, error) {
                    alert(xhr + '~' + status + '~' + error);
                }
            });
        }

        function CopyDetail()
        {
            endEditing();
            debugger;
            if(parseInt($("#winPatternPicker").data('SelectedWarpWeftType'))<=0)    {alert("Please Selet Warp/Weft Type"); return false}
            var oFabricPlanOrder={FabricPlanOrderID: $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID, RefID: sessionStorage.getItem("RefID"), RefType:sessionStorage.getItem("RefType"),FabricPlans:[],FabricPlanRepeats:[]}
            var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');
            var oFabricPlans_New=[];
            for(var i =0;i<oFabricPlans.length;i++)
            {

                oFabricPlans[i].FabricPlanID=0;
                oFabricPlans[i].WarpWeftType=(oFabricPlans[i].WarpWeftType===1)?2:0;
                oFabricPlans[i].FabricPlanID=0;

                oFabricPlans_New.push(oFabricPlans[i]);
            }


            var oFabricPlanDetails=[];
            var oFabricPlans = oFabricPlans_New;

            if (oFabricPlans.length==0) {
                alert("No Yarn/Color found!");
                return false;
            }

            for(var i=0;i<oFabricPlans.length;i++)
            {
                oFabricPlanDetails=[];
                var oFabricPlan=  oFabricPlans[i]
                for(var j=1;j<=$("#winPatternPicker").data('FabricPlanOrder').ColumnCount;j++)
                {
                    var nEndsCount=  oFabricPlan["EndsCount"+j];

                    if(nEndsCount>0)
                    {
                        var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:nEndsCount, SLNo:0};
                        oFabricPlanDetails.push(oFPD);
                    }
                }
                oFabricPlans[i].FabricPlanDetails=oFabricPlanDetails;

                oFabricPlans[i].FabricPlanID=0;

            }
            oFabricPlanOrder.FabricPlans=oFabricPlans;
            oFabricPlanOrder.FabricPlanRepeats=$("#winPatternPicker").data('FabricPlanOrder').FabricPlanRepeats;
            Save(oFabricPlanOrder);
        }

        /*============COLOR PICKER CODE START============================*/
        var picker = new CP(document.getElementById('btnPickColor')),
            output = document.getElementById('txtRGB');
        picker.on("change", function(color)
        {
            // convert to RGB
            $('#txtRGBPriview').val('#'+color);
            var rgb = CP.HEX2RGB(color);
            output.value = rgb.join(', ');
        });
        function ColorChange(nType)
        {
            debugger;
            if(nType==1 && $('#txtRGB').val().split(',').length==3)
            {
                var color=$('#txtRGB').val();
                var hex = CP.RGB2HEX(color.split(','));
                $('#txtRGBPriview').val('#'+hex);
            }
            else if(nType==2)
            {
                var color=$('#txtRGBPriview').val();
                var rgb = CP.HEX2RGB(color.replace('#',''));
                output.value = rgb.join(', ');
            }
        };
        /*============COLOR PICKER CODE ENDS============================*/

        function GetWarpWeftTypes(nId){
            if(nId==true)
                return "Warp";
            return 'Weft';
        }

        $('#tblFabricPlan').datagrid({selectOnCheck:false, checkOnSelect:false});

        function Initialization(oFabricPlan, sOperation){
            ResetControll();
            if(sOperation=="View")
            {
                $('#toolbar,#btnSave,.ics-pick').hide();
                $('input,select').not('#txtFabricPlanNo').prop('disabled',true);
                $('.td-col-6 input').css('width','92%');
            }
            else{
                $('#toolbar,#btnSave,.ics-pick').show();
                $('input,select').not('#txtFabricPlanNo').prop('disabled',false);
                $('.td-col-6 input').css('width','70%');
            }
        }



        function ResetDetail(bIsProductReset){
            $("#winPatternPicker").data('FabricPlan',null);
            if(bIsProductReset)
            {
                $("#winPatternPicker").data('ProductID',0);
                _nFabricPlanColorID=0;
                $('#txtProduct').val("");

            }
            $("#txtColorName").val("");
            $('#lblEditUpdate').text('Edit');
        }

        function ValidationDetail(){
            if(parseInt($("#winPatternPicker").data('ProductID'))<=0){
                $('#txtProduct').focus();
                $('#txtProduct').addClass("errorFieldBorder");
                alert('No product found.');
                return false;
            }
            else{
                $('#txtProduct').removeClass("errorFieldBorder");
            }

            if($('#txtRGB').val().split(',').length!=3)
            {
                $('#txtRGB').focus();
                $('#txtRGB').addClass("errorFieldBorder");
                alert('Valid RGB Color Is required.');
                return false;
            }
            else{
                $('#txtRGB').removeClass("errorFieldBorder");
            }
            return true;
        }

        function RefreshObjectDetail(bIsUpdate){
            var FabricPlan={
                FabricPlanID: (bIsUpdate? ($("#winPatternPicker").data('FabricPlan').FabricPlanID>0 ? $("#winPatternPicker").data('FabricPlan').FabricPlanID:0) : 0 ),
                FabricPlanOrderID :$("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID,
                ProductID:$("#winPatternPicker").data('ProductID'),
                Color: $.trim($("#txtColorName").val()),
                RGB:$('#txtRGB').val(),
                ColorInHEX:"#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
                WarpWeftType:$("#winPatternPicker").data('SelectedWarpWeftType'),
                WarpWeftTypeSt:GetWarpWeftTypes($("#winPatternPicker").data('SelectedWarpWeftType')),
                RefID: sessionStorage.getItem("RefID"),
                RefType:sessionStorage.getItem("RefType"),
                LabdipDetailID:$("#winPatternPicker").data('LabdipDetailID')
            }
            return FabricPlan;
        }

        function SaveFabricPlanDetail(bIsUpdate){
            debugger;
            if (!ValidationDetail()) return false;
            var FabricPlan =null;
            if(bIsUpdate==true)
            {
                if(parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID)<=0){
                    alert('No product found.');
                    return false;
                }
                if(parseInt($("#winPatternPicker").data('FabricPlan').FabricPlanID)<=0){
                    alert('No product found.');
                    return false;
                }
                FabricPlan=$("#winPatternPicker").data('FabricPlan');
                FabricPlan.FabricPlanID=$("#winPatternPicker").data('FabricPlan').FabricPlanID;
                FabricPlan.ProductID=$("#winPatternPicker").data('ProductID'),
                FabricPlan.FabricPlanOrderID =$("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID,
                FabricPlan.RefID  =$("#winPatternPicker").data('FabricPlanOrder').RefID,
                FabricPlan.RefType =$("#winPatternPicker").data('FabricPlanOrder').RefType,
                FabricPlan.Color= $.trim($("#txtColorName").val()),
                FabricPlan.RGB=$('#txtRGB').val(),
                FabricPlan.ColorInHEX="#"+CP.RGB2HEX($('#txtRGB').val().split(',')),
                FabricPlan.WarpWeftType=$("#winPatternPicker").data('SelectedWarpWeftType'),
                FabricPlan.WarpWeftTypeSt=GetWarpWeftTypes($("#winPatternPicker").data('SelectedWarpWeftType'))
            }
            else
            {
                FabricPlan = RefreshObjectDetail(bIsUpdate);
            }
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: FabricPlan,
                ObjectId: FabricPlan.FabricPlanID,
                ControllerName: "FabricPlan",
                ActionName: "SavePlanning",
                TableId: "",
                IsWinClose: false,
                Message: ""// (FabricPlan.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
            };

            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null)
                {
                    debugger;
                    if (response.obj.FabricPlanID > 0 && response.obj.ErrorMessage=='')
                    {
                        $('#tdFullcopy').hide();
                        var oFabricPlan=response.obj;
                        $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID=response.obj.FabricPlanOrderID;
                        //if($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID<=0)
                        //{
                        //    $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID=response.obj.FabricPlanOrderID
                        //}
                        oFabricPlan.ColorInHEX="#"+CP.RGB2HEX(oFabricPlan.RGB.split(','));
                        var oFabricPlans =  $("#winPatternPicker").data('FabricPlans');
                        if(bIsUpdate)
                        {
                            $('#tblFabricPlan').datagrid('updateRow',{row:oFabricPlan, index: parseInt(sessionStorage.getItem("SelectedRowIndex_Detail"))});
                            oFabricPlans[parseInt(sessionStorage.getItem("SelectedRowIndex_Detail"))] = oFabricPlan;
                        }else{
                            oFabricPlans.push(oFabricPlan);

                            if(_bIsNew==true)
                            {
                                var oFabricPlanOrder={FabricPlanOrderID:oFabricPlan.FabricPlanOrderID,RefNo:_oFabricSCReport.FabricNo,   RefID: sessionStorage.getItem("RefID"),  RefType:sessionStorage.getItem("RefType")};
                                var oFabricPlanOrders= $('#tblFabricPlanOrders').datagrid('getRows');
                                var nIndex=oFabricPlanOrders.length;
                                $('#tblFabricPlanOrders').datagrid('appendRow', oFabricPlanOrder);
                                $('#tblFabricPlanOrders').datagrid('selectRow', nIndex);
                            }
                            _bIsNew=false;
                        }
                        $("#winPatternPicker").data('FabricPlans',oFabricPlans);
                        ResetDetail(false);
                        ChangeWarpWeft();
                        if(bIsUpdate){
                            $("#tblFabricPlan").datagrid("selectRow", sessionStorage.getItem("SelectedRowIndex_Detail"));
                        }
                        endEditing();
                    }
                    else alert(response.obj.ErrorMessage);
                }
            });
        }

        $("#btnAddDetail").click(function () {

            SaveFabricPlanDetail(false);
        });

        $('#btnEditDetail').click(function(e){
            debugger;
            if($('#lblEditUpdate').text()=='Edit')
            {
                var FabricPlan = $("#tblFabricPlan").datagrid("getSelected");
                if (FabricPlan == null || FabricPlan.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }
                ResetDetail(true);
                sessionStorage.setItem("SelectedRowIndex_Detail",$('#tblFabricPlan').datagrid('getRowIndex', FabricPlan));
                $("#winPatternPicker").data('ProductID',FabricPlan.ProductID);
                $("#winPatternPicker").data('FabricPlan',FabricPlan);
                $('#txtProduct').val(FabricPlan.ProductName);
                $('#txtColorName').val(FabricPlan.Color);
                $('#txtRGB').val(FabricPlan.RGB);ColorChange(1);
                $('#cboWarp').val(FabricPlan.WarpWeftType);
                $('#lblEditUpdate').text('Update');
            }
            else
            {
                SaveFabricPlanDetail(true);
            }

        });

        $("#btnRemoveDetail").click(function () {

            var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');
            if(oFabricPlans.length<=0){
                alert("No items found to be twisted."); return false;
            }
            if (!confirm("Confirm to Delete?")) return false;
            var nSelectedIndex = 0;

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricPlan/DeletePlanning",
                traditional: true,
                data: JSON.stringify(oFabricPlans),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricPlanOrder = data;
                    if (oFabricPlanOrder.ErrorMessage == '' || oFabricPlanOrder.ErrorMessage == null) {
                        alert("Data Save Successfully");
                        $("#winPatternPicker").data('FabricPlanOrder',oFabricPlanOrder);
                        var oFabricPlans=$("#winPatternPicker").data('FabricPlanOrder').FabricPlans;

                        //MakeGrid();
                        debugger;
                        var oFabricPlans=$("#winPatternPicker").data('FabricPlanOrder').FabricPlans;
                        $("#winPatternPicker").data('FabricPlans',oFabricPlans);
                        if($("#winPatternPicker").data('FabricPlanOrder').FabricPlans.length>0)
                        {

                            $("#winPatternPicker").data('CellRowSpans',$("#winPatternPicker").data('FabricPlanOrder').FabricPlans[0].CellRowSpans);
                        }
                        else{
                            $("#winPatternPicker").data('CellRowSpans',[]);
                        }
                        ChangeWarpWeft();
                    }
                    else {
                        alert(oFabricPlanOrder.ErrorMessage);
                    }
                    editIndex = undefined;
                },
                error: function (xhr, status, error) {
                    alert(xhr + '~' + status + '~' + error);
                }
            });


        });
        $("#btnUpdateYarn").click(function () {

            var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');

            if(oFabricPlans.length<=0){
                alert("No items found to be twisted."); return false;
            }
            //var FabricPlan = $("#tblFabricPlan").datagrid("getSelected");
            //if (FabricPlan == null || FabricPlan.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }

            if (!confirm("Confirm to change yarn?")) return false;
            //var nIndex = $("#tblFabricPlan").datagrid("getRowIndex", FabricPlan);


            var nSelectedIndex = 0;
            //var indexLists = [];
            for (i = 0; i < oFabricPlans.length; ++i) {

                oFabricPlans[i].ProductID=$("#winPatternPicker").data('ProductID');
                oFabricPlans[i].ProductName=$('#txtProduct').val();
            }

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricPlan/UpdateYarn",
                traditional: true,
                data: JSON.stringify(oFabricPlans),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var sMessage = jQuery.parseJSON(data);
                    debugger

                    if (sMessage == 'Saved')
                    {
                        for (i = 0; i < oFabricPlans.length; ++i) {

                            nSelectedIndex = $('#tblFabricPlan').datagrid('getRowIndex', oFabricPlans[i]);
                            $('#tblFabricPlan').datagrid('updateRow', { index: nSelectedIndex, row: oFabricPlans[i] });


                        }
                        alert("Data Save Successfully");
                    }
                    else {
                        alert(sMessage);
                    }
                    editIndex = undefined;
                },
                error: function (xhr, status, error) {
                    alert(xhr + '~' + status + '~' + error);
                }
            });


        });


        $('#btnAddPlanDetail').click(function (e) {
            var FabricPlan = $("#tblFabricPlan").datagrid("getSelected");
            if (FabricPlan == null || FabricPlan.FabricPlanID <= 0) { alert("Please select an item from list!"); return false; }
            window.open(sessionStorage.getItem('BaseAddress')+"/FabricPlan/ViewFabricPlanDetail?nFabricPlanID="+FabricPlan.FabricPlanID, '_blank');
        });

        $("#btnResetProduct").click(function () {

            $("#txtProduct").val("");
            $("#winPatternPicker").data('ProductID',0);
        });
        $("#btnPickProduct").click(function () {
            var sProductName=$.trim($("#txtProduct").val());
            GetProducts(sProductName);
        });
        $("#txtProduct").keydown(function (e) {
            var nkeyCode = e.keyCode || e.which;
            if(nkeyCode==13){
                var sProductName=$.trim($("#txtProduct").val());
                //if(sProductName==""){ alert("Type product name to search."); return false; }
                GetProducts(sProductName);
            }
            else if(nkeyCode==8){
                $("#txtProduct").val("");
                $("#winPatternPicker").data('ProductID',0);
            }
        });

        function SetProduct(oProduct)
        {
            if(oProduct !=null  && oProduct.ProductID>0){
                $('#txtProduct').val(oProduct.ProductName);
                $('#txtColorName').focus();

                $("#winPatternPicker").data('ProductID',oProduct.ProductID);
            }
        }
        function GetProducts(sProductName){
            if(parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 0 || parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 3){
                alert('please select either Warp or Weft!!');
                return false;
            }
            var oProduct = {
                BUID: sessionStorage.getItem("BUID"),
                ProductName: sProductName,
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oProduct,
                ControllerName: "FabricPlan",
                ActionName: "GetProducts",
                IsWinClose: false
            };

            var tblColums = [];
            var oColumn = { field: "ProductCode", title: "Code", width: 80, align: "left" };tblColums.push(oColumn);
            oColumn = { field: "ProductName", title: "Name", width: 270, align: "left" };tblColums.push(oColumn);
            oColumn = { field: "MUnit", title: "Unit", width: 70, align: "left" };tblColums.push(oColumn);

            var oPickerParam = {
                winid: 'winProductPicker',
                winclass:'clsProductPicker',
                winwidth: 520,
                winheight: 460,
                tableid: 'tblProductPicker',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName:'ProductName',
                windowTittle: 'Product List',
                paramObj:obj,
                pkID:'ProductID',
                callBack:SetProduct
            };


            $.icsDynamicPicker(oPickerParam);
        }

        $("#btnAddLD_Warp").click(function(){

            var oWarpPlan = $('#tblFabricPlan').datagrid('getSelected');
            if (oWarpPlan == null ) {
                alert("Please select a Warp color from list!");
                return;
            }

            GetsWaftWarp($("#txtColorWarp").val());
        });
        $("#txtLDNo_Warp").keydown(function (e) {
            if (e.keyCode == 13) // Enter Press
            {
                var oWarpPlan = $('#tblFabricPlan').datagrid('getSelected');
                if (oWarpPlan == null ) {
                    alert("Please select a warp color from list!");
                    return;
                }

                GetsWaftWarp($("#txtLDNo_Warp").val());
            }
        });
        function GetsWaftWarp(sColorNo) {
            debugger;
            var oFESDetail = {
                FabricID: 0,
                ColorName: "" ,
                ColorNo: sColorNo ,
                ProductID:0
                // here Note property use for color name string
            };

            var oWarpPlan = $('#tblFabricPlan').datagrid('getSelected');
            oFESDetail.ProductID=0;//oWarpPlan.ProductID;

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFESDetail,
                ControllerName: "FabricExecutionOrderSpecification",
                ActionName: "GetsLabdips",
                IsWinClose: false
            };
            var tblColums = [];
            var oColumn = { field: "ColorName", title: "ColorName", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ColorName", title: "ColorName", width: 300, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ColorNo", title: "LD No", width: 80, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "PantonNo", title: "Panton No", width: 80, align: "left" }; tblColums.push(oColumn);

            var oPickerParam = {
                winid: 'winFPColorPicker',
                winclass:'clsFPColorPicker',
                winwidth: 520,
                winheight: 460,
                tableid: 'tblFPColorPicker',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName:'ColorName',
                windowTittle: 'Color List',
                paramObj:obj,
                pkID:'LabDipDetailID',
                callBack:SetLDNo
            };


            $.icsDynamicPicker(oPickerParam);

        }
        function SetLDNo(oLabDipDetail)
        {
            if(oLabDipDetail !=null  && oLabDipDetail.LabDipDetailID>0){
                var oWarpPlan = $('#tblFabricPlan').datagrid('getSelected');
                var nSelectedIndex = $('#tblFabricPlan').datagrid('getRowIndex', oWarpPlan);
                if (oWarpPlan == null ) {
                    alert("Please select a item from list!");
                    return;
                }
                //oWarpPlan.ColorNo=oLabDipDetail.ColorNo;
                //oWarpPlan.ColorName=oLabDipDetail.ColorName;
                oWarpPlan.LabdipDetailID=oLabDipDetail.LabDipDetailID;
                oWarpPlan.PantonNo=oLabDipDetail.PantonNo;
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : _sBaseAddress+  "/FabricPlan/UpdateLDDetailID",
                    traditional: true,
                    data: JSON.stringify(oWarpPlan),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        var oFP = jQuery.parseJSON(data);
                        if(oFP.ErrorMessage=="" || oFP.ErrorMessage == null){
                            $('#tblFabricPlan').datagrid('updateRow', { index: nSelectedIndex, row: oFP });
                        }
                        else{
                            alert(oFP.ErrorMessage);
                        }
                    },error: function (xhr, status, error) {
                        alert(error);
                    }
                });
            }
        }
        $("#txtColorName").keydown(function (e) {
            if (e.keyCode === 13) {
                if ($.trim($("#txtColorName").val()).length == 0 ) {
                    $("#txtColorName").addClass("errorFieldBorder");
                    $("#txtColorName").focus();
                    alert("Please Entry Color Name.");
                    return false;
                } else {
                    $("#txtColorName").removeClass("errorFieldBorder");
                }

                if(parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 0 || parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 3)
                {
                    alert('please select either Warp or Weft!!');
                    return false;
                }
                debugger
                if($("#winPatternPicker").data('FabricPlan')==null || parseInt($("#winPatternPicker").data('FabricPlan').FabricPlanID)<=0)
                {
                    SaveFabricPlanDetail(false);
                }
                else{
                    SaveFabricPlanDetail(true);
                }

            }
        });

        $("#btnPickLDNo").click(function(){
            GetsLD($("#txtLDNo").val());
        });
        $("#txtLDNo").keydown(function (e) {
            if (e.keyCode == 13){
                GetsLD($("#txtLDNo").val());
            }
            else if(e.keyCode == 8){
                $("#winPatternPicker").data('ProductID',0);
                $("#txtColorName").val("");
                $("#winPatternPicker").data('LabdipDetailID',0);
            }
        });
        function GetsLD(sColorNo) {
            debugger;
            if(parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 0 || parseInt($("#winPatternPicker").data('SelectedWarpWeftType')) == 3){
                alert('please select either Warp or Weft!!');
                return false;
            }
            var oFESDetail = {
                ColorNo: sColorNo
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFESDetail,
                ControllerName: "FabricExecutionOrderSpecification",
                ActionName: "GetsLabdips",
                IsWinClose: false
            };
            var tblColums = [];
            var oColumn = { field: "ColorName", title: "ColorName", width: 120, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ColorName", title: "ColorName", width: 300, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "ColorNo", title: "LD No", width: 80, align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "PantonNo", title: "Panton No", width: 80, align: "left" }; tblColums.push(oColumn);
            var oPickerParam = {
                winid: 'winLDPicker',
                winclass:'clsLDPicker',
                winwidth: 520,
                winheight: 460,
                tableid: 'tblLDPicker',
                tablecolumns: tblColums,
                multiplereturn: false,
                searchingbyfieldName:'ColorName',
                windowTittle: 'Color List',
                paramObj:obj,
                pkID:'LabDipDetailID',
                callBack:SetLabDipDNo
            };
            $.icsDynamicPicker(oPickerParam);
        }

        function SetLabDipDNo(oLabDipDetail)
        {
            if(oLabDipDetail !=null  && oLabDipDetail.LabDipDetailID>0){
                $("#winPatternPicker").data('ProductID',oLabDipDetail.ProductID);
                $("#txtColorName").val(oLabDipDetail.ColorName);
                $("#winPatternPicker").data('LabdipDetailID', oLabDipDetail.LabDipDetailID);
                SaveFabricPlanDetail(false);
            }
        }

        $('#btnClose').click(function(e){
            debugger
            window.location.href = sessionStorage.getItem("BackLink");
        });

        $('#btnPrint,#btnPrintPO').click(function (e)
        {
            debugger;
            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            if(oFabricPlanOrder==null || oFabricPlanOrder.FabricPlanOrderID<=0)
            {
                alert("Please select an item from list!");
                return;
            }
         //   if ($("#winPatternPicker").data('FabricPlanOrder') ==null || $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID<=0 ) { alert("Please select an item from list."); return ; }
            window.open(_sBaseAddress + '/FabricPlan/PrintFabricPlan?nID='+oFabricPlanOrder.FabricPlanOrderID+"&buid="+1, "_blank");

        });
        $('#btnPrintV1,#btnPrintV1PO').click(function (e)
        {
            debugger;
            var oFabricPlanOrder= $('#tblFabricPlanOrders').datagrid('getSelected');
            if(oFabricPlanOrder==null || oFabricPlanOrder.FabricPlanOrderID<=0)
            {
                alert("Please select an item from list!");
                return;
            }
            // var oLDpDetail = $('#tblFabricPlan').datagrid('getRows');
           // if ($("#winPatternPicker").data('FabricPlanOrder') ==null || $("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID<=0 ) { alert("Please select an item from list."); return ; }
            window.open(_sBaseAddress + '/FabricPlan/PrintFabricPlan_V1?nID='+oFabricPlanOrder.FabricPlanOrderID+"&buid="+1, "_blank");

        });
        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#tblFabricPlan').datagrid('validateRow', editIndex)) {
                $('#tblFabricPlan').datagrid('endEdit', editIndex);
                $('#tblFabricPlan').datagrid('selectRow', editIndex);
                debugger;
                //InvoiceType: Standard = 1, Advance = 2
                //ReferenceType : Open = 1, PO = 2, Import = 3
                var oFabricPlan = $('#tblFabricPlan').datagrid('getSelected');
                _nEndsCount=0;
                for(var j=1;j<=$("#winPatternPicker").data('FabricPlanOrder').ColumnCount;j++)
                {
                    _nEndsCount=parseInt(_nEndsCount)+ parseInt(oFabricPlan["EndsCount"+j]);
                }
                oFabricPlan.EndsCount=_nEndsCount;
                //if (oFabricPlan.FabricPlanID>0) {
                //    UpdateFP(oFabricPlan, editIndex);
                //}
                //else
                //{
                //    $('#tblFabricPlan').datagrid('updateRow', { index: editIndex, row: oFabricPlan });
                //}
                $('#tblFabricPlan').datagrid('updateRow', { index: editIndex, row: oFabricPlan });

                //  RefreshSummery();
                editIndex = undefined;
                return true;
            }
            else {
                return false;
            }
        }

        function onClickRow(index) {
            if (editIndex != index) {
                if (endEditing()) {
                    $('#tblFabricPlan').datagrid('selectRow', index).datagrid('beginEdit', index);
                    var oFabricPlan= $('#tblFabricPlan').datagrid('getSelected');
                    //if(oPurchaseInvoiceDetail.PurchaseInvoiceDetailID<=0){
                    //    $('#btnAddSpecification').hide();
                    //}
                    //else{
                    //    $('#btnAddSpecification').show();
                    //}
                    editIndex = index;
                }
                else {
                    $('#tblFabricPlan').datagrid('selectRow', editIndex);
                }
            }
        }

        function UpdateFP(oFabricPlan, SelectedRowIndex)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricPlan/SavePlanning",
                traditional: true,
                data: JSON.stringify(oFabricPlan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oFabricPlan = jQuery.parseJSON(data);

                    if (parseInt(oFabricPlan.FabricPlanID) > 0) {
                        $('#tblFabricPlan').datagrid('updateRow', { index: SelectedRowIndex, row: oFabricPlan });
                        // RefreshTotalSummery();
                    }
                    else {
                        alert(oFabricPlan.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }

        /////Twist
        function formatTwisted(value){

            if(value>0){
                return "Twisted";
            }
            else{
                return "";
            }
        }
        function onLoadSuccess(data)
        {
            debugger;
            var nIndex=0;
            var nSpan=0;
            var oCellRowSpans = $("#winPatternPicker").data('CellRowSpans');
            if(oCellRowSpans!==null)
            {
                if(oCellRowSpans.length>0)
                {
                    for(var i=0;i<oCellRowSpans.length;i++){
                        var oMCell=[oCellRowSpans[i].mergerCell];
                        nIndex=oMCell[0][0];
                        nSpan= oMCell[0][1];
                        if(oCellRowSpans[i].FieldName=="TwistedGroup"){
                            $(this).datagrid('mergeCells',{index: nIndex, field: 'TwistedGroup', rowspan: nSpan});
                            $(this).datagrid('mergeCells',{index: nIndex, field: 'Value', rowspan: nSpan});
                            $(this).datagrid('mergeCells',{index: nIndex, field: 'EndsCount', rowspan: nSpan});
                            $(this).datagrid('mergeCells',{index: nIndex, field: 'WarpWeftTypeSt', rowspan: nSpan});

                        }
                    }
                }
            }
        }



        $('#btnMakeTwisted').click(function(e){

            debugger;
            var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');

            if(oFabricPlans.length<=0){
                alert("No items found to be twisted."); return false;
            }

            var sFabricPlanIDs="";
            for(var i=0; i<oFabricPlans.length; i++){
                sFabricPlanIDs = sFabricPlanIDs + oFabricPlans[i].FabricPlanID +",";
            }
            sFabricPlanIDs=sFabricPlanIDs.substring(0,sFabricPlanIDs.length-1);

            var oFabricPlan={
                FSCDID: oFabricPlans[0].FSCDID,
                FabricPlanOrderID:oFabricPlans[0].FabricPlanOrderID,
                FabricPlanID: oFabricPlans[0].FabricPlanID,
                ComboNo: 0,
                WarpWeftType: parseInt($("#winPatternPicker").data('SelectedWarpWeftType')),
                ErrorMessage: sFabricPlanIDs
            }

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFabricPlan,
                ObjectId: oFabricPlan.FabricPlanID,
                ControllerName: "FabricPlan",
                ActionName: "MakeCombo",
                TableId: "",
                IsWinClose: false,
                Message: ""// (oDyeingOrderDetail.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    debugger;
                    if (response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID>0)
                    {
                        $("#winPatternPicker").data('CellRowSpans',response.obj.FabricPlans[0].CellRowSpans);
                        $("#winPatternPicker").data('FabricPlans',response.obj.FabricPlans);
                       // ChangeWarpWeft();
                        Refresh(response.obj.FabricPlans);
                    }
                    else if(response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID<=0){
                        alert(response.obj.FabricPlans[0].ErrorMessage);
                    }
                    else{
                        alert(response.obj.ErrorMessage);
                    }
                }
            });
        });

        $('#btnRemoveTwisted').click(function(e){

            var oFabricPlans= $('#tblFabricPlan').datagrid('getChecked');

            if(oFabricPlans.length<=0){
                alert("No items found to be twisted."); return false;
            }

            var sFabricPlanIDs="";
            for(var i=0; i<oFabricPlans.length; i++){
                sFabricPlanIDs = sFabricPlanIDs + oFabricPlans[i].FabricPlanID +",";
            }
            sFabricPlanIDs=sFabricPlanIDs.substring(0,sFabricPlanIDs.length-1);

            var oFabricPlan={
                FSCDID: oFabricPlans[0].FSCDID,
                FabricPlanOrderID:oFabricPlans[0].FabricPlanOrderID,
                FabricPlanID: oFabricPlans[0].FabricPlanID,
                ComboNo: 0,
                WarpWeftType: parseInt($("#winPatternPicker").data('SelectedWarpWeftType')),
                ErrorMessage: sFabricPlanIDs
            }


            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFabricPlan,
                ObjectId: oFabricPlan.FabricPlanID,
                ControllerName: "FabricPlan",
                ActionName: "RemoveComboGroup",
                TableId: "",
                IsWinClose: false,
                Message: ""// (oDyeingOrderDetail.FabricPlanID>0)?"Update Successfully." : "Save Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    debugger;
                    if (response.obj.FabricPlans.length > 0 && response.obj.FabricPlans[0].FabricPlanID>0) {

                        $("#winPatternPicker").data('CellRowSpans', response.obj.FabricPlans[0].CellRowSpans);
                        //   DynamicRefreshList(response.obj.DyeingOrderDetails, 'tblFabricPlan');
                        Refresh(response.obj.FabricPlans);debugger;
                    }
                    else{
                        alert(response.obj.ErrorMessage);
                    }
                }
            });
        });

        function formatPrice(val,row)
        {
            if (isNaN(val)) {val = 0;}
            val=parseFloat(val);
            var test = val.toFixed(0);
            if (val <= 0)
            {
                test=(-1*test);
            }
            var tests =test;// addComma(test);
            if (val <= 0)
            {
                return '';
            }
            else
            {
                return tests;
            }

        }


        function IsExist(oFabricPlan)
        {
            var oLDpDetail = $('#tblFabricPlan').datagrid('getRows');
            for (var i = 0; i < oLDpDetail.length; i++) {
                if (parseInt(oLDpDetail[i].WarpWeftType) ==parseInt(oFabricPlan.WarpWeftType) && oLDpDetail[i].ColorName ==oFabricPlan.ColorName)
                {
                    return true;
                }
            }

            return false;
        }
        $('#btnRefresh').click(function(e){

            endEditing();
        });

        $('#btnAddColumn').click(function(e){

            endEditing();
            $("#winPatternPicker").data('FabricPlanOrder').ColumnCount= $("#winPatternPicker").data('FabricPlanOrder').ColumnCount+5;

            debugger
            var oFabricPlanDetails=[];
            var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');

            for(var i=0;i<oFabricPlans.length;i++)
            {
                var oFabricPlan=  oFabricPlans[i];
                oFabricPlanDetails=[];
                for(var j=1;j<=$("#winPatternPicker").data('FabricPlanOrder').ColumnCount;j++)
                {
                    var nEndsCount=  oFabricPlan["EndsCount"+j];
                    //var nColNo=  oFabricPlan["ColNo"+j];
                    if(nEndsCount>0)
                    {
                        var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:nEndsCount, SLNo:0};
                        oFabricPlanDetails.push(oFPD);
                    }
                    //else{
                    //    var oFPD={FabricPlanID:oFabricPlans[i].FabricPlanID, ColNo:j, EndsCount:0, SLNo:0};
                    //    oFabricPlanDetails.push(oFPD);
                    //}
                }
                oFabricPlans[i].FabricPlanDetails=oFabricPlanDetails;
            }

            MakeGrid();
            Refresh(oFabricPlans);

        });

        //NAZMUL 9/12/19
        function CbolColNoLoad(){
            _oStartEndCols = [];
            for(var i = 1; i <=$("#winPatternPicker").data('FabricPlanOrder').ColumnCount; i++)
            {
                //oVal= { field :"EndsCount"+i, title:"Count" + i};
                oVal= { field :i, title:"Count" + i};
                _oStartEndCols.push(oVal);
            }

            DynamicRefreshList([],'tblEndColmns');
            DynamicRefreshList(_oStartEndCols,'tblEndColmns');
        }

        $("#btnRepeatSection").click(function(){
            debugger;
            CbolColNoLoad();
            var oFabricPlanRepeat={
                FabricPlanOrderID : parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID)
            }
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/FabricPlan/GetFabricPlanRepeat",
                traditional: true,
                data:  JSON.stringify(oFabricPlanRepeat),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    _oFabricPlanRepeats = data;
                    if (_oFabricPlanRepeats.length>0)
                    {
                        DynamicRefreshList(_oFabricPlanRepeats,'tblFabricPlanRepeat');
                    }
                    else
                    {
                        //RefreshConsumption();
                        DynamicRefreshList([],'tblFabricPlanRepeat');
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
            $("#cboWarpWeftType").val(parseInt($("#winPatternPicker").data('SelectedWarpWeftType')));
            $("#winFabricPlanRepeat").icsWindow('open',"Add Faric Plan Repeat");
        });

        $("#btnFabricPlanRepeatClose").click(function(){
            $("#winFabricPlanRepeat").icsWindow('close');
        });

        function ValidateInput(){
            var oColNos = $("#tblEndColmns").datagrid("getChecked");
            var nWarpWeftType =  parseInt($("#cboWarpWeftType").val())
            if(oColNos.length<2){
                alert("Start & End Column Required");
                return false;
            }
            if(nWarpWeftType == 3){
                alert("Choose Warp or Weft!");
                return false;
            }

            return true;
        }
        $('#btnAddFabricPlanRepeat').click(function(){
            debugger;
            var startCol = 0;
            var endCol = 0;
            var oColNos = $("#tblEndColmns").datagrid("getChecked");
            for(var i=0; i<oColNos.length;i++)
            {
                if(i==0){
                    startCol = oColNos[i].field;
                }
                if(i==oColNos.length-1){
                    endCol = oColNos[i].field;
                }

            }
            sessionStorage.setItem("FabricPlanRepeatHeader","Add FabricPlanRepeat")
            var oFabricPlanRepeat =
                {
                    FabricPlanRepeatID :  0,
                    FabricPlanOrderID : parseInt($("#winPatternPicker").data('FabricPlanOrder').FabricPlanOrderID),
                    WarpWeftType : parseInt($("#cboWarpWeftType").val()),
                    RepeatNo : parseInt(icsRemoveComma($('#txtRepeatNo').val())),
                    StartCol :   parseInt(startCol),
                    EndCol :  parseInt(endCol)
                }
            debugger;
            if(!ValidateInput()){return;}
            $.ajax({
                type: "POST",
                dataType: "json",
                url :  _sBaseAddress+ "/FabricPlan/FabricPlanRepeatSave",
                traditional: true,
                data:  JSON.stringify(oFabricPlanRepeat),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    oFabicPlanRepeat = jQuery.parseJSON(data);
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oFabicPlanRepeat.ErrorMessage=="" || oFabicPlanRepeat.ErrorMessage==null)
                    {
                        alert("Data Saved sucessfully");
                        if(sessionStorage.getItem("FabricPlanRepeatHeader") == "Add FabricPlanRepeat")
                        {
                            $('#tblFabricPlanRepeat').datagrid('appendRow',oFabicPlanRepeat);
                            var oData = $('#tblFabricPlanRepeat').datagrid('getRows');
                            $('#tblFabricPlanRepeat').datagrid('selectRow',oData.length-1);
                        }
                        RefreshConsumption();
                        //$("#winFabricPlanRepeat").icsWindow('close');
                    }
                    else
                    {
                        alert(oFabicPlanRepeat.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }

            });

        });

        $("#btnRemoveFabricPlanRepeat").click(function(){
            debugger;
            var oFabricPlanRepeat = $('#tblFabricPlanRepeat').datagrid('getSelected');
            if(oFabricPlanRepeat==null || oFabricPlanRepeat.FabricPlanRepeatID<=0)
            {
                alert("Please select a item from list!");
                return;
            }
            var SelectedRowIndex=$('#tblFabricPlanRepeat').datagrid('getRowIndex',oFabricPlanRepeat);
            if (!confirm("Confirm to Delete?")) return false;
            $.ajax({
                type: "GET",
                dataType: "json",
                url :  _sBaseAddress+ "/FabricPlan/FabricPlanRepeatDelete",
                data: {id: oFabricPlanRepeat.FabricPlanRepeatID},
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage == "Deleted")
                    {
                        alert("Delete sucessfully");
                        $('#tblFabricPlanRepeat').datagrid('deleteRow',SelectedRowIndex);

                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

        });

        function RefreshConsumption()
        {
            $('#txtRepeatNo').val(0);
            $("#cboWarpWeftType").val(0);
            $("#cboStartCol").val(0);
            $("#cboEndCol").val(0);
        }

        ////Sequence
        function UP()
        {
            debugger;
            var oFabricPlan = $('#tblFabricPlan').datagrid('getSelected');
            if(oFabricPlan==null)
            {
                alert("Please select Item");
                return;
            }
            var SelectedRowIndex=$('#tblFabricPlan').datagrid('getRowIndex',oFabricPlan);
            if(SelectedRowIndex==0)return;
            var oFabricPlans=$('#tblFabricPlan').datagrid('getRows');
            var oTempFabricPlans = [];
            for(var i=0; i<oFabricPlans.length; i++)
            {
                if(i==(SelectedRowIndex-1))
                {
                    oTempFabricPlans[i]=oFabricPlans[i+1];
                }
                else if(i==SelectedRowIndex)
                {
                    oTempFabricPlans[i]=oFabricPlans[i-1];
                }
                else
                {
                    oTempFabricPlans[i]=oFabricPlans[i];
                }
                oTempFabricPlans[i].SLNo=i+1;
            }
            $("#winPatternPicker").data('FabricPlans',oTempFabricPlans);
            DynamicRefreshList(oTempFabricPlans, 'tblFabricPlan');
            var newSelectedRowIndex=SelectedRowIndex-1;
            $('#tblFabricPlan').datagrid('selectRow',newSelectedRowIndex);

        }
        function Down()
        {
            debugger;
            var oFabricPlan = $('#tblFabricPlan').datagrid('getSelected');
            if(oFabricPlan==null)
            {
                alert("Please select a item from list!");
                return;
            }
            var SelectedRowIndex=$('#tblFabricPlan').datagrid('getRowIndex',oFabricPlan);
            if(SelectedRowIndex==($("#winPatternPicker").data('FabricPlans').length-1))return;
            var oFabricPlans=$('#tblFabricPlan').datagrid('getRows');
            var oTempFabricPlans = [];
            for(var i=0; i<oFabricPlans.length; i++)
            {
                if(i==(SelectedRowIndex+1))
                {
                    oTempFabricPlans[i]=oFabricPlans[i-1];
                }
                else if(i==SelectedRowIndex)
                {
                    oTempFabricPlans[i]=oFabricPlans[i+1];
                }
                else
                {
                    oTempFabricPlans[i]=oFabricPlans[i];
                }
                oTempFabricPlans[i].SLNo=i+1;
            }
            $("#winPatternPicker").data('FabricPlans',oTempFabricPlans);
            DynamicRefreshList(oTempFabricPlans, 'tblFabricPlan');
            var newSelectedRowIndex=SelectedRowIndex+1;
            $('#tblFabricPlan').datagrid('selectRow',newSelectedRowIndex);
        }
        function RefreshSequence()
        {
            var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');
            if(oFabricPlans.length>0)
            {
                for(var i = 0;i<oFabricPlans.length;i++)
                {
                    oFabricPlans[i].SLNo = i+1;
                }

                DynamicRefreshList(oFabricPlans, 'tblFabricPlan');
            }
        }
        $("#btnSaveSequence").click(function () {
            debugger;

            var oFabricPlans = $('#tblFabricPlan').datagrid('getRows');
            if(oFabricPlans.length>0)
            {
                for(var i = 0;i<oFabricPlans.length;i++)
                {
                    oFabricPlans[i].SLNo = i+1;
                }

              //  DynamicRefreshList(oFabricPlans, 'tblFabricPlan');
            }

            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oFabricPlans,
                ObjectId: oFabricPlans[0].FabricPlanID,
                ControllerName: "FabricPlan",
                ActionName: "SaveSequence",
                TableId: "",
                IsWinClose: false
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {

                }
            });
        });


        $('#btnClosePattern').click(function(e){
            debugger;
            $("#winPatternPicker").icsWindow('close');
        });

        function TempAddComma(nStr) {
            debugger;
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var process = /(\d+)(\d{3})/;
            while (process.test(x1)) {
                x1 = x1.replace(process, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }
    </script>
