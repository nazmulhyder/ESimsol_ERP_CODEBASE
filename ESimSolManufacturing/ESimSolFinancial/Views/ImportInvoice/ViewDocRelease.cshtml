<html>
@{
    ViewBag.title = "Document Release";
}
@model ESimSol.BusinessObjects.ImportInvoice
<body>
    <div class="menuMainCollectionTable" id="divImportInvoice" class="easyui-panel" title="Add  Invoice" style="font-family:Tahoma; height:100%; width:100%">
        <div class="easyui-panel" title="Send to CNF" style="font-family:Tahoma; height:89%; width:100%">
            <fieldset>
                <legend style="font-weight:bold">Invoice Info: </legend>
                <table border="0" cellspacing="4" cellpadding="4" style="width:100%;font-size:11px; font-weight:bold">
                    
                    <tr>
                        <td style="width:15%; text-align:right">
                            Invoice No:
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtInvoiceNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            <label id="lblAmendmentNo">L/C No :</label>
                        </td>
                        <td style="width:25%">
                            <input id="txtLCNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            Supplier Name:
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtContractorName" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            Bank Name :
                        </td>
                        <td style="width:25%">
                            <input id="txtBankName" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            Invoice Date:
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtInvoiceDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            L/C Date  :
                        </td>
                        <td style="width:25%">
                            <input id="txtLCDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            Invoice Value:
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtInvoiceValue" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            L/C Value :
                        </td>
                        <td style="width:25%">
                            <input id="txtLCValue" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            Payment Type:
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtLCPaymentType" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            L/C Status :
                        </td>
                        <td style="width:25%">
                            <input id="txtLCStatus" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            Invoice Status :
                        </td>
                        <td colspan="3" style="width:30%">
                            <input id="txtInvoiceStatus" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            Bank Status :
                        </td>
                        <td style="width:25%">
                            <input id="txtBankStatus" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                    <tr>
                        <td style="width:15%; text-align:right">
                            B/L No :
                        </td>
                        <td style="width:10%">
                            <input id="txtBLNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:10%; text-align:right">
                            B/L Date :
                        </td>
                        <td style="width:10%">
                            <input id="txtBLDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                        <td style="width:15%; text-align:right">
                            ETA Date :
                        </td>
                        <td style="width:25%">
                            <input id="txtETADate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                        </td>
                       
                        <td style="width:10%; text-align:right"></td>
                    </tr>
                 
                </table>
            </fieldset>
            <fieldset id="DocRelease">
                <legend> <span style=" font-weight:bold; color:gray; ">Doc Release Letter Issue</span></legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width: 100%;font-weight: bold; font-size: 12px">

                    <tr style="height:40px">
                        <td style="width:20%; text-align:right;">Letter Issue Date:</td>
                        <td style="width:10%;"><input id="txtDateofBankInfo" type="text" style="width: 100%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                       
                        <td style="width:20%;"></td>
                        <td style="width:8%; text-align:right;"></td>
                        <td style="width:22%;"></td>
                        <td style="width:20%; text-align:right;"></td>
                    </tr>

                    <tr>
                        <td style="width:20%; text-align:right;">Remarks:</td>
                        <td colspan="3" style="width:30%;"><input id="txtRemarkOne" type="text" style="width:100%;" /></td>
                                             
                        <td style="width:8%;text-align:right; font-size:13px">
                            <a id="btnSave_DocBank" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width:22%;text-align:left;">
                            <a id="btnPrintLetter" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintLetter()">Letter(Preview)</a>
                        </td>
                        <td style="width:20%; text-align:right;"></td>
                    </tr>

                </table>
            </fieldset>
            <fieldset id="DocRelease">
                <legend> <span style=" font-weight:bold; color:gray; ">Doc Release </span></legend>
                <table border="0" cellspacing="2" cellpadding="2" style="width: 100%;font-weight: bold; font-size: 12px">
                    <tr style="height:40px">
                        <td style="width:20%; text-align:right;">Doc Release Date:</td>
                        <td style="width:10%;"><input id="txtDateOfTakeOutDoc" type="text" style="width: 100%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>

                        <td style="width:20%;"></td>
                        <td style="width:8%; text-align:right;"></td>
                        <td style="width:22%;"></td>
                        <td style="width:20%; text-align:right;"></td>
                    </tr>

                    <tr>
                        <td style="width:20%; text-align:right;">Remarks:</td>
                        <td colspan="3" style="width:30%;"><input id="txtRemarkTwo" type="text" style="width:100%;" /></td>

                        <td style="width:8%;text-align:right; font-size:13px">
                            <a id="btnSaveDocRelease" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        </td>
                        <td style="width:22%;text-align:left;">
                        </td>
                        <td style="width:20%; text-align:right;"></td>
                    </tr>
                 
                    

                </table>
            </fieldset>

        </div>
        <fieldset>
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="0" cellpadding="0" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width: 20%;text-align:left;">
                        <a id="btnPrintLetter" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="PrintLetter()">Doc Release Letter</a>
                    </td>
                    <td style="width:50%; text-align:right">
                        <div style="width: 95%;margin: 0 auto;text-align: center;font-size: 15px; float: left;">
                            <span class="lblToolTip"></span>
                        </div>
                    </td>
                    <td style="width: 20%;text-align:right;">
                    </td>
                    <td style="width: 10%;text-align:right;">
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="Close()" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
        </div>
    </body>
    </html>

    <script type="text/javascript">
    var _oImportInvoice=null;
    var _oPInvoiceHistory=null;
    var _sBaseAddress="";
    var _oImportInvoiceHistorys=[];
    var _sHeader="";
    var _sBackLink="";
    var _nTotalExpAmount=0;
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oImportInvoice = @Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oImportInvoiceHistorys=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ImportInvoiceHistorys));
            RefreshLabel();
            _sBackLink=sessionStorage.getItem("BackLink");
        });


        function RefreshLabel()
        {
            debugger;
            $("#txtInvoiceNo").val(_oImportInvoice.ImportInvoiceNo);
            $("#txtLCNo").val(_oImportInvoice.ImportLCNo);
            $("#txtContractorName").val(_oImportInvoice.ContractorName);
            $("#txtBankName").val(_oImportInvoice.BankName_Nego);
            $("#txtInvoiceDate").val(_oImportInvoice.InvoiceDateInString);
            $("#txtLCDate").val(_oImportInvoice.ImportLCDateInString);
            $("#txtInvoiceValue").val(_oImportInvoice.AmountSt);
            $("#txtLCValue").val(_oImportInvoice.AmountLCInSt);
            $("#txtLCPaymentType").val(_oImportInvoice.LCPaymentType);
            $("#txtLCStatus").val(_oImportInvoice.LCCurrentStatusSt);
            $("#txtInvoiceStatus").val(_oImportInvoice.CurrentStatusInSt);
            $("#txtBankStatus").val(_oImportInvoice.BankStatusInSt);
            $("#txtBLNo").val(_oImportInvoice.BLNo);
            $("#txtBLDate").val(_oImportInvoice.BLDateSt);
            $("#txtETADate").val(_oImportInvoice.ETADateSt);

            $('#txtDateofBankInfo').datebox('setValue',_oImportInvoice.DateofBankInfoSt);
            $('#txtDateOfTakeOutDoc').datebox('setValue',_oImportInvoice.DateOfTakeOutDocSt);
                        
            for (var i = 0; i < _oImportInvoiceHistorys.length; i++) 
            {
                if(_oImportInvoiceHistorys[i].InvoiceEventInt===3)
                {
                    $("#txtRemarkOne").val(_oImportInvoiceHistorys[i].Note);
                }
                if(_oImportInvoiceHistorys[i].InvoiceEventInt==4)
                {
                    $("#txtRemarkTwo").val(_oImportInvoiceHistorys[i].Note);
                }
                
            }
        }
        function   PrintLetter()
        {
           
            window.open(_sBaseAddress+'/ImportInvoice/PrintTakeOutOriginalDoc?id='+_oImportInvoice.ImportInvoiceID, "_blank");

        }

        $('#btnSave_DocBank').click( function(){
        
            var dDateofBankInfo = new Date($('#txtDateofBankInfo').datebox('getValue'));
            var dDateOfInvoice = new Date(_oImportInvoice.DateofInvoice);

            if ($('#txtDateofBankInfo').datebox('getValue') == null || $('#txtDateofBankInfo').datebox('getValue') == "") {
                alert("Please give valid Date!"); $('#txtDateofBankInfo').focus();
                return false;
            }
            if ((dDateOfInvoice) > (dDateofBankInfo))
            {
                alert("Doc Receive By Bank Date cannot be greater than Invoice Date.");
                $('#txtDateofBankInfo').focus();
                $("#txtDateofBankInfo").addClass("errorFieldBorder");
                return false;
            }
           
            var oImportInvoice={
                ImportInvoiceID: _oImportInvoice.ImportInvoiceID,
                DateofBankInfo:new Date($('#txtDateofBankInfo').datebox('getValue')),
                DateOfTakeOutDoc:new Date(),
                BillofEntryDate:new Date(),
                DateofNegotiation :new Date(),
                DateofAcceptance :new Date(),
                DateofMaturity :new Date(),
                CommonDate :new Date(),
                CommonRemarks:  $("#txtRemarkOne").val()
            }

        
            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/ImportInvoice/BankInfoCollect",
                traditional: true,
                data:  JSON.stringify(oImportInvoice),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oImportInvoice = jQuery.parseJSON(data);
                    if(oImportInvoice.ErrorMessage==null||oImportInvoice.ErrorMessage=="" )
                    {
                        alert("Data Save Succesfully.");
                        _oImportInvoice=oImportInvoice;
                        var oImportInvoices = sessionStorage.getItem("ImportInvoices");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oImportInvoices != null) {
                            oImportInvoices = jQuery.parseJSON(oImportInvoices);
                        }
                        else {
                            oImportInvoices = [];
                        }
                        if (nIndex != -1) {
                            oImportInvoices[nIndex] = _oImportInvoice;
                        }
                        else {
                            sessionStorage.setItem("SelectedRowIndex", oImportInvoices.length);
                            oImportInvoices.push(_oImportInvoice);
                        }
                        sessionStorage.setItem("ImportInvoices", JSON.stringify(oImportInvoices));
                        //window.location.href = _sBackLink;
                    
                    }
                    else{
                        alert(oImportInvoice.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

        }); 
        $('#btnSaveDocRelease').click( function(){
        
            var dDateofBankInfo = new Date($('#txtDateofBankInfo').datebox('getValue'));
            var dDateOfTakeOutDoc = new Date($('#txtDateOfTakeOutDoc').datebox('getValue'));

            if ($('#txtDateOfTakeOutDoc').datebox('getValue') == null || $('#txtDateOfTakeOutDoc').datebox('getValue') == "") {
                alert("Please give valid Date!"); $('#txtDateOfTakeOutDoc').focus();
                return false;
            }
            if ((dDateOfTakeOutDoc) < (dDateofBankInfo))
            {
                alert("Doc Release Date Date cannot be greater than Doc Receive By Bank Date.");
                $('#txtDateofBankInfo').focus();
                $("#txtDateofBankInfo").addClass("errorFieldBorder");
                return false;
            }
            
            var oImportInvoice={
                ImportInvoiceID: _oImportInvoice.ImportInvoiceID,
                DateofBankInfo:new Date($('#txtDateofBankInfo').datebox('getValue')),
                DateOfTakeOutDoc:new Date($('#txtDateOfTakeOutDoc').datebox('getValue')),
                BillofEntryDate:new Date(),
                DateofNegotiation :new Date(),
                DateofAcceptance :new Date(),
                DateofMaturity :new Date(),
                CommonDate :new Date(),
                CommonRemarks:  $('#txtRemarkTwo').val()
            }

            $.ajax({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/ImportInvoice/TakeOutOrginalDoc",
                traditional: true,
                data:  JSON.stringify(oImportInvoice),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oImportInvoice = jQuery.parseJSON(data);
                    if(oImportInvoice.ErrorMessage==null||oImportInvoice.ErrorMessage=="" )
                    {
                        alert("Data Save Succesfully.");
                        _oImportInvoice=oImportInvoice;
                        var oImportInvoices = sessionStorage.getItem("ImportInvoices");
                        var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                        if (oImportInvoices != null) {
                            oImportInvoices = jQuery.parseJSON(oImportInvoices);
                        }
                        else {
                            oImportInvoices = [];
                        }
                        if (nIndex != -1) {
                            oImportInvoices[nIndex] = _oImportInvoice;
                        }
                        else {
                            sessionStorage.setItem("SelectedRowIndex", oImportInvoices.length);
                            oImportInvoices.push(_oImportInvoice);
                        }
                        sessionStorage.setItem("ImportInvoices", JSON.stringify(oImportInvoices));
                      //  window.location.href = _sBackLink;
                    
                    }
                    else{
                        alert(oImportInvoice.ErrorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });

        }); 




  
    


        function Close()
        {
            window.location.href = _sBackLink;
        }

        $(document).keydown(function(e) {
            if(e.which == 27)//escape=27
            {
                window.location.href = _sBackLink
            }
        });

    </script>