
@model IEnumerable<ESimSol.BusinessObjects.TextileSubUnit>
    <div ng-app="TSUModule" ng-controller="TSUController" class="ms-custom-control">
        <div class="ui-grid-top-panel">
            <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="add()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> New</button>
            <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="delete()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Delete</button>
            <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="inactive()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Active</button>
        </div>
        <div ui-grid="TSUgridOptions" ui-grid-selection ui-grid-resize-columns ui-grid-key-nav class="grid ui-grid-selectable"></div>
  
        <script type="text/ng-template" id="TSU.html">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Textile Sub Unit</h3>
            </div>
            <div class="modal-body form-horizontal regionTSU ms-custom-control" id="modal-body">

                <fieldset>
                    <legend>Textile Sub Unit</legend>
                    <div class="row">
                        <div class="col-md-12 ">
                            <div class="col-md-3 text-right"><label class="control-label">Textile Unit:</label></div>
                            <div class="col-md-4 text-left">
                                <select ng-model="TSU.TSUTextileUnitID" ng-options="obj.id as obj.Value for obj in TextileUnits" ng-disabled="disabled" class="form-control">
                                    <option value="">--Select Textile Unit--</option>
                                </select>
                            </div>
                            <div class="col-md-3 text-right"><label class="control-label">Name:</label></div>
                            <div class="col-md-4 text-left">
                                <input type="text" ng-model="TSU.TSUName" class="form-control" placeholder="Enter Name" required />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 ">
                            <div class="col-md-3 text-right"><label class="control-label">Note:</label></div>
                            <div class="col-md-11 text-left">
                                <input type="text" ng-model="TSU.TSUNote" class="form-control" placeholder="Enter Unit Note" required />
                            </div>
                        </div>
                    </div>
                </fieldset>

                @*<fieldset>
                    <legend>Textile Sub Unit Machine</legend>
                    <div class="row" style="">
                        <div class="col-md-12 text-left form-inline">
                            <div class="input-group">
                                <input type="text" ng-model="MachineName" ng-keyup="searchMachineByKeyUp($event)" class="form-control" placeholder="Enter Machine ID or Name" required />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="searchMachine()" ng-disabled="disabled"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                </span>
                            </div>
                            <input type="text" ng-model="TSUMachine.MachineNote" class="form-control" placeholder="Enter Machine Note" required />
                            <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="addMachine()" ng-hide="hide"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                            <button type="button" class="btn btn-sm btn-danger" aria-label="Left Align" ng-click="deleteMachine()" ng-hide="hide"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                            <button type="button" class="btn btn-sm btn-success" aria-label="Left Align" ng-click="activeMachine()"> <span class="glyphicon glyphicon-ok" aria-hidden="true"></span></button>
                        </div>

                    </div>
                    <div ui-grid="TSUMachinegridOptions" ui-grid-selection ui-grid-resize-columns ui-grid-key-nav class="grid ui-grid-selectable"></div>
                </fieldset>
            </div>*@
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="save()" ng-hide="hide"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save</button>
                <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Close</button>
            </div>
        </script>
      </div>

    <style type="text/css">
        .grid{
            height:530px;
            width:auto
        }
        .modal-body .grid{
            height:200px;
            width:auto
        }
        .form-control {
            height: 26px;
            padding: 0px 6px;
            font-size: 12px;
        }
        .regionTSU .form-horizontal .control-label{
            padding-top:3px;
        }
        .regionTSU .form-control{
            height:26px;
            padding:0px 6px;
            font-size:12px;
        }
        .regionTSU .col-md-12{
            width:100%;
            padding-right:5px;
            padding-left:5px;
            margin-bottom:5px;
        }
        .regionTSU .col-md-11{
            width:76%;
            padding-right:5px;
            padding-left:5px;
        }

        .regionTSU .col-md-2{
            width:13%;
            padding-right:5px;
            padding-left:5px;
        }
        .regionTSU .col-md-3{
            width:20%;
            padding-right:5px;
            padding-left:5px;
        }

        .regionTSU .col-md-4{
            width:28%;
            padding-right:5px;
            padding-left:5px;
        }

        .regionTSU .btn-sm{
            padding:3px 10px;
        }
        .regionTSU .input-group-addon{
            padding: 4px 8px;
        }
    </style>




<script type="text/javascript">
    var  _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    var oTSUs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oTextileUnits =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.TextileUnits));




    var  TSUModule = angular.module('TSUModule', ['ngAnimate','ui.bootstrap','ui.grid','ui.grid.selection','ui.grid.resizeColumns','ms.service']);
    TSUModule.controller('TSUController', function ($scope,$http,$uibModal,$log,uiGridConstants,msModal,userSession) {

        $scope.TextileUnits = oTextileUnits;
        $scope.TextileUnits.removeAt(0);

        $scope.TSUgridOptions ={
            enableRowHeaderSelection: false,
            enableRowSelection: true,
            enableFullRowSelection: true,
            multiSelect: false,
            enableColumnResizing: true,
            noUnselect : true,
            enableHorizontalScrollbar: uiGridConstants.scrollbars.NEVER,
            columnDefs: [
                {name: ' ',width:'3%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false},
                { field: 'TextileUnitStr', name: 'Textile Unit', width:'20%', enableCellEdit: false },
                { field: 'Name', name: 'Name', width:'20%', enableCellEdit: false },
                { field: 'Note', name: 'Note', width:'20%', enableCellEdit: false },
                { field: 'InactiveByName', name: 'Inactive By', width:'20%', enableCellEdit: false },
                { field: 'InactiveDateInString', name: 'Inactive Date', width:'20%', enableCellEdit: false },
            ],
            data:oTSUs,
            onRegisterApi:function(TSUgridApi) {
                $scope.TSUgridApi = TSUgridApi;

            }
        };

        $scope.inactive = function () {

            var data=$scope.TSUgridApi.selection.getSelectedRows().first();
            if(data==null || data.TSUID<=0){
                msModal.Message({headerTitle : '', bodyText:'Select an item from list.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            $scope.index = $scope.TSUgridOptions.data.indexOf(data);
            msModal.Message({headerTitle : '', bodyText:'Are you sure to Active?.', sucessText : ' Ok', cancelText : ' Cancel', feedbackType:true, autoClose : false}).result.then(function(result){
                if(result){
                    $http.post(_sBaseAddress+'/TextileSubUnit/Approve', JSON.stringify(data)).then(
                                 function (response) {
                                     var result=jQuery.parseJSON(response.data);
                                     if(result.TSUID>0)
                                     {
                                         debugger;
                                         $scope.TSUgridOptions.data[ $scope.index]=result;
                                         $scope.TSUgridApi.grid.modifyRows($scope.TSUgridOptions.data);
                                         $scope.TSUgridApi.selection.selectRow(result);
                                     }
                                     else{
                                         alert(result.ErrorMessage);
                                     }
                                 },
                                 function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                           );
                }
            });

        };

        $scope.add = function () {
            $scope.Modal(null, 'add');
        };

        $scope.Modal = function (obj, operation) {
            

            debugger;
            var modalInstance = $uibModal.open({
                //animation: $scope.animationsEnabled,
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                size: 'md',
                templateUrl: 'TSU.html',
                controller: 'ModalInstanceCtrl',
                controllerAs: 'TSUController',
                resolve: {
                    obj: function () {
                        return { TSU:obj, Operation: operation ,TextileUnits : $scope.TextileUnits};
                    }
                }
            });

            modalInstance.result.then(function (result) {

                if(result.TSUID>0){
                    if(operation=='add'){
                        $scope.TSUgridOptions.data.push(result);
                        $scope.TSUgridApi.grid.modifyRows($scope.TSUgridOptions.data);
                        $scope.TSUgridApi.selection.selectRow(result);
                    }
                    else{
                        $scope.TSUgridOptions.data[$scope.index]=result;
                        $scope.TSUgridApi.grid.modifyRows($scope.TSUgridOptions.data);
                        $scope.TSUgridApi.selection.selectRow($scope.TSUgridOptions.data[$scope.index]);
                    }
                }

            }, function () {
                $log.info('Modal dismissed at: ' + new Date());
            });
        };

        $scope.delete = function () {
            debugger;
            var data=$scope.TSUgridApi.selection.getSelectedRows().first();
           
            if(data==null || data.TSUID<=0){
                msModal.Message({headerTitle : '', bodyText:'No item found to delete. Select an item.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            $scope.index = $scope.TSUgridOptions.data.indexOf(data);

            $http.post(_sBaseAddress+'/TextileSubUnit/Delete',JSON.stringify(data)).then(
                            function (response) {
                                if(jQuery.parseJSON(response.data)=='Deleted'){
                                    $scope.TSUgridOptions.data.splice($scope.index,1);
                                    msModal.Message({headerTitle : '', bodyText:'Delete Successfully.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                }
                                else{
                                    msModal.Message({headerTitle : '', bodyText:jQuery.parseJSON(response.data), sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                }
                            },
                            function (response) {alert(jQuery.parseJSON(response.data));}
                        );

        };


    });

    TSUModule.controller('ModalInstanceCtrl', function ($scope, $http, $uibModalInstance,$log,uiGridConstants, msModal, obj) {
        
        
        debugger;
        $scope.TextileUnits = obj.TextileUnits;
        if(obj.TSU!=null){
          
            $scope.TSU = obj.TSU;
            $scope.TextileUnitID=$scope.TSU.TextileUnitID;
            $scope.TSUName=$scope.TSU.TSUName;
            $scope.TSUNote=$scope.TSU.TSUNote;
        }
       
        else{
            $scope.TSU={
                TSUID : 0,
                TextileUnitID : 0,
                TSUName:'',
                TSUNote:'',
                InactiveBy : 0,
                InactiveDate : new Date()
            }
        }
        
        $scope.searchMachineByKeyUp=function(keyEvent){
            if(keyEvent.which==13){
                debugger;
                $scope.getsMachine();
            }
            else if(keyEvent.which==08){
            }
        };

        $scope.searchMachine=function(){
            debugger;
            $scope.getsMachine();
        };
        
        $scope.getsMachine=function(){
            debugger;
            ($scope.MachineName== undefined)? "": $scope.MachineName;
            var obj={ Name:$scope.MachineName }
           // alert($scope.TSUMachine.Name);
          
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/FabricMachine/GetMachineByNameCode',$.param(obj), config).then(
                function (response)
                {
                var results=jQuery.parseJSON(response.data);
                var modalObj={
                size:'md',
                title:'Machine List',
                url:_sBaseAddress+'/Home/Modal',
                modalController:'TSUModalCtrl',
                appController:'TSUController',
                objs:results,
                multiSelect:false,
                columns:[
                    { field: 'Code', name: 'Code' },
                    { field: 'Name', name: 'Name' },
                ]
                }
                var modalInstance=msModal.Instance(modalObj);
                modalInstance.result.then(function (result) {
                                          
                    if(result.FMID>0){
                        $scope.MachineName = result.Name;
                        $scope.FMID=result.FMID;
                    }

                }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });
                },
                    function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                );
        }
                
        $scope.Validation=function(){
            if($scope.TSU.TSUTextileUnitID==undefined || $scope.TSU.TSUTextileUnitID=='' || $scope.TSU.TSUTextileUnitID==0){
                msModal.Message({headerTitle : '', bodyText:'Select Textile Unit.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            else if($scope.TSU.TSUName=="" || $scope.TSU.TSUName==null){
                msModal.Message({headerTitle : '', bodyText:'Enter Name', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            return  true;
        };
       
        $scope.save = function () {
            debugger;
            if(!$scope.Validation())
                return false;
            var obj={ TextileUnit: $scope.TSU.TSUTextileUnitID ,Name:$scope.TSU.TSUName, Note : $scope.TSU.TSUNote }
            
            $http.post(_sBaseAddress+'/TextileSubUnit/Save', JSON.stringify(obj)).then(

                             function (response) {
                                 debugger;
                                 var result=jQuery.parseJSON(response.data);
                                 if(result.TSUID>0)
                                 {
                                     $uibModalInstance.close(result);
                                 }
                                 else{
                                     msModal.Message({headerTitle : '', bodyText:result.ErrorMessage, sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                 }
                             },
                             function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                       );
        };

        $scope.close= function () {
            $uibModalInstance.dismiss('cancel');
        };
    });
</script>
