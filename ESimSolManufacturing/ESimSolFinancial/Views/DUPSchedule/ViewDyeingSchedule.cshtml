
@model IEnumerable <ESimSol.BusinessObjects.DUPSchedule>

<link href="../../Content/CSS/AjaxLoader.css" rel="stylesheet" type="text/css" />
<link href="../../Content/CSS/icon.css" rel="stylesheet" type="text/css" />

@{
    ViewBag.Title = "Production Schedule";
}

    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div id="winPrintTypeSelector" class="easyui-window winClass" title="Print Type" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="width:360px; float: left;">
            <table border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td style="width: 50px; text-align: right">
                        Type:
                    </td>
                    <td style="width:120px">
                        <input type="checkbox" id="chkPortrait" />Portrait
                    </td>
                    <td style="width:120px">
                        <input type="checkbox" id="chkLandScape" />Landscape
                    </td>
                </tr>
                <tr style="height:50px">
                    <td style="width:350px; text-align:right" colspan="3">
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="OkPrintTypeButtonClick()()">Ok</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="ClosePrintType()">Close</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="menuMainCollectionTable" id="divPS" style="width: 100%; height: 560px">
        <div id="cc" class="easyui-layout" style="width: 100%; height: 560px;">
            <div id="divContentCenter" data-options="region:'center'" style="padding: 2px; width: 100%">
                <div style="margin-left: 0px; height: 485px; width: 100%; padding-top: 0px;">
                    <table id="tblDUPScheduleDetail" class="easyui-datagrid" style="height: 480px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" striped="true" autorowheight="false" toolbar="#scheduleDetailtoolbar" data-options="onLoadSuccess: onLoadSuccess">
                        <thead frozen="true">
                            <tr>
                                <th field="MachineName" width="12%" striped="true" align="left">
                                    Machine Name
                                </th>
                                <th field="CheckBox" checkbox="true">
                                </th>
                                <th field="ScheduleNo" width="10%" align="left">
                                    PS No
                                </th>
                            </tr>
                        </thead>
                        <thead>
                            <tr>
                                @*<th field="OrderNo" width="10%" align="left">
                                        Order No
                                    </th>
                                    <th field="ContractorName" width="15%" align="left">
                                        Buyer Name
                                    </th>
                                    <th field="BuyerRef" width="15%" align="left">
                                        Buyer Ref
                                    </th>
                                    <th field="ColorName" width="10%" align="left">
                                        Color Name
                                    </th>
                                    <th align="right" width="10%" data-options="field:'Qty',formatter:formatPrice">
                                        Qty
                                    </th>
                                    <th field="DeliveryDateSt" width="8%" align="left">
                                        Delivery Date
                                    </th>
                                    <th field="ProductName" width="12%" align="left">
                                        Yarn Type
                                    </th>

                                    <th field="PSBatchNo" width="8%" align="center">
                                        Color Batch
                                    </th>*@
                                <th field="PSBatchNoSt" width="10%" align="left">
                                    Batch
                                </th>
                                <th field="StartTimeSt" width="14%" align="left">
                                    Start Date
                                </th>
                                <th field="EndTimeSt" width="14%" align="left">
                                    End Date
                                </th>

                                <th field="LotNo" width="12%" align="left">
                                    Match to
                                </th>
                                <th field="StatusSt" width="8%" align="left">
                                    Status
                                </th>

                            </tr>
                        </thead>
                    </table>

                    <div id="scheduleDetailtoolbar">
                        <button type="button" id="btnAdd" class="btn-primary" onclick="DUPS_Add(0)" style="  font-size:11px; width:80px;" value="Swap"><span class="glyphicon glyphicon-plus info"> Add </span></button>
                        <button type="button" id="btnEdit" class="btn-primary" onclick="DUPS_Edit()" style="  font-size:11px; width:80px;" value="Swap"><span class="glyphicon glyphicon-edit info"> Edit </span></button>
                        <button type="button" id="btnEdit" class="btn-danger" onclick="DUPS_Delete()" style="  font-size:11px; width:80px;" value="Swap"><span class="glyphicon glyphicon-remove info"> Delete </span></button>
                        <button type="button" id="btnSwap" class="btn-warning" style="  font-size:11px; width:80px;" value="Swap"><span class="glyphicon glyphicon-repeat info"> Swap </span></button>
                    </div>
                </div>
                <fieldset>
                    <legend>Action:</legend>
                    <div style="float:right">
                        <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </div>
                </fieldset>
            </div>
        </div>

        <div id="divAjaxLoader" style="width: 500px;">
            <img src="../../Content/Images/Ajaxloader.GIF" class="ajax-loader" />
        </div>
    </div>
    <div id="winDUDUPSchedule" style="width:800px;height:540px" class="easyui-window winstyle" title="Schedule Informations" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="padding-left:0px; padding-right:0px; padding-top:2px;">
            <table id="tblDUPSDetail" class="easyui-datagrid" style="width:100%;height:150px;"
                    data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarPS',onClickRow:onClickRow ">
                <thead>
                    <tr>
                        <th field="OrderNo" width="12%" align="left">
                            Order No
                        </th>

                        <th width="10%" align="right" field="OrderQty" formatter="formatPrice">
                            Order Qty
                        </th>
                        <th data-options="field:'BagCount',align:'right',editor:{type:'numberbox',options:{precision:0}}" width="10%"> <label id="lblBagCount"></label> </th>
                        <th data-options="field:'QtyPerBag',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%"> <label id="lblBagQty"></label> </th>
                        <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="10%">Qty</th>
                        <th field="ContractorName" width="15%" align="left">
                            Buyer Name
                        </th>
                        <th field="ProductName" width="15%" align="left">
                            Product Name
                        </th>
                        <th field="ColorName" width="10%" align="left">
                            Color Name
                        </th>
                        <th field="ColorNo" width="10%" align="left">
                            LD No/Color No
                        </th>
                        <th field="RouteSheetNo" width="10%" align="left">
                            Batch No/Lot No
                        </th>
                    </tr>
                </thead>
            </table>
            <div>
                <div id="toolbarPS">
                    <select id="cboOrderType" style="width:15%" disabled></select> @* onchange="ChangeOrderType()"*@
                    <span class="lblOrderNo"></span>
                    <input id="txtOrderNo" class="reset-text" placeholder="Search by Order No" style="width:20%" />
                    <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                    <a id="btnResetOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                    <a id="btnRefreshDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                    <a id="btnDeleteDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>

                </div>

            </div>
        </div>
        <div>
            <fieldset>
                <legend>Schedule Info:</legend>
                <div>
                    <table cellpadding="1" cellspacing="1" style="font-size: 12px;width: 100%">
                        <tr>
                            <td style="width:8%;text-align:right;"></td>
                            <td style="width:10%;text-align:right;">
                                Schedule No:
                            </td>
                            <td style="padding-left: 2px;width:22%;text-align:left">
                                <input id="txtScheduleNo" type="text" style="width:100%" data-options="showSeconds:false" />
                            </td>
                            <td colspan="2" style="padding-right: 2px;width:50%;text-align:right;">
                                <div style="float: right; width:100%;">

                                    <span>
                                        <input type="button" id="btnScheduleLastTime" value="Default Time" style="font-size: 11px;
                                        height: 23px; width: 80px;" />
                                    </span><span>
                                        <input type="button" id="btnCurrenttime" value="Current Time" style="font-size: 11px;
                                        height: 23px; width: 80px;" />
                                    </span><span>
                                        <input id="tptimeSpinner" class="easyui-timespinner" style="width: 75px; height:20px; font-size: 11px;" required="required"
                                                data-options="showSeconds:false" />
                                    </span>
                                    <span>
                                        <input type="button" id="btnAddSpinnerTime" value="Add" style="font-size: 11px;
                                        height: 23px; width: 30px;" />
                                    </span>
                                </div>
                            </td>
                            <td style="width:10%;text-align:right;"></td>
                        </tr>
                        <tr>
                            <td style="width:8%;text-align:right;"></td>
                            <td style="width:10%;text-align:right;">
                                Start Time:
                            </td>
                            <td style="width:22%;">
                                @*<input id="txtStartDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                <input id="txtStartDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                            </td>

                            <td style="width:20%;text-align:right;">
                                End Time:
                            </td>
                            <td style="padding-left: 2px;width:30%;">
                                @*<input id="txtEndDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                <input id="txtEndDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                            </td>

                            <td style="width:10%;text-align:right;"></td>
                        </tr>

                    </table>

                </div>

            </fieldset>
            <fieldset>
                <legend>Schedule Info:</legend>
                <div>
                    <table style="font-size: 12px;width: 100%">
                        <tr>
                            <td style="width:20%;text-align:right;">
                                Location Name:
                            </td>
                            <td style="width:30%;">
                                <select style="width:100%" id="cboLocationTwo"></select>
                            </td>
                            <td style="padding-left:2px;text-align:right;width:20%;">
                                Machine Name:
                            </td>
                            <td style="width:30%;">
                                <input id="txtMachine" class="reset-text txt-styler-picker" placeholder="Search Machine" />
                                <a id="btnPickMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:20%;text-align:right;">
                                Store Name:
                            </td>
                            <td style="width:30%;">
                                <select style="width:100%" id="cboWorkingUnit" onchange="chngWorkingUnit()"></select>
                            </td>
                            <td style="width:20%;text-align:right;">
                                Remarks:
                            </td>
                            <td colspan="3" style="width:80%;">
                                <input id="txtNote" class="reset-text" style="width:100%;" placeholder="Remarks.." />
                            </td>
                        </tr>
                    </table>
                    <table id="tblDUPSLot" class="easyui-datagrid" style="width:98%;height:120px;"
                           data-options="singleSelect: true,fitColumns:false, rownumbers:true, pagination:false, autoRowHeight:false, toolbar: '#toolbarLot',onClickRow:onClickRow_Lot">
                        <thead>
                            <tr>
                                <th field="LotNo" width="30%" align="left">Lot No</th>
                                <th width="20%" align="right" field="Balance" formatter="formatPrice"> Balance</th>
                                <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="20%">Qty</th>
                            </tr>
                        </thead>
                    </table>
                    <div>
                        <div id="toolbarLot">
                            Lot No:<input id="txtLot" class="reset-text txt-styler-picker" placeholder="Search Lot" />
                            <a id="btnPickLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                            <a id="btnResetLot" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                            <a id="btnRefreshLot" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Refresh</a>
                            <a id="btnDeleteLot" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                        </div>
                    </div>

                </div>
            </fieldset>
        </div>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:60%;text-align:left;">
                        <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
                        <a id="btnSaveRS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;">Dyeing Card</a>
                        @*<a id="btnCut" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cut" plain="true" style=" height:22px;">Cut</a>*@
                        <a id="btnPaste1" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-paste" plain="true" style=" height:22px;">Paste</a>

                    </td>
                    <td style="width:40%;text-align:right;">
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;" onclick="Save(false)">Save</a>
                        <a id="btnClosePS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
    </div>

<script type="text/javascript">

    var _sBaseAddress="";
    var _sCalendarDate='';
    var _oDUPSchedule=null;
    var _oDyeMachines=[];

    var _nfirstLoad=1;
    var nflagWeekValue=0;
    var _nView=0;
    var _nWeek=0;


    var _oDUPSchedules=[];
    var _bToolbarRefresh=false;
    var _bCut=false;
    var _oDUPSCopy=null;
    var _sMachineIDs = "";
    var _oDyeMachines_temp=[];
    var _oDyeMachine={};
    var _oAuthorizationRolesMapping=[];
    var _oWorkingUnits=[];
    var _oMachineTypes=[];
    var _oMCells=[];
    var _oMCellPSs=[];
    $(document).ready(function ()
    {
        //debugger;
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oDUPSchedules =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oDyeMachines=  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.CapitalResources));
        var oLocations=  @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Locations));
        //_oDUPSchedules= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.DUPSchedules));
        _oDUOrderSetups = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.DUOrderSetups));
        var nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.BUID));
        var oLocations=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.Locations));
        _oWorkingUnits=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.WorkingUnits));
        _oMachineTypes=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.MachineTypes));
        _oDyeingOrder=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.DyeingOrder));
        _nDyeingOrderID=_oDyeingOrder.DyeingOrderID;

        _oAuthorizationRolesMapping =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));

        RefreshControlLayout();

        txtCone='Cone';
        txtHank='Bell';
        changeLabel({HankorCone:0});

        sessionStorage.setItem('BUID',nBUID);
        $("#divPS").data("PrintParam","");
        $("#divPS").data("PrintType","");
        $('#tpStartTime,#tpEndTime').timespinner('setValue', "00:00");
        $('#txtStartDate,#txtEndDate').datebox('setValue', icsdateformat(new Date));
        //$('#txtStartDate,#txtEndDate').datebox('setValue',icsdateformat(new Date()));
        $("#cboLocationTwo").icsLoadCombo({ List: oLocations,  OptionValue: "LocationID",  DisplayText: "Name",  });
        $("#cboWorkingUnit").icsLoadCombo({ List: _oWorkingUnits,  OptionValue: "WorkingUnitID",  DisplayText: "OperationUnitName",  });


        if(oLocations.length==1)
        {
            $("#cboLocationTwo").val(oLocations[0].LocationID);
        }
        $("#cboOrderType").icsLoadCombo({ List: _oDUOrderSetups,  OptionValue: "OrderType", DisplayText: "ShortName",});
        $("#cboMachineType").icsLoadCombo({ List: _oMachineTypes,  OptionValue: "MachineTypeID", DisplayText: "Name", InitialValue:'-- All Machine --'});

        $("#cboOrderType").val(_oDyeingOrder.DyeingOrderType);
        $("#divParentCalendar").hide();
        $("#divMachineView").hide();
        var oDate=new Date();
        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        console.log(_oDUPSchedules);
        RefreshMachineWise(_oDUPSchedules);
        $("#divAjaxLoader,#divExeFound").hide();
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    function DetailViewSchedule(nObjectID, sDate, index,sPSID) {

        //  alert("index="+sPSID);
        //if (nObjectID == null || nObjectID <= 0) {
        //    alert("Please select a item from list!");
        //    return;
        //}

        _oDUPSchedule = { ErrorMessage: "", DUPScheduleID: sPSID, MachineID: nObjectID };

        $.ajax({
            type: "POST",
            url: _sBaseAddress + "/DUPSchedule/GetPS",
            traditional: true,
            data: JSON.stringify(_oDUPSchedule),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                _oDUPSchedule = { ErrorMessage: "", DUPScheduleID: 0, MachineID: 0 };
                var oDUPSchedule = jQuery.parseJSON(data);
                if(oDUPSchedule.DUPScheduleDetails!=null )
                {
                    if(oDUPSchedule.DUPScheduleDetails.length>0)
                        changeLabel(oDUPSchedule.DUPScheduleDetails[0]);

                    DynamicRefreshList(oDUPSchedule.DUPScheduleDetails, "tblDUPSDetail");
                    DynamicRefreshList(oDUPSchedule.DUPSLots, "tblDUPSLot");
                }
                else{
                    DynamicRefreshList([], "tblDUPSDetail");
                }
                RefreshControl(oDUPSchedule);
                endEditing();

                debugger;
                if(_oDUPSCopy==null || _oDUPSCopy.DUPScheduleID==undefined || _oDUPSCopy.DUPScheduleID==0)
                    $("#btnPaste1").hide();
                else
                    $("#btnPaste1").show();


                $("#winDUDUPSchedule").icsWindow("open", "Schedule Entry");

            }
        });
    }

    function formatString(val,row)
    {
        return '<center>'+val+'</center>';
    }
    function formatDate(val,row)
    {

        return '<span style="color:blue">'+val+'</span>';
    }

    $('#btnOrderNoReset').click(function(e)
    {
        $("#txtOrderNo")[0].value='';
        document.getElementById('lblExeFound').innerHTML="";
        document.getElementById('divExeFound').style.display='none';
    });
    
    function DUPS_Add()
    {
        sessionStorage.setItem("DUPS_Operation",'ADD');
        DetailViewSchedule(0, "", 0,"")
    }

    function DUPS_Edit()
    {  
        var oDUPScheduleDetails = $('#tblDUPScheduleDetail').datagrid('getChecked');
        if(oDUPScheduleDetails[0]==undefined || oDUPScheduleDetails[0].DUPScheduleID<=0)
        {
            alert("Please select two items.");
            return;
        }
        
        sessionStorage.setItem("DUPS_Operation",'EDIT');
        DetailViewSchedule(0, "", 0, oDUPScheduleDetails[0].DUPScheduleID)
    }


    function setDateTime(startDate)
    {
        var nYear=startDate.getFullYear();
        var nMonth=startDate.getMonth();
        var nDate=startDate.getDate();
        var nHour=startDate.getHours();
        var nMin=startDate.getMinutes();
        //        if(nMonth<10 )
        //        {
        //           nMonth="0"+nMonth;
        //        }
        if(nDate<10)
        {
            nDate="0"+nDate;
        }
        if(nHour<10)
        {
            nHour="0"+nHour;
        }
        if(nMin<10)
        {
            nMin="0"+nMin;
        }

        // var intervalMin=Number(nMin)+14;

        //var sDateTime= nMonth+"/"+nDate+"/"+nYear+" "+nHour+":"+nMin+" - "+nHour+":"+intervalMin;
        //var mthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        //var sDateTime= nDate+"/"+mthNames[Number(nMonth)]+"/"+nYear+" "+nHour+":"+nMin;

        var sDateTime= nHour+":"+nMin;
        return sDateTime;
    }

    function Next()
    {
        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var dateString=document.getElementById("dateHeader").innerHTML;

        var returnValue=dateChange();

        var nDate= new Date(returnValue[0]);
        var cSpace= returnValue[1];
        var sDateView=returnValue[2];


        if( sDateView=="viewAsDateMonth")
        {
            if(Number(cSpace)==1)
            {
                _nfirstLoad=0;
                nDate.setMonth(Number(nDate.getMonth())+1);
                document.getElementById("dateHeader").innerHTML= Month[nDate.getMonth()] +" "+ nDate.getFullYear();
                _oDUPSchedule.sMonth="Month";
                _oDUPSchedule.StartTime= nDate;
                // search();

            }
            else if(Number(cSpace)==2)
            {
                nDate.setDate(Number(nDate.getDate())+1);
                document.getElementById("dateHeader").innerHTML= nDate.getDate()+" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
                _oDUPSchedule.sDay= "Day";
                _oDUPSchedule.StartTime= nDate;
                // search();
            }
        }

        else if(sDateView=="viewAsWeek")
        {
            var tempDate=new Date(returnValue[0]);
            nDate.setDate(nDate.getDate()+7);

            if(nDate.getFullYear()==tempDate.getFullYear())
            {
                document.getElementById("dateHeader").innerHTML= (tempDate.getDate()+1)+" "+ Month[tempDate.getMonth()] +" - "+ nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
            }
            else
            {
                //alert(tempDate.getDate()+1);
                tempDate.setDate(tempDate.getDate()+1);
                document.getElementById("dateHeader").innerHTML= (tempDate.getDate())+" "+ Month[tempDate.getMonth()] +" "+ tempDate.getFullYear()+" "+"-"+" "+ nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
            }

            _oDUPSchedule.sWeek= "Week";
            _oDUPSchedule.StartTime= tempDate;
            //search();
        }




    }

    function Prevoius()
    {
        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var dateString=document.getElementById("dateHeader").innerHTML;

        var returnValue=dateChange();
        var nDate= new Date(returnValue[0]);
        var cSpace= returnValue[1];
        var sDateView=returnValue[2];

        if( sDateView=="viewAsDateMonth")
        {
            if(Number(cSpace)==1)
            {
                _nfirstLoad=0;
                nDate.setMonth(Number(nDate.getMonth())-1);
                document.getElementById("dateHeader").innerHTML= Month[nDate.getMonth()] +" "+ nDate.getFullYear();
                _oDUPSchedule.sMonth="Month";
                _oDUPSchedule.StartTime= nDate;
                // search();

            }
            if(Number(cSpace)==2)
            {
                nDate.setDate(Number(nDate.getDate())-1);
                document.getElementById("dateHeader").innerHTML= nDate.getDate()+" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
                _oDUPSchedule.sDay= "Day";
                _oDUPSchedule.StartTime= nDate;
                //search();
            }
        }
        else if(sDateView=="viewAsWeek")
        {
            var tempDate=new Date(returnValue[0]);

            tempDate.setDate(Number(tempDate.getDate())-13);
            nDate.setDate(Number(nDate.getDate())-7);
            if(nDate.getFullYear()==tempDate.getFullYear())
            {
                document.getElementById("dateHeader").innerHTML= tempDate.getDate()+" "+ Month[tempDate.getMonth()] +" - "+nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
            }
            else
            {
                document.getElementById("dateHeader").innerHTML= tempDate.getDate()+" "+ Month[tempDate.getMonth()] +" "+ tempDate.getFullYear()+" - "+ nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
            }

            _oDUPSchedule.sWeek= "Week";
            _oDUPSchedule.StartTime= tempDate;
            //search();
        }

    }

    function dateChange()
    {

        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var dateString=document.getElementById("dateHeader").innerHTML;
        var flag=0;
        var countSpace=0;
        var tempDate="";
        var sMonth="";
        var temp=0;
        var dateFormat="";
        var sDateView="";
        var sStartDate="";
        for(var i=0; i<dateString.length;i++)
        {
            if(dateString[i]=='-')
            {
                flag=1;
                i=dateString.length;
            }
        }

        if(flag==0)
        {

            for(var i=0; i<dateString.length;i++)
            {
                nflagWeekValue=0;
                if(dateString[i]!=" ")
                {
                    if(isNaN(dateString[i]))
                    {
                        sMonth += dateString[i];
                        if(dateString[Number(i)+1]==" ")
                        {
                            for(var j=0;j<Month.length;j++)
                            {
                                if(Month[j]==sMonth)
                                {
                                    temp=Number(j)+1;
                                    j=Month.length;
                                }
                            }
                        }

                    }

                    else
                    {
                        tempDate +=dateString[i];
                    }

                }
                if(dateString[i] ==" ")
                {
                    countSpace=Number(countSpace)+1;
                    tempDate +="/";
                }

            }

            if(tempDate.length>5)
            {
                dateFormat=temp+"/"+tempDate;
            }
            else
            {
                dateFormat=temp+"/"+"1"+"/"+tempDate;
            }

            sDateView="viewAsDateMonth";

        }

        else if(flag==1)
        {
            nflagWeekValue=1;
            var i=0;
            while(dateString[i]!='-')
            {
                sStartDate=sStartDate+dateString[i];
                i++;
            }
            sStartDate=$.trim(sStartDate.split('-')[0]);
            i++;
            for(var j=i; i<dateString.length;i++)
            {

                if(dateString[i]!=" ")
                {
                    if(isNaN(dateString[i]))
                    {
                        sMonth += dateString[i];
                        if(dateString[Number(i)+1]==" ")
                        {
                            for(var j=0;j<Month.length;j++)
                            {
                                if(Month[j]==sMonth)
                                {
                                    temp=Number(j)+1;
                                    j=Month.length;
                                }
                            }
                        }

                    }

                    else
                    {
                        tempDate +=dateString[i];
                    }

                }
                if(dateString[i] ==" ")
                {
                    countSpace=Number(countSpace)+1;
                    tempDate +="/";
                }

            }

            if(tempDate.length>5)
            {
                dateFormat=temp+"/"+tempDate;
            }
            else
            {
                dateFormat=temp+"/"+"1"+"/"+tempDate;
            }
            if(sStartDate.length<=6)
            {
                var oDate=new Date(dateFormat);
                sStartDate=sStartDate+' '+oDate.getFullYear();
            }
            sStartDate=new Date(sStartDate);
            sDateView="viewAsWeek";

        }


        var newDate=new Date(dateFormat);
        if($.trim(sStartDate)=='')
        {
            sStartDate=newDate;
        }
        return [newDate, countSpace,sDateView,sStartDate];
    }

    function RefreshMachineWise(oDUPScheduleDetails)
    {
        var oMachineNames=[];
        var oPSs=[];
        if(oDUPScheduleDetails!=null && oDUPScheduleDetails.length>0)
        {
            for(var i=0; i<oDUPScheduleDetails.length;i++)
            {
                oMachineNames.push(oDUPScheduleDetails[i].MachineName);
                oPSs.push(oDUPScheduleDetails[i].ScheduleNo);
            }
            _oMCells=GenerateRowSpan(oMachineNames);
            _oMCellPSs=GenerateRowSpan(oPSs);
            $('#tblDUPScheduleDetail').empty();
            DynamicRefreshList(oDUPScheduleDetails, "tblDUPScheduleDetail");
        }

    }
    function MachineView()
    {
        $("#divParentCalendar").hide();
        $("#divSchedule").hide();
        $("#divMachineView").show();

        $('#tblDUPScheduleDetail').datagrid({selectOnCheck:false, checkOnSelect:false});
        var returnValue=dateChange();
        var nDate=new Date(returnValue[0]);
        if(nflagWeekValue==1)
        {
            nDate.setDate(nDate.getDate()-6);
        }

        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        document.getElementById("dateHeader").innerHTML= nDate.getDate()+" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
        _oDUPSchedule.sDay= "Day";
        _oDUPSchedule.sPrintView="viewAsDateMonth";
        _oDUPSchedule.StartTime= nDate;
        _bToolbarRefresh=true;

        $('#btnPrintSC').show();
        _oDUPSchedule.LocationID=0;
        _oDUPSchedule.BUID = sessionStorage.getItem('BUID');
        _oDUPSchedule.MachineName= ($("#cboMachineType").val()==0?"":$("#cboMachineType").val());
        _oDUPSchedule.MachineNo=_sMachineIDs;

        DynamicRefreshList([], 'tblSchedule');
        var sScheduleDateType = "";
        if(_bToolbarRefresh==false)
        {
            sScheduleDateType = $("#cboDateSelection").val()
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/GetsForMachineView",
            traditional: true,
            data:  JSON.stringify({oDUPSchedule: _oDUPSchedule, bUptoLoadDyeMachine:false, sScheduleDateType:3}),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oPS = jQuery.parseJSON(data);
                var oDUPScheduleDetails=oPS.DUPScheduleDetails;

                var oMachineNames=[];
                var oPSs=[];
                if(oDUPScheduleDetails.length>0)
                {
                    for(var i=0; i<oDUPScheduleDetails.length;i++)
                    {
                        oMachineNames.push(oDUPScheduleDetails[i].MachineName);
                        oPSs.push(oDUPScheduleDetails[i].ScheduleNo);

                    }
                    _oMCells=GenerateRowSpan(oMachineNames);
                    _oMCellPSs=GenerateRowSpan(oPSs);
                    $('#tblDUPScheduleDetail').empty();
                    DynamicRefreshList(oDUPScheduleDetails, "tblDUPScheduleDetail");
                }

            },
            error: function (xhr, status, error)
            {
                alert(error);
            }


        });

    }
    function GenerateRowSpan(oDatas)
    {
        var oMCell=null;
        var nIndex=0;
        var nRowSpan=0;
        var oMCells=[];
        for (var i=0; i<oDatas.length;i++)
        {
            nRowSpan=0;
            for(var j=i; j<oDatas.length;j++)
            {
                if(oDatas[i]==oDatas[j]){++nRowSpan;}
            }
            nRowSpan = (nRowSpan >= 0) ? nRowSpan : 0;
            oMCell={
                ParentID : 0,
                Index : nIndex,
                RowSpan : nRowSpan
            };
            oMCells.push(oMCell);
            nIndex = nIndex + nRowSpan;
            i=nIndex-1;
        }
        return oMCells;
    }
    function onLoadSuccess(data)
    {
        debugger;
        for(var i=0; i<_oMCells.length; i++)
        {
            $(this).datagrid('mergeCells',{index: _oMCells[i].Index,field: 'MachineName', rowspan: _oMCells[i].RowSpan});

        }
        for(var i=0; i<_oMCellPSs.length; i++)
        {
            $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'CheckBox', rowspan: _oMCellPSs[i].RowSpan});
            $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'ProductionScheduleNo', rowspan: _oMCellPSs[i].RowSpan});
            $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'StartTimeInString', rowspan: _oMCellPSs[i].RowSpan});
            $(this).datagrid('mergeCells',{index: _oMCellPSs[i].Index,field: 'EndTimeInString', rowspan: _oMCellPSs[i].RowSpan});
        }
    }
    ///Machine view end
    function WeekView()
    {

        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        var returnValue=dateChange();

        var tempDate=new Date(returnValue[0]);
        var nDate=new Date(returnValue[0]);
        //  if(_nWeek==0)
        {
            nDate.setDate(nDate.getDate()+6);
            _nWeek=1;
        }
        //    else
        //    {
        //      //nDate.setDate(nDate.getDate()-6);
        //       tempDate.setDate(tempDate.getDate()-6);
        //    }

        if(nDate.getFullYear()==tempDate.getFullYear())
        {
            document.getElementById("dateHeader").innerHTML= tempDate.getDate()+" "+ Month[tempDate.getMonth()]+" "+"-"+" "+ nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
        }
        else
        {
            document.getElementById("dateHeader").innerHTML= tempDate.getDate()+" "+ Month[tempDate.getMonth()] +" "+ tempDate.getFullYear()+" "+"-"+" "+ nDate.getDate() +" "+ Month[nDate.getMonth()] +" "+ nDate.getFullYear();
        }

        _oDUPSchedule.sWeek= "Week";
        _oDUPSchedule.sPrintView="viewAsWeek";
        _oDUPSchedule.StartTime= tempDate;
        _bToolbarRefresh=true;
        search();

    }

    function ToolbarRefresh()
    {
        $("#divParentCalendar").hide();
        $("#divSchedule").show();
        $("#divMachineView").hide();
        var returnValue=dateChange();
        var nDate= new Date(returnValue[0]);
        var cSpace= returnValue[1];
        var sDateView=returnValue[2];
        if(sDateView=="viewAsDateMonth")
        {
            _oDUPSchedule.StartTime=nDate;
            if(Number(cSpace)==1)
            {
                _oDUPSchedule.sMonth="Month";
            }
            else if(Number(cSpace)==2)
            {
                _oDUPSchedule.sDay= "Day";
                search();
            }
        }
        else if(sDateView=="viewAsWeek")
        {
            _oDUPSchedule.sWeek= "Week";
            _oDUPSchedule.StartTime=new Date(nDate.setDate(nDate.getDate()-6));

        }
        _bToolbarRefresh=true;


    }


    function search()
    {
        $('#btnPrintSC').show();
        _oDUPSchedule.LocationID=0;
        _oDUPSchedule.BUID = sessionStorage.getItem('BUID');
        _oDUPSchedule.MachineName= ($("#cboMachineType").val()==0?"":$("#cboMachineType").val());
        _oDUPSchedule.MachineNo=_sMachineIDs;

        DynamicRefreshList([], 'tblSchedule');
        var sScheduleDateType = "";
        if(_bToolbarRefresh==false)
        {
            sScheduleDateType = $("#cboDateSelection").val()
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/RefreshMachineWise",
            traditional: true,
            data:  JSON.stringify({oDUPSchedule: _oDUPSchedule, bUptoLoadDyeMachine:false, sScheduleDateType:3}),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oPS = jQuery.parseJSON(data);
                _oDUPSchedules=oPS.DUPSchedules;
                _oDyeMachines=oPS.DyeMachines;
                MakeTable(_oDyeMachines);
                GenerateTableData(_oDyeMachines);


            },
            error: function (xhr, status, error)
            {
                alert(error);
            }


        });
    }
    function print()
    {

        var returnValue=dateChange();
        var oEndTime = new Date(returnValue[0]);
        var oStartTime= new Date(returnValue[3]);
        var Month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var sStartTime= oStartTime.getDate() +" "+Month[oStartTime.getMonth()]+" "+ oStartTime.getFullYear()+" "+0+":"+0;
        var sEndTime= oEndTime.getDate() +" "+Month[oEndTime.getMonth()]+" "+ oEndTime.getFullYear()+" "+0+":"+0;
        var cSpace= 0;
        var sPrintView= "";
        var MachineIDs="";
        var DUPScheduleIDs="";
        var nLocationID=3;
        var bPortrait=false;
        var bValue=false;
        var psof=document.getElementById("dateHeader").innerHTML;
        var newstring=cSpace+'~'+sStartTime+'~'+sEndTime+'~'+nLocationID+'~'+MachineIDs+'~'+psof+'~'+sPrintView+'~'+DUPScheduleIDs+'~'+bValue+'~'+sessionStorage.getItem('BUID')+'~'+$('#cboMachineType').val()+"~"+_sMachineIDs;
        window.open(_sBaseAddress + '/DUPSchedule/PrintDUPSchedule?newstring='+newstring+'&bPortrait='+bPortrait, '_blank'); // Print in Portrait

    }

    $('#chkPortrait').change(function(e)
    {
        $("#divPS").data("PrintType","");
        if(document.getElementById('chkPortrait').checked==true)
        {
            document.getElementById('chkLandScape').checked=false;
            $("#divPS").data("PrintType","Portrait");
        }
        else
        {
            document.getElementById('chkPortrait').checked=false;
            document.getElementById('chkLandScape').checked=true;
            $("#divPS").data("PrintType","Landscape");
        }
    });
    $('#chkLandScape').change(function(e)
    {
        $("#divPS").data("PrintType","");
        if(document.getElementById('chkLandScape').checked==true)
        {
            document.getElementById('chkPortrait').checked=false;
            $("#divPS").data("PrintType","Landscape");
        }
        else
        {
            document.getElementById('chkLandScape').checked=false;
            document.getElementById('chkPortrait').checked=true;
            $("#divPS").data("PrintType","Portrait");
        }
    });
    function ClosePrintType()
    {
        $("#divPS").data("PrintType","");
        $("#divPS").data("PrintParam","");
        $("#winPrintTypeSelector").icsWindow('close');
    }
    function OkPrintTypeButtonClick()
    {
        if($("#divPS").data("PrintType")=="" || $("#divPS").data("PrintParam")=="")
        {
            alert("Select Page Type.");
            return;
        }
        $("#winPrintTypeSelector").icsWindow('close');
        var bPortrait = false;
        if($("#divPS").data("PrintType")=='Landscape'){ bPortrait=false;}else{ bPortrait=true;}
        window.open(_sBaseAddress + '/DUPSchedule/PrintDUPSchedule?newstring='+$("#divPS").data("PrintParam")+'&bPortrait='+bPortrait, '_blank'); // Print in Portrait
    }

    //////////////
    $("#btnPickOrderNo").click(function () {

        var oList=  $('#tblDUPSDetail').datagrid('getRows');

        console.log(oList);
        var nDetailID=0;
        if(oList.length>0)
        {
            nDetailID=oList[0].LabDipDetailID;

            if(nDetailID<=0)
            {
                alert("No Lab Dip Color Found!");return;
            }

        }else  if (parseInt($("#cboOrderType").val())<=0 )
        {

            alert("Please Select Order Type.");
            $('#cboOrderType').focus();
            $('#cboOrderType').addClass("errorFieldBorder");
            return;
        }
        else{
            $('#cboOrderType').removeClass("errorFieldBorder");
        }

        var oPSDetail = {
            OrderType:$('#cboOrderType').val(),
            OrderNo:$('#txtOrderNo').val(),
            LabDipDetailID:nDetailID,
            DyeingOrderID:_nDyeingOrderID
        };

        GetOrders(oPSDetail);
    });
    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNo").val());

            var oList=  $('#tblDUPSDetail').datagrid('getRows');
            debugger;
            var nDetailID=0;
            if(oList.length>0)
            {
                nDetailID=oList[0].LabDipDetailID;

                if(nDetailID<=0)
                {
                    alert("No Lab Dip Color Found!");return;
                }

            }else if (parseInt($("#cboOrderType").val())<=0 ) {

                alert("Please Select Order Type.");
                $('#cboOrderType').focus();
                $('#cboOrderType').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#cboOrderType').removeClass("errorFieldBorder");
            }

            var oPSDetail = {
                OrderType:$('#cboOrderType').val(),
                OrderNo:$('#txtOrderNo').val(),
                LabDipDetailID:nDetailID,
                DyeingOrderID:_nDyeingOrderID
            };
            GetOrders(oPSDetail);
        }
        else if(nkeyCode==8){

        }
    });
    $("#btnResetOrderNo").click(function ()
    {
        $("#txtOrderNo").val("");
    });
    function GetOrders(oPSDetail){

        //var oRSDOs = $('#tblDUPSDetail').datagrid('getRows');
        //if(oRSDOs.length>0)
        //{
        //    alert("Multiple Item Can Not Be Picked!!"); return;
        //}

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "DUPSchedule",
            ActionName: "GetsDyeingOrder",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].DODID > 0) {
                    debugger;
                    var tblColums = [];

                    var oColumn = { field: "OrderNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderQty", title: "Order Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty_PSD", title: "Schedule Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "Qty", title: "Balance", width: 75, align: "right" };tblColums.push(oColumn);
                    oColumn = { field: "Qty_Pro", title: "Batch Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Yarn Type", width: 225, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorName", title: "ColorName", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ShadeSt", title: "Shade", width: 40, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ColorNo", title: "ColorNo", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LabdipNo", title: "LabdipNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "OrderTypeSt", title: "OrderType", width: 100, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 1000,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }

    $("#btnResetMachine").click(function () {

        $("#txtMachine").val("");
        _oDUPSchedule.MachineID=0;
    });
    $("#btnPickMachine").click(function () {

        var sMachineName=$.trim($("#txtMachine").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachines(sMachineName);
    });
    $("#txtMachine").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachine").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachines(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachine").val("");
            _oDUPSchedule.MachineID=0;
        }
    });

    
    function chngWorkingUnit()
    {
        debugger;
        var oLots=$('#tblDUPSLot').datagrid('getRows');
        if(_oDUPSchedule.DUPScheduleID>0 && oLots.length>0)
        {
            $('#cboWorkingUnit').val(_oDUPSchedule.WorkingUnitID);
        }
    }
    var editIndex_lot = undefined;
    var _nQty=undefined;
    function endEditing_Lot() {
        if (editIndex_lot == undefined) { return true }
        if ($('#tblDUPSLot').datagrid('validateRow', editIndex_lot)) {
            $('#tblDUPSLot').datagrid('endEdit', editIndex_lot);
            $('#tblDUPSLot').datagrid('selectRow', editIndex_lot);
            var oDUPSDetail = $('#tblDUPSLot').datagrid('getSelected');

            debugger;
            if(oDUPSDetail.Qty<=0)
            {
                alert("Lot Qty Should Be Greater Than Zero!"); editIndex_lot = undefined; return;
            }

            if(_nQty!=oDUPSDetail.Qty)
                SaveDUPSLot(oDUPSDetail,"EDIT");
    
            $('#tblDUPSLot').datagrid('updateRow', { index: editIndex_lot, row: oDUPSDetail });
            editIndex_lot = undefined;
            return true;
        }
        else {
            return false;
        }
    }
    function onClickRow_Lot(index) {

        if (editIndex_lot != index) {
            if (endEditing_Lot()) {
                $('#tblDUPSLot').datagrid('selectRow', index).datagrid('beginEdit', index);
                $('#tblDUPSLot').datagrid('selectRow', index);
                var oDUPSDetail = $('#tblDUPSLot').datagrid('getSelected');
                _nQty=(oDUPSDetail==undefined? 0: parseFloat(oDUPSDetail.Qty));
                editIndex_lot = index;
            }
            else {
                $('#tblDUPSLot').datagrid('selectRow', editIndex_lot);
            }
        }
    }
    /*---LOT ENTRY (Multiple)*/
    function SaveProductionSchedule(oDUPSchedule,isDUPSLot)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/Save",
            traditional: true,
            data:  JSON.stringify(oDUPSchedule),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oDUPS = jQuery.parseJSON(data);
                if (oDUPS.ErrorMessage=="")
                {
                    _oDUPSchedule=oDUPS;
                    alert("Data Saved successfully");
                    var oDUPSchedule= $('#tblSchedule').datagrid('getSelected');
                    if (oDUPSchedule ==null || oDUPSchedule.DUPScheduleID <=0 ) { alert("Please select an item from list."); return ; }
                    var SelectedRowIndex=$('#tblSchedule').datagrid('getRowIndex',oDUPSchedule);
                    oDUPSchedule["MachineID"+oDUPS.MachineID] = oDUPS.MachineID+"~"+""+"~"+oDUPS.OrderInfo+"~"+oDUPS.DUPScheduleID;
                    $('#tblSchedule').datagrid('updateRow', { index: SelectedRowIndex, row: oDUPSchedule });
                   
                    if(isDUPSLot)
                    {
                        var oDUPS= JSON.parse(sessionStorage.getItem('DUPSLot'));
                        Save_DUPSLot(oDUPS,'ADD')
                    }else
                    {
                        endEditing_Lot();
                        $("#winDUDUPSchedule").icsWindow("close");
                    }
                }
                else {
                    alert(oDUPS.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }


        });
    }
    function SaveDUPSLot(oDUPSLot,sOpt)
    {
        var nDUPScheduleID=(_oDUPSchedule!=null && _oDUPSchedule.DUPScheduleID>0)? _oDUPSchedule.DUPScheduleID:0;
        if(nDUPScheduleID<=0)
        {
            sessionStorage.setItem('DUPSLot', JSON.stringify(oDUPSLot));
            Save(true); return false;
        }else
        {
            Save_DUPSLot(oDUPSLot,sOpt);
        }
    }
    function Save_DUPSLot(oDUPSLot,sOpt)
    {
        var nDUPScheduleID=(_oDUPSchedule!=null && _oDUPSchedule.DUPScheduleID>0)? _oDUPSchedule.DUPScheduleID:0;
        if(nDUPScheduleID<=0)
        {
            alert("Please save Production Schedule & try again!"); return false;
        }

        oDUPSLot.DUPScheduleID=nDUPScheduleID;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/Save_Lot",
            traditional: true,
            data:  JSON.stringify(oDUPSLot),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                var oDUPS = jQuery.parseJSON(data);
                if (oDUPS.ErrorMessage=="" || oDUPS.ErrorMessage==null)
                {
                    if(sOpt!='EDIT')
                    {
                        alert("Lot Added successfully");
                        $('#tblDUPSLot').datagrid('appendRow',oDUPS);
                    }
                    //if (oDUPSchedule ==null || oDUPSchedule.DUPScheduleID <=0 ) { alert("Please select an item from list."); return ; }
                    //var SelectedRowIndex=$('#tblSchedule').datagrid('getRowIndex',oDUPSchedule);
                    //oDUPSchedule["MachineID"+oDUPS.MachineID] = oDUPS.MachineID+"~"+""+"~"+oDUPS.OrderInfo+"~"+oDUPS.DUPScheduleID;
                    //$('#tblSchedule').datagrid('updateRow', { index: SelectedRowIndex, row: oDUPSchedule });
                    //$("#winDUDUPSchedule").icsWindow("close");
                }
                else {
                    alert(oDUPS.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }


        });
    }
    $("#btnDeleteLot").click(function () {

        var oDUPScheduleDetail = $("#tblDUPSLot").datagrid("getSelected");
        if (oDUPScheduleDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblDUPSLot').datagrid('getRowIndex',oDUPScheduleDetail);
        if (!confirm("Confirm to Delete?")) return false;

        endEditing_Lot();
        if(oDUPScheduleDetail.DUPSLotID<=0)
        {
            $("#tblDUPSLot").datagrid("deleteRow", nIndex);
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oDUPScheduleDetail,
                         ControllerName: "DUPSchedule",
                         ActionName: "Delete_Lot",
                         TableId: "tblDUPSLot",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
        }
        //RefreshSummary();
        editIndex = undefined;
    });
    
    ///Pick Lots
    $("#btnPickLot").click(function () {

        var sLotName=$.trim($("#txtLot").val());
        //if(sLotName==""){ alert("Type Lot name to search."); return false; }
        GetLots(sLotName);
    });
    $("#txtLot").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sLotName=$.trim($("#txtLot").val());
            //if(sLotName==""){ alert("Type Lot name to search."); return false; }
            GetLots(sLotName);
        }
        else if(nkeyCode==8){
            $("#txtLot").val("");
            _oDUPSchedule.LotID=0;
        }
    });
    function GetLots(sLotName){

        var nWorkingUnitID= $("#cboWorkingUnit").val();
        if(nWorkingUnitID<=0)
        {
            alert("Please select a store!"); return;
        }

        var sParam="NotInHouse";
        var oRSDOs = $('#tblDUPSDetail').datagrid('getRows');
        if(oRSDOs!=null && oRSDOs.length>0)
        {
            if(oRSDOs[0].IsInHouse) sParam="IsInHouse"; console.log(oRSDOs);
        }else
        {
            alert("Please add items and try again."); return;
        }

        var oLot = {
            BUID:sessionStorage.getItem('BUID'),
            WorkingUnitID:nWorkingUnitID,
            LotNo:sLotName,
            ContractorID:oRSDOs[0].ContractorID,
            ModelReferenceID:oRSDOs[0].DODID,
            Params:sParam//"NotInHouse"
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oLot,
            ControllerName: "DUPSchedule",
            ActionName: "GetsLot",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "LotNo", title: "LotNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Balance", title: "Balance", width: 90, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winLotPicker',
                        winclass:'clsLotPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblLotPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Lot found.");
            }
        });


    }

    function GetMachines(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem('BUID'),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "DUPSchedule",
            ActionName: "GetsMachine",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].MachineID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Capacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);


                    var oPickerParam = {
                        winid: 'winMachinePicker',
                        winclass:'clsMachinePicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });


    }
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid == 'winLabDipPicker')
        {
            if (oreturnObj != null && oreturnObj.LabDipDetailID > 0)
            {
                $('#txtColorNo').val(oreturnObj.ColorNo);
                //$('#txtColorName').val(oreturnObj.ColorName);
                $('#txtLabdipNo').val(oreturnObj.LabdipNo);
                _nLabDipDetailID= oreturnObj.LabDipDetailID;
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winMachinePicker')
        {
            if(oreturnObj !=null  && oreturnObj.MachineID>0){

                $('#txtMachine').val(oreturnObj.Name);
                _oDUPSchedule.MachineID= oreturnObj.MachineID;
                _oDUPSchedule.LocationID=oreturnObj.LocationID;
            }
            else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winLotPicker')
        {
            if(oreturnObj !=null  && oreturnObj.LotID>0){

                $('#txtLot').val("");
                _oDUPSchedule.LotID= oreturnObj.LotID;
                SaveDUPSLot(oreturnObj,"ADD");
            }
            else{
                alert("Please select Lot.");
            }
        }
        else if (oPickerobj.winid == 'winOrderPicker')
        {
            debugger;
            if(oreturnObj !=null  && oreturnObj.DODID>0)
            {
                bExists= IsExist(oreturnObj.DODID)
                if(bExists)
                {
                    alert("This Order already exists.")
                    return;
                }
                changeLabel(oreturnObj); console.log(oreturnObj);
                $('#tblDUPSDetail').datagrid('appendRow',oreturnObj);
            }
                //if (oreturnobjs != null && oreturnobjs.length > 0)
                //{

                //    for (i=0; i<oreturnobjs.length;i++)
                //    {
                //        var bExists= IsExist(oreturnobjs[i].LabDipDetailID)
                //        if(bExists)
                //        {
                //            alert("Color must be same")
                //            return;
                //        }
                //        //bExists= IsExist_DOD(oreturnobjs[i].LabDipDetailID)
                //        //if(bExists)
                //        //{
                //        //    alert("This Order already exists.")
                //        //    return;
                //        //}
                //        $('#tblDUPSDetail').datagrid('appendRow',oreturnobjs[i]);
                //    }
                //}
            else{
                alert("Data Not Found.");
                return;
            }
        }
    }

    function changeLabel(obj)
    {
        var nCount="Cone";
        nCount=obj.HankorConeST;
        $('#lblBagCount').text(nCount);
        $('#lblBagQty').text('Qty/'+nCount);
    }
    $("#btnRefreshRSDO").click(function () {

        endEditing();
    });
    function IsExist(nDyeingOrderDetailID)
    {
        var oRSDOs = $('#tblDUPSDetail').datagrid('getRows');
        for (var i = 0; i < oRSDOs.length; i++)
        {
            if (parseInt(oRSDOs[i].DODID) == parseInt(nDyeingOrderDetailID))
            {
                return true;
            }
        }

        return false;
    }
    function IsExist_DOD(nDyeingOrderDetailID)
    {
        var oRSDOs = $('#tblRouteSheetDO').datagrid('getRows');
        for (var i = 0; i < oRSDOs.length; i++) {
            if (parseInt(oRSDOs[i].DyeingOrderDetailID) == parseInt(nDyeingOrderDetailID))
            {
                return true;
            }
        }

        return false;
    }

    function RefreshControl(oDUPSchedule)
    {
        _oDUPSchedule=oDUPSchedule;
        $('#tpStartTime').timespinner('setValue', oDUPSchedule.StartTimeTS);
        $('#txtStartDate').datebox('setValue', oDUPSchedule.StartDateSt);

        $('#tpEndTime').timespinner('setValue', oDUPSchedule.EndTimeTS);
        $('#txtEndDate').datebox('setValue', oDUPSchedule.EndDateSt);

        $("#txtScheduleNo").val(oDUPSchedule.ScheduleNo);
        $("#txtMachine").val(oDUPSchedule.MachineNoWithCapacity);
        $("#cboLocationTwo").val(oDUPSchedule.LocationID);
        $("#cboWorkingUnit").val(oDUPSchedule.WorkingUnitID);
        $("#txtLot").val(oDUPSchedule.LotNo);
        $("#txtNote").val(oDUPSchedule.Note);
    }

    _nBagCount=0;
    _nQtyPerBag=0;
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblDUPSDetail').datagrid('validateRow', editIndex)) {
            $('#tblDUPSDetail').datagrid('endEdit', editIndex);
            $('#tblDUPSDetail').datagrid('selectRow', editIndex);
            var oDUPSDetail = $('#tblDUPSDetail').datagrid('getSelected');

            debugger;

            if(_nBagCount!=parseFloat(oDUPSDetail.BagCount) || _nQtyPerBag!=parseFloat(oDUPSDetail.QtyPerBag))
            {
                if(parseFloat(oDUPSDetail.BagCount)>0 && parseFloat(oDUPSDetail.QtyPerBag)>0)
                {
                    oDUPSDetail.Qty= oDUPSDetail.BagCount*oDUPSDetail.QtyPerBag;
                }
                _nBagCount=parseFloat(oDUPSDetail.BagCount);
                _nQtyPerBag=parseFloat(oDUPSDetail.QtyPerBag);
            }


            $('#tblDUPSDetail').datagrid('updateRow', { index: editIndex, row: oDUPSDetail });

            //RefreshSummary();
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblDUPSDetail').datagrid('selectRow', index).datagrid('beginEdit', index);


                var oDUPSDetail= $('#tblDUPSDetail').datagrid('getSelected');
                _nBagCount=parseFloat(oDUPSDetail.BagCount);
                _nQtyPerBag=parseFloat(oDUPSDetail.QtyPerBag);


                editIndex = index;
            }
            else {
                $('#tblDUPSDetail').datagrid('selectRow', editIndex);
            }
        }
    }
    $("#btnClosePS").click(function () {
        $("#winDUDUPSchedule").icsWindow("close");

    });
    $('#btnCurrenttime').click(function(e)
    {
        var oDate=new Date();
        oDate.setMinutes(oDate.getMinutes()+5);
        SetStartTime(oDate);
        AddTime(oDate);
    });

    $("#btnClose").click(function () {
        window.location.href= sessionStorage.getItem("BackLink");
    });

    function SetLastScheduleTime()
    {

        if(parseInt(_oDUPSchedule.MachineID)>0 && parseInt(_oDUPSchedule.LocationID)>0)
        {
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: _sBaseAddress + "/DUPSchedule/GetPSByMachine",
                data: { nMachineID: _oDUPSchedule.MachineID ,  nLocationID: _oDUPSchedule.LocationID , nts:nts },
                contentType: "application/json; charset=utf-8",
                success: function(data)
                {
                    //debugger;
                    var sStratTime = jQuery.parseJSON(data);
                    if ($.trim(sStratTime)!='')
                    {
                        SetStartTime(new Date(sStratTime));
                        AddTime(new Date(sStratTime));
                    }
                    else
                    {
                        var oDate=new Date();
                        oDate.setMinutes(oDate.getMinutes()+5);
                        SetStartTime(oDate);
                        AddTime(oDate);
                    }
                },
                error: function(xhr, status, error)
                {
                    alert(error);
                }
            });
        }

    }

    $('#btnScheduleLastTime').click(function(e)
    {
        if(parseInt($("#cboLocationTwo").val())<=0)
        {
            alert("Please Select Location.");
            $("#cboLocationTwo").focus();
            $('#cboLocationTwo').addClass("errorFieldBorder");
            return;
        }
        else{
            $('#cboLocationTwo').removeClass("errorFieldBorder");
        }
        _oDUPSchedule.LocationID=parseInt($("#cboLocationTwo").val());
        SetLastScheduleTime();
    });
    function SetStartTime(oDate)
    {

        debugger;

        $('#txtStartDate').datebox('setValue', icsdateformat(oDate));

    }

    function AddTime(sDate)
    {
        debugger;
        //var startTime= $('#tpStartTime').timespinner('getValue');
        //var sTime=startTime.split(':');
        //var hStartTime= parseFloat(sTime[0]);
        //var mStartTime= parseFloat(sTime[1]);

        var nhr=$('#tpStartTime').timespinner('getHours');
        var nmin=$('#tpStartTime').timespinner('getMinutes');
        if(isNaN(nhr))
        {
            nhr=0;
        }
        if(isNaN(nmin))
        {
            nmin=0;
        }
        var oDate=new Date(sDate);
        oDate.setHours(oDate.getHours()+nhr);
        oDate.setMinutes(oDate.getMinutes()+nmin);
        $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
        {
            nHour=0;
        }
        if(isNaN(nMin))
        {
            nMin=0;
        }
        $('#tpEndTime').timespinner('setValue', nHour+":"+nMin);

    }
    function ValidationOfStartTime()
    {
        if(new Date($('#txtStartDate').datebox('getValue'))> new Date($('#txtEndDate').datebox('getValue'))){
            alert("Start time must be later than End time.");
            return false;
        }
        return true;
    }

    $('#btnAddSpinnerTime').click(function(e)
    {
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var nhr=$('#tptimeSpinner').timespinner('getHours');
        var nmin=$('#tptimeSpinner').timespinner('getMinutes');
        if(isNaN(nhr))
        {
            nhr=0;
        }
        if(isNaN(nmin))
        {
            nmin=0;
        }
        var oDate=new Date(dStartDate);
        oDate.setHours(oDate.getHours()+nhr);
        oDate.setMinutes(oDate.getMinutes()+nmin);
        AddTime(oDate);
        if(!ValidationOfStartTime())return;
    });

    ///
    function RefreshObject()
    {
        debugger;
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var dEndtDate =$('#txtEndDate').datebox('getValue');
        var EndtTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndtTime.split(':');
        var hEndtTime= parseFloat(sTime[0]);
        var mEndtTime= parseFloat(sTime[1]);
        dEndtDate = new Date(dEndtDate);
        dEndtDate.setHours(hEndtTime);
        dEndtDate.setMinutes(mEndtTime);


        var oScheduleDetail=$('#tblDUPSDetail').datagrid('getRows');

        var oDUPSchedule = {
            DUPScheduleID          : (_oDUPSchedule!=null && _oDUPSchedule.DUPScheduleID>0)? _oDUPSchedule.DUPScheduleID:0,
            MachineID              : _oDUPSchedule.MachineID,
            LotID                  : _oDUPSchedule.LotID,
            BatchNo                : _oDUPSchedule.BatchNo,
            LocationID             : $("#cboLocationTwo").val(),
            BUID                   :sessionStorage.getItem('BUID'),
            Qty                    : 0,
            ScheduleType           : _oDUPSchedule.ScheduleType,
            StartTime	           : dStartDate,
            EndTime                : dEndtDate,
            Note                   :  $("#txtNote").val(),
            DUPScheduleDetails     : oScheduleDetail
        };
        return oDUPSchedule;
    }
    function Save(isDUPSLot)
    {
        //debugger;
        endEditing();

        if(!ValidationOfStartTime())return;
        if(_oDUPSchedule.MachineID==null || _oDUPSchedule.MachineID<=0)
        {
            alert("Please, first select a MachineID.");
            return;
        }
        //var ntotalQuantity = (oScheduleDetail.BatchNo * oScheduleDetail.ProductionQty);
        //if( ntotalQuantity<1)
        //{
        //    alert("Number of yet to schedule must greater than zero.");
        //    return;
        //}
        var oDUPSchedule=RefreshObject();
        var nts=(new Date()).getTime()/1000;

        $('#btnSave').hide();

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/DUPSchedule/ScheduleInTimePeriod",
            data: JSON.stringify({oDUPSchedule:oDUPSchedule, nts: nts}),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            {
                //debugger;
                var nCount = jQuery.parseJSON(data);
                if (nCount>0)
                {
                    if(confirm("Are you sure to increase time from next all schedules."))
                    {
                        oDUPSchedule.IsIncreaseTime=true;
                        SaveProductionSchedule(oDUPSchedule, isDUPSLot);
                    }
                }
                else if(nCount==0)
                {
                    oDUPSchedule.IsIncreaseTime=false;
                    SaveProductionSchedule(oDUPSchedule, isDUPSLot);
                }

                //$("#winDUDUPSchedule").icsWindow("close");
                $('#btnSave').show();
            },
            error: function(xhr, status, error)
            {
                alert(error);
                $('#btnSave').show();
            }
        });
    }

    $('#btnSaveRS').click(function(e){


        if(!ValidationOfStartTime())return;
        if(_oDUPSchedule.MachineID==null || _oDUPSchedule.MachineID<=0)
        {
            alert("Please, first select a MachineID.");
            return;
        }
        var oDUPSchedule=RefreshObject();

        if(oDUPSchedule.DUPScheduleID==null || oDUPSchedule.DUPScheduleID<=0)
        {
            alert("Please, first select valid Schedul.");
            return;
        }
        if (!confirm("Confirm to Create Dyeing Card?")) return;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/SaveRS",
            traditional: true,
            data:  JSON.stringify(oDUPSchedule),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oDUPS = jQuery.parseJSON(data);
                if(oDUPS.ErrorMessage==""|| oDUPS.ErrorMessage==null)
                {
                    alert("Dyeing Card create successfully");
                    var oDUPSchedule= $('#tblSchedule').datagrid('getSelected');
                    if (oDUPSchedule ==null || oDUPSchedule.DUPScheduleID <=0 ) { alert("Please select an item from list."); return ; }
                    var SelectedRowIndex=$('#tblSchedule').datagrid('getRowIndex',oDUPSchedule);
                    //oDUPSchedule["MachineID"+_oDUPSchedule.MachineID] =_oDUPSchedule.MachineID+"~"+""+"~"+""+"~";
                    $('#tblSchedule').datagrid('updateRow', { index: SelectedRowIndex, row: oDUPSchedule });
                }
                else{alert(oDUPS.ErrorMessage)}

            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });

    });

    $('#btnRefreshDetail').click(function(e){
        endEditing();
    });

    function SaveProductionScheduleOFF(oDUPSchedule)
    {
        //$.ajax({
        //    type: "POST",
        //    dataType: "json",
        //    url : _sBaseAddress+  "/DUPSchedule/Save",
        //    traditional: true,
        //    data:  JSON.stringify(oDUPSchedule),
        //    contentType: "application/json; charset=utf-8",
        //    success: function (data) {
        //        //debugger;
        //        var oDUPS = jQuery.parseJSON(data);
        //        if (oDUPS.ErrorMessage=="")
        //        {
        //            _oDUPSchedule=oDUPS;
        //            alert("Data Saved successfully");

        //            if(sessionStorage.getItem("DUPS_Operation")=='ADD')
        //            {
        //                var oDUPSchedules= $('#tblDUPScheduleDetail').datagrid('getRows');
        //                oDUPSchedules.push(oDUPS);
                        
        //                DynamicRefreshList(oDUPSchedules, "tblDUPScheduleDetail");
        //                $('#tblDUPSDetail').datagrid('selectRow', oDUPSchedules.length-1);
        //            }else
        //            {
        //                var oDUPSchedule= $('#tblDUPScheduleDetail').datagrid('getSelected');
        //                var SelectedRowIndex=$('#tblDUPScheduleDetail').datagrid('getRowIndex',oDUPSchedule);
        //                //oDUPSchedule["MachineID"+oDUPS.MachineID] = oDUPS.MachineID+"~"+""+"~"+oDUPS.OrderInfo+"~"+oDUPS.DUPScheduleID;
        //                $('#tblDUPScheduleDetail').datagrid('updateRow', { index: SelectedRowIndex, row: oDUPSchedule });
        //            }

        //            $("#winDUDUPSchedule").icsWindow("close");

        //        }
        //        else {
        //            alert(oDUPS.ErrorMessage);
        //        }
        //    },
        //    error: function (xhr, status, error) {
        //        alert(error);
        //    }


        //});
    }
    $('#btnDelete').click(function(e){
        DUPS_Delete();
    });

    function DUPS_Delete(){
        var oDUPSchedule= $('#tblDUPScheduleDetail').datagrid('getSelected');
        if (oDUPSchedule ==null || oDUPSchedule.DUPScheduleID <=0 ) { alert("Please select an item from list."); return ; }
        var SelectedRowIndex=$('#tblDUPScheduleDetail').datagrid('getRowIndex',oDUPSchedule);

        if(oDUPSchedule.DUPScheduleID==null || oDUPSchedule.DUPScheduleID<=0)
        {
            alert("Please, first select valid Schedul.");
            return;
        }
        if (!confirm("Confirm to delete?")) return;

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/DUPSchedule/Delete",
            traditional: true,
            data:  JSON.stringify(oDUPSchedule),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oDUPSchedule = jQuery.parseJSON(data);
                if(oDUPSchedule.ErrorMessage=="Deleted")
                {
                    $("#winDUDUPSchedule").icsWindow("close");

                    var oDUPSchedule= $('#tblDUPScheduleDetail').datagrid('getSelected');
                    if (oDUPSchedule ==null || oDUPSchedule.DUPScheduleID <=0 ) { alert("Please select an item from list."); return ; }
                    var SelectedRowIndex=$('#tblDUPScheduleDetail').datagrid('getRowIndex',oDUPSchedule);
                    $('#tblDUPScheduleDetail').datagrid('deleteRow', SelectedRowIndex);
                }
                else{alert(oDUPSchedule.ErrorMessage)}

            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });

    }

    $("#btnDeleteDetail").click(function () {

        var oDUPScheduleDetail = $("#tblDUPSDetail").datagrid("getSelected");
        if (oDUPScheduleDetail == null) { alert("Please select an item from list!"); return false; }
        var nIndex=$('#tblDUPSDetail').datagrid('getRowIndex',oDUPScheduleDetail);
        if (!confirm("Confirm to Delete?")) return false;

        if(oDUPScheduleDetail.DUPScheduleDetailID<=0)
        {
            $("#tblDUPSDetail").datagrid("deleteRow", nIndex);
        }
        else
        {
            var obj =
                     {
                         BaseAddress: _sBaseAddress,
                         Object: oDUPScheduleDetail,
                         ControllerName: "DUPSchedule",
                         ActionName: "DeleteDetail",
                         TableId: "tblDUPSDetail",
                         IsWinClose: false
                     };
            $.icsDelete(obj);
        }
        //RefreshSummary();
        editIndex = undefined;
    });

    $("#btnRefresh").click(function () {
        debugger;
        var sDate = $('#txtDateScheduleCalendar').datebox('getValue');
        if (sDate == null || sDate == "") {
            alert("Please select a date!");
            return;
        }

        _sCalendarDate = '';

        RefreshMSCalendarArguments();


        $.ajax({
            type: "POST",
            url: _sBaseAddress + "/MarketingSchedule/Gets",
            traditional: true,
            data: JSON.stringify(_oBaseMarketingSchedule),
            contentType: "application/json; charset=utf-8",
            success: function (data) {


                _oDBMarketingSchedules = (jQuery.parseJSON(data) == null) ? [] : jQuery.parseJSON(data);

                var sDate = $('#txtDateScheduleCalendar').datebox('getValue');
                var dCurrentDate = new Date();
                var sDay = icsCustomStringFormat(dCurrentDate.getDate(), '00');
                sDate = sDay + " " + sDate;
                RefreshCalendarShcedule(sDate);


            }
        });
    });
    function RefreshControlLayout()
    {
        debugger;
        $('#toolbarPS,#btnSave,#btnDelete,#btnDeleteDetail,#btnSaveRS,.ics-pick,#chkboxUptoUnloadDyeMachine').hide();
        //if(HavePermission('AdvSearch','NOA')){document.getElementById('btnSearch').style.display = '';}
        if(HavePermission('Add','DUPSchedule')){  $('#toolbarPS,#btnSave,.ics-pick').show();}
        if(HavePermission('Edit','DUPSchedule')){ $('#toolbarPS,#btnSave,.ics-pick').show();}
        if(HavePermission('Delete','DUPSchedule')){ $('#btnDeleteDetail,#btnDelete,.ics-pick').show();}
        if(HavePermission('Add','RouteSheet')){$('#btnSaveRS').show();}
        //if(HavePermission('Approved','NOA')){document.getElementById('btnApproved').style.display = '';}
        //if(HavePermission('Preview','DUPSchedule')){$('#btnPrintSC,#chkboxUptoUnloadDyeMachine').show();}
    }

    $('#btnSwap').click(function(e)
    {
        debugger;
        var oDUPScheduleDetails = $('#tblDUPScheduleDetail').datagrid('getChecked');
        if(oDUPScheduleDetails.length<2)
        {
            alert("Please select two items.");
            return;
        }
        if(oDUPScheduleDetails.length>2){alert("Please select only two items.");  return;}
        var nts=(new Date()).getTime()/1000;
        {
            var sPSIDs=oDUPScheduleDetails[0].DUPScheduleID+'~'+oDUPScheduleDetails[1].DUPScheduleID;
            $.ajax({
                type: "Post",
                dataType: "json",
                url: _sBaseAddress + "/DUPSchedule/SwapSchedule",
                traditional: true,
                data:   JSON.stringify({sPSIDs : sPSIDs, nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    var oresults=jQuery.parseJSON(data);
                    if(oresults[0].ErrorMessage=="" || oresults[0].ErrorMessage==null)
                    {
                        alert("Swap Successfully");
                        var oDUPScheduleDetails = $('#tblDUPScheduleDetail').datagrid('getChecked');
                        var oList=$('#tblDUPScheduleDetail').datagrid('getRows');
                        var nFirstIndex=oList.indexOf(oDUPScheduleDetails[0]);
                        var nSecondIndex=oList.indexOf(oDUPScheduleDetails[1]);

                        oList[nSecondIndex]=oresults[0];
                        oList[nFirstIndex]=oresults[1];

                        console.log(oresults);

                        DynamicRefreshList(oList, "tblDUPScheduleDetail");
                    }
                    else {alert(oDUPScheduleDetails[0].ErrorMessage);}
                    //alert(sMessage);
                    //if(sMessage=="Swap Successfully") { Refresh(); }

                },
                error: function (xhr, status, error) {alert(error);}
            });
        }
    });
    $("#txtMachineTypePicker").keyup(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){

            debugger
            //if($('#cboMachineType').val()<=0){
            //    alert("Please select machine type and try again!"); return;
            //}

            var oMechine = {
                Name : $('#txtMachineTypePicker').val(),
                MachineTypeID : $('#cboMachineType').val(),
                BUID : sessionStorage.getItem('BUID')
            };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oMechine,
                ControllerName: "DUPSchedule",
                ActionName: "SearchMachineType",
                IsWinClose: false
            };

            $.icsDataGets(obj, function (response) {
                var result=response.objs;
                if (response.status && result.length > 0) {
                    if (result[0].MachineID > 0) {
                        var tblColums = [];
                        var oColumn = { field: "Code", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Name", title: "Name", width: 180, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "MachineTypeName", title: "Machine Type ", width: 110, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winPickerMachine',
                            winclass: 'clsMachinePicker',
                            winwidth: 500,
                            winheight: 460,
                            tableid: 'tblMachinePicker',
                            tablecolumns: tblColums,
                            datalist: result,
                            multiplereturn: true,
                            searchingbyfieldName: 'Name',
                            windowTittle: 'Machine List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbuttonPI(oPickerParam);
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }
                }else{
                    alert("Data Not Found.");
                }
            });
        }else if(event.which==8)
        {
            _sMachineIDs="";
            $('#txtMachineTypePicker').val("");
        }
    });
    function IntializePickerbuttonPI(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssignPI(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssignPI(oPickerobj);
            }
        });
    }
    function SetPickerValueAssignPI(oPickerobj) {
        _sMachineIDs="";
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        if (oPickerobj.winid == 'winPickerMachine')
        {
            if (oreturnObjs!= null && oreturnObjs.length> 0)
            {
                debugger;
                var oMechines = oreturnObjs;
                _sMachineIDs=oMechines[0].MachineID;
                for(var i =1;i<oMechines.length;i++)
                {
                    _sMachineIDs +=","+ oMechines[i].MachineID;
                }

                $('#txtMachineTypePicker').val(oMechines.length+" item(s) selected")
                console.log(_sMachineIDs);
            }
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }


    function HavePermission(sOperationType, sDbObject)
    {
        var nSessionID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.currentUserID]));
        if(nSessionID == -9)
        {
            return true;
        }
        else if(_oAuthorizationRolesMapping==null)
        {
            return false;
        }
        else
        {
            for(var i =0;i<_oAuthorizationRolesMapping.length;i++)
            {
                if(_oAuthorizationRolesMapping[i].OperationTypeST == sOperationType && _oAuthorizationRolesMapping[i].ModuleNameST == sDbObject)
                    return  true;
            }
            return false;
        }
    }

</script>
