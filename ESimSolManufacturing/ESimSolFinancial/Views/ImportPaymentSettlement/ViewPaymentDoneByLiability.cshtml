<html>
@{
    ViewBag.Title = "Import Payment Settlement";
}
@model ESimSol.BusinessObjects.ImportInvoice
    <body>
        <div class="menuMainCollectionTable">
            <div id="divImportPayment" class="easyui-panel" title="Import Payment Settlement" style="font-family:Tahoma; text-align:center; height:90%;">
                <div style="width:100%; height:100%;text-align:center; overflow:auto">
                    <fieldset>
                        <legend style="font-weight: bold"> Settlement Informations : </legend>
                        <table border="0" cellspacing="2" cellpadding="2" style="width:100%;  font-size:12px">
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Invoice No :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtInvoiceNo" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    Invoice Date :
                                </td>
                                <td style="width:15%; text-align:left">                                    
                                    <input id="txtInvoiceDate" style="font-weight:bold; width:100%; text-align:center" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    L/C No :
                                </td>
                                <td style="width:15%; text-align:left">                                    
                                    <input id="txtLCNo" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    L/C Date :
                                </td>
                                <td style="width:15%; text-align:left">                                    
                                    <input id="txtLCDate" style="font-weight:bold; width:100%; text-align:center" disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Settlement With :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtPaymentType" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    L/C Status :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtLCStatus" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    Supplier Name :
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <input id="txtSupplierName" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>                                
                                
                            </tr>                            
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Invoice Value :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtInvoiceValue" style="font-weight:bold; width:100%; text-align:right" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    L/C Value :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtLCValue" style="font-weight:bold; width:100%; text-align:right" disabled="disabled" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    Bank Name :
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <input id="txtBankName" style="font-weight:bold; width:100%; text-align:left" disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Margin Account :
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <select id="cboMarginBankAccount" style="width:100%;"></select>
                                </td>
                                <td style="width:10%; text-align:right">
                                    <label style="font-weight:normal">Margin Amount :</label>
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <table border="0" style="width:100%">
                                        <tr>
                                            <td style="width:25%">
                                                <select id="cboMarginCurrency" style="width:100%;"></select>
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtMarginAmount" type="text" style="width:100%;" />
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtMarginRate" type="text" style="width:100%;" />
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtMarginAmountBC" type="text" style="width:100%;"/>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Bank Account :
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <select id="cboBankAccount" style="width:100%;"></select>
                                </td>
                                <td style="width:10%; text-align:right">
                                    <label style="font-weight:normal" id="lblDeductOrLoanAmount">Deduct Amount :</label> 
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <table border="0" style="width:100%">
                                        <tr>
                                            <td style="width:25%">
                                                <select id="cboCurrency" style="width:100%;"></select>
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtAmountBC_Bank" type="text" style="width:100%;" />
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtAmountBC_BankRate" type="text" style="width:100%;" />
                                            </td>
                                            <td style="width:25%">
                                                <input id="txtAmountBC_BankInBDT" type="text" style="width:100%;"/>
                                            </td>
                                        </tr>
                                    </table>
                                </td>                                
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">
                                    <label style="font-weight:normal" id="lblLoanNo">Loan No :</label> 
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">
                                    <input id="txtLiabilityNo" style="font-weight:bold; width:100%; text-align:left" />
                                </td>                               
                                <td style="width:10%; text-align:right">
                                    <label style="font-weight:normal" id="lblOpeningDate">Opening Date :</label> 
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtDateOfOpening" type="text" style="width:100%" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    <label style="font-weight:normal" id="lblMaturityDate">Maturity Date :</label> 
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtDateOfMaturity" type="text" style="width:100%" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">
                                    Payment Date :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtPaymentDate" type="text" style="width:100%" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    Interest Rate :
                                </td>
                                <td style="width:15%; text-align:left">
                                    <input id="txtInterestRate" type="text" style="width:100%;" />
                                </td>
                                <td style="width:10%; text-align:right">
                                    Remarks :
                                </td>
                                <td colspan="3" style="width:40%; text-align:left">                                    
                                    <input id="txtRemarks" style="font-weight:bold; width:100%; text-align:left"/>
                                </td>                                
                            </tr>
                            <tr style="height:2px">
                                <td colspan="8" style="width:100%; text-align:right"></td>
                            </tr>
                            <tr style="height:210px">
                                <td colspan="8" style="width:100%; text-align:left; vertical-align:top">
                                    <table border="0" cellpadding="1" cellspacing="1" style="width:100%">
                                        <tr style="height:200px">
                                            <td style="width:60%; text-align:left; vertical-align:top">
                                                <fieldset style="width:100%">
                                                    <legend style="font-weight:bold">Settlement Summery :</legend>
                                                    <table border="0" cellspacing="2" cellpadding="2" style="width:100%;  font-weight:normal">
                                                        <tr>
                                                            <td style="width:28%; text-align:right;font-weight:bold"><u>Particulars</u></td>
                                                            <td style="width:18%; text-align:right;font-weight:bold"></td>
                                                            <td style="width:15%"></td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%; text-align:center;font-weight:bold"><u>C. Rate</u></td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%; text-align:center;font-weight:bold"><u>Amount (BDT)</u></td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width:28%; text-align:right">Invoice Amount :</td>
                                                            <td style="width:18%;">
                                                                <input id="txtAmount_Invoice" type="text" disabled="disabled" style="width:100%" />
                                                            </td>
                                                            <td style="width:15%">
                                                                <select id="cboCurrency_Invoice" disabled="disabled" style="width:100%"></select>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%">
                                                                <input id="txtCCRate_Invoice" type="text" disabled="disabled" style="width:100%" />
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%">
                                                                <input id="txtAmountBC_Invoice" type="text" disabled="disabled" style="width: 100%" />
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width:28%; text-align:right">Settlement With LC Margin :</td>
                                                            <td style="width:18%;">
                                                                <input id="txtAmount_LCMargin" type="text" style="width:100%" disabled="disabled" />
                                                            </td>
                                                            <td style="width:15%">
                                                                <select id="cboCurrency_LCMargin" style="width:100%" disabled="disabled"></select>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%">
                                                                <input id="txtMarginSettledRate" type="text" style="width: 100%"/>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%">
                                                                <input id="txtAmountBC_LCMargin" type="text" style="width: 100%" disabled="disabled" />
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width:28%; text-align:right">
                                                                <label style="font-weight:normal" id="lblSettlementWith">Settlement With PAD :</label>                                                                
                                                            </td>
                                                            <td style="width:18%;">
                                                                <input id="txtAmount_Payment" type="text" disabled="disabled" style="width:100%" />
                                                            </td>
                                                            <td style="width:15%">
                                                                <select id="cboCurrency_Payment" disabled="disabled" style="width:100%"></select>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%">
                                                                <input id="txtLiabilitySettledRate" type="text" style="width:100%"/>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%">
                                                                <input id="txtAmountBC_Payment" type="text" disabled="disabled" style="width: 100%" />
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width:28%; text-align:right">
                                                                Foreign Exchange <select id="cboGainLoss" style="width:30%" disabled="disabled"></select> :
                                                            </td>
                                                            <td style="width:18%;">
                                                                <input id="txtAmount_CurrencyGain" type="text" style="width:100%" disabled="disabled" />
                                                            </td>
                                                            <td style="width:15%">
                                                                <select id="cboCurrency_CurrencyGain" style="width:100%" disabled="disabled"></select>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%">
                                                                <input id="txtCCRate_CurrencyGain" type="text" style="width: 100%" disabled="disabled" />
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%">
                                                                <input id="txtAmountBC_CurrencyGain" disabled="disabled" type="text" style="width: 100%" />
                                                            </td>
                                                        </tr>                                                        
                                                        <tr>
                                                            <td style="width:28%; text-align:right">Charge  :</td>
                                                            <td style="width:18%;">
                                                                <input id="txtAmount_Charge" disabled="disabled" type="text" style="width:100%" />
                                                            </td>
                                                            <td style="width:15%">
                                                                <select id="cboCurrency_Charge" style="width:100%" disabled="disabled"></select>
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%">
                                                                <input id="txtCCRate_Charge" type="text" style="width: 100%" disabled="disabled" />
                                                            </td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%">
                                                                <input id="txtAmountBC_Charge" type="text" disabled="disabled" style="width: 100%" />
                                                            </td>
                                                        </tr>
                                                        <tr style="height:15px">
                                                            <td style="width:28%; text-align:right"></td>
                                                            <td style="width:18%;"></td>
                                                            <td style="width:15%"></td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:15%"></td>
                                                            <td style="width:3%"></td>
                                                            <td style="width:18%"></td>
                                                        </tr>
                                                    </table>
                                                </fieldset>
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <div style="height:200px; width:100%; margin-top:5px" >
                                                    <table id="tblCostHeads" title="Cost Heads" style="width:100%;height:200px" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar">
                                                        <thead>
                                                            <tr>
                                                                <th field="AccountHeadName" width="65%">Account Head</th>
                                                                <th field="Amount" align="right" formatter="formatPrice" width="30%">Amount</th>                                                                
                                                            </tr>
                                                        </thead>
                                                    </table>
                                                    <div id="toolbar">
                                                        <table border="0" style="width:100%">
                                                            <tr>
                                                                <td style="width:60%">
                                                                    <select id="cboCostHead" style="width:100%"></select>                                                                    
                                                                </td>
                                                                <td style="width:20%; text-align:right"> Amount:</td>
                                                                <td style="width:20%">
                                                                    <input id="txtCostHeadAmount" type="text" style="width:100%; margin-top:2px; text-align:right"/>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="width:60%">
                                                                    <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="false">Add</a>
                                                                    <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="false">Remove</a>
                                                                    <a id="btnRefresh" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="false">Refresh</a>
                                                                </td>
                                                                <td style="width:20%; text-align:right">Total Cost:</td>
                                                                <td style="width:20%; text-align:right">
                                                                    <input type="text" id="txtTotalValue" style="width:100%; font-weight:bold; text-align:right" value="0.00" disabled="disabled" />                                                                    
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
            </div>
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:83%; text-align:right"></td>
                        <td style="width:17%;text-align:right;">
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnApproived" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approved</a>
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
</body>
</html>

<script type="text/javascript">
    $(document).ready(function () {
        var oImportInvoice = @Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oCompany= @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.Company));
        var oImportPayment = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ImportPayment));
        var oBankAccounts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BankAccounts));
        var oForExGainLoss = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ForExGainLoss));
        var oAccountHeads = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.AccountHeads));

        $('#divImportPayment').data('ImportInvoice', oImportInvoice);
        $('#divImportPayment').data('Currencys', oImportInvoice.Currencys);
        $('#divImportPayment').data('Company', oCompany);
        $('#divImportPayment').data('ImportPayment', oImportPayment);
        $('#divImportPayment').data('BankAccounts', oBankAccounts);
        $('#divImportPayment').data('ForExGainLoss', oForExGainLoss);
        $('#divImportPayment').data('AccountHeads', oAccountHeads);

        $('#txtMarginAmount,#txtMarginAmountBC').icsCurrencyBox(null, null, 2);
        $('#txtAmountBC_Bank,#txtAmountBC_BankInBDT').icsCurrencyBox(null, null, 2);

        $('#txtAmount_Invoice,#txtAmountBC_Invoice').icsCurrencyBox(null, null, 2);
        $('#txtAmount_Payment,#txtAmountBC_Payment').icsCurrencyBox(null, null, 2);
        $('#txtAmount_CurrencyGain,#txtAmountBC_CurrencyGain').icsCurrencyBox(null, null, 2);
        $('#txtAmount_LCMargin,#txtAmountBC_LCMargin').icsCurrencyBox(null, null, 2);
        $('#txtAmount_Charge,#txtAmountBC_Charge').icsCurrencyBox(null, null, 2);
        $('#txtCostHeadAmount,#txtTotalValue').icsCurrencyBox(null, null, 2);

        $('#txtMarginRate,#txtAmountBC_BankRate,#txtCCRate_Invoice,#txtLiabilitySettledRate,#txtInterestRate').icsCurrencyBox(null, null, 4);
        $('#txtCCRate_CurrencyGain,#txtMarginSettledRate,#txtCCRate_Charge').icsCurrencyBox(null, null, 4);



        RefreshComboBox();
        RefreshControls();

        var sHeader= sessionStorage.getItem("ImportPaymentSettlementHeader");
        if(sHeader === "Payment Settlement")
        {
            $('#btnApproived').hide();
        }
        else if(sHeader === "View Settlement")
        {
            $('#divImportPayment :input').prop('disabled', true)
            $('#btnApproived').hide();
            $("#btnSave").hide();
        }
        else if(sHeader === "Approved Settlement")
        {
            $('#divImportPayment :input').prop('disabled', true)
            $("#btnSave").hide();
        }
    });

    function RefreshComboBox()
    {
        var oCurrencys = $('#divImportPayment').data('Currencys');
        var oBankAccounts = $('#divImportPayment').data('BankAccounts');
        var oForExGainLoss = $('#divImportPayment').data('ForExGainLoss');
        var oAccountHeads = $('#divImportPayment').data('AccountHeads');

        $("#cboMarginCurrency").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency_Invoice").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency_Payment").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency_CurrencyGain").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency_LCMargin").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});
        $("#cboCurrency_Charge").icsLoadCombo({List: oCurrencys, OptionValue: "CurrencyID", DisplayText: "CurrencyName"});        

        $("#cboMarginBankAccount").icsLoadCombo({List: oBankAccounts, OptionValue: "BankAccountID",DisplayText: "AccountNo"});
        $("#cboBankAccount").icsLoadCombo({List: oBankAccounts, OptionValue: "BankAccountID",DisplayText: "AccountNo"});
        $("#cboGainLoss").icsLoadCombo({List: oForExGainLoss, OptionValue: "id", DisplayText: "Value"});
        $("#cboCostHead").icsLoadCombo({List: oAccountHeads, OptionValue: "AccountHeadID", DisplayText: "AccountHeadName"});
    }

    function RefreshControls()
    {
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        var oImportPayment = $('#divImportPayment').data('ImportPayment');
        var oCompany = $('#divImportPayment').data('Company');

        $('#txtInvoiceNo').val(oImportInvoice.ImportInvoiceNo);
        $('#txtInvoiceDate').val(oImportInvoice.InvoiceDateInString);
        $('#txtLCNo').val(oImportInvoice.ImportLCNo);
        $('#txtLCDate').val(oImportInvoice.ImportLCDateInString);
        $('#txtSupplierName').val(oImportInvoice.ContractorName);
        $('#txtPaymentType').val(oImportInvoice.LiabilityTypeSt);
        $('#txtLCStatus').val(oImportInvoice.LCCurrentStatusSt);
        $('#txtInvoiceValue').val(oImportInvoice.AmountSt);
        $('#txtLCValue').val(oImportInvoice.AmountLCInSt);
        $('#txtBankName').val(oImportInvoice.BankName_Nego);
        $('#txtBankName').val(oImportInvoice.BankName_Nego);

        $('#cboMarginBankAccount').val(parseInt(oImportPayment.MarginAccountID));
        $('#cboMarginCurrency').val(parseInt(oImportPayment.MarginCurrencyID));
        $('#txtMarginAmount').val(icsFormatPrice(parseFloat(oImportPayment.LCMarginAmount), null, 2));
        $('#txtMarginRate').val(icsFormatPrice(parseFloat(oImportPayment.MarginCCRate), null, 4));
        $('#txtMarginAmountBC').val(icsFormatPrice(parseFloat(oImportPayment.LCMarginAmountBC), null, 2));

        $('#cboBankAccount').val(parseInt(oImportPayment.BankAccountID));
        $('#cboCurrency').val(parseInt(oImportPayment.CurrencyID));
        $('#txtAmountBC_Bank').val(icsFormatPrice(parseFloat(oImportPayment.Amount), null, 2));
        $('#txtAmountBC_BankRate').val(icsFormatPrice(parseFloat(oImportPayment.CCRate), null, 4));
        $('#txtAmountBC_BankInBDT').val(icsFormatPrice(parseFloat(oImportPayment.AmountBC), null, 2));


        $('#lblSettlementWith').text('Settlement With '+oImportInvoice.LiabilityTypeSt+' :');
        if(parseInt(oImportInvoice.LiabilityTypeInt)===1)
        {
            $('#lblDeductOrLoanAmount').text('Deduct Amount :');
            $('#txtLiabilityNo').prop('disabled', true);
            $('#txtInterestRate').prop('disabled', true);            
            $('#txtDateOfOpening').datebox({disabled : true});
            $('#txtDateOfMaturity').datebox({disabled : true});

            $('#txtLiabilityNo').val('');
            $('#txtInterestRate').val(icsFormatPrice(parseFloat(0.00), null, 4));
            $('#txtDateOfOpening').datebox('setValue', icsdateformat(new Date()));
            $('#txtDateOfMaturity').datebox('setValue', icsdateformat(new Date()));
        }
        else
        {
            $('#lblDeductOrLoanAmount').text('Loan Amount :');
            $('#txtLiabilityNo').val(oImportPayment.LiabilityNo);
            $('#txtInterestRate').val(icsFormatPrice(parseFloat(oImportPayment.InterestRate), null, 4));
            $('#txtDateOfOpening').datebox('setValue', oImportPayment.DateOfOpeningST);
            $('#txtDateOfMaturity').datebox('setValue', oImportPayment.DateOfMaturityST);
        }
        $('#txtPaymentDate').datebox('setValue', oImportPayment.PaymentDateSt);        
        $('#txtRemarks').val(oImportPayment.Remarks);
        $('#txtMarginSettledRate').val(icsFormatPrice(parseFloat(oImportPayment.MarginSettledRate), null, 4));
        $('#txtLiabilitySettledRate').val(icsFormatPrice(parseFloat(oImportPayment.LiabilitySettledRate), null, 4));

        $('#cboCurrency_CurrencyGain').val(parseInt(oCompany.BaseCurrencyID));
        $('#txtCCRate_CurrencyGain').val('1.00');
        
        RefreshList(oImportPayment.EHTransactions);
        RefreshAmount();
    }

    $('#cboMarginCurrency').change(function(e){
        var oCompany = $('#divImportPayment').data('Company');
        var nCurrencyID = parseInt($('#cboMarginCurrency').val());
        if(parseInt(oCompany.BaseCurrencyID)===parseInt(nCurrencyID))
        {
            var nMarginAmount = icsRemoveComma($('#txtMarginAmount').val());
            $('#txtMarginRate').val('1.00');
            $('#txtMarginAmountBC').val(icsFormatPrice(nMarginAmount, null, 2));
            $('#txtMarginRate').prop('disabled', true);
        }
        else
        {
            $('#txtMarginRate').val('0.00');
            $('#txtMarginAmountBC').val('0.00');
            $('#txtMarginRate').prop('disabled', false);
        }

        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC) === parseInt(nCurrencyID))
        {
            var nMarginRate = icsRemoveComma($('#txtMarginRate').val());            
            $('#txtMarginSettledRate').val(icsFormatPrice(nMarginRate, null, 4));
            $('#txtMarginSettledRate').prop('disabled', true);
        }
        else
        {            
            $('#txtMarginSettledRate').val('0.00');
            $('#txtMarginSettledRate').prop('disabled', false);
        }
        RefreshAmount();
    });

    $('#txtMarginAmount,#txtMarginRate').keyup(function(e){
        var nMarginAmount = icsRemoveComma($('#txtMarginAmount').val());
        var nMarginRate = icsRemoveComma($('#txtMarginRate').val());
        var nAmountInBC = (parseFloat(nMarginAmount) * parseFloat(nMarginRate));
        $('#txtMarginAmountBC').val(icsFormatPrice(nAmountInBC, null, 2));

        var nCurrencyID = parseInt($('#cboMarginCurrency').val());
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC) === parseInt(nCurrencyID))
        {
            var nMarginRate = icsRemoveComma($('#txtMarginRate').val());            
            $('#txtMarginSettledRate').val(icsFormatPrice(nMarginRate, null, 4));
            $('#txtMarginSettledRate').prop('disabled', true);
        }
        RefreshAmount();
    });

    $('#txtMarginAmountBC').keyup(function(e){
        var nMarginRate = 0.00;
        var nMarginAmount = icsRemoveComma($('#txtMarginAmount').val());
        var nMarginAmountBC = icsRemoveComma($('#txtMarginAmountBC').val());        
        if(nMarginAmount > 0)
        {
            nMarginRate = (nMarginAmountBC/nMarginAmount);
            $('#txtMarginRate').val(icsFormatPrice(nMarginRate, null, 4));
        }        
        var nCurrencyID = parseInt($('#cboMarginCurrency').val());
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC) === parseInt(nCurrencyID))
        {
            var nMarginRate = icsRemoveComma($('#txtMarginRate').val());            
            $('#txtMarginSettledRate').val(icsFormatPrice(nMarginRate, null, 4));
            $('#txtMarginSettledRate').prop('disabled', true);
        }
        RefreshAmount();
    });

    $('#cboCurrency').change(function(e){
        var oCompany = $('#divImportPayment').data('Company');
        var nCurrencyID = parseInt($('#cboCurrency').val());
        if(parseInt(oCompany.BaseCurrencyID)===parseInt(nCurrencyID))
        {
            var nAmountBC_Bank = icsRemoveComma($('#txtAmountBC_Bank').val());
            $('#txtAmountBC_BankRate').val('1.00');
            $('#txtAmountBC_BankInBDT').val(icsFormatPrice(nAmountBC_Bank, null, 2));
            $('#txtAmountBC_BankRate').prop('disabled', true);
        }
        else
        {
            $('#txtAmountBC_BankRate').val('0.00');
            $('#txtAmountBC_BankInBDT').val('0.00');
            $('#txtAmountBC_BankRate').prop('disabled', false);
        }
        
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC)===parseInt(nCurrencyID))
        {
            var nAmountBC_BankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());            
            $('#txtLiabilitySettledRate').val(icsFormatPrice(nAmountBC_BankRate, null, 4));
            $('#txtLiabilitySettledRate').prop('disabled', true);
        }
        else
        {            
            $('#txtLiabilitySettledRate').val('0.00');
            $('#txtLiabilitySettledRate').prop('disabled', false);
        }
        ChangeCurrencyAndCRate();
        RefreshAmount();
    });

    $('#txtAmountBC_Bank,#txtAmountBC_BankRate').keyup(function(e){
        var nAmountBC_Bank = icsRemoveComma($('#txtAmountBC_Bank').val());
        var nAmountBC_BankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());
        var nAmountInBC = (parseFloat(nAmountBC_Bank) * parseFloat(nAmountBC_BankRate));
        $('#txtAmountBC_BankInBDT').val(icsFormatPrice(nAmountInBC, null, 2));

        var nCurrencyID = parseInt($('#cboCurrency').val());
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC) === parseInt(nCurrencyID))
        {
            var nAmountBC_BankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());            
            $('#txtLiabilitySettledRate').val(icsFormatPrice(nAmountBC_BankRate, null, 4));
            $('#txtLiabilitySettledRate').prop('disabled', true);
        }

        ChangeCurrencyAndCRate();
        RefreshAmount();
    });

    $('#txtAmountBC_BankInBDT').keyup(function(e){
        var nAmountBC_BankRate = 0;
        var nAmountBC_Bank = icsRemoveComma($('#txtAmountBC_Bank').val());
        var nAmountBC_BankInBDT = icsRemoveComma($('#txtAmountBC_BankInBDT').val());
        if(nAmountBC_Bank > 0)
        {
            nAmountBC_BankRate = (nAmountBC_BankInBDT/nAmountBC_Bank);
            $('#txtAmountBC_BankRate').val(icsFormatPrice(nAmountBC_BankRate, null, 4));
        }
        var nCurrencyID = parseInt($('#cboCurrency').val());
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(parseInt(oImportInvoice.CurrencyID_LC) === parseInt(nCurrencyID))
        {
            var nAmountBC_BankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());            
            $('#txtLiabilitySettledRate').val(icsFormatPrice(nAmountBC_BankRate, null, 4));
            $('#txtLiabilitySettledRate').prop('disabled', true);
        }

        ChangeCurrencyAndCRate();
        RefreshAmount();
    });

    $('#txtMarginSettledRate,#txtLiabilitySettledRate').keyup(function(e){        
        RefreshAmount();
    });

    function RefreshAmount()
    {
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        var oImportPayment = $('#divImportPayment').data('ImportPayment');

        $('#txtAmount_Invoice').val(icsFormatPrice(parseFloat(oImportInvoice.Amount), null, 2));
        $('#cboCurrency_Invoice').val(oImportInvoice.CurrencyID_LC);
        $('#txtCCRate_Invoice').val(icsFormatPrice(parseFloat(oImportInvoice.CCRate),null, 4));
        var nAmountBC_Invoice =  (parseFloat(oImportInvoice.Amount) * parseFloat(oImportInvoice.CCRate));
        $('#txtAmountBC_Invoice').val(icsFormatPrice(nAmountBC_Invoice, null, 2));
        
        $('#cboCurrency_LCMargin').val(oImportInvoice.CurrencyID_LC);
        var nMarginAmountBC = icsRemoveComma($('#txtMarginAmountBC').val());
        var nMarginSettledRate = icsRemoveComma($('#txtMarginSettledRate').val());
        var nMarginAmount = 0;
        if(parseFloat(nMarginSettledRate)>0)
        {
            //nMarginAmount =  parseFloat((parseFloat(nMarginAmountBC) / parseFloat(nMarginSettledRate)).toFixed(2));
            nMarginAmount =  icsRemoveComma($('#txtMarginAmount').val());
        }
        $('#txtAmount_LCMargin').val(icsFormatPrice(parseFloat(nMarginAmount), null, 2));
        $('#txtAmountBC_LCMargin').val(icsFormatPrice(parseFloat(nMarginAmountBC), null, 2));

                
        $('#cboCurrency_Payment').val(oImportInvoice.CurrencyID_LC);        
        var nLoanOrDeductAmountBC = icsRemoveComma($('#txtAmountBC_BankInBDT').val());
        var nLiabilitySettledRate = icsRemoveComma($('#txtLiabilitySettledRate').val());
        var nRequiredSettlementWithLoanOrTransfer = parseFloat((parseFloat(oImportInvoice.Amount)-parseFloat(nMarginAmount)).toFixed(2));
        var nSettlementWithLoanOrTransfer = 0;        
        if(parseFloat(nLiabilitySettledRate)>0)
        {
            //nSettlementWithLoanOrTransfer = parseFloat((parseFloat(nLoanOrDeductAmountBC) / parseFloat(nLiabilitySettledRate)).toFixed(2));
            nSettlementWithLoanOrTransfer = icsRemoveComma($('#txtAmountBC_Bank').val());
        }
        
        var nChargeAmountBDT = 0 ; var nChargeAmountInCurrency = 0;
        if(parseFloat(nSettlementWithLoanOrTransfer) <= parseFloat(nRequiredSettlementWithLoanOrTransfer))
        {
            $('#txtAmount_Payment').val(icsFormatPrice(parseFloat(nSettlementWithLoanOrTransfer), null, 2));
            var nAmountBC_Payment = parseFloat((parseFloat(nSettlementWithLoanOrTransfer) * parseFloat(nLiabilitySettledRate)).toFixed(2));
            $('#txtAmountBC_Payment').val(icsFormatPrice(parseFloat(nAmountBC_Payment), null, 2));
        }
        else
        {
            $('#txtAmount_Payment').val(icsFormatPrice(parseFloat(nRequiredSettlementWithLoanOrTransfer), null, 2));
            var nAmountBC_Payment = parseFloat((parseFloat(nRequiredSettlementWithLoanOrTransfer) * parseFloat(nLiabilitySettledRate)).toFixed(2));
            $('#txtAmountBC_Payment').val(icsFormatPrice(parseFloat(nAmountBC_Payment), null, 2));

            nChargeAmountBDT = parseFloat((parseFloat(nSettlementWithLoanOrTransfer) - parseFloat(nRequiredSettlementWithLoanOrTransfer)).toFixed(2)); // Charger Amount in Invoice Currency
            nChargeAmountBDT =  parseFloat((parseFloat(nChargeAmountBDT) * parseFloat(nLiabilitySettledRate)).toFixed(2)); //actual charge amount in BDT
            var nAmountBC_BankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());
            if(parseFloat(nAmountBC_BankRate)>0)
            {
                nChargeAmountInCurrency = parseFloat((parseFloat(nChargeAmountBDT) / parseFloat(nAmountBC_BankRate)).toFixed(2));
            }
        }
        
        var nCurrencyID = parseInt($('#cboCurrency').val());
        $('#cboCurrency_Charge').val(nCurrencyID);
        var nBankRate = icsRemoveComma($('#txtAmountBC_BankRate').val());
        $('#txtAmount_Charge').val(icsFormatPrice(nChargeAmountInCurrency, null, 2));
        $('#txtCCRate_Charge').val(icsFormatPrice(parseFloat(nBankRate), null, 4));
        var nChargeAmountBC = parseFloat((parseFloat(nChargeAmountInCurrency) * parseFloat(nBankRate)).toFixed(2));
        $('#txtAmountBC_Charge').val(icsFormatPrice(nChargeAmountBC, null, 2));


        var nTempInvoiceAmount = icsRemoveComma($('#txtAmountBC_Invoice').val());
        var nTempMarginAmount = icsRemoveComma($('#txtAmountBC_LCMargin').val());
        var nTempSettlementAmount = icsRemoveComma($('#txtAmountBC_Payment').val());

        var nAmountBC_CurrencyGain = parseFloat((parseFloat(nTempInvoiceAmount) - (parseFloat(nTempMarginAmount)+parseFloat(nTempSettlementAmount))).toFixed(2));
        if(nAmountBC_CurrencyGain>0)
        {
            //EnumForExGainLoss{ None = 0, Gain = 1, Loss = 2, NoEffect =3 }
            $('#cboGainLoss').val(1);
        }
        else if(nAmountBC_CurrencyGain<0)
        {
            $('#cboGainLoss').val(2);
            nAmountBC_CurrencyGain = (nAmountBC_CurrencyGain * (-1));
        }
        else
        {
            $('#cboGainLoss').val(3);
        }
        $('#txtAmount_CurrencyGain').val(icsFormatPrice(nAmountBC_CurrencyGain, null, 2));
        $('#txtAmountBC_CurrencyGain').val(icsFormatPrice(nAmountBC_CurrencyGain, null, 2));


        var nTotalChargeAmount = 0;
        var oEHTransactions = $('#tblCostHeads').datagrid('getRows');
        for(var i=0; i<oEHTransactions.length; i++)
        {
            nTotalChargeAmount = nTotalChargeAmount + parseFloat(oEHTransactions[i].Amount);
        }
        $('#txtTotalValue').val(icsFormatPrice(parseFloat(nTotalChargeAmount), null, 2));
    }

    function ValidateInput()
    {
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(oImportInvoice===null || parseInt(oImportInvoice.ImportInvoiceID)<0)
        {
            alert("Invalid Import Invoice! Please Try again!");
            return false;
        }

        if(parseInt(oImportInvoice.LiabilityTypeInt)<=0)
        {
            alert("Invalid Liability Type!");
            return false;
        }

        if(parseInt($('#cboMarginBankAccount').val())>0)
        {
            if(parseInt($('#cboMarginCurrency').val()) <=0)
            {
                alert("Please Select Margin Currency!");
                $('#cboMarginCurrency').focus()
                return false;
            }
            if(parseFloat(icsRemoveComma($('#txtMarginAmount').val())) <=0)
            {
                alert("Please Enter Margin Amount!");
                $('#txtMarginAmount').focus()
                return false;
            }
            if(parseFloat(icsRemoveComma($('#txtMarginRate').val())) <=0)
            {
                alert("Please Enter Margin CRate!");
                $('#txtMarginRate').focus()
                return false;
            }

            if(parseInt($('#txtMarginSettledRate').val()) <=0)
            {
                alert("Please enter margin settled currency!");
                $('#txtMarginSettledRate').focus()
                return false;
            }
        }

        if(parseFloat(icsRemoveComma($('#txtMarginAmount').val()))>0)
        {
            if(parseInt($('#cboMarginBankAccount').val())<=0)
            {
                alert("Please Select Margin Account!");
                $('#cboMarginBankAccount').focus()
                return false;
            }
            if(parseInt($('#cboMarginCurrency').val()) <=0)
            {
                alert("Please Select Margin Currency!");
                $('#cboMarginCurrency').focus()
                return false;
            }
            if(parseFloat(icsRemoveComma($('#txtMarginRate').val())) <=0)
            {
                alert("Please Enter Margin CRate!");
                $('#txtMarginRate').focus()
                return false;
            }

            if(parseInt($('#txtMarginSettledRate').val()) <=0)
            {
                alert("Please enter margin settled currency!");
                $('#txtMarginSettledRate').focus()
                return false;
            }
        }

        if(parseInt($('#cboBankAccount').val())<=0)
        {
            alert("Please Select Loan/Deduct Bank Account!");
            $('#cboBankAccount').focus()
            return false;
        }

        if(parseInt($('#cboCurrency').val()) <=0)
        {
            alert("Please Select Loan/Deduct Currency!");
            $('#cboCurrency').focus()
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtAmountBC_Bank').val())) <=0)
        {
            alert("Please Enter Loan/Deduct Amount!");
            $('#txtAmountBC_Bank').focus()
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtAmountBC_BankRate').val())) <=0)
        {
            alert("Please Enter Loan/Deduct CRate!");
            $('#txtAmountBC_BankRate').focus()
            return false;
        }

        if(parseInt(oImportInvoice.LiabilityTypeInt)!=1)
        {
            if($('#txtLiabilityNo').val() === null || $('#txtLiabilityNo').val() === "")
            {
                alert("Please Enter Loan No!");
                $('#txtLiabilityNo').focus()
                return false;
            }

            var nInterestRate = icsRemoveComma($('#txtInterestRate').val());
            if(parseFloat(nInterestRate)<=0)
            {
                alert("Please Enter Interest Rate!");
                $('#txtInterestRate').focus()
                return false;
            }

            var sDateOfOpening =  $('#txtDateOfOpening').datebox('getValue');
            var sDateOfMaturity =  $('#txtDateOfMaturity').datebox('getValue');
            if(sDateOfOpening === null || sDateOfOpening === "")
            {
                alert("Please Enter Loan Opening Date!");
                $('#txtDateOfOpening').focus()
                return false;
            }

            if(sDateOfMaturity === null || sDateOfMaturity === "")
            {
                alert("Please Enter Loan Maturity Date!");
                $('#txtDateOfMaturity').focus()
                return false;
            }

            var dDateOfOpening = new Date(sDateOfOpening);
            var dDateOfMaturity = new Date(sDateOfMaturity);
            var nInterestInTime = (dDateOfMaturity.getTime() - dDateOfOpening.getTime());
            var nInterestDays = (nInterestInTime / (1000 * 3600 * 24));
            //alert(nInterestDays);
            if(nInterestDays<60)
            {
                alert("Please Enter Loan Maturity Date At-least 60 Days!");
                $('#txtDateOfMaturity').focus()
                return false;
            }

        }

        var sPaymentDate =  $('#txtPaymentDate').datebox('getValue');
        if(sPaymentDate === null || sPaymentDate === "")
        {
            alert("Please Enter Payment Date !");
            $('#txtPaymentDate').focus()
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtLiabilitySettledRate').val()))<=0)
        {
            alert("Please enter Liability settled currency!");
            $('#txtLiabilitySettledRate').focus()
            return false;
        }

        var nTempInvoiceAmount = icsRemoveComma($('#txtAmount_Invoice').val());
        var nTempMarginAmount = icsRemoveComma($('#txtAmount_LCMargin').val());
        var nTempSettlementAmount = icsRemoveComma($('#txtAmount_Payment').val());
        var nTempChargeAmount = icsRemoveComma($('#txtAmount_Charge').val());
        var nTempTotalCharge = icsRemoveComma($('#txtTotalValue').val());

        var nGapAmountInvoice = (parseFloat(nTempInvoiceAmount) - (parseFloat(nTempMarginAmount)+ parseFloat(nTempSettlementAmount)));
        if(nGapAmountInvoice<0) 
        {
            nGapAmountInvoice = (nGapAmountInvoice * (-1));
        }

        var nGapAmountCharge = (parseFloat(nTempChargeAmount) - parseFloat(nTempTotalCharge));        
        if(nGapAmountCharge<0) 
        {
            nGapAmountCharge = (nGapAmountCharge * (-1));
        }

        if(parseFloat(nGapAmountInvoice) > 0.001)
        {
            alert("Please Check Invoice Settlement Amount!");            
            return false;
        }

        if(parseFloat(nGapAmountCharge) > 0.001)
        {
            alert("Charge Amount Not Match with Head Wise Total Charge Amount!");            
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtAmount_CurrencyGain').val())) > 0)
        {
            if(parseInt($('#cboCurrency_CurrencyGain').val()) <=0)
            {
                alert("Invalid ForEx Currency!");
                $('#cboCurrency_CurrencyGain').focus()
                return false;
            }
        }
        return true;
    }

    function RefreshObject()
    {
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        var oImportPayment = $('#divImportPayment').data('ImportPayment');

        var oImportPayment = {
            ImportPaymentID : parseInt(oImportPayment.ImportPaymentID),
            ImportInvoiceID : parseInt(oImportInvoice.ImportInvoiceID),
            LiabilityType : parseInt(oImportInvoice.LiabilityTypeInt),
            LiabilityTypeInt : parseInt(oImportInvoice.LiabilityTypeInt),
            MarginAccountID : parseInt($('#cboMarginBankAccount').val()),
            MarginCurrencyID : parseInt($('#cboMarginCurrency').val()),
            LCMarginAmount : parseFloat(icsRemoveComma($('#txtMarginAmount').val())),
            MarginCCRate : parseFloat(icsRemoveComma($('#txtMarginRate').val())),
            LCMarginAmountBC : parseFloat(icsRemoveComma($('#txtMarginAmountBC').val())),
            LiabilityNo : $('#txtLiabilityNo').val(),
            InterestRate : parseFloat(icsRemoveComma($('#txtInterestRate').val())),
            DateOfOpening : $('#txtDateOfOpening').datebox('getValue'),
            DateOfMaturity : $('#txtDateOfMaturity').datebox('getValue'),
            BankAccountID : parseInt($('#cboBankAccount').val()),
            CurrencyID : parseInt($('#cboCurrency').val()),
            Amount : parseFloat(icsRemoveComma($('#txtAmountBC_Bank').val())),
            CCRate : parseFloat(icsRemoveComma($('#txtAmountBC_BankRate').val())),
            AmountBC : parseFloat(icsRemoveComma($('#txtAmountBC_BankInBDT').val())),
            PaymentDate : $('#txtPaymentDate').datebox('getValue'),
            MarginSettledRate : parseFloat(icsRemoveComma($('#txtMarginSettledRate').val())),
            LiabilitySettledRate : parseFloat(icsRemoveComma($('#txtLiabilitySettledRate').val())),
            Remarks : $('#txtRemarks').val(),
            ForExGainLoss : parseInt($('#cboGainLoss').val()),
            ForExGainLossInt : parseInt($('#cboGainLoss').val()),
            ForExCurrencyID : parseInt($('#cboCurrency_CurrencyGain').val()),
            ForExAmount : parseFloat(icsRemoveComma($('#txtAmount_CurrencyGain').val())),
            ForExCCRate : parseFloat(icsRemoveComma($('#txtCCRate_CurrencyGain').val())),
            ForExAmountBC : parseFloat(icsRemoveComma($('#txtAmountBC_CurrencyGain').val())),
            ChargeAmount : parseFloat(icsRemoveComma($('#txtAmount_Charge').val())),
            ChargeAmountBC : parseFloat(icsRemoveComma($('#txtAmountBC_Charge').val())),
            ApprovedBy : parseInt(oImportPayment.ApprovedBy),
            EHTransactions : $('#tblCostHeads').datagrid('getRows')
        }
        return oImportPayment;
    }

    $('#btnSave').click(function(e){
        if(!ValidateInput()) return;
        var oImportPayment = RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +  "/ImportPaymentSettlement/Save",
            traditional: true,
            data:  JSON.stringify(oImportPayment),
            contentType: "application/json; charset=utf-8",
            success: function (data){
                var   oImportPaymentSettlement = jQuery.parseJSON(data);
                if (oImportPaymentSettlement.ErrorMessage=="" || oImportPaymentSettlement.ErrorMessage==null)
                {
                    alert("Data Save Successfully");
                    var oImportPaymentSettlements = sessionStorage.getItem("ImportPaymentSettlements");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if(oImportPaymentSettlements!=null)
                    {
                        oImportPaymentSettlements = jQuery.parseJSON(oImportPaymentSettlements);
                    }
                    else
                    {
                        oImportPaymentSettlements=[];
                    }
                    if(nIndex!=-1)
                    {
                        oImportPaymentSettlements[nIndex]=oImportPaymentSettlement;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndexBank", oImportPaymentSettlements.length);
                        oImportPaymentSettlements.push(oImportPaymentSettlement);
                    }
                    sessionStorage.setItem("ImportPaymentSettlements", JSON.stringify(oImportPaymentSettlements));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else
                {
                    alert(oImportPaymentSettlement.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    $('#btnApproived').click(function(e){        
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(oImportInvoice===null || parseInt(oImportInvoice.ImportInvoiceID)<0)
        {
            alert("Invalid Import Invoice! Please Try again!");
            return;
        }

        var oImportPayment = $('#divImportPayment').data('ImportPayment');
        if(oImportPayment === null || parseInt(oImportPayment.ImportPaymentID)<=0)
        {
            alert("Invalid Import Payment! Please Try again!");
            return;
        }
        if(parseInt(oImportPayment.ApprovedBy)!=0)
        {
            alert("Your Selected Import Payment Already Exists! Please Try again!");
            return;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +  "/ImportPaymentSettlement/Approved",
            traditional: true,
            data:  JSON.stringify(oImportPayment),
            contentType: "application/json; charset=utf-8",
            success: function (data){
                var   oImportPaymentSettlement = jQuery.parseJSON(data);
                if (oImportPaymentSettlement.ErrorMessage=="" || oImportPaymentSettlement.ErrorMessage==null)
                {
                    alert("Approved Successfully");
                    var oImportPaymentSettlements = sessionStorage.getItem("ImportPaymentSettlements");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if(oImportPaymentSettlements!=null)
                    {
                        oImportPaymentSettlements = jQuery.parseJSON(oImportPaymentSettlements);
                    }
                    else
                    {
                        oImportPaymentSettlements=[];
                    }
                    if(nIndex!=-1)
                    {
                        oImportPaymentSettlements[nIndex]=oImportPaymentSettlement;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndexBank", oImportPaymentSettlements.length);
                        oImportPaymentSettlements.push(oImportPaymentSettlement);
                    }
                    sessionStorage.setItem("ImportPaymentSettlements", JSON.stringify(oImportPaymentSettlements));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else
                {
                    alert(oImportPaymentSettlement.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    function ChangeCurrencyAndCRate()
    {
        var oEHTransactions = $('#tblCostHeads').datagrid('getRows');
        for(var i=0; i<oEHTransactions.length; i++)
        {
            var nAmount = parseFloat(oEHTransactions[i].Amount);
            var nCRate = parseFloat(icsRemoveComma($('#txtAmountBC_BankRate').val()));
            var nAmountBC = (parseFloat(nAmount) * parseFloat(nCRate));            
            oEHTransactions[i].CurrencyID = parseInt($('#cboCurrency').val());
            oEHTransactions[i].Amount = parseFloat(nAmount);
            oEHTransactions[i].CCRate = parseFloat(nCRate);
            oEHTransactions[i].AmountBC = parseFloat(nAmountBC);
        }
        RefreshList(oEHTransactions);
    }

    function RefreshList(oEHTransactions)
    {
        data = oEHTransactions;
        data = { "total": "" + data.length + "", "rows": data };
        $('#tblCostHeads').datagrid('loadData', data);
    }

    $("#btnAdd").click(function(){        
        var oImportInvoice = $('#divImportPayment').data('ImportInvoice');
        if(oImportInvoice===null || parseInt(oImportInvoice.ImportInvoiceID)<0)
        {
            alert("Invalid Import Invoice! Please Try again!");
            return false;
        }

        if(parseInt($('#cboCurrency').val()) <=0)
        {
            alert("Invalid Currency!");
            $('#cboCurrency').focus()
            return;
        }
        if(parseFloat(icsRemoveComma($('#txtAmountBC_BankRate').val())) <=0)
        {
            alert("Please Enter CRate!");
            $('#txtAmountBC_BankRate').focus()
            return;
        }
        if(parseInt($('#cboCostHead').val()) <=0)
        {
            alert("Please Select Cost Head!");
            $('#cboCostHead').focus()
            return;
        }

        if(parseFloat(icsRemoveComma($('#txtCostHeadAmount').val())) <=0)
        {
            alert("Please Enter CostHead Amount!");
            $('#txtCostHeadAmount').focus()
            return;
        }

        var oEHTransactions = $('#tblCostHeads').datagrid('getRows');
        for(var i=0; i<oEHTransactions.length; i++)
        {
            if(parseInt(oEHTransactions[i].AccountHeadID) === parseInt($('#cboCostHead').val()))
            {
                alert("Selected Cost Head Already Exists!");
                return;
            }
        }
        
        var nAmount = parseFloat(icsRemoveComma($('#txtCostHeadAmount').val()));
        var nCRate = parseFloat(icsRemoveComma($('#txtAmountBC_BankRate').val()));
        var nAmountBC = (parseFloat(nAmount) * parseFloat(nCRate));

        var oEHTransaction = {
            EHTransactionID : 0,
            AccountHeadID : parseInt($('#cboCostHead').val()),
            ExpenditureType : 21, //EnumExpenditureType.ImportInvoice = 21
            ExpenditureTypeInt : 21, //EnumExpenditureType.ImportInvoice = 21
            RefObjectID : parseInt(oImportInvoice.ImportInvoiceID),
            CurrencyID : parseInt($('#cboCurrency').val()),
            Amount : parseFloat(nAmount),
            CCRate : parseFloat(nCRate),
            AmountBC : parseFloat(nAmountBC),
            Remarks : "N/A",
            AccountHeadName : $("#cboCostHead option:selected").text(),
            CSymbol : $("#cboCurrency option:selected").text()
        };
        $('#tblCostHeads').datagrid('appendRow', oEHTransaction);
        $('#cboCostHead').val(0);
        $('#txtCostHeadAmount').val('');        
        RefreshAmount();
    });
    
    $("#btnDelete").click(function(){
        var oEHTransaction = $('#tblCostHeads').datagrid('getSelected');
        if(oEHTransaction===null || parseInt(oEHTransaction.AccountHeadID)<=0)
        {
            alert("Please Select a Cost Head from list!");
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex = $('#tblCostHeads').datagrid('getRowIndex', oEHTransaction);
        $('#tblCostHeads').datagrid('deleteRow', nSelectedIndex);
        alert("Delete sucessfully");
        RefreshAmount();
    });

    $("#btnRefresh").click(function(){
        ChangeCurrencyAndCRate();
    });

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });
</script>