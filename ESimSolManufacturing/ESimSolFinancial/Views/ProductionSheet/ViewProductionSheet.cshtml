<html>
<head>
    @{ViewBag.Title = "Production Sheet";} 
</head>
<body>
    @model ESimSol.BusinessObjects.ProductionSheet
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    <div id="winRecipePicker" class="easyui-window winClass" title="Recipe Picker" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table border="0" cellpadding="0" cellspacing="0" style="font-size:12px" width="1100px;">
            <tr style="height:270px">
                <td style="width:1100px">
                    <table border="0" cellpadding="0" cellspacing="0" style="font-size:12px" width="100%">
                        <tr style="height:260px">
                            <td style="width:300px; height:453px; vertical-align:top;height:420px">
                                <table id="tblRecipes" title="Recipe List " class="easyui-datagrid" style="width:300px;height:450px;font-size:12px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" , autorowheight="false">
                                    <thead>
                                        <tr>
                                            <th field="RecipeName" width="110">Recipe Name</th>
                                            <th field="ColorName" width="205">Color Name</th>
                                        </tr>
                                    </thead>
                                </table>
                            </td>
                            <td style="width:800px; height:453px;vertical-align:top">
                                <table id="tblTempProductionRecipes" title="Recipe Details" class="easyui-datagrid" style="width:790px;height:450px;font-size:12px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false"
                                       data-options="rowStyler: function(index,row){if (row.bIsColor == true){return 'background-color:#6293BB;color:#fff;font-weight:bold;';}else{return 'background-color:#F5BCA9;color:#000000;font-weight:bold;';}}">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'Selected',checkbox:true"></th>
                                            <th field="ProductCode" width="70">Code</th>
                                            <th field="ProductName" width="265">Product Name</th>
                                            <th field="QtyTypeSt" width="60">Qty Type</th>
                                            <th field="QtyInPercent" width="70" align="right">Qty(Recipe)</th>
                                            <th field="StockUnitName" width="40">S.Unit</th>
                                            <th field="StockBalance" formatter="formatPrice4digit" width="100" align="right">Stock Qty</th>
                                            <th field="MUName" width="40">R.Unit</th>
                                            <th field="RequiredQty" width="90" formatter="formatPrice4digit" align="right">Required Qty</th>
                                        </tr>
                                    </thead>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr style="height:50px">
                <td style="width:650px; text-align:right">
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="OkButtonClickRecipe()">Ok</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true" onclick="CloseRecipePicker()">Close</a>
                </td>
            </tr>
        </table>
     </div>
    
     <div class="menuMainCollectionTable" id="divPS">
            <div class="easyui-panel" title="Production Sheet(Hanger)" style="font-family:Tahoma; text-align:center; height:90%;">
                <div style="width:100%;">
                    <fieldset>
                        <legend style="font-weight:bold">Production Sheet info: </legend>
                        <table style="width:100%" cellpadding="1" cellspacing="1">
                            <tr>
                                <td style="width: 10%; text-align: right">
                                    Sheet No:
                                </td>
                                <td style="width: 25%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:30%">@Html.TextBoxFor(model => model.SheetNo, new { style = "width: 100%;", id = "txtSheetNo", disabled = "disabled" })</td>
                                            <td style="width:30%; text-align:right;">Issue Date:</td>
                                            <td style="width:40%"><input id="txtIssueDate" type="text" class="easyui-datebox" style="width: 100%;" data-options="formatter:icsdateformat,parser:icsdateparser" /></td>
                                        </tr>
                                    </table>

                                </td>
                                <td style="width: 10%; text-align:right;">
                                    Customer :
                                </td>
                                <td style="width:20%; text-align:left;">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:84%;">@Html.TextBoxFor(model => model.ContractorName, new { style = "width: 100%;", id = "txtContractorName" })</td>
                                            <td style="width:16%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPickContractor" /></td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width:10%; text-align: right">
                                    PI No:
                                </td>
                                <td style="width: 25%; text-align: right">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%">@Html.TextBoxFor(model => model.ExportPINo, new { style = "width:100%;", id = "txtExportPINo" })</td>
                                            <td style="width:15%; text-align:right;"><input type="button" id="btnPickPI" value="Pick" /></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>

                            <tr>
                                <td style="width: 10%; text-align: right">
                                    Model Ref:
                                </td>
                                <td style="width: 25%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%;">@Html.TextBoxFor(model => model.ModelReferencenName, new { style = "width: 100%;", id = "txtModelReferencenName", disabled = "disabled" })</td>
                                            <td style="width:15%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPickMold" /></td>
                                        </tr>
                                    </table>

                                </td>
                                <td style="width: 10%; text-align: right">
                                    Product:
                                </td>
                                <td style="width: 20%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:84%;">@Html.TextBoxFor(model => model.ProductName, new { style = "width: 100%;", id = "txtProductName" })</td>
                                            <td style="width:16%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPickProduct" /></td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width:10%; text-align: right">
                                    Order Qty:
                                </td>
                                <td style="width: 25%; text-align: right">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%">@Html.TextBoxFor(model => model.ProdOrderQty, new { style = "width:97%;text-align:right", id = "txtProdOrderQty", disabled = "disabled" })</td>
                                            <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbol", disabled = "disabled" })</td>
                                        </tr>
                                    </table>
                                    
                                </td>

                            </tr>

                            <tr>
                                <td style="width: 10%; text-align: right">
                                    F.G Weight:
                                </td>
                                <td style="width: 25%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="font-size:11px;">
                                        <tr>
                                            <td style="width:20%;">@Html.TextBoxFor(model => model.FGWeight, new { style = "width:95%;text-align:right", id = "txtFGWeight" })</td>
                                            <td style="width:12%; text-align:right;">@Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width:90%;text-align:right", id = "txtFGWeightUnitSymbol", disabled = "disabled" })</td>
                                            <td style="width:32%; text-align:right;">Runner Weight</td>
                                            <td style="width:22%;">@Html.TextBoxFor(model => model.NaliWeight, new { style = "width:95%;text-align:right", id = "txtNaliWeight" })</td>
                                            <td style="width:12%; text-align:right;">@Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width:90%;text-align:right", id = "txtNaliFGWeightUnitSymbol", disabled = "disabled" })</td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">
                                    Total Weight:
                                </td>
                                <td style="width: 20%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:25%">
                                                @Html.TextBoxFor(model => model.TotalWeight, new { style = "width:90%;text-align:right", id = "txtTotalWeight", disabled = "disabled" })
                                            </td>
                                            <td style="width:10%; text-align:right;">
                                                @Html.TextBoxFor(model => model.FGWeightUnitSymbol, new { style = "width: 95%;text-align:right", id = "txtTotalFGWeightUnitSymbol", disabled = "disabled" })
                                            </td>
                                            <td style="width:45%; text-align:right">
                                                Weight For(Pcs):
                                            </td>
                                            <td style="width:20%">
                                                @Html.TextBoxFor(model => model.WeightFor, new { style = "width:93%;text-align:right", id = "txtWeightFor" })
                                            </td>
                                        </tr>
                                    </table>

                                </td>
                                <td style="width: 10%; text-align: right">
                                    Remaining Qty:
                                </td>
                                <td style="width: 25%; text-align: right">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%">@Html.TextBoxFor(model => model.YetToSheetQty, new { style = "width:97%;text-align:right", id = "txtYetToSheetQty", disabled = "disabled" })</td>
                                            <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbolRemainingQty", disabled = "disabled" })</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 10%; text-align: right">
                                    Recipe Name:
                                </td>
                                <td style="width: 25%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%">@Html.TextBoxFor(model => model.RecipeName, new { style = "width: 100%;", id = "txtRecipeName" })</td>
                                            <td style="width:15%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPicRecipe" /></td>
                                        </tr>
                                    </table>

                                </td>
                                <td style="width: 10%; text-align: right">
                                    Color Name:
                                </td>
                                <td style="width: 20%; text-align: left">
                                    @Html.TextBoxFor(model => model.ColorName, new { style = "width: 100%;", id = "txtColorName", disabled = "disabled" })
                                </td>
                                <td style="width: 10%; text-align: right">
                                    Sheet Qty:
                                </td>
                                <td style="width: 25%; text-align: right">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%">@Html.TextBoxFor(model => model.Quantity, new { style = "width:97%;text-align:right", id = "txtQuantity"})</td>
                                            <td style="width:15%">@Html.TextBoxFor(model => model.UnitSymbol, new { style = "width: 100%;", id = "txtUnitSymbolQty", disabled = "disabled" })</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 10%; text-align: right">
                                    Machine:
                                </td>
                                <td style="width:25%; text-align: left">
                                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                        <tr>
                                            <td style="width:85%;">@Html.TextBoxFor(model => model.MachineName, new { style = "width: 100%;", id = "txtMachineName", placeholder = "Type Machine Name and Press Enter" })</td>
                                            <td style="width:15%; text-align:right;"><input type="button" style="width:100%" value="Pick" id="btnPickMachine" /></td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">
                                    Qty Per Carton :
                                </td>
                                <td style="width:25%; text-align: left">
                                    @Html.TextBoxFor(model => model.PerCartonFGQty, new { style = "width: 100%;", id = "txtPerCartonFGQty" })
                                </td>
                                <td style="width: 10%; text-align: right">
                                    Note:
                                </td>
                                <td style="width: 25%; text-align: right">@Html.TextBoxFor(model => model.Note, new { style = "width:99%;", id = "txtNote" })</td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
                <table id="tblProductionRecipe" title="Production Recipe Details" class="easyui-datagrid" style="height:295px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar" data-options="onClickRow: onClickRow">
                    <thead>
                        <tr>                            
                            <th field="ProductCode" width="10%" align="left">Code</th>
                            <th field="ProductName" width="25%" align="left">Raw Material Name</th>
                            <th width="10%" align="left" field="QtyTypeSt">Qty Type</th>
                            <th width="10%" align="left" field="MUName">Unit Name</th>
                            <th width="10%" align="left" data-options="field:'QtyInPercent',editor:{type:'numberbox',options:{precision:4}}">Qty(%)</th>
                            <th width="20%" align="right" field="RequiredQty" formatter="formatPrice4digit">Required Qty</th>
                        </tr>
                    </thead>
                </table>
                <div id="toolbar">
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="RefreshGrid()">Refresh</a>
                    <input type="text" id="txtRawMaterialName" placeholder="Type Raw Material Name & Press Enter" style="width:180px" />
                    <a id="btnPickRawMaterial" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Pick</a>
                    <select id="cboQtyType" style="width:150px"><option value="0">--Select Qty Type--</option><option value="1">Percent</option><option value="2">Count</option></select>
                    <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true" onclick="AddRawMaterial()">Add</a>
                    <a id="btnRemoveRawmaterial" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true" onclick="RemoveRawMaterial()">Remove</a>
                </div>
            </div>
            <fieldset style="height:10%">
                <legend style="font-weight: bold">Action : </legend>
                <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                    <tr>
                        <td style="width:83%; text-align:right"></td>
                        <td style="width:17%;text-align:right;">
                            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-approved" plain="true">Approve</a>
                            <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                            <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="Close()" plain="true">Close</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </div>
</body>
</html>
<script type="text/javascript">
    var _sBaseAddress = "";
    var _oPaymentTypes=[];
    var _oPriorityLevels=[];
    var _oMktPersons = [];
    var _oProduct = null;
    var _oColorCategory = null;
    var _oSizeCategory =  null;
    var _bIsBuyer= true;
    var _oCurrencyList = [];
    $(document).ready(function () {
        _sBaseAddress =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        var oProductionSheet =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));       
        debugger;       
        $('#divPS').data('ProductionSheet',oProductionSheet);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();    
        $('#txtFGWeight,#txtNaliWeight,#txtPerCartonFGQty,#txtWeightFor,#txtQuantity,#txtYetToSheetQty').icsCurrencyBox();
        $('#txtIssueDate').datebox('setValue',oProductionSheet.IssueDateInString);
        $('#btnApprove').hide();
        $('#txtRawMaterialName').data('Product',null);
        if(parseInt(oProductionSheet.ProductionSheetID)>0)
        {
            GetsUnitConversion(parseInt(oProductionSheet.RecipeID));
            RefreshControl(oProductionSheet);
        }
        if(parseInt(oProductionSheet.PTUUnit2ID)>0)
        {
            $("#txtExportPINo,#txtContractorName,#txtProductName,#txtModelReferencenName").addClass("fontColorOfPickItem");
        }
        $('#tblRecipes').datagrid({onSelect: function(rowIndex, rowData){ RowSelect(rowData);}}); 
        $('#cboQtyType').prop('disabled',true);
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    function RowSelect(oTempRecipe)
    {
        
        var nTotalWeight = parseFloat(icsRemoveComma($('#txtTotalWeight').val()));
        var nWeightFor = parseFloat(icsRemoveComma($('#txtWeightFor').val()));
        var nFGMUnitID = parseInt($('#divPS').data('ProductionSheet').FGWeightUnitID);
        var nFGQty = parseFloat(icsRemoveComma($('#txtQuantity').val()));
        if(nTotalWeight<=0 || nWeightFor<=0)
        {
            alert("Invalid Hanger Weight!");
            return;
        }
        if(parseInt(nFGMUnitID)<=0)
        {
            alert("Invalid Hanger Measurement Unit!");
            return;
        }

        var oRecipe={
            RecipeID : oTempRecipe.RecipeID,
            BUID:oTempRecipe.BUID,
            ProductNatureInInt:1,//Hanger
            Note:nTotalWeight+'~'+nWeightFor+'~'+nFGMUnitID+'~'+nFGQty
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/Recipe/GetsProductionRecipeList",
            data:  JSON.stringify(oRecipe),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var  oRecipe = jQuery.parseJSON(data);
                $('#divPS').data('UnitConversions', oRecipe.UnitConversions);
                var  oProductionRecipes = oRecipe.ProductionRecipes;
                if(oProductionRecipes.length>0)
                {
                    if(oProductionRecipes[0].ErrorMessage=="" || oProductionRecipes[0].ErrorMessage==null) 
                    {
                        DynamicRefreshList(oProductionRecipes, "tblTempProductionRecipes");
                        for(var i = 0;i<oProductionRecipes.length;i++)
                        {
                            if(oProductionRecipes[i].bIsChecked)
                            {
                                $('#tblTempProductionRecipes').datagrid('checkRow', i);
                            }
                        }
                        $('#tblTempProductionRecipes').datagrid({onCheck: function(rowIndex, rowData){ RowCheck(rowData);}}); 
                    }else
                    {
                        alert(oProductionRecipes[0].ErrorMessage);
                        DynamicRefreshList([], "tblTempProductionRecipes");
                    }
                }else{
                    alert("Data Not Found.");
                }
               
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }
    function RowCheck(oTempProductionRecipe)
    {
        debugger;
        var oTempList = $('#tblTempProductionRecipes').datagrid('getRows');
        if(oTempList.length>0 && oTempProductionRecipe!=null)
        {
            for(var i =0;i<oTempList.length;i++)
            {
                if(parseInt(oTempList[i].ProductBaseID)==parseInt(oTempProductionRecipe.ProductBaseID) && parseInt(oTempList[i].ProductID)!=parseInt(oTempProductionRecipe.ProductID))
                {
                    $('#tblTempProductionRecipes').datagrid('uncheckRow',i);
                }
            }
        }
    }
    
    function CloseRecipePicker()
    {
        $("#winRecipePicker").icsWindow('close');
    }

    $('#txtNaliWeight,#txtFGWeight,#txtQuantity,#txtWeightFor').keyup(function()
    {
        $('#txtTotalWeight').val(parseFloat($('#txtFGWeight').val())+parseFloat($('#txtNaliWeight').val()));
        CalculateRequiredQty();
    });

    function GetUnitConversion(nProductID, nFromUnitID, nToUnitID)
    {
        var nConversionValue = 0;
        var oUnitConversions = $('#divPS').data('UnitConversions');
        for(var i=0; i<oUnitConversions.length; i++)
        {
            if(parseInt(oUnitConversions[i].ProductID)===parseInt(nProductID) &&  parseInt(oUnitConversions[i].MeasurementUnitID)===parseInt(nFromUnitID) && parseInt(oUnitConversions[i].ConvertedUnitID)===parseInt(nToUnitID))
            {
                return parseFloat(oUnitConversions[i].ConvertedUnitValue);
            }
        }
        return nConversionValue;
    }

    function CalculateRequiredQty()
    {
        
        var nTotalWeight = parseFloat(icsRemoveComma($('#txtTotalWeight').val()));
        var nWeightFor = parseFloat(icsRemoveComma($('#txtWeightFor').val()));
        var nFGMUnitID = parseInt($('#divPS').data('ProductionSheet').FGWeightUnitID);
        var nFGQty = parseFloat(icsRemoveComma($('#txtQuantity').val()));
        if(nTotalWeight<=0 || nWeightFor<=0)
        {
            alert("Invalid Hanger Weight!");
            return;
        }
        if(parseInt(nFGMUnitID)<=0)
        {
            alert("Invalid Hanger Measurement Unit!");
            return;
        }
        var nPerHangerWeight = (nTotalWeight/nWeightFor);
        var oProductionRecipes = $('#tblProductionRecipe').datagrid('getRows');
        for(var i = 0;i<oProductionRecipes.length;i++)
        {
            if(parseInt(oProductionRecipes[i].QtyTypeInt)==1)
            {
                var nConvertedValue=1;
                var nPerHangerReqQty = (nPerHangerWeight * parseFloat(parseFloat(oProductionRecipes[i].QtyInPercent))/100);
                if(parseInt(oProductionRecipes[i].MUnitID)!=nFGMUnitID)
                {
                    nConvertedValue=GetUnitConversion(oProductionRecipes[i].ProductID, nFGMUnitID, oProductionRecipes[i].MUnitID);   
                }
                if(nConvertedValue<=0)
                {
                    alert("Unit conversion required for "+ oProductionRecipes[i].ProductName +"!");
                    return;
                }
                nPerHangerReqQty= (nPerHangerReqQty * nConvertedValue);                
                oProductionRecipes[i].RequiredQty =parseFloat((nPerHangerReqQty*nFGQty));
            }
            else
            {
                oProductionRecipes[i].RequiredQty = parseFloat(oProductionRecipes[i].QtyInPercent * nFGQty);
            }
        }
        RefreshProductionRecipeList(oProductionRecipes);
    }

    function RefreshControl(oProductionSheet){        
        if(parseInt(oProductionSheet.ProductionSheetID)>0)
        {
            $("#txtExportPINo,#txtRecipeName,#txtContractorName,#txtMachineName").addClass("fontColorOfPickItem");
            RefreshProductionRecipeList(oProductionSheet.ProductionRecipes);
        }
        if(sessionStorage.getItem("ProductionSheetHeader")=="View Production Sheet")
        {
            $('#btnSave').hide();
            $("#btnPickContractor,#btnProductPiker,#txtProductName,#txtColorName").prop('disabled', true);
        }
        if(sessionStorage.getItem("ProductionSheetHeader")=="Approve Production Sheet")
        {
            $('#btnApprove').show();
            $('#btnSave').hide();
        }
    }

    function RefreshProductionRecipeList(oOrderDetailList)
    {
        var data=oOrderDetailList;
        data={"total":""+data.length+"","rows":data};
        $('#tblProductionRecipe').datagrid('loadData',data);
    }
   
    function Validation(){

        if(parseInt($('#divPS').data('ProductionSheet').PTUUnit2ID)<=0)
        {
            $('#txtExportPINo').focus();
            $('#txtExportPINo').addClass("errorFieldBorder");
            alert('Please Pick Prodction Order.');
            return false;
        }else{
            $('#txtExportPINo').removeClass("errorFieldBorder");
        }

                
        if(parseInt($('#divPS').data('ProductionSheet').ContractorID)<=0){
            $('#txtContractorName').focus();
            $('#txtContractorName').addClass("errorFieldBorder");
            alert('Please Pick Buyer.');
            return false;
        }
        else{
            $('#txtContractorName').removeClass("errorFieldBorder");
        }
       
        if(parseInt($('#divPS').data('ProductionSheet').RecipeID)<=0){
            $('#txtRecipeName').focus();
            $('#txtRecipeName').addClass("errorFieldBorder");
            alert('Please Pick Recipe');
            return false;
        }
        else{
            $('#txtRecipeName').removeClass("errorFieldBorder");
        }

        if(parseInt($('#divPS').data('ProductionSheet').MachineID)<=0)
        {
            $('#txtMachine').focus();
            $('#txtMachine').addClass("errorFieldBorder");
            alert('Please Pick Machine.');
            return false;
        }else{
            $('#txtMachine').removeClass("errorFieldBorder");
        }
        if(parseInt(icsRemoveComma($('#txtPerCartonFGQty').val()))<=0)
        {
            $('#txtPerCartonFGQty').focus();
            $('#txtPerCartonFGQty').addClass("errorFieldBorder");
            alert('Finish Good Qty in per Carton should be greater than 0.');
            return false;
        }else{
            $('#txtPerCartonFGQty').removeClass("errorFieldBorder");
        }

        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
        {
            alert('Sheet Quantity Should be Greater than 0.');
            return false;
        }
       
        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))> parseFloat(icsRemoveComma($('#txtYetToSheetQty').val())))
        {
            alert('Sheet Quantity Should be Less than Remianing Qty.');
            return false;
        }
      
        return true;
    }

    function RefreshObject()
    {
        var oTempProductionSheet = $('#divPS').data('ProductionSheet');
        var oProductionSheet={
            ProductionSheetID: (oTempProductionSheet!=null && oTempProductionSheet.ProductionSheetID>0)? oTempProductionSheet.ProductionSheetID:0,
            SheetNo:oTempProductionSheet.SheetNo,
            PTUUnit2ID:oTempProductionSheet.PTUUnit2ID,
            IssueDate:$('#txtIssueDate').datebox('getValue'),
            ProductID:oTempProductionSheet.ProductID,
            BUID:sessionStorage.getItem('BUID'),
            SheetStatusInInt:0,//Initialize
            Note:$('#txtNote').val(),
            Quantity:icsRemoveComma($('#txtQuantity').val()),
            FGWeight: icsRemoveComma($('#txtFGWeight').val()), 
            NaliWeight: icsRemoveComma($('#txtNaliWeight').val()),
            WeightFor: icsRemoveComma($('#txtWeightFor').val()),
            FGWeightUnitID:oTempProductionSheet.FGWeightUnitID,
            RecipeID:oTempProductionSheet.RecipeID,
            ModelReferenceID:oTempProductionSheet.ModelReferenceID,
            MachineID:oTempProductionSheet.MachineID,
            PerCartonFGQty:parseInt(icsRemoveComma($('#txtPerCartonFGQty').val())),
            ProductionRecipes:$('#tblProductionRecipe').datagrid('getRows')
        };
        return oProductionSheet;
    }

    $("#btnSave").click(function (){
        debugger;
        endEditing();
        if(!Validation()) return false;
        var oProductionSheet=RefreshObject();

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionSheet/Save",
            traditional: true,
            data:  JSON.stringify(oProductionSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oProductionSheet = jQuery.parseJSON(data);
                if (oProductionSheet.ErrorMessage==null || oProductionSheet.ErrorMessage=="")
                {
                    alert("Data Saved successfully");
                    var oProductionSheets = sessionStorage.getItem("ProductionSheets");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oProductionSheets != null) {
                        oProductionSheets = jQuery.parseJSON(oProductionSheets);
                    }
                    else {
                        oProductionSheets = [];
                    }
                    if (nIndex != -1) {
                        oProductionSheets[nIndex] = oProductionSheet;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oProductionSheets.length);
                        oProductionSheets.push(oProductionSheet);
                    }
                    sessionStorage.setItem("ProductionSheets", JSON.stringify(oProductionSheets));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oProductionSheet.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $("#btnApprove").click(function (){
        debugger;
        if(!Validation()) return false;
        if (!confirm("Confirm to Approve?")) return false;
        var oProductionSheet=RefreshObject();
        oProductionSheet.SheetStatusInInt = 1;//
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/ProductionSheet/Approve",
            traditional: true,
            data:  JSON.stringify(oProductionSheet),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                oProductionSheet = jQuery.parseJSON(data);
                if (oProductionSheet.ErrorMessage==null || oProductionSheet.ErrorMessage=="") {
                    alert("Approved successfully");
                    var oProductionSheets = sessionStorage.getItem("ProductionSheets");
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oProductionSheets != null) {
                        oProductionSheets = jQuery.parseJSON(oProductionSheets);
                    }
                    else {
                        oProductionSheets = [];
                    }
                    if (nIndex != -1) {
                        oProductionSheets[nIndex] = oProductionSheet;
                    }
                    else {
                        sessionStorage.setItem("SelectedRowIndex", oProductionSheets.length);
                        oProductionSheets.push(oProductionSheet);
                    }
                    sessionStorage.setItem("ProductionSheets", JSON.stringify(oProductionSheets));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else {
                    alert(oProductionSheet.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    ///Contractor Pick
    $("#txtContractorName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            var oContractor = { Params: 2 + '~' + $('#txtContractorName').val()+'~'+sessionStorage.getItem("BUID") };
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oContractor,
                ControllerName: "Contractor",
                ActionName: "ContractorSearchByNameType",
                IsWinClose: false
            };
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            var intervalID = setInterval(updateProgress, 250);
            $.icsDataGets(obj, function (response) {
                debugger;
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ContractorID > 0) {
                        debugger;
                        var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                        oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winContractors',
                            winclass: 'clsContractor',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblContractors',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'Name',
                            windowTittle: 'Contractor List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else { alert(response.objs[0].ErrorMessage); }
                }else{
                    alert("Data Not Found.");
                    return;
                }
            });
        }
    });
    $("#btnPickContractor").click(function () {
        var oContractor = { Params: "2~~"+sessionStorage.getItem("BUID") };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            debugger;
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winContractors',
                        winclass: 'clsContractor',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblContractors',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Contractor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });

    });
    $('#txtContractorName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtContractorName").removeClass("fontColorOfPickItem");
            $('#divPS').data('ProductionSheet').ContractorID = 0;
            $('#txtContractorName').val('');
        }
    });
    //Delivery to pick


    ///ProductionOrderDetail Pick
    $("#txtExportPINo").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtExportPINo').val())==null || $.trim($('#txtExportPINo').val())=="")
            {
                alert("Please Type PO No and Press Enter");
                return;
            }
            GetPTUDetails($.trim($('#txtExportPINo').val()));
        }
    });
    $("#btnPickPI").click(function () {
        GetPTUDetails($.trim($('#txtExportPINo').val()));
    });
    function GetPTUDetails(sPINo)
    {
        var oPTUUnit2 = {ExportPINo:sPINo,
            BUID:sessionStorage.getItem("BUID"),
            ProductNatureInInt:sessionStorage.getItem('ProductNature'),
            ContractorID: $('#divPS').data('ProductionSheet').ContractorID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPTUUnit2,
            ControllerName: "PTUUnit2",
            ActionName: "GetsPTUUnit",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            debugger;
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].PTUUnit2ID > 0) {
                    debugger;
                    var tblColums = []; var oColumn = { field: "ExportPINo", title: "PO No", width:150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductCode", title: "Product Code", width:80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Buyer", width: 150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "YetToProductionSheeteQtySt", title: "Qty", width:100, align: "right" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winPTUUnit2s',
                        winclass: 'clsPTUUnit2',
                        winwidth: 700,
                        winheight: 460,
                        tableid: 'tblPTUUnit2s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'ExportPINo',
                        windowTittle: 'PO List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
                return;
            }
        });
    }
    $('#txtExportPINo').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtExportPINo").removeClass("fontColorOfPickItem");
            $('#divPS').data('ProductionSheet').PTUUnit2ID = 0;
            $("#txtExportPINo,#txtExportPINo,#txtProdOrderQty,#txtYetToSheetQty").val('');
        }
    });
    //Delivery to pick

    $("#txtRecipeName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
            {
                alert('Sheet Quantity Should be Greater than 0.');
                return false;
            }

            if($.trim($('#txtRecipeName').val())==null || $.trim($('#txtRecipeName').val())=="")
            {
                alert("Please Type Recipe Name And Press Enter.");
                return;
            }
            DynamicRefreshList([], "tblRecipes");
            DynamicRefreshList([], "tblTempProductionRecipes");
            GetRecipes($.trim($('#txtRecipeName').val()));
            $("#winRecipePicker").icsWindow('open', "Recipe List");
        }
    });
    function GetRecipes(sRecipeName)
    {
        var oRecipe = {  RecipeName:sRecipeName,BUID:sessionStorage.getItem('BUID'),ProductNatureInInt:sessionStorage.getItem('ProductNature'),RecipeType:1};//RecipeType:1: Production, 2: consumption
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oRecipe,
            ControllerName: "Recipe",
            ActionName: "GetsRecipeByModelName",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            debugger;
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].RecipeID > 0) {
                    debugger;
                    $('#divPS').data('Recipes',response.objs);
                    DynamicRefreshList(response.objs, "tblRecipes");
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });
    }
    $("#btnPicRecipe").click(function () 
    {
        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
        {
            alert('Sheet Quantity Should be Greater than 0.');
            return false;
        }
        DynamicRefreshList([], "tblRecipes");
        DynamicRefreshList([], "tblTempProductionRecipes");
        GetRecipes($.trim($('#txtRecipeName').val()));
        $("#winRecipePicker").icsWindow('open', "Recipe List");
    });
    $('#txtRecipeName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtRecipeName").removeClass("fontColorOfPickItem");
            $("#txtRecipeName").val('');
            $('#divPS').data('ProductionSheet').RecipeID = 0;
        }
    });
    function OkButtonClickRecipe()
    {
        var oRecipe = $('#tblRecipes').datagrid('getSelected');
        if(oRecipe==null || parseInt(oRecipe.RecipeID)<=0)
        {
            alert("Please Select Recipe.");
            return;
        }
        $("#winRecipePicker").icsWindow('close');
        $('#txtRecipeName').val(oRecipe.RecipeName);
        $('#txtRecipeName').addClass('fontColorOfPickItem');
        $('#txtColorName').val(oRecipe.ColorName);
        $('#divPS').data('ProductionSheet').RecipeID= oRecipe.RecipeID;    
        var oProductionRecipeList = $('#tblTempProductionRecipes').datagrid('getChecked');
        RefreshProductionRecipeList(oProductionRecipeList);
        $('#txtRecipeName').focus();
    }
    //Machin Pick   
    $("#txtMachineName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtMachineName').val())==null || $.trim($('#txtMachineName').val())=="")
            {
                alert("Please Type Machine Name And Press Enter.");
                return;
            }
            GetMachines($.trim($('#txtMachineName').val()));
        }
    });
    $("#btnPickMachine").click(function () 
    {
        GetMachines("");
    });
    $('#txtMachineName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtMachineName").removeClass("fontColorOfPickItem");
            $("#txtMachineName").val('');
            $('#divPS').data('ProductionSheet').MachineID = 0;
        }
    });

    function GetMachines(sMachineName)
    {
        var oCapitalResource = {ResourcesTypeInInt:2,BUID:sessionStorage.getItem('BUID'),Name:sMachineName};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oCapitalResource,
            ControllerName:"CapitalResource",
            ActionName: "GetsCapitalResourceLastLayer",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].CRID > 0) {
                    debugger;
                    var tblColums = []; var oColumn = { field: "Name", title: "Machine Name", width:300, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winMachine',
                        winclass: 'clsMachine',
                        winwidth: 500,
                        winheight: 400,
                        tableid: 'tblMachine',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });
    }
    //Product Pick
    $("#txtProductName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($('#txtProductName').val()==null || $('#txtProductName').val()=="")
            {
                alert("Please Type Product and Press Enter.");
                $('#txtProductName').focus();
                return;
            }
            var oProduct = { BUID:sessionStorage.getItem('BUID'),ProductName:$('#txtProductName').val()};
            var obj = {
                BaseAddress: _sBaseAddress,
                Object: oProduct,
                ControllerName: "ProductionSheet",
                ActionName: "GetProducts",
                IsWinClose: false
            };
            $.icsDataGets(obj, function (response) {
                debugger;
                if (response.status && response.objs.length > 0) {
                    if (response.objs[0].ProductID > 0) {
                        var tblColums = []; var oColumn = { field: "NameCode", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);
                        var oPickerParam = {
                            winid: 'winProductPicker',
                            winclass: 'clsProductPicker',
                            winwidth: 600,
                            winheight: 460,
                            tableid: 'tblProductPicker',
                            tablecolumns: tblColums,
                            datalist: response.objs,
                            multiplereturn: false,
                            searchingbyfieldName: 'NameCode',
                            windowTittle: 'Product List'
                        };
                        $.icsPicker(oPickerParam);
                        IntializePickerbutton(oPickerParam);
                    }
                    else {
                        alert(response.objs[0].ErrorMessage);
                    }

                }else{
                    alert("Data Not Found.");
                }
            });
        }
    });
    $("#btnPickProduct").click(function () {
        var oProduct = { BUID: sessionStorage.getItem('BUID')};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "ProductionSheet",
            ActionName: "GetProducts",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = []; var oColumn = { field: "NameCode", title: "Product Name", width: 300, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winProductPicker',
                        winclass: 'clsProductPicker',
                        winwidth: 600,
                        winheight: 460,
                        tableid: 'tblProductPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'Product List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });

    });
    $('#txtProductName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtProductName").removeClass("fontColorOfPickItem");
            $('#txtProductName').val('');
            $('#divPS').data('ProductionSheet').ProductID = 0;
        }
    });

    //Mold Pick   
    $("#btnPickMold").click(function () 
    {
        var oCapitalResource = {ResourcesTypeInInt:1,BUID:sessionStorage.getItem('BUID'),Name:''};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oCapitalResource,
            ControllerName:"CapitalResource",
            ActionName: "GetsCapitalResourceLastLayer",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].CRID > 0) {
                    debugger;
                    var tblColums = []; var oColumn = { field: "Name", title: "Mold Name", width:300, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winCapitalResource',
                        winclass: 'clsCapitalResource',
                        winwidth: 500,
                        winheight: 400,
                        tableid: 'tblCapitalResource',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Mold List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
            }
        });
    });

    //Raw Material
    $("#btnPickRawMaterial").click(function ()
    {
        if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
        {
            alert('Sheet Quantity Should be Greater than 0.');
            return false;
        }
       
        GetRawMaterials("");
    });

    $("#txtRawMaterialName").keydown(function (e) {
        debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if(parseFloat(icsRemoveComma($('#txtQuantity').val()))<=0)
            {
                alert('Sheet Quantity Should be Greater than 0.');
                return false;
            }
           
            if($.trim($('#txtRawMaterialName').val())==null || $.trim($('#txtRawMaterialName').val())=="")
            {
                alert("Type Raw Material Name and Press Enter.");
                $('#txtRawMaterialName').focus();
                return;
            }
            //if(parseInt($('#cboQtyType').val())<=0)
            //{
            //    alert("Please select Qty Type!");
            //    $('#cboQtyType').focus();
            //    return;
            //}
            var sProductName = $.trim($('#txtRawMaterialName').val());
            GetRawMaterials(sProductName);
        }else if (code == 8) //backspace=8
        {
            //debugger;
            $("#txtRawMaterialName").removeClass("fontColorOfPickItem");
            $('#txtRawMaterialName').data('Product',null);
        }
    });
    function GetRawMaterials(sProductName)
    {
        var oProduct = {ProductName:sProductName, BUID:sessionStorage.getItem('BUID')};
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oProduct,
            ControllerName: "Recipe",
            ActionName: "SearchByProductBUModuleWise",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ProductID > 0) {
                    var tblColums = []; var oColumn = { field: "ProductCode", title: "Code", width: 100, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductName", title: "Product Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 130, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ProductCategoryName", title: "Category Name", width: 120, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winRawMaterialPicker',
                        winclass: 'clsRawMaterialPicker',
                        winwidth: 640,
                        winheight: 460,
                        tableid: 'tblRawMaterialPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'NameCode',
                        windowTittle: 'RawMaterial List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }

            }else{
                alert("Data Not Found.");
            }
        });
    }

    function AddRawMaterial()
    {
        var oSelectedProduct =  $('#txtRawMaterialName').data('Product');
        if(oSelectedProduct==null)
        {
            alert("Please select Product.");
            $('#txtRawMaterialName').focus();
            return;
        }
        if(parseInt($('#cboQtyType').val())<=0)
        {
            alert("Please select Qty Type!");
            $('#cboQtyType').focus();
            return;
        }

        var oProductionRecipes=$('#tblProductionRecipe').datagrid('getRows');
        if(!ICS_IsExist(oProductionRecipes,"ProductID",oSelectedProduct.ProductID))
        {
            var nQtyType = parseInt($('#cboQtyType').val())
            var oProductionRecipe = {
                ProductionRecipeID:0,
                ProductionSheetID:$('#divPS').data('ProductionSheet').ProductionSheetID,
                ProductID : oSelectedProduct.ProductID,
                QtyInPercent:0,
                RequiredQty : 0,
                QtyType :nQtyType,
                QtyTypeInt : nQtyType,
                QtyTypeSt:$('#cboQtyType option:selected').text(),
                Remarks :"",
                ProductCode  :oSelectedProduct.ProductCode,
                ProductName: oSelectedProduct.ProductName,
                MUnitID : oSelectedProduct.MeasurementUnitID,
                MUName :  oSelectedProduct.MUnit
            };
            $('#tblProductionRecipe').datagrid('appendRow',oProductionRecipe);
            GetsUnitConversionByProduct(oProductionRecipe.ProductID);
        }
        $('#txtRawMaterialName').data('Product',null);
        //$('#txtRawMaterialName').val('');
        $("#txtRawMaterialName").removeClass("fontColorOfPickItem");
        $('#cboQtyType').val(0);
        $('#cboQtyType').prop('disabled',true);
    }

     $("#btnRefreshDetail").click(function (){
        endEditing();
    });
    
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {
        debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
        if (oPickerobj.winid == 'winPTUUnit2s')
        {
            if (oreturnObj != null && oreturnObj.PTUUnit2ID > 0)
            {
                var oTempProductionSheet =  $('#divPS').data('ProductionSheet');
                $('#txtExportPINo').val(oreturnObj.ExportPINo);
                $('#txtContractorName').val(oreturnObj.ContractorName);
                $('#txtModelReferencenName').val(oreturnObj.ModelReferenceName);
                $('#txtProductName').val(oreturnObj.ProductName);
                $('#txtProdOrderQty').val(oreturnObj.ProdOrderQty);
                $('#txtUnitSymbol,#txtUnitSymbolRemainingQty,#txtUnitSymbolQty').val(oreturnObj.UnitSymbol);
                $('#txtYetToSheetQty').val(oreturnObj.YetToProductionSheeteQty);
                $('#txtFGWeightUnitSymbol,#txtNaliFGWeightUnitSymbol,#txtTotalFGWeightUnitSymbol').val(oreturnObj.FGUSymbol);
                $('#txtFGWeight').val(oreturnObj.FinishGoodsWeight);
                $('#txtNaliWeight').val(oreturnObj.NaliWeight);
                $('#txtWeightFor').val(oreturnObj.WeightFor);
                $('#txtTotalWeight').val(parseFloat(oreturnObj.FinishGoodsWeight)+parseFloat(oreturnObj.NaliWeight));                
                $('#txtExportPINo,#txtContractorName,#txtProductName,#txtModelReferencenName').addClass('fontColorOfPickItem');
                oTempProductionSheet.PTUUnit2ID = oreturnObj.PTUUnit2ID;
                oTempProductionSheet.ContractorID= oreturnObj.ContractorID;
                oTempProductionSheet.ProductID= oreturnObj.ProductID;
                oTempProductionSheet.ModelReferenceID= oreturnObj.ModelReferenceID;
                oTempProductionSheet.FGWeightUnitID= oreturnObj.FinishGoodsUnit;                
                $('#divPS').data('ProductionSheet',oTempProductionSheet);
                $('#txtExportPINo').focus();
            }
        }else  if (oPickerobj.winid == 'winContractors')
        {
            if (oreturnObj != null && oreturnObj.ContractorID > 0) {
                $('#txtContractorName').val(oreturnObj.Name);
                $('#txtContractorName').addClass('fontColorOfPickItem');
                $('#divPS').data('ProductionSheet').ContractorID= oreturnObj.ContractorID;
                $('#txtContractorName').focus();
            }
        }
       
        else if (oPickerobj.winid == 'winProductPicker')
        {
            if (oreturnObj != null && oreturnObj.ProductID > 0)
            {
                $('#txtProductName').val(oreturnObj.ProductName); 
                $('#txtProductName').addClass('fontColorOfPickItem');
                $('#txtFGWeightUnitSymbol,#txtNaliFGWeightUnitSymbol,#txtTotalFGWeightUnitSymbol').val(oreturnObj.FGUSymbol);
                $('#txtFGWeight').val(oreturnObj.FinishGoodsWeight);
                $('#txtNaliWeight').val(oreturnObj.NaliWeight);
                $('#txtWeightFor').val(oreturnObj.WeigthFor);
                $('#txtTotalWeight').val(parseFloat(oreturnObj.FinishGoodsWeight)+parseFloat(oreturnObj.NaliWeight));
                $('#divPS').data('ProductionSheet').ProductID = oreturnObj.ProductID;
                $('#divPS').data('ProductionSheet').FGWeightUnitID = oreturnObj.FinishGoodsUnit;
                $('#txtProductName').focus();
            }
        }
        else if (oPickerobj.winid=='winCapitalResource')
        {
            if (oreturnObj != null && oreturnObj.CRID > 0)
            {
                $('#txtModelReferencenName').val(oreturnObj.Name);
                $('#txtModelReferencenName').addClass('fontColorOfPickItem');
                $('#divPS').data('ProductionSheet').ModelReferenceID = oreturnObj.CRID;               
                $('#txtModelReferencenName').focus();
            }
        } else if (oPickerobj.winid=='winMachine')
        {
            if (oreturnObj != null && oreturnObj.CRID > 0)
            {
                $('#txtMachineName').val(oreturnObj.Name);
                $('#txtMachineName').addClass('fontColorOfPickItem');
                $('#divPS').data('ProductionSheet').MachineID = oreturnObj.CRID;
                $('#txtMachineName').focus();
            }
        }
        else if(oPickerobj.winid == 'winRawMaterialPicker')
        {
            if(oreturnObj!=null)
            {
                $("#txtRawMaterialName").val(oreturnObj.ProductName);
                $('#txtRawMaterialName').addClass('fontColorOfPickItem');
                $('#txtRawMaterialName').data('Product',oreturnObj);
                $('#cboQtyType').val(oreturnObj.QtyType);
                if(oreturnObj.QtyType!=0)
                {
                    $('#cboQtyType').prop('disabled',true);
                }else{
                    $('#cboQtyType').prop('disabled',false);
                }

            }
        } 
    }

    function RemoveRawMaterial()
    {        
        var oRawMaterialDetail = $('#tblProductionRecipe').datagrid('getSelected');
        if(oRawMaterialDetail==null)
        {
            alert("Please select a item from list!");
            return;
        }
        var conf = confirm("Confirm to delete?");
        if(conf==false)return;
        
        var SelectedRowIndex=$('#tblProductionRecipe').datagrid('getRowIndex',oRawMaterialDetail);
        $('#tblProductionRecipe').datagrid('deleteRow',SelectedRowIndex);
        RefreshGrid();
    }

    function RefreshGrid()
    {
        endEditing();
        data=$('#tblProductionRecipe').datagrid('getRows');
        data={"total":""+data.length+"","rows":data};
        $('#tblProductionRecipe').datagrid('loadData',data);
        $('#tblProductionRecipe').datagrid({selectOnCheck:false, checkOnSelect:false})
    }
    function GetsUnitConversion(nRecipeID)
    {
        var oUnitConversions = [];
        $('#divPS').data('UnitConversions', oUnitConversions);

        var oRecipe={
            RecipeID : nRecipeID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/MeasurementUnit/GetsUCByReceipe",
            data:  JSON.stringify(oRecipe),
            contentType: "application/json; charset=utf-8",
            success: function (data) {                
                var  oUnitConversions = jQuery.parseJSON(data);
                if(oUnitConversions.length>0)
                {
                    $('#divPS').data('UnitConversions', oUnitConversions);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function GetsUnitConversionByProduct(nProductID)
    {          
        var oProduct ={
            ProductID : nProductID
        };
        $.ajax ({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/MeasurementUnit/GetsUCByProduct",
            data:  JSON.stringify(oProduct),
            contentType: "application/json; charset=utf-8",
            success: function (data) {                
                var  oTempUnitConversions = jQuery.parseJSON(data);
                if(oTempUnitConversions.length>0)
                {
                    var oUnitConversions = $('#divPS').data('UnitConversions');
                    for(var i=0; i<oTempUnitConversions.length;i++)
                    {
                        oUnitConversions.push(oTempUnitConversions[i]);
                    }
                    $('#divPS').data('UnitConversions', oUnitConversions);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    }

    function ValidateInputDetail()
    {
        if(_oProduct==null || $('#txtProductName').val()=="")
        {
            $('#txtProductName').focus();
            $('#txtProductName').addClass("errorFieldBorder");
            alert('Select Product');
            return false;
        }
        if(_oProduct.IsApplyColor)
        {
            if(parseInt(_oColorCategory.ColorCategoryID)<=0)
            {
                $('#txtColorName').focus();
                $('#txtColorName').addClass("errorFieldBorder");
                alert('Select Color');
                return false;
            }
        }
       
        if($('#cboUnit').val()<=0)
        {
            $('#cboUnit').focus();
            alert('Select Unit.');
            return false;
        }
        if(_oProduct.IsApplyMeasurement)
        {
            if( $('#txtMeasurement').val()==""|| $('#txtMeasurement').val()==null)
            {
                $('#txtMeasurement').focus();
                $('#txtMeasurement').addClass("errorFieldBorder");
                alert('Select Measurement');
                return false;
            }
        }
        if(parseInt(icsRemoveComma($('#txtQty').val()))<=0)
        {
            $('#txtQty').focus();
            $('#txtQty').addClass("errorFieldBorder");
            alert('Qty Should be Greater than 0');
            return false;
        }
        if(parseFloat(icsRemoveComma($('#txtRate').val()))<=0)
        {
            $('#txtRate').focus();
            $('#txtRate').addClass("errorFieldBorder");
            alert('Rate Should be Greater than 0');
            return false;
        }
        return true;
    }

    function ResetDetail(){
        _oProduct = null;_oColorCategory = null;_oSizeCategory = null;
        $('#txtQty,#txtRate').val('');
        $('#txtColorQty').val(0);
        $('#txtProductName,#txtColorName,#txtProductDescription,#txtMeasurement,#txtStyleDescription,#txtBuyerRef').removeClass("fontColorOfPickItem");
        $('#txtProductName,#txtColorName,#txtProductDescription,#txtMeasurement,#txtStyleDescription,#txtBuyerRef').val("");
        
        var oUnits = [];
        $("#cboUnit").icsLoadCombo({List: oUnits,OptionValue: "MeasurementUnitID",DisplayText: "Symbol"});
        $('#txtProductName').focus();
    }

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

    $("#btnRemoveDetail").click(function () {

        var oProductionRecipe = $("#tblProductionRecipe").datagrid("getSelected");
        if (oProductionRecipe == null || parseInt(oProductionRecipe.ProductID) <= 0) { alert("Please select an item from list!"); return false; }
        if (!confirm("Confirm to Delete?")) return false;
        var SelectedRowIndex=$('#tblProductionRecipe').datagrid('getRowIndex',oProductionRecipe);
        alert("Data Delete Successfully.");
        $('#tblProductionRecipe').datagrid('deleteRow',SelectedRowIndex);
        SetTotal();
    });

    var editIndex = undefined;
    function endEditing(){
        if (editIndex == undefined){return true}
        if ($('#tblProductionRecipe').datagrid('validateRow', editIndex)){
            $('#tblProductionRecipe').datagrid('endEdit', editIndex);
            $('#tblProductionRecipe').datagrid('selectRow',editIndex);
            var oProductionRecipe=$('#tblProductionRecipe').datagrid('getSelected');
            if(oProductionRecipe!=null)
            {
                $('#tblProductionRecipe').datagrid('updateRow',{index: editIndex,	row: oProductionRecipe});
            }
            var oDetails = $('#tblProductionRecipe').datagrid('getRows');
            CalculateRequiredQty();
            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }
    function onClickRow(index){
        if (editIndex != index){
            if (endEditing())
            {
                $('#tblProductionRecipe').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else
            {
                $('#tblProductionRecipe').datagrid('selectRow', editIndex);
            }
        }
    }


   
</script>