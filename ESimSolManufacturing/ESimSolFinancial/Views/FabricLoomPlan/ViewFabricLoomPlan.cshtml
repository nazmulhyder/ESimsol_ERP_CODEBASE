@{
    ViewBag.Title = "Fabric Loom Plan(s)";
}
@model IEnumerable<ESimSol.BusinessObjects.FabricLoomPlan>

    <div class="menuMainCollectionTable">
        <table id="tblFabricLoomPlan" title="Fabric Loom Plan List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" data-options="resizable:true,checkOnSelect:false,selectOnCheck:false" toolbar="#toolbarFabricLoomPlan">
            @*<thead>
                <tr>
                    <th colspan="5" width="40%" align="left">Forecasting Coming Out</th>
                    <th colspan="11" align="left" width="107%">Programme Given</th>
                </tr>
            </thead>*@
            <thead>
                <tr>
                    <th colspan="5" width="360" align="left">Forecasting Coming Out</th>
                    <th colspan="13" align="left" width="780">Programme Given</th>
                </tr>
                <tr>
                    <th data-options="field:'Selected',checkbox:true"></th>
                    <th field="MachineName" width="100">Loom No</th>
                    <th field="Const_CO" width="120">Construction</th>
                    <th field="Shift_CO" width="80">Shift</th>
                    <th field="ReedCount_CO" width="80">Reed Count</th>
                    <th field="ExeNo" width="80">Dispo No</th>
                    <th field="BatchNo" width="80">Batch No</th>
                    <th field="StartTimeSt" width="110">Start Date</th>
                    <th field="EndTimeSt" width="110">End Date</th>
                    <th field="Construction" width="120">Construction</th>
                    <th field="PlanStatusSt" data-options="formatter:cellFormatterColor" width="80" align="left">Plan Status</th>
                    <th field="StatusSt" width="110">Batch Status</th>
                    <th field="ExeQtyInM" formatter="formatPrice" width="100" align="right">Execution Qty (M)</th>
                    <th field="FabricProgrameSt" width="80" align="left">Fab. Program</th>
                    <th field="ReedNo" width="80">ReedNo</th>
                    <th field="ContractorName" width="120">Customer</th>
                    <th field="NoOfColorWF" width="120">Construction</th>
                    <th field="Weave" width="80">Design</th>
                    <th field="Note" width="150" align="left">Remarks</th>
                    <th field="LowerUpperType" width="100" align="left">Type</th>
                </tr>
            </thead>

        </table>

        <div id="toolbarFabricLoomPlan">
            <input type="text" id="txtLoomNo" placeholder="Search by Loom No" style="width:150px;" />
            <a id="btnAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Adv. Search</a>
            @*<input type="text" id="txtSearchByDispoNo" placeholder="Search by Dispo No" style="width:150px;text-align:left" />*@            
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Add</a>
            @*<a id="btnNewPlan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">New Plan</a>*@
            <a id="btnProgramReport" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Program Report</a>
            <a id="btnCreateMultiplePlan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Create New Plan</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
        </div>
    </div>

    <div id="winDUFabricLoomPlan" style="width:800px;height:495px" class="easyui-window winstyle" title="Schedule Informations" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div style="padding-left:0px; padding-right:0px; padding-top:2px;">
            <fieldset>
                <legend>Order Info:</legend>
                <div>
                    <table cellpadding="1" cellspacing="1" style="font-size: 12px;width: 100%">
                        <tr>
                            <td style="width:15%;text-align:right;">
                                Dispo No:
                            </td>
                            <td style="width:35%;text-align:left;">
                                <select id="cboType" style="width:30%;height:22px;"><option value="1">Open</option><option value="2">Sizing Complete</option></select>
                                <input type="text" id="txtOrderNo" class="reset-text" placeholder="Search by Dispo No" style="width:55%" />
                                <a id="btnPickOrderNo" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                            </td>
                            <td style="width:15%;text-align:right;">
                                Buyer Name:
                            </td>
                            <td style="padding-left: 2px;width:35%;text-align:left">
                                <input id="txtBuyerName" type="text" style="width:100%"  disabled="disabled" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:15%;text-align:right;">
                                Construction:
                            </td>
                            <td style="width:35%;text-align:left;">
                                <input id="txtConstruction" class="reset-text" placeholder="Construction" style="width:100%" disabled="disabled" />
                            </td>
                            <td style="width:15%;text-align:right;">
                                Previous Const.n:
                            </td>
                            <td style="padding-left: 2px;width:35%;text-align:left">
                                <input id="txtPreviousConstruction" type="text" style="width:100%" disabled="disabled" />
                            </td>
                        </tr>
                        
                    </table>
                </div>
                
            </fieldset>
        </div>
        <div>
            <fieldset>
                <legend>Schedule Info:</legend>
                <div>
                    <table cellpadding="1" cellspacing="1" style="font-size: 12px;width: 100%">
                        <tr>
                            <td style="width:5%;text-align:right;"></td>
                            <td style="width:10%;text-align:right;">
                                Machine:
                            </td>
                            <td style="padding-left: 0px;width:30%;text-align:left">
                                <input id="txtMachine" style="width: 73% ; font-size: 11px;" placeholder="Search Machine" />
                                @*<a id="btnPickMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                <a id="btnResetMachine" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>*@
                            </td>
                            <td colspan="2" style="padding-right: 2px;width:50%;text-align:right;">
                                <div style="float: right; width:100%;">

                                    <span>
                                        <input type="button" id="btnScheduleLastTime" value="Default Time" style="font-size: 11px;
                                        height: 23px; width: 80px;" />
                                    </span><span>
                                        <input type="button" id="btnCurrenttime" value="Current Time" style="font-size: 11px;
                                        height: 23px; width: 80px;" />
                                    </span><span>
                                        <input id="tptimeSpinner" class="easyui-timespinner" style="width: 75px; height:20px; font-size: 11px;" required="required"
                                                data-options="showSeconds:false" />
                                    </span>
                                    <span>
                                        <input type="button" id="btnAddSpinnerTime" value="Add" style="font-size: 11px;
                                        height: 23px; width: 30px;" />
                                    </span>
                                </div>
                            </td>
                            <td style="width:5%;text-align:right;"></td>
                        </tr>
                        <tr>
                            <td style="width:5%;text-align:right;"></td>
                            <td style="width:10%;text-align:right;">
                                Start Time:
                            </td>
                            <td style="width:30%;">
                                @*<input id="txtStartDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                <input id="txtStartDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpStartTime" class="easyui-timespinner" style="width:60px;" required="required" />
                            </td>

                            <td style="width:20%;text-align:right;">
                                End Time:
                            </td>
                            <td style="padding-left: 2px;width:30%;">
                                @*<input id="txtEndDate" type="text" class="easyui-datetimebox" style="width:100%" data-options="showSeconds:false" />*@
                                <input id="txtEndDate" style="width:100px;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                <input id="tpEndTime" class="easyui-timespinner" style="width:60px;" required="required" />
                            </td>

                            <td style="width:5%;text-align:right;"></td>
                        </tr>

                    </table>

                </div>
            </fieldset>
            <fieldset>
                <legend></legend>
                   
                <div>
                    <table style="font-size: 12px;width: 100%">
                        <tr>
                            <td style="text-align:right;width:12%;">
                                <label>Fab. Program :</label>
                            </td>
                            <td style="text-align:left;width:39%;">
                                <select id="cboFabricProgram" style="width:100%;height:22px;"></select>
                            </td>
                            @*<td style="text-align:right;width:12%;">
                                <label>Plan Status :</label>
                            </td>*@
                            @*<td style="text-align:left;width:22%;">
                                <select id="cboPlanStatus" style="width:100%;height:22px;"></select>
                            </td>*@
                            <td style="text-align:right;width:10%;">
                                <label>Shift :</label>
                            </td>
                            <td style="text-align:left;width:39%;">
                                <select id="cboShift" style="width:100%;height:22px;"></select>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align:right;width:12%;">
                                <label>Note :</label>
                            </td>
                            <td colspan="3" style="width:88%;">
                                <input id="txtNote" class="reset-text" style="width:100%;" placeholder="Remarks.." />
                            </td>
                        </tr>
                    </table>

                </div>
            </fieldset>
        </div>
        <div id="divBeam" style="width: 100%; height:170px;">
            <table id="tblBeams" style="height:170px;" title="Beam List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarBeams">
                <thead>
                    <tr>
                        <th field="Construction" width="15%">Construction</th>
                        <th field="FEONo" width="12%">Dispo No</th>
                        <th field="BatchNo" width="12%">Batch No</th>
                        <th field="BuyerName" width="15%">Buyer</th>
                        <th field="BeamNo" width="12%">Beam No</th>
                        <th field="QtyInMtr" width="13%" align="right" formatter="formatPrice">Beam Length(M)</th>
                        <th field="IsDrawingSt" width="12%">Drawing/Leasing</th>
                    </tr>
                </thead>
            </table>
            <div id="toolbarBeams">
                <a id="btnDeleteBeam" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
            </div>
        </div>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="width:100%; font-size:11px; font-weight:bold;">
                <tr>
                    <td style="width:60%;text-align:left;">
                        <label id="lblPlanStatus">Plan Status :</label>
                        <select style="width:25%" id="cboPlanStatus"> </select>
                        <a id="btnUpdatePlanStatus" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true" style=" height:22px;">Update</a>
                    </td>
                    <td style="width:40%;text-align:right;">
                        @*<a id="btnAddFB" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Fabric Batch</a>*@
                        <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true" style=" height:22px;" onclick="Save()">Save</a>
                        <a id="btnClosePS" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
        @*<fieldset id="region-fabric-batch">
            <legend>Fabric Batch</legend>
            <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-3 text-right">
                    <label class="control-label">Fabric Batch(s):</label>
                </div>
                <div class="col-lg-8 col-md-8 col-sm-8">
                    <select id="cboFabricBatch" class="form-control"></select>
                    <label id="lblSingleFB" class="control-label"></label>
                    <a id="btnBatchCardPrint" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true"></a>
                </div>
            </div>
        </fieldset>*@
    </div>

    <div id="winAdvSearch" class="easyui-window winClass" style=" width:500px;" title=" adv. search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table style="width:100%;">
            <tr>
                <td>
                    <fieldset style="margin-bottom: 0px;">
                        <legend>Searching Criteria</legend>
                        <table>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Loom No : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <input id="txtLoomNoAdv" type="text" style="width:93%" />
                                </td>
                            </tr>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Dispo No : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <input id="txtExeNoAdv" type="text" style="width:93%" />
                                </td>
                            </tr>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Start Date : </label>
                                </td>
                                <td colspan="3">
                                    <select id="cboStartDateAdv" style="width:30%;height:22px;" onchange="DateActionsDateAdvSearch(); "></select>
                                    <input id="txtFromDateAdv" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                    <input id="txtToDateAdv" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                </td>
                            </tr>
                            
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Construction : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <input id="txtConstructionAdv" type="text" style="width:93%" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:20%;text-align:right;">
                                    <label>Fab. Program : </label>
                                </td>
                                <td colspan="3" style=" width:80%;text-align:left;">
                                    <select id="cboFabProgramAdv" style="width:93%;height:22px;"></select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:20%;text-align:right;">
                                    <label>Plan Status : </label>
                                </td>
                                <td colspan="3" style=" width:80%;text-align:left;">
                                    <select id="cboPlanStatusAdv" style="width:93%;height:22px;"></select>
                                </td>
                            </tr>


                            @*<tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Machine : </label>
                                </td>
                                <td colspan="3" style=" width:80%;text-align:left;">
                                    <input id="txtMachineName" style="width:78%;" type="text" placeholder="Type Machine Name & Press Enter" />
                                    <a id="btnMachinePiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                    <a id="btnClrMachinePiker" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                </td>
                            </tr>*@

                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Customer : </label>
                                </td>
                                <td colspan="3" style=" width:80%;text-align:left;">
                                    <input id="txtCustomerNameAdv" style="width:78%;" type="text" placeholder="Type Customer Name & Press Enter" />
                                    <a id="btnCustomerPikerAdv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                    <a id="btnClrCustomerPikerAdv" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-clear" plain="true"></a>
                                </td>
                            </tr>
                              
                            <tr>
                                <td height="5px" colspan="4"></td>
                            </tr>
                            @*<tr>
                                    <td class="btnResetSearch" colspan="4">
                                        <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
                                        <a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>
                                    </td>
                              </tr>*@
                        </table>
                    </fieldset>
                </td>
            </tr>
        </table>

        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <label class="lblLoadingMessage" style="float: left;">Loading Please Wait...</label>
            @*<a id="btnResetAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true">Reset</a>*@
            <a id="btnSearchAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Search</a>
            <a id="btnCloseAdvSearch" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>
        
    <div id="winCreateMultiplePlan" class="easyui-window winClass" style=" width:500px;" title="" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <table style="width:100%;">
            <tr>
                <td>
                    <fieldset style="margin-bottom: 0px;">
                        <legend>Create Multiple Plan</legend>
                        <table>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Dispo No : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <select id="cboType2" style="width:30%;height:22px;"><option value="1">Open</option><option value="2">Sizing Complete</option></select>
                                    <input type="text" id="txtOrderNo2" class="reset-text" placeholder="Search by Dispo No" style="width:60%" />
                                    <a id="btnPickOrderNo2" href="javascript:void(0)" class="easyui-linkbutton ics-pick" iconcls="icon-pick" plain="true"></a>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style=" width:100%;height:140px;">
                                    <table id="tblDispoForMultiple" style="height:130px;" title="Beam List" class="easyui-datagrid" fit="true" fitcolumn="true" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbarForMul"></table>
                                    <div id="toolbarForMul">
                                        <a id="btnDeleteForMultiple" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Start Time : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <input id="txtStartDate2" style="width:74%;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpStartTime2" class="easyui-timespinner" style="width:25%;" required="required" />
                                </td>
                            </tr>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>End Time : </label>
                                </td>
                                <td colspan="3">
                                    <input id="txtEndDate2" style="width:74%;" type="text" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    <input id="tpEndTime2" class="easyui-timespinner" style="width:25%;" required="required" />
                                </td>
                            </tr>
                            <tr>
                                <td style=" width:20%;text-align:right;">
                                    <label>Fab. Program : </label>
                                </td>
                                <td colspan="3" style="width:80%;text-align:left;">
                                    <select id="cboFabricProgram2" style="width:100%;height:22px;"></select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:20%;text-align:right;">
                                    <label>Shift : </label>
                                </td>
                                <td colspan="3" style=" width:80%;text-align:left;">
                                    <select id="cboShift2" style="width:100%;height:22px;"></select>
                                </td>
                            </tr>
                            
                            <tr>
                                <td height="5px" colspan="4"></td>
                            </tr>
                        </table>
                    </fieldset>
                </td>
            </tr>
        </table>
        <fieldset class="actionfieldsetstyle">
            <legend>Actions : </legend>
            <a id="btnCreatePlan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true">Create</a>
            <a id="btnClosePlan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
        </fieldset>
    </div>

    <script type="text/javascript">
    var _sBaseAddress="";
    var _oFabricLoomPlans=[];
    var _oAuthorizationRolesMapping=[];
    var _sMessage='';
    var _nNextStatus=-1;
    var _sMenuID=0;
    var _nContractorIDs="";
    var _sMenuID=0;
    var _nBUID = 0;
    var _sContractorIds = '';
    var _sProductIds = '';
    var _sDeliverToIDs = '';
    var _oIsAdd=false;
    var _oFabricLoomPlan={};
    var _nSelectedRowIndex=0;
    $(document).ready(function () {
        _oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _sBaseAddress = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _oFabricLoomPlans =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sMenuID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));
        _nBUID = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
        _oCompareOperators = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.CompareOperators));
        var oFabricWeaves = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricWeaves));
        var oPlanStatusList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.PlanStatusList));
        var oFabricProgrameList = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FabricProgrameList));
        var oHRMShifts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(@ViewBag.HRMShifts));
        debugger;
        RefreshControlLayout();
        DynamicRefreshList(_oFabricLoomPlans, 'tblFabricLoomPlan');
        $("#cboPlanStatus").icsLoadCombo({ List: oPlanStatusList, OptionValue: "id", DisplayText: "Value" });
        $("#cboFabricProgram,#cboFabricProgram2").icsLoadCombo({ List: oFabricProgrameList, OptionValue: "id", DisplayText: "Value" });
        $("#cboShift,#cboShift2").icsLoadCombo({List: oHRMShifts,OptionValue: "ShiftID",DisplayText: "ShiftWithDuration"});
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $(".lblLoadingMessage").hide();
        sessionStorage.setItem("ParamsSO", "");

        //adv search
        //$("#cboDesign").icsLoadCombo({List: oFabricWeaves, OptionValue: "FabricProcessID", DisplayText: "Name"});
        $("#cboPlanStatusAdv").icsLoadCombo({ List: oPlanStatusList, OptionValue: "id", DisplayText: "Value" });
        $("#cboFabProgramAdv").icsLoadCombo({ List: oFabricProgrameList, OptionValue: "id", DisplayText: "Value" });
        $("#winAdvSearch").data("MachineIDs","");
        $("#winAdvSearch").data("CustomerIDs","");
        $("#winAdvSearch").data("oAdvObject",null);
        $('#btnPast').hide();
        $('#tblFabricLoomPlan').datagrid({ onSelect: function (rowIndex, rowData) { OpenAttHistory(rowIndex, rowData); } });
        function OpenAttHistory(rowIndex, rowData) {

        }

        $("#winCreateMultiplePlan").data("OpenList", []);
        $("#winCreateMultiplePlan").data("SizingCompleteList", []);
    });
    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }
    $(document).keydown(function (e) { if (e.keyCode == 27) { $('#winFabricLoomPlanOrder').icsWindow('close'); } });


    $('#tblFabricLoomPlan').datagrid({ onSelect: function (rowIndex, rowData) { OperationPerforms(rowIndex, rowData); } });

    function OperationPerforms(rowIndex, rowData)
    {
        if (rowData != null && rowData.FLPID > 0)
        {
            if (rowData.OrderStatus==1 )  //Initialized = 1,
            {

            }
            //$('#btnCancel,#btnUndo,#btnAdd,#btnEdit,#btnDelete').hide();
            ////if (rowData.OrderStatus==1 )  //Initialized = 1,
            ////{
            //$('#btnAdd,#btnEdit,#btnDelete,#btnOrderStatus').show();
            //_nNextStatus=2;
            //_sMessage="send an approval request.";
            //$('#lblOrderStatus').text(' Approve');
        }
    }

    function cellFormatterColor(value,row,index) {
        //debugger;
        if(row.PlanStatus == 1)
            return "<table style='width:100%;background-color:#0EF622;'><tr><td style='border: 0px'>" + row.PlanStatusSt  + "</td></tr></table>";
        else if(row.PlanStatus == 2)
            return "<table style='width:100%;background-color:#EE7CC8;'><tr><td style='border: 0px'>" + row.PlanStatusSt  + "</td></tr></table>";
        else return row.PlanStatusSt;
    }


    /*------------------------------------*/

    $('#btnEdit').click(function (e)
    {
        debugger;
        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        if (oFabricLoomPlan ==null) { alert("Please select an item from list."); return ; }
        if (oFabricLoomPlan.FMID <=0 ) { alert("Machine Not Found!!"); return ; }
        _nSelectedRowIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
        ResetLoomPlanDiv();
        _oFabricLoomPlan = oFabricLoomPlan;
        if (oFabricLoomPlan.FLPID <=0){
            $("#cboPlanStatus").hide();
            $("#btnUpdatePlanStatus").hide();
            $("#lblPlanStatus").hide();
            RefreshScheduleInfo(oFabricLoomPlan);
        }else{
            $("#cboPlanStatus").show();
            $("#btnUpdatePlanStatus").show();
            $("#lblPlanStatus").show();
            SetLoomPlanDiv();
        }
        if(oFabricLoomPlan.Const_CO == "" || oFabricLoomPlan.Const_CO == null){
            SetPreviousConstruction(oFabricLoomPlan.FMID);
        }else{
            $("#txtPreviousConstruction").val(oFabricLoomPlan.Const_CO);
        }

        $("#winDUFabricLoomPlan").icsWindow("open", "Schedule Entry");
        if(_oFabricLoomPlan.FabricLoomPlanDetails.length <= 0){
            DynamicRefreshList([],"tblBeams");
            $("#cboType").val(1);
        }
        else{
            //document.getElementById('winDUFabricLoomPlan').setAttribute("style","height:495px");
            //document.getElementById("winDUFabricLoomPlan").style.display = "block";
            DynamicRefreshList(_oFabricLoomPlan.FabricLoomPlanDetails,"tblBeams");
            $("#cboType").val(2);
        }
    });

    //$('#btnNewPlan').click(function (e)
    //{
    //    debugger;
    //    var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
    //    if (oFabricLoomPlan ==null) { alert("Please select an item from list."); return ; }
    //    if (oFabricLoomPlan.FMID <=0 ) { alert("Machine Not Found!!"); return ; }
    //    _nSelectedRowIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
    //    ResetLoomPlanDiv();
    //    _oFabricLoomPlan = oFabricLoomPlan;
    //    _oFabricLoomPlan.FabricLoomPlanDetails = [];

    //    //SetLoomPlanDiv();
    //    $("#txtMachine").val(_oFabricLoomPlan.MachineName);
    //    $("#cboPlanStatus").val(1);
                
    //    DynamicRefreshList([],"tblBeams");
    //    $("#cboType").val(1);

    //    $("#winDUFabricLoomPlan").icsWindow("open", "Schedule Entry");        
    //});

    //$('#cboType').change(function(e){
    //    if($("#cboType").val() == 1){
    //        $("#divBeam").hide();
    //        document.getElementById('winDUFabricLoomPlan').setAttribute("style","height:325px");
    //        document.getElementById("winDUFabricLoomPlan").style.display = "block";
    //        DynamicRefreshList([],"tblBeams");
    //    }
    //    else{
    //        $("#divBeam").show();
    //        document.getElementById('winDUFabricLoomPlan').setAttribute("style","height:495px");
    //        document.getElementById("winDUFabricLoomPlan").style.display = "block";
    //        DynamicRefreshList([],"tblBeams");
    //    }
    //});

    function SetPreviousConstruction(nFMID){
        if(nFMID > 0){
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: _sBaseAddress + "/FabricLoomPlan/GetPreviousConstruction",
                data: { nFMID: _oFabricLoomPlan.FMID ,  nts:nts },
                contentType: "application/json; charset=utf-8",
                success: function(data)
                {
                    ////debugger;
                    var oFabricBatchLoom = jQuery.parseJSON(data);
                    if(oFabricBatchLoom.FabricBatchLoomID > 0){
                        $("#txtPreviousConstruction").val(oFabricBatchLoom.Construction);
                    }
                },
                error: function(xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    }

    function ResetLoomPlanDiv(){
        _oFabricLoomPlan = {};
        $("#txtOrderNo").val("");
        $("#txtBuyerName").val("");
        $("#txtConstruction").val("");
        $("#txtPreviousConstruction").val("");
        $("#txtMachine").val("");
        $("#txtNote").val("");
        $("#cboFabricProgram").val(0);
        $("#cboPlanStatus").val(0);
        $("#cboShift").val(0);
        $('#tpStartTime').timespinner('setValue', "0:0");
        $('#txtStartDate').datebox('setValue', icsdateformat(new Date()));
        $('#tpEndTime').timespinner('setValue', "0:0");
        $('#txtEndDate').datebox('setValue', icsdateformat(new Date()));
    }

    function SetLoomPlanDiv(){
        $("#txtOrderNo").val(_oFabricLoomPlan.ExeNo);
        $("#txtBuyerName").val(_oFabricLoomPlan.BuyerName);
        $("#txtConstruction").val(_oFabricLoomPlan.Construction);
        //$("#txtStyleNo").val(_oFabricLoomPlan.StyleNo);
        $("#txtMachine").val(_oFabricLoomPlan.MachineName);
        $("#txtNote").val(_oFabricLoomPlan.Note);
        $("#cboFabricProgram").val(_oFabricLoomPlan.FabricPrograme);
        $("#cboPlanStatus").val(_oFabricLoomPlan.PlanStatus);
        $("#cboShift").val(_oFabricLoomPlan.ShiftID);

        $('#tpStartTime').timespinner('setValue', _oFabricLoomPlan.StartTimeTS);
        $('#txtStartDate').datebox('setValue', _oFabricLoomPlan.StartDateSt);
        $('#tpEndTime').timespinner('setValue', _oFabricLoomPlan.EndTimeTS);
        $('#txtEndDate').datebox('setValue', _oFabricLoomPlan.EndDateSt);

    }

    function RefreshScheduleInfo(oFabricLoomPlan){
        if(oFabricLoomPlan.FMID > 0){
            $("#txtMachine").val(oFabricLoomPlan.MachineName);
            $("#cboPlanStatus").val(1);
            SetLastScheduleTime();
        }
    }

    //$('#btnEdit').click(function (e)
    //{
    //    _oIsAdd=false;
    //    var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
    //    if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }
    //    var nIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
    //    _nSelectedRowIndex=nIndex;
    //    $.ajax({
    //        type: "POST",
    //        url: _sBaseAddress + "/FabricLoomPlan/GetPS",
    //        traditional: true,
    //        data: JSON.stringify(oFabricLoomPlan),
    //        contentType: "application/json; charset=utf-8",
    //        success: function (data) {
    //            debugger;
    //            var oFabricLoomPlan = jQuery.parseJSON(data);
    //            RefreshControl(oFabricLoomPlan);
    //            $("#winDUFabricLoomPlan").icsWindow("open", "Schedule Entry");
    //            $("#cboPlanStatus").show();
    //            $("#btnUpdatePlanStatus").show();
    //            $("#lblPlanStatus").show();
    //        }
    //    });

    //});
    function RefreshControl(oFabricLoomPlan)
    {
        debugger;
        _oFabricLoomPlan=oFabricLoomPlan;
        if(oFabricLoomPlan.FLPID>0)
        {
            $('#tpStartTime').timespinner('setValue', oFabricLoomPlan.StartTimeTS);
            $('#txtStartDate').datebox('setValue', oFabricLoomPlan.StartDateSt);

            $('#tpEndTime').timespinner('setValue', oFabricLoomPlan.EndTimeTS);
            $('#txtEndDate').datebox('setValue', oFabricLoomPlan.EndDateSt);

            $("#txtScheduleNo").val(oFabricLoomPlan.ScheduleNo);
            $("#txtMachine").val(oFabricLoomPlan.MachineName);
            $("#txtNote").val(oFabricLoomPlan.Note);
            $("#txtWarpBeam").val(oFabricLoomPlan.WarpBeam);
            $("#cboPlanStatus").val(oFabricLoomPlan.PlanStatus);
        }
        else{
            $("#txtMachine").val("");
            //$("#divFabricLoomPlan").data("MachineID",0);
            $("#txtNote").val("");
            $("#txtWarpBeam").val("");
        }
        $("#cboPriority").val(oFabricLoomPlan.Priority);
        $("#txtOrderNo").val(oFabricLoomPlan.ExeNo);
        $("#txtBuyerName").val(oFabricLoomPlan.ContractorName);
        $("#txtConstruction").val(oFabricLoomPlan.Construction);
        $("#txtComposition").val(oFabricLoomPlan.Composition);
        $("#txtDesign").val(oFabricLoomPlan.Weave);

        $("#txtQtyOrderY").val(formatPrice(oFabricLoomPlan.OrderQty));
        $("#txtQtyOrderM").val(formatPrice(GetMeter(oFabricLoomPlan.OrderQty,2)));

        $("#txtGreyTargetQtyUSInMeter").val(formatPrice(parseFloat(oFabricLoomPlan.GreigeDemand).toFixed(1)));
        $("#txtGreyTargetQtyUS").val(formatPrice(parseFloat(oFabricLoomPlan.GreigeDemand*1.09361).toFixed(1)));

        $("#txtRequireWarpLengthUSInMeter").val(oFabricLoomPlan.RequiredWarpLength);
        $("#txtRequireWarpLengthY").val(formatPrice(parseFloat(oFabricLoomPlan.RequiredWarpLength*1.09361).toFixed(1)));

        $("#txtLengthInWeavingM").val(oFabricLoomPlan.TFLength);
        $("#txtLengthInWeavingY").val(formatPrice(parseFloat(oFabricLoomPlan.TFLength*1.09361).toFixed(1)));

        $('#txtWeftColor').val(oFabricLoomPlan.WeftColor);
        $('#txtWarpColor').val(oFabricLoomPlan.WarpColor);

        //var nMeterQty = GetMeter(oFabricLoomPlan.Qty,2);

        //$('#txtQty').numberbox({min:0, precision:2 });
        $('#txtQty').numberbox({onChange:ConvertIntoYards,min:0, precision:2 });
        $('#txtYardQty').numberbox({min:0, precision:2 });

        $('#txtQty').numberbox('setValue',oFabricLoomPlan.Qty);
        $('#txtYardQty').numberbox('setValue',GetYard(oFabricLoomPlan.Qty,2));

        $('#region-fabric-batch').hide();
        $('#btnBatchCardPrint').hide();
        if(oFabricLoomPlan.FLPID>0){
            GetsFabricBatch(oFabricLoomPlan.FLPID);
            $("#btnAddFB").show();
        }
        else{

            $("#btnAddFB").hide();
        }
    }

    $('#txtStartDate').datebox({
        onSelect: function(date){
            //alert(date.getFullYear()+":"+(date.getMonth()+1)+":"+date.getDate());
            debugger;
            var oDate = new Date(date);
            oDate.setHours(new Date().getHours());
            oDate.setMinutes(new Date().getMinutes());

            var nHour=oDate.getHours();
            var nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);

            oDate.setMinutes(oDate.getMinutes() + 10);
            $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
            nHour=oDate.getHours();
            nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpEndTime').timespinner('setValue', nHour+":"+nMin);
        }
    });

    function ConvertIntoYards()
    {

        var nQtyInMeter= $('#txtQty').numberbox('getValue');
        var nQtyInYards= nQtyInMeter*1.09361;
        $('#txtYardQty').numberbox('setValue',nQtyInYards.toFixed(2));
    }

    //$("#btnCancel").click(function(){

    //    var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
    //    if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }

    //    var nIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
    //    sessionStorage.setItem("Operation", "Cancel");
    //    sessionStorage.setItem("SelectedRowIndex", nIndex);
    //    sessionStorage.setItem("FabricLoomPlanHeader", "Cancel Production");
    //    sessionStorage.setItem("FabricLoomPlans", JSON.stringify($('#tblFabricLoomPlan').datagrid('getRows')));
    //    sessionStorage.setItem("BackLink", window.location.href);
    //    var tsv=((new Date()).getTime())/1000;
    //    window.location.href = _sBaseAddress+ "/FabricLoomPlan/ViewFabricLoomPlan?nId="+oFabricLoomPlan.FLPID+"&ts="+tsv;

    //});
    $('#btnDelete').click(function(e){
        debugger;
        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        oFabricLoomPlan.StartTime = new Date(oFabricLoomPlan.StartTimeSt); //icsdateformat(oFabricLoomPlan.StartTimeSt);
        oFabricLoomPlan.EndTime = new Date(oFabricLoomPlan.EndTimeSt); //icsdateformat(oFabricLoomPlan.EndTimeSt);
        if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }
        if (!confirm("Confirm to delete?")) return;
        sessionStorage.clear();
        var obj =
        {
            BaseAddress: _sBaseAddress,
            Object: oFabricLoomPlan,
            ControllerName: "FabricLoomPlan",
            ActionName: "Delete",
            TableId: "tblFabricLoomPlan",
            IsWinClose: false
        };
        $.icsDelete(obj);

    });
    $('#btnCut').click(function(e){
        debugger;

        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        oFabricLoomPlan.StartTime = new Date(oFabricLoomPlan.StartTimeSt); //icsdateformat(oFabricLoomPlan.StartTimeSt);
        oFabricLoomPlan.EndTime = new Date(oFabricLoomPlan.EndTimeSt); //icsdateformat(oFabricLoomPlan.EndTimeSt);
        if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }

        _oFabricLoomPlan=oFabricLoomPlan;

        var SelectedRowIndex = $('#tblFabricLoomPlan').datagrid('getRowIndex', oFabricLoomPlan);
        $('#tblFabricLoomPlan').datagrid('deleteRow',SelectedRowIndex);
        $('#btnPast').show();
        $('#btnCut').hide();

    });
    $('#btnPast').click(function(e)
    {
        if(_oFabricLoomPlan==null|| _oFabricLoomPlan.FLPID<=0){alert("Nothing found for paste."); return;}
        //if(_oFabricLoomPlan.FMID<=0)
        //{
        //    alert("Select Machine from List.");
        //    return;
        //}
        debugger;

        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        oFabricLoomPlan.StartTime = new Date(oFabricLoomPlan.StartTimeSt); //icsdateformat(oFabricLoomPlan.StartTimeSt);
        oFabricLoomPlan.EndTime = new Date(oFabricLoomPlan.EndTimeSt); //icsdateformat(oFabricLoomPlan.EndTimeSt);
        if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }

        var nIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
        var dStartDate =oFabricLoomPlan.EndTimeSt;
        var startTime=oFabricLoomPlan.EndTimeSt;


        //if(_oFabricSizingPlan.FabricSizingPlanID<=0)
        //{
        //    var dStartDate =$('#txtStartDate').datebox('getValue');
        //    var startTime= $('#tpStartTime').timespinner('getValue');
        //}
        //else{
        //    var dStartDate =_oFabricSizingPlan.EndDateSt;
        //    var startTime=_oFabricSizingPlan.EndTimeTS;
        //}

        if(_oFabricLoomPlan.FMID<=0){
            alert("Invalid Machine !"); return;
        }
        if(oFabricLoomPlan.FMID<=0){
            alert("Invalid Machine !"); return;
        }

        var oFabricWP=
            {
                FLPID: (oFabricLoomPlan!=null &&oFabricLoomPlan.FLPID>0)? oFabricLoomPlan.FLPID:0,
                FMID:oFabricLoomPlan.FMID,
                BUID:sessionStorage.getItem('BUID'),
                Params:oFabricLoomPlan.FLPID+'~'+_oFabricLoomPlan.FLPID+'~'+dStartDate+"~"+startTime
            };

        //debugger;

        var nts=(new Date()).getTime()/1000;
        {
            //var sPSIDs=;
            $.ajax({
                type: "Post",
                dataType: "json",
                url: _sBaseAddress + "/FabricLoomPlan/PastSchedule",
                traditional: true,
                data:   JSON.stringify(oFabricWP),///{sPSIDs : sPSIDs, nts:nts}),
                contentType: "application/json; charset=utf-8",
                success: function (data)
                {
                    debugger;
                    var oresults=jQuery.parseJSON(data);
                    if(oresults[0].ErrorMessage=="" || oresults[0].ErrorMessage==null)
                    {
                        debugger;
                        alert("Paste Successfully");
                        var  oFabricLoomPlans=$('#tblFabricLoomPlan').datagrid('getRows');
                        // Replace with `33`
                        nIndex=nIndex+1;
                        if ( nIndex >= 0 ) {
                            oFabricLoomPlans.splice( nIndex, 0, oresults[0] );

                            DynamicRefreshList(oFabricLoomPlans, 'tblFabricLoomPlan');
                            $('#tblFabricLoomPlan').datagrid('selectRow', nIndex);
                        }

                        $('#btnCut').show();
                        $('#btnPast').hide();
                        //function move(array, oldIndex, newIndex) {
                        //    if (newIndex >= array.length) {
                        //        newIndex = array.length - 1;
                        //    }
                        //    array.splice(newIndex, 0, array.splice(oldIndex, 1)[0]);
                        //    return array;
                        //}

                        //var idx = data.indexOf(32);

                        //// Replace with `33`
                        //if ( idx >= 0 ) {
                        //    data.splice( idx, 0, 33 );
                        //}


                    }
                    else {alert(oresults[0].ErrorMessage);}
                    //alert(sMessage);
                    //if(sMessage=="Swap Successfully") { Refresh(); }

                },
                error: function (xhr, status, error) {alert(error);}
            });
        }
    });

    $('#btnSwap').click(function(e)
    {
        var oRows =  $('#tblFabricLoomPlan').datagrid('getChecked');
        if(oRows.length != 2){
            alert("Please select only two items!!");
            return;
        }
        for(var i=0;i<oRows.length;i++){
            if(oRows[i].FMID<=0){
                alert("Invalid Machine For Dispo No: "+oRows[i].ExeNo+" !"); return;
            }
            oRows[i].StartTime = new Date(oRows[i].StartTimeSt); //icsdateformat(oFabricSizingPlan.StartTimeSt);
            oRows[i].EndTime = new Date(oRows[i].EndTimeSt); //icsdateformat(oFabricSizingPlan.EndTimeSt);
        }

        if(!confirm("Are you sure want to swap?"))
            return false;

        var nIndex1=$('#tblFabricLoomPlan').datagrid('getRowIndex',oRows[0]);
        var nIndex2=$('#tblFabricLoomPlan').datagrid('getRowIndex',oRows[1]);

        var oFabricWP=
            {
                Params: oRows[0].FLPID+'~'+oRows[1].FLPID //+'~'+dStartDate+"~"+startTime
            };

        debugger;
        $.ajax({
            type: "Post",
            dataType: "json",
            url: _sBaseAddress + "/FabricLoomPlan/SwapTwoSchedule",
            traditional: true,
            data:   JSON.stringify(oFabricWP),
            contentType: "application/json; charset=utf-8",
            success: function (data)
            {
                debugger;
                var oresults=jQuery.parseJSON(data);
                if(oresults[0].ErrorMessage=="" || oresults[0].ErrorMessage==null)
                {
                    debugger;
                    alert("Swap Successfully");

                    $('#tblFabricLoomPlan').datagrid('updateRow',{index: nIndex1,row: oresults[1]});
                    $('#tblFabricLoomPlan').datagrid('updateRow',{index: nIndex2,row: oresults[0]});

                    $('#tblFabricLoomPlan').datagrid('selectRow', nIndex1);
                }
                else {alert(oresults[0].ErrorMessage);}
            },
            error: function (xhr, status, error) {alert(error);}
        });


    });

    //$('#btnView').click(function (e)
    //{
    //    var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
    //    if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select an item from list."); return ; }

    //    var nIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);

    //    sessionStorage.clear();
    //    sessionStorage.setItem("Operation", "View");
    //    sessionStorage.setItem("SelectedRowIndex", nIndex);
    //    sessionStorage.setItem("DOHeader", "View Order");
    //    sessionStorage.setItem("FabricLoomPlans", JSON.stringify($('#tblFabricLoomPlan').datagrid('getRows')));
    //    sessionStorage.setItem("BackLink", window.location.href);
    //    var tsv=((new Date()).getTime())/1000;
    //    window.location.href = _sBaseAddress+ "/FabricLoomPlan/ViewFabricLoomPlan?nId="+oFabricLoomPlan.FLPID+"&ts="+tsv;;
    //});



    //////////////
    $("#btnPickOrderNo").click(function ()
    {
        if($('#cboType').val() == 1){
            var oPSDetail = {
                FEONo:$('#txtOrderNo').val()
            };
            GetOrders(oPSDetail);
        }else{
            var oFabricBatchLoom={
                Status : 3,
                FEONo: ""
            };
            SearchFBPB(oFabricBatchLoom);
        }

    });

    $("#txtOrderNo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNo").val());
            if($('#cboType').val() == 1){
                if(sorderNo == ""){
                    alert("Please enter Order No!!");
                    $('#txtOrderNo').focus()
                    return;
                }
                var oPSDetail = {
                    FEONo:sorderNo
                };
                GetOrders(oPSDetail);
            }else{
                var oFabricBatchLoom={
                    Status : 3,
                    FEONo: sorderNo
                };
                SearchFBPB(oFabricBatchLoom);
            }

        }
        else if(nkeyCode==8){
            _oFabricLoomPlan.FSCDID=0;
            _oFabricLoomPlan.FBID=0;
        }
    });
    $("#txtOrderNoTwo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNoTwo").val());

            if (sorderNo=="" ||sorderNo==null)
            {

                alert("Please Type Order no.");
                $('#txtOrderNoTwo').focus();
                $('#txtOrderNoTwo').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#txtOrderNoTwo').removeClass("errorFieldBorder");
            }

            var oPSDetail = {
                OrderType:0,
                OrderNo:$('#txtOrderNoTwo').val(),
                LabDipDetailID:0,
                DODID:0
            };
            GetOrdersTwo(oPSDetail);
        }
        else if(nkeyCode==8){

        }
    });

    $("#txtBatchNoTwo").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sRouteSheetNo=$.trim($("#txtBatchNoTwo").val());

            if (sRouteSheetNo=="" ||sRouteSheetNo==null)
            {

                alert("Please Type Batch no.");
                $('#txtBatchNoTwo').focus();
                $('#txtBatchNoTwo').addClass("errorFieldBorder");
                return;
            }
            else{
                $('#txtBatchNoTwo').removeClass("errorFieldBorder");
            }

            SearchDO("",sRouteSheetNo);
        }
        else if(nkeyCode==8){

        }
    });


    $("#btnResetOrderNo").click(function ()
    {
        $("#txtOrderNo").val("");
    });

    function SearchFBPB(oFabricBatchLoom)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatchLoom,
            ControllerName: "FabricLoomPlan",
            ActionName: "SearchFBPB",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "OrderNo", title: "Dispo No", width: 100, align: "left" };tblColums.push(oColumn);
                    var oColumn = { field: "BeamNo", title: "Beam No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BatchNo", title: "Batch No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "QtyInMtr", title: "Qty (M) ", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "IsDrawingSt", title: "Drawing/Leasing", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FSpcTypeSt", title: "Spec. Type", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "LowerUpperType", title: "Type", width: 100, align: "left" };tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winBeamPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 800,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List',
                        placeholder : "Search By Dispo No"
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });
    }

    function GetOrders(oPSDetail)
    {
        debugger;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetFabricBatches",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    debugger;
                    var tblColums = [];

                    var oColumn = { field: "FEONo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    var oColumn = { field: "BatchNo", title: "Batch No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buyer", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction ", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "StyleNo", title: "Style No ", width: 120, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "ColorName", title: "Color", width: 100, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "TFLength", title: "T/F Length", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    //oColumn = { field: "LengthReaming", title: "Remaing Length", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    //oColumn = { field: "RequiredWarpLength", title: "Required Warp Length", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    //oColumn = { field: "Qty_FWP", title: "Warping Qty", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "QtyInM", title: "Qty(M)", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    oColumn = { field: "LowerUpperType", title: "Type", width: 120, align: "left" };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPicker',
                        winclass:'clsOrderPicker',
                        winwidth: 820,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }

    function GetOrdersTwo(oPSDetail)
    {

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetsFabricExecutionSpe",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FEOSID > 0) {
                    //debugger;
                    var tblColums = [];

                    var oColumn = { field: "ExeNo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "ContractorName", title: "Customer", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Composition", title: "Composition ", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Weave", title: "Design", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "RequiredWarpLength", title: "Required Warp Length", width: 75, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPickerTwo',
                        winclass:'clsOrderPicker',
                        winwidth: 1000,
                        winheight: 660,
                        tableid: 'tblOrderPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });


    }
    $("#btnResetMachine").click(function () {

        $("#txtMachine").val("");
        _oFabricLoomPlan.FMID=0;
    });

    $("#btnPickMachine").click(function () {

        var sMachineName=$.trim($("#txtMachine").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachines(sMachineName);
    });

    $("#txtMachine").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachine").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachines(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachine").val("");
            _oFabricLoomPlan.FMID=0;
        }
    });
    function GetMachines(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem('BUID'),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetsMachine",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FMID > 0) {
                    //debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "Capacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "SequenceNo", title: "SL No", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMachinePicker',
                        winclass:'clsMachinePicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinePicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });


    }


    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function SetPickerValueAssign(oPickerobj) {
        //debugger;
        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        //$("#" + oPickerobj.winid).icsWindow("close");
        //$("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid == 'winLabDipPicker')
        {
            if (oreturnObj != null && oreturnObj.LabDipDetailID > 0)
            {
                $('#txtColorNo').val(oreturnObj.ColorNo);
                //$('#txtColorName').val(oreturnObj.ColorName);
                $('#txtLabdipNo').val(oreturnObj.LabdipNo);
                _nLabDipDetailID= oreturnObj.LabDipDetailID;
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winMachinePicker')
        {debugger;
            if(oreturnObj !=null  && oreturnObj.FMID>0){

                $('#txtMachine').val(oreturnObj.Name);
                _oFabricLoomPlan.FMID= oreturnObj.FMID;
                SetLastScheduleTime();
            }
            else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winMachinesPicker')
        {
            if(oreturnobjs.length > 0){
                if(oreturnobjs.length == 1){
                    $("#txtMachineName").val(oreturnobjs[0].Name);
                    $("#winAdvSearch").data("MachineIDs",oreturnobjs[0].FMID);
                }else{
                    var ids = "";
                    for(var i=0;i<oreturnobjs.length;i++){
                        ids += oreturnobjs[i].FMID + ",";
                    }
                    if(ids.length > 0) ids = ids.substring(0, ids.length-1);
                    $("#txtMachineName").val("You select " + oreturnobjs.length + " Machines");
                    $("#winAdvSearch").data("MachineIDs",ids);
                }
            }else{
                alert("Please select machine.");
            }
        }
        else if (oPickerobj.winid == 'winCustomersPicker')
        {
            if(oreturnobjs.length > 0){
                if(oreturnobjs.length == 1){
                    $("#txtCustomerNameAdv").val(oreturnobjs[0].Name);
                    $("#winAdvSearch").data("CustomerIDs",oreturnobjs[0].ContractorID);
                }else{
                    var ids = "";
                    for(var i=0;i<oreturnobjs.length;i++){
                        ids += oreturnobjs[i].ContractorID + ",";
                    }
                    if(ids.length > 0) ids = ids.substring(0, ids.length-1);
                    $("#txtCustomerNameAdv").val("You select " + oreturnobjs.length + " Customers");
                    $("#winAdvSearch").data("CustomerIDs",ids);
                }
            }else{
                alert("Please select Customer.");
            }
        }

        else if (oPickerobj.winid == 'winOrderPicker')
        {
            debugger;
            if(oreturnObj !=null  && oreturnObj.FBID>0)
            {
                var oFabricLoomPlan=oreturnObj;
                //GetsOrderInfo(oreturnObj);
                //oFabricLoomPlan.WeftColor=_oFabricLoomPlan.WeftColor;
                //oFabricLoomPlan.WarpColor=_oFabricLoomPlan.WarpColor;
                //oFabricLoomPlan.TFLength=_oFabricLoomPlan.TFLength;
                //oFabricLoomPlan.TFLength=_oFabricLoomPlan.TFLength;
                //RefreshControl(oFabricLoomPlan);
                $("#txtOrderNo").val(oFabricLoomPlan.FEONo);
                $("#txtBuyerName").val(oFabricLoomPlan.BuyerName);
                $("#txtConstruction").val(oFabricLoomPlan.Construction);
                //$("#txtStyleNo").val(oFabricLoomPlan.StyleNo);
                _oFabricLoomPlan.FSCDID=oFabricLoomPlan.FEOID;
                _oFabricLoomPlan.FBID=oFabricLoomPlan.FBID;
            }

            else{
                alert("Data Not Found.");
                _oFabricLoomPlan.FSCDID=0;
                _oFabricLoomPlan.FBID=0;
                return;
            }
        }
        else if (oPickerobj.winid == 'winOrderPickerTwo')
        {
            if (oreturnobjs != null && oreturnobjs.length> 0)
            {

                var sDODIDs=''; var sMessage='';
                sMessage=(oreturnobjs.length>1)? oreturnobjs.length +" Order(s) Selected" : oreturnobjs[0].OrderNo;
                $('#txtOrderNoTwo').val(sMessage);
                $("#txtOrderNoTwo").addClass("fontColorOfPickItem");

                for(var i=0;i<oreturnobjs.length;i++){
                    sDODIDs=sDODIDs+oreturnobjs[i].FEOSID+',';
                }
                sDODIDs=sDODIDs.substring(0,sDODIDs.length-1);
                SearchDO(sDODIDs,"");
            }
            else
            {
                alert("Please select a Order.");
                return false;
            }

        }
        else if (oPickerobj.winid == 'winBeamPicker')
        {
            debugger;
            if(oreturnobjs.length > 0)
            {
                var oList = [];
                var oRows = $("#tblBeams").datagrid("getRows");
                for(var i=0;i<oRows.length;i++)
                    oList.push(oRows[i]);
                for(var i=0;i<oreturnobjs.length;i++)
                    oList.push(oreturnobjs[i]);

                var isEqual = true;
                if(oList.length >= 1){
                    for(var i=1;i<oList.length;i++){
                        if(oList[0].FBID != oList[i].FBID){
                            isEqual = false; break;
                        }
                    }
                }

                if(!isEqual){
                    if(oList.length >= 1){
                        isEqual = true;
                        if(oList[0].FSpcType == 1) //SeerSucker
                        {
                            for(var i=1;i<oList.length;i++){
                                if(oList[0].FEOID != oList[i].FEOID || oList[0].FSpcType != oList[i].FSpcType){
                                    isEqual = false; break;
                                }
                            }
                        }
                        else{
                            isEqual = false;
                        }
                    }
                }
                
                if(!isEqual){
                    alert("(All Batch should be Equal) OR (All Dispo should be Equal And Fabric Spe. Type of These Dispo's should be Seer Sucker)!!");
                    return;
                }

                $("#txtOrderNo").val(oreturnobjs[0].FEONo);
                $("#txtBuyerName").val(oreturnobjs[0].BuyerName);
                $("#txtConstruction").val(oreturnobjs[0].Construction);
                _oFabricLoomPlan.FSCDID=oreturnobjs[0].FSCDID;
                _oFabricLoomPlan.FBID=oreturnobjs[0].FBID;
                for(var i=0;i<oreturnobjs.length;i++){
                    var isExist = CheckExisting(oreturnobjs[i]);
                    if(!isExist)
                        $('#tblBeams').datagrid('appendRow',oreturnobjs[i]);
                }
            }
            else{
                alert("Data Not Found.");
                _oFabricLoomPlan.FSCDID=0;
                _oFabricLoomPlan.FBID=0;
                return;
            }
        }
        else if (oPickerobj.winid == 'winOrderPicker2')
        {
            debugger;
            if(oreturnobjs.length > 0)
            {
                //$("#txtOrderNo2").val("You select " + oreturnobjs.length + " item(s).")
                //$("#winCreateMultiplePlan").data("OpenList", oreturnobjs);
                var oDetailColumns = []; var oColumn = "";
                oColumn =  { field:'FEONo', title:'Order No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'BatchNo', title:'Batch No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'StyleNo', title:'Style No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'QtyInMeterSt', title:'Qty(M)', width:'15%', align:'right' };oDetailColumns.push(oColumn);
                $('#tblDispoForMultiple').datagrid({
                    columns:[oDetailColumns]
                });
                //$('#tblDispoForMultiple').datagrid('loadData', oreturnobjs);
                for(var i=0;i<oreturnobjs.length;i++)
                    $('#tblDispoForMultiple').datagrid('appendRow',oreturnobjs[i]);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }
        else if (oPickerobj.winid == 'winBeamPicker2')
        {
            debugger;
            if(oreturnobjs.length > 0)
            {
                //$("#txtOrderNo2").val("You select " + oreturnobjs.length + " item(s).")
                //$("#winCreateMultiplePlan").data("SizingCompleteList", oreturnobjs);
                var oDetailColumns = []; var oColumn = "";
                oColumn =  { field:'OrderNo', title:'Dispo No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'BeamNo', title:'Beam No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'BatchNo', title:'Batch No', width:'20%', align:'left' };oDetailColumns.push(oColumn);
                oColumn =  { field:'QtyInMtrSt', title:'Qty(M)', width:'15%', align:'right' };oDetailColumns.push(oColumn);
                $('#tblDispoForMultiple').datagrid({columns:[oDetailColumns] });
                //$('#tblDispoForMultiple').datagrid('loadData', oreturnobjs);
                for(var i=0;i<oreturnobjs.length;i++)
                    $('#tblDispoForMultiple').datagrid('appendRow',oreturnobjs[i]);
            }
            else{
                alert("Data Not Found.");
                return;
            }
        }

        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }

    function CheckExisting(oObj){
        var oRows = $("#tblBeams").datagrid("getRows");
        var isExist = false;
        for(var i=0;i<oRows.length;i++){
            if(oRows[i].FBPBeamID == oObj.FBPBeamID){
                isExist = true; break;
            }
        }
        return isExist;
    }

    $("#btnDeleteBeam").click(function ()
    {
        debugger;
        var oDetail=$('#tblBeams').datagrid('getSelected');
        if(oDetail==null)
        {
            alert("Please select a item from list.");
            return;
        }
        var nIndex= $('#tblBeams').datagrid('getRowIndex',oDetail);
        $('#tblBeams').datagrid('deleteRow',nIndex);
        
    });

    function GetsOrderInfo(oFabricLoomPlan) {
        var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oFabricLoomPlan,
                ControllerName: "FabricLoomPlan",
                ActionName: "GetsOrderDetails",
                IsWinClose: false
            };
        $.icsDataGet(obj, function (response) {

            if (response.status && response.obj != null) {
                debugger;
                _oFabricLoomPlan=response.obj;
                RefreshControl(_oFabricLoomPlan);

            }
        });

    }
    $("#btnClosePS").click(function () {
        $("#winDUFabricLoomPlan").icsWindow("close");

    });
    $('#btnCurrenttime').click(function(e)
    {
        var oDate=new Date();
        oDate.setMinutes(oDate.getMinutes()+5);
        SetStartTime(oDate);
        AddTime(oDate);
    });

    function SetLastScheduleTime()
    {

        if(parseInt(_oFabricLoomPlan.FMID)>0 )
        {
            var nts=(new Date()).getTime()/1000;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: _sBaseAddress + "/FabricLoomPlan/GetPSByMachine",
                data: { nFMID: _oFabricLoomPlan.FMID ,  nts:nts },
                contentType: "application/json; charset=utf-8",
                success: function(data)
                {
                    ////debugger;
                    var sStratTime = jQuery.parseJSON(data);
                    if ($.trim(sStratTime)!='')
                    {
                        SetStartTime(new Date(sStratTime));
                        AddTime(new Date(sStratTime));
                    }
                    else
                    {
                        var oDate=new Date();
                        oDate.setMinutes(oDate.getMinutes()+5);
                        SetStartTime(oDate);
                        AddTime(oDate);
                    }
                },
                error: function(xhr, status, error)
                {
                    alert(error);
                }
            });
        }

    }

    $('#btnScheduleLastTime').click(function(e)
    {

        SetLastScheduleTime();
    });
    function SetStartTime(oDate)
    {
        //debugger;
        $('#txtStartDate').datebox('setValue', icsdateformat(oDate));
        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
        {
            nHour=0;
        }
        if(isNaN(nMin))
        {
            nMin=0;
        }
        $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);
    }

    function AddTime(sDate)
    {
        //debugger;  //Previous Code
        //var nhr=$('#tpStartTime').timespinner('getHours');
        //var nmin=$('#tpStartTime').timespinner('getMinutes');
        //if(isNaN(nhr))
        //{
        //    nhr=0;
        //}
        //if(isNaN(nmin))
        //{
        //    nmin=0;
        //}
        //var oDate=new Date(sDate);
        //oDate.setHours(oDate.getHours()+nhr);
        //oDate.setMinutes(oDate.getMinutes()+nmin);
        //$('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        //var nHour=oDate.getHours();
        //var nMin=oDate.getMinutes();
        //if(isNaN(nHour))
        //{
        //    nHour=0;
        //}
        //if(isNaN(nMin))
        //{
        //    nMin=0;
        //}
        //$('#tpEndTime').timespinner('setValue', nHour+":"+nMin);

        //Add 10 mins from start date
        var oDate = new Date($('#txtStartDate').datebox('getValue'));
        oDate.setHours(new Date().getHours());
        oDate.setMinutes(new Date().getMinutes());

        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpStartTime').timespinner('setValue', nHour+":"+nMin);

        oDate.setMinutes(oDate.getMinutes() + 10);
        $('#txtEndDate').datebox('setValue', icsdateformat(oDate));
        nHour=oDate.getHours();
        nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpEndTime').timespinner('setValue', nHour+":"+nMin);

    }

    function ValidationOfStartTime()
    {
        if(new Date($('#txtStartDate').datebox('getValue'))> new Date($('#txtEndDate').datebox('getValue'))){
            alert("Start time must be later than End time.");
            return false;
        }
        if(_oFabricLoomPlan.FMID==null || _oFabricLoomPlan.FMID<=0)
        {
            alert("Machine Not Found!!.");
            return;
        }
        if($("#cboType").val() == 2 && $("#tblBeams").datagrid("getRows").length <= 0){
            alert("Atleast One Detail Required!!.");
            return;
        }
        return true;
    }

    $('#btnAddSpinnerTime').click(function(e)
    {
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var nhr=$('#tptimeSpinner').timespinner('getHours');
        var nmin=$('#tptimeSpinner').timespinner('getMinutes');
        if(isNaN(nhr))
        {
            nhr=0;
        }
        if(isNaN(nmin))
        {
            nmin=0;
        }
        var oDate=new Date(dStartDate);
        oDate.setHours(oDate.getHours()+nhr);
        oDate.setMinutes(oDate.getMinutes()+nmin);
        AddTime(oDate);
        if(!ValidationOfStartTime())return;
    });

    function RefreshObject()
    {
        debugger;
        var dStartDate =$('#txtStartDate').datebox('getValue');
        var startTime= $('#tpStartTime').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var dEndtDate =$('#txtEndDate').datebox('getValue');
        var EndtTime= $('#tpEndTime').timespinner('getValue');
        var sTime=EndtTime.split(':');
        var hEndtTime= parseFloat(sTime[0]);
        var mEndtTime= parseFloat(sTime[1]);
        dEndtDate = new Date(dEndtDate);
        dEndtDate.setHours(hEndtTime);
        dEndtDate.setMinutes(mEndtTime);


        var oFabricLoomPlan = {
            FLPID     : (_oFabricLoomPlan!=null && _oFabricLoomPlan.FLPID>0)? _oFabricLoomPlan.FLPID:0,
            FMID                   : _oFabricLoomPlan.FMID,
            FBID                 : _oFabricLoomPlan.FBID,
            FSCDID                 : _oFabricLoomPlan.FSCDID,
            StartTime	           : dStartDate,
            EndTime                : dEndtDate,
            Note                   : $("#txtNote").val(),
            //PlanStatus             : $("#cboPlanStatus").val(),
            FabricPrograme         : $("#cboFabricProgram").val(),
            ShiftID                : $("#cboShift").val(),
            FabricLoomPlanDetails  : $("#tblBeams").datagrid("getRows")
        };
        return oFabricLoomPlan;
    }
    function Save()
    {
        debugger;
        if(!ValidationOfStartTime())return;
        var oFabricLoomPlan=RefreshObject();
        var nts=(new Date()).getTime()/1000;

        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricLoomPlan/ScheduleInTimePeriod",
            data: JSON.stringify({oFabricLoomPlan:oFabricLoomPlan, nts: nts}),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            {
                ////debugger;
                var nCount = jQuery.parseJSON(data);
                if (nCount>0)
                {
                    if(confirm("Are you sure to increase time from next all schedules."))
                    {
                        oFabricLoomPlan.IsIncreaseTime=true;
                        SaveProductionSchedule(oFabricLoomPlan);
                    }
                }
                else if(nCount==0)
                {
                    oFabricLoomPlan.IsIncreaseTime=false;
                    SaveProductionSchedule(oFabricLoomPlan);
                }

            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });
    }
    function SaveProductionSchedule(oFabricLoomPlan)
    {
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FabricLoomPlan/Save",
            traditional: true,
            data:  JSON.stringify(oFabricLoomPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oFLP = jQuery.parseJSON(data);
                if (oFLP.ErrorMessage=="")
                {
                    _oFabricLoomPlan=oFLP;
                    DynamicRefreshList(_oFabricLoomPlan.FabricLoomPlanDetails,"tblBeams");
                    alert("Data Saved successfully");

                    $('#tblFabricLoomPlan').datagrid('updateRow', { index: _nSelectedRowIndex, row: _oFabricLoomPlan });
                    $('#tblFabricLoomPlan').datagrid('selectRow', _nSelectedRowIndex);
                    //$("#winDUFabricLoomPlan").icsWindow("close");
                }
                else {
                    alert(oFLP.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    $("#btnUpdatePlanStatus").click(function () {
        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Please select a valid item from list."); return ; }
        var nIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
        if(parseInt($("#cboPlanStatus").val()) <= 0) {alert("Please select a status!!"); return;}
        oFabricLoomPlan.PlanStatus = $("#cboPlanStatus").val();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FabricLoomPlan/UpdatePlanStatus",
            traditional: true,
            data: JSON.stringify(oFabricLoomPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                oFabricLoomPlan = jQuery.parseJSON(data);
                if(oFabricLoomPlan!=null)
                {
                    if(oFabricLoomPlan.ErrorMessage=="" || oFabricLoomPlan.ErrorMessage == null)
                    {
                        alert("Updated Successful");
                        $('#tblFabricLoomPlan').datagrid('updateRow',{ index: nIndex, row: oFabricLoomPlan });
                    }
                    else
                    {
                        alert(oFabricLoomPlan.ErrorMessage);
                    }
                }
                else
                {
                    alert("Invalid Operation!");
                }

            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    });

    //////advance Search

    $("#btnClrMachinePiker").click(function () {

        $("#txtMachineName").val("");
        $("#winAdvSearch").data("MachineIDs","");
    });

    $("#btnMachinePiker").click(function () {

        var sMachineName=$.trim($("#txtMachineName").val());
        //if(sMachineName==""){ alert("Type machine name to search."); return false; }
        GetMachinespp(sMachineName);
    });

    $("#txtMachineName").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sMachineName=$.trim($("#txtMachineName").val());
            //if(sMachineName==""){ alert("Type machine name to search."); return false; }
            GetMachinespp(sMachineName);
        }
        else if(nkeyCode==8){
            $("#txtMachineName").val("");
            $("#winAdvSearch").data("MachineIDs","");
        }
    });
    function GetMachinespp(sMachineName){

        var oMachine = {
            BUID:sessionStorage.getItem('BUID'),
            //ResourcesTypeInInt:2,
            Name:sMachineName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oMachine,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetsMachine",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {

            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FMID > 0) {
                    //debugger;
                    var tblColums = [];
                    var oColumn = { field: "Code", title: "Code", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Machine Name", width: 150, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "Capacity", title: "Capacity", width: 90, align: "left" };tblColums.push(oColumn);
                    //oColumn = { field: "SequenceNo", title: "SL No", width: 150, align: "left" };tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winMachinesPicker',
                        winclass:'clsMachinesPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblMachinesPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Machine List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No machine found.");
            }
        });
    }

    $("#btnClrCustomerPikerAdv").click(function () {
        $("#txtCustomerNameAdv").val("");
        $("#winAdvSearch").data("CustomerIDs","");
    });

    $("#btnCustomerPikerAdv").click(function () {
        var sCustomerName=$.trim($("#txtCustomerNameAdv").val());
        //if(sCustomerName==""){ alert("Type Customer name to search."); return false; }
        GetCustomers(sCustomerName);
    });

    $("#txtCustomerNameAdv").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sCustomerName=$.trim($("#txtCustomerNameAdv").val());
            //if(sCustomerName==""){ alert("Type Customer name to search."); return false; }
            GetCustomers(sCustomerName);
        }
        else if(nkeyCode==8){
            $("#txtCustomerNameAdv").val("");
            $("#winAdvSearch").data("CustomerIDs","");
        }
    });
    function GetCustomers(sCustomerName){

        var oCustomer = {
            Name:sCustomerName
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oCustomer,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetsCustomer",
            IsWinClose: false
        };

        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "Name", title: "Name", width: 200, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Address", title: "Address", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Email", title: "Email", width: 90, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "ShortName", title: "Short Name", width: 90, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winCustomersPicker',
                        winclass:'clsCustomersPicker',
                        winwidth: 480,
                        winheight: 460,
                        tableid: 'tblCustomersPicker',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'Name',
                        windowTittle: 'Customer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No Customer found.");
            }
        });
    }

    function CheckFromAndToDateValidation(OperationComboId, FromDateId, ToDateId) {
        $("#" + OperationComboId).parent().parent().parent().find("select").removeClass("errorFieldBorder");
        var nCboVal = $("#" + OperationComboId).val();
        if (parseInt(nCboVal) == 5 || parseInt(nCboVal) == 6) {
            var fromDate = $("#" + FromDateId).datebox("getValue");
            var toDate = $("#" + ToDateId).datebox("getValue");
            if (new Date(fromDate) > new Date(toDate)) {
                $("#" + ToDateId).focus();
                $("#" + OperationComboId).addClass("errorFieldBorder");
                $(".lblLoadingMessage").hide();
                return false;
            } else {
                $("#" + OperationComboId).removeClass("errorFieldBorder");
                return true;
            }
        } else {
            return true;
        }
    }

    function ResetAdvSearchWindow() {
        _sContractorIds = '';
        _sDeliverToIDs = "";
        _sCPersonnelIds="";
        $("#winAdvSearch input").not("input[type='button']").val("");
        $("#winAdvSearch input").removeClass("fontColorOfPickItem");
        $("#winAdvSearch select").val(0);
        DateActionsDateAdvSearch();
        $("#txtFromDateAdv,#txtToDateAdv").datebox({ disabled: true });
        $("#txtFromDateAdv,#txtToDateAdv").datebox("setValue", icsdateformat(new Date()));
    }

    function PickContractors_AdvS() {
        var oContractor = {
            Params: '2,3' + '~' + $.trim($("#txtContractorAdvS").val())+"~"+_nBUID
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };

        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);

        DynamicRefreshList([], "tblAccountsPickerAdvSearch");
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winContractorPicker',
                        winclass: 'clsAccountOf',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblAccountOfs',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Contactor List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Contactor Found.");
            }
        });
    }

    function PickDeliverTo_AdvS() {
        var oContractor = {
            Params: '2' + '~' + $.trim($("#txtDeliverToAdvS").val()+"~"+_nBUID)
        };
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oContractor,
            ControllerName: "Contractor",
            ActionName: "ContractorSearchByNameType",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        DynamicRefreshList([], "tblContractorsPickerAdvSearch");
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ContractorID > 0) {
                    var tblColums = []; var oColumn = { field: "ContractorID", title: "Code", width: 50, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winBuyers',
                        winclass: 'clsBuyer',
                        winwidth: 400,
                        winheight: 460,
                        tableid: 'tblBuyers',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName: 'Name',
                        windowTittle: 'Buyer List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Contactor Found.");
            }
        });
    }
    function DateActionsDateAdvSearch() {
        DynamicDateActions("cboStartDateAdv", "txtFromDateAdv", "txtToDateAdv");
    }
    $("#btnCloseAdvSearch").click(function () {
        $("#winAdvSearch").icsWindow("close");
    });
    $("#btnAdvSearch").click(function () {
        debugger;
        $("#winAdvSearch").icsWindow("open", " Advance Search");

        DynamicResetAdvSearchWindow("winAdvSearch");
        DynamicDateActions("cboStartDateAdv", "txtFromDateAdv", "txtToDateAdv");
        ResetAdvSearchWindow();
        $("#cboStartDateAdv").icsLoadCombo({
            List: _oCompareOperators,
            OptionValue: "id",
            DisplayText: "Value"
        });
    });
    $('#txtSearchByDispoNo').keypress(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            var nCboOrderDate = 0;
            var dFromOrderDate = icsdateformat(new Date());
            var dToOrderDate = icsdateformat(new Date());
            var sExeNo = $.trim($("#txtSearchByDispoNo").val());

            debugger;
            var sParams = nCboOrderDate + "~" +
                          dFromOrderDate + "~" +
                          dToOrderDate + "~" +
                          sExeNo + "~" +
                          "" +"~"+
                          "" +"~"+
                          "" +"~"+
                          0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        false;

            //console.log(sParams);
            sessionStorage.setItem("ParamsSO", sParams);
            var oFabricLoomPlan = {
                ErrorMessage : sParams
            };

            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricLoomPlan/AdvSearch",
                traditional: true,
                data: JSON.stringify(oFabricLoomPlan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricLoomPlans = data;
                    if (oFabricLoomPlans != null )
                    {
                        if (oFabricLoomPlans.length > 0 && oFabricLoomPlans[0].ErrorMessage=='')
                        {
                            DynamicRefreshList(oFabricLoomPlans, "tblFabricLoomPlan");
                            $.icsMakeFooterColumn('tblFabricLoomPlan',['ReedNo','Qty']);
                            $("#winAdvSearch").icsWindow("close");
                        }
                        else
                        {
                            alert("Sorry, No data found. "+(oFabricLoomPlans[0]==undefined?'':oFabricLoomPlans[0].ErrorMessage));
                            DynamicRefreshList([], "tblFabricLoomPlan");
                        }

                    } else {
                        alert("Sorry, No data found. ");
                        DynamicRefreshList([], "tblFabricLoomPlan");
                    }
                    $(".lblLoadingMessage").hide();
                }
            });
        }
        else if (code === 8) {
            DynamicRefreshList([], "tblExportBillReports");
        }
    });

    $("#txtLoomNo").keyup(function (e) {
        var keyCode = e.keyCode || e.which;
        if (keyCode == 13){
            var oFabricLoomPlan = {
                MachineName: $.trim($("#txtLoomNo").val())
            };
            $.ajax({
                type: "POST",
                dataType: "json",
                url: _sBaseAddress + "/FabricLoomPlan/GetByLoomNo",    //AdvSearch
                traditional: true,
                data: JSON.stringify(oFabricLoomPlan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oFabricLoomPlans = data;
                    debugger;
                    if (oFabricLoomPlans.length > 0)
                    {
                        if (oFabricLoomPlans[0].ErrorMessage=='')
                        {
                            DynamicRefreshList(oFabricLoomPlans, "tblFabricLoomPlan");
                        }
                        else
                        {
                            alert(oFabricLoomPlans[0].ErrorMessage);
                        }

                    } else {
                        alert("Sorry, No data found. ");
                    }
                }
            });
        }

    });

    $("#btnSearchAdvSearch").click(function () {
        debugger;
        var checkDate = CheckFromAndToDateValidation("cboStartDateAdv", "txtFromDateAdv", "txtToDateAdv");
        if (!checkDate) {
            alert("End date must be greater than start date.");
            return false;
        }
        var nCboStartDate = parseInt($("#cboStartDateAdv").val());
        var dFromStartDate = $('#txtFromDateAdv').datebox('getValue');
        var dToStartDate = $('#txtToDateAdv').datebox('getValue');

        var sLoomNoAdv = $.trim($("#txtLoomNoAdv").val());
        var sExeNoAdv = $.trim($("#txtExeNoAdv").val());
        var sConstructionAdv = $.trim($("#txtConstructionAdv").val());

        var nPlanStatusAdv = parseInt($("#cboPlanStatusAdv").val());
        var nFabProgramAdv = parseInt($("#cboFabProgramAdv").val());

        //var sMachineIDs = $("#winAdvSearch").data("MachineIDs");
        var sCustomerIDs = $("#winAdvSearch").data("CustomerIDs");
        //var nDesign = parseInt($("#cboDesign").val());
        //var nPlanStatus = parseInt($("#cboPlanStatusAdv").val());
        //var sBatchNo = $.trim($("#txtBatchNo").val());
        //var bIsPending = false;
        //if($('#chkIsPending').attr("checked"))
        //    bIsPending=true;

        if(nCboStartDate <= 0 && sLoomNoAdv == "" && sExeNoAdv == "" && sConstructionAdv == "" && nPlanStatusAdv <= 0 && nFabProgramAdv <= 0 && sCustomerIDs == ""){
            alert("Please enter atleast one searching criteria!!");
            return;
        }

        debugger;
        var sParams =   nCboStartDate + "~" +
                        dFromStartDate + "~" +
                        dToStartDate;

        //sessionStorage.setItem("ParamsSO", sParams);
        var oFabricLoomPlan = {
            ErrorMessage : sParams,
            ExeNo: sExeNoAdv,
            MachineName: sLoomNoAdv,
            Construction: sConstructionAdv,
            PlanStatus: nPlanStatusAdv,
            FabricPrograme: nFabProgramAdv,
            ContractorName: sCustomerIDs
        };
        $("#winAdvSearch").data("oAdvObject",oFabricLoomPlan);
        $(".lblLoadingMessage").show();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricLoomPlan/AdvSearch",
            traditional: true,
            data: JSON.stringify(oFabricLoomPlan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var oFabricLoomPlans = data;
                debugger;
                if (oFabricLoomPlans.length > 0)
                {
                    if (oFabricLoomPlans[0].ErrorMessage=='')
                    {
                        DynamicRefreshList(oFabricLoomPlans, "tblFabricLoomPlan");
                        $("#winAdvSearch").icsWindow("close");
                    }
                    else
                    {
                        alert(oFabricLoomPlans[0].ErrorMessage);
                        //DynamicRefreshList([], "tblFabricLoomPlan");
                    }

                } else {
                    alert("Sorry, No data found. ");
                    //DynamicRefreshList([], "tblFabricLoomPlan");
                }
                $(".lblLoadingMessage").hide();
            }
        });
    });
    $("#btnPrint").click(function () {
        var sParams="";
        var bIsPending = false;
        if($('#chkIsPendingFWP').attr("checked"))
            bIsPending=true;
        if(bIsPending == true){
            sParams = 0 + "~" +
                          icsdateformat(new Date()) + "~" +
                          icsdateformat(new Date()) + "~" +
                          "" + "~" +
                          "" +"~"+
                          "" +"~"+
                          "" +"~"+
                          0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        true;

        }else{
            sParams=sessionStorage.getItem("ParamsSO");
            if(sParams == ""){
                alert("Please search first!!");
                return;
            }
        }

        window.open(_sBaseAddress + '/FabricLoomPlan/PrintFabricWarpingPlan_Machine?sTemp=' + sParams, "_blank");
    });
    $('#btnAddFB').click(function(e){
        debugger;
        AddFB();
        $("#winDUFabricLoomPlan").icsWindow("close");

    });



    function AddFB(){
        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        if (oFabricLoomPlan ==null || oFabricLoomPlan.FLPID <=0 ) { alert("Planning yet not created."); return ; }

        if(oFabricLoomPlan == null || parseInt(oFabricLoomPlan.FLPID)<=0){
            alert("Planning yet not created.");
            return false;
        }
        if(!confirm("Are you sure to create fabric batch?"))
            return false;
        var SelectedRowIndex=$('#tblFabricLoomPlan').datagrid('getRowIndex',oFabricLoomPlan);
        var oFabricBatch={
            FWPDID:oFabricLoomPlan.FLPID
        }
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatch,
            ControllerName: "FabricBatch",
            ActionName: "GetLastFabricBatchByWarpPlane",
            IsWinClose: false
        };
        $.icsDataGet(obj, function (response)
        {
            debugger;
            //if (response.obj.FBID>0) {
            //    $("#txtTotalEnds").val(response.obj.TotalEnds);
            //}
            //else {
            //    $("#txtTotalEnds").val(0);
            //}
            var oFabricBatchTemp=response.obj;
            var oFabricBatch={
                FBID:oFabricBatchTemp.FBID,
                FWPDID:oFabricLoomPlan.FLPID,
                FabricSalesContractDetailID:oFabricLoomPlan.FSCDID,
                Qty:oFabricLoomPlan.Qty*1.0936132983,
                FMID:oFabricLoomPlan.FMID,
                FEOSID:oFabricLoomPlan.FEOSID,
                TotalEnds:0,
                Params:$('#tblFabricLoomPlan').data('FWPDID')
            }
            var obj =
            {
                BaseAddress: _sBaseAddress,
                Object: oFabricBatch,
                ObjectId: oFabricBatch.FBID,
                ControllerName: "FabricBatch",
                ActionName: "SaveFabricBatchFromWarpPlan",
                TableId: "",
                IsWinClose: false,
                Message: "Fabric Batch Create Successfully."
            };
            $.icsSave(obj, function (response) {
                if (response.status && response.obj != null) {
                    if (response.obj.FBID>0)
                    {
                        oFabricLoomPlan.BatchNo = response.obj.BatchNo;
                        $('#tblFabricLoomPlan').datagrid('updateRow',{ index: SelectedRowIndex, row: oFabricLoomPlan });
                        $("#winDUFabricLoomPlan").icsWindow("close");

                    }
                }
            });


        });
    }
    function GetsFabricBatch(nFWPDID){
        _nFBID =0;
        $("#cboFabricBatch").empty();
        $("#lblSingleFB").text("");
        $("#btnAddFB,#cboFabricBatch,#lblSingleFB").hide();

        var obj = {
            BaseAddress: _sBaseAddress,
            Object: { FWPDID:nFWPDID },
            ControllerName: "FabricBatch",
            ActionName: "GetsFabricBatchByFWPD",
            IsWinClose: false
        };
        $.icsMaxDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                $("#region-fabric-batch").show();
                $('#btnBatchCardPrint').show();
                $('#btnAddFB').hide();
                if(response.objs.length > 1)
                {
                    $("#cboFabricBatch").icsLoadCombo({
                        List: response.objs,
                        OptionValue: "FBID",
                        DisplayText: "FabricBatchWithStatus",
                        InitialValue:""
                    });
                    $("#cboFabricBatch").show();

                }else{
                    $("#lblSingleFB").show();
                    $("#lblSingleFB").text(response.objs[0].FabricBatchWithStatus);
                    $('#btnBatchCardPrint').show();
                    _nFBID =response.objs[0].FBID;
                }
            }
        });
    }

    $("#btnBatchCardPrint").click(function () {

        if(_nFBID<=0)
        {
            alert("No Batch Card Found!");
            return;
        }
        window.open(_sBaseAddress+ "/FabricBatch/PrintBatchCard_Dynamic?nFBID="+_nFBID+"&nProcess="+0); ///warping = 0
    });

    $("#btnExcel").click(function () {
        var sParams="";
        var bIsPending = false;
        if($('#chkIsPendingFWP').attr("checked"))
            bIsPending=true;
        if(bIsPending == true){
            sParams = 0 + "~" +
                          icsdateformat(new Date()) + "~" +
                          icsdateformat(new Date()) + "~" +
                          "" + "~" +
                          "" +"~"+
                          "" +"~"+
                          "" +"~"+
                          0 +"~"+
                        0 +"~"+
                        "" +"~"+
                        true;

        }else{
            sParams=sessionStorage.getItem("ParamsSO");
            if(sParams == ""){
                alert("Please search first!!");
                return;
            }
        }

        window.open(_sBaseAddress + '/FabricLoomPlan/ExcelFabricWarpingPlan_Machine?sTemp=' + sParams, "_blank");
    });


    function RefreshControlLayout()
    {
        $('#btnAdd,#btnEdit,#btnDelete,#btnCut,#btnPast,#btnSwap').hide();

        if (PermissionChecker('Add', 'FabricLoomPlan',_oAuthorizationRolesMapping)) {$("#btnAdd").show();}
        if (PermissionChecker('Edit', 'FabricLoomPlan',_oAuthorizationRolesMapping)) {$("#btnEdit").show();}
        if (PermissionChecker('View', 'FabricLoomPlan',_oAuthorizationRolesMapping)) {$("#btnView").show();}
        if (PermissionChecker('Delete', 'FabricLoomPlan',_oAuthorizationRolesMapping)) {$("#btnDelete").show();}
        if (PermissionChecker('Copy', 'FabricLoomPlan',_oAuthorizationRolesMapping)) {$('#btnCut,#btnPast,#btnSwap').show();}

    }

    $('#btnProgramReport').click(function(){
        debugger;
        var oFLP = $("#winAdvSearch").data("oAdvObject");
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+  "/FabricLoomPlan/SetFabricLoomPlanData",
            traditional: true,
            data:  JSON.stringify(oFLP),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var sFeedBackMessage = jQuery.parseJSON(data);
                if (sFeedBackMessage==="Successful")
                {
                    window.open (_sBaseAddress+ "/FabricLoomPlan/PrintProgramReport?nBUID="+_nBUID);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });      
    });

    $("#btnClosePlan").click(function () {
        $("#winCreateMultiplePlan").icsWindow("close");
    });

    $('#txtStartDate2').datebox({
        onSelect: function(date){
            //alert(date.getFullYear()+":"+(date.getMonth()+1)+":"+date.getDate());
            debugger;
            var oDate = new Date(date);
            oDate.setHours(new Date().getHours());
            oDate.setMinutes(new Date().getMinutes());

            var nHour=oDate.getHours();
            var nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpStartTime2').timespinner('setValue', nHour+":"+nMin);

            oDate.setMinutes(oDate.getMinutes() + 10);
            $('#txtEndDate2').datebox('setValue', icsdateformat(oDate));
            nHour=oDate.getHours();
            nMin=oDate.getMinutes();
            if(isNaN(nHour))
                nHour=0;
            if(isNaN(nMin))
                nMin=0;
            $('#tpEndTime2').timespinner('setValue', nHour+":"+nMin);
        }
    });

    function SetDateForMultiplePlan(){
        var oDate = new Date();
        oDate.setHours(new Date().getHours());
        oDate.setMinutes(new Date().getMinutes());
        $('#txtStartDate2').datebox('setValue', icsdateformat(oDate));
        var nHour=oDate.getHours();
        var nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpStartTime2').timespinner('setValue', nHour+":"+nMin);

        oDate.setMinutes(oDate.getMinutes() + 10);
        $('#txtEndDate2').datebox('setValue', icsdateformat(oDate));
        nHour=oDate.getHours();
        nMin=oDate.getMinutes();
        if(isNaN(nHour))
            nHour=0;
        if(isNaN(nMin))
            nMin=0;
        $('#tpEndTime2').timespinner('setValue', nHour+":"+nMin);
    }

    $("#btnCreateMultiplePlan").click(function () {
        debugger;
        var oFabricLoomPlan = $('#tblFabricLoomPlan').datagrid('getSelected');
        if (oFabricLoomPlan ==null) { alert("Please select an item from list."); return ; }
        if (oFabricLoomPlan.FMID <=0 ) { alert("Machine Not Found!!"); return ; }
        //if (oFabricLoomPlan.PlanStatus != 0 ) { alert("Please select Initialize item!!!!"); return ; }
        SetDateForMultiplePlan();
        $('#cboFabricProgram2,#cboShift2').val(0);
        $('#txtOrderNo2').val("");
        $("#winCreateMultiplePlan").data("OpenList", []);
        $("#winCreateMultiplePlan").data("SizingCompleteList", []);
        $('#tblDispoForMultiple').datagrid({columns:[] });
        $('#tblDispoForMultiple').datagrid('loadData', []);
        $("#winCreateMultiplePlan").icsWindow("open", "Fabric Loom Plan");
    });

    $('#cboType2').change(function(e){
        $('#tblDispoForMultiple').datagrid({columns:[] });
        $('#tblDispoForMultiple').datagrid('loadData', []);
    });

    $("#btnPickOrderNo2").click(function ()
    {
        if($('#cboType2').val() == 1){
            var oPSDetail = {
                FEONo:$('#txtOrderNo2').val()
            };
            GetOrders2(oPSDetail);
        }else{
            var oFabricBatchLoom={
                Status : 3,
                FEONo: ""
            };
            SearchFBPB2(oFabricBatchLoom);
        }

    });

    $("#txtOrderNo2").keydown(function (e) {
        var nkeyCode = e.keyCode || e.which;
        if(nkeyCode==13){
            var sorderNo=$.trim($("#txtOrderNo2").val());
            if($('#cboType2').val() == 1){
                if(sorderNo == ""){
                    alert("Please enter Order No!!");
                    $('#txtOrderNo2').focus()
                    return;
                }
                var oPSDetail = {
                    FEONo:sorderNo
                };
                GetOrders2(oPSDetail);
            }else{
                var oFabricBatchLoom={
                    Status : 3,
                    FEONo: sorderNo
                };
                SearchFBPB2(oFabricBatchLoom);
            }

        }
        else if(nkeyCode==8){
            $("#txtOrderNo2").val("");
            $("#winCreateMultiplePlan").data("OpenList");
            $("#winCreateMultiplePlan").data("SizingCompleteList");
        }
    });

    function GetOrders2(oPSDetail)
    {
        debugger;
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oPSDetail,
            ControllerName: "FabricLoomPlan",
            ActionName: "GetFabricBatches",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "FEONo", title: "OrderNo", width: 100, align: "left" };tblColums.push(oColumn);
                    var oColumn = { field: "BatchNo", title: "Batch No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BuyerName", title: "Buyer", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "Construction", title: "Construction ", width: 150, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "StyleNo", title: "Style No ", width: 120, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "QtyInM", title: "Qty(M)", width: 80, align: "right",formatter:formatPrice };tblColums.push(oColumn);
                    var oPickerParam = {
                        winid: 'winOrderPicker2',
                        winclass:'clsOrderPicker2',
                        winwidth: 750,
                        winheight: 660,
                        tableid: 'tblOrderPicker2',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });
    }

    function SearchFBPB2(oFabricBatchLoom)
    {
        var obj = {
            BaseAddress: _sBaseAddress,
            Object: oFabricBatchLoom,
            ControllerName: "FabricLoomPlan",
            ActionName: "SearchFBPB",
            IsWinClose: false
        };
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);
        $.icsDataGets(obj, function (response) {
            clearInterval(intervalID);
            $("#progressbarParent").hide();
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].FBID > 0) {
                    debugger;
                    var tblColums = [];
                    var oColumn = { field: "OrderNo", title: "Dispo No", width: 100, align: "left" };tblColums.push(oColumn);
                    var oColumn = { field: "BeamNo", title: "Beam No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "BatchNo", title: "Batch No", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "QtyInMtr", title: "Qty (M) ", width: 80, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "IsDrawingSt", title: "Drawing/Leasing", width: 100, align: "left" };tblColums.push(oColumn);
                    oColumn = { field: "FSpcTypeSt", title: "Spec. Type", width: 100, align: "left" };tblColums.push(oColumn);
                    
                    var oPickerParam = {
                        winid: 'winBeamPicker2',
                        winclass:'clsOrderPicker2',
                        winwidth: 700,
                        winheight: 660,
                        tableid: 'tblOrderPicker2',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: true,
                        searchingbyfieldName:'OrderNo',
                        windowTittle: 'Order List',
                        placeholder : "Search By Dispo No"
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);//multiplereturn, winclassName
                }
                else { alert(response.objs[0].ErrorMessage); }
            }
            else{
                alert("No order found.");
            }
        });
    }

    $("#btnDeleteForMultiple").click(function ()
    {
        var oDetail=$('#tblDispoForMultiple').datagrid('getSelected');
        if(oDetail==null)
        {
            alert("Please select a item from list.");
            return;
        }
        var nIndex= $('#tblDispoForMultiple').datagrid('getRowIndex',oDetail);
        $('#tblDispoForMultiple').datagrid('deleteRow',nIndex);
    });
    
    $("#btnCreatePlan").click(function ()
    {
        if(new Date($('#txtStartDate2').datebox('getValue'))> new Date($('#txtEndDate2').datebox('getValue'))){
            alert("Start time must be smaller than End time.");
            return false;
        }
        var oFLP = $('#tblFabricLoomPlan').datagrid('getSelected');
        var dStartDate =$('#txtStartDate2').datebox('getValue');
        var startTime= $('#tpStartTime2').timespinner('getValue');
        var sTime=startTime.split(':');
        var hStartTime= parseFloat(sTime[0]);
        var mStartTime= parseFloat(sTime[1]);
        dStartDate = new Date(dStartDate);
        dStartDate.setHours(hStartTime);
        dStartDate.setMinutes(mStartTime);

        var dEndtDate =$('#txtEndDate2').datebox('getValue');
        var EndtTime= $('#tpEndTime2').timespinner('getValue');
        var sTime=EndtTime.split(':');
        var hEndtTime= parseFloat(sTime[0]);
        var mEndtTime= parseFloat(sTime[1]);
        dEndtDate = new Date(dEndtDate);
        dEndtDate.setHours(hEndtTime);
        dEndtDate.setMinutes(mEndtTime);

        debugger;
        var oList = [];
        if($('#cboType2').val() == 1){
            //var oOpenList = $("#winCreateMultiplePlan").data("OpenList");
            var oOpenList = $('#tblDispoForMultiple').datagrid('getRows');
            for(var i=0;i<oOpenList.length;i++){
                var oObj = {
                    FLPID                  : 0,
                    FMID                   : oFLP.FMID,
                    FBID                   : oOpenList[i].FBID,
                    FSCDID                 : oOpenList[i].FEOID,
                    StartTime	           : dStartDate,
                    EndTime                : dEndtDate,
                    Note                   : "",
                    PlanStatus             : 1,
                    FabricPrograme         : $("#cboFabricProgram2").val(),
                    ShiftID                : $("#cboShift2").val()
                };
                oList.push(oObj);
            }
        }else{
            //var oSizingCompleteList = $("#winCreateMultiplePlan").data("SizingCompleteList");
            var oSizingCompleteList = $('#tblDispoForMultiple').datagrid('getRows');
            for(var i=0;i<oSizingCompleteList.length;i++){
                var oObj = {
                    FLPID                  : 0,
                    FMID                   : oFLP.FMID,
                    FBID                   : oSizingCompleteList[i].FBID,
                    FSCDID                 : oSizingCompleteList[i].FSCDID,
                    StartTime	           : dStartDate,
                    EndTime                : dEndtDate,
                    Note                   : "",
                    PlanStatus             : 1,
                    FabricPrograme         : $("#cboFabricProgram2").val(),
                    ShiftID                : $("#cboShift2").val(),
                    FabricLoomPlanDetails  : [{ FLPDID: 0,FLPID: 0,FBPBeamID: oSizingCompleteList[i].FBPBeamID}]
                };
                oList.push(oObj);
            }
        }
        debugger;
        $.ajax({
            type: "POST",
            dataType: "json",
            url: _sBaseAddress + "/FabricLoomPlan/SaveMultiplePlan",
            data: JSON.stringify(oList),
            contentType: "application/json; charset=utf-8",
            success: function(data)
            {
                debugger;
                oList = jQuery.parseJSON(data);
                if(oList.length > 0){
                    if(oList[0].ErrorMessage == "" || oList[0].ErrorMessage == null){
                        var nIndex= $('#tblFabricLoomPlan').datagrid('getRowIndex',oFLP);
                        if (oFLP.PlanStatus <= 0 ){
                            $('#tblFabricLoomPlan').datagrid('deleteRow',nIndex);
                            var oFinalList = [];
                            var oRows = $('#tblFabricLoomPlan').datagrid('getRows');
                            for(var i=0;i<oList.length;i++){
                                oFinalList.push(oList[i]);
                            }
                            for(var i=0;i<oRows.length;i++){
                                oFinalList.push(oRows[i]);
                            }
                            DynamicRefreshList(oFinalList, 'tblFabricLoomPlan');
                            $('#tblFabricLoomPlan').datagrid('selectRow', 0);
                        }else{
                            var oFinalList = [];
                            var oRows = $('#tblFabricLoomPlan').datagrid('getRows');
                            for(var i=0;i<oRows.length;i++){
                                oFinalList.push(oRows[i]);
                                if(i == nIndex){
                                    for(var i=0;i<oList.length;i++){
                                        oFinalList.push(oList[i]);
                                    }
                                }
                            }
                            DynamicRefreshList(oFinalList, 'tblFabricLoomPlan');
                            $('#tblFabricLoomPlan').datagrid('selectRow', nIndex);
                        }
                        
                        alert("Plan(s) Created Succesfully!!");
                        $("#winCreateMultiplePlan").icsWindow("close");
                    }else{
                        alert(oList[0].ErrorMessage);
                    }
                }else{
                    alert("Data not found!!");
                }
            },
            error: function(xhr, status, error)
            {
                alert(error);
            }
        });


    });

</script>
