@{
    Layout = "~/Views/Shared/_AngularLayout.cshtml";
    ViewBag.Title = "Fabric Delivery Order";
}
@model ESimSol.BusinessObjects.FabricDeliveryOrder

<div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
    <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
        <label style="font-size:18px;">Please wait</label>
        <div id="progressbar" style="width:100%;height:37px;"></div>
    </div>
</div>
<div style="padding-top:1px" ng-app="FabricDeliveryOrderAPP" class="form-horizontal regionFabricDeliveryOrder">
    <div ng-controller="FabricDeliveryOrderCtrl as ctrl">
        <md-content>
            <md-tabs style="height:25px" md-dynamic-height md-border-bottom md-stretch-tabs md-swipe-content>
                @*md-dynamic-height="" md-border-bottom=""*@
                <md-tab label="Order">
                    <md-content class="">
                        <fieldset>
                            <legend>Order Info</legend>
                            <div class="row col-md-12">
                                <div class="col-md-2 text-right"><label class="control-label">DO Type:</label></div>
                                <div class="col-md-3 text-left">
                                    <select class="form-control" ng-change="changeFDOType()" id="cboFDOType" ng-model="FabricDeliveryOrder.FDOTypeInInt" ng-options="obj.FDOTypeInt as obj.FDOName for obj in FDOTypes" ng-disabled="disabledType">
                                        <option value="">---Select Type---</option>
                                    </select>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Issue To:</label></div>
                                <div class="col-md-3 text-left">
                                    <div class="input-group">
                                        <input ng-model="FabricDeliveryOrder.ContractorName" ng-keyup="searchContractorByKeyUp($event)" class="form-control" placeholder="Search Supplier...." ng-disabled="disabled" required />
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="searchContractor()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Buying House:</label></div>
                                <div class="col-md-3 text-left">
                                    <div class="input-group">
                                        <input ng-model="FabricDeliveryOrder.BuyerName" ng-keyup="searchBuyerByKeyUp($event)" class="form-control" placeholder="Search Buying House...." ng-disabled="disabled" required />
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="searchBuyer()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>DO Info</legend>
                            <div class="row col-md-12">
                                <div class="col-md-2 text-right"><label class="control-label">DO No:</label></div>
                                <div class="col-md-3 text-left">
                                    @*<input ng-model="FabricDeliveryOrder.DONo" ng-disabled="disabled" class="form-control"   />*@
                                    <input type="text" ng-model="FabricDeliveryOrder.DONo" placeholder="17-0000" class=" form-control" onkeypress="return event.charCode==0 ||event.charCode==8 || (event.charCode >= 45 && event.charCode <= 57)" />
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">DO Date:</label></div>
                                <div class="col-md-3 text-left">
                                    @*<div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="FabricDeliveryOrder.DODateSt" ng-disabled="disabled"><span class="input-group-addon"><i class="glyphicon glyphicon-th" ng-disabled="disabled"></i></span>
                                </div>*@
                                    <md-datepicker ng-model="FabricDeliveryOrder.DODateSt" md-placeholder="Enter date"></md-datepicker>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Delivery Date:</label></div>
                                <div class="col-md-3 text-left">
                                    @*<div class="input-group date date-container">
                                    <input type="text" class="form-control" ng-model="FabricDeliveryOrder.ExpDeliveryDateSt" ng-disabled="disabled"><span class="input-group-addon"><i class="glyphicon glyphicon-th" ng-disabled="disabled"></i></span>
                                </div>*@
                                    <md-datepicker ng-model="FabricDeliveryOrder.ExpDeliveryDateSt" md-placeholder="Enter date"></md-datepicker>
                                </div>
                            </div>
                            <div class="row col-md-12">
                                <div class="col-md-2 text-right"><label class="control-label">Delivery To Name:</label></div>
                                <div class="col-md-3 text-left">
                                    <select ng-model="FabricDeliveryOrder.ContractorID" ng-options="obj.ContractorID as obj.DeliveryToName for obj in Contractors" ng-disabled="disabled" class="form-control"></select>
                                </div>
                                <div class="col-md-2 text-right"><label class="control-label">Concern Person:</label></div>
                                <div class="col-md-3 text-left">

                                    <div class="input-group">
                                        <select ng-model="FabricDeliveryOrder.BCPID" ng-options="obj.BCPID as obj.BuyerCPName for obj in BCPs" ng-disabled="disabled" class="form-control"></select>
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="searchBCP()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                        </span>
                                    </div>

                                </div>
                                <div class="col-md-2 text-right"><label class="control-label"></label></div>
                                <div class="col-md-3 text-left">
                                    @*<input ng-model="FabricDeliveryOrder.CotractNo" ng-disabled="disabled" class="form-control" required />*@
                                </div>
                            </div>
                            <div class="row col-md-12">
                                <div class="col-md-2 text-right"><label class="control-label">Delivery Point:</label></div>
                                <div class="col-md-5 text-left">
                                    <div class="input-group">
                                        <input ng-model="FabricDeliveryOrder.DeliveryPoint" ng-disabled="disabled" ng-keydown="SearchZoneByKeyDown($event)" class="form-control" placeholder="Search Delivery Zone...." style="width:100%; margin-left:5px" />
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="PickZoneByContartor()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="OpenUpdateModal('Add')"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                            <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-disabled="disabled" ng-click="OpenUpdateModal('Edit')"> <span class="glyphicon glyphicon-edit" aria-hidden="true"></span></button>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-1 text-right" style="margin-left:25px"><label class="control-label">Remarks:</label></div>
                                <div class="col-md-4 text-left">
                                    <input ng-model="FabricDeliveryOrder.Note" ng-disabled="disabled" class="form-control" />
                                </div>
                            </div>
                        </fieldset>
                        @*DETAILS TABLE*@
                        <fieldset>
                            <legend>Details : </legend>
                            <div class="ui-grid-panel">
                                <div class="container col-md-12">
                                    <div class="form-inline">

                                      

                                        <input ng-model="FabricDeliveryOrder.PINo" style="width:130px" class="form-control" ng-keydown="SearchKeyDownPIList($event,1)" placeholder="{{somePlaceholder}}" required />
                                        <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-click="searchPIList(1)"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> </button>

                                        <input ng-hide="FabricDeliveryOrder.FDOTypeInInt!=1" style="width:130px" ng-model="FabricDeliveryOrder.LCNo" class="form-control" ng-keydown="SearchKeyDownPIList($event,2)" placeholder="Type LC No & Press Enter" required />
                                        <button ng-hide="FabricDeliveryOrder.FDOTypeInInt!=1" type="button" class="btn btn-sm" aria-label="Left Align" ng-click="searchPIList(2)"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> </button>

                                        <input ng-model="FabricDeliveryOrder.SCNo" style="width:130px" class="form-control" ng-keydown="SearchKeyDownPOList($event,false)" placeholder="Type PO No & Press Enter" required />
                                        <button type="button" class="btn btn-sm btn-primary"  aria-label=" left align" ng-click="searchPOList(false)"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> </button>

                                        <input ng-model="FabricDeliveryOrder.DisPoNo" style="width:130px" class="form-control" ng-keydown="SearchKeyDownPOList($event,true)" placeholder="Type DisPO No & Press Enter" required />
                                        <button type="button" class="btn btn-sm btn-primary" aria-label="Left Align" ng-click="searchPOList(true)"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> </button>
                                        <button type="button" class="btn btn-sm btn-danger" aria-label="Left Align" ng-click="deleteDetail()" ng-hide="hide"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Remove </button>
                                        <button type="button" class="btn btn-sm" aria-label="Left Align" ng-hide="hideCutPiceType" ng-click="CopyDetail()"> <span class="glyphicon glyphicon-copy" aria-hidden="true">Cut Piece</span> </button>
                                        @*<button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="editDetail()" ng-hide="hide"> <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> </button>*@
                                        <input ng-model="txtDisPoNo" style="background-color:InfoBackground; margin-left:80px;width:130px" class="form-control" ng-keydown="searchDispoByKeyUp($event,false)" placeholder="Type Dispo No to change" required />
                                        

                                        @*<button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="changeDetail()" ng-hide="hide"> <span class="glyphicon glyphicon-check" aria-hidden="true"> Change Dispo </span> </button>*@
                                    </div>
                                </div>
                            </div>
                            <div class="row col-md-12">
                                <div  ui-grid="gridOptions" ui-grid-selection ui-grid-resize-columns ui-grid-edit class="grid"></div>
                            </div>
                        </fieldset>
                    </md-content>
                </md-tab>
                <md-tab label="Notes" ng-if="showTab==true">
                    @*data-ng-if="ctrl.showTab"*@
                    <md-content class="">
                        <fieldset>
                            <legend>Notes : </legend>
                            <div class="row ui-grid-panel">
                                <div class="container col-md-12">
                                    <div class="form-inline">
                                        <input ng-model="$parent.FDONote.Note" class="form-control" style="margin-left:15px; width:50%" ng-keydown="$parent.keyAddNote($event)" placeholder="Write Note ..." required />
                                        <button type="button" class="btn btn-sm btn-success" aria-label=" left align" ng-click="$parent.addNote()"> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add </button>

                                        <button type="button" class="btn btn-sm btn-danger" style=" float:right; margin-right:15px" aria-label="Left Align" ng-click="$parent.deleteNote()" ng-hide="hide"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row col-md-12">
                                <div ui-grid="gridOptionsNote" style="" ui-grid-selection ui-grid-resize-columns ui-grid-edit class="grid gridNote ui-grid-selectable"></div>
                            </div>
                        </fieldset>
                    </md-content>
                </md-tab>
            </md-tabs>
        </md-content>
        <fieldset>
            <legend>Action</legend>
            <div class="row col-md-12 text-right">
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save_Revise()" ng-hide="hide_Revise"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Save(Revise)</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="Approve()" ng-hide="hide_Approve"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Approve</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save()" ng-hide="hide_Save"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true">Save</span> </button>
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
            </div>
        </fieldset>
    </div>
    <script type="text/ng-template" id="DeliveryZone.html">
        <div class="modal-header">
            <h4 class="modal-title" id="modal-title">{{lblDeliveryZone}}</h4>
        </div>
        <div class="modal-body form-horizontal regionExportUP ms-custom-control" id="modal-body">
            <div class="row">
                <div class="col-md-12 ">
                    <div class="col-md-3 text-right"><label class="control-label">Zone Name:</label></div>
                    <div class="col-md-7 text-left">
                        <input class="form-control" ng-model="DeliveryZone.DeliveryZoneName" placeholder="Delivery Zone Name..">
                    </div>
                </div>
            </div>
            @*<div class="row">
                    <div class="col-md-12 ">
                        <div class="col-md-3 text-right"><label class="control-label">Note:</label></div>
                        <div class="col-md-7 text-left">
                            <input type="text" class="form-control" ng-model="DeliveryZone.SalesStatusRemarks">
                        </div>
                    </div>
                </div>*@

        </div>
        <div class="modal-footer">
            <button type="button" class="btn-success btn-sm" aria-label="Left Align" ng-click="Save()" ng-hide="hide"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save</button>
            <button type="button" class="btn-danger btn-sm" aria-label="Left Align" ng-click="cancel()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel</button>
        </div>
    </script>
</div>

<style type="text/css">
    .grid {
        width: 100%;
        height: 210px;
    }

    .gridNote {
        width: 100%;
        height: 390px;
    }
  
    .regionFabricDeliveryOrder md-content md-tabs md-tabs-wrapper {
        height:40px;
        margin-top:-15px;
        background-color:#eaf2ff;
    }

    .form-horizontal .control-label {
        padding-top: 3px;
        margin-bottom: 0;
        text-align: right;
    }

    .btn-sm, .btn-group-sm > .btn {
        padding: 5px 10px;
        font-size: 10px;
        line-height: 1.4;
        border-radius: 2px;
    }

    .regionFabricDeliveryOrder .form-control {
        height: 22px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionFabricDeliveryOrder .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 5px;
    }

    .regionFabricDeliveryOrder .col-md-2 {
        width: 13%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionFabricDeliveryOrder .col-md-3 {
        width: 20%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionFabricDeliveryOrder .col-md-4 {
        width: 35%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionFabricDeliveryOrder .col-md-5 {
        width: 40%;
        padding-right: 5px;
        padding-left: 0px;
    }

    .regionFabricDeliveryOrder .col-md-10 {
        width: 86%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionFabricDeliveryOrder .btn-sm {
        padding: 3px 10px;
    }

    .regionFabricDeliveryOrder .input-group-addon {
        padding: 4px 8px;
    }
   .regionFabricDeliveryOrder .ui-grid-header-cell-primary-focus {
        line-height: 1;
    }
    #progressbarParent {
        opacity: 0.8;
        background-color: #ffffff /*#DCD9D4*/;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0px;
        left: 0px;
        z-index: 1000;
    }
</style>

<script type="text/javascript">
    $("#progressbar").progressbar({ value: 0 });
    $("#progressbarParent").hide();

    var _nBUID=0;
    _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
    var oFabricDeliveryOrder =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
    var oFDODetails =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDODetails));
    var oFDOTypes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDOTypes));
    var oBCPs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BCPs));
    var oFDONotes =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.FDONotes));
    var tab =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.tab));
    _nBUID =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BUID));
    var oMeasurementUnitCon =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.MeasurementUnitCon));


    var FabricDeliveryOrderModule = angular.module('FabricDeliveryOrderAPP', ['ngAnimate','ngMaterial', 'ui.bootstrap', 'ui.grid', 'ui.grid.selection','ui.grid.resizeColumns', 'ui.grid.edit','ms.service']);
    FabricDeliveryOrderModule.controller('FabricDeliveryOrderCtrl', function ($scope, $http, $uibModal, $log,$mdDateLocale, uiGridConstants, msModal, userSession) {
        
        $mdDateLocale.formatDate = function(date) {
            return moment(date).format('DD-MMM-YYYY');
        };
        debugger;
        $scope.showTab = tab;
        $scope.MeasuementValue=oMeasurementUnitCon.Value;
        var viewType = sessionStorage.getItem("Operation");
        if (viewType == 'View')
        {
            $scope.disabledType=true;
            $scope.disabled= true;
            $scope.hide=true;

            $scope.hide_Revise=true;
            $scope.hide_Approve=true;
            $scope.hide_Save=true;
        }
        else  if (viewType == 'Approve')
        {
            $scope.disabledType=true;
            $scope.disabled= true;
            $scope.hide=true;
            $scope.hide_Revise=true;
            $scope.hide_Approve=false;
            $scope.hide_Save=true;
        }
        else  if (viewType == 'Revise')
        {
            $scope.disabledType=true;
            $scope.disabled= false;
            $scope.hide=false;
            $scope.hide_Revise=false;
            $scope.hide_Approve=true;
            $scope.hide_Save=true;
        }
        else
        {
            $scope.disabled= false;
            $scope.hide=false;
            $scope.hide_Revise=true;
            $scope.hide_Approve=true;
            $scope.hide_Save=false;
        }
        $scope.FDOTypes=oFDOTypes;
        $scope.FabricDeliveryOrder=oFabricDeliveryOrder;
        $scope.BCPs=oBCPs;
        $scope.ExportPIID=0;
        if($scope.FabricDeliveryOrder.FDOID>0)
        {
            $scope.disabledType=true;
        }
        $scope.somePlaceholder = 'Type P/I No & Press Enter';
        //$scope.changeFDOType();
      //  $scope.hideCutPiceType =true; 
        if(($scope.FabricDeliveryOrder.FDOTypeInInt==8))
        {
            $scope.hideCutPiceType =false;    
        }
        else{
            $scope.hideCutPiceType =true; 
        }
        var oContractors=[];
        if(oFabricDeliveryOrder.FDOID>0)
        {
            var oContractor={ContractorID:oFabricDeliveryOrder.ContractorID,DeliveryToName:oFabricDeliveryOrder.DeliveryToName}
            oContractors.push(oContractor);
            if(oFabricDeliveryOrder.IssueToID!=oFabricDeliveryOrder.ContractorID)
            {
                var oContractor={ContractorID:oFabricDeliveryOrder.IssueToID,DeliveryToName:oFabricDeliveryOrder.ContractorName}
                oContractors.push(oContractor);
            }
            if(oFabricDeliveryOrder.BuyerID!=oFabricDeliveryOrder.ContractorID)
            {
                var oContractor={ContractorID:oFabricDeliveryOrder.BuyerID,DeliveryToName:oFabricDeliveryOrder.BuyerName}
                oContractors.push(oContractor);
            }
        }
        $scope.Contractors=oContractors


        var oDetailColumns = [];
        var //oColumn =   {name: ' ',width:'3%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
        oColumn =  {name: ' ',width:'3%', cellTemplate: '<div style="padding-top:5px;"><span>{{grid.renderContainers.body.visibleRowCache.indexOf(row)+1}}</span></div>',cellClass: 'text-center', enableCellEdit: false, enableSorting:false, enableColumnResizing:false, enableColumnMenu:false};oDetailColumns.push(oColumn);
        oColumn = { field:'FEONo', name:'PO No', width:'11%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'FabricNo', name:'Mkt Ref No', width:'10%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'Qty', name: 'Qty(Y)', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        oColumn ={ field: 'Qty_Meter', name: 'Qty(M)', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        oColumn ={ field: 'Qty_DC', name: 'Challan Qty', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:false,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        oColumn ={ field: 'Qty_RC', name: 'Return Qty', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:false,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        oColumn ={ field: 'Construction', name:'Construction', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'MUName', name:'Unit', width:'6%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'ExeNo', name:'Dispo No', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'PINo', name:'P/I No', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'ColorInfo', name:'ColorInfo', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
        oColumn ={ field: 'StyleNo', name:'StyleNo', width:'7%',enableCellEdit:false ,enableColumnResizing:true};oDetailColumns.push(oColumn);
        oColumn ={ field: 'BuyerRef', name:'BuyerRef', width:'7%',enableCellEdit:false };oDetailColumns.push(oColumn);
        
        oColumn ={ field: 'UnitPrice', name: 'UP(Y)', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
        oColumn ={ field: 'DOPriceTypeSt', name:'PriceType', width:'7%',enableCellEdit:false };oDetailColumns.push(oColumn);
        
        ////Commercial invoice LC Detail
        $scope.gridOptions = {
            enableRowHeaderSelection: false,
            enableRowSelection: true,
            enableFullRowSelection: true,
            multiSelect: false,
            enableColumnResizing: true,
            noUnselect : true,
            showColumnFooter: true,
            //enableGridMenu: true,
            rowHeight: 25 ,
            columnFooterHeight:25,
            enableHorizontalScrollbar: uiGridConstants.scrollbars.ALWAYS,
            columnDefs:oDetailColumns,
            data:oFDODetails,
            onRegisterApi: function (gridApi) {
                $scope.gridDetailApi = gridApi;
                gridApi.edit.on.afterCellEdit($scope,
                    function (rowEntity, colDef, newValue, oldValue)
                    {
                        debugger;
                        if(colDef.field=="Qty_Meter")
                        {
                            if(!isNaN($scope.MeasuementValue) && $scope.MeasuementValue>0)
                                rowEntity.Qty=newValue/$scope.MeasuementValue;
                        }else if(colDef.field=="Qty")
                        {
                            if(!isNaN($scope.MeasuementValue) && $scope.MeasuementValue>0)
                                rowEntity.Qty_Meter=newValue*$scope.MeasuementValue;
                        }
                        console.log(colDef);
                        return rowEntity;
                    });
            }
        };

        $scope.gridOptionsNote = {
            showColumnFooter: true,
            enableFullRowSelection: true,
            enableColumnResizing: true,
            ///enableRowHeaderSelection: false,
            enableSelectAll: false,
            multiSelect:false,
            enableHorizontalScrollbar: uiGridConstants.scrollbars.NEVER,
            columnDefs:[{ field: 'Note', name:'Note', width:'90%',enableCellEdit:true }],
            data:oFDONotes,
            onRegisterApi: function (gridApi) {
                $scope.gridNoteApi = gridApi;
                gridApi.edit.on.afterCellEdit($scope,
                    function (rowEntity, colDef, newValue, oldValue)
                    {
                        return rowEntity;
                    });
            }
        };

        //*********** Fabric Sales Contact Picker
        $scope.changeDetail=function()
        {
            var data=$scope.gridDetailApi.selection.getSelectedRows();

            if(data==null || data[0]==undefined)
            {
                msModal.Message({headerTitle : '', bodyText:'No item found. Please select an item & try again!', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            $scope.getsDispo();
        };
        $scope.searchDispoByKeyUp=function(e)
        {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) 
            {
                var data=$scope.gridDetailApi.selection.getSelectedRows();

                if(data==null || data[0]==undefined)
                {
                    msModal.Message({headerTitle : '', bodyText:'No item found. Please select an item & try again!', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                    return false;
                }
                $scope.getsDispo();
            }
        };

        $scope.getsDispo=function()
        {
            debugger;
            var sTxt=($scope.txtDisPoNo==undefined)?"":$scope.txtDisPoNo;

            if(sTxt==""){ alert('Please Type dispo no and try agian !!'); return;};

            var obj={
                ExeNo:sTxt
            }

            $.icsProgressBar(true);

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/FabricSCReport/GetsBySCNoExeNo',$.param(obj), config).then(
                                  function (response) 
                                  { 
                                      debugger;
                                      var results=(response.data); 
                                      var modalObj={
                                          size:'md',
                                          title:'Dispo List',
                                          url:_sBaseAddress+'/Home/Modal',
                                          modalController:'DispoModalCtrl', 
                                          appController:'FNExeController', 
                                          objs:results, 
                                          multiSelect:false,
                                          columns:[{ field: 'ExeNo', name: 'Dispo No' },{ field: 'SCNoFull', name: 'PO No' },{ field: 'FabricNo', name: 'Fabric No' }]
                                      }

                                      
                                      $.icsProgressBar(false);
                                      var modalInstance=msModal.Instance(modalObj);
                                      modalInstance.result.then(function (result) {
                                     
                                          debugger;
                                          //if(result.FabricSalesContractDetailID>0)
                                          //{
                                          //    if(!confirm(" Confirm to change dispo no? "))return false;

                                          //    $scope.txtDisPoNo="";
                                          //    var data=$scope.gridDetailApi.selection.getSelectedRows()[0];
                                          //    var index=$scope.gridOptions.data.indexOf(data);
                                          //    data.FEOID=result.FabricSalesContractDetailID;
                                          //    data.ExeNo=result.ExeNo;
                                          //    data.FabricNo=result.FabricNo;
                                          //    data.FEONo=result.SCNoFull;
                                          //    $scope.gridOptions.data[index]=data;
                                          //}

                                          if(result.FabricSalesContractDetailID>0)
                                          {
                                              if(!confirm(" Confirm to add dispo no? "))return false;

                                              $scope.txtDisPoNo="";
                                              var data=$scope.gridDetailApi.selection.getSelectedRows()[0];
                                              //oColumn = { field:'FEONo', name:'PO No', width:'11%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'FabricNo', name:'Mkt Ref No', width:'10%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'Qty', name: 'Qty(Y)', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'Qty_Meter', name: 'Qty(M)', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:true,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'Qty_DC', name: 'Challan Qty', cellClass: 'text-right',width: '7%' , cellFilter: 'number: 2', aggregationType: uiGridConstants.aggregationTypes.sum, aggregationHideLabel: true,  type: 'number', enableCellEdit:false,footerCellClass: 'text-right' ,footerCellFilter: 'number:0'};oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'Construction', name:'Construction', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'MUName', name:'Unit', width:'6%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'ExeNo', name:'Dispo No', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'PINo', name:'P/I No', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'ColorInfo', name:'ColorInfo', width:'9%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'StyleNo', name:'StyleNo', width:'7%',enableCellEdit:false ,enableColumnResizing:true};oDetailColumns.push(oColumn);
                                              //oColumn ={ field: 'BuyerRef', name:'BuyerRef', width:'7%',enableCellEdit:false };oDetailColumns.push(oColumn);
                                              var oFDOD = 
                                                  {
                                                      FEOID: result.FabricSalesContractDetailID,
                                                      ExeNo: result.ExeNo,
                                                      FabricNo: result.FabricNo,
                                                      FEONo: result.SCNoFull,
                                                      FabricID: result.FabricID,
                                                      Qty:result.Qty,
                                                      Construction:result.Construction,
                                                      MUName: result.MUName,
                                                      ColorInfo: result.ColorInfo,
                                                      StyleNo: result.StyleNo,
                                                      BuyerRef: result.BuyerRef,
                                                      PINo: data.PINo,  
                                                      ExportPIID: data.ExportPIID,
                                                      ExportPIDetailID: data.ExportPIDetailID
                                                  }
                                              $scope.gridOptions.data.push(oFDOD);
                                          }
                                      }, function () {
                                          
                                          $.icsProgressBar(false);
                                          $log.info('Modal dismissed at: ' + new Date());
                                      });
                                  },
                                  function (response) { alert(response.statusText);}
                            );
        };
        //*********** END FSCD

        $scope.save = function () {

            if($scope.FabricDeliveryOrder.FDOTypeInInt<=0)
            {
                alert("Please, Select DO Type");
                return;
            }

            $scope.FabricDeliveryOrder.DODate = $scope.FabricDeliveryOrder.DODateSt;
            $scope.FabricDeliveryOrder.ExpDeliveryDate = $scope.FabricDeliveryOrder.ExpDeliveryDateSt;
            $scope.FabricDeliveryOrder.FDODetails = $scope.gridOptions.data;
            $scope.FabricDeliveryOrder.FDONotes = $scope.gridOptionsNote.data;

            $http.post(_sBaseAddress+'/FabricDeliveryOrder/Save',JSON.stringify($scope.FabricDeliveryOrder)).then(
                                function (response) {
                                    var result=jQuery.parseJSON(response.data);

                                    debugger;
                                    if(result.FDOID>0  && result.ErrorMessage=="")
                                    {
                                        $scope.FabricDeliveryOrder=result;
                                        userSession.setData('FabricDeliveryOrders',$scope.FabricDeliveryOrder);
                                        userSession.previousPage();
                                        // msModal.Message({headerTitle : '', bodyText:'Save Successfully.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                    }
                                    else
                                    {
                                        alert(result.ErrorMessage);
                                        return;
                                    }

                                },
                                function (response) { alert(response.data);}
                        );
        };
        $scope.Approve = function () {

            $scope.FabricDeliveryOrder.DODate = $scope.FabricDeliveryOrder.DODateSt;
            $scope.FabricDeliveryOrder.FDODetails = $scope.gridOptions.data;

            $http.post(_sBaseAddress+'/FabricDeliveryOrder/Approved',JSON.stringify($scope.FabricDeliveryOrder)).then(
                                function (response) {
                                    var result=jQuery.parseJSON(response.data);
                                    console.log(result);
                                    if(result.FDOID>0  && result.ErrorMessage=="")
                                    {
                                        debugger;
                                        $scope.FabricDeliveryOrder=result;
                                        userSession.setData('FabricDeliveryOrders',$scope.FabricDeliveryOrder);
                                        userSession.previousPage();
                                        // msModal.Message({headerTitle : '', bodyText:'Save Successfully.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                    }
                                    else
                                    {
                                        alert(result.ErrorMessage);
                                        return;
                                    }

                                },
                                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                        );
        };
        $scope.save_Revise = function () {

            $scope.FabricDeliveryOrder.DODate = $scope.FabricDeliveryOrder.DODateSt;
            $scope.FabricDeliveryOrder.FDODetails = $scope.gridOptions.data;

            $http.post(_sBaseAddress+'/FabricDeliveryOrder/SaveLog',JSON.stringify($scope.FabricDeliveryOrder)).then(
                                function (response) {
                                    var result=jQuery.parseJSON(response.data);
                                    console.log(result);
                                    if(result.FDOID>0  && result.ErrorMessage=="")
                                    {
                                        debugger;
                                        $scope.FabricDeliveryOrder=result;
                                        userSession.setData('FabricDeliveryOrders',$scope.FabricDeliveryOrder);
                                        userSession.previousPage();
                                        // msModal.Message({headerTitle : '', bodyText:'Save Successfully.', sucessText : 'Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                                    }
                                    else
                                    {
                                        alert(result.ErrorMessage);
                                        return;
                                    }

                                },
                                function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                        );
        };

        $scope.close = function () {
            userSession.previousPage();
        };

        $scope.SearchZoneByKeyDown =  function (e) {
            debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtDeliveryPoint = $.trim($scope.FabricDeliveryOrder.DeliveryPoint);
                if(txtDeliveryPoint=="" || txtDeliveryPoint==null)
                {
                    alert("Please Type Zone and Press Enter");
                    return;
                }
                $scope.PickZone();
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.FabricDeliveryOrder.DeliveryPoint="";
                $scope.FabricDeliveryOrder.DeliveryZoneID=0;
            }
        };
        $scope.PickZone= function () {
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            var oFabricDeliveryOrder = {
                DeliveryZoneName: $.trim($scope.FabricDeliveryOrder.DeliveryPoint)
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/DeliveryZone/Gets',$.param(oFabricDeliveryOrder), config).then(
                    function (response)
                    {
                        var oColumns = [];
                        var oColumn = { field: 'DeliveryZoneName', name: 'Delivery Zone',width: '100%'  };oColumns.push(oColumn);
                        oColumn = { field: 'FabricNo', name: 'Mkt Ref No',width: '13%', enableSorting: false  };oColumns.push(oColumn);

                        //oColumn = { field: 'LCNo', name: 'L/C No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        var results=jQuery.parseJSON(response.data);
                        var modalObj={
                            size:'md',
                            title:'Zone List',
                            url:_sBaseAddress+'/Home/Modal',
                            modalController:'',
                            appController:'FabricDeliveryOrderCtrl',
                            objs:results,
                            multiSelect:false,
                            pickertitle:' Zone List',
                            searchingbyfieldName:'DeliveryZoneName',
                            columns:oColumns
                        }
                        $("#progressbar").progressbar({ value: 0 });//hide
                        $("#progressbarParent").hide();
                        var modalInstance=msModal.Instance(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            //result=JSON.parse(result);
                            if(result.DeliveryZoneID>0)
                            {
                                $scope.FabricDeliveryOrder.DeliveryPoint=result.DeliveryZoneName;
                                $scope.FabricDeliveryOrder.DeliveryZoneID=result.DeliveryZoneID;
                                event.currentTarget.focus();
                            }

                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };

        $scope.PickZoneByContartor= function () {
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            debugger;
            var oFabricDeliveryOrder = {
                DeliveryZoneName: $.trim($scope.FabricDeliveryOrder.DeliveryPoint),
                ErrorMessage:$scope.FabricDeliveryOrder.ContractorID
            };
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/FabricDeliveryOrder/GetsDeliveryZone',$.param(oFabricDeliveryOrder), config).then(
                    function (response)
                    {
                        var oColumns = [];
                        var oColumn = { field: 'DeliveryZoneName', name: 'Delivery Zone',width: '100%'  };oColumns.push(oColumn);
                        oColumn = { field: 'FabricNo', name: 'Mkt Ref No',width: '13%', enableSorting: false  };oColumns.push(oColumn);

                        //oColumn = { field: 'LCNo', name: 'L/C No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        var results=jQuery.parseJSON(response.data);

                        var modalObj={
                            size:'md',
                            title:'Zone List',
                            url:_sBaseAddress+'/Home/Modal',
                            modalController:'',
                            appController:'FabricDeliveryOrderCtrl',
                            objs:results,
                            multiSelect:false,
                            pickertitle:' Zone List',
                            searchingbyfieldName:'DeliveryZoneName',
                            columns:oColumns
                        }

                        $("#progressbar").progressbar({ value: 0 });//hide
                        $("#progressbarParent").hide();

                        if(results==undefined){
                            alert("No Data Found!");return;
                        }
                        if(results!=null && results[0].ErrorMessage!=''){
                            alert(results[0].ErrorMessage);return;
                        }

                        var modalInstance=msModal.Instance(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            //result=JSON.parse(result);
                            if(result.DeliveryZoneID>0)
                            {
                                $scope.FabricDeliveryOrder.DeliveryPoint=result.DeliveryZoneName;
                                $scope.FabricDeliveryOrder.DeliveryZoneID=result.DeliveryZoneID;
                                event.currentTarget.focus();
                            }

                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };

        $scope.SearchKeyDownPOList =  function (e, IsDispo) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {
                var txtSCNoFull = (IsDispo? $.trim($scope.FabricDeliveryOrder.DisPoNo) : $.trim($scope.FabricDeliveryOrder.SCNo));
                if(txtSCNoFull=="" || txtSCNoFull==null)
                {
                    alert("Type PO or DisPo No and Press Enter");
                    return;
                }
                $scope.PickPOList(IsDispo);
            }else if (code == 8) //backspace=8
            {
                //debugger;
                $scope.SCNoFull = '';
            }
        };
        $scope.searchPOList=function(IsDispo){
            if(($scope.FabricDeliveryOrder.IssueToID<=0 && $scope.FabricDeliveryOrder.BuyerID<=0) && ($.trim($scope.FabricDeliveryOrder.SCNo)=="" ||  $.trim($scope.FabricDeliveryOrder.SCNo)==null))
            {
                alert("Please, Select Issue To or Buying House Name or Type No");
                return;
            }
            $scope.PickPOList(IsDispo);
        };
        $scope.PickPOList= function (IsDispo) {

            if($scope.FabricDeliveryOrder.FDOTypeInInt<=0)
            {
                alert("Please, Select DO Type");  return;
            }

            var oFDODetails =$scope.gridOptions.data;
            var sFEOID="";
            if(oFDODetails!=null && oFDODetails.length>0)
            {
                for (var i = 0;i<oFDODetails.length; i++){
                    sFEOID = oFDODetails[i].FEOID + "," + sFEOID;
                }
                sFEOID = sFEOID.substring(0, sFEOID.length - 1);
            }

            if(($scope.FabricDeliveryOrder.FDOTypeInInt==1 && $scope.ExportPIID<=0))
            {
                alert("Please, First Pick PI.");
                return;
            }
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            var oFabricDeliveryOrder = {
                SCNo: (IsDispo ? $.trim($scope.FabricDeliveryOrder.DisPoNo) : $.trim($scope.FabricDeliveryOrder.SCNo)),
                FDOTypeInInt: $.trim($scope.FabricDeliveryOrder.FDOTypeInInt),
                IssueToID:$scope.FabricDeliveryOrder.IssueToID,
                BuyerID: $scope.FabricDeliveryOrder.BuyerID,
                ExportPIID:$scope.ExportPIID,
                Params:sFEOID,
                BUID:_nBUID,
                IsDisPo:IsDispo
            };

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/FabricDeliveryOrder/GetsPO',$.param(oFabricDeliveryOrder), config).then(
                    function (response)
                    {
                        debugger;
                        var oColumns = [];
                        var oColumn = { field: 'FEONo', name: 'PO No',width: '13%'  };oColumns.push(oColumn);
                        oColumn = { field: 'FabricNo', name: 'Mkt Ref No',width: '13%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'Qty_PI', name: 'Order Qty',width: '8%', enableSorting: false,aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right'   };oColumns.push(oColumn);
                        oColumn = { field: 'Qty_DO', name: 'Prev. DO',width: '8%', enableSorting: false ,aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right'  };oColumns.push(oColumn);
                        oColumn = { field: 'Qty_DC', name: 'Challan Qty',width: '8%', enableSorting: false,  aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right' };oColumns.push(oColumn);
                        oColumn = { field: 'Qty', name: 'Qty',width: '8%', enableSorting: false, aggregationType: uiGridConstants.aggregationTypes.sum,aggregationHideLabel: true, footerCellFilter: 'number:2', footerCellClass: 'text-right'  };oColumns.push(oColumn);
                        oColumn = { field: 'ExeNo', name: 'Dispo No',width: '10%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'PINo', name: 'PI No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        //oColumn = { field: 'OrderTypeSt', name: 'Order Type',width: '10%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'ContractorName', name: 'Issue To',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'BuyerName', name: 'Buying House',width: '15%', enableSorting: false  };oColumns.push(oColumn);

                        //oColumn = { field: 'LCNo', name: 'L/C No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        var results=jQuery.parseJSON(response.data);
                        var modalObj={
                            size:'lg',
                            title:'PO List',
                            url:_sBaseAddress+'/Home/Modal',
                            modalController:'',
                            appController:'FabricDeliveryOrderCtrl',
                            objs:results,
                            showColumnFooter:true,
                            multiSelect:true,
                            pickertitle:' PO List',
                            searchingbyfieldName:'SCNoFull',
                            columns:oColumns
                        }
                        $("#progressbar").progressbar({ value: 0 });//hide
                        $("#progressbarParent").hide();
                        var modalInstance=msModal.Instance(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            debugger;
                            var oFDODetailsTwo =$scope.gridOptions.data;
                            angular.forEach(result,function(value,index)
                            {
                                $scope.gridOptions.data.push(value);

                            });
                            //$scope.gridApi.grid.modifyRows($scope.gridOptions.data);

                            var oFDODetails =$scope.gridOptions.data;
                            if(oFDODetails.length>0)
                            {
                                debugger;
                                if($scope.Contractors.length<=0)
                                {
                                    $scope.FabricDeliveryOrder.ContractorName=oFDODetails[0].ContractorName;
                                    $scope.FabricDeliveryOrder.IssueToID=oFDODetails[0].ContractorID;

                                    debugger;
                                    var oContractors=[];
                                    var oContractor={ContractorID:oFDODetails[0].ContractorID,DeliveryToName:oFDODetails[0].ContractorName}
                                    oContractors.push(oContractor);
                                    if(oFDODetails[0].BuyerID>0 && oFDODetails[0].BuyerID!=oFDODetails[0].ContractorID)
                                    {
                                        $scope.FabricDeliveryOrder.BuyerName=oFDODetails[0].BuyerName;
                                        $scope.FabricDeliveryOrder.BuyerID=oFDODetails[0].BuyerID;

                                        oContractor={ContractorID:oFDODetails[0].BuyerID,DeliveryToName:oFDODetails[0].BuyerName}
                                        oContractors.push(oContractor);
                                    }
                                    $scope.Contractors=oContractors;
                                    $scope.FabricDeliveryOrder.ContractorID=oFDODetails[0].ContractorID;
                                    //$scope.FabricDeliveryOrder.DeliveryPoint=oFDODetails[0].ContractorAddress;
                                    var oBCPs=[];
                                    var oBCP={BCPID:oFDODetails[0].BCPID, BuyerCPName:oFDODetails[0].BuyerCPName }
                                    if(oBCP.BCPID>0)
                                    {
                                        oBCPs.push(oBCP);
                                        $scope.BCPs=oBCPs;
                                        $scope.FabricDeliveryOrder.BCPID=oBCP.BCPID;
                                    }
                                }
                                $scope.disabledType=true;
                                event.currentTarget.focus();
                            }

                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };
        $scope.CopyDetail= function ()
        {
            debugger;
            var oDetail=$scope.gridDetailApi.selection.getSelectedRows()[0];
            //var data=$scope.gridApi.selection.getSelectedRows();
            if(oDetail==null)
            {
                alert("Select At least One item !");
                return;
            }
            if (!confirm("Confirm to Copy?")) return ;

            var oFDOD=
                {
                    FEONo: oDetail.FEONo,
                    FabricNo : oDetail.FabricNo,
                    Qty_Meter :0,
                    Qty_DC : 0,
                    Qty:0,
                    ExeNo : oDetail.ExeNo,
                    Construction : oDetail.Construction,
                    PINo : oDetail.PINo,
                    ColorInfo : oDetail.ColorInfo,
                    Construction : oDetail.Construction,
                    StyleNo : oDetail.StyleNo,
                    BuyerRef : oDetail.BuyerRef,
                    DOPriceTypeSt: "Cut Price",
                    DOPriceType: 2,
                    UnitPrice : 0,
                    FEOID : oDetail.FEOID,
                    FabricID : oDetail.FabricID,
                    ExportPIID : oDetail.ExportPIID,
                    OrderType : oDetail.OrderType,
                    FDODID :   0,
                    FDOID :   0,
                    ProductID : oDetail.ProductID
                  
            
                };
            
            $scope.gridOptions.data.push(oFDOD);
        }

        $scope.deleteDetail= function ()
        {
            var data=$scope.gridDetailApi.selection.getSelectedRows();

            if(data==null || data.length<=0)
            {
                msModal.Message({headerTitle : '', bodyText:'No item found to delete.', sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            
            if (!confirm("Confirm to Delete?")) return ;
            var index=$scope.gridOptions.data.indexOf(data[0]);
            $scope.gridOptions.data.splice(index,1);
        }
       
        ///PI///
        $scope.SearchKeyDownPIList =  function (e,nRef) {
            //debugger;
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) {

                if(nRef==2)
                {
                    if($scope.FabricDeliveryOrder.FDOTypeInInt!=1)
                    {
                        alert("Please, Select DO Type(Export)");
                        return;
                    }
                }
                else if($scope.FabricDeliveryOrder.FDOTypeInInt!=1 && $scope.FabricDeliveryOrder.FDOTypeInInt!=3 && $scope.FabricDeliveryOrder.FDOTypeInInt!=2 && $scope.FabricDeliveryOrder.FDOTypeInInt!=9)
                {
                    alert("Please, Select DO Type(Export or Advance)");
                    return;
                }
                var txtRefNo="";

                if(nRef==1)
                    txtRefNo=$.trim($scope.FabricDeliveryOrder.PINo);
                else if(nRef==2)
                    txtRefNo=$.trim($scope.FabricDeliveryOrder.LCNo);

                if(txtRefNo=="" || txtRefNo==null)
                {
                    if(nRef==1)
                        alert("Type PI No and Press Enter");
                    else   if(nRef==2)
                        alert("Type LC No and Press Enter");
                    return;
                }
                $scope.PickPIList(nRef);
            }else if (code == 8) //backspace=8
            {
                if(nRef==1)
                    $scope.PINo = '';
                if(nRef==2)
                    $scope.LCNo = '';
            }
        };
        $scope.searchPIList=function(nRef){
            debugger;
            //if($scope.FabricDeliveryOrder.FDOTypeInInt!=1 && $scope.FabricDeliveryOrder.FDOTypeInInt!=3 &&  $scope.FabricDeliveryOrder.FDOTypeInInt!=2)
            //{
            //    alert("Please, Select DO Type");
            //    return;
            //}
            if(($scope.FabricDeliveryOrder.IssueToID<=0 && $scope.FabricDeliveryOrder.BuyerID<=0) && ($.trim($scope.FabricDeliveryOrder.PINo)=="" ||  $.trim($scope.FabricDeliveryOrder.PINo)==null))
            {
                alert("Please, Select Issue To or Buying House Name or Type any No");
                return;
            }

            $scope.PickPIList(nRef);
        };
        $scope.PickPIList= function (nRef) {

            if(nRef==1)
            {
                var oFabricDeliveryOrder = {
                    PINo: $.trim($scope.FabricDeliveryOrder.PINo),
                    FDOTypeInInt: $.trim($scope.FabricDeliveryOrder.FDOTypeInInt),
                    IssueToID:$scope.FabricDeliveryOrder.IssueToID,
                    BuyerID: $scope.FabricDeliveryOrder.BuyerID,
                    BUID:_nBUID

                };
            }else
            {
                var oFabricDeliveryOrder = {
                    LCNo: $.trim($scope.FabricDeliveryOrder.LCNo),
                    FDOTypeInInt: $.trim($scope.FabricDeliveryOrder.FDOTypeInInt),
                    IssueToID:$scope.FabricDeliveryOrder.IssueToID,
                    BuyerID: $scope.FabricDeliveryOrder.BuyerID,
                    BUID:_nBUID
                };
            }

            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/FabricDeliveryOrder/GetsExportPI',$.param(oFabricDeliveryOrder), config).then(
                    function (response)
                    {
                        debugger;
                        var oColumns = [];
                        var oColumn = { field: 'PINo', name: 'PI No',width: '20%'  };oColumns.push(oColumn);
                        oColumn = { field: 'Qty', name: 'Qty',width: '12%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'ContractorName', name: 'Issue To',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'BuyerName', name: 'Buying House',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        oColumn = { field: 'LCNo', name: 'L/C No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        //oColumn = { field: 'LCNo', name: 'L/C No',width: '15%', enableSorting: false  };oColumns.push(oColumn);
                        var results=jQuery.parseJSON(response.data);
                        var modalObj={
                            size:'lg',
                            title:'PI List',
                            url:_sBaseAddress+'/Home/Modal',
                            modalController:'',
                            appController:'FabricDeliveryOrderCtrl',
                            objs:results,
                            multiSelect:false,
                            pickertitle:' PI List',
                            searchingbyfieldName:'PINo',
                            columns:oColumns
                        }
                        $("#progressbar").progressbar({ value: 0 });//hide
                        $("#progressbarParent").hide();
                        var modalInstance=msModal.Instance(modalObj);
                        modalInstance.result.then(function (result)
                        {
                            $scope.FabricDeliveryOrder.PINo=result.PINo;
                            $scope.FabricDeliveryOrder.LCNo=result.LCNo;
                            $scope.FabricDeliveryOrder.ContractorName=result.ContractorName;
                            $scope.FabricDeliveryOrder.IssueToID=result.ContractorID;

                            var oContractors=[];
                            var oContractor={ContractorID:result.ContractorID,DeliveryToName:result.ContractorName}
                            oContractors.push(oContractor);
                            if(result.BuyerID>0 && result.BuyerID!=result.ContractorID)
                            {
                                $scope.FabricDeliveryOrder.BuyerName=result.BuyerName;
                                $scope.FabricDeliveryOrder.BuyerID=result.BuyerID;

                                oContractor={ContractorID:result.BuyerID,DeliveryToName:result.BuyerName}
                                oContractors.push(oContractor);
                            }
                            $scope.Contractors=oContractors;
                            $scope.FabricDeliveryOrder.ContractorID=result.ContractorID;
                            $scope.ExportPIID=result.ExportPIID;


                        }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                    },
                        function (response) { alert(jQuery.parseJSON(response.data).Message);}
                );
        };
        ///endPI//

       

        $scope.keyAddNote=function(keyEvent){
            if(keyEvent.which==13){
                $scope.addNote();
            }
        };
        $scope.addNote=function()
        {
            if($scope.FDONote.Note=="" || $scope.FDONote.Note==undefined)
            {
                alert("Please Write A Note And Try Again!!"); return;
            }

            var oNote=
                {
                    FDONoteID:0,
                    FDOID:$scope.FabricDeliveryOrder.FDOID,
                    Note:$scope.FDONote.Note,
                }
            $scope.gridOptionsNote.data.push(oNote);$scope.FDONote.Note="";
        }
        $scope.deleteNote = function ()
        {
            debugger;
            var data = $scope.gridNoteApi.selection.getSelectedRows();
            if(data==null || data[0].length>0){
                msModal.Message({headerTitle : '', bodyText:"Select an item from list", sucessText : ' Yes', cancelText : ' Close', feedbackType:false, autoClose : false});
                return false;
            }
            
            $scope.gridOptionsNote.data.splice($scope.gridOptionsNote.data.indexOf(data[0]), 1);
        };

        $scope.OpenUpdateModal=function (opt)
        {
            debugger;
            if(opt=="Edit" && $scope.FabricDeliveryOrder.DeliveryZoneID<=0)
            {
                alert("Delivery Zone Not Found !!"); return;
            }

            var DZone={DeliveryZoneID:$scope.FabricDeliveryOrder.DeliveryZoneID, DeliveryZoneName:$scope.FabricDeliveryOrder.DeliveryPoint};
            $scope.Modal(DZone, opt);
        }
        $scope.Modal = function (obj, operation, url) {
            debugger;
            var modalInstance = $uibModal.open({
                //animation: $scope.animationsEnabled,
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                size: 'lg',
                templateUrl: 'DeliveryZone.html',
                controller: 'ModalInstanceCtrl',
                controllerAs: 'DeliveryZoneCtrl',
                resolve: {
                    obj: function () {
                        return { value:obj, operation: operation };
                    }
                }
            });

            modalInstance.result.then(function (result) {

                if(result.DeliveryZoneID>0)
                {
                    $scope.FabricDeliveryOrder.DeliveryPoint=result.DeliveryZoneName;
                    $scope.FabricDeliveryOrder.DeliveryZoneID=result.DeliveryZoneID;
                }
                //if(operation=='add'){
                //    $scope.gridOptions.data.push(result);
                //    if(result.FabricDeliveryOrder.FabricDeliveryOrderID>0)
                //    {
                //        $scope.FabricDeliveryOrder=result.FabricDeliveryOrder;
                //        userSession.setData('FabricDeliveryOrders',$scope.FabricDeliveryOrder);
                //        $scope.gridApi.grid.modifyRows($scope.gridOptions.data);
                //        $scope.gridDetailApi.selection.selectRow($scope.gridOptions.data[0]);
                //    }
                //}
                //else{
                //    $scope.gridOptions.data[$scope.index]=result;
                //    $scope.gridApi.grid.modifyRows($scope.gridOptions.data);
                //    $scope.gridDetailApi.selection.selectRow($scope.gridOptions.data[$scope.index]);
                //}
            }, function () {
                $log.info('Modal dismissed at: ' + new Date());
            });
        };

        $scope.searchContractorByKeyUp=function(keyEvent){
            if(keyEvent.which==13){
                $scope.getsContractor();
            }
            else if(keyEvent.which==8){
                $scope.FabricDeliveryOrder.ContractorID=0;
            }
        };

        $scope.searchContractor=function(){
            $scope.getsContractor();
        };

        $scope.getsContractor=function(){
            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            var obj={
                Params: '3' + '~' + (($scope.FabricDeliveryOrder.ContractorName==undefined)?"":$scope.FabricDeliveryOrder.ContractorName)+'~'+_nBUID
            }
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(obj), config).then(
                                    function (response)
                                    {
                                        debugger;
                                        var results=response.data;
                                        var modalObj={
                                            size:'sm',
                                            title:'Contractor List',
                                            url:_sBaseAddress+'/Home/Modal',
                                            modalController:'ContractorModalCtrl',
                                            appController:'FabricDeliveryOrderCtrl',
                                            objs:results,
                                            multiSelect:false,
                                            columns:[{ field: 'Name', name: 'Contractor Name' }]
                                        }
                                        $("#progressbar").progressbar({ value: 0 });//hide
                                        $("#progressbarParent").hide();
                                        var modalInstance=msModal.Instance(modalObj);
                                        modalInstance.result.then(function (result) {
                                            $scope.FabricDeliveryOrder.ContractorID=0;
                                            $scope.FabricDeliveryOrder.ContractorName="";
                                            if(result.ContractorID>0){
                                                $scope.FabricDeliveryOrder.ContractorName=result.Name;
                                                $scope.FabricDeliveryOrder.IssueToID=result.ContractorID;
                                                var oContractors=[];
                                                var oContractor={ContractorID:result.ContractorID,DeliveryToName:result.Name}
                                                oContractors.push(oContractor);
                                                $scope.Contractors=oContractors;
                                                $scope.FabricDeliveryOrder.ContractorID=oContractor.ContractorID;
                                            }

                                        }, function () {
                                            $log.info('Modal dismissed at: ' + new Date());
                                        });
                                    },
                                    function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                            );
        };

        function updateProgress() {
            var value =$('#progressbar').progressbar('getValue');
            if (value < 90){
                value += Math.floor(Math.random() * 10);
                $('#progressbar').progressbar('setValue', value);
            }
        }
        function hideShow(miliseconds) {
            $("#progressbarParent").hide();
        }

        $scope.searchBuyerByKeyUp=function(keyEvent){
            if(keyEvent.which==13){
                $scope.searchBuyer();
            }
            else if(keyEvent.which==8){
                $scope.FabricDeliveryOrder.BuyerID=0;
            }
        };

        $scope.searchBuyer=function(){
            $scope.getsBuyer();
        };

        $scope.getsBuyer=function(){

            $("#progressbar").progressbar({ value: 0 });
            $("#progressbarParent").show();
            setInterval(updateProgress,250);

            debugger;
            var obj={
                Params: '2' + '~' + (($scope.FabricDeliveryOrder.BuyerName==undefined)?"":$scope.FabricDeliveryOrder.BuyerName)+'~'+_nBUID
            }
            var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
            $http.post(_sBaseAddress+'/Contractor/ContractorSearchByNameType',$.param(obj), config).then(
                                    function (response)
                                    {
                                        $("#progressbar").progressbar({ value: 0 });//hide
                                        $("#progressbarParent").hide();

                                        var results=response.data;
                                        var modalObj={
                                            size:'sm',
                                            title:'Contractor List',
                                            url:_sBaseAddress+'/Home/Modal',
                                            modalController:'ContractorModalCtrl',
                                            appController:'FabricDeliveryOrderCtrl',
                                            objs:results,
                                            multiSelect:false,
                                            columns:[{ field: 'Name', name: 'Contractor Name' }]
                                        }

                                        var modalInstance=msModal.Instance(modalObj);
                                        modalInstance.result.then(function (result) {
                                            $scope.FabricDeliveryOrder.BuyerID=0;
                                            $scope.FabricDeliveryOrder.BuyerName="";
                                            if(result.ContractorID>0){
                                                $scope.FabricDeliveryOrder.BuyerName=result.Name;
                                                $scope.FabricDeliveryOrder.BuyerID=result.ContractorID;
                                                var oContractors=[];
                                                var oContractor={ContractorID:result.ContractorID,DeliveryToName:result.Name}
                                                oContractors.push(oContractor);
                                                $scope.Contractors=oContractors;
                                                $scope.FabricDeliveryOrder.ContractorID=oContractor.ContractorID;
                                            }

                                        }, function () {
                                            $log.info('Modal dismissed at: ' + new Date());
                                        });
                                    },
                                    function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage);}
                            );
        };

        $scope.changeFDOType = function()
        {
            debugger;
            if(($scope.FabricDeliveryOrder.FDOTypeInInt==2))
            {
                $scope.somePlaceholder = 'Type Bill/Invoice No & Press Enter';
            }
            else{
                $scope.somePlaceholder = 'Type PI No & Press Enter';
            }

            if(($scope.FabricDeliveryOrder.FDOTypeInInt==8))
            {
                $scope.hideCutPiceType =false;    
            }
            else{
                $scope.hideCutPiceType =true; 
            }
        };

        $scope.searchBCP=function()
        {

            if($scope.FabricDeliveryOrder.ContractorID<=0)
            {
                alert("Please Select Delivery To");
                return;
            }

            if($scope.FabricDeliveryOrder.ContractorID>0)
            {
                var oContactPersonnel = { ContractorName:$scope.FabricDeliveryOrder.ContractorID,Name:''};
                debugger;

                var config = { headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;' } };
                $http.post(_sBaseAddress+'/ContractorPersonal/GetsByContractors',$.param(oContactPersonnel), config).then(
                            function (response)
                            {
                                var oBCPs=[];
                                var oBCPs_Temp = jQuery.parseJSON(response.data);
                                if(oBCPs_Temp.length>0)
                                {
                                    for(var i = 0; i<oBCPs_Temp.length;i++)
                                    {
                                        var oBCP={BCPID:oBCPs_Temp[i].ContactPersonnelID ,BuyerCPName:oBCPs_Temp[i].Name };
                                    }
                                    oBCPs.push(oBCP);
                                    $scope.BCPs=oBCPs

                                }else{
                                    alert("Data Not found.");
                                }

                            },
                                function (response) { alert(jQuery.parseJSON(response.data).Message); }
                        );


            }

        };
    });


    FabricDeliveryOrderModule.controller('ModalInstanceCtrl', function ($scope, $http, $uibModalInstance, msModal, obj) {
        debugger;
        $scope.operation=obj.operation;
        $scope.DeliveryZone=obj.value;
        $scope.lblDeliveryZone="";
        $scope.lblDeliveryZone=$scope.operation+" Delivery Zone ";

        $scope.Save= function ()
        {
            if (!confirm("Confirm to Update ?")) return ;
            debugger;
            var oDeliveryZone= $scope.DeliveryZone;
            $http.post(sessionStorage.getItem('BaseAddress')+'/DeliveryZone/SaveDeliveryZone', JSON.stringify(oDeliveryZone)).then(
                            function (response)
                            {
                                debugger;
                                if (jQuery.parseJSON(response.data)!=null && jQuery.parseJSON(response.data).DeliveryZoneID > 0 && jQuery.parseJSON(response.data).ErrorMessage=="")
                                {
                                    alert("Successfully Saved.");
                                    $uibModalInstance.close(jQuery.parseJSON(response.data));
                                }
                                else
                                {
                                    alert(jQuery.parseJSON(response.data).ErrorMessage);
                                }
                            },
                            function (response) { alert(jQuery.parseJSON(response.data).ErrorMessage); }
                        );
        };

        $scope.cancel= function () {
            $uibModalInstance.close();
        };
    });

</script>


