@{
    ViewBag.Title = "Knitting Challan List";
}
@model IEnumerable<ESimSol.BusinessObjects.KnittingYarnChallan>
    <div id="progressbarParent" style="width:100%;height:100%;margin:0 auto;text-align:center; margin-left: auto;margin-right: auto;left: 0;right: 0;z-index: 1;">
        <div style="margin: 0px auto;margin-top: 251px;text-align:center;width:390px;">
            <label style="font-size:18px;">Please wait</label>
            <div id="progressbar" style="width:100%;height:37px;"></div>
        </div>
    </div>
    
    <div class="menuMainCollectionTable" id="divKnittingYarnChallan">
        <table id="tblKnittingYarnChallans" title="Knitting Challan List" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
            <thead>
                <tr>
                    <th field="ChallanNo" width="9%">Challan No</th>
                    <th field="ChallanDateInString" width="10%">Challan Date</th>
                    <th field="DeliveryPoint" width="12%">Delivery Point</th>
                    <th field="CarNumber" width="12%">Truck Number</th> 
                    <th field="DriverName" width="12%">Driver Name</th> 
                    <th field="Remarks" width="30%">Remarks</th>
                    <th field="ApproveUser" width="30%">Approve By</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Add</a>
            <a id="btnEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
            <a id="btnView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
            <a id="btnDelete" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Delete</a>
            <a id="btnApprove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Approve</a>
            <a id="btnPreview" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true">Preview</a>
         
        </div>
    </div>
    <div id="winKnittingYarnChallan" class="easyui-window" title="Knitting Order Challan" style="height: 515px; width: 1020px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
        <div id="MainDiv" style="font-family:Tahoma;height:85% ;width:99%">
            <table style="width:100%;">
                <tr style="width:100%;">
                    <td style="width:100%;">
                        <fieldset>
                            <legend>Knitting Challan Info</legend>
                            <table style="width:100%;">
                                <tr>
                                    <td class="align-right" style="width:10%">Order No</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:45%;" id="txtOrderNo" disabled />
                                        <span>
                                            <input type="text" style="width:45%;" id="txtBusinessSession" disabled />
                                        </span>
                                    </td>
                                    <td class="align-right" style="width:10%">Order Date</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtOrderDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                    <td class="align-right" style="width:15%">Order Type</td>
                                    <td style="width:25%">
                                        <input type="text" style="width:100%;" id="txtOrderType" disabled />
                                    </td>
                                </tr>
                                <tr>
                                    <td class="align-right" style="width:10%">Factory</td>
                                    <td colspan="3" style="width:50%">
                                        <input type="text" style="width:100%;" id="txtFactory" disabled />
                                    </td>
                                    <td class="align-right" style="width:15%">Start Date</td>
                                    <td style="width:25%">
                                        <input type="text" style="width:100%;" id="txtStartDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                </tr>
                                <tr>
                                    <td class="align-right" style="width:10%">Challan No</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtChallanNo" disabled/>
                                    </td>
                                    <td class="align-right" style="width:10%">Challan Date</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtChallanDate" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                    </td>
                                    <td class="align-right" style="width:15%">Truck Number</td>
                                    <td style="width:25%">
                                        <input type="text" style="width:100%;" id="txtCarNumber" placeholder="Enter Truck Number" />
                                    </td>
                                </tr>
                                <tr>
                                    <td class="align-right" style="width:10%">Driver Name</td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtDriverName" placeholder="Enter Driver Name" />
                                    </td>
                                    <td class="align-right" style="width:10%">Delivery Point </td>
                                    <td style="width:20%">
                                        <input type="text" style="width:100%;" id="txtDeliveryPoint" placeholder="Enter Delivery Point"/>
                                    </td>
                                    <td class="align-right" style="width:15%">Remarks</td>
                                    <td style="width:25%" >
                                        <input type="text" style="width:100%;" id="txtRemarks"/>
                                    </td>
                                   
                                </tr>
                                
                                
                            </table>
                        </fieldset>
                    </td>
                </tr>
            </table>
            <table id="tblKnittingYarnChallanDetail" title="Knitting Challan Details" class="easyui-datagrid" style="height:280px; width:100%;" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#Wintoolbar" data-options="onClickRow:onClickRow,onEndEdit: onEndEdit">
                <thead>
                    <tr> 
                        <th field="OperationUnitName" width="12%" align="left">Store</th>
                        <th field="StyleWithColor" width="12%" align="left">Style</th>
                        <th field="YarnCode" width="8%" align="left">Code</th>
                        <th field="YarnName" width="15%" align="left">Yarn Name</th>
                        <th field="LotNo" width="15%" align="left">Lot No</th>
                        <th field="MUnitName" width="8%" align="left">M. Unit</th>
                        <th field="LotBalance" formatter="formatPrice" width="10%" align="right">Lot Balance</th>
                        <th field="YetToChallanQty" width="8%" align="right">Yet To Challan</th>
                        <th data-options="field:'Qty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">Qty</th>
                        <th field="ColorName" width="10%" align="left">Color</th>
                        @*<th data-options="field:'BrandName',align:'left',editor:{type:'text'}" width="10%">Brand</th>*@
                        <th field="BrandShortName" width="10%" align="left">Brand</th>
                        <th data-options="field:'BagQty',align:'right',editor:{type:'numberbox',options:{precision:2}}" width="8%">Bag Qty</th>
                        <th data-options="field:'Remarks',align:'left',editor:{type:'text'}" width="10%">Remarks</th>
                    </tr>
                </thead>
            </table>
            <div id="Wintoolbar">
                Store : <select id="cboStore" style="width:100px;height:22px;"></select> 
                Style  : <select id="cboStyle" style="width:630px;height:22px;"></select>
                Yet To Challan : <input type="text" id="txtYetToChallan" value="0.00" style="width:70px;text-align:right" disabled />
                <br />
                Yarn  : <select id="cboYarn" style="width:150px;height:22px;"></select>  
                Lot  : <input type="text" id="txtWinLot" style=" width:130px;"  placeholder="Type Lot"/>
                <input type="button" id="btnLot" style="width:25px;" onclick="PickLot()" value="P" />
                Color : <input type="text" id="txtColor" style="width:130px;" onkeydown="ColorKeyDown(event)" />
                <input type="button" id="btnColor" style="width:25px;" onclick="PickColor()" value="..." />
                Qty : <input type="text" id="txtQty" style="width:70px;" class="number" />
                MUnit : <select id="cboMUnit" style="width:100px;height:22px;" disabled></select>   
                <a id="btnAddDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                <a id="btnRemoveDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                <a id="btnRefreshDetail" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true"></a>

            </div>
        </div>
        <fieldset style="height:14%">
            <legend style="font-weight: bold">Action : </legend>
            <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; font-weight: bold; width:100%">
                <tr>
                    <td style="width:60%; text-align:right"></td>
                    <td style="width:40%;text-align:right;">
                        <a id="btnWinSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                        <a id="btnWinClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel"  plain="true">Close</a>
                    </td>
                </tr>
            </table>
        </fieldset>
      
    
    </div>

    <script type="text/javascript">
    var _oKnittingChallan=null;
    var _oKnittingYarnChallans=[];
    var _sBaseAddress="";
    var _oKnittingOrder=null;
    //var _oKnittingCompostions = null;
    var _MUnits=[];
    var _Stores=[];
    var _KnittingOrderDetails = [];
    $(document).ready(function () {
        debugger;
        var oAuthorizationRolesMappings =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));
        _oKnittingYarnChallans =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));
        _MUnits = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Units));
        _oKnittingOrder=@Html.Raw(Json.Encode(ViewBag.KnittingOrder));
        @*var oKnittingCompostions = @Html.Raw(Json.Encode(ViewBag.KnittingCompostions));*@
        _Stores=@Html.Raw(Json.Encode(ViewBag.Stores));
        _KnittingOrderDetails = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.KnittingOrderDetails));
        //$('#divKnittingYarnChallan').data('KnittingCompostions', oKnittingCompostions);
        DynamicRefreshList(_oKnittingYarnChallans, "tblKnittingYarnChallans");
        var dgPanel = $('#tblKnittingYarnChallans').datagrid('getPanel');
        dgPanel.panel('setTitle',"Challan List For : Order No - "+_oKnittingOrder.OrderNo);
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").hide();
        $("#winKnittingYarnChallan").data("ColorID",0);
        $("#cboStyle").icsLoadCombo({ List:_KnittingOrderDetails, OptionValue: "KnittingOrderDetailID", DisplayText: "FabricWithColor",});
        $("#txtWinLot").data("PickerLot",null);
        $('#divKnittingYarnChallan').data('KnittingCompostions', null);
        RefreshControlLayout(oAuthorizationRolesMappings);
    });

    function updateProgress() {
        var value =$('#progressbar').progressbar('getValue');
        if (value < 96){
            value += Math.floor(Math.random() * 10);
            $('#progressbar').progressbar('setValue', value);
        }
    }
    function hideShow(miliseconds) {
        $("#progressbarParent").hide();
    }

    $("#btnAdd").click(function(){
        if(parseInt(_oKnittingOrder.KnittingOrderID) > 0){
            $.ajax({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnChallan/GetKnittingCompostionsByKOID",
                traditional: true,
                data:  {KOID:parseInt(_oKnittingOrder.KnittingOrderID)},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oKnittingCompostions = jQuery.parseJSON(data);
                    $('#divKnittingYarnChallan').data('KnittingCompostions', oKnittingCompostions);
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }

        $("#winKnittingYarnChallan").data("ActionName","New");
        RefreshControlWindowLayout(0);
        var oKnittingChallans= $('#tblKnittingYarnChallans').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));
        sessionStorage.setItem("SelectedRowIndex", -1);


    });

    $("#btnEdit").click(function(){
        debugger;
        var oKnittingYarnChallan= $('#tblKnittingYarnChallans').datagrid('getSelected');
        if(oKnittingYarnChallan==null || oKnittingYarnChallan.KnittingYarnChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnChallan.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }

        if(parseInt(_oKnittingOrder.KnittingOrderID) > 0){
            $.ajax({
                type: "GET",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnChallan/GetKnittingCompostionsByKOID",
                traditional: true,
                data:  {KOID:parseInt(_oKnittingOrder.KnittingOrderID)},
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oKnittingCompostions = jQuery.parseJSON(data);
                    $('#divKnittingYarnChallan').data('KnittingCompostions', oKnittingCompostions);
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }

        $("#winKnittingYarnChallan").data("ActionName","Edit");
        RefreshControlWindowLayout(oKnittingYarnChallan.KnittingYarnChallanID);
        var oKnittingChallans= $('#tblKnittingYarnChallans').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));

        var SelectedRowIndex=$('#tblKnittingYarnChallans').datagrid('getRowIndex',oKnittingYarnChallan);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);

    });

    $("#btnView").click(function(){
        var oKnittingYarnChallan= $('#tblKnittingYarnChallans').datagrid('getSelected');
        if(oKnittingYarnChallan==null || oKnittingYarnChallan.KnittingYarnChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        $("#winKnittingYarnChallan").data("ActionName","View");
        RefreshControlWindowLayout(oKnittingYarnChallan.KnittingYarnChallanID);
        var oKnittingChallans= $('#tblKnittingYarnChallans').datagrid('getRows');
        sessionStorage.setItem("KnittingChallans", JSON.stringify(oKnittingChallans));
        var SelectedRowIndex=$('#tblKnittingYarnChallans').datagrid('getRowIndex',oKnittingYarnChallan);
        sessionStorage.setItem("SelectedRowIndex", SelectedRowIndex);
    });

    $('#cboStore').on('change', function (e) {
        $("#txtWinLot").data("PickerLot",null);
        $("#txtWinLot").val("");
    });
    $('#cboStyle').on('change', function (e) {        
        $('#txtYetToChallan').val("");
        $("#txtWinLot").data("PickerLot",null);
        $("#txtWinLot").val("");
        $("#winKnittingYarnChallan").data("ColorID",0);
        $("#txtColor").val("");
        $("#txtQty").val("");
        $('#cboMUnit').val(0);
        debugger;
        var oKnittingCompostions = $('#divKnittingYarnChallan').data('KnittingCompostions');
        var oNewKCs = [];
        if(oKnittingCompostions!=null)
        {
            for(var i=0;i<oKnittingCompostions.length;i++){
                if(oKnittingCompostions[i].KnittingOrderDetailID==parseInt($('#cboStyle').val())){
                    oNewKCs.push(oKnittingCompostions[i]);           
                }
            }
        }
        $("#cboYarn").icsLoadCombo({
            List: oNewKCs,
            OptionValue: "KnittingCompositionID",
            DisplayText: "YarnNameWithQty",
        });
    });

    $('#cboYarn').on('change', function (e) {
        debugger;
        var n =parseInt($('#cboYarn').val());
        var oKC = GetComposition(parseInt($('#cboYarn').val()));
        if(oKC !=null){
            $('#txtYetToChallan').val(parseFloat(oKC.YetToChallanQty));
            $("#txtQty").val(parseFloat(oKC.Qty));//$("#txtQty").val(parseFloat(oKC.YetToChallanQty));
        }
        else{
            $('#txtYetToChallan').val(0);
            $("#txtQty").val(parseFloat(0));
        }
        $("#txtWinLot").data("PickerLot",null);
        $("#txtWinLot").val("");
        $("#winKnittingYarnChallan").data("ColorID",0);
        $("#txtColor").val("");
        $('#cboMUnit').val(0);
    });

    $("#btnDelete").click(function(){
        var oKnittingYarnChallan= $('#tblKnittingYarnChallans').datagrid('getSelected');
        if(oKnittingYarnChallan==null || oKnittingYarnChallan.KnittingYarnChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnChallan.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }


        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblKnittingYarnChallans').datagrid('getRowIndex',oKnittingYarnChallan);
        if (oKnittingYarnChallan.KnittingYarnChallanID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnChallan/Delete",
                data: JSON.stringify(oKnittingYarnChallan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var feedbackmessage = jQuery.parseJSON(data);
                    if (feedbackmessage== "Data delete successfully")
                    {

                        alert("Delete sucessfully");
                        $('#tblKnittingYarnChallans').datagrid('deleteRow',SelectedRowIndex);


                    }
                    else
                    {
                        alert(feedbackmessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });
    $("#btnApprove").click(function(){
        var oKnittingYarnChallan= $('#tblKnittingYarnChallans').datagrid('getSelected');
        if(oKnittingYarnChallan==null || oKnittingYarnChallan.KnittingYarnChallanID<=0)
        {
            alert("Please select a item from list!");
            return;
        }
        if(oKnittingYarnChallan.ApprovedBy!=0)
        {
            alert("Already Approved!");
            return;
        }

        if (!confirm("Confirm to Approve?")) return ;
        var SelectedRowIndex=$('#tblKnittingYarnChallans').datagrid('getRowIndex',oKnittingYarnChallan);
        if (oKnittingYarnChallan.KnittingYarnChallanID > 0)
        {
            $.ajax
            ({
                type: "POST",
                dataType: "json",
                url : _sBaseAddress+  "/KnittingYarnChallan/ApproveChallan",
                data: JSON.stringify(oKnittingYarnChallan),
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    var oKnittingYarnChallan = jQuery.parseJSON(data);
                    if (oKnittingYarnChallan.ErrorMessage == null || oKnittingYarnChallan.ErrorMessage == "")
                    {                        
                        $('#tblKnittingYarnChallans').datagrid('updateRow', { index: SelectedRowIndex,  row: oKnittingYarnChallan });
                        alert("Approved Succesfully!!");
                    }
                    else
                    {
                        alert(oKnittingYarnChallan.ErrorMessage);
                    }
                },
                error: function (xhr, status, error)
                {
                    alert(error);
                }
            });
        }
    });



    function RefreshList(oKnittingOrders)
    {

        var data=oKnittingOrders;
        data={"total":""+data.length+"","rows":data};
        $('#tblKnittingYarnChallans').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        $('#tblKnittingYarnChallans').datagrid('selectRow',nIndex);
    }

    /*---------------REgion For Picker Knitting Yarn Challan----------------------*/
    function SetPickerValueAssign(oPickerobj) {

        var oreturnObj = null, oreturnobjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();

        if (oPickerobj.winid === 'winLots')
        {
            if (oreturnObj!=null)
            {

                $("#txtWinLot").val(oreturnObj.LotNo);
                $("#txtWinLot").data("PickerLot",JSON.stringify(oreturnObj));
                (oreturnObj.Balance > parseFloat($("#txtQty").val()) ) ? $("#txtQty").val() : $("#txtQty").val(oreturnObj.Balance);
                $("#cboMUnit").val(oreturnObj.MUnitID);
            }
        }
        else if (oPickerobj.winid == 'winColor')
        {
            SetColor(oreturnObj);
        }

    }
    function IntializePickerbutton(oPickerobj) {
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            //for Single Select
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which == 13)//enter=13
            {
                SetPickerValueAssign(oPickerobj);

            }
        });
    }
    function PickLot()
    {
        if($("#cboYarn").val()<=0){
            alert("Select Yarn");
            $("#cboYarn").focus();
            return;
        }
        if($("#cboStore").val()<=0){
            alert("Select Store");
            $("#cboStore").focus();
            return;
        }
        var oKC = GetComposition(parseInt($("#cboYarn").val()));
        var nProductID = (oKC != null) ? oKC.YarnID : 0;
        if(nProductID<=0){
            alert("Select valid Yarn!!");
            $("#cboYarn").focus();
            return;
        }
        var tblColums = [];
        
        var oRefObject={
            BUID:_oKnittingOrder.BUID,
            LotNo:$.trim($('#txtWinLot').val()),
            ProductID: nProductID,
            WorkingUnitID:parseInt($("#cboStore").val())
        };
        var oColumn = { field: "SupplierShortName", title: "Brand", width: "35%", align: "left" }; tblColums.push(oColumn);
            oColumn = { field: "LotNo", title: "Lot No", width: "35%", align: "left" }; tblColums.push(oColumn);        
            oColumn = { field: "Balance", title: "Balance", width: "25%", align: "right" }; tblColums.push(oColumn);

        searchingbyfieldName="LotNo";
        var obj = {
            BaseAddress: sessionStorage.getItem("BaseAddress"),
            Object: oRefObject,
            ControllerName:"KnittingYarnChallan",
            ActionName:"GetLotByYarn",
            IsWinClose: false
        };
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].LotID > 0) {
                    var oPickerParam = {
                        winid: 'winLots',
                        winclass: 'clsLots',
                        winwidth: 530,
                        winheight: 450,
                        tableid: 'tblLots',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: "LotNo",
                        windowTittle: 'Lot List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
                return;
            }
        });
    }
    $("#txtWinLot").keydown(function (e) {

        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            PickLot();
        }
        if (code == 8||code==27) {

            $("#txtWinLot").data("PickerLot",null);
        }
    });
    function WinToolbarLayOutRefresh(){
        $("#cboMUnit").icsLoadCombo({
            List:_MUnits,
            OptionValue: "MeasurementUnitID",
            DisplayText: "UnitName",

        });
        $("#cboStore").icsLoadCombo({
            List:_Stores,
            OptionValue: "WorkingUnitID",
            DisplayText: "OperationUnitName",

        });
        $("#txtWinLot").val("");
        $("#txtWinLot").data("PickerLot",null);
        $("#txtQty").val(0);
    }
    function WinActionNew(){
        $("#cboStyle").val(0);
        $("#txtChallanNo,#txtDriverName,#txtCarNumber,#txtDeliveryPoint,#txtRemarks,#txtYetToChallan").val("");
        $("#cboYarn").val(0);
        $("#txtWinLot").data("PickerLot",null);
        $("#txtWinLot").val("");

        $('#txtChallanDate').datebox('setValue',icsdateformat(new Date()));
        DynamicRefreshList([], "tblKnittingYarnChallanDetail");
        $("#btnWinSave").show();
        WinToolbarLayOutRefresh();
        $("#winKnittingYarnChallan :input").prop("disabled", false);
        $("#txtChallanNo,#cboMUnit,#txtYetToChallan").prop("disabled", true);
        $("#winKnittingYarnChallan").icsWindow('open');
        _oKnittingChallan=null;

        $("#txtOrderNo").prop("disabled", true);
        $("#txtBusinessSession").prop("disabled", true);
        $("#txtOrderType").prop("disabled", true);
        $("#txtFactory").prop("disabled", true);
        $('#txtOrderDate').datebox({ disabled : true });
        $('#txtStartDate').datebox({ disabled : true });
        $("#txtOrderNo").val(_oKnittingOrder.OrderNo);
        $("#txtBusinessSession").val(_oKnittingOrder.BusinessSessionName);
        $("#txtOrderType").val(_oKnittingOrder.OrderTypeInString);
        $("#txtFactory").val(_oKnittingOrder.FactoryName);
        $('#txtOrderDate').datebox('setValue',_oKnittingOrder.OrderDateInString);
        $('#txtStartDate').datebox('setValue',_oKnittingOrder.StartDateInString);
    }
    function WinActionOthers(oKnitChallan){
        editIndex = undefined;
        $("#cboStyle").val(0);
        $("#txtYetToChallan").val("");
        $("#cboYarn").val(0);
        $("#txtWinLot").data("PickerLot",null);
        $("#txtWinLot").val("");

        _oKnittingChallan=oKnitChallan;
        var sActionName=$("#winKnittingYarnChallan").data("ActionName");
        $("#txtChallanNo").val(oKnitChallan.ChallanNo);
        $("#txtDriverName").val(oKnitChallan.DriverName);
        $("#txtCarNumber").val(oKnitChallan.CarNumber);
        $("#txtDeliveryPoint").val(oKnitChallan.DeliveryPoint);
        $("#txtRemarks").val(oKnitChallan.Remarks);
        $('#txtChallanDate').datebox('setValue',oKnitChallan.ChallanDateInString);
        DynamicRefreshList(oKnitChallan.KnittingYarnChallanDetails, "tblKnittingYarnChallanDetail");
        WinToolbarLayOutRefresh();
        if(sActionName=="View"){
            $("#winKnittingYarnChallan :input").prop("disabled", true);
            $("#btnWinSave").hide();
        }
        else{
            $("#winKnittingYarnChallan :input").prop("disabled", false);
            $("#btnWinSave").show();


        }
        $("#txtChallanNo,#cboMUnit,#txtYetToChallan").prop("disabled", true);
        $("#winKnittingYarnChallan").icsWindow('open');

        $("#txtOrderNo").prop("disabled", true);
        $("#txtBusinessSession").prop("disabled", true);
        $("#txtOrderType").prop("disabled", true);
        $("#txtFactory").prop("disabled", true);
        $('#txtOrderDate').datebox({ disabled : true });
        $('#txtStartDate').datebox({ disabled : true });
        $("#txtOrderNo").val(_oKnittingOrder.OrderNo);
        $("#txtBusinessSession").val(_oKnittingOrder.BusinessSessionName);
        $("#txtOrderType").val(_oKnittingOrder.OrderTypeInString);
        $("#txtFactory").val(_oKnittingOrder.FactoryName);
        $('#txtOrderDate').datebox('setValue',_oKnittingOrder.OrderDateInString);
        $('#txtStartDate').datebox('setValue',_oKnittingOrder.StartDateInString);
    }
    function RefreshControlWindowLayout(nKnittingYarnChallanID)
    {

        var sActionName=$("#winKnittingYarnChallan").data("ActionName");
        if(sActionName=="New"){
            WinActionNew();
        }
        else{
            $.ajax({
                type: "POST",
                dataType: "JSON",
                url: sessionStorage.getItem("BaseAddress")+  "/KnittingYarnChallan/GetKnittingYarnChallan",
                data:  JSON.stringify({KnittingYarnChallanID:nKnittingYarnChallanID}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var oResult= JSON.parse(data);
                    WinActionOthers(oResult);
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        }

    }

    function ColorKeyDown(event) {
        //return;
        if (event.which == 13) {
            var oTxtName=$("#txtColor").val();
            if (oTxtName != null) {
                PickColor(oTxtName);
            }
        }
        if (event.which == 8) {
            $("#winKnittingYarnChallan").data("ColorID",0);
            txtColor.style.color="Black";
        }
    }
    function PickColor(oTxtName)
    {
        var oStyleSearch = {
            ColorName:$("#txtColor").val()

        };

        console.log(oStyleSearch);
        debugger;
        var obj = {
            BaseAddress:_sBaseAddress,
            Object: (oStyleSearch) ,
            ControllerName: "ColorCategory",
            ActionName: "getColorByColorName",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: "ColorName", title: "Color Name", width: 200, align: "left" }; tblColums.push(oColumn);
        //oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);
        //DynamicPiker('Color',obj,tblColums,false,'ColorName','ColorCategoryID',400); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
        $.icsProgressBar(true);
        $.icsDataGets(obj, function (response) {
            $.icsProgressBar(false);
            if (response.status && response.objs.length > 0) {
                if (response.objs[0].ColorCategoryID > 0) {
                    var oPickerParam = {
                        winid: 'winColor',
                        winclass: 'clsColor',
                        winwidth: 350,
                        winheight: 450,
                        tableid: 'tblColor',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: "ColorName",
                        windowTittle: 'Color List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else { alert(response.objs[0].ErrorMessage); }
            }else{
                alert("Data Not Found.");
                return;
            }
        });

    }
    function SetColor(oSelectedStyle) {
        debugger;
        console.log(document.getElementById("txtColor").innerHTML);
        document.getElementById("txtColor").value = oSelectedStyle.ColorName;
        $("#winKnittingYarnChallan").data("ColorID",oSelectedStyle.ColorCategoryID);
        txtColor.style.color="Blue";
    }

    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tblKnittingYarnChallanDetail').datagrid('validateRow', editIndex)) {
            $('#tblKnittingYarnChallanDetail').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        }
        else {
            return false;
        }
    }

    function onClickRow(index) {

        if (editIndex != index) {
            if (endEditing()) {
                $('#tblKnittingYarnChallanDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else {
                $('#tblKnittingYarnChallanDetail').datagrid('selectRow', editIndex);
            }
        }
    }
    function onEndEdit(index, row) {

    }
    
    function GetComposition(nKnittingCompostionID){
        debugger;
        var oKnittingCompostions = $('#divKnittingYarnChallan').data('KnittingCompostions');
        if(oKnittingCompostions!=null)
        {
            for(var i=0;i<oKnittingCompostions.length;i++){
                if(oKnittingCompostions[i].KnittingCompositionID==nKnittingCompostionID){
                    return oKnittingCompostions[i];               
                }
            }
        }
        return null;
    }
    
    function GetYetToQty(nKODID){
        var YetToChallanQty=0;
        for(var i=0;i<_KnittingOrderDetails.length;i++){
            if(_KnittingOrderDetails[i].KnittingOrderDetailID==nKODID){
                YetToChallanQty=_KnittingOrderDetails[i].YetToChallanQty;
                break;
            }
        }
        return YetToChallanQty;
    }
    


    $("#btnAddDetail").click(function (){
        var SelectedLot =JSON.parse($("#txtWinLot").data("PickerLot"));
        if(parseInt($("#cboStore").val()) <= 0){
            alert("Please enter  Store!!");
            $("#cboStore").focus();
            return;
        }
        if(parseInt($("#cboStyle").val()) <= 0){
            alert("Please enter  Style!!");
            $("#cboStyle").focus();
            return;
        }
        if(parseInt($("#cboYarn").val()) <= 0){
            alert("Please enter  Yarn!!");
            $("#cboYarn").focus();
            return;
        }
        if(parseFloat($("#txtQty").val()) <= 0){
            alert("Please enter Qty!!");
            $("#txtQty").focus();
            return;
        }
        if(SelectedLot==null){
            alert("No Lot Found!!");
            $("#txtWinLot").focus();
            return;
        }
        if(SelectedLot.LotID <= 0){
            alert("No Lot Found!!");
            $("#txtWinLot").focus();
            return;
        }
        if(parseFloat($("#txtQty").val()) > parseFloat($("#txtYetToChallan").val())){
            alert("Qty can't be greate than Yet To Challan Qty!!");
            $("#txtQty").focus();
            return;
        }

        var oKnittingYarnChallanDetails = $('#tblKnittingYarnChallanDetail').datagrid('getRows');
        for(var i=0;i<oKnittingYarnChallanDetails.length;i++){
            if(oKnittingYarnChallanDetails[i].KnittingCompositionID == parseInt($("#cboYarn").val()) && oKnittingYarnChallanDetails[i].LotID == SelectedLot.LotID){
                alert("Yarn with this Lot already exist!!");
                $("#cboYarn").focus();
                return;
            }
        }

        var oKC = GetComposition(parseInt($("#cboYarn").val()));
        if(oKC != null){
            var oKC = GetComposition(parseInt($('#cboYarn').val()));
            var oKnittingYarnChallanDetail={
                KnittingYarnChallanDetailID: 0,
                KnittingYarnChallanID: 0,
                KnittingOrderDetailID: parseInt($("#cboStyle").val()),
                KnittingCompositionID: parseInt($("#cboYarn").val()),
                StyleWithColor: $("#cboStyle option:selected").text(),
                IssueStoreID: parseInt($("#cboStore").val()),
                YarnID: oKC.YarnID,
                Remarks:'',
                LotID:SelectedLot.LotID,
                OperationUnitName: $("#cboStore option:selected").text(),
                YarnCode: oKC.YarnCode,
                YarnName:oKC.YarnName,//  $("#cboYarn option:selected").text(),
                MUnitName:$("#cboMUnit option:selected").text(),
                LotNo:SelectedLot.LotNo,
                LotBalance:SelectedLot.Balance,
                Qty:parseFloat($("#txtQty").val()),
                MUnitID:parseInt($("#cboMUnit").val()),
                ColorID: parseInt($("#winKnittingYarnChallan").data("ColorID")),
                ColorName: $("#txtColor").val(),
                BrandName: '',
                BrandShortName: SelectedLot.SupplierShortName,
                BagQty: 0,
                YetToChallanQty: parseFloat($('#txtYetToChallan').val())
            };
            $('#tblKnittingYarnChallanDetail').datagrid('appendRow',oKnittingYarnChallanDetail);
        }
        

    });

    $("#btnRemoveDetail").click(function ()
    {
        endEditing();
        var oKnittingChallanDetail=$('#tblKnittingYarnChallanDetail').datagrid('getSelected');
        if(oKnittingChallanDetail==null)
        {
            alert("Please select a valid item from list.");
            return;
        }
        var nIndex= $('#tblKnittingYarnChallanDetail').datagrid('getRowIndex',oKnittingChallanDetail);
        $('#tblKnittingYarnChallanDetail').datagrid('deleteRow',nIndex);
    });

    $("#btnRefreshDetail").click(function ()
    {
        endEditing();
        var data= $('#tblKnittingYarnChallanDetail').datagrid('getRows');
        data={"total":""+data.length+"","rows":data};
        $('#tblKnittingYarnChallanDetail').datagrid('loadData',data);
    });
    $("#btnWinClose").click(function (){
        $("#winKnittingYarnChallan").icsWindow('close');

    });
    function Validation(){
        if($("#txtChallanDate").datebox('getValue') == '' || $("#txtChallanDate").datebox('getValue') == null){
            alert('Please Enter Challan date!!');
            $("#txtChallanDate").focus();
            return false;
        }
        var oRows=$('#tblKnittingYarnChallanDetail').datagrid('getRows');
        if(oRows.length<=0){
            alert("Atleast onen Knitting Challan detail required!!");
            return false;
        }
        return true;
    }
    function RefreshObject()
    {

        var oRows=$('#tblKnittingYarnChallanDetail').datagrid('getRows');

        var oKnittingYarnChallan={

            KnittingYarnChallanID : (_oKnittingChallan==null)?0:_oKnittingChallan.KnittingYarnChallanID,
            KnittingOrderID:_oKnittingOrder.KnittingOrderID,
            ChallanDate:$('#txtChallanDate').datebox('getValue'),
            Remarks : $.trim($('#txtRemarks').val()),
            DriverName: $.trim($('#txtDriverName').val()),
            CarNumber: $.trim($('#txtCarNumber').val()),
            DeliveryPoint: $.trim($('#txtDeliveryPoint').val()),
            KnittingYarnChallanDetails:$('#tblKnittingYarnChallanDetail').datagrid('getRows')

        };

        return oKnittingYarnChallan;
    }
    $("#btnWinSave").click(function (){

        endEditing();
        if(!Validation()) return false;
        var oKnittingYarnChallan=RefreshObject();
        //return;
        $("#progressbar").progressbar({ value: 0 });
        $("#progressbarParent").show();
        var intervalID = setInterval(updateProgress, 250);

        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/KnittingYarnChallan/Save",
            traditional: true,
            data:JSON.stringify(oKnittingYarnChallan),
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                oKnittingYarnChallan = jQuery.parseJSON(data);
                clearInterval(intervalID);
                $("#progressbarParent").hide();
                if (oKnittingYarnChallan.ErrorMessage==null || oKnittingYarnChallan.ErrorMessage=="") {
                    alert("Data Saved successfully");
                    _oKnittingChallan=oKnittingYarnChallan;
                    $('#txtChallanNo').val(_oKnittingChallan.ChallanNo);
                    DynamicRefreshList(_oKnittingChallan.KnittingYarnChallanDetails, "tblKnittingYarnChallanDetail");
                    var oKnittingChallans = sessionStorage.getItem("KnittingChallans");
                    debugger;
                    var nIndex = parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    if (oKnittingChallans != null) {
                        oKnittingChallans = jQuery.parseJSON(oKnittingChallans);
                    }
                    else
                    {
                        oKnittingChallans = [];
                    }
                    if (nIndex != -1)
                    {
                        oKnittingChallans[nIndex] = oKnittingYarnChallan;
                        $('#tblKnittingYarnChallans').datagrid('updateRow', { index: nIndex,  row: oKnittingYarnChallan });
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oKnittingChallans.length);
                        oKnittingChallans.push(oKnittingYarnChallan);
                        $('#tblKnittingYarnChallans').datagrid('appendRow',oKnittingYarnChallan);
                        $('#tblKnittingYarnChallans').datagrid('selectRow',oKnittingChallans.length-1);
                    }
                    // sessionStorage.setItem("KnittingOrders", JSON.stringify(oKnittingChallans));

                }
                else {
                    alert(oKnittingYarnChallan.ErrorMessage);
                }
            },
            error: function (xhr, status, error) {
                alert(error);
            }

        });
    });

    $('#btnPreview').click(function()
    {
        debugger;
        var oKnittingYarnChallan=$('#tblKnittingYarnChallans').datagrid('getSelected');
        if(oKnittingYarnChallan==null || parseInt(oKnittingYarnChallan.KnittingYarnChallanID)<=0)
        {
            alert("Please select Knitting Challan ");
            return;
        }
        window.open(_sBaseAddress+ "/KnittingYarnChallan/KnittingYarnChallanPrintPreview?id="+oKnittingYarnChallan.KnittingYarnChallanID);
    });


        
    function RefreshControlLayout(oAuthorizationRolesMappings)
    {
        $('#btnAdd,#btnEdit,#btnView,#btnDelete,#btnApprove,#btnPreview').hide(); //

        if(PermissionChecker('Add','KnittingYarnChallan', oAuthorizationRolesMappings)){$('#btnAdd').show();}
        if(PermissionChecker('Edit','KnittingYarnChallan', oAuthorizationRolesMappings)){$('#btnEdit').show(); }
        if(PermissionChecker('View','KnittingYarnChallan', oAuthorizationRolesMappings)){$('#btnView').show(); }
        if(PermissionChecker('Delete','KnittingYarnChallan', oAuthorizationRolesMappings)){ $('#btnDelete').show(); }
        if(PermissionChecker('Approved','KnittingYarnChallan', oAuthorizationRolesMappings)){$('#btnApprove').show();}        
        if(PermissionChecker('Preview','KnittingYarnChallan', oAuthorizationRolesMappings)){$('#btnPreview').show();}
    }
    /*---------------------------Endregion----------------------------------------*/


    </script>
