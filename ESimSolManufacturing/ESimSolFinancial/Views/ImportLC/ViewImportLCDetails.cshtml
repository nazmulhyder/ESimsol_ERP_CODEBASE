
@model IEnumerable<ESimSol.BusinessObjects.ImportLC>
@{
    ViewBag.Title = "Purchase Letter of Credit";
}

<div class="menuMainCollectionTable" style="margin-left: 0px; height:100%; width:100%">
<table id="tblImportLC" class="easyui-datagrid" fit="true" fitcolumns="true" rownumbers="true" pagination="true" singleselect="true" autorowheight="false" toolbar="#toolbar">
    <thead>
        <tr>
            <th field="LCNo" width="10%" align="left">LC No</th>
            <th field="ImportLCDateInString" width="10%" align="left">LC Date</th>
            <th field="LCCoverNoteNo" width="10%" align="left">Cover Note No</th>
            <th field="LCPaymentTypeSt" width="10%" align="left">Payment TYpe</th>
            <th field="SupplierName" width="10%" align="left">Supplier Name</th>
            <th field="NegotiateBankName" width="10%" align="left">Negotiable Bank</th>
            <th field="LCCurrentStatusInString" width="10%" align="left">Current Status</th>
            <th field="CurrencyName" width="10%" align="left">Currency</th>
            <th data-options="field:'Amount',align:'right',formatter:formatPrice" style="width:10%" align="right">Total LC Value</th>
            <th data-options="field:'TotalInvoiceValue',align:'right',formatter:formatPrice" style="width:10%" align="right">Total Invoice Value</th>
            <th data-options="field:'ShipmentWithoutBLValue',align:'right',formatter:formatPrice" style="width:10%" align="right">Shipment Without BL</th>
            <th data-options="field:'Balance',align:'right',formatter:formatPrice" style="width:10%" align="right">Balance</th>
        </tr>
    </thead>
</table>
<div id="toolbar">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-reload" plain="true" onclick="Refresh()"></a>
    <input type="text" id="txtSearchbyLCNo" value="Search by LC No" style="width:230px" onclick="Clearfield()" />
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true" id="btnSearch">Adv. Search</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" plain="true" onclick="WaitForLCOpen()">Waiting For LCOpen</a>

    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="LCOpen()" id="btnAdd">LC Open</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true" onclick="Edit()" id="btnEdit">Edit</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true" onclick="View()" id="btnView">View</a>

    @*<a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print()" id="btnPrint">Print</a>
<a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-print" plain="true" onclick="Print()" id="btnLCDetail">Print Product Wise</a>*@
</div>
</div>
<div id="winAdvanceSearch_LC" class="easyui-window winClass" title="Advance Search" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
<div style="width:730px;height:550px; float: left;align-content:center;">
    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
        <tr>
            <td style="width:100%;">
                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;height:480px;">
                    <tr style="height:50%; vertical-align:top;">
                        <td style="width: 50%; height:100%;">
                            <fieldset style="height:460px;">
                                <legend style="font-weight: bold; font-size: 12px">Searching Criteria : </legend>
                                <table border="0" cellpadding="0" cellspacing="0" style=" width: 100%;height:100%; ">
                                    <tr>
                                        <td style="width: 100%; text-align: left">
                                            <label style="font-weight:bold;"> Date :</label> <br />
                                            <table border="0" style="width: 100%;">
                                                <tr>
                                                    <td style="width: 100%; text-align: left">

                                                        <select class="_select_changeA" id="cboDateSearch" style="width: 30%;text-align:left"></select>
                                                        <input id="txtOpeningDateStart" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />To
                                                        <input id="txtOpeningDateEnd" type="text" style="width: 100px;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                                    </td>

                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 100%; text-align: left">
                                            Supplier :
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 100%; text-align: left">
                                            @Html.TextBox("txtSupplier", "", new { style = "width: 255px", id = "txtSupplier", placeholder = "Type Client & Press Enter" })<input type="button" style="width: 70px; font-size: 12px" id="btnSupplierPicker" value="Pick" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width: 100%;height: 200px; text-align: left">
                                            <label style="font-weight:bold;"> </label> <br />
                                            @*<table id="tblStatusLoad" title="" class="easyui-datagrid" style="width: 90%; height: 200px;   font-size: 12px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="false"
                                                    autorowheight="false">
                                                <thead>
                                                    <tr>
                                                        <td></td>
                                                    </tr>
                                                </thead>
                                            </table>*@
                                        </td>
                                    </tr>

                                    <tr style="height:50%; vertical-align:bottom;">
                                        <td style=" text-align:left; width:100%;">
                                            <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                                <tr>
                                                    <td style="width:50%; text-align:left;padding-bottom:10px;"><input type="button" value="Reset" id="btnReset" style="width:70px;" /></td>
                                                    <td style=" text-align:right; width:50%;padding-bottom:10px;"><input type="button" value="Search" id="btnRefresh" style="width:70px;" /></td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </fieldset>
                        </td>
                        <td style="width: 50%; vertical-align:top;">
                            <div style="height:470px;width:100%;padding-top:6px;">
                                <table id="tblSCs_AdvS" title="L/C(s)" class="easyui-datagrid" style="width: 100%;height: 100%; " fitcolumns="false" rownumbers="true" pagination="false" singleselect="false" autorowheight="false" data-options="resizehandle:'right', resizable:true ">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'Selected',checkbox:true"></th>
                                            <th field="ImportLCNO" width="95" align="left">
                                                L/C No
                                            </th>
                                            <th field="AmountSt" width="82" align="center">
                                                Amount
                                            </th>
                                            <th field="ImportLCDateInString" width="100" align="left">
                                                L/C Open Date
                                            </th>

                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td style="width: 100%; text-align: right">
                <fieldset>
                    <legend style="font-weight: bold; text-align:left;">Actions : </legend>
                    <a href="javascript:void(0)" id="btnOkAdvSearch" class="easyui-linkbutton" iconcls="icon-ok" plain="true">Ok</a>
                    <a href="javascript:void(0)" id="btnCloseAdvSearch" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                </fieldset>
            </td>

        </tr>
    </table>
</div>
</div>
<script type="text/javascript">

    var _oImportLC;
    var _oImportLCs;
    var _sBaseAddress="";
    var _sMenuID=0;
    $(document).ready(function ()
     {
      _sBaseAddress =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.BaseAddress]));  
        _oImportLCs =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model)); 
        _sMenuID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.MenuID]));

        var oImportLCs =sessionStorage.getItem("ImportLCs");
       if(oImportLCs!=null )
        {
            oImportLCs = jQuery.parseJSON(oImportLCs);
        }
        else
        {
           oImportLCs=_oImportLCs;
        }
        LoadintoGrid(oImportLCs);

    });


    
    function WaitForLCOpen()
    {
     
        var oImportLC= {
            ImportLCID:0
        };
    
        $.ajax({
            type: "POST",
            dataType: "json",            
            url : _sBaseAddress+  "/ImportLC/WaitForLCOpen",
            traditional: true,
            data:  JSON.stringify(oImportLC),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var oImportLCs = jQuery.parseJSON(data);
                LoadintoGrid(oImportLCs);
            },
            error: function (xhr, status, error) 
            {
                alert(error);
            }                      
        });
    }

    function LoadintoGrid(oImportLC)
    {
        data=oImportLC;
        data={"total":""+data.length+"","rows":data};
        $('#tblImportLC').datagrid('loadData',data);
        var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
        if(nIndex!=null)
        {
            $('#tblImportLC').datagrid('selectRow',nIndex);
        }
    }


   

    function Refresh()
    {
     
        window.location.href =_sBaseAddress+  '/ImportLC/ViewImportLCDetails?menuid='+_sMenuID; ///+"&menuid="+_sMenuID;
    }

    function Clearfield()
    {
         $("#txtSearchbyLCNo")[0].value='';
    }

    $('#txtSearchbyLCNo').keydown(function (e) {
    debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13)//Enter key-13
        {
            if (_oImportLC.length <= 0)
             {
                    alert("There are no data for searching!!!!");
                    return;
            }
            var sSearchByLCNo= document.getElementById('txtSearchbyLCNo').value;
            var sName = "";
            var oSearchedData = [];
            
            var n = 0;
            for (i = 0; i < _oImportLC.length; ++i)
             {
                sName = _oImportLC[i].LCNo;
                n = 0;
                n = sName.toUpperCase().indexOf(sSearchByLCNo.toUpperCase());
                if (n != -1) {
                    oSearchedData.push(_oImportLC[i]);
                }
            }
           $('#tblImportLC').empty();
           data = oSearchedData;
           data={"total":""+data.length+"","rows":data};
           $('#tblImportLC').datagrid('loadData',data);
               
        }
        $('#txtSearchbyLCNo').focus();

    })

    
  

     function LCOpen()
     {
         var oImportLC=$('#tblImportLC').datagrid('getSelected');
         var nSelectedIndex= $('#tblImportLC').datagrid('getRowIndex',oImportLC);

         if(oImportLC==null || oImportLC.ImportLCID<=0)
         {
             alert("Please select a item from list!");
             return;
         }
         var tsv=((new Date()).getTime())/1000;
         var oImportLCs= $('#tblImportLC').datagrid('getRows');
         sessionStorage.setItem("ImportLCs", JSON.stringify(oImportLCs));
         sessionStorage.setItem("SelectedRowIndex", nSelectedIndex);
         sessionStorage.setItem("ImportLCHeader", "Add Purchase LC");
         sessionStorage.setItem("BackLink", window.location.href);
         window.location.href = _sBaseAddress+ "/ImportLC/ViewImportLCReceive?id="+oImportLC.ImportLCID+"&ts="+tsv;

     }



     function Edit()
     {
         var oImportLC=$('#tblImportLC').datagrid('getSelected');
         var nSelectedIndex= $('#tblImportLC').datagrid('getRowIndex',oImportLC);

         if(oImportLC==null || oImportLC.ImportLCID<=0)
         {
             alert("Please select a item from list!");
             return;
         }
         var tsv=((new Date()).getTime())/1000;
         var oImportLCs= $('#tblImportLC').datagrid('getRows');
         sessionStorage.setItem("ImportLCs", JSON.stringify(oImportLCs));
         sessionStorage.setItem("SelectedRowIndex", nSelectedIndex);
         sessionStorage.setItem("ImportLCHeader", "Edit Purchase LC");
         sessionStorage.setItem("BackLink", window.location.href);
         window.location.href = _sBaseAddress+ "/ImportLC/ViewImportLCReceive?id="+oImportLC.ImportLCID+"&ts="+tsv;

     }

     function View()
     {
         var oImportLC=$('#tblImportLC').datagrid('getSelected');
         var nSelectedIndex= $('#tblImportLC').datagrid('getRowIndex',oImportLC);

         if(oImportLC==null || oImportLC.ImportLCID<=0)
         {
             alert("Please select a item from list!");
             return;
         }
         var tsv=((new Date()).getTime())/1000;
         var oImportLCs= $('#tblImportLC').datagrid('getRows');
         sessionStorage.setItem("ImportLCs", JSON.stringify(oImportLCs));
         sessionStorage.setItem("SelectedRowIndex", nSelectedIndex);
         sessionStorage.setItem("ImportLCHeader", "View Purchase LC");
         sessionStorage.setItem("BackLink", window.location.href);
         window.location.href = _sBaseAddress+ "/ImportLC/ViewImportLCReceive?id="+oImportLC.ImportLCID+"&ts="+tsv;

     }

  



     ///Seraching
     //Pick Supplier
     $("#txtSupplier").keydown(function (e) {
         debugger;
         var code = (e.keyCode ? e.keyCode : e.which);
         if (code == 13) // Enter Press
         {
             var oContractor = { Param: "2,5" + '~' + document.getElementById('txtSupplier').value };
             var obj = {
                 BaseAddress: _sBaseAddress,
                 Object: oContractor,
                 ControllerName: "Contractor",
                 ActionName: "ContractorSearchByNameType",
                 IsWinClose: false
             };
             $.icsDataGets(obj, function (response) {
                 debugger;
                 if (response.status && response.objs.length > 0) {
                     if (response.objs[0].ContractorID > 0) {
                         debugger;
                         var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 150, align: "left" }; tblColums.push(oColumn);
                         oColumn = { field: "ContractorTypeInString", title: "Type", width: 150, align: "left" }; tblColums.push(oColumn);
                         var oPickerParam = {
                             winid: 'winSupplier',
                             winclass: 'clsSupplier',
                             winwidth: 600,
                             winheight: 460,
                             tableid: 'tblBuyers',
                             tablecolumns: tblColums,
                             datalist: response.objs,
                             multiplereturn: false,
                             searchingbyfieldName: 'Name',
                             windowTittle: 'Buyer List'
                         };
                         $.icsPicker(oPickerParam);
                         IntializePickerbutton(oPickerParam);
                     }
                     else { alert(response.objs[0].ErrorMessage); }
                 }
             });
         }
     });
     $("#btnSupplierPicker").click(function () {
         var oContractor = { Param: "2,5" };
         var obj = {
             BaseAddress: _sBaseAddress,
             Object: oContractor,
             ControllerName: "Contractor",
             ActionName: "GetsByContractorType",
             IsWinClose: false
         };
         $.icsDataGets(obj, function (response) {
             debugger;
             if (response.status && response.objs.length > 0) {
                 if (response.objs[0].ContractorID > 0) {
                     var tblColums = []; var oColumn = { field: "Name", title: "Name", width: 150, align: "left" }; tblColums.push(oColumn);
                     oColumn = { field: "ContractorTypeInString", title: "Type", width: 150, align: "left" }; tblColums.push(oColumn);
                     var oPickerParam = {
                         winid: 'winSupplier',
                         winclass: 'clsSupplier',
                         winwidth: 600,
                         winheight: 460,
                         tableid: 'tblBuyers',
                         tablecolumns: tblColums,
                         datalist: response.objs,
                         multiplereturn: true,
                         searchingbyfieldName: 'Name',
                         windowTittle: 'Buyer List'
                     };
                     $.icsPicker(oPickerParam);
                     IntializePickerbutton(oPickerParam);
                 }
                 else { alert(response.objs[0].ErrorMessage); }
             }
         });

     });
     $('#txtSupplier').keydown(function (e) {
         var code = (e.keyCode ? e.keyCode : e.which);
         if (code == 8) //backspace=8
         {
             //debugger;
             var txtSupplierName = document.getElementById("txtSupplier");
             txtSupplierName.style.color = "black";
             txtSupplierName.style.fontWeight = "normal";
             _nContractorIDs = "";

         }
     });
     function IntializePickerbutton(oPickerobj) {
         debugger;
         $("#" + oPickerobj.winid).find("#btnOk").click(function () {
             debugger;
             //for Single Select
             PickerEvents(oPickerobj);
         });
         $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
             if (e.which == 13)//enter=13
             {
                 PickerEvents(oPickerobj);
             }
         });
     }
     function PickerEvents(oPickerobj) {
         var oreturnobj = null, oreturnobjs = [];
         if (oPickerobj.multiplereturn)
         {
             oreturnobjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
         } else
         {
             oreturnobj = $('#' + oPickerobj.tableid).datagrid('getSelected');
         }
    
         $("#" + oPickerobj.winid).icsWindow("close");
         $("#" + oPickerobj.winid).remove();
         if (oPickerobj.winclass == 'clsSupplier')
         {
             _nContractorIDs = "";
             if (oPickerobj.multiplereturn)
             {
                 var ncount = 0;
                 for (var i = 0; i <oreturnobjs.length; i++) {
                     var nSupplierID = oreturnobjs[i].ContractorID;
                     _nContractorIDs = _nContractorIDs + nSupplierID + ',';
                     ncount++;
                 }
                 if (ncount > 1)
                 {
                     $('#txtSupplier').val("Select " + ncount + " Supplier's");
                 } else
                 {
                     $('#txtSupplier').val(oreturnobjs[0].Name);
                 }
                 _nContractorIDs = _nContractorIDs.substring(0, _nContractorIDs.length - 1);

             } else
             {
                 $('#txtSupplier').val(oreturnobj.Name);
                 _nContractorIDs = "" + oreturnobj.ContractorID + "";
                 $('#txtSupplier').focus();
             }
             var txtSupplier = document.getElementById("txtSupplier");
             txtSupplier.style.color = "blue";
             txtSupplier.style.fontWeight = "bold";
         }  
     }
    
     $(document).keydown(function (e) {
         //debugger;
         if (e.which == 27)//escape=27
         {
             //debugger;
             $("#winAdvanceSearch_LC").icsWindow('close');
         }
     });
     
     $("#btnSearch").click(function () {

         $("#winAdvanceSearch_LC").icsWindow('open', "Advance Search");
         $("#winAdvanceSearch_LC input").not("input[type='button']").val("");
         $("#winAdvanceSearch_LC select").val(0);
         SetTodayDate();
         RefreshDateSearch();
     });

     function RefreshDateSearch()
     {
         debugger;
         SetTodayDate();
         $('#cboDateSearch').empty();
         var listDates = "<option value='"+"0"+"'>" + "None" + "</option>";
         listDates+= "<option value='"+"1"+"'>" + "EqualTo" + "</option>";
         listDates+= "<option value='"+"5"+"'>" + "Between" + "</option>";
         $("#cboDateSearch").html(listDates);
     }

     //Refresh
     $('#btnRefresh').click(function () {
         debugger;
     
           
         var sSelectedOption = $('#cboDateSearch').val();
         var dStartDate = $('#txtOpeningDateStart').datebox('getValue');
         var dEndDate = $('#txtOpeningDateEnd').datebox('getValue');
        
         var sMakStatsQry="";

         var chkResult = CheckEmpty();
         if (chkResult!= true) {
             alert("Please Select Date Criteria !!");
             return;
         }

         var oImportLC= {


             DateOption :sSelectedOption,
             ImportLCDate: dStartDate,
             ImportLCDate_End: dEndDate,
             SupplierName    :_nContractorIDs

          
         };
         $.ajax({
             type: "POST",
             dataType: "json",
             url : _sBaseAddress+  "/ImportLC/GetsSearchedData",
             data: JSON.stringify(oImportLC),
             contentType: "application/json; charset=utf-8",
             success: function (data) {
                 debugger;
                 var oImportLCs = jQuery.parseJSON(data);
                 debugger;
                 if (oImportLCs != null)
                 {
                     if (oImportLCs.length > 0)
                     {
                         DynamicRefreshList(oImportLCs,'tblSCs_AdvS');
                            
                     }
                     else {
                         alert("Data not found!!");
                         DynamicRefreshList([],'tblSCs_AdvS');
                     }
                 }
                 else{
                     alert("Data not found!!");
                     DynamicRefreshList([],'tblSCs_AdvS');
                 }
             },
             error: function (xhr, status, error) {
                 alert(error);
             }
         });

     });

     //Reset
     $('#btnReset').click(function () {
         debugger;
         DynamicRefreshList([],'tblSCs_AdvS');
         RefreshDateSearch();

     });

     //Button Click
     $('#btnOkAdvSearch').click(function () {
         var oSCs = [];
         var oSCs = $('#tblSCs_AdvS').datagrid('getChecked');
         if (oSCs.length <= 0) {
             alert("please select at least one item");
             return;
         }
         DynamicRefreshList(oSCs,'tblImportLC');
         $("#winAdvanceSearch_LC").icsWindow('close');
     });

     //Close Picker
     $('#btnCloseAdvSearch').click(function () {
         $("#winAdvanceSearch_LC").icsWindow('close');
     });

     $('._select_changeA').change(function () {
         //  debugger;
          
         var x = $("#cboDateSearch").val();
         if (x == "EqualTo" || x == "NotEqualTo" || x == "GreaterThen" || x == "SmallerThen") {
             $('#txtOpeningDateStart').datebox({disabled: false});
             $('#txtOpeningDateStart').datebox('setValue', icsdateformat(new Date()));
             $('#txtOpeningDateEnd').datebox({disabled: true});
             $('#txtOpeningDateEnd').datebox('setValue', icsdateformat(new Date()));
         }
         else {
             $('#txtOpeningDateStart').datebox({disabled: false});
             $('#txtOpeningDateStart').datebox('setValue', icsdateformat(new Date()));
             $('#txtOpeningDateEnd').datebox({disabled: false});
             $('#txtOpeningDateEnd').datebox('setValue', icsdateformat(new Date()));
         }
     });

     function SetTodayDate() {
         $('#txtOpeningDateStart').datebox('setValue', icsdateformat(new Date()));
         $('#txtOpeningDateEnd').datebox('setValue', icsdateformat(new Date()));
     }
     function CheckEmpty() {

         var cboDateSearch = document.getElementById("cboDateSearch");
         var ncboDateSearch = cboDateSearch.options[cboDateSearch.selectedIndex].index;
        
         //   var sStatus =  $('#tblStatusLoad').datagrid('getChecked');
         if (ncboDateSearch<= 0 && _nContractorIDs=='' )
         {
             return false;
         }
         return true;
     }
     //End Search
    
</script>



