<html>
<head>
    @{
        ViewBag.Title = "Export Bill Encash";
    } 
</head>
<body>

    @model ESimSol.BusinessObjects.ExportBill
    <div class="menuMainCollectionTable">
        <div id="divExportBillEncash" style="width:100%;height:100%">
            <div style="width:100%;height:88%">
                <fieldset>
                    <legend style="font-weight:bold">L/C & Invoice  info </legend>
                    <table border="0" cellspacing="2" cellpadding="2" style=" width:100%;font-size:12px; font-weight:bold">
                        <tr>
                            <td style="width:8%; text-align:right">
                                Invoice No :
                            </td>
                            <td style="width:8%">
                                <input id="txtExportBillNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                File No :
                            </td>
                            <td style="width:8%">
                                <input id="txtFileNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                Bill Date :
                            </td>
                            <td style="width:8%">
                                <input id="txtExportBillDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td rowspan="6" style="width:46%; font-weight:normal">
                                <table id="tblLoan" title="PC Loan Settlement" style="width:100%;height:100%" class="easyui-datagrid" fit="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" showfooter="true" toolbar="#toolbarLoan">
                                    <thead data-options="frozen:true">
                                        <tr>
                                            <th field="LoanLCNo" width="22%" align="left">Export LCNo</th>
                                                                     
                                        </tr>
                                    </thead>
                                    <thead>
                                        <tr>                                            
                                            <th field="LoanNo" width="18%">Loan No</th>
                                            <th field="AmountSt" width="18%" align="right">Paid Amount</th>
                                            <th field="AmountBCSt" width="18%" align="right">Paid Amt(TK)</th>
                                            <th field="PrincipalAmountSt" width="18%" align="right">Principal Amt</th>
                                            <th field="InstallmentPrincipalAmountSt" width="18%" align="right">Effect Amt</th>
                                            <th field="TotalInterestAmountSt" width="18%" align="right">Interest Amt</th>
                                            <th field="ChargeAmountSt" width="18%" align="right">Charge Amt</th>
                                            <th field="DiscountPaidAmountSt" width="18%" align="right">Dis(Paid)</th>
                                            <th field="DiscountRcvAmountSt" width="18%" align="right">Dis(Rcv)</th>
                                            <th field="TotalPayableAmountSt" width="18%" align="right">Payable Amt</th>                                            
                                        </tr>
                                    </thead>
                                </table>
                                <div id="toolbarLoan">                                                               
                                    <a id="btnLoanSettlement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true">Settlement</a>
                                    <a id="btnLoanEdit" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-edit" plain="true">Edit</a>
                                    <a id="btnLoanView" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-details" plain="true">View</a>
                                    <a id="btnRemoveSettlement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true">Remove</a>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:8%; text-align:right">
                                L/C No :
                            </td>
                            <td colspan="3" style="width:26%">
                                <input id="txtLCNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                <label id="lblAmendmentNo">Amendment :</label>
                            </td>
                            <td style="width:8%">
                                <input id="txtAmendmentNoAndDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:8%; text-align:right">
                                Party Name :
                            </td>
                            <td colspan="3" style="width:26%">
                                <input id="txtApplicantName" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                Realization Dt :
                            </td>
                            <td style="width:8%">
                                <input id="txtRelizationDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:8%; text-align:right">
                                Nego. Bank :
                            </td>
                            <td colspan="3" style="width:26%">
                                <input id="txtBankName_Nego" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                FDD Rcv Date :
                            </td>
                            <td style="width:8%">
                                <input id="txtBankFDDRecDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:8%; text-align:right">
                                L/C Date :
                            </td>
                            <td style="width:8%">
                                <input id="txtLCDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                Maturity Rcv:
                            </td>
                            <td style="width:8%">
                                <input id="txtMaturityReceivedDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                LDBC/IBC Dt :
                            </td>
                            <td style="width:8%">
                                <input id="txtLDBCDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:8%; text-align:right">
                                L/C Value :
                            </td>
                            <td style="width:8%">
                                <input id="txtIAmountLC" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                Maturity Date :
                            </td>
                            <td style="width:8%">
                                <input id="txtMaturityDate" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                            <td style="width:10%; text-align:right">
                                LDBC/IBC No :
                            </td>
                            <td style="width:8%">
                                <input id="txtLDBCNo" style="width: 100%;font-size:12px; font-weight:bold" class="type-diabaled" disabled />
                            </td>
                        </tr>
                    </table>
                </fieldset>

                <fieldset>
                    <legend style="font-weight:bold">Encashment info </legend>
                    <table style="width:100%;font-size:12px; font-weight:normal" border="0" cellspacing="2" cellpadding="2">
                        <tr>
                            <td style="width:6%; text-align:right">
                                Bill Value :
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtBillAmountSt" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                Accept Rate:
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtAcceptRate" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                Amount(BD):
                            </td>
                            <td style="width:12%; text-align:left">
                                <input id="txtBillAmountBCSt" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                <label id="lblForEx" style="font-weight:normal">ForEx Gain:</label>
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtForExCurrency" style="width: 100%;font-size:12px; font-weight:bold;" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                <label id="lblForExAmount" style="font-weight:normal">Gain Amount:</label>
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtForExAmountSt" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                Encash Date
                            </td>
                            <td style="width:10%">
                                <input id="txtEncashmentDate" type="text" style="width: 100%;" class="easyui-datebox" required="required" data-options="formatter:icsdateformat,parser:icsdateparser" />
                            </td>
                        </tr>
                        <tr>
                            <td style="width:6%; text-align:right">
                                Currency :
                            </td>
                            <td style="width:8%; text-align:left">
                                <select id="cboCurrency_Encash" style="width:100%;"></select>
                            </td>
                            <td style="width:8%; text-align:right">
                                Encash Rate:
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtCRate_Encash" type="text" style="width:100%; font-weight:bold" />
                            </td>
                            <td style="width:8%; text-align:right">
                                Amount(BD):
                            </td>
                            <td style="width:12%; text-align:left">
                                <input id="txtEncashAmountBC" type="text" style="width:100%; text-align:right; font-weight:bold" />
                            </td>
                            <td style="width:8%; text-align:right">
                                Over-Due:
                                @*<label style="font-weight:normal;font-size:10px;">OverDue Amount:</label>*@
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtOverDueAmount" style="width: 100%;font-size:12px; font-weight:bold;" />
                            </td>
                            <td style="width:8%; text-align:right">
                                Over-Due(BD):
                                @*<label style="font-weight:normal;font-size:10px;">OverDue Amount(BD):</label>*@
                            </td>
                            <td style="width:8%; text-align:left">
                                <input id="txtOverDueAmountBDT" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:8%; text-align:right">
                                Remarks:
                            </td>
                            <td style="width:10%; text-align:left">
                                <input id="txtNote_Encashment" type="text" style="width:100%;" />
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <div style="float:left; width:100%;height:70px">
                    <fieldset >
                        <legend style="font-weight:bold">Discount Adjustment Info, Exp Bank Info and Encashment Breakdown </legend>
                        <table style="width:100%">
                            <tr>
                                <td style="width:30%">
                                    <table style="width:100%;font-size:12px; font-weight:normal" border="0" cellspacing="2" cellpadding="2">
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                                Discount Adj Amount :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <input id="txtDisCountAdjAmtSymbol" style="width: 15%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled placeholder="$" />
                                                <input id="txtDisCountAdjAmount" style="width: 82%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                                            </td>
                                            <td style="width:10%; text-align:right">
                                               
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                                Discount Adj Currency Rate :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <input id="txtDisCountAdjRate" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                                            </td>
                                            <td style="width:10%; text-align:right">
                                           
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                                Discount Adj Amount(BD) :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <input id="txtDisCountAdjAmountBD" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                                            </td>
                                            <td style="width:10%; text-align:right"></td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                                <label id="lblDisCountForEx" style="font-weight:normal">Discount Adj Amount GainLoss:</label>
                                                
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <input id="txtDisCountAdjGainLoss" style="width: 100%;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                                            </td>
                                            <td style="width:10%; text-align:right"></td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                               Exp Bank(If Needed) :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <select id="cboExpBankAccount" style="width:100%"></select>
                                            </td>
                                            <td style="width:10%; text-align:right"></td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                               Exp Amount :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <select id="cboExpCurrency" style="width:37%"></select>
                                                <input id="txtExpAmount" style="width: 60%;font-size:12px; font-weight:bold; text-align:right" placeholder="Exp Amount" />
                                            </td>
                                            <td style="width:10%; text-align:right"></td>
                                            </tr>
                                        <tr>
                                            <td style="width:50%; text-align:right">
                                               Exp Amount (BD) :
                                            </td>
                                            <td style="width:40%; text-align:left">
                                                <input id="txtExpCRate" style="width: 52%;font-size:12px; font-weight:bold; text-align:right" placeholder="Exp CRate" />
                                                <input id="txtExpAmountBC" style="width: 45%;font-size:12px; font-weight:bold; text-align:right" disabled="disabled" placeholder="Exp Amount BC" />
                                            </td>
                                            <td style="width:10%; text-align:right"></td>
                                        </tr>
                                     
                                    </table>
                                </td>
                                <td style="width:70%;">
                                    <div style="width:100%;height:180px;">
                                        <table id="tblEncashmentBreakdown" style="width:100%;height:50px;" class="easyui-datagrid" fit="true" showfooter="true" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#toolbar">
                                            <thead>
                                                <tr>
                                                    <th field="AccountCode" width="10%">Account Code</th>
                                                    <th field="AccountHeadName" width="15%" align="left">Account Head Name</th>
                                                    <th field="SubledgerCode" width="12%" align="left">Subledger Code</th>
                                                    <th field="SubledgerName" width="15%" align="left">Subledger Name</th>
                                                    <th field="CurrencyName" width="8%">Currency</th>
                                                    <th field="Amount" width="10%" align="right"  formatter="formatPrice">Amount</th>
                                                    <th field="CCRate" width="15%" align="right" precision="4" formatter="formatPrice">CRate</th>
                                                    <th field="AmountBC" width="15%" align="right" formatter="formatPrice">Amount(BD)</th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <div id="toolbar">
                                            <input type="text" id="txtAccountHead" style="width:180px" placeholder="Enter with Account Head Name or Code" />
                                            <input type="button" id="btnPickAccountHead" style="width:25px;" value="P" />
                                            <input type="button" id="btnClearAccountHead" style="width:25px;" value="C" />
                                            <input type="text" id="txtSubledger" style="width:160px" placeholder="Enter with Subledger Name or Code" />
                                            <input type="button" id="btnPickSubledger" style="width:25px;" value="P" />
                                            <input type="button" id="btnClearSubledger" style="width:25px;" value="C" />
                                            <select id="cboCurrency" style="width:12%;"></select><input type="text" id="txtCRate" style="width:12%;text-align:right" placeholder="CRate" />
                                            <input id="txtAmount" type="text" style="width:80px; margin-top:2px" placeholder="Amount" />&nbsp;
                                            <a id="btnAdd" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-add" plain="true"></a>
                                            <a id="btnRemove" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-remove" plain="true"></a>
                                        </div>
                                    </div>
                                </td>
                            </tr>

                        </table>
                    </fieldset>
</div>
            </div>

            <fieldset style="margin-top:9px;height:10%">
                <legend>Action</legend>
                <div style="width:100%;">
                    <table border="0" cellpadding="2" cellspacing="2" style="width:100%;">
                        <tr>
                           
                            <td style="width:7%; text-align:right; font-weight:bold">
                                Balance :
                            </td>
                            <td style="width: 10%; text-align:left">
                                <input id="txtBalanceAmount" style="width: 143px;font-size:12px; font-weight:bold; text-align:right" class="type-diabaled" disabled />
                            </td>
                            <td style="width:13%; font-size:13px"></td>
                            <td style="width: 15%;text-align: right;  font-size:13px">
                                <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Commit</a>
                                <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                            </td>
                        </tr>
                    </table>
                </div>

            </fieldset>
        </div>

        <div id="winLoanInstallment" class="easyui-window" title="Loan Settlement" style="height: 515px; width: 1020px;" data-options="modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false,closable:false">
            <div id="p" style="width:99%; height:100%; padding:1px">
                <div style="width:100%; height:85%; padding-top:2px">
                    <fieldset style="width:100%; height:100%">
                        <legend>Loan Info:</legend>
                        <table border="0" cellpadding="2" cellspacing="2" style="width:100%">
                            <tr>
                                <td style="width:10%; text-align:right">File No:</td>
                                <td style="width:15%">
                                    <input type="text" id="txtLoanFileNo" style="width:100%; font-weight:bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Loan No:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:70%">
                                                <input type="text" id="txtLoanNumber" style="width: 100%; font-weight: bold" />
                                            </td>                                            
                                            <td style="width:15%">
                                                <input type="button" value="Sug" style="width:100%; height:100%; font-weight:bold; text-align:center; padding-left:0px" id="btnLoanSuggest" />
                                            </td>   
                                            <td style="width:15%">
                                                <input type="button" value="Clr" style="width: 100%; height: 100%; font-weight: bold; text-align: center; padding-left: 0px" id="btnLoanClear" />
                                            </td>                                         
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">Loan Type:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanType" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Issue Date:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanIssueDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">Loan Start DT:</td>
                                <td style="width:15%">
                                    <input type="text" id="txtLoanStartDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Export LC:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanExportLC" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Loan A/C:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanAccountNo" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Loan Amt:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtLoanAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtLoanAmount" style="width: 100%; text-align: right; font-weight: bold; " disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">Loan Transfer:</td>
                                <td style="width:15%">
                                    <select id="cboLoanTransfer" style="width: 100%; font-weight: bold"></select>
                                </td>
                                <td style="width: 10%; text-align: right">Turf Date:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:50%">
                                                <input id="txtTransferDate" type="text" style="width: 100px" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                            </td>
                                            <td style="width:50%">
                                                <input type="text" id="txtTransferInterestDays" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">Transfer IR:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanTransferInterestRate" style="width: 100%; font-weight: bold" />
                                </td>
                                <td style="width: 10%; text-align: right">Turf Interest:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtTransferInterestCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtTransferInterest" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">Interest Rate:</td>
                                <td style="width:15%">
                                    <input type="text" id="txtLoanInterestRate" style="width: 100%; font-weight: bold" />
                                </td>
                                <td style="width: 10%; text-align: right">Stlmt Date:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:50%">
                                                <input id="txtSettlementDate" type="text" style="width: 100px;" class="easyui-datebox" data-options="formatter:icsdateformat,parser:icsdateparser" />
                                            </td>
                                            <td style="width:50%">
                                                <input type="text" id="txtInterestDays" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>                                    
                                </td>
                                <td style="width: 10%; text-align: right">Int. Amount:</td>
                                <td style="width: 15%">
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtLoanInterestAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtLoanInterestAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">Total Interest:</td>
                                <td style="width: 15%">                                    
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtTotalInterestAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtTotalInterestAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>                           
                            <tr>
                                <td style="width:10%; text-align:right">Approx Stlmt</td>
                                <td style="width:15%">
                                    <input type="text" id="txtApproxStlmtDate" style="width: 100%; font-weight: bold" disabled="disabled" />
                                </td>
                                <td style="width: 10%; text-align: right">Principle Amt:</td>
                                <td style="width: 15%">                                    
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtLoanPrincipleAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtLoanPrincipleAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">Total Charge:</td>
                                <td style="width: 15%">                                    
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtLoanTotalChargeCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtLoanTotalCharge" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width: 10%; text-align: right">Remarks:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtLoanStlmtRemarks" style="width: 100%; font-weight: bold" />                                    
                                </td>
                            </tr>
                            <tr>
                                <td style="width:10%; text-align:right">Dis(Paid) Amt:</td>
                                <td style="width:15%">
                                    <input type="text" id="txtDiscountPaidAmount" style="width: 100%; font-weight: bold" />
                                </td>
                                <td style="width: 10%; text-align: right">Dis(Rcv) Amt:</td>
                                <td style="width: 15%">
                                    <input type="text" id="txtDiscountRcvAmount" style="width: 100%; font-weight: bold" />
                                </td>
                                <td style="width: 10%; text-align: right">Payable Amt:</td>
                                <td style="width: 15%">                                    
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtTotalPayableAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">                                                
                                                <input type="text" id="txtTotalPayableAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>                                
                                <td style="width: 10%; text-align: right">Paid Amt:</td>
                                <td style="width: 15%">                                    
                                    <table border="0" cellpadding="0" cellspacing="0">
                                        <tr>
                                            <td style="width:25%">
                                                <input type="text" id="txtLoanPaidAmountCurrency" style="width: 100%; text-align: center; font-weight: bold; " disabled="disabled" />
                                            </td>
                                            <td style="width:75%">
                                                <input type="text" id="txtLoanPaidAmount" style="width: 100%; text-align: right; font-weight: bold" disabled="disabled" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style="width:50%">
                                    <table style="height:210px; width:100%" id="tblLoanCharge" title="Loan Charge Details" class="easyui-datagrid" singleselect="true" showfooter="true" toolbar="#toolLoanCharge">
                                        <thead>
                                            <tr>
                                                <th field="AccountName" width="35%">Cost Head</th>
                                                <th field="CurrencySymbol" width="15%">Curency</th>
                                                <th field="Amount" formatter="formatPrice" width="15%" align="right">Amount</th>
                                                <th field="CRate" formatter="formatPrice" width="15%" align="right">C Rate</th>
                                                <th field="AmountBC" formatter="formatPrice" width="15%" align="right">Amount(TK)</th>
                                            </tr>
                                        </thead>
                                    </table>
                                    <div style="width:100%" id="toolLoanCharge">
                                        <select id="cboExpenseHead" style="width:40%;"></select>
                                        <select id="cboChargeCurSymbol" style="width:10%;" disabled></select>
                                        <input type="text" style="width:12%" id="txtLoanChargeCRate" />
                                        <input type="text" style="width:15%" id="txtLoanChargeAmount" />
                                        <a id="btnAddCharge" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-add" plain="true"></a>
                                        <a id="btnChargeDelete" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-remove" plain="true"></a>
                                    </div>
                                </td>
                                <td colspan="4" style="width:50%">
                                    <table style="height:210px; width:99%" id="tblPayment" title="Payment Details" class="easyui-datagrid" singleselect="true" showfooter="true" toolbar="#toolbarLoanPayment">
                                        <thead>
                                            <tr>
                                                <th field="AccountName" width="35%">Bank A/C</th>
                                                <th field="CurrencySymbol" width="15%">Curency</th>
                                                <th field="Amount" formatter="formatPrice" width="17%" align="right">Amount</th>
                                                <th field="CRate" formatter="formatPrice" width="15%" align="right">C Rate</th>
                                                <th field="AmountBC" formatter="formatPrice" width="17%" align="right">Amount(TK)</th>
                                            </tr>
                                        </thead>
                                    </table>
                                    <div style="width:100%" id="toolbarLoanPayment">
                                        <select id="cboBankAC" style="width:40%;"></select>
                                        <select id="cboPaymentCurrencySymbol" style="width:10%;" disabled></select>
                                        <input type="text" style="width:12%" id="txtPaymentCRate" />
                                        <input type="text" style="width:15%" id="txtPaymentAmount" />
                                        <a id="btnPaymentAdd" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-add" plain="true"></a>
                                        <a id="btnPaymentDelete" href="javascript:void(0)" class="easyui-linkbutton easyui-tooltip" iconcls="icon-remove" plain="true"></a>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
                <div style="width:100%; height:15%">
                    <fieldset style="width:100%; height:100%">
                        <legend> Action:</legend>
                        <table border="0" cellpadding="0" cellspacing="0" style="width:100%">
                            <tr style="height:100%">
                                <td style="width:60%; text-align:left; font-size:12px; font-weight:bold">
                                    <label id="lblLoanBalance" style="font-size:15px; font-weight:bold; color:red">Balance : 0.00</label>
                                </td>
                                <td style="width: 20%; text-align: right; font-size: 12px; font-weight: bold; vertical-align: bottom;">
                                    <a id="btnSaveLoanSettlement" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save" plain="true">Save</a>
                                </td>
                                <td style="width:20%; text-align:right; font-size:12px; font-weight:bold; vertical-align:bottom">
                                    <a id="btnCloseLoan" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" plain="true">Close</a>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
                
            </div>
        </div>
    </div>
</body>
</html>

<style type="text/css">
    .td-styler input {
        padding-left: 5px;
    }

    .td-styler select {
        padding-left: 5px;
    }

    .td-col-3 select {
        width: 95%;
    }
    /*.element.style {
    width: 854px;
    height: 150px;
    }*/
</style>

<script type="text/javascript">    
    $(document).ready(function () {        
        var oExportBill =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        var oCurrencys = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Currencys));
        var oBankAccounts = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.BankAccounts));
        var oExpenditureHeads = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.ExpenditureHeads));
        var oCompany = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.Company));
        var oTrnasferTypes = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(ViewBag.TrnasferTypes));

        $('#AppMainLayout').layout('collapse', 'west');        
        $('#AppMainLayout').layout('expand', 'west');
        $('#AppMainLayout').layout('collapse', 'west');

        $("#txtLoanPaidAmount").data('PaymentBC', parseFloat(0.00));
        $('#divExportBillEncash').data('ExportBill', oExportBill);
        $('#divExportBillEncash').data('Currencys', oCurrencys);
        $('#divExportBillEncash').data('BankAccounts', oBankAccounts);
        $('#divExportBillEncash').data('ExpenditureHeads', oExpenditureHeads);
        $('#divExportBillEncash').data('Company', oCompany);
        $('#divExportBillEncash').data('TrnasferTypes', oTrnasferTypes);
        $('#divExportBillEncash').data('ExportBillEncashments', oExportBill.ExportBillEncashments);
        $('#txtCRate_Encash,#txtCRate,#txtCRate_Exp,#txtOverDueAmount,#txtLoanInterestRate,#txtLoanChargeCRate,#txtPaymentCRate,#txtLoanTransferInterestRate,#txtExpCRate,#txtDisCountAdjRate').icsCurrencyBox(null, null, 4);
        $('#txtEncashAmountBC,#txtAmount,#txtPaymentAmount,#txtLoanChargeAmount,#txtDisCountAdjGainLoss,#txtDisCountAdjAmount,#txtDisCountAdjAmountBD,#txtDiscountPaidAmount,#txtDiscountRcvAmount,#txtExpAmount,#txtExpAmountBC').icsCurrencyBox(null, null, 2);
        RefreshComboBox();
        RefreshControl();
        if(parseInt(oExportBill.StateInt)===8)
        {
            $('#divExportBillEncash :input').prop('disabled', true)
            $('#btnSave,#btnLoanSettlement,#btnLoanEdit,#btnRemoveSettlement').hide();
        }
    });

    function RefreshComboBox()
    {
        debugger;
        var oCurrencys = $('#divExportBillEncash').data('Currencys');
        var oBankAccounts = $('#divExportBillEncash').data('BankAccounts');
        var oExpenditureHeads = $('#divExportBillEncash').data('ExpenditureHeads');

        $("#cboBankAccount").icsLoadCombo({List: oBankAccounts, OptionValue:"BankAccountID",DisplayText: "AccountNo", InitialValue:"--Select Bank A/C--" });
        $("#cboCurrency").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "CurrencyName", InitialValue:"--Currency--"});
        $("#cboCurrency").val(1);
        $('#txtCRate').attr('disabled','disabled');
        $('#txtCRate').val('1.00');
        $("#cboCurrency_Encash").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "CurrencyName", InitialValue:"--Currency--"});
        $("#cboExpBankAccount").icsLoadCombo({List: oBankAccounts, OptionValue:"BankAccountID",DisplayText: "AccountNo", InitialValue:"--Select Bank A/C--" });
        $("#cboExpCurrency").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "CurrencyName", InitialValue:"--Currency--"});
    }

    function RefreshControl()
    {    
        var oCompany = $('#divExportBillEncash').data('Company');
        var oExportBill = $('#divExportBillEncash').data('ExportBill');
        var oExportBillEncashments = $('#divExportBillEncash').data('ExportBillEncashments');

        $("#txtExportBillNo").val(oExportBill.ExportBillNo);
        $("#txtAmendmentNoAndDate").val(oExportBill.AmendmentNo);        
        $("#txtLCNo").val(oExportBill.ExportLCNo);
        $("#txtFileNo").val(oExportBill.FileNo);
        $("#txtApplicantName").val(oExportBill.ApplicantName);
        $("#txtExportBillDate").val(oExportBill.StartDateSt);
        $("#txtLCDate").val(oExportBill.LCOpeningDatest);
        $("#txtBankName_Nego").val(oExportBill.BankName_Nego + '[' + oExportBill.BBranchName_Nego + ']');
        $("#txtBillAmountSt").val(oExportBill.AmountSt);
        $("#txtIAmountLC").val(oExportBill.Amount_LCSt);
        $("#txtRelizationDate").val(oExportBill.RelizationDateSt);
        $("#txtBankFDDRecDate").val(oExportBill.BankFDDRecDateSt);

        $("#txtLDBCNo").val(oExportBill.LDBCNo);
        $("#txtLDBCDate").val(oExportBill.LDBCDateSt);
        $("#txtMaturityReceivedDate").val(oExportBill.MaturityReceivedDateSt);
        $("#txtMaturityDate").val(oExportBill.MaturityDateSt);
        $("#txtForExCurrency").val(oCompany.CurrencyName);
        $("#txtDisCountAdjAmount").val(icsFormatPrice(parseFloat(oExportBill.LDBPAmount), null,2));
        $("#txtDisCountAdjRate").val(icsFormatPrice(parseFloat(oExportBill.LDBPCCRate), null,4));
        $("#txtDisCountAdjAmountBD").val(icsFormatPrice(parseFloat(oExportBill.LDBPAmountBD), null,2));
        $("#txtDisCountAdjAmtSymbol").val(oExportBill.LDBPCSymbol);

        if(parseInt(oExportBill.EncashCurrencyID)>0)
        {
            $('#cboCurrency_Encash').val(parseInt(oExportBill.EncashCurrencyID));
        }
        else
        {
            $('#cboCurrency_Encash').val(parseInt(oCompany.BaseCurrencyID));
        }
        $('#cboCurrency_Encash').prop('disabled', true);

        if(parseInt(oExportBill.EncashCurrencyID)=== parseInt(oExportBill.CurrencyID))
        {
            $('#txtCRate_Encash').prop('disabled', true);
            $('#txtEncashAmountBC').prop('disabled', true);
        }

        if (oExportBill.EncashmentDateSt == "" || oExportBill.EncashmentDateSt == "--") {
            $('#txtEncashmentDate').datebox('setValue', icsdateformat(new Date()));
        }
        else {
            $('#txtEncashmentDate').datebox('setValue', oExportBill.EncashmentDateSt);
        }

        var nBillAmountBC = parseFloat((parseFloat(oExportBill.AcceptanceRate) * parseFloat(icsRemoveComma(oExportBill.BillAmountSt))).toFixed(3));
        $('#txtAcceptRate').val(icsFormatPrice(parseFloat(oExportBill.AcceptanceRate), null,4));
        $('#txtBillAmountBCSt').val(icsFormatPrice(parseFloat(nBillAmountBC), null,2));        
        $('#txtCRate_Encash').val(icsFormatPrice(parseFloat(oExportBill.EncashCRate), null,4));
        $('#txtEncashAmountBC').val(icsFormatPrice(parseFloat(oExportBill.EncashAmountBC), null,2));        
        $("#txtNote_Encashment").val(oExportBill.EncashRemarks);
        $("#txtOverDueAmount").val(oExportBill.OverDueAmount);
        $("#txtOverDueAmountBDT").val(formatPrice(parseFloat(oExportBill.OverDueAmount)*parseFloat($('#txtCRate_Encash').val()),0));
        $("#cboExpBankAccount").val(parseInt(oExportBill.ExpBankAccountID));
        $("#cboExpCurrency").val(parseInt(oExportBill.ExpCurrencyID));
        $("#txtExpAmount").val(icsFormatPrice(parseFloat(oExportBill.ExpAmount), null, 2));
        $("#txtExpCRate").val(icsFormatPrice(parseFloat(oExportBill.ExpCRate), null, 4));
        $("#txtExpAmountBC").val(icsFormatPrice(parseFloat(oExportBill.ExpAmountBC), null, 2));

        var oEBELoans = [];
        var oEBEncashmentBreakdowns = [];                
        for (var i = 0; i < oExportBillEncashments.length ; i++)
        {
            if(parseInt(oExportBillEncashments[i].LoanInstallmentID)>0)
            {                
                oEBELoans.push(oExportBillEncashments[i]);
            }
            else
            {
                oEBEncashmentBreakdowns.push(oExportBillEncashments[i]);
            }
        }
        DynamicRefreshList(oEBELoans, "tblLoan");
        DynamicRefreshList(oEBEncashmentBreakdowns, "tblEncashmentBreakdown");
        RefreshTotalAmount();
        RefreshAmount();
    }

    $('#txtCRate_Encash').keyup(function(e){
        var oExportBill = $('#divExportBillEncash').data('ExportBill');
        var nEncashRate = icsRemoveComma($('#txtCRate_Encash').val());                
        var nEncashAmountBC = parseFloat((parseFloat(nEncashRate) *  parseFloat(parseFloat(icsRemoveComma(oExportBill.BillAmountSt)).toFixed(3))).toFixed(2));
        $('#txtEncashAmountBC').val(icsFormatPrice(parseFloat(nEncashAmountBC), null,2));
        var nOverDueAmount = $("#txtOverDueAmount").val();
        $("#txtOverDueAmountBDT").val(formatPrice(parseFloat(nOverDueAmount)*parseFloat(nEncashRate),0));
        RefreshAmount();
    });

    $('#txtEncashAmountBC').keyup(function(e){
        var oExportBill = $('#divExportBillEncash').data('ExportBill');
        var nEncashAmountBC = icsRemoveComma($('#txtEncashAmountBC').val());        
        var nEncashRate =  parseFloat((parseFloat(nEncashAmountBC) / parseFloat(parseFloat(icsRemoveComma(oExportBill.BillAmountSt)).toFixed(3))).toFixed(4));
        $('#txtCRate_Encash').val(icsFormatPrice(parseFloat(nEncashRate), null, 4));
        var nOverDueAmount = $("#txtOverDueAmount").val();
        $("#txtOverDueAmountBDT").val(formatPrice(parseFloat(nOverDueAmount)*parseFloat(nEncashRate),0));
        RefreshAmount();
    });

    $('#txtOverDueAmount').keyup(function(e){
        var nOverDueAmount = $("#txtOverDueAmount").val();
        var nEncashRate = icsRemoveComma($('#txtCRate_Encash').val());    
        $("#txtOverDueAmountBDT").val(formatPrice(parseFloat(nOverDueAmount)*parseFloat(nEncashRate),0));
        RefreshAmount();
    });

    $('#txtExpAmount').keyup(function(e){
        var nExpAmount = $("#txtExpAmount").val();
        var nExpCRate = parseFloat(icsRemoveComma($('#txtExpCRate').val()));    
        $("#txtExpAmountBC").val(formatPrice(parseFloat(nExpAmount)*parseFloat(nExpCRate),0));
        RefreshAmount();
    });

    $('#txtExpCRate').keyup(function(e){
        var nExpAmount = $("#txtExpAmount").val();
        var nExpCRate = parseFloat(icsRemoveComma($('#txtExpCRate').val()));    
        $("#txtExpAmountBC").val(formatPrice(parseFloat(nExpAmount)*parseFloat(nExpCRate),0));
        RefreshAmount();
    });

    $('#cboExpCurrency').change(function(e){
        var oCompany = $('#divExportBillEncash').data('Company');
        var nSelectedCurrency = parseInt($('#cboExpCurrency').val());
        if(parseInt(nSelectedCurrency) === parseInt(oCompany.BaseCurrencyID))
        {
            $('#txtExpCRate').val('1.00');
            $('#txtExpCRate').prop('disabled', true); 
            
        }
        else
        {
            $('#txtExpCRate').val('0.00');
            $('#txtExpCRate').prop('disabled', false);
        }

        var nExpAmount = $("#txtExpAmount").val();
        var nExpCRate = parseFloat(icsRemoveComma($('#txtExpCRate').val()));    
        $("#txtExpAmountBC").val(formatPrice(parseFloat(nExpAmount)*parseFloat(nExpCRate),0));
        RefreshAmount();
    });

    function RefreshAmount()
    {
        var nBillAmountBC = icsRemoveComma($('#txtBillAmountBCSt').val());
        var nEncashAmountBC = icsRemoveComma($('#txtEncashAmountBC').val());
        var nOverDueAmountBDT= icsRemoveComma($('#txtOverDueAmountBDT').val());
        var nExpAmountBC = icsRemoveComma($('#txtExpAmountBC').val());
        var nCRateEncash=icsRemoveComma($('#txtCRate_Encash').val());
        var nDisCountAdjRate=icsRemoveComma($('#txtDisCountAdjRate').val());
        var nDisCountAmount=icsRemoveComma($('#txtDisCountAdjAmount').val());
        var nDisCountAmountBD=icsRemoveComma($('#txtDisCountAdjAmountBD').val());
        var nCheckDisGainLoss = 0;
        if(parseFloat(nEncashAmountBC)>=parseFloat(nBillAmountBC))
        {
            $('#lblForEx').text("ForEx Gain:");
            $('#lblForExAmount').text("Gain Amount:");
            var nGainAmount = parseFloat((parseFloat(nEncashAmountBC) - parseFloat(nBillAmountBC)).toFixed(2));
            $('#txtForExAmountSt').val(icsFormatPrice(parseFloat(nGainAmount), null,2));
        }
        else
        {
            $('#lblForEx').text("ForEx Loss:");
            $('#lblForExAmount').text("Loss Amount:");
            var nLossAmount =  parseFloat((parseFloat(nBillAmountBC) - parseFloat(nEncashAmountBC)).toFixed(2));
            $('#txtForExAmountSt').val(icsFormatPrice(parseFloat(nLossAmount), null, 2));
        }

        if(parseFloat(nCRateEncash)>=parseFloat(nDisCountAdjRate))
        {            
            var DifRate = parseFloat(nCRateEncash) - parseFloat(nDisCountAdjRate);
            var nGainAmount=parseFloat((parseFloat(DifRate) * parseFloat(nDisCountAmount)).toFixed(2));
            $('#lblDisCountForEx').text("Discount Adj Gain:");
            $('#txtDisCountAdjGainLoss').val(icsFormatPrice(parseFloat(nGainAmount), null, 2));
            nCheckDisGainLoss = 1;
        }
        else
        {            
            var DifRate = (parseFloat(nDisCountAdjRate) - parseFloat(nCRateEncash));
            var nLossAmount =  parseFloat((parseFloat(DifRate) * parseFloat(nDisCountAmount)).toFixed(2));
            $('#lblDisCountForEx').text("Discount Adj Loss:");
            $('#txtDisCountAdjGainLoss').val(icsFormatPrice(parseFloat(nLossAmount), null, 2));
        }

        var nBalanceAmount = 0;
        var nTotalPaidLoanAmount = 0;
        var nTotalPaidLoanAmountBC = 0;        
        var nTotalAccountsAmount = 0;
        var nTotalExpenditureAmount =0;        
        var oLoans = $("#tblLoan").datagrid("getRows");
        var oEncashmentBreakdowns = $("#tblEncashmentBreakdown").datagrid("getRows");       
        for(var i=0; i<oEncashmentBreakdowns.length; i++)
        {
            nTotalAccountsAmount =  nTotalAccountsAmount + parseFloat(parseFloat(oEncashmentBreakdowns[i].AmountBC).toFixed(2));
        }
        for(var i=0; i<oLoans.length; i++)
        {            
            nTotalPaidLoanAmount = nTotalPaidLoanAmount + parseFloat(parseFloat(oLoans[i].Amount).toFixed(2));
            nTotalPaidLoanAmountBC = nTotalPaidLoanAmountBC + parseFloat(parseFloat(oLoans[i].AmountBC).toFixed(2));            
        }
        var nDisCountAdjGainLoss = icsRemoveComma($('#txtDisCountAdjGainLoss').val());
        $('#txtDisCountAdjGainLoss').data("DiscountGainLoss", false);
        if(nCheckDisGainLoss == 1)
        {
            nDisCountAdjGainLoss = (parseFloat(nDisCountAdjGainLoss) * (-1));
            $('#txtDisCountAdjGainLoss').data("DiscountGainLoss", true);
        }     
        
        nBalanceAmount = parseFloat(((parseFloat(nEncashAmountBC) + parseFloat(nOverDueAmountBDT) + parseFloat(nExpAmountBC) ) - (parseFloat(nTotalAccountsAmount) + parseFloat(nDisCountAmountBD) + parseFloat(nTotalPaidLoanAmountBC))+ parseFloat(nDisCountAdjGainLoss)).toFixed(2));       
        if(nBalanceAmount<0)
        {
            nBalanceAmount = (nBalanceAmount * (-1));
            $('#txtBalanceAmount').val('('+icsFormatPrice(parseFloat(nBalanceAmount), null,2)+')');
        }
        else
        {
            $('#txtBalanceAmount').val(icsFormatPrice(parseFloat(nBalanceAmount), null,2));
        }
        
        var FooterField=[];
        var obj=new Object();        
        obj['LoanLCNo']="Total Paid:";        
        obj['AmountBCSt'] = icsFormatPrice(parseFloat(nTotalPaidLoanAmountBC), null,2);
        FooterField.push(obj);
        $('#tblLoan').datagrid('reloadFooter',FooterField);
    }
    
    $('#cboCurrency').change(function(e){
        var oCompany = $('#divExportBillEncash').data('Company');
        var nSelectedCurrency = parseInt($('#cboCurrency').val());
        if(parseInt(nSelectedCurrency) === parseInt(oCompany.BaseCurrencyID))
        {
            $('#txtCRate').val('1.00');
            $('#txtCRate').prop('disabled', true); 
            
        }
        else
        {
            $('#txtCRate').val('0.00');
            $('#txtCRate').prop('disabled', false);
        }
    });
    
    $("#btnAdd").click(function(){
        var oExportBill = $('#divExportBillEncash').data('ExportBill');
        var oCompany = $('#divExportBillEncash').data('Company');

        if(oExportBill===null || parseInt(oExportBill.ExportBillID)<=0)
        {
            alert("Invalid Export Bill!");
            return;
        }        

        var oAccountHead=$("#txtAccountHead").data("AccountHead");
        if(oAccountHead==null)
        {
            alert("Please Pick Account Head");
            return;
        }
        var oSubledger = $("#txtSubledger").data("Subledger");
        if(oSubledger==null)
        {
            var oSubledger={
                ACCostCenterID:0,
                Name:"",
                Code:""
            }
       
            $("#txtSubledger").data("Subledger",oSubledger);
        }
        var oSubledger=$("#txtSubledger").data("Subledger");
        if(oAccountHead.IsCostCenterApply)
        {
            if(parseInt(oSubledger.ACCostCenterID)<=0)
            {
                alert("Please Select Subledger");
                return;
            }
        }
        if(parseInt($("#cboCurrency").val())<=0)
        {
            alert("Please Select Currency Type");
            return;
        }
        if(parseInt($("#cboCurrency").val())>1)
        {
            if(parseFloat(icsRemoveComma($('#txtCRate').val()))<=0)
            {
                alert("Please , Entry CRate!");
                $('#txtCRate').focus();
                return;
            }
        }    
        if(parseFloat(icsRemoveComma($('#txtAmount').val()))<=0)
        {
            alert("Please , Entry Amount!");
            $('#txtAmount').focus();
            return;
        }

        var oEncashmentBreakdowns = $("#tblEncashmentBreakdown").datagrid("getRows");       
        for(var i=0; i<oEncashmentBreakdowns.length; i++)
        {
            if(parseInt(oEncashmentBreakdowns[i].AccountHeadID) == parseInt(oAccountHead.AccountHeadID) &&   parseInt(oEncashmentBreakdowns[i].SubledgerID) == parseInt(oSubledger.ACCostCenterID))
            {
                alert("Your Selected Account Head & Subledger Already Exists!");
                return;
            }
        }

        var nAmount = parseFloat(icsRemoveComma($('#txtAmount').val()));        
        var nCCRate = parseFloat(icsRemoveComma($('#txtCRate').val()));
        var nAmountBC = (parseFloat(nAmount) * parseFloat(nCCRate));

        var oExportBillEncashment = {
            ExportBillEncashmentID : 0,
            ExportBillID : parseInt(oExportBill.ExportBillID),
            AccountHeadID : parseInt(oAccountHead.AccountHeadID),
            SubledgerID : parseInt(oSubledger.ACCostCenterID),
            SubledgerName :oSubledger.Name,
            SubledgerCode :oSubledger.Code,
            AccountCode : oAccountHead.AccountCode,
            AccountHeadName :oAccountHead.AccountHeadName,
            Amount : parseFloat(icsRemoveComma($('#txtAmount').val())),
            Note : "N/A",
            CurrencyID : parseInt($('#cboCurrency').val()),
            CCRate : parseFloat(icsRemoveComma($('#txtCRate').val())),
            AmountBC :parseFloat(icsRemoveComma(icsFormatPrice(nAmountBC, null, 2))),
            AmountBCSt : oCompany.CurrencySymbol+' '+ icsFormatPrice(nAmountBC, null, 2),
            CurrencyName : $("#cboCurrency option:selected").text()
        };

        $('#tblEncashmentBreakdown').datagrid('appendRow', oExportBillEncashment);
        if(parseInt(oSubledger.ACCostCenterID)>0)
        {
            $('#txtSubledger').val("");
            $('#txtSubledger').data('Subledger', null);
            $("#txtSubledger").removeClass("fontColorOfPickItem");
            $('#txtSubledger').focus();
        }
        else
        {
            $('#txtSubledger').val("");
            $('#txtSubledger').data('Subledger', null);
            $("#txtSubledger").removeClass("fontColorOfPickItem");            

            $('#txtAccountHead').val("");
            $("#txtAccountHead").removeClass("fontColorOfPickItem");
            $('#txtAccountHead').data('AccountHead', null);
            $('#txtAccountHead').focus();
        }
        RefreshTotalAmount();
        $('#txtAmount').val('0.00');      
        RefreshAmount();    
    });
    function RefreshTotalAmount()
    {
        
        var oExportBillEncashments = $('#tblEncashmentBreakdown').datagrid('getRows');
        var nTotalAmount = 0,nTotalAmountBD=0;
        if(oExportBillEncashments.length >0)
        {
            for(var i =0;i<oExportBillEncashments.length;i++)
            {
                nTotalAmount  = nTotalAmount + parseFloat((oExportBillEncashments[i].Amount));
                nTotalAmountBD  = nTotalAmountBD + parseFloat((oExportBillEncashments[i].AmountBC));
            }
        }

        var FooterField=[];
        var obj=new Object();
        obj['CurrencyName'] = "Total:";
        obj['Amount'] = parseFloat(nTotalAmount);
        obj['AmountBC'] = parseFloat(nTotalAmountBD);
        FooterField.push(obj);
        $('#tblEncashmentBreakdown').datagrid('reloadFooter',FooterField);
    }
    $("#btnRemove").click(function(){
        var oExportBillEncashment= $('#tblEncashmentBreakdown').datagrid('getSelected');
        if(oExportBillEncashment===null || parseInt(oExportBillEncashment.ExportBillID)<=0)
        {
            alert("Please select an Item!");                  
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var SelectedRowIndex=$('#tblEncashmentBreakdown').datagrid('getRowIndex',oExportBillEncashment);
        $('#tblEncashmentBreakdown').datagrid('deleteRow',SelectedRowIndex);
        RefreshTotalAmount();
        RefreshAmount();
    });


        
    function ValidateInput()
    {
        debugger;
        var oExportBill = $('#divExportBillEncash').data('ExportBill');        
        if(oExportBill===null || parseInt(oExportBill.ExportBillID)<=0)
        {
            alert("Invalid Export Bill!");
            return;
        }
        
        var sEncashmentDate =  $('#txtEncashmentDate').datebox('getValue');       
        if(sEncashmentDate === null || sEncashmentDate === "")
        {
            alert("Please Enter Encashment Date!");
            $('#txtEncashmentDate').focus()
            return false;
        }

        if(parseInt($('#cboCurrency_Encash').val()) <=0)
        {
            alert("Please Select Encash Currency!");
            $('#cboCurrency_Encash').focus()
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtCRate_Encash').val())) <=0)
        {
            alert("Please Enter Encash Rate!");
            $('#txtCRate_Encash').focus()
            return false;
        }

        if(parseFloat(icsRemoveComma($('#txtEncashAmountBC').val())) <=0)
        {
            alert("Please Enter Encash Amount!");
            $('#txtEncashAmountBC').focus()
            return false;
        }

        if(parseInt($('#cboExpCurrency').val())>0)
        {
            if(parseFloat(icsRemoveComma($('#txtExpAmountBC').val())) <=0)
            {
                alert("Please Enter Exp Amount!");
                $('#txtExpAmountBC').focus()
                return false;
            }
        }

        if(parseFloat(icsRemoveComma($('#txtExpAmount').val()))>0)
        {
            if(parseInt($('#cboExpCurrency').val())<=0)
            {
                alert("Please Select Exp Currency!");
                $('#cboExpCurrency').focus()
                return false;
            }
        }

        var nBillAmountBC = icsRemoveComma($('#txtBillAmountBCSt').val());
        var nEncashAmountBC = icsRemoveComma($('#txtEncashAmountBC').val());
        var nOverDueAmountBDT= icsRemoveComma($('#txtOverDueAmountBDT').val());
        var nExpAmountBC = icsRemoveComma($('#txtExpAmountBC').val());
        var nCRateEncash=icsRemoveComma($('#txtCRate_Encash').val());
        var nDisCountAdjRate=icsRemoveComma($('#txtDisCountAdjRate').val());
        var nDisCountAmount=icsRemoveComma($('#txtDisCountAdjAmount').val());
        var nDisCountAmountBD=icsRemoveComma($('#txtDisCountAdjAmountBD').val());

        var nBalanceAmount = 0;
        var nTotalPaidLoanAmount = 0;
        var nTotalPaidLoanAmountBC = 0;        
        var nTotalAccountsAmount = 0;
        var nTotalExpenditureAmount =0;        
        var oLoans = $("#tblLoan").datagrid("getRows");
        var oEncashmentBreakdowns = $("#tblEncashmentBreakdown").datagrid("getRows");       
        for(var i=0; i<oEncashmentBreakdowns.length; i++)
        {
            nTotalAccountsAmount =  nTotalAccountsAmount + parseFloat(parseFloat(oEncashmentBreakdowns[i].AmountBC).toFixed(2));
        }
        for(var i=0; i<oLoans.length; i++)
        {            
            nTotalPaidLoanAmount = nTotalPaidLoanAmount + parseFloat(parseFloat(oLoans[i].Amount).toFixed(2));
            nTotalPaidLoanAmountBC = nTotalPaidLoanAmountBC + parseFloat(parseFloat(oLoans[i].AmountBC).toFixed(2));            
        }
        var nDisCountAdjGainLoss = icsRemoveComma($('#txtDisCountAdjGainLoss').val()); 
        var bCheckDisGainLoss = $('#txtDisCountAdjGainLoss').data("DiscountGainLoss");
        if(bCheckDisGainLoss == true)
        {
            nDisCountAdjGainLoss = (parseFloat(nDisCountAdjGainLoss) * (-1));
        }
        nBalanceAmount = parseFloat(((parseFloat(nEncashAmountBC) + parseFloat(nOverDueAmountBDT) + parseFloat(nExpAmountBC) ) - (parseFloat(nTotalAccountsAmount) + parseFloat(nDisCountAmountBD) + parseFloat(nTotalPaidLoanAmountBC))+ parseFloat(nDisCountAdjGainLoss)).toFixed(2));       

        if(nBalanceAmount<0)
        {
            nBalanceAmount = (nBalanceAmount * (-1));            
        }
        if(parseFloat(nBalanceAmount) > 0.001)
        {
            alert("Encash Amount & distribution amount not same!");            
            return false;
        }       
        return true;
    }

    function RefreshObject()
    {
        var oExportBill = $('#divExportBillEncash').data('ExportBill');
        var oEncashmentBreakdowns = $("#tblEncashmentBreakdown").datagrid("getRows"); 
        var oLoans = $("#tblLoan").datagrid("getRows");
        for (var i = 0; i < oLoans.length; i++)
        {
            oEncashmentBreakdowns.push(oLoans[i]);
        }        
        var oExportBill = {
            ExportBillID: parseInt(oExportBill.ExportBillID),
            EncashmentDate: $('#txtEncashmentDate').datebox('getValue'),
            EncashCurrencyID : parseInt($('#cboCurrency_Encash').val()),
            EncashCRate : parseFloat(icsRemoveComma($('#txtCRate_Encash').val())),
            EncashAmountBC : parseFloat(icsRemoveComma($('#txtEncashAmountBC').val())),
            OverDueAmount: parseFloat($("#txtOverDueAmount").val()),
            ExpBankAccountID : parseInt($('#cboExpBankAccount').val()),
            ExpCurrencyID : parseInt($('#cboExpCurrency').val()),
            ExpAmount : parseFloat(icsRemoveComma($('#txtExpAmount').val())),
            ExpCRate : parseFloat(icsRemoveComma($('#txtExpCRate').val())),
            ExpAmountBC : parseFloat(icsRemoveComma($('#txtExpAmountBC').val())),
            EncashRemarks : $('#txtNote_Encashment').val(),
            DiscountAdjAmount : parseFloat(icsRemoveComma($('#txtDisCountAdjAmount').val())),
            DiscountAdjCRate : parseFloat(icsRemoveComma($('#txtDisCountAdjRate').val())),
            DiscountAdjAmountBC : parseFloat(icsRemoveComma($('#txtDisCountAdjAmountBD').val())),
            DiscountAdjGainLossBC : parseFloat(icsRemoveComma($('#txtDisCountAdjGainLoss').val())),
            DiscountAdjIsGain : $('#txtDisCountAdjGainLoss').data("DiscountGainLoss"),
            ExportBillEncashments : oEncashmentBreakdowns
        };
        return oExportBill;
    }

    $("#btnSave").click(function (){
        if(!ValidateInput()) return;
        if (!confirm("Can't rollback this operation are you sure for commit?")) return ;
        var oExportBill=RefreshObject();
        $.ajax({
            type: "POST",
            dataType: "json",
            url : sessionStorage.getItem('BaseAddress') +"/ExportBill/SaveEncashmentRecived",
            traditional: true,
            data:  JSON.stringify(oExportBill),
            contentType: "application/json; charset=utf-8",
            success: function (data) {                
                var oExportBill = jQuery.parseJSON(data);
                if (oExportBill.ErrorMessage=="" || oExportBill.ErrorMessage==null)
                {                   
                    alert("Data Save Succesfully!!");
                    var oExportBills =sessionStorage.getItem("ExportBills");
                    var nIndex= parseInt(sessionStorage.getItem("SelectedRowIndex"));
                    
                    if(oExportBills!=null)
                    {
                        oExportBills = jQuery.parseJSON(oExportBills);
                    }
                    else
                    {
                        oExportBills=[];
                    }
                    if(nIndex!=-1)
                    {
                        oExportBills[nIndex]=oExportBill;
                    }
                    else
                    {
                        sessionStorage.setItem("SelectedRowIndex", oExportBills.length);
                        oExportBills.push(oExportBill);
                    }
                    sessionStorage.setItem("ExportBills", JSON.stringify(oExportBills));
                    window.location.href = sessionStorage.getItem("BackLink");
                }
                else
                {
                    alert(oExportBill.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });
    });

    $('#btnClose').click(function(e){
        window.location.href = sessionStorage.getItem("BackLink");
    });

   

    //Start Loan Settlement
    $('#btnLoanSettlement').click(function(e){
        LoanRestControls();        
        var oExportBill = $('#divExportBillEncash').data('ExportBill');        
        var oExportBillEncashment = {
            ExportBillEncashmentID : 0,
            ExportBillID : parseInt(oExportBill.ExportBillID),
            AccountHeadID : 0,
            ExpenditureHeadID : 0,
            ExportLCID : parseInt(oExportBill.ExportLCID),
            ExportLCNo : oExportBill.ExportLCNo
        };
        $("#winLoanInstallment").data('SelectedIndex', -1);        
        $("#winLoanInstallment").data('ExportBillEncashment', oExportBillEncashment);
        $("#btnSaveLoanSettlement").show();
        $("#winLoanInstallment").icsWindow('open');        
    });

    $('#btnLoanEdit').click(function(e){
        var oExportBillEncashment = $("#tblLoan").datagrid("getSelected");
        if(oExportBillEncashment === null ||     parseInt(oExportBillEncashment.LoanID)<=0)
        {
            alert("Please Select an Item From List!");            
            return;
        }
        var nSelectedIndex  = $("#tblLoan").datagrid("getRowIndex", oExportBillEncashment);
        $("#winLoanInstallment").data('SelectedIndex', nSelectedIndex);
        $("#winLoanInstallment").data('ExportBillEncashment', oExportBillEncashment);
        $('#winLoanInstallment').data('LoanInstallment', oExportBillEncashment.LoanInstallment);
        LoanRestControls();
        LoanRefreshControls();     
        $("#btnSaveLoanSettlement").show();
        $("#winLoanInstallment").icsWindow('open');        
    });

    $('#btnLoanView').click(function(e){
        var oExportBillEncashment = $("#tblLoan").datagrid("getSelected");
        if(oExportBillEncashment === null ||     parseInt(oExportBillEncashment.LoanID)<=0)
        {
            alert("Please Select an Item From List!");            
            return;
        }
        var nSelectedIndex  = $("#tblLoan").datagrid("getRowIndex", oExportBillEncashment);
        $("#winLoanInstallment").data('SelectedIndex', nSelectedIndex);
        $("#winLoanInstallment").data('ExportBillEncashment', oExportBillEncashment);
        $('#winLoanInstallment').data('LoanInstallment', oExportBillEncashment.LoanInstallment);
        LoanRestControls();
        LoanRefreshControls();   
        $("#btnSaveLoanSettlement").hide();        
        $("#winLoanInstallment").icsWindow('open');        
    });

    $('#btnRemoveSettlement').click(function(e){
        var oExportBillEncashment = $("#tblLoan").datagrid("getSelected");
        if(oExportBillEncashment === null ||     parseInt(oExportBillEncashment.LoanID)<=0)
        {
            alert("Please Select an Item From List!");            
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblLoan").datagrid("getRowIndex", oExportBillEncashment);
        $("#tblLoan").datagrid("deleteRow", nSelectedIndex);
        RefreshAmount();
    });

    $('#btnLoanClear').click(function(e){
        LoanRestControls();              
    });

    function LoanRestControls()
    {       
        RefreshLoanComboBox();
        $("#txtLoanFileNo").val("");
        $("#txtLoanType").val("");
        $("#txtLoanNumber").val("");
        $("#txtLoanIssueDate").val("");

        $("#txtLoanStartDate").val("");
        $("#txtLoanExportLC").val("");
        $("#txtLoanAccountNo").val("");   
        $("#txtLoanAmountCurrency").val("");
        $("#txtLoanAmount").val("0.00");

        $("#cboLoanTransfer").val("");
        $('#txtTransferDate').datebox('setValue', "");
        $("#txtTransferInterestDays").val("0");
        $("#txtLoanTransferInterestRate").val("0.00");
        $("#txtTransferInterestCurrency").val("");
        $("#txtTransferInterest").val("0.00");

        $("#txtLoanInterestRate").val(0.00);
        $('#txtSettlementDate').datebox('setValue', "");
        $("#txtInterestDays").val(0);
        $("#txtLoanInterestAmountCurrency").val("");
        $("#txtLoanInterestAmount").val("0.00");
        $("#txtTotalInterestAmountCurrency").val("");
        $("#txtTotalInterestAmount").val("0.00");
        
        $("#txtApproxStlmtDate").val("");
        $("#txtLoanPrincipleAmountCurrency").val("");
        $("#txtLoanPrincipleAmount").val("0.00");
        $("#txtLoanTotalChargeCurrency").val("");
        $("#txtLoanTotalCharge").val("0.00");
        $("#txtLoanStlmtRemarks").val("");
        
        $("#txtDiscountPaidAmount").val("0.00");
        $("#txtDiscountRcvAmount").val("0.00");
        $("#txtTotalPayableAmountCurrency").val("");
        $("#txtTotalPayableAmount").val("0.00");    
        $("#txtLoanPaidAmountCurrency").val("");
        $("#txtLoanPaidAmount").val("0.00");

        $("#txtPaymentCRate").val("0.00");
        $("#txtLoanChargeCRate").val("0.00");
        $("#txtPaymentCRate").prop("disabled", false);
        $("#txtLoanChargeCRate").prop("disabled", false);

        $("#cboChargeCurSymbol").prop("disabled", false);
        $("#cboPaymentCurrencySymbol").prop("disabled", false);
        
        DynamicRefreshList([], "tblLoanCharge");
        DynamicRefreshList([], "tblPayment");
        RefreshLoanSummery();
    }

    function LoanRefreshControls()
    {
        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var oCompany = $('#divExportBillEncash').data('Company');
        RefreshLoanComboBox();
        $("#txtLoanFileNo").val(oLoanInstallment.FileNo);
        $("#txtLoanType").val(oLoanInstallment.LoanTypeSt);
        $("#txtLoanNumber").val(oLoanInstallment.LoanNo);
        $("#txtLoanIssueDate").val(oLoanInstallment.IssueDateSt);

        $("#txtLoanStartDate").val(oLoanInstallment.InstallmentStartDateInString);
        $("#txtLoanExportLC").val(oLoanInstallment.LoanRefNo);
        $("#txtLoanAccountNo").val(oLoanInstallment.BankAccNo);   
        $("#txtLoanAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtLoanAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.PrincipalAmount), null, 2));

        $("#cboLoanTransfer").val(parseInt(oLoanInstallment.LoanTransferTypeInt));
        $('#txtTransferDate').datebox('setValue', oLoanInstallment.TransferDateInString);
        $("#txtTransferInterestDays").val(oLoanInstallment.TransferDays);
        $("#txtLoanTransferInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.TransferInterestRate), null, 4));
        $("#txtTransferInterestCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtTransferInterest").val(icsFormatPrice(parseFloat(oLoanInstallment.TransferInterestAmount), null, 2));

        $("#txtLoanInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestRate), null, 4));
        $('#txtSettlementDate').datebox('setValue', oLoanInstallment.SettlementDateInString);
        $("#txtInterestDays").val(oLoanInstallment.InterestDays);
        $("#txtLoanInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtLoanInterestAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestAmount), null, 2));
        $("#txtTotalInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtTotalInterestAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.TotalInterestAmount), null, 2));
        
        $("#txtApproxStlmtDate").val(oLoanInstallment.ApproxSettlementSt);
        $("#txtLoanPrincipleAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtLoanPrincipleAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.LoanPrincipalAmount), null, 2));
        $("#txtLoanPrincipleAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtLoanTotalCharge").val(icsFormatPrice(parseFloat(oLoanInstallment.ChargeAmount), null, 2));        
        $("#txtLoanStlmtRemarks").val(oLoanInstallment.Remarks);


        $("#txtDiscountPaidAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.DiscountPaidAmount), null, 2));
        $("#txtDiscountRcvAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.DiscountRcvAmount), null, 2));
        $("#txtTotalPayableAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtTotalPayableAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.TotalPayableAmount), null, 2));
        $("#txtLoanPaidAmountCurrency").val(oLoanInstallment.LoanCurency);
        $("#txtLoanPaidAmount").val(icsFormatPrice(parseFloat(oLoanInstallment.PaidAmount), null, 2));


        $("#cboChargeCurSymbol").val(oLoanInstallment.LoanCurencyID);
        $("#cboPaymentCurrencySymbol").val(oLoanInstallment.LoanCurencyID);
        $("#cboChargeCurSymbol,#cboPaymentCurrencySymbol").prop("disabled", true);

        if(parseInt(oCompany.BaseCurrencyID) === parseInt(oLoanInstallment.LoanCurencyID))
        {
            $("#txtPaymentCRate").val("1.00");
            $("#txtLoanChargeCRate").val("1.00");
            
            $("#txtPaymentCRate").prop("disabled", true);
            $("#txtLoanChargeCRate").prop("disabled", true);            
        }
        else
        {
            $("#txtPaymentCRate").val("0.00");
            $("#txtLoanChargeCRate").val("0.00");
            
            $("#txtPaymentCRate").prop("disabled", false);
            $("#txtLoanChargeCRate").prop("disabled", false);
        }
        
        DynamicRefreshList(oLoanInstallment.LoanchargeList, "tblLoanCharge");
        DynamicRefreshList(oLoanInstallment.PaymentList, "tblPayment");
        RefreshLoanSummery();
    }

    function RefreshLoanComboBox()
    {   
        var oCurrencys = $('#divExportBillEncash').data('Currencys');
        var oBankAccounts = $('#divExportBillEncash').data('BankAccounts');
        var oExpenditureHeads = $('#divExportBillEncash').data('ExpenditureHeads');
        var oTrnasferTypes = $('#divExportBillEncash').data('TrnasferTypes');

        $("#cboBankAC").icsLoadCombo({List: oBankAccounts, OptionValue:"BankAccountID",DisplayText: "AccountNo", InitialValue:"--Bank A/C--" });
        $("#cboExpenseHead").icsLoadCombo({List: oExpenditureHeads, OptionValue:"AccountHeadID",DisplayText: "AccountHeadName", InitialValue:"--Expense Head--"});        
        $("#cboChargeCurSymbol").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "Symbol", InitialValue:"--Currency--"});
        $("#cboPaymentCurrencySymbol").icsLoadCombo({List: oCurrencys, OptionValue:"CurrencyID",DisplayText: "Symbol", InitialValue:"--Currency--"});
        $("#cboLoanTransfer").icsLoadCombo({List: oTrnasferTypes, OptionValue:"id",DisplayText: "Value", InitialValue:"--Loan Transfer--"});
    }

    function RefreshLoanSummery()
    {
        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        if(oLoanInstallment != null && oLoanInstallment != undefined)
        {
            var oPayments = $("#tblPayment").datagrid("getRows"); 
            var oLoanCharges = $("#tblLoanCharge").datagrid("getRows");
            var nPaymentBC = 0; var nPayment =0;
            var nLoanChargeBC = 0; var nLoanCharge =0;            
            var nLoanTransferInterestAmount =0;
            var nLoanInterestAmount =0;
            var nTotalInterestAmount =0;
            var nTotalPayableAmount = 0;
            var nLoanTransferType = parseInt($('#cboLoanTransfer').val());
            var dLoanStartDate = new Date(oLoanInstallment.InstallmentStartDateInString);
            if(nLoanTransferType != 0)
            {                
                var dtxtTransferDate = new Date($('#txtTransferDate').datebox('getValue'));
                var nLoanTransferDays = parseInt((dtxtTransferDate - dLoanStartDate)/(1000 * 60 * 60 * 24));
                $("#txtTransferInterestDays").val(parseInt(nLoanTransferDays));
                var nLoanTransferInterestRate = parseFloat(icsRemoveComma($("#txtLoanTransferInterestRate").val()));
                nLoanTransferInterestAmount = ((((parseFloat(oLoanInstallment.PrincipalAmount) * parseFloat(nLoanTransferInterestRate))/100.00) / 360.00) * parseFloat(nLoanTransferDays));
                $("#txtTransferInterest").val(oLoanInstallment.LoanCurency+ " "+  icsFormatPrice(parseFloat(nLoanTransferInterestAmount), null, 2));
                dLoanStartDate = new Date($('#txtTransferDate').datebox('getValue'));
            }
            var dSettlementDate = new Date($('#txtSettlementDate').datebox('getValue'));
            var nLoanDays = parseInt((dSettlementDate - dLoanStartDate)/(1000 * 60 * 60 * 24));
            var nInterestRate = parseFloat(icsRemoveComma($("#txtLoanInterestRate").val()));
            nLoanInterestAmount = ((((parseFloat(oLoanInstallment.PrincipalAmount) * parseFloat(nInterestRate))/100.00) / 360.00) * parseFloat(nLoanDays));
            nTotalInterestAmount = (nLoanTransferInterestAmount + nLoanInterestAmount);
            for(var i=0; i < oLoanCharges.length; i++)
            {
                nLoanChargeBC = nLoanChargeBC + parseFloat(oLoanCharges[i].AmountBC);
                nLoanCharge = nLoanCharge + parseFloat(oLoanCharges[i].Amount);
            }
        
            for(var i=0; i < oPayments.length; i++)
            {
                nPaymentBC = nPaymentBC + parseFloat(oPayments[i].AmountBC);
                nPayment = nPayment + parseFloat(oPayments[i].Amount);
            }

            var nDiscountPaidAmount = parseFloat(icsRemoveComma($("#txtDiscountPaidAmount").val()));
            var nDiscountRcvAmount = parseFloat(icsRemoveComma($("#txtDiscountRcvAmount").val()));
            nTotalPayableAmount = (parseFloat(oLoanInstallment.PrincipalAmount) + parseFloat(nTotalInterestAmount) + parseFloat(nLoanCharge) + parseFloat(nDiscountPaidAmount) - parseFloat(nDiscountRcvAmount));            
            $("#txtInterestDays").val(parseInt(nLoanDays));            
            $("#txtLoanInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtLoanInterestAmount").val(icsFormatPrice(parseFloat(nLoanInterestAmount), null, 2));
            $("#txtTotalInterestAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtTotalInterestAmount").val(icsFormatPrice(parseFloat(nTotalInterestAmount), null, 2));
            $("#txtTotalPayableAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtTotalPayableAmount").val(icsFormatPrice(parseFloat(nTotalPayableAmount), null, 2));

            var FooterField=[];
            var obj=new Object();        
            obj['AccountName'] = "Grand Total:";
            obj['Amount'] = parseFloat(parseFloat(nLoanCharge).toFixed(2));
            obj['AmountBC'] = parseFloat(parseFloat(nLoanChargeBC).toFixed(2));
            FooterField.push(obj);
            $('#tblLoanCharge').datagrid('reloadFooter',FooterField);
            $("#txtLoanTotalChargeCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtLoanTotalCharge").val(icsFormatPrice(parseFloat(nLoanCharge), null, 2));
        
            var FooterFieldPmt = [];
            var objPmt =new Object();        
            objPmt['AccountName']="Grand Total:";
            objPmt['Amount'] = parseFloat(parseFloat(nPayment).toFixed(2));
            objPmt['AmountBC'] = parseFloat(parseFloat(nPaymentBC).toFixed(2));
            FooterFieldPmt.push(objPmt);
            $('#tblPayment').datagrid('reloadFooter',FooterFieldPmt);
            $("#txtLoanPaidAmountCurrency").val(oLoanInstallment.LoanCurency);
            $("#txtLoanPaidAmount").val(icsFormatPrice(parseFloat(nPayment), null, 2));
            $("#txtLoanPaidAmount").data('PaymentBC', parseFloat(nPaymentBC));

            var nBalanceAmount = (parseFloat(nTotalPayableAmount)  - parseFloat(nPayment));
            if(nBalanceAmount>=0)
            {
                $("#lblLoanBalance").text("Balance : "+oLoanInstallment.LoanCurency+" "+ icsFormatPrice(parseFloat(nBalanceAmount), null, 2)); 
            }
            else
            {
                nBalanceAmount = (nBalanceAmount * (-1));
                $("#lblLoanBalance").text("Balance : "+oLoanInstallment.LoanCurency+" ("+ icsFormatPrice(parseFloat(nBalanceAmount), null, 2)+ ")"); 
            }
        }
    }

    function RefreshObjectLoanInstallment()
    {
        var oTempLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var oLoanInstallment = {
            LoanInstallmentID : parseInt(oTempLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oTempLoanInstallment.LoanID),
            InstallmentNo : oTempLoanInstallment.InstallmentNo,
            InstallmentStartDate : oTempLoanInstallment.InstallmentStartDateInString,
            InstallmentStartDateInString : oTempLoanInstallment.InstallmentStartDateInString,
            InstallmentDate : $('#txtSettlementDate').datebox('getValue'),
            InstallmentDateInString : $('#txtSettlementDate').datebox('getValue'),
            PrincipalAmount : parseFloat(oTempLoanInstallment.PrincipalAmount),
            LoanTransferType : parseInt($('#cboLoanTransfer').val()),
            LoanTransferTypeInt : parseInt($('#cboLoanTransfer').val()),
            TransferDate : $('#txtTransferDate').datebox('getValue'),
            TransferDateInString : $('#txtTransferDate').datebox('getValue'),
            TransferDays : parseInt($("#txtTransferInterestDays").val()),
            TransferInterestRate : parseFloat(icsRemoveComma($("#txtLoanTransferInterestRate").val())),
            TransferInterestAmount : parseFloat(icsRemoveComma($("#txtTransferInterest").val())),
            SettlementDate : $('#txtSettlementDate').datebox('getValue'),
            SettlementDateInString : $('#txtSettlementDate').datebox('getValue'),
            InterestDays : parseInt($("#txtInterestDays").val()),
            InterestRate : parseFloat(icsRemoveComma($("#txtLoanInterestRate").val())),
            InterestAmount : parseFloat(icsRemoveComma($("#txtLoanInterestAmount").val())),
            LiborRate : (0.00),
            LiborInterestAmount : (0.00),
            TotalInterestAmount : parseFloat(icsRemoveComma($("#txtTotalInterestAmount").val())),
            ChargeAmount : parseFloat(icsRemoveComma($("#txtLoanTotalCharge").val())),
            DiscountPaidAmount : parseFloat(icsRemoveComma($("#txtDiscountPaidAmount").val())),
            DiscountRcvAmount : parseFloat(icsRemoveComma($("#txtDiscountRcvAmount").val())),
            TotalPayableAmount : parseFloat(icsRemoveComma($("#txtTotalPayableAmount").val())),
            PaidAmount : parseFloat(icsRemoveComma($("#txtLoanPaidAmount").val())),
            PaidAmountBC : parseFloat(parseFloat($("#txtLoanPaidAmount").data('PaymentBC')).toFixed(2)),
            PrincipalDeduct : (0.00),
            PrincipalBalance : (0.00),
            Remarks : $('#txtLoanStlmtRemarks').val(),
            SettlementBy : parseInt(oTempLoanInstallment.SettlementBy),
            SettlementByName : oTempLoanInstallment.SettlementByName,
            FileNo : oTempLoanInstallment.FileNo,
            LoanNo : oTempLoanInstallment.LoanNo,
            LoanRefType : parseInt(oTempLoanInstallment.LoanRefType),
            LoanCRate : parseFloat(oTempLoanInstallment.LoanCRate),
            LoanPrincipalAmount : parseFloat(oTempLoanInstallment.LoanPrincipalAmount),
            LoanRefID : parseInt(oTempLoanInstallment.LoanRefID),
            LoanRefNo : oTempLoanInstallment.LoanRefNo,
            LoanType : (oTempLoanInstallment.LoanType),
            LoanTypeSt : oTempLoanInstallment.LoanTypeSt,
            ApproxSettlement : oTempLoanInstallment.ApproxSettlementSt,
            ApproxSettlementSt : oTempLoanInstallment.ApproxSettlementSt,
            IssueDate : oTempLoanInstallment.IssueDateSt,
            IssueDateSt : oTempLoanInstallment.IssueDateSt,
            BankAccNo : oTempLoanInstallment.BankAccNo,
            LoanCurencyID : parseInt(oTempLoanInstallment.LoanCurencyID),
            LoanCurency : oTempLoanInstallment.LoanCurency,            
            LoanchargeList : $("#tblLoanCharge").datagrid("getRows"),
            PaymentList : $("#tblPayment").datagrid("getRows")
        }

        
        var nPaidAmount = parseFloat(oLoanInstallment.PaidAmount);
        var nPaidAmountBC = parseFloat(oLoanInstallment.PaidAmountBC);
        var nCRate = 1.00;
        if(nPaidAmount > 0 && nPaidAmountBC > 0)
        {
            nCRate = parseFloat((parseFloat(nPaidAmountBC) / parseFloat(nPaidAmount)).toFixed(4));
        }
        else
        {
            nCRate = 1.00;
            nPaidAmount= 0.00;
            nPaidAmountBC = 0.00;
        }
        var oCompany = $('#divExportBillEncash').data('Company');
        var oTempExportBillEncashment = $("#winLoanInstallment").data('ExportBillEncashment');
        var oExportBillEncashment = {
            ExportBillEncashmentID : parseInt(oTempExportBillEncashment.ExportBillEncashmentID),
            ExportBillID : parseInt(oTempExportBillEncashment.ExportBillID),
            AccountHeadID : parseInt(oTempExportBillEncashment.AccountHeadID),
            ExpenditureHeadID : parseInt(oTempExportBillEncashment.ExpenditureHeadID),
            LoanInstallmentID : parseInt(oLoanInstallment.LoanInstallmentID),
            CurrencyID : parseInt(oLoanInstallment.LoanCurencyID),
            CCRate : parseFloat(nCRate),
            Amount : parseFloat(nPaidAmount),
            AmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(nPaidAmount), null, 2),
            AmountBC : parseFloat(nPaidAmountBC),
            AmountBCSt : oCompany.CurrencySymbol + " "+ icsFormatPrice(parseFloat(nPaidAmountBC), null, 2),
            AccountNo : "",
            AccountName : "",
            BankName : "",
            BranchName : "",
            CurrencyName : oLoanInstallment.LoanCurency,
            Currency : oLoanInstallment.LoanCurency,
            ExpenditureName : "",
            ExportLCID : parseInt(oTempExportBillEncashment.ExportLCID),
            ExportLCNo : oTempExportBillEncashment.ExportLCNo,
            LoanNo : oLoanInstallment.LoanNo,
            LoanRefType : parseInt(0),
            LoanLCID : parseInt(oLoanInstallment.LoanRefID),            
            LoanCurencyID : parseInt(oLoanInstallment.LoanCurencyID),
            LoanID : parseInt(oLoanInstallment.LoanID),
            LoanCurency : oLoanInstallment.LoanCurency,
            PrincipalAmount : parseFloat(oLoanInstallment.LoanPrincipalAmount),    
            PrincipalAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.LoanPrincipalAmount), null, 2),
            InstallmentPrincipalAmount : parseFloat(oLoanInstallment.PrincipalAmount), 
            InstallmentPrincipalAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.PrincipalAmount), null, 2),
            TotalInterestAmount : parseFloat(oLoanInstallment.TotalInterestAmount),
            TotalInterestAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.TotalInterestAmount), null, 2),
            ChargeAmount : parseFloat(oLoanInstallment.ChargeAmount),
            ChargeAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.ChargeAmount), null, 2),
            DiscountPaidAmount : parseFloat(oLoanInstallment.DiscountPaidAmount),
            DiscountPaidAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.DiscountPaidAmount), null, 2),
            DiscountRcvAmount : parseFloat(oLoanInstallment.DiscountRcvAmount),
            DiscountRcvAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.DiscountRcvAmount), null, 2),
            TotalPayableAmount : parseFloat(oLoanInstallment.TotalPayableAmount),   
            TotalPayableAmountSt : oLoanInstallment.LoanCurency + " "+ icsFormatPrice(parseFloat(oLoanInstallment.TotalPayableAmount), null, 2),
            LoanLCNo : oLoanInstallment.LoanRefNo,
            LoanInstallment : oLoanInstallment
        }        
        return oExportBillEncashment;
    }

    function ValidateLoanInstallment()
    {
        var oTempLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        if(oTempLoanInstallment === undefined || oTempLoanInstallment === null || parseInt(oTempLoanInstallment.LoanID)<=0)
        {
            alert("Invalid Loan! Please Try Again!");
            return false;
        }

        var sSettlementDate = $('#txtSettlementDate').datebox('getValue');
        if(sSettlementDate === null || sSettlementDate === "")
        {
            alert("Please Select Loan Settlement Date!!");
            return false;
        }

        if(parseInt($('#cboLoanTransfer').val())!=0)
        {
            var sTransferDate = $('#txtTransferDate').datebox('getValue');
            if(sTransferDate === null || sTransferDate === "")
            {
                alert("Please Select Loan Transfer Date!!");
                return false;
            }
            if(parseInt($("#txtTransferInterestDays").val())<0)
            {
                alert("Invalid Transfer Days Count!!");
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtLoanTransferInterestRate").val()))<=0)
            {
                alert("Please Enter Transfer Interest Rate!!");
                $('#txtLoanTransferInterestRate').focus();
                return false;
            }
            if(parseFloat(icsRemoveComma($("#txtTransferInterest").val()))<0)
            {
                alert("Please Enter Transfer Interest Amount!!");
                $('#txtLoanTransferInterestRate').focus();
                return false;
            }
        }
        if(parseInt($("#txtInterestDays").val())<0)
        {
            alert("Invalid Interest Days Count!!");
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtLoanInterestRate").val()))<=0)
        {
            alert("Please Enter Interest Rate!!");
            $('#txtLoanInterestRate').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtLoanInterestAmount").val()))<0)
        {
            alert("Please Enter Interest Amount!!");
            $('#txtLoanInterestAmount').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtTotalInterestAmount").val()))<0)
        {
            alert("Please Enter Total Interest Amount!!");
            $('#txtTotalInterestAmount').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtTotalPayableAmount").val()))<=0)
        {
            alert("Invalid Total Payable Amount!!");
            $('#txtTotalPayableAmount').focus();
            return false;
        }
        if(parseFloat(icsRemoveComma($("#txtLoanPaidAmount").val()))<=0)
        {
            alert("Please Enter Paid Amount!!");
            $('#txtLoanPaidAmount').focus();
            return false;
        }
        return true;
    }

    $("#btnSaveLoanSettlement").click(function (){
        if(!ValidateLoanInstallment()) return;
        var oExportBillEncashment = RefreshObjectLoanInstallment();
        var nSelectedIndex =  parseInt($("#winLoanInstallment").data('SelectedIndex'));
        if(nSelectedIndex<0)
        {
            $('#tblLoan').datagrid('appendRow', oExportBillEncashment);
        }
        else
        {
            $('#tblLoan').datagrid('updateRow',{ index: nSelectedIndex, row: oExportBillEncashment });
        }       
        RefreshAmount();
        $("#winLoanInstallment").icsWindow('close');        
    });

    $("#btnCloseLoan").click(function (){
        $("#winLoanInstallment").icsWindow('close');        
    });
    $("#txtAccountHead").keydown(function (e) {

        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtAccountHead').val())===null || $.trim($('#txtAccountHead').val())==="")
            {
                alert("Press enter with AccountHead Name/Code");
                return;
            }
           
            PickAccountHead();
        }
        if (code == 8) //backspace=8
        {            
            $("#txtAccountHead").removeClass("fontColorOfPickItem");
            $('#txtAccountHead').data('AccountHead', null);
            $('#txtSubledger').val("");
            $('#txtSubledger').data('Subledger', null);
            $("#txtSubledger").removeClass("fontColorOfPickItem");
        }
    });
    $("#btnPickAccountHead").click(function () {
        PickAccountHead();
    });
    $("#btnClearAccountHead").click(function () {
        $('#txtAccountHead').val("");
        $("#txtAccountHead").removeClass("fontColorOfPickItem");
        $('#txtAccountHead').data('AccountHead',null);
        $('#txtSubledger').val("");
        $('#txtSubledger').data('Subledger', null);
        $("#txtSubledger").removeClass("fontColorOfPickItem");
    });
    function PickAccountHead()
    {
        $('#txtAccountHead').data('AccountHead', null);
        $('#txtSubledger').data('Subledger', null);

        var oTempExportBill = $('#divExportBillEncash').data('ExportBill');
        var oChartsOfAccount = {
            BusinessUnitID:  parseInt(oTempExportBill.BUID),
            AccountHeadCodeName:$.trim($("#txtAccountHead").val())
        };


        debugger;
        var obj = {
            BaseAddress:sessionStorage.getItem("BaseAddress"),
            Object: (oChartsOfAccount) ,
            ControllerName: "Voucher",
            ActionName: "GetsByCodeOrNameForExportEncashment",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: 'AccountCode', name: 'Account Code',title: 'Account Code',width: '15%'  };tblColums.push(oColumn);
        oColumn = { field: 'AccountHeadName', title: 'AccountHeadName',width: '40%', enableSorting: false  };tblColums.push(oColumn);
        oColumn = { field: 'AccountTypeInString', title: 'AccountType',width: '20%', enableSorting: false  };tblColums.push(oColumn);
        oColumn = { field: "ParentHeadName", title: "Parent Head", width: '25%', align: "left" }; tblColums.push(oColumn);
        DynamicPiker('AccountHead',obj,tblColums,false,'AccountHeadName','AccountHeadID',600); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }

    $("#txtSubledger").keydown(function (e) {
        $('#txtSubledger').data('Subledger', null);
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) // Enter Press
        {
            if($.trim($('#txtSubledger').val())===null || $.trim($('#txtSubledger').val())==="")
            {
                alert("Press enter with Subledger Name/Code");
                return;
            }
            PickSubledger();
        }
        if (code == 8) //backspace=8
        {           
            $("#txtSubledger").removeClass("fontColorOfPickItem");
            $('#txtSubledger').data('Subledger', null);
        }
    });
    $("#btnPickSubledger").click(function () {
        PickSubledger();
    });
    $("#btnClearSubledger").click(function () {
        $('#txtSubledger').val("");
        $("#txtSubledger").removeClass("fontColorOfPickItem");
        $('#txtSubledger').data('Subledger',null);
    });
    function PickSubledger()
    {

        debugger;
        $('#txtSubledger').data('Subledger', null);
        var oTempExportBill = $('#divExportBillEncash').data('ExportBill');
        var oAccountHead= $('#txtAccountHead').data('AccountHead');
        if(oAccountHead==null)
        {
            alert("Please Pick Account Head first");
            return;
        }
        var oACCostCenter = {
            BUID:  parseInt(oTempExportBill.BUID),
            NameCode:$.trim($("#txtSubledger").val()),
            AccountHeadID:parseInt(oAccountHead.AccountHeadID)

        };


        debugger;
        var obj = {
            BaseAddress:sessionStorage.getItem("BaseAddress"),
            Object: (oACCostCenter) ,
            ControllerName: "ACCostCenter",
            ActionName: "GetsByCodeOrName",
            IsWinClose: false
        };
        var tblColums = []; var oColumn = []; var oColumn = { field: 'Code', name: 'Subledger Code',title: 'Subledger Code',width: '20%'  };tblColums.push(oColumn);
        oColumn = { field: 'Name', title: 'Subledger Name',width: '50%', enableSorting: false  };tblColums.push(oColumn);
        oColumn = { field: 'CategoryName', title: 'SubledgerType',width: '25%', enableSorting: false  };tblColums.push(oColumn);
        //oColumn = { field: "Name", title: "Name", width: 280, align: "left" }; tblColums.push(oColumn);
        DynamicPiker('Subledger',obj,tblColums,false,'Name','ACCostCenterID',400); //pickerName(unique),obj,table,multiReturn,SearchingField, pkID
    }

    function DynamicPiker(pickerName,obj,pTblColums,pMultiReturn,pSearchField,pID,nWidth)
    {
        debugger;
        $.icsDataGets(obj, function (response) {
            debugger;
            if (response.status && response.objs.length > 0) {
                debugger;
                if (response.objs[0][pID] > 0) {
                     debugger;
                    var tblColums = pTblColums;
                    var oPickerParam = {
                        winid: 'win'+pickerName,
                        winclass: 'cls'+pickerName,
                        winwidth: nWidth,
                        winheight: 460,
                        tableid: 'tbl'+pickerName+'s',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: pMultiReturn,
                        searchingbyfieldName: pSearchField,
                        windowTittle: pickerName+' List',
                        colsable:true
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else{
                alert("Data Not Found.");
                return;
            }
        });
    }
    $("#txtLoanNumber").keydown(function (e) {
        if (e.keyCode === 13) // Enter Press
        {
            if($("#txtLoanNumber").val()==null || $("#txtLoanNumber").val()=="")
            {
                alert("Press Enter With Loan/LC Number!");
                return;
            }
            PickLoan($("#txtLoanNumber").val());
        }        
    });

    $("#btnLoanSuggest").click(function (){
        PickLoan("");
    });

    function PickLoan(sLoanNoORLCNo) 
    {
        var oTempExportBill = $('#divExportBillEncash').data('ExportBill');
        if(oTempExportBill === null || parseInt(oTempExportBill.ExportBillID)<=0)
        {
            alert("Inavlid Export Bill!");
            return;
        }
        if(parseInt(oTempExportBill.BUID)<=0)
        {
            alert("Inavlid Business Unit!");
            return;
        }

        var oExportBill = {
            ExportLCID : parseInt(oTempExportBill.ExportLCID),
            BUID : parseInt(oTempExportBill.BUID),
            ExportLCNo : sLoanNoORLCNo
        };

        var obj = {
            BaseAddress: sessionStorage.getItem("BaseAddress"),
            Object: oExportBill,
            ControllerName: "ExportBill",
            ActionName: "GetsPCLoanByLoanNumberORLCNo",
            IsWinClose: false
        };
        $.icsDataGets(obj, function (response) {
            if (response.status && response.objs.length > 0) {
                if ( parseInt(response.objs[0].LoanID) > 0) {
                    var tblColums = []; 
                    var oColumn = { field: "LoanNo", title: "Loan Number", width: 120, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "LoanRefNo", title: "ExportLC Number", width: 150, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "LoanStartDateInString", title: "StartDate", width: 80, align: "left" }; tblColums.push(oColumn);
                    oColumn = { field: "PrincipalAmountSt", title: "Loan Amount", width: 100, align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "TotalInterestAmountSt", title: "Interest Amount", width: 100, align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "TotalChargeAmountSt", title: "Charge Amount", width: 100, align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "PaidAmountSt", title: "Paid Amount", width: 100, align: "right" }; tblColums.push(oColumn);
                    oColumn = { field: "LoanAmountSt", title: "Balance Amount", width: 100, align: "right" }; tblColums.push(oColumn);

                    var oPickerParam = {
                        winid: 'winLoanPicker',
                        winclass: 'clsLoanPicker',
                        winwidth: 900,
                        winheight: 460,
                        tableid: 'tblLoanPickers',
                        tablecolumns: tblColums,
                        datalist: response.objs,
                        multiplereturn: false,
                        searchingbyfieldName: 'LoanRefNo',
                        windowTittle: 'Loan List'
                    };
                    $.icsPicker(oPickerParam);
                    IntializePickerbutton(oPickerParam);
                }
                else {
                    alert(response.objs[0].ErrorMessage);
                }
            }
            else {
                alert("Sorry, No Loan Found.");
            }
        });
    }

    function IntializePickerbutton(oPickerobj) {
        debugger;
        $("#" + oPickerobj.winid).find("#btnOk").click(function () {
            SetPickerValueAssign(oPickerobj);
        });
        $(document).find('.' + oPickerobj.winclass).keydown(function (e) {
            if (e.which === 13) {
                SetPickerValueAssign(oPickerobj);
            }
        });
    }

    function SetPickerValueAssign(oPickerobj) {        
        var oreturnObj = null, oreturnObjs = [];
        if (oPickerobj.multiplereturn) {
            oreturnObjs = $('#' + oPickerobj.tableid).datagrid('getChecked');
        } else {
            oreturnObj = $('#' + oPickerobj.tableid).datagrid('getSelected');
        }


        if (oPickerobj.winid == 'winLoanPicker') {
            if (oreturnObj != null && parseInt(oreturnObj.LoanID) > 0)
            {   
                var oTempLoanInstallment = { 
                                                LoanID : parseInt(oreturnObj.LoanID),
                                                LoanInstallmentID : 0
                                            };

                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url : sessionStorage.getItem('BaseAddress')+  "/ExportBill/GetsPCLoan",
                    traditional: true,
                    data:  JSON.stringify(oTempLoanInstallment),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        oLoanInstallment = jQuery.parseJSON(data);
                        if(oLoanInstallment != null && parseInt(oLoanInstallment.LoanID)>0 && oLoanInstallment.ErrorMessage == "")
                        {
                            $('#winLoanInstallment').data('LoanInstallment', oLoanInstallment);
                            LoanRefreshControls();
                        }
                        else 
                        {
                            alert(oLoanInstallment.ErrorMessage);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                    }
                });

            }
            else
            {
                alert("Please select a Loan from List!");
                return false;
            }
        }
        else if (oPickerobj.winid == 'winAccountHead') 
        {
            SetAccountHead(oreturnObj);
        }
        else if (oPickerobj.winid == 'winSubledger') 
        {
            SetSubledger(oreturnObj);
        }
        $("#" + oPickerobj.winid).icsWindow("close");
        $("#" + oPickerobj.winid).remove();
    }
    function SetAccountHead(oResult){
        $('#txtAccountHead').data('AccountHead',oResult);
        $("#txtAccountHead").val(oResult.AccountHeadName);
        $("#txtAccountHead").addClass("fontColorOfPickItem");
        if(oResult.IsCostCenterApply)
        {
            $('#txtSubledger').focus();
        }
        else{
            $('#txtAmount').focus();
        }
    }
    function SetSubledger(oResult){
        $('#txtSubledger').data('Subledger',oResult);
        $("#txtSubledger").val(oResult.Name);
        $("#txtSubledger").addClass("fontColorOfPickItem");
    }
    $('#txtSettlementDate,#txtTransferDate').datebox({
        onSelect: function(date){
            RefreshLoanSummery();
        }
    });

    $("#txtLoanInterestRate,#txtLoanTransferInterestRate,#txtDiscountPaidAmount,#txtDiscountRcvAmount").keyup(function (e) {
        RefreshLoanSummery();
    });

    $("#cboLoanTransfer").change(function(e){
        var nLoanTransfer = parseInt($("#cboLoanTransfer").val());
        if(nLoanTransfer === 0)
        {
            $('#txtTransferDate').datebox('setValue', "");
            $("#txtTransferInterestDays").val("0");
            $("#txtLoanTransferInterestRate").val("0.00");
            $("#txtTransferInterest").val("0.00");
        }
        else
        {
            var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
            if(oLoanInstallment != null && oLoanInstallment != undefined)
            {                   
                $('#txtTransferDate').datebox('setValue', oLoanInstallment.SettlementDateInString);
                $("#txtLoanTransferInterestRate").val(icsFormatPrice(parseFloat(oLoanInstallment.InterestRate), null, 4));
            }
        }
        RefreshLoanSummery();
    });

    $('#btnAddCharge').click(function(e){
        if(parseInt($('#cboExpenseHead').val())<=0)
        {
            alert("Please Select Charge Head!");
            $('#cboExpenseHead').focus();
            return;
        }
        if(parseInt($('#cboChargeCurSymbol').val())<=0)
        {
            alert("Please Select Charge Currency!");
            $('#cboChargeCurSymbol').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtLoanChargeCRate").val()))<=0)
        {
            alert("Please Enter Charge Currency Rate!");
            $('#txtLoanChargeCRate').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtLoanChargeAmount").val()))<=0)
        {
            alert("Please Enter Charge Amount!");
            $('#txtLoanChargeCRate').focus();
            return;
        }

        var oLoanCharges = $("#tblLoanCharge").datagrid("getRows");
        for(var i=0; i<oLoanCharges.length; i++)
        {
            if(parseInt($('#cboExpenseHead').val()) === parseInt(oLoanCharges[i].ExpenseHeadID))
            {
                alert("Your Selected Charge Head Already Exists!");
                $('#cboExpenseHead').focus();
                return;
            }
        }

        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var nLoanChargeCRate = parseFloat(icsRemoveComma($("#txtLoanChargeCRate").val()));
        var nLoanChargeAmount = parseFloat(icsRemoveComma($("#txtLoanChargeAmount").val()));        
        var oLoanCharge = {
            LoanSettlementID : 0,
            LoanInstallmentID : parseInt(oLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oLoanInstallment.LoanID), 
            BankAccountID : 0,
            ExpenseHeadID : parseInt($('#cboExpenseHead').val()), 
            CurrencyID : parseInt($('#cboChargeCurSymbol').val()),
            AmountBC : parseFloat((parseFloat(nLoanChargeCRate) * parseFloat(nLoanChargeAmount)).toFixed(2)),
            CRate : parseFloat(nLoanChargeCRate),
            Amount : parseFloat(parseFloat(nLoanChargeAmount).toFixed(2)), 
            Remarks : "N/A",
            AccountName : $("#cboExpenseHead option:selected").text(),
            CurrencySymbol : $("#cboChargeCurSymbol option:selected").text()
        }
        $('#tblLoanCharge').datagrid('appendRow', oLoanCharge);
        $('#cboExpenseHead').val(0);
        $("#txtLoanChargeAmount").val("0.00");
        RefreshLoanSummery();
    });

    $('#btnChargeDelete').click(function(e){
        var oLoanCharge = $("#tblLoanCharge").datagrid("getSelected");
        if(oLoanCharge === null ||     parseInt(oLoanCharge.ExpenseHeadID)<=0)
        {
            alert("Please Select an Item From List!");            
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblLoanCharge").datagrid("getRowIndex", oLoanCharge);
        $("#tblLoanCharge").datagrid("deleteRow", nSelectedIndex);
        RefreshLoanSummery();
    });
    
    $('#btnPaymentAdd').click(function(e){
        if(parseInt($('#cboBankAC').val())<=0)
        {
            alert("Please Select Bank Account!");
            $('#cboBankAC').focus();
            return;
        }
        if(parseInt($('#cboPaymentCurrencySymbol').val())<=0)
        {
            alert("Please Select Paid Currency!");
            $('#cboPaymentCurrencySymbol').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtPaymentCRate").val()))<=0)
        {
            alert("Please Enter Paid Currency Rate!");
            $('#txtPaymentCRate').focus();
            return;
        }
        if(parseFloat(icsRemoveComma($("#txtPaymentAmount").val()))<=0)
        {
            alert("Please Enter Paid Amount!");
            $('#txtPaymentAmount').focus();
            return;
        }

        var oPayments = $("#tblPayment").datagrid("getRows");
        for(var i=0; i<oPayments.length; i++)
        {
            if(parseInt($('#cboBankAC').val()) === parseInt(oPayments[i].BankAccountID))
            {
                alert("Your Selected Bank A/C Head Already Exists!");
                $('#cboBankAC').focus();
                return;
            }
        }

        var oLoanInstallment = $('#winLoanInstallment').data('LoanInstallment');
        var nPaymentCRate = parseFloat(icsRemoveComma($("#txtPaymentCRate").val()));
        var nPaymentAmount = parseFloat(icsRemoveComma($("#txtPaymentAmount").val()));        
        var oPayment = {
            LoanSettlementID : 0,
            LoanInstallmentID : parseInt(oLoanInstallment.LoanInstallmentID),
            LoanID : parseInt(oLoanInstallment.LoanID), 
            BankAccountID : parseInt($('#cboBankAC').val()),
            ExpenseHeadID : 0, 
            CurrencyID : parseInt($('#cboPaymentCurrencySymbol').val()),
            AmountBC : parseFloat((parseFloat(nPaymentCRate) * parseFloat(nPaymentAmount)).toFixed(2)),
            CRate : parseFloat(nPaymentCRate),
            Amount : parseFloat(parseFloat(nPaymentAmount).toFixed(2)), 
            Remarks : "N/A",
            AccountName : $("#cboBankAC option:selected").text(),
            CurrencySymbol : $("#cboPaymentCurrencySymbol option:selected").text()
        }
        $('#tblPayment').datagrid('appendRow', oPayment);
        $('#cboBankAC').val(0);
        $("#txtPaymentAmount").val("0.00");
        RefreshLoanSummery();
    });

    $('#btnPaymentDelete').click(function(e){
        var oPayment = $("#tblPayment").datagrid("getSelected");
        if(oPayment === null ||     parseInt(oPayment.BankAccountID)<=0)
        {
            alert("Please Select an Item From List!");            
            return;
        }
        if (!confirm("Confirm to Delete?")) return ;
        var nSelectedIndex  = $("#tblPayment").datagrid("getRowIndex", oPayment);
        $("#tblPayment").datagrid("deleteRow", nSelectedIndex);
        RefreshLoanSummery();
    });


    //end Loan Settlement
</script>