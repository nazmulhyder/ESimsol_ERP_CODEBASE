<html>

<body>
    @model ESimSol.BusinessObjects.LCTransfer

    <div class="menuMainCollectionTable" ng-app="LCTransferApp" ng-controller="LCTransferController as LCTC" id="divLT">
        <div style="font-family:Tahoma;text-align:center;height:90%;" class="regionLT">
            <fieldset>
                <legend>Master LC Transfer Info :</legend>
                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">Ref No:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.RefNo" class="form-control" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Transfer Issue Date:</label></div>
                    <div class="col-md-2 text-left">
                        <div class="input-group date date-container">
                            <input type="text" class="form-control" ng-model="LCTransfer.TransferIssueDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                        </div>
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Production Factory:</label></div>
                    <div class="col-md-2 text-left">
                        <div class="input-group">
                            <input ng-model="LCTransfer.ProductionFactoryName" class="form-control" ng-keydown="SearchKeyDownFactory($event)" placeholder="Type Factory & Press Enter" required />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="PickProductionFactroy()"> <span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                            </span>
                        </div>

                    </div>
                </div>
                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">Master LC No:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.MasterLCNo" class="form-control" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Status</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.LCStatusInString" class="form-control" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Buyer Name:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.BuyerName" class="form-control" disabled />
                    </div>
                </div>
                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">LC Value:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.LCValue" class="form-control" style="text-align:right;" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Yet To Transfer:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.YetToTransferValue" class="form-control" style="text-align:right;" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Commission Favor Of:</label></div>
                    <div class="col-md-2 text-left">
                        <select class="form-control" ng-model="LCTransfer.CommissionFavorOf" ng-options="item.CompanyID as item.Name for item in CommissionFavorOfs"></select>
                    </div>
                </div>
                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">Transfer No:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.TransferNo" class="form-control" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Transfer Date:</label></div>
                    <div class="col-md-2 text-left">
                        <div class="input-group date date-container">
                            <input type="text" class="form-control" ng-model="LCTransfer.TransferDateInString"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                        </div>
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Commission Account:</label></div>
                    <div class="col-md-2 text-left">
                        <select class="form-control" ng-model="LCTransfer.TransferBankAccountID" ng-options="item.BankAccountID as item.BankAccountNo for item in BankAccounts"></select>
                    </div>
                </div>
                <div class="row col-md-12">
                    <div class="col-md-2 text-right"><label class="control-label">Transfer Amount:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.TransferAmount" class="form-control" style="text-align:right;" disabled />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Note:</label></div>
                    <div class="col-md-2 text-left">
                        <input ng-model="LCTransfer.Note" class="form-control" />
                    </div>
                    <div class="col-md-2 text-right"><label class="control-label">Factory Branch:</label></div>
                    <div class="col-md-2 text-left">
                        <select class="form-control" ng-model="LCTransfer.FactoryBranchID" ng-options="item.BankBranchID as item.BranchWithBankName for item in FactoryBankBranchs"></select>
                    </div>
                </div>

            </fieldset>
            <div class="ui-grid-top-panel" style="text-align:left;">
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="PickOrder()"><span class="glyphicon glyphicon-plus" aria-hidden="true"> Pick Order</span></button>
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RemoveDetail()"><span class="glyphicon glyphicon-remove" aria-hidden="true"> Remove</span></button>
                <button type="button" class="btn btn-default btn-sm" aria-label="right Align" ng-click="RefreshDetail()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> Refresh</span></button>
            </div>
            <div style="width: 100%; height:200px;" ui-grid="gridOptionsLTDetail" ui-grid-selection ui-grid-cellnav ui-grid-edit></div>
        </div>

        <fieldset>
            <legend>Action</legend>
            <div class="row col-md-12 text-right">
                <button type="button" class="btn btn-sm" aria-label="Left Align" ng-click="save()"> <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"> Save</span> </button>
                <button type="button" id="btnclose" class="btn btn-sm" aria-label="Left Align" ng-click="close()"> <span class="glyphicon glyphicon-remove" aria-hidden="true"> Close</span> </button>
            </div>
        </fieldset>

    </div>
            <div style="font-family: Tahoma">
                <div style="width:945px;height:500px">
                    <div style="padding:02px; font-size:12px; font-style:normal;">
                        <div style="padding:0px">
                            
                        </div>
                        <div title="LC Transfer Details" style="padding:02px">
                            
                            <table id="tblLCTransferDetail" title="LC Transfer Details" class="easyui-datagrid" style="width: 937px; height: 300px" fitcolumns="false" rownumbers="true" pagination="false" singleselect="true" autorowheight="false" toolbar="#DetailtoolBar"
                                   data-options="singleSelect: false, fitColumns:false,  rownumbers:true,pagination:false,autoRowHeight:false,  onClickRow: onClickRow">
                                <thead>
                                    <tr>
                                        <th field="StyleNo" width="100" align="left"> Style No  </th>
                                        <th field="OrderNo" width="70" align="left"> Order No </th>
                                        <th field="ProductName" width="100" align="left"> Item Description </th>
                                        <th field="PIDetailQty" width="90" formatter="formatPricewithoutdecimal" align="right"> Total Quantity</th>
                                        <th field="YeToTransferQtyInString" formatter="formatPricewithoutdecimal" width="100" align="right"> Yet To Transfer </th>
                                        <th field="TransferQty" align="right" formatter="formatPricewithoutdecimal" width="80"> Transfer Qty </th>
                                        <th field="FOB" width="40" formatter="formatPrice4digit" align="right"> FOB </th>
                                        <th field="Amount" width="70" formatter="formatPrice" align="right"> Amount</th>
                                        <th width="78" align="right" data-options="field:'CommissionInPercent',editor:{type:'numberbox',options:{precision:2}}"> Comm(%) </th>
                                        <th width="78" align="right" data-options="field:'FactoryFOB',editor:{type:'numberbox',options:{precision:2}}">Factory FOB</th>
                                        <th field="CommissionPerPcs" width="70" formatter="formatPrice4digit" align="right">Comm/Pcs </th>
                                        <th field="CommissionAmount" width="90" formatter="formatPrice" align="right">Comm. Amount </th>
                                    </tr>
                                </thead>
                            </table>
                            <table border="0">
                                <tr>
                                    <td id="tdTotalCaption" style="width: 310px; text-align: right; font-size: 12px; font-weight:bold"> Total : </td>
                                    <td style="width: 70px; text-align: right; font-size: 12px"> <label id="lblTotalQty" style="text-align: right; font-size:12px; float: right; font-weight:bold">0</label></td>
                                    <td style="width: 80px; text-align: right; font-size: 12px"> <label id="lblYetTransferQty" style="text-align: right; font-size:12px; float: right; font-weight:bold">0</label></td>
                                    <td style="width: 80px; text-align: right; font-size: 12px"> <label id="lblTransferQty" style="text-align: right; font-size:12px; float: right; font-weight:bold">0</label></td>
                                    <td style="width: 130px; text-align: right; font-size: 12px"> <label id="lblAmount" style="text-align: right; font-size:12px; float: right; font-weight:bold">0</label> </td>
                                    <td style="width: 200px; text-align: right; font-size: 12px"> <label id="lblTotalComisionAmount" style="text-align: right; font-size:12px; float: right; font-weight:bold">0</label></td>

                                </tr>
                            </table>
                        </div>
                    </div>

                </div>
                <fieldset>
                    <legend style="font-weight: bold">Action : </legend>
                    <table border="0" cellspacing="2" cellpadding="2" style="font-size: 11px; width: 100%;
            font-weight: bold; font-size: 12">
                        <tr>
                            <td style="width: 840px; text-align: right"></td>
                            <td style="width: 60px; font-size: 13">
                                <a id="btnSave" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-save"
                                   plain="true" onclick="Save()">Save</a>
                            </td>
                            <td style="width: 60px; font-size: 13">
                                <a id="btnClose" href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel"
                                   plain="true" onclick="Close()">Close</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </div>
</body>
</html>
<style type="text/css">
    .regionLT .form-horizontal .control-label {
        padding-top: 1px;
    }

    .regionLT .form-control {
        height: 26px;
        padding: 0px 6px;
        font-size: 12px;
    }

    .regionLT .form-controlsm {
        height: 20px;
        padding: 0px 2px;
        text-align: right;
        width: 100%;
        font-size: 12px;
    }

    .regionLT .col-md-12 {
        width: 100%;
        padding-right: 5px;
        padding-left: 5px;
        margin-bottom: 5px;
    }

    .regionLT .col-md-2 {
        width: 16.66%;
        padding-right: 5px;
        padding-left: 5px;
    }


    .regionLT .col-md-6 {
        width: 50%;
        padding-right: 5px;
        padding-left: 5px;
    }

    .regionLT .col-md-8 {
        width: 66.66%;
        padding-right: 5px;
        padding-left: 0px;
    }

    .regionLT .col-md-4 {
        width: 33.33%;
        padding-right: 5px;
        padding-left: 0px;
    }


    .regionLT .col-md-5 {
        width: 41.66%;
        padding-right: 5px;
        padding-left: 0px;
    }

    .regionLT .btn-sm {
        padding: 3px 10px;
    }

    .regionLT .input-group-addon {
        padding: 4px 8px;
    }
</style>

<script type="text/javascript">
    var _oLCTransfer=null;
    var _oCurrencies =[];
    var _oBankAccounts = [];
    var _oFactoryBankBranchs = [];
    var _oCompanies = [];
    var _oLCTransferDetails =[];
    var _nFactoryID =0;
    var _nTotalQty =0;
    var _nTotalYetToTransferQty = 0;
    var _nTotalTransferQty = 0;
    var _nTotalAmount = 0;
    var _nTotalCommissionAmount = 0;
    var _oAuthorizationRolesMapping =[];
    var _oClientOperationSetting = null;
    $(document).ready(function () {
        ////debugger;
        
        _oLCTransfer =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));
        _oLCTransferDetails=@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.LCTransferDetails));
        _oCompanies =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.Companies));
        _oBankAccounts =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.BankAccounts));
        _oFactoryBankBranchs =@Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.BankBranches));
        _oClientOperationSetting = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model.ClientOperationSetting));
       _oAuthorizationRolesMapping =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.AuthorizationRolesMapping]));


        var obj = window.dialogArguments;
        _objName =obj.Name;
        document.getElementById ("lblHeaderName").innerHTML =_objName;
        $('#txtTransferIssueDate').datebox('setValue',_oLCTransfer.TransferIssueDateInString);
        $('#txtTransferDate').datebox('setValue',_oLCTransfer.TransferDateInString);
        if(parseInt(_oClientOperationSetting.WayOfLCTransfer)==0)//Percent Base
        {
            $('#tblLCTransferDetail').datagrid('hideColumn', 'FactoryFOB'); //Percent Base
        }else{
            $('#tblLCTransferDetail').datagrid('hideColumn', 'CommissionInPercent'); //FOB Base
        }

        LoadCompanies();
        LoadBankAccounts();
        LoadFactoryBranch();

        if(_objName=="Edit LC Transfer")
        {
            ForEdit();
        }
        if(_objName=="View LC Transfer")
        {
            ForEdit();
            ForView();
        }
        //        RefreshControlLayout();

    });


    function ForEdit()
    {
        RefreshListDetails(_oLCTransferDetails);
        _nFactoryID =_oLCTransfer.ProductionFactoryID;
        $('#cboCommisionFavorOf').val(_oLCTransfer.CommissionFavorOf);
        $('#cboCommisionAccount').val(_oLCTransfer.CommissionAccountID);
        SetTotal();
    }


    function  ForView()
    {

        document.getElementById('txtTransferIssueDate').disabled = true;
        document.getElementById('btnContactor').disabled = true;
        document.getElementById('cboCommisionFavorOf').disabled = true;
        document.getElementById('cboCommisionAccount').disabled = true;
        document.getElementById('cboFactoryBranch').disabled = true;
        document.getElementById('txtTransferDate').disabled = true;

        document.getElementById('txtProductionFactoryName').disabled = true;


        document.getElementById('btnPickOrder').disabled = true;
        document.getElementById('btnRemoveLCTransferDetail').disabled = true;
        document.getElementById('btnRefreshLCTransferDetail').disabled = true;



        document.getElementById('btnSave').style.display = 'none';


    }



    function PickProductionFactroy()
    {
        var oParameter = new Object();
        oParameter.Name = "Factroy list";
        oParameter.MultipleItemReturn =false;
        oParameter.ContractorType ="3";
        var url =_sBaseAddress+  "/Contractor/ContractorSearch";
        var oReturnObj = window.showModalDialog(url, oParameter, 'dialogHeight:430px;dialogWidth:450px;dialogLeft:350;dialogTop:100;center:yes;resizable:no;status:no;scroll:no');
        document.getElementById("txtProductionFactoryName").value = oReturnObj.Name;
        _nFactoryID =oReturnObj.ContractorID;

    }

    // Search Factory Start
    $('#txtProductionFactoryName').keypress(function (e) {
        //debugger;
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) {
            var txtFactoryName = document.getElementById('txtProductionFactoryName').value;
            if(txtFactoryName!="")
            {
                //debugger;
                var tsv=((new Date()).getTime())/1000;
                var oParameter = new Object();
                oParameter.EnteredText=txtFactoryName;
                var url =_sBaseAddress+ "/Contractor/ViewContractorSearch?sTemp="+txtFactoryName+"&pt=3&ts="+tsv;
                var oFactory = window.showModalDialog(url, oParameter, 'dialogHeight:270px;dialogWidth:383px;dialogLeft:520;dialogTop:310;center:yes;resizable:no;status:no;scroll:no');
                //debugger;
                if(oFactory !=null)
                {
                    if(parseInt(oFactory.ContractorID)>0)
                    {
                        var txtFactoryName=document.getElementById("txtProductionFactoryName");
                        txtFactoryName.value=oFactory.Name;
                        txtFactoryName.style.color="blue";
                        txtFactoryName.style.fontWeight="bold";
                        _nFactoryID=oFactory.ContractorID;

                    }
                }
                else
                {
                    var txtFactoryName=document.getElementById("txtProductionFactoryName");
                    txtFactoryName.style.color="black";
                    txtFactoryName.style.fontWeight="normal";
                    _nFactoryID =0;
                }

            }
        }
    });

    $('#txtProductionFactoryName').keydown(function (e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 8) //backspace=8
        {
            //debugger;
            var txtFactoryName=document.getElementById("txtProductionFactoryName");
            txtFactoryName.style.color="black";
            txtFactoryName.style.fontWeight="normal";
            _nFactoryID =0;
        }
    });
    // Search Factory End



    var editIndex = undefined;
    function endEditing(){
        debugger;
        if (editIndex == undefined){return true}
        if ($('#tblLCTransferDetail').datagrid('validateRow', editIndex)){

            $('#tblLCTransferDetail').datagrid('endEdit', editIndex);
            $('#tblLCTransferDetail').datagrid('selectRow',editIndex);
            var oLCTransferDetail=$('#tblLCTransferDetail').datagrid('getSelected');
            oLCTransferDetail.Amount= parseFloat(parseFloat(oLCTransferDetail.TransferQty )* parseFloat(oLCTransferDetail.FOB));
            if(parseInt(_oClientOperationSetting.WayOfLCTransfer)==0)//Percent Base
            {
                oLCTransferDetail.CommissionPerPcs= parseFloat((parseFloat(oLCTransferDetail.CommissionInPercent )* parseFloat(oLCTransferDetail.FOB))/100);
                oLCTransferDetail.CommissionAmount= parseFloat(parseFloat(oLCTransferDetail.TransferQty )* parseFloat(oLCTransferDetail.CommissionPerPcs));
                oLCTransferDetail.FactoryFOB = parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.CommissionPerPcs);
               
            }else{//FOB Base
                oLCTransferDetail.CommissionPerPcs = parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB);
                oLCTransferDetail.CommissionInPercent = (parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB)* parseFloat(100))/parseFloat(oLCTransferDetail.FOB);
                oLCTransferDetail.CommissionAmount = parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB) * parseFloat(oLCTransferDetail.TransferQty);
            }

            $('#tblLCTransferDetail').datagrid('updateRow',{index: editIndex,	row: oLCTransferDetail});
            SetTotal();
            editIndex = undefined;
            return true;
        }
        else
        {
            return false;
        }
    }

    function onClickRow(index){

        if (editIndex != index){
            if (endEditing())
            {
                $('#tblLCTransferDetail').datagrid('selectRow', index).datagrid('beginEdit', index);
                editIndex = index;
            }
            else
            {
                $('#tblLCTransferDetail').datagrid('selectRow', editIndex);
            }
        }
    }




    function LoadCompanies()
    {
        ////debugger;
        $('#cboCommisionFavorOf').empty();
        var listItems= "<option value='"+0+"'>" +"--Select Company--" + "</option>";
        if (_oCompanies !=null)
        {
            if(_oCompanies.length>0)
            {

                for (var i = 0; i < _oCompanies.length; i++) {
                    listItems += "<option value='" + _oCompanies[i].CompanyID+"'>" + _oCompanies[i].Name+"</option>";
                }
            }
            $("#cboCommisionFavorOf").html(listItems);
            $('#cboCommisionFavorOf').val(_oLCTransfer.LCFavorOf);

        }

    }


    function LoadBankAccounts()
    {
        ////debugger;
        $('#cboCommisionAccount').empty();
        var listItems= "<option value='"+0+"'>" +"--Select Bank Account--" + "</option>";
        if (_oBankAccounts !=null)
        {
            if(_oBankAccounts.length>0)
            {

                for (var i = 0; i < _oBankAccounts.length; i++) {
                    listItems += "<option value='" + _oBankAccounts[i].BankAccountID+"'>" + _oBankAccounts[i].BankNameAccountNo+"</option>";
                }
            }
            $("#cboCommisionAccount").html(listItems);
            $('#cboCommisionAccount').val(_oLCTransfer.TransferBankAccountID);

        }
    }

    function LoadFactoryBranch()
    {
        ////debugger;
        $('#cboFactoryBranch').empty();
        var listItems= "<option value='"+0+"'>" +"--Select factory Branch--" + "</option>";
        if (_oFactoryBankBranchs !=null)
        {
            if(_oFactoryBankBranchs.length>0)
            {

                for (var i = 0; i < _oFactoryBankBranchs.length; i++) {
                    listItems += "<option value='" + _oFactoryBankBranchs[i].BankBranchID+"'>" + _oFactoryBankBranchs[i].BranchWithBankName+"</option>";
                }
            }
            $("#cboFactoryBranch").html(listItems);
            $('#cboFactoryBranch').val(_oLCTransfer.FactoryBranchID);

        }
    }



    function PickOrder()
    {
        if(_oLCTransfer.MasterLCID<=0)
        {
            alert("Sorry, There is no Master LC");
            return;
        }
        var oParameter = new Object();
        var tsv=((new Date()).getTime())/1000;
        var url =_sBaseAddress+  "/ProformaInvoice/PIOrderPicker?id="+_oLCTransfer.MasterLCID+"&ts="+tsv;
        var oPIDetails = window.showModalDialog(url, oParameter, 'dialogHeight:440px;dialogWidth:820px;dialogLeft:200;dialogTop:150;center:yes;resizable:no;status:no;scroll:no');
        if(oPIDetails.length>0)
        {

            for(var i =0;i<oPIDetails.length;i++)
            {
                if(!IsExists(oPIDetails[i].ProformaInvoiceDetailID))
                {

                    var oLCTransferDetail ={
                        LCTransferDetailID : 0,
                        LCTransferID :_oLCTransfer.LCTransferID,
                        ProformaInvoiceDetailID :oPIDetails[i].ProformaInvoiceDetailID,
                        TechnicalSheetID :oPIDetails[i].TechnicalSheetID,
                        OrderRecapID :oPIDetails[i].OrderRecapID,
                        PIDetailQty : oPIDetails[i].Quantity,
                        YeToTransferQty : oPIDetails[i].YetToTransfer,
                        YeToTransferQtyInDouble: oPIDetails[i].YetToTransfer,
                        YeToTransferQtyInString:oPIDetails[i].YeToTransferQtyInString,
                        TransferQty : oPIDetails[i].YetToTransfer,
                        FOB :oPIDetails[i].UnitPrice,
                        Amount : parseFloat(parseFloat( oPIDetails[i].Quantity)* parseFloat(oPIDetails[i].UnitPrice)),
                        CommissionInPercent : 5,
                        FactoryFOB:oPIDetails[i].CMValue,
                        CommissionPerPcs : parseFloat(parseFloat(5) * parseFloat(oPIDetails[i].UnitPrice)/100),
                        OrderRecapNo :oPIDetails[i].SaleOrderNo,
                        OrderNo:oPIDetails[i].SaleOrderNo,
                        CommissionAmount :parseFloat(parseFloat(oPIDetails[i].Quantity)* parseFloat(parseFloat(5) * parseFloat(oPIDetails[i].UnitPrice)/100)),
                        StyleNo :oPIDetails[i].StyleNo,
                        ProductName :oPIDetails[i].ProductName,
                        Fabrication :oPIDetails[i].FabricName

                    };
                    if(parseInt(_oClientOperationSetting.WayOfLCTransfer)==1)//FOB Base
                    {
                        oLCTransferDetail.CommissionPerPcs = parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB);
                        oLCTransferDetail.CommissionInPercent = (parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB)* parseFloat(100))/parseFloat(oLCTransferDetail.FOB);
                        oLCTransferDetail.CommissionAmount = parseFloat(oLCTransferDetail.FOB - oLCTransferDetail.FactoryFOB) * parseFloat(oLCTransferDetail.TransferQty);
                    }
                    $('#tblLCTransferDetail').datagrid('appendRow',oLCTransferDetail);

                }
            }
            RefreshDetail();
            endEditing();
            SetTotal();

        }
    }

    function IsExists(nProformaInvoiceDetailID)
    {
        var oLCTransferDetails = $('#tblLCTransferDetail').datagrid('getRows');
        for(var i =0;i<oLCTransferDetails.length;i++)
        {
            if(oLCTransferDetails[i].ProformaInvoiceDetailID==nProformaInvoiceDetailID)
            {
                return true;
            }
        }

        return false;

    }





    function RemoveDetail()
    {
        var oLCTransferDetail =$('#tblLCTransferDetail').datagrid('getSelected');
        if(oLCTransferDetail==null)
        {
            alert("Select At least One item !");
            return;
        }
        var SelectedRowIndex=$('#tblLCTransferDetail').datagrid('getRowIndex',oLCTransferDetail);
        if (!confirm("Confirm to Delete?")) return ;
        $('#tblLCTransferDetail').datagrid('deleteRow',SelectedRowIndex);
        endEditing();
        SetTotal();

    }

    function RefreshDetail()
    {
        endEditing();
        var oLCTransferDetails = $('#tblLCTransferDetail').datagrid('getRows');
        if(oLCTransferDetails!=null)
        {
            RefreshListDetails(oLCTransferDetails);
        }
    }

    function SetTotal()
    {
        var oLCTransferDetails = $('#tblLCTransferDetail').datagrid('getRows');
        _nTotalQty =0;
        _nTotalYetToTransferQty = 0;
        _nTotalTransferQty = 0;
        _nTotalAmount = 0;
        _nTotalCommissionAmount = 0;
        if(oLCTransferDetails.length>0)
        {

            for(var i =0;i<oLCTransferDetails.length;i++)
            {
                _nTotalQty+=parseFloat(oLCTransferDetails[i].PIDetailQty);
                _nTotalYetToTransferQty+=parseFloat(oLCTransferDetails[i].YeToTransferQty);
                _nTotalTransferQty+=parseFloat(oLCTransferDetails[i].TransferQty);
                _nTotalAmount+= parseFloat(parseFloat(oLCTransferDetails[i].TransferQty) * parseFloat(oLCTransferDetails[i].FOB));
                _nTotalCommissionAmount+= parseFloat(parseFloat(oLCTransferDetails[i].TransferQty) * parseFloat(oLCTransferDetails[i].CommissionPerPcs));
                parseFloat(_nTotalQty);
                parseFloat(_nTotalYetToTransferQty);
                parseFloat(_nTotalTransferQty);
                parseFloat(_nTotalAmount);
                parseFloat(_nTotalCommissionAmount);

            }
        }
        document.getElementById('lblTotalQty').innerHTML =formatPricewithoutdecimal(_nTotalQty,0);
        document.getElementById('lblYetTransferQty').innerHTML = formatPricewithoutdecimal(_nTotalYetToTransferQty,0);
        document.getElementById('lblTransferQty').innerHTML =formatPricewithoutdecimal(_nTotalTransferQty,0);
        document.getElementById('lblAmount').innerHTML = formatPrice(_nTotalAmount,0) ;
        document.getElementById('lblTotalComisionAmount').innerHTML = formatPrice(_nTotalCommissionAmount,0) ;
        $('#txtTransferAmount')[0].value =   formatPrice(_nTotalAmount,0) ;

    }



    function RefreshListDetails(oLCTransferDetails)
    {
        data=oLCTransferDetails;
        data={"total":""+data.length+"","rows":data};
        $('#tblLCTransferDetail').datagrid('loadData',data);
    }



    function Save()
    {
        debugger;
        endEditing();
        if(!ValidateInput()) return;
        var oLCTransfer=LCTransferRefreshObject();
        oLCTransfer.LCTransferDetails = $('#tblLCTransferDetail').datagrid('getRows');
        $.ajax({
            type: "POST",
            dataType: "json",
            url : _sBaseAddress+"/LCTransfer/Save",
            traditional: true,
            data:  JSON.stringify(oLCTransfer),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //debugger;
                var _oLCTransfer= jQuery.parseJSON(data);
                if (_oLCTransfer.ErrorMessage=="" || _oLCTransfer.ErrorMessage==null)
                {

                    alert("Data Save Successfully!!");
                    window.returnValue= _oLCTransfer;
                    window.close();
                }
                else
                {
                    alert(_oLCTransfer.ErrorMessage);
                }
            },
            error: function (xhr, status, error)
            {
                alert(error);
            }
        });

    }



    function ValidateInput()
    {
        //debugger;
        if(document.getElementById("txtProductionFactoryName").value==null || document.getElementById("txtProductionFactoryName").value=="" || _nFactoryID <=0) { alert("Please Pick factory!"); $('#txtProductionFactoryName').focus(); return false; }
        if(document.getElementById("cboCommisionFavorOf").value=="--Select Company--" || $("#cboCommisionFavorOf").val()==0) { alert("Please select Favor Of"); $('#cboCommisionFavorOf').focus(); return false; }
        if(document.getElementById("cboCommisionAccount").value=="--Select Bank Account--" || $("#cboCommisionAccount").val()==0) { alert("Please select Bank Accout"); $('#cboCommisionAccount').focus(); return false; }
       // if(document.getElementById("cboFactoryBranch").value=="--Select factory Branch--" || $("#cboFactoryBranch").val()==0) { alert("Please select Factory Branch"); $('#cboFactoryBranch').focus(); return false; }
        if(document.getElementById("txtTransferAmount").value<=0 || document.getElementById("txtTransferAmount").value=="" ) { alert("Transfer Amount Should be greater than O"); $('#txtTransferAmount').focus(); return false; }

        if(document.getElementById("txtTransferAmount").value>_oLCTransfer.LCValue)
        {
            alert("Transfer Amount Should be Less  than LC Value");
            $('#txtTransferAmount').focus();
            return false;
        }


        var dtransferDate = new Date($('#txtTransferDate').datebox('getValue'));
        if(dtransferDate<_oLCTransfer.LCDate)
        {
            alert("Transfer Date should be Greater than LC Date.");
            return false;
        }

        var oLCTransferDetails = $('#tblLCTransferDetail').datagrid('getRows');
        if(oLCTransferDetails.length <=0){alert("Please Add LC Transfer Details");  return false;}
           for(var i = 0;i<oLCTransferDetails.length;i++)
           {
               if(parseInt(_oClientOperationSetting.WayOfLCTransfer)==parseInt(1))
               {
                   if( parseFloat(oLCTransferDetails[i].FactoryFOB)<=0)
                   {
                       alert("Factory FOB Should be Greater than 0 for ["+oLCTransferDetails[i].StyleNo+"']");
                       return false;
                   }
               }

           }

          //if(document.getElementById("lblTotalComisionAmount").value<=0)
          //{
          //  alert("Commi");
          //   return false;
          //}

        return true;
    }


    function LCTransferRefreshObject()
    {
        //debugger;
        var cboCommisionAccount = document.getElementById("cboCommisionAccount");
        var oLCTransfer= {
            LCTransferID :_oLCTransfer.LCTransferID,
            MasterLCID :_oLCTransfer.MasterLCID,
            RefNo :_oLCTransfer.RefNo,
            TransferIssueDate :$('#txtTransferIssueDate').datebox('getValue'),
            ProductionFactoryID :_nFactoryID,
            BuyerID :_oLCTransfer.BuyerID,
            CommissionFavorOf : document.getElementById("cboCommisionFavorOf").value,
            CommissionAccountID  : document.getElementById("cboCommisionAccount").value,
            FactoryBranchID: $("#cboFactoryBranch").val(),
            TransferNo : document.getElementById("txtTransferNo").value,
            TransferDate :$('#txtTransferDate').datebox('getValue'),
            TransferAmount: document.getElementById("txtTransferAmount").value,
            CommissionAmount :_nTotalCommissionAmount,
            Note : document.getElementById("txtNote").value
        };
        return oLCTransfer;
    }




    function Close()
    {

        window.close();
    }


    function RefreshControlLayout()
    {

        if(!HavePermission('RateView','LCTransfer')){$('#tblLCTransferDetail').datagrid('hideColumn','FOBCM'); }

    }

    function HavePermission(sOperationType, sDbObject)
    {
        var nSessionID =@Html.Raw( new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(HttpContext.Current.Session[SessionInfo.currentUserID]));
        if(nSessionID == -9) //check SuperUser
        {
            return true;
        }else
        {

            for(var i =0;i<_oAuthorizationRolesMapping.length;i++)
            {
                if(_oAuthorizationRolesMapping[i].OperationTypeInString == sOperationType && _oAuthorizationRolesMapping[i].DBObjectName == sDbObject)
                    return  true;
            }
            return false;
        }
    }


    $(document).keydown(function(e) {
        //debugger;
        if(e.which == 27)//escape=27
        {
            //debugger;
            window.close();
        }
    });


</script>
